.TODO
09:52 2014-04-01
work report - bjzhang -week 13
GREEN
fate#316276: XEN: Bring back the Xen snapshot functionality

09:55 2014-04-01
GTD
0, 9:30-17:50

1, today
1), snapshot. see"09:56 2014-04-01"
2), community work. support a cubietruck run xen on it.
3), 40' meeting. see"16:43 2014-04-01"

09:56 2014-04-01
fate#316276: XEN: Bring back the Xen snapshot functionality
1, write disk snapshot commit
implement disk snapshot in xenlight
2, (10:53 2014-04-02)
git send-email --no-chain-reply-to --annotate 0001-tools-libxl-add-disk-snapshot-support.patch --to xen-devel@lists.xen.org --cc anthony.perard@citrix.com --cc ian.jackson@eu.citrix.com --cc ian.campbell@citrix.com
3, [RFC] about libxl snapshot

i have sent a patch about implement disk internal snapshot. this is our first
step about snapshot.

our plan about snapshot is:
1, basic disk snapshot support(internal snapshot, qdisk as backend).
ALREADY SENT.
2, vm snapshot(memory save, snapshot the whole snapshot with transaction qmp
opeartion, only support internal disk snapshot at this step.
in this step, we plan to add the vm snapshot record in xenstore in domain in
order to management the status of vm snapshot.

question:
in GSOC2013, there is a requirement: "Add VM snapshot functionalities to libxl
save/restore and migration functions". is it mean add a flag to create snapshot
in save, revert snapshot in restore besides the dedicated vm snapshot command?
or just implement the snapshot in save, restore and migration?
it might be more clear for user if there is a dedicated snapshot command.

3, some "advanced" feature such driver-mirror, support other backend.

when i prepare to send this out, i found that there is a GSOC project during
community review this week. i am sorry about i do not send this discussion
eariler. sorry if i break the plan of xen community.

14:19 2014-04-01
sharkbate
i5: haswell
q87 expresss chipset
board: flathead.

16:10 2014-04-01
security, CCC
30C3 MP4 Recordings
http://hoersuppe.de/30c3recv.xml
Hardware Attacks, Advanced ARM Exploitation, and Android Hacking

16:43 2014-04-01
local sync meeting
1, roger
1), c600. sles11sp3.
pxe boot fail.
intel.
2), go to german next week.

2, chunyan
1), NOCOW.
(1), send a quick fix to SLE12 beta4.
(2), qemu: git.
send it bruce or anderas, they will merge into git. build service has a script will pull the git.

3, bamvor, TODO
1), send patch and doc out.
2), work on bnc#859701
3), roger's board.

10:51 2014-04-02
GTD
0, 10:00-19:30

1, today
1), snapshot. see"09:56 2014-04-01"2.
2), something about virt-manager. see"12:58 2014-04-02"
3), training for HA. see"16:32 2014-04-02".

12:58 2014-04-02
software skill, virtualization, virt-manager, storage
virt-manager call vm-install for virtual machine installation.
the disk image is created in volume pool. such volume pool is created by virsh volume create.

13:08 2014-04-02
software skills, useful website
http://stackoverflow.com for programming question
http://superuser.com for user question

15:17 2014-04-02
about gmtime and gmtime_r
from man pages:
The  four  functions  asctime(),  ctime(),  gmtime()  and  localtime() return a pointer to static data and hence are not thread-safe.  Thread-safe versions asctime_r(), ctime_r(), gmtime_r() and localtime_r() are specified by SUSv2, and available since libc 5.2.5.

16:32 2014-04-02
training, HA
1, overview
1), pacemaker.
no limit in theory. 实际还是有限制的。
2), corosync
usually do not exceed 16 nodes.
3), SBD(Storage Based Device, Stonish ... Device?)
prevents split brain scenarios.
4), Metro Area Clusters
still in corosync cluster.
up to 30Kilometer.
5), Geo Clustering.

2), cluster aware file system and volume management
data and meta data, both have cache. it should maintenance the coherence when difference user access it.
会需要一个全局范围的集群锁(e.g. dlm).
(1), Oracle Cluster File System(OCFS2)
(2), Clustered Logical Volume Manager 2(cLVM2)
保证不同节点中device map的一致性: 例如说修改lv meta, 同时只能有一个激活。active vg：在一个节点active vg, 所有节点都会同时激活。

某个应用场景, it could be:
OCFS2
  |
  |
cLVM2

lvm都是directIO. lvm suspend和deactive区别: suspend对于文件系统是透明的，不需要umount.
reference, "10:07 2013-03-20": https://bugzilla.novell.com/show_bug.cgi?id=801663

3), Continuous Data Replication
(1), DRBD
可以简单理解是个软件的raid0.
(2), Node Recovery with ReaR.
操作系统快速备份和恢复。

2, management tools
1), Cluster Test Drive.

3, resource agents
1), type
anything: 例如就是一个binary, 启动, monitor就是发"kill -0".

4, Maintenance mode for single mode.
enter maintenance mode for maintenance, e.g. update software.
re-enter using re-probe.

5, http://www.linbit.com/
DRBD for cluster solutions for all Linux-based applications.
现在和linbit合作.

6, 数据库
瓶颈: cpu, io.

7, cmirrord
http://linux.die.net/man/8/cmirrord
cmirrord(8) - Linux man page

cmirrord - cluster mirror log daemon

cmirrord is the daemon that tracks mirror log information in a cluster. It is specific to device-mapper based mirrors (and by extension, LVM cluster mirrors). Cluster mirrors are not possible without this daemon running.
This daemon relies on the cluster infrastructure provided by the Cluster MANager (CMAN), which must be set up and running in order for cmirrord to function. (The cluster infrastructure is also required for clvmd.)

Output is logged via syslog. The USR1 signal can be issued to cmirrord to gather current status information for debugging purposes.

Once started, cmirrord will run until it is shutdown via INT signal. If there are still active cluster mirrors, however, the signal will be ignored. Active cluster mirrors should be shutdown before stopping the cluster mirror log daemon.

8, cluster fs和distrbuted fs有啥区别？一样么？
http://en.wikipedia.org/wiki/Clustered_file_system
A clustered file system is a file system which is shared by being simultaneously mounted on multiple servers.
Distributed file systems do not share block level access to the same storage but use a network protocol.

17:07 2014-04-02
software skill, process, monitor process live or not
http://www.dbafree.net/?p=870
http://www.linuxjournal.com/content/monitoring-processes-kill-0
bamvor@laptop-work:~> ps
  PID TTY          TIME CMD
 8834 pts/0    00:00:00 bash
 8849 pts/0    00:00:00 ps
bamvor@laptop-work:~> kill -0 8834 && echo exist || echo non-exist
exist
bamvor@laptop-work:~> kill -0 8835 && echo exist || echo non-exist
-bash: kill: (8835) - No such process
non-exist

14:59 2014-04-03
GTD
1, today
1), bnc.
2, TODO
1), bnc#859701
discuss it on irc about does libvirt support user manage pool or not.

15:00 2014-04-03
software skill, SCM, git, reset
git reset --hard
1, commit错了，可以用git reset --hard恢复正确的历史。
2, git pull说有冲突：
例如github上有作者会改历史，可以用git reset --hard恢复到双方共有的位置。然后重新pull。我原来都是删掉这个branch重新做。

17:01 2014-04-03
storage, pool, volume
http://libvirt.org/storage.html
A storage pool is a quantity of storage set aside by an administrator, often a dedicated storage administrator, for use by virtual machines. Storage pools are divided into storage volumes either by the storage administrator or the system administrator, and the volumes are assigned to VMs as block devices.

8:13 2014-4-4
rop
shell code
mprotect

14:43 2014-4-7
snapshot
1, reply to snapshot
"Ian Jackson" <Ian.Jackson@eu.citrix.com> writen
>
> Bamvor Jian Zhang writes ("[RFC] about libxl snapshot"):
> > our plan about snapshot is:
> > 1, basic disk snapshot support(internal snapshot, qdisk as backend).
> > ALREADY SENT.
>
> Right, see my comments on that.  I'm not sure what feature it
> provides, apart from something that could be done with qemku-img.
yes. thanks for your review. basically this patch want to provide some api for vm snapshot.
is it ok if i send current patch plus vm snapshot patch together, and leave some advanced feature alone?
i mean support create, delete, list and revert for vm snapshot(only support internal disk snapshot).
> > 2, vm snapshot(memory save, snapshot the whole snapshot with transaction qmp
> > opeartion, only support internal disk snapshot at this step.
> > in this step, we plan to add the vm snapshot record in xenstore in domain in
> > order to management the status of vm snapshot.
>
> I'm not sure what you mean by "add the vm snapshot record in
> xenstore".  I don't know what "vm snapshot record" is exactly.  If you
> mean the domain save state it's far too big for xenstore.
sorry for confuse. i mean store the vm snapshot information, such as name of snapshot, creation time.
>
> > question:
> > in GSOC2013, there is a requirement: "Add VM snapshot functionalities to libxl
> > save/restore and migration functions". is it mean add a flag to create snapshot
> > in save, revert snapshot in restore besides the dedicated vm snapshot command?
> > or just implement the snapshot in save, restore and migration?
> > it might be more clear for user if there is a dedicated snapshot command.
>
> I agree that a dedicated command might be clearer.  This is a matter
> for the implementor to think about and decide in consultation with the
> community.  I don't think the 2013 GSOC requirement was intended to
> specify an xl UI.
>
> > 3, some "advanced" feature such driver-mirror, support other backend.
> >
> > when i prepare to send this out, i found that there is a GSOC project during
> > community review this week. i am sorry about i do not send this discussion
> > eariler. sorry if i break the plan of xen community.
>
> We welcome contributions from anyone, whether within GSOC or without.
> Sadly sometimes that means things come in parallel, which can involve
> duplicated work.  We'll know fairly soon which GSOC projects have been
> accepted.
>
> Ian.

2, reply
hi, ian
 "Ian Jackson" <Ian.Jackson@eu.citrix.com> written:
>
> Bamvor Jian Zhang writes ("[RFC] tools/libxl: add disk snapshot support"):
> > add internal disk snapshot support through qemu qmp, including create,
> > delete and list.
>
> Thanks for this submission.
>
> To review this idea, I think it is really necessary for me to
> understand the proposed semantics.  Sadly you don't provide a
> documentation patch.
>
> I think this would be much easier to review in the form of a patch to
> docs/man/xl.pod.1.  There needs to be a conceptual explanation of what
> a snapshot is, where it is stored, and so forth.
thanks, i will add doc in next version.

regards

bamvor
>
> Your code appears simply to send some messages to qemu.  I don't
> understand how that can do anything particularly useful.
>
> Thanks,
> Ian.
>

9:22 2014-4-8
开会建议。
1，大家提会议议题，没有议题不开会。
2，说一些大家不知道的事情，例如公司的动向，VPP什么时候发。
3, 工作内容work report里面都有。没有必要重复。

10:13 2014-04-08
GTD
0, 9:40-19:10

1, today
1), -11:29 13:30-19:03 vm snapshot. see"10:29 2014-04-08"
2), 12:41-13:30 personal.
3), xen community work. support guys work on cubietruck.
4), support liuhua wang. add floppy. see"14:36 2014-04-08"
5), work report.

10:29 2014-04-08
fate#316276: XEN: Bring back the Xen snapshot functionality
1, wirte vm snasphot patch.
1), hope finish create, delete and list today.
2), work on revert tomorrow.
3), write doc on xen man.
reference commit#4d1759b5.
2, write and debug create code.
diskinfo.param and diskinfo.dev is wrong.
1), (10:26 2014-04-09)
i should use xs_read instead of libxl__xs_read, because the latter one will free the buffer in GC_FREE.
diskinfo->dev = xs_read(ctx->xsh, XBT_NULL, libxl__sprintf(gc, "%s/dev", diskinfo->backend), NULL);
diskinfo->dev = libxl__xs_read(gc, XBT_NULL, libxl__sprintf(gc, "%s/dev", diskinfo->backend));
2), TODO: check the difference
libxl_snapshot **snapshotp;
*snapshotp = (libxl_snapshot*)realloc(*snapshotp, sizeof(libxl_snapshot) * nb);
fprintf(stderr, "device %-30s\n", (*snapshotp[j]).device);
fprintf(stderr, "device %-30s\n", (*snapshotp)[j].device);
3, write delete and list.
1), (11:12 2014-04-10)
(1), "15:19" finish coding. check and compile.
4, TODO
1), replace memset with libxl_xxx_init. for libxl_snapshot. libxl_vm_snapshot.
2), do i need to lock in xl in order to protect between create, delete and revert?
it seems not. there is no support between vm create, destroy and restore as well(i guess).
3), do i need check xs_rm return value?
4), how do i store the xen vm snapshot after host reboot?

10:38 2014-04-08
software skill, shell, bash; yast, update
alias you='if test "$EUID" = 0 ; then /sbin/yast2 online_update ; else su - -c "/sbin/yast2 online_update" ; fi'

14:36 2014-04-08
software skill, virtualization, libvirt, add floppy device
    <disk type='file' device='floppy'>
      <driver name='qemu' type='raw'/>
      <source file='/root/floppy.raw'/>
      <target dev='fd0' bus='fdc'/>
      <alias name='fdc0-0-0'/>
      <address type='drive' controller='0' bus='0' target='0' unit='0'/>
    </disk>

i paste it from "virsh dumpxml". bus, alias, address could be ignored.

16:09 2014-04-09
GTD
0, -18:05

1, today
1), 16:00-

23:38 2014-4-9
procedure call standard for ARM 64-bit Architecture.
armv8 support ieee 754-2008.
PSTATE: C: 例如无符号加法进位。N: 例如有符号加法溢出。TODO实验。

11:12 2014-04-10
GTD
1, today
1), 11:12-11:38 13:37-16:54 snapshot

13:35 2014-04-10
北京分行亚运村支行

13:39 2014-04-10
coding, how to remove file
int libxl__remove_file(libxl__gc *gc, const char *path)
{
    for (;;) {
        int r = unlink(path);
        if (!r) return 0;
        if (errno == ENOENT) return 0;
        if (errno == EINTR) continue;
        LOGE(ERROR, "failed to remove file %s", path);
        return ERROR_FAIL;
     }
}

#define ENOENT       2  /* No such file or directory */
#define EINTR        4  /* Interrupted system call */

http://stackoverflow.com/questions/19902828/why-does-enoent-mean-no-such-file-or-directory
It's an abbreviation of Error NO ENTry, and can actually be used for more than files/directories.
 
