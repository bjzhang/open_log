.LOG
09:52 2014-04-01
work report - bjzhang -week 13
GREEN
fate#316276: XEN: Bring back the Xen snapshot functionality

09:55 2014-04-01
GTD
0, 9:30-17:50

1, today
1), snapshot. see"09:56 2014-04-01"
2), community work. support a cubietruck run xen on it.
3), 40' meeting. see"16:43 2014-04-01"

09:56 2014-04-01
fate#316276: XEN: Bring back the Xen snapshot functionality
1, write disk snapshot commit
implement disk snapshot in xenlight
2, (10:53 2014-04-02)
git send-email --no-chain-reply-to --annotate 0001-tools-libxl-add-disk-snapshot-support.patch --to xen-devel@lists.xen.org --cc anthony.perard@citrix.com --cc ian.jackson@eu.citrix.com --cc ian.campbell@citrix.com
3, [RFC] about libxl snapshot

i have sent a patch about implement disk internal snapshot. this is our first
step about snapshot.

our plan about snapshot is:
1, basic disk snapshot support(internal snapshot, qdisk as backend).
ALREADY SENT.
2, vm snapshot(memory save, snapshot the whole snapshot with transaction qmp
opeartion, only support internal disk snapshot at this step.
in this step, we plan to add the vm snapshot record in xenstore in domain in
order to management the status of vm snapshot.

question:
in GSOC2013, there is a requirement: "Add VM snapshot functionalities to libxl
save/restore and migration functions". is it mean add a flag to create snapshot
in save, revert snapshot in restore besides the dedicated vm snapshot command?
or just implement the snapshot in save, restore and migration?
it might be more clear for user if there is a dedicated snapshot command.

3, some "advanced" feature such driver-mirror, support other backend.

when i prepare to send this out, i found that there is a GSOC project during
community review this week. i am sorry about i do not send this discussion
eariler. sorry if i break the plan of xen community.

14:19 2014-04-01
sharkbate
i5: haswell
q87 expresss chipset
board: flathead.

16:10 2014-04-01
security, CCC
30C3 MP4 Recordings
http://hoersuppe.de/30c3recv.xml
Hardware Attacks, Advanced ARM Exploitation, and Android Hacking

16:43 2014-04-01
local sync meeting
1, roger
1), c600. sles11sp3.
pxe boot fail.
intel.
2), go to german next week.

2, chunyan
1), NOCOW.
(1), send a quick fix to SLE12 beta4.
(2), qemu: git.
send it bruce or anderas, they will merge into git. build service has a script will pull the git.

3, bamvor, TODO
1), send patch and doc out.
2), work on bnc#859701
3), roger's board.

10:51 2014-04-02
GTD
0, 10:00-19:30

1, today
1), snapshot. see"09:56 2014-04-01"2.
2), something about virt-manager. see"12:58 2014-04-02"
3), training for HA. see"16:32 2014-04-02".

12:58 2014-04-02
software skill, virtualization, virt-manager, storage
virt-manager call vm-install for virtual machine installation.
the disk image is created in volume pool. such volume pool is created by virsh volume create.

13:08 2014-04-02
software skills, useful website
http://stackoverflow.com for programming question
http://superuser.com for user question

15:17 2014-04-02
about gmtime and gmtime_r
from man pages:
The  four  functions  asctime(),  ctime(),  gmtime()  and  localtime() return a pointer to static data and hence are not thread-safe.  Thread-safe versions asctime_r(), ctime_r(), gmtime_r() and localtime_r() are specified by SUSv2, and available since libc 5.2.5.

16:32 2014-04-02
training, HA, Gao Yan
1, overview
1), pacemaker.
no limit in theory. 实际还是有限制的。
2), corosync
usually do not exceed 16 nodes.
3), SBD(Storage Based Device, Stonish ... Device?)
prevents split brain scenarios.
4), Metro Area Clusters
still in corosync cluster.
up to 30Kilometer.
5), Geo Clustering.

2), cluster aware file system and volume management
data and meta data, both have cache. it should maintenance the coherence when difference user access it.
会需要一个全局范围的集群锁(e.g. dlm).
(1), Oracle Cluster File System(OCFS2)
(2), Clustered Logical Volume Manager 2(cLVM2)
保证不同节点中device map的一致性: 例如说修改lv meta, 同时只能有一个激活。active vg：在一个节点active vg, 所有节点都会同时激活。

某个应用场景, it could be:
OCFS2
  |
  |
cLVM2

lvm都是directIO. lvm suspend和deactive区别: suspend对于文件系统是透明的，不需要umount.
reference, "10:07 2013-03-20": https://bugzilla.novell.com/show_bug.cgi?id=801663

3), Continuous Data Replication
(1), DRBD
可以简单理解是个软件的raid0.
(2), Node Recovery with ReaR.
操作系统快速备份和恢复。

2, management tools
1), Cluster Test Drive.

3, resource agents
1), type
anything: 例如就是一个binary, 启动, monitor就是发"kill -0".

4, Maintenance mode for single mode.
enter maintenance mode for maintenance, e.g. update software.
re-enter using re-probe.

5, http://www.linbit.com/
DRBD for cluster solutions for all Linux-based applications.
现在和linbit合作.

6, 数据库
瓶颈: cpu, io.

7, cmirrord
http://linux.die.net/man/8/cmirrord
cmirrord(8) - Linux man page

cmirrord - cluster mirror log daemon

cmirrord is the daemon that tracks mirror log information in a cluster. It is specific to device-mapper based mirrors (and by extension, LVM cluster mirrors). Cluster mirrors are not possible without this daemon running.
This daemon relies on the cluster infrastructure provided by the Cluster MANager (CMAN), which must be set up and running in order for cmirrord to function. (The cluster infrastructure is also required for clvmd.)

Output is logged via syslog. The USR1 signal can be issued to cmirrord to gather current status information for debugging purposes.

Once started, cmirrord will run until it is shutdown via INT signal. If there are still active cluster mirrors, however, the signal will be ignored. Active cluster mirrors should be shutdown before stopping the cluster mirror log daemon.

8, cluster fs和distrbuted fs有啥区别？一样么？
http://en.wikipedia.org/wiki/Clustered_file_system
A clustered file system is a file system which is shared by being simultaneously mounted on multiple servers.
Distributed file systems do not share block level access to the same storage but use a network protocol.

17:07 2014-04-02
software skill, process, monitor process live or not
http://www.dbafree.net/?p=870
http://www.linuxjournal.com/content/monitoring-processes-kill-0
bamvor@laptop-work:~> ps
  PID TTY          TIME CMD
 8834 pts/0    00:00:00 bash
 8849 pts/0    00:00:00 ps
bamvor@laptop-work:~> kill -0 8834 && echo exist || echo non-exist
exist
bamvor@laptop-work:~> kill -0 8835 && echo exist || echo non-exist
-bash: kill: (8835) - No such process
non-exist

14:59 2014-04-03
GTD
1, today
1), bnc.
2, TODO
1), bnc#859701
discuss it on irc about does libvirt support user manage pool or not.

15:00 2014-04-03
software skill, SCM, git, reset
git reset --hard
1, commit错了，可以用git reset --hard恢复正确的历史。
2, git pull说有冲突：
例如github上有作者会改历史，可以用git reset --hard恢复到双方共有的位置。然后重新pull。我原来都是删掉这个branch重新做。

17:01 2014-04-03
storage, pool, volume
http://libvirt.org/storage.html
A storage pool is a quantity of storage set aside by an administrator, often a dedicated storage administrator, for use by virtual machines. Storage pools are divided into storage volumes either by the storage administrator or the system administrator, and the volumes are assigned to VMs as block devices.

8:13 2014-4-4
rop
shell code
mprotect

14:43 2014-4-7
snapshot
1, reply to snapshot
"Ian Jackson" <Ian.Jackson@eu.citrix.com> writen
>
> Bamvor Jian Zhang writes ("[RFC] about libxl snapshot"):
> > our plan about snapshot is:
> > 1, basic disk snapshot support(internal snapshot, qdisk as backend).
> > ALREADY SENT.
>
> Right, see my comments on that.  I'm not sure what feature it
> provides, apart from something that could be done with qemku-img.
yes. thanks for your review. basically this patch want to provide some api for vm snapshot.
is it ok if i send current patch plus vm snapshot patch together, and leave some advanced feature alone?
i mean support create, delete, list and revert for vm snapshot(only support internal disk snapshot).
> > 2, vm snapshot(memory save, snapshot the whole snapshot with transaction qmp
> > opeartion, only support internal disk snapshot at this step.
> > in this step, we plan to add the vm snapshot record in xenstore in domain in
> > order to management the status of vm snapshot.
>
> I'm not sure what you mean by "add the vm snapshot record in
> xenstore".  I don't know what "vm snapshot record" is exactly.  If you
> mean the domain save state it's far too big for xenstore.
sorry for confuse. i mean store the vm snapshot information, such as name of snapshot, creation time.
>
> > question:
> > in GSOC2013, there is a requirement: "Add VM snapshot functionalities to libxl
> > save/restore and migration functions". is it mean add a flag to create snapshot
> > in save, revert snapshot in restore besides the dedicated vm snapshot command?
> > or just implement the snapshot in save, restore and migration?
> > it might be more clear for user if there is a dedicated snapshot command.
>
> I agree that a dedicated command might be clearer.  This is a matter
> for the implementor to think about and decide in consultation with the
> community.  I don't think the 2013 GSOC requirement was intended to
> specify an xl UI.
>
> > 3, some "advanced" feature such driver-mirror, support other backend.
> >
> > when i prepare to send this out, i found that there is a GSOC project during
> > community review this week. i am sorry about i do not send this discussion
> > eariler. sorry if i break the plan of xen community.
>
> We welcome contributions from anyone, whether within GSOC or without.
> Sadly sometimes that means things come in parallel, which can involve
> duplicated work.  We'll know fairly soon which GSOC projects have been
> accepted.
>
> Ian.

2, reply
hi, ian
 "Ian Jackson" <Ian.Jackson@eu.citrix.com> written:
>
> Bamvor Jian Zhang writes ("[RFC] tools/libxl: add disk snapshot support"):
> > add internal disk snapshot support through qemu qmp, including create,
> > delete and list.
>
> Thanks for this submission.
>
> To review this idea, I think it is really necessary for me to
> understand the proposed semantics.  Sadly you don't provide a
> documentation patch.
>
> I think this would be much easier to review in the form of a patch to
> docs/man/xl.pod.1.  There needs to be a conceptual explanation of what
> a snapshot is, where it is stored, and so forth.
thanks, i will add doc in next version.

regards

bamvor
>
> Your code appears simply to send some messages to qemu.  I don't
> understand how that can do anything particularly useful.
>
> Thanks,
> Ian.
>

9:22 2014-4-8
开会建议。
1，大家提会议议题，没有议题不开会。
2，说一些大家不知道的事情，例如公司的动向，VPP什么时候发。
3, 工作内容work report里面都有。没有必要重复。

10:13 2014-04-08
GTD
0, 9:40-19:10

1, today
1), -11:29 13:30-19:03 vm snapshot. see"10:29 2014-04-08"
2), 12:41-13:30 personal.
3), xen community work. support guys work on cubietruck.
4), support liuhua wang. add floppy. see"14:36 2014-04-08"
5), work report.

10:29 2014-04-08
fate#316276: XEN: Bring back the Xen snapshot functionality
1, wirte vm snasphot patch.
1), hope finish create, delete and list today.
2), work on revert tomorrow.
3), write doc on xen man.
reference commit#4d1759b5.
2, write and debug create code.
diskinfo.param and diskinfo.dev is wrong.
1), (10:26 2014-04-09)
i should use xs_read instead of libxl__xs_read, because the latter one will free the buffer in GC_FREE.
diskinfo->dev = xs_read(ctx->xsh, XBT_NULL, libxl__sprintf(gc, "%s/dev", diskinfo->backend), NULL);
diskinfo->dev = libxl__xs_read(gc, XBT_NULL, libxl__sprintf(gc, "%s/dev", diskinfo->backend));
2), TODO: check the difference
libxl_snapshot **snapshotp;
*snapshotp = (libxl_snapshot*)realloc(*snapshotp, sizeof(libxl_snapshot) * nb);
fprintf(stderr, "device %-30s\n", (*snapshotp[j]).device);
fprintf(stderr, "device %-30s\n", (*snapshotp)[j].device);
3, write delete and list.
1), (11:12 2014-04-10)
(1), "15:19" finish coding. check and compile.
(2), works before i go to sleep.

10:38 2014-04-08
software skill, shell, bash; yast, update
alias you='if test "$EUID" = 0 ; then /sbin/yast2 online_update ; else su - -c "/sbin/yast2 online_update" ; fi'

14:36 2014-04-08
software skill, virtualization, libvirt, add floppy device
    <disk type='file' device='floppy'>
      <driver name='qemu' type='raw'/>
      <source file='/root/floppy.raw'/>
      <target dev='fd0' bus='fdc'/>
      <alias name='fdc0-0-0'/>
      <address type='drive' controller='0' bus='0' target='0' unit='0'/>
    </disk>

i paste it from "virsh dumpxml". bus, alias, address could be ignored.

16:09 2014-04-09
GTD
0, -18:05

1, today
1), 16:00-

23:38 2014-4-9
procedure call standard for ARM 64-bit Architecture.
armv8 support ieee 754-2008.
PSTATE: C: 例如无符号加法进位。N: 例如有符号加法溢出。TODO实验。

11:12 2014-04-10
GTD
1, today
1), 11:12-11:38 13:37-16:54 snapshot

13:35 2014-04-10
北京分行亚运村支行

13:39 2014-04-10
coding, how to remove file
int libxl__remove_file(libxl__gc *gc, const char *path)
{
    for (;;) {
        int r = unlink(path);
        if (!r) return 0;
        if (errno == ENOENT) return 0;
        if (errno == EINTR) continue;
        LOGE(ERROR, "failed to remove file %s", path);
        return ERROR_FAIL;
     }
}

#define ENOENT       2  /* No such file or directory */
#define EINTR        4  /* Interrupted system call */

http://stackoverflow.com/questions/19902828/why-does-enoent-mean-no-such-file-or-directory
It's an abbreviation of Error NO ENTry, and can actually be used for more than files/directories.

09:32 2014-04-11
GTD
0, 9:20

1, today
1), 9:33-11:30 13:49- snapshot. see"09:33 2014-04-11"

09:33 2014-04-11
fate#316276: XEN: Bring back the Xen snapshot functionality
1, open issue about snapshot
1), replace memset with libxl_xxx_init. for libxl_snapshot. libxl_vm_snapshot.
2), do i need to lock in xl in order to protect between create, delete and revert?
it seems not. there is no support between vm create, destroy and restore as well(i guess).
3), do i need check xs_rm return value?
4), how do i store the xen vm snapshot after host reboot?
5), i should flush aio before disk snapshot. check if it has been done in blockdev-snapshot-internal-sync(blockdev-snapshot-external-sync)?
TODO: i should flush I/O before save.
after check the code, i found that there is "bdrv_drain_all()" and "bdrv_flush_all()" in do_vm_stop. so this should be safe for vm snapshot.
6), work on pv guest snapshot.
7), do i need to add vm apply snapshot to xen-all.c in qemu?
it is not a big deal, i think it could be discuss in xen-devel.
8), with current vm snapshot apply, it will be change domid. it is differnet from qemu implementation.
2, plan
1), write revert.
2), deal with open issue next week.
3, revert
1), i do not find snapshot opions in qemu snapshot.
here is the current plan:
(1), restore domain with pause state.
(2), how to revert disk image?
4, snapshot information should not store in domain. it will disappear after domain destroy.

17:16 2014-04-11
work report - bjzhang -week 14, 15
GREEN
1, fate#316276: XEN: Bring back the Xen snapshot functionality
1), write disk snapshot patch and send it to upstream.
discuss with upstream, upstream do not want to review the disk snapshot patch alone.
2), work on vm snapshot: create, list, delete functional ok.
3), writing vm snapshot apply patch.
2, bnc#859701 With default setup this is not possible to create persistent pool with virsh
could reproduce it. need confirm whether it is a bug or not.
3, community
1), join octc 2014.
talk with openstack user and developer. talk with Larry Wall.
4, others
1 day public holiday.
HA related training by Gaoyan.

10:12 2014-04-14
GTD
1, today
1), snapshot.

14:15 2014-04-14
rpm, transaction
i saw this error because i do not run zypper with root permisstion.
(with --nodeps --force) Error: Subprocess failed. Error: RPM failed: error: can't create transaction lock on /var/lib/rpm/.rpm.lock (Permission denied)

16:30 2014-04-14
libxl__build_device_model_args

17:04 2014-04-14
(09:21 2014-04-15)
(10:10 2014-04-17)
snapshot
1, store snapshot in dir.
/var/lib/xen/snapshots/<domain_uuid>/snapshotdata-<snapshot_name>.xl
e.g.
snapshot_name="123"
snapshot_creationtime="123"
snapshot_save="/var/lib/xen/snapshots/5c84adcc-bd59-788a-96d2-195f9b599cfe/123.save"
TODO: do i need snapshot_disks list?
snapshot_disks=['hda', 'hdc']

2, write pod doc for upstream review.

09:21 2014-04-15
GTD
0, 9:15-17:20

1, today
1), 9:30-10:00 snapshot. see"17:04 2014-04-14"2.
2), 预约hospital.

2, next
1), try foundation model on server. hope start coding today.

10:04 2014-04-15
virtualization, beijing sync
1, chunyan
1), sr-iov
2), xen direct boot.
work with upstream qemu.
2, lin ma
1), automation team:
(1), v2v: from xen to kvm.
(2), xen:
oss test, xen-rt(regression test).
oss test base on debian.
xen-rt base on xensever.
3, bamvor
nothing special. reference work report.

13:00 2014-04-15
1,
Hi,

这个事情对我来说有限复杂。英语水平有限，写中文了，不好意思。

 >>>roger zhou <zzhou@suse.com> wrote:
> Bamvor and Team,
>
> This is a good topic I learned here. I think it is good to bring up and
> welcome discussion, debate, etc.
>
> Basically, I am not convinced to approve a leave here.  We need a
> justification for a swap leave to the community activities, which could be:
>
> a) to provide a presentation/support in the context of SUSE.
这肯定是个目标，去做presentation对公司对自己都有好处。但是是否不做presentation就不能算参与社区活动，就不能倒休，我有所怀疑。
> b) to share with the team of what we learned from community activity.
这个肯定有好处啊。我觉得可以从最轻量级的邮件分享开始。
> c) it is useful to help our day-to-day work efficiency.
部分赞同，但是应该不限于具体工作。
比如说上次ostc知道了一些git技巧: "git commit -p".
还有openstack部署上可能遇到的问题: 例如说openstack里面如果vm挂了，如何能更快的恢复服务。这和目前xen社区正在讨论的lazy restore可能有直接关系。
> d) there could be other valid reason, I think we need discuss about it.
> And you guys can comment on this.
>
> Don't get me wrong, I am more happy to approve with a valid
> justification.
我想知道公司是否已经有相关规定或约定成俗的习惯。如果已经有了，其实应该基于已有情况讨论吧。
如果没有，我们是否应该先申请公司相关更high level的manager(sunny, olaf, ...)做个解释。
> I do not want us go off track and loose our business focus.
既然已经有了邮件讨论，大家可能都需要深入思考。不知道是否不适合作为下午开会的议题。

regards

bamvor
>
> Regards,
> Roger
>
>
> 于 2014年04月14日 17:27, Bamvor Jian Zhang 写道:
> > hi, roger
> >
> > 3.30社区活动倒休。
> >
> > regards
> >
> > bamvor
> >
>
> --
> regards,
> Roger (office#:+86 10 65339283, cellphone# +86 13391978086)
>

2, (09:44 2014-04-16)
Hi, roger

 >>>roger zhou <zzhou@suse.com> wrote:

> Like we discussed slightly in the meeting, we need WIN-WIN situation, a
> justification to apply a swap leave. I can not approve a swap leave
> without a justification.
it is ok you do not approve my leave. and obviously you do not exlain all the reason which you told me in yestoday morning, meanwhile you do not answer my question in my last email.
there is something i need to say/discuss.

1), in yestoday 1:1, you said that it is unfair if you approve my swap leave, because other guys(roger, dongmao, shawn, liuhua..) do not ask this swap leave(i mean ostc2014 on 3, March).
i wonder why do you so sure others will not ask this swap leave. i do not hear others input except you.

2), in yestoday 1:1, you said that ostc is not relative to my daily work.
i doubt it. because i have learn and discuss about cloud and openstack which is relative to my work.
as you may know, i work on xen tools and libvirt. openstack use libvirt as hyperviosr management tools, and openstack support xen as well. and i have work on a bug which resolve a bug openstack:
https://bugzilla.novell.com/show_bug.cgi?id=782311
so i need to know something about openstack and clock, and i could not afford to learn openstack in a long dedicated time, such as a whole week. in contrast, in the meeting like ostc2014, i could learn openstack and clock in about 0.5day. it is very suitable for me.
last but not least, as you said yestoday, useful to daily work is probably a minor justification. if so, please write it explicitly.
if we want to clarify the company rules or traditions,  we should write it in a public place with accurate description and follow proper examples. a few sentence is not enough.
>
> Liuhua reminds me to clarify that we need one of a), or b), or c), not a
> justification for all item a) and b) and c).
3), the only reason i saw you decline my leave is no share. please correct me if i am wrong.
it is make sense to me. meanwhile the rules do not mention type of share and the depth of share. it is hard for me to follow the rules. could you please show us an example in order to do further discussion?
i am a little bit busy these days(work on snapshot patch). i would like to write a share about ostc2014. i do not mean to request the swap leave, we could discuss the specific rules base on my share. a clear and reasonal rules will make me comfortable.

4), is it a company rules about swap leave?
i have ask this yestoday, but you do not reply.
it is very important for us to know whether there is a company rules or nor, and how it works traditionally.
i do not want to cc sunny or olaf or other managers/coordinators in beijing in this emails, I guess it is your responsibility to know the company's rules or traditionals for our team.

BTW: i am busy these days and it could waste everyone time if we have a meeting again. discuss in email is a better choice for me.

regards

bamvor

>
> regards,
> Roger
>

13:09 2014-04-15
work report
1, fate
2, meeting
1), Beijing virtualization sync. 1hour.
2), beijing server team meeting. 2h
3), discuss with roger about community work.(0.5day).

14:08 2014-04-15
beijing server meeting.
1, finance
book revenue 2~3% grow.
revenue: 200m.
sles: 108m, HA 4m.

HA: roughly, 400k/person
years ago, vmware 280k, so as to windriver.

systemz
SAP. hana.
cloud: 几十k.

2, product.
sle11sp4: NCC -> SCC(suse customer center).
slepos.
opensuse: LTS(long-term support); centos like OS?

3, discuss
feature evaluation.
agile.
TDD.

4, culture.

14:24 2014-04-15
lunch and learning
A view behind the curtains of the SUSE Customer Center.
http://streaming.nue.suse.com/i/lunch_learn/ll-scc-dmayer-20140327.webm

09:48 2014-04-16
GTD
0, 9:40

1, today

10:37 2014-04-16
China All-hands meeting, andy jiang
1,
$K
China:
SUSE: 10985. huawei, zhongxing.
OEM: HP, IBM, dell.
NetIQ: 401. FY13 AVIC IDM 576k. shandong police: sentinel 200k.
novell: 17.
SVCs: 823.

HK
SUSE: 500
NetIQ: 1026
novell: 1013
SVCs: 659.

TW:
SUSE: 223
NetIQ: 902
novell: 121
SVCs: 222.

korea
SUSE: 635
NetIQ: 130
novell: 1
SVCs: 1

HP: SAP: hana.
IBM: systemZ.

2,
TM(Territory Manager): usually focus on non-suse. 或者一个suse一个非suse.
AE: acount. 大客户经理。按行业划分。
PE: 渠道经理。
TSS:
NTS
Admin.

North China: TM: Gu Yun suse. TBH non-suse. e.g. dell non-suse.
PE: North China: Kevin Shen HP, IBM, 曙光。 suse only?
HK: AE: Carol Chui. maybe do attachment in mainland China too.

3, APAC
TAG values and Beliefs Award
1), APAC
Nick Lu -- Embrace Change. TW.
Xiaoyu hu -- Think Globally. China call center.
2), Global Operations
Claudia Ping -- Celebrate Success.

4, HR update(Claudia Ping).
1), Fulfulled Vacancies: 48.
2), Recruiting Channel.
Direct Search: 15.
Internal Referral: 14.
Internal moves: 8.
Headhunter: 11.
3), On going vavancies: 5.
4), People Development
(1), promotion: 15.
(2), Lateral Move: 12.
5), HR projects
(1), Global
TAG values and reliefs.
Performance Management.
Compensation Planning.
New Celebrate. bamvor: interesting. i would like to try it.
(2), Regional/BU
Policy and Procedure Review.
Benefit Review.
SUSE EVP.

16:57 2014-04-16
GTD
1, today

10:08 2014-04-17
GTD
0, 9:40

1, today
1), 10:10-11:30 16:02-  snapshot. see"17:04 2014-04-14".

17:23 2014-04-17
software skill, virtualization, xen, qemu
device_model_override="/path/to/your/qemu
#the device model is qemu-dm(xen qemu)
device_model_version="qemu-xen-traditional"
#the device model is upstream qemu
device_model_version="qemu-xen"

17:49 2014-04-17
vm snapshot doc
--to xen-devel@lists.xen.org --cc anthony.perard@citrix.com --cc ian.jackson@eu.citrix.com --cc ian.campbell@citrix.com --cc cyliu@suse.com --jfehlg@suse.com --cc zzhou@suse.com

[RFC v2] vm snapshot documents
Hi,

here is the second version about vm snapshot documents, the first version is
here[1]

thanks Ian Jackson suggestion, i write this doc about vm snapshot including new
command, struct and api. currently, the disk snapshot(create, delete, list)
worked(patch is already sent[2]), and vm snapshot(create, delete, list) work.
but i have some questions about snapshot apply(see the last section).

feel free to comment it. thanks.

1, new command
=head1 SNAPSHOT

there are two types of snapshots supported by libxl: disk snapshot and vm
snapshot. The following subcommands management the snapshot of a domain,
including create, delete, list and apply.
a domain snapshot(or a vm snapshot) means save the domain config, memory and
disk snapshot. currently, only support qcow2 and internal disk snapshot.

the vm snapshot information will store in the follow path:
/var/lib/xen/snapshots/<domain_uuid>/snapshotdata-<snapshot_name>.xl

here is an example for snapshot information file:
snapshot_name="1397207577"
snapshot_creationtime="1397207577"
snapshot_save="/var/lib/xen/snapshots/5c84adcc-bd59-788a-96d2-195f9b599cfe/1397207577.save"

the user could give a snapshot name when vm snapshot created. if not, the epoch
seconds will set as name as the above examples.

=over 4

=item B<vm-snapshot-create> [I<OPTIONS>] I<domain-id>

create vm snapshot.
it will call the qmp transaction for creating the disk snapshot in order to
ensure the disk snapshot is coherence.
vm is paused during snapshot create, and is unpause after take snapshot
finished.

B<OPTIONS>

=over 4

=item B<-n>

vm snapshot name

=back

=item B<vm-snapshot-delete> [I<OPTIONS>] I<domain-id>

delete vm snapshot.
delete the saved memory file and snapshot information file created by
vm-snapshot-create.

B<OPTIONS>

=over 4

=item B<-n>

vm snapshot name

=back

=item B<vm-snapshot-list> I<domain-id>

list vm snapshot for the dedicated domain including snapshot name and creation
time which stored in the vm snapshot information file.

=item B<vm-snapshot-apply> [I<OPTIONS>] I<domain-id>

apply vm snapshot for the dedicated domain.

B<OPTIONS>

=over 4

=item B<-n>

vm snapshot name

=back

=item B<disk-snapshot-create> [I<OPTIONS>] I<domain-id>

create disk snapshot.

B<OPTIONS>

=over 4

=item B<-n>

disk snapshot name

=back

=item B<disk-snapshot-delete> [I<OPTIONS>] I<domain-id>

delete disk snapshot by snapshot name or snapshot id.

B<OPTIONS>

=over 4

=item B<-i>

disk snapshot id

=item B<-n>

disk snapshot name

=back

=item B<disk-snapshot-list> I<domain-id>

list disk snapshot including snapshot id, tag, vm size, date, vm clock.

=back

2, new struct and new api
1), new struct
(1), libxl_snapshot struct store a disk snapshot information, which get from
qcow2 image through "query-block" qmp command.

libxl_snapshot = Struct("snapshot",[
    ("device",        string),
    ("name",          string),
    ("id",            string),
    ("vm_state_size", uint64),
    ("date_sec",      uint64),
    ("date_nsec",     uint64),
    ("vm_clock_sec",  uint64),
    ("vm_clock_nsec", uint64),

(2), libxl_vm_snapshot store vm snapshot information which store in the path
shown above. i add some api for create, delete and list these information.
at first, i want to add these information to xenstore, but it will lose when
xenstore reboot or dom0 reboot.

libxl_vm_snapshot = Struct("vm_snapshot",[
    ("name",          string),
    ("creation_time", uint64),
    ("save",          string),
    ])

2), new api
(1), in libxl/libxl.h
/* disk snapshot api
 * support create, delete and list for internal snapshot of a single disk
 * only support internal snapshot rigt now.
 */
/* create disk snapshot according to the device name in snapshot array. nb is
 * the number of snapshot array.
 * use the qmp transaction to ensure all snapshot of disk is coherence.
 */
int libxl_disk_snapshot_create(libxl_ctx *ctx, int domid,
                               libxl_snapshot *snapshot, int nb);
/* delete number of nb disk snapshot describe in snapshot array
 */
int libxl_disk_snapshot_delete(libxl_ctx *ctx, int domid,
                               libxl_snapshot *snapshot, int nb);
int libxl__disk_snapshot_delete(libxl_ctx *ctx, int domid,
                                libxl_snapshot *snapshot);
/* apply the disk snapshot by qemu-img command
 */
int libxl_disk_snapshot_apply(libxl_ctx *ctx, int domid,
                              libxl_snapshot *snapshot, int nb);
/* list disk snapshot by qmp query-block command
 */
int libxl__disk_snapshot_list(libxl_ctx *ctx, int domid,
                              libxl_snapshot **snapshotp);

/* vm snapshot api
 */
/* write vm snapshot information to file
 */
int libxl_vm_snapshot_add(libxl_ctx *ctx, uint32_t domid,
                          libxl_vm_snapshot *snapshot,
                          const libxl_asyncop_how *ao_how)
                          LIBXL_EXTERNAL_CALLERS_ONLY;
/* delete vm snapshot information file
 */
int libxl_vm_snapshot_remove(libxl_ctx *ctx, uint32_t domid,
                             libxl_vm_snapshot *snapshot,
                             const libxl_asyncop_how *ao_how)
                             LIBXL_EXTERNAL_CALLERS_ONLY;
/* list vm snapshot from file
 */
libxl_vm_snapshot *libxl_vm_snapshot_list(libxl_ctx *ctx, uint32_t domid,
                                          int *num)
                                          LIBXL_EXTERNAL_CALLERS_ONLY;
/* read vm snapshot information from dedicated file
 */
int libxl_vm_snapshot_getinfo(libxl_ctx *ctx, uint32_t domid,
                              libxl_vm_snapshot *snapshot);
/* delete vm save image */
int libxl_vm_snapshot_delete_save_image(libxl_ctx *ctx,
                                        libxl_vm_snapshot *snapshot);

(2), libxl/xl_cmdimpl.c
/* get disk device name (hda, hdc..) and image path through
 * libxl_device_disk_list and libxl_device_disk_getinfo
 */
static int get_disk(uint32_t domid, libxl_snapshot **snapshotp, char *name);

3, question
1), how to do disk snapshot apply?
when i apply the vm snapshot, i need to revert the disk snapshot. in qemu, it is
done by bdrv_snapshot_goto api. this api is only called by loadvm hmp or
qemu-img commands.
there is no hmp api in libxl. so the only choice is using qemu-img command.
i know usually i should call qmp for qemu operation. but there is not qmp at
the moment, could i call qemu-img in libxl for disk snapshot apply?

[1] http://lists.xen.org/archives/html/xen-devel/2014-04/msg00414.html
[2] http://lists.xen.org/archives/html/xen-devel/2014-04/msg00244.html

21:51 2014-04-17
Hi,
 >>>roger zhou <zzhou@suse.com> wrote:

> 于 2014年04月16日 13:46, Bamvor Jian Zhang 写道:
> > Hi, roger
> >
> >   >>>roger zhou <zzhou@suse.com> wrote:
> >
> >> Like we discussed slightly in the meeting, we need WIN-WIN situation, a
> >> justification to apply a swap leave. I can not approve a swap leave
> >> without a justification.
> > it is ok you do not approve my leave.
>
> Bamvor,
>
> No intention against yourself, just don't get me wrong.
>
> To add more words on my opinion further,
>
> - I don't want to set the tone/atmosphere of the team to think SUSE by
> default will pay us for community events. Working day is the cost of
> SUSE :)  SUSE has no problem to pay for once or twice. But if it takes 5
> ~ 10 days a year without a plan, it is a problem. I don't know how many
> you anticipate for a year. Guys, you can give me some rough number.
basically, i join two activities last year.
1, arm technology symposia 2013 on 27, Nov in Beijing.
http://www.arm.com/zh/about/events/arm-technology-symposia-2013-china.php
here is the notes on that event: "14:03 2013-11-27"

2, ouros activity("开源力量公开课2013年度庆典：我们的开源项目") on 29, Dec.
news: http://code.csdn.net/news/2818866
my slide: http://share.csdn.net/slides/1347
and the Beijing sle team give me a chance excise this presentation on 24, Dec.
(Beijing sle team lunch and learning)
>
> - Go further a little, this is correlated to another email I sent out on
> April 3 in the title "[JUNK] 存储领域主要顶级会议". SUSE want to spend
> money on community events wisely. I can't agree more. I know our
> management team also very much encourage us to *support* local community
> event. It is low cost.
>
> If I have to give some reason why I am not in favor to approve your
> request smoothly, they are:
> a) we need be *professional justification* to swap a working day leave
> b) we need plan thing *ahead of time*. Coincidentally, you took leave on
> Apr 4th because of one previous community event.
it looks like you are curious about the "previous community event". it is the
presentation on the ouros activity, see above.
> Sorry, I can't convince
> myself to keep approving leave like this.
>
> >   and obviously you do not exlain all the reason which you told me in
> yestoday morning, meanwhile you do not answer my question in my last email.
> > there is something i need to say/discuss.
> >
> > 1), in yestoday 1:1, you said that it is unfair if you approve my swap
> leave, because other guys(roger, dongmao, shawn, liuhua..) do not ask this
> swap leave(i mean ostc2014 on 3, March).
> > i wonder why do you so sure others will not ask this swap leave. i do not
> hear others input except you.
>
> Haha, thanks Dongmao and Liuhua, they replied individually. I still need
> reply them separately, if need, later.
>
> >
> > 2), in yestoday 1:1, you said that ostc is not relative to my daily work.
> > i doubt it.
>
> We have different skill set and competencies. I believe you learn
> something from ostc and it is useful. It is just so hard for me to say
> it is very close related to our work.
>
> > because i have learn and discuss about cloud and openstack which is
> relative to my work.
> > as you may know, i work on xen tools and libvirt. openstack use libvirt as
> hyperviosr management tools, and openstack support xen as well. and i have
> work on a bug which resolve a bug openstack:
> > https://bugzilla.novell.com/show_bug.cgi?id=782311
> > so i need to know something about openstack and clock, and i could not
> afford to learn openstack in a long dedicated time, such as a whole week. in
> contrast, in the meeting like ostc2014, i could learn openstack and clock in
> about 0.5day. it is very suitable for me.
> > last but not least, as you said yestoday, useful to daily work is probably
> a minor justification. if so, please write it explicitly.
> > if we want to clarify the company rules or traditions,  we should write it
> in a public place with accurate description and follow proper examples. a few
> sentence is not enough.
>
> Come on, I am not in favor of "rules"/"accurate description" like you
> said, it is not SUSE culture. Also we want to spend time and energy on
> more value area. I came up with a/b/c as options for me to convince
> myself before I apply a swap leave, and I would like to share with you.
> Like I said in d), could be other options.
>
> >>
> >> Liuhua reminds me to clarify that we need one of a), or b), or c), not a
> >> justification for all item a) and b) and c).
> > 3), the only reason i saw you decline my leave is no share. please correct
> me if i am wrong.
> > it is make sense to me. meanwhile the rules do not mention type of share
> and the depth of share. it is hard for me to follow the rules. could you
> please show us an example in order to do further discussion?
>
> I hope this get answered.
>
> > i am a little bit busy these days(work on snapshot patch). i would like to
> write a share about ostc2014. i do not mean to request the swap leave, we
> could discuss the specific rules base on my share. a clear and reasonal rules
> will make me comfortable.
>
> Carry on your "snapshot patch", I don't want to waste of your time. That
> is the business matters stuff.
>
> I am sure you like to share ostc2014. If you set a tentative goal (, and
> the better case to set a plan, like, to give a talk in 2 weeks) in the
> initial email, I think it is professional enough for me to approve it
> from the beginning. Side note: to do a talk right after the event is
> more appropriate, because it is fresh. Longer time later, it will take
> more longer time to prepare the talk is not wise.
>
> >
> > 4), is it a company rules about swap leave?
> > i have ask this yestoday, but you do not reply.
> > it is very important for us to know whether there is a company rules or
> nor, and how it works traditionally.
> > i do not want to cc sunny or olaf or other managers/coordinators in beijing
> in this emails, I guess it is your responsibility to know the company's rules
> or traditionals for our team.
>
> I hope you are clear my opinion in previous replies.
>
> >
> > BTW: i am busy these days and it could waste everyone time if we have a
> meeting again. discuss in email is a better choice for me.
>
> Thanks for the time consideration for the team.
>
>
> >
> > regards
> >
> > bamvor
> >
> >>
> >> regards,
> >> Roger
> >>
> >>
> >> 于 2014年04月15日 13:21, Bamvor Jian Zhang 写道:
> >>> Hi,
> >>>
> >>> 这个事情对我来说有限复杂。英语水平有限，写中文了，不好意思。
> >>>
> >>>    >>>roger zhou <zzhou@suse.com> wrote:
> >>>> Bamvor and Team,
> >>>>
> >>>> This is a good topic I learned here. I think it is good to bring up and
> >>>> welcome discussion, debate, etc.
> >>>>
> >>>> Basically, I am not convinced to approve a leave here.  We need a
> >>>> justification for a swap leave to the community activities, which could be:
> >>>>
> >>>> a) to provide a presentation/support in the context of SUSE.
> >>> 这肯定是个目标，去做presentation对公司对自己都有好处。但是是否不做presentation就不能算参与社区活动，就不能倒休，我有所怀疑。
>
> I think this get answered.
>
> >>>> b) to share with the team of what we learned from community activity.
> >>> 这个肯定有好处啊。我觉得可以从最轻量级的邮件分享开始。
>
> Yes, email sharing is light weighted if no better one.
>
> >>>> c) it is useful to help our day-to-day work efficiency.
> >>> 部分赞同，但是应该不限于具体工作。
> >>> 比如说上次ostc知道了一些git技巧: "git commit -p".
> >>> 还有openstack部署上可能遇到的问题: 例如说openstack里面如果vm挂了，如何能更快的恢复服务。这和目前xen社区正在讨论的lazy
> >> restore可能有直接关系。
>
> This is a good takeaway from the meeting. This has to be a gray area. I
> don't think I can, nor it is necessary to measure how to be closely
> related to our daily work.
if you do not know, you could ask others one help. and of course it is necessary
to measure. if you don't, how could you so sure this activities is not relative
to my work. i need take it as example for further swap leave i may request.
as i said in the today before yesterday, i already give up the swap leave for
ostc 2014. so your measure result will not affect my current leave.

regards

bamvor

>
>
> >>>> d) there could be other valid reason, I think we need discuss about it.
> >>>> And you guys can comment on this.
> >>>>
> >>>> Don't get me wrong, I am more happy to approve with a valid
> >>>> justification.
> >>> 我想知道公司是否已经有相关规定或约定成俗的习惯。如果已经有了，其实应该基于已有情况讨论吧。
> >>> 如果没有，我们是否应该先申请公司相关更high level的manager(sunny, olaf, ...)做个解释。
>
> Again, SUSE does support our community activity, and with keep in mind
> to make the participation more related to SUSE. I hope it is more clear
> during this conversation.
>
> And I do thank you for discussion/debate. That's why I write
> "Transparent" yesterday in our team meeting.
>
>
> Regards,
> Roger
>
> >>>> I do not want us go off track and loose our business focus.
> >>> 既然已经有了邮件讨论，大家可能都需要深入思考。不知道是否不适合作为下午开会的议题。
> >>>
> >>> regards
> >>>
> >>> bamvor
> >>>> Regards,
> >>>> Roger
> >>>>
> >>>>
> >>>> 于 2014年04月14日 17:27, Bamvor Jian Zhang 写道:
> >>>>> hi, roger
> >>>>>
> >>>>> 3.30社区活动倒休。
> >>>>>
> >>>>> regards
> >>>>>
> >>>>> bamvor
> >>>>>
> >>>> --
> >>>> regards,
> >>>> Roger (office#:+86 10 65339283, cellphone# +86 13391978086)
> >>>>
> >>>>
> >>
> >> --
> >> regards,
> >> Roger (office#:+86 10 65339283, cellphone# +86 13391978086)
> >>
> >>
>
> --
> regards,
> Roger (office#:+86 10 65339283, cellphone# +86 13391978086)
>
>

16:37 2014-04-18
software skill, build service, obs, ibs, maintainer, bugowner; doc, getting startted
requestmaintainership (reqbs, reqbugownership,  reqmaintainership, reqms, requestbugownership)
    requests to add user as maintainer or bugowner

18:11 2014-04-18
GTD
0, -18:10

16:26 2014-04-21
GTD
1, today
1), 16:26-17:30 snapshot

09:21 2014-04-22
GTD
0, 9:15

1, today
1), 09:21-11:30 14:30-17:22 snapshot. see"09:22 2014-04-22"
2), lunch; search for kindle.
3), 30' nap.
4), Summary
(1), 7:30起床，到公司刚干一会儿(9:47)就困了，还要继续努力啊。
(2), 干了一天，效率并不高，感觉每天都是下午才进入状态。

2, TODO
1), work report
2), shenzhou, zuche.com.
3), coding excises: glob.

09:22 2014-04-22
snapshot
1, plan
1), today: finish snapshot function.
2), tomorrow: add a new snapshot.c

2, morning
finish except parse to/from file. do it afternoon.

16:07 2014-04-22
kernel direct boot, kvm
pc-bios/optionrom/linuxboot.S:
load kernel and initrd from host according to fw_cfg.

reference commit:
commit 57a46d0579951d7abbcbe86766f73afa93a5d370
Author: Alexander Graf <agraf@suse.de>
Date:   Thu Nov 12 21:53:14 2009 +0100

08:08 2014-04-23
virtualization, sync
1, snapshot
1), GSOC libvirt.

11:51 2014-04-23
30c3, exploitation, arm
1, stephen C lawler
http://dontstuffbeansupyournose.com/2012/01/12/practical-arm-exploitation-a-new-training/
https://docs.google.com/viewer?url=http://dl.dropbox.com/u/2595211/Lab_Manual_Preview.pdf
2, advanced arm exploitation
1), rop
2), stack flip(?).

13:13 2014-04-23
GTD
0, 11:30-18:20

1, today
1), 8:00-8:45 virtualization sync. see"08:08 2014-04-23".
2), 13:40-18:18 reply Jim email about snapshot. see"13:28 2014-04-23"

2, TODO
[1] - http://dmarlin.fedorapeople.org/yum/f21/
[2] - https://fedoraproject.org/wiki/Architectures/ARM/AArch64/QuickStart

13:28 2014-04-23
snapshot, jim reply
Re: [Xen-devel] [RFC v2] vm snapshot documents
To: Bamvor Jian Zhang <bjzhang@xxxxxxxx>
From: Jim Fehlig <jfehlig@xxxxxxxx>
Date: Tue, 22 Apr 2014 21:31:19 -0600
Cc: Zhiqiang Zhou <ZZhou@xxxxxxxx>, Ian Campbell <Ian.Campbell@xxxxxxxxxx>, Ian Jackson <Ian.Jackson@xxxxxxxxxxxxx>,    Chun Yan Liu <CYLiu@xxxxxxxx>, xen-devel@xxxxxxxxxxxxx, Anthony.perard@xxxxxxxxxx
Delivery-date: Wed, 23 Apr 2014 03:31:31 +0000
List-id: Xen developer discussion <xen-devel.lists.xen.org>

> Bamvor Jian Zhang wrote:
> > Hi,
> > here is the second version about vm snapshot documents, the first version is
> > here[1]
> Hi Bamvor,
>
> Thanks for being adventurous and starting this work :-).
thanks for your reply.
>
> > thanks Ian Jackson suggestion, i write this doc about vm snapshot including
> > new
> > command, struct and api. currently, the disk snapshot(create, delete, list)
> > worked(patch is already sent[2]), and vm snapshot(create, delete, list) work.
> > but i have some questions about snapshot apply(see the last section).
> >
> > feel free to comment it. thanks.
> >
> > 1, new command
> > =head1 SNAPSHOT
> >
> > there are two types of snapshots supported by libxl: disk snapshot and vm
> > snapshot.
>
> Here and throughout, you should be consistent with the use of 'vm'
> verses 'domain'. For the most part, the existing docs use 'domain'.
>
> It would be good to provide more detail about these types of snapshots
> too. E.g. a disk snapshot will only be crash-consistent if the domain is
> running. Disk snapshots can also be internal (qcow2) or external
> (snapshot in one file, delta in another).
>
> Domain snapshots include disk snapshots and domain state, allowing to
> resume the domain from the same state when the snapshot was created.
> This type of snapshot is also referred to as a domain checkpoint or
> system checkpoint.
thanks, i will add more description in next version.
>
> >  The following subcommands management the snapshot of a domain,
> > including create, delete, list and apply.
> >
>
> I struggle over apply vs revert, but lean toward the latter.
so as to me.
>
> > a domain snapshot(or a vm snapshot) means save the domain config, memory and
> > disk snapshot. currently, only support qcow2 and internal disk snapshot.
> >
> > the vm snapshot information will store in the follow path:
> > /var/lib/xen/snapshots/<domain_uuid>/snapshotdata-<snapshot_name>.xl
> >
> > here is an example for snapshot information file:
> > snapshot_name="1397207577"
> > snapshot_creationtime="1397207577"
> > snapshot_save="/var/lib/xen/snapshots/5c84adcc-bd59-788a-96d2-195f9b599cfe/1397207577.save"
> >
>
> The snapshot prefix seems redundant. A 'description' entry would be
> useful too.
ok.
>
> > the user could give a snapshot name when vm snapshot created. if not, the
> > epoch
> > seconds will set as name as the above examples.
> >
> > =over 4
> >
> > =item B<vm-snapshot-create> [I<OPTIONS>] I<domain-id>
> >
> > create vm snapshot.
> > it will call the qmp transaction for creating the disk snapshot in order to
> > ensure the disk snapshot is coherence.
> > vm is paused during snapshot create, and is unpause after take snapshot
> > finished.
> >
>
> I think the user should be able to choose whether to live snapshot vs
> pausing/unpausing, via an option. E.g. 'xl snapshot-create <dom> ...
> --live'.
i agree that live snapshot may be useful. meanwhile i am not sure how could i
implement the live snapshot. it might be hard to ensure the consistent between
memory and disk.
>
> > B<OPTIONS>
> >
> > =over 4
> >
> > =item B<-n>
> >
> > vm snapshot name
> >
> > =back
> >
> > =item B<vm-snapshot-delete> [I<OPTIONS>] I<domain-id>
> >
>
> This should take a snapshot name, since a domain could have several.
yes, see the option "-n" below.
>
> > delete vm snapshot.
> > delete the saved memory file and snapshot information file created by
> > vm-snapshot-create.
> >
> > B<OPTIONS>
> >
> > =over 4
> >
> > =item B<-n>
> >
> > vm snapshot name
> >
> > =back
> >
> > =item B<vm-snapshot-list> I<domain-id>
> >
> > list vm snapshot for the dedicated domain including snapshot name and creation
> > time which stored in the vm snapshot information file.
> >
>
> This could behave like domain listing in xl. E.g. 'xl snapshot-list
> <dom>' will list all snapshots. 'xl snapshot-list --long <dom>' will
> list detailed info about all snapshots. 'xl snapshot-list --long <dom>
> <snapshot-name>' will list detailed info on the requested snapshot.
yeah, it it usefull. i will add this feature.
>
> > =item B<vm-snapshot-apply> [I<OPTIONS>] I<domain-id>
> >
> > apply vm snapshot for the dedicated domain.
> >
> > B<OPTIONS>
> >
> > =over 4
> >
> > =item B<-n>
> >
> > vm snapshot name
> >
> > =back
> >
> > =item B<disk-snapshot-create> [I<OPTIONS>] I<domain-id>
> >
> > create disk snapshot.
> >
> > B<OPTIONS>
> >
> > =over 4
> >
> > =item B<-n>
> >
> > disk snapshot name
> >
> > =back
> >
> > =item B<disk-snapshot-delete> [I<OPTIONS>] I<domain-id>
> >
> > delete disk snapshot by snapshot name or snapshot id.
> >
> > B<OPTIONS>
> >
> > =over 4
> >
> > =item B<-i>
> >
> > disk snapshot id
> >
> > =item B<-n>
> >
> > disk snapshot name
> >
> > =back
> >
> > =item B<disk-snapshot-list> I<domain-id>
> >
> > list disk snapshot including snapshot id, tag, vm size, date, vm clock.
> >
> > =back
> >
>
> IMO, the vm-snapshot-* and disk-snapshot-* subcommands can be combined
> into one snapshot-*, and passing an option for disk only snapshots. E.g.
> 'xl snapshot-create <dom> ... --disk-only'.
sure.
>
> > 2, new struct and new api
> > 1), new struct
> > (1), libxl_snapshot struct store a disk snapshot information, which get from
> > qcow2 image through "query-block" qmp command.
> >
> > libxl_snapshot = Struct("snapshot",[
> >     ("device",        string),
> >
>
> Should this be libxl_device_disk instead of a string? And should
> multiple be supported, allowing control over which of a domain's disks
> are included in the snapshot?
one libxl_snapshot represent one disk. see my comment below.
>
> "description" would be helpful.
>
> >     ("id",            string),
> >     ("vm_state_size", uint64),
> >     ("date_sec",      uint64),
> >     ("date_nsec",     uint64),
> >     ("vm_clock_sec",  uint64),
> >     ("vm_clock_nsec", uint64),
> >
>
> A lot of these are read-only and wouldn't be provided when calling
> libxl_snapshot_create(). I think adding the domain state at time of
> snapshot would be useful.
do you mean the stopped or running state for a domain?
> There are probably other items I'm not
> considering atm, which makes me nervous about future extensibility.
so, how about this?
 libxl_vm_snapshot = Struct("vm_snapshot",[
     ("name",          string),
     ("creation_time", uint64),
     ("save",          string),
+    ("state",         string),
+    ("disks", Array(libxl_snapshot, "num_disks")),
     ])

BTW: maybe i should rename libxl_snapshot to libxl_disk_snapshot?

>
> > (2), libxl_vm_snapshot store vm snapshot information which store in the path
> > shown above. i add some api for create, delete and list these information.
> > at first, i want to add these information to xenstore, but it will lose when
> > xenstore reboot or dom0 reboot.
> >
> > libxl_vm_snapshot = Struct("vm_snapshot",[
> >     ("name",          string),
> >     ("creation_time", uint64),
> >     ("save",          string),
> >     ])
> >
> > 2), new api
> > (1), in libxl/libxl.h
> > /* disk snapshot api
> >  * support create, delete and list for internal snapshot of a single disk
> >  * only support internal snapshot rigt now.
> >  */
> > /* create disk snapshot according to the device name in snapshot array. nb is
> >  * the number of snapshot array.
> >  * use the qmp transaction to ensure all snapshot of disk is coherence.
> >  */
> > int libxl_disk_snapshot_create(libxl_ctx *ctx, int domid,
> >                                libxl_snapshot *snapshot, int nb);
> > /* delete number of nb disk snapshot describe in snapshot array
> >  */
> > int libxl_disk_snapshot_delete(libxl_ctx *ctx, int domid,
> >                                libxl_snapshot *snapshot, int nb);
> > int libxl__disk_snapshot_delete(libxl_ctx *ctx, int domid,
> >                                 libxl_snapshot *snapshot);
> > /* apply the disk snapshot by qemu-img command
> >  */
> > int libxl_disk_snapshot_apply(libxl_ctx *ctx, int domid,
> >                               libxl_snapshot *snapshot, int nb);
> > /* list disk snapshot by qmp query-block command
> >  */
> > int libxl__disk_snapshot_list(libxl_ctx *ctx, int domid,
> >                               libxl_snapshot **snapshotp);
> >
> > /* vm snapshot api
> >  */
> > /* write vm snapshot information to file
> >  */
> > int libxl_vm_snapshot_add(libxl_ctx *ctx, uint32_t domid,
> >                           libxl_vm_snapshot *snapshot,
> >                           const libxl_asyncop_how *ao_how)
> >                           LIBXL_EXTERNAL_CALLERS_ONLY;
> > /* delete vm snapshot information file
> >  */
> > int libxl_vm_snapshot_remove(libxl_ctx *ctx, uint32_t domid,
> >                              libxl_vm_snapshot *snapshot,
> >                              const libxl_asyncop_how *ao_how)
> >                              LIBXL_EXTERNAL_CALLERS_ONLY;
> > /* list vm snapshot from file
> >  */
> > libxl_vm_snapshot *libxl_vm_snapshot_list(libxl_ctx *ctx, uint32_t domid,
> >                                           int *num)
> >                                           LIBXL_EXTERNAL_CALLERS_ONLY;
> > /* read vm snapshot information from dedicated file
> >  */
> > int libxl_vm_snapshot_getinfo(libxl_ctx *ctx, uint32_t domid,
> >                               libxl_vm_snapshot *snapshot);
> > /* delete vm save image */
> > int libxl_vm_snapshot_delete_save_image(libxl_ctx *ctx,
> >                                         libxl_vm_snapshot *snapshot);
> >
>
> IMO, these too should be combined into libxl_snapshot_*(), with disk vs
> domain snapshot controlled via a flags argument.
maybe the function name is not clear. i will call the above function in the
libxl_snapshot_create(), like this:
libxl_snapshot_create()
{
    //save memory
    save_domain
    //get disk list
    get_disk
    //create disk snapshot according to disk list
    libxl__disk_snapshot_create
    //store snapshot information to file, maybe libxl_snapshot_store is more
    //clear?
    libxl_snapshot_add
    //unpause
    libxl_domain_unpause
}

but i have some problems while i write libxl_snapshot_* apis.
firstly, there are different routines about vm save/restore because in libvirt
the driver need to interact between libvirtd.
secondly, i want to reuse the save_domain, create_domain in xl_cmdimpl.c.
so, it is hard to me to provided the domain snapshot api directly. if i only
provide some sub-command for domain snapshot, it just like
libxl_domain_suspend in save_doman or libxl_domain_new in create_domain, it
might be easier for libvirt driver to implement snapshot.
is it make sense? or is there a better way to provide the domain snapshot api?

>
> > (2), libxl/xl_cmdimpl.c
> > /* get disk device name (hda, hdc..) and image path through
> >  * libxl_device_disk_list and libxl_device_disk_getinfo
> >  */
> > static int get_disk(uint32_t domid, libxl_snapshot **snapshotp, char *name);
> >
> > 3, question
> > 1), how to do disk snapshot apply?
> > when i apply the vm snapshot, i need to revert the disk snapshot. in qemu, it
> > is
> > done by bdrv_snapshot_goto api. this api is only called by loadvm hmp or
> > qemu-img commands.
> > there is no hmp api in libxl. so the only choice is using qemu-img command.
> > i know usually i should call qmp for qemu operation. but there is not qmp at
> > the moment, could i call qemu-img in libxl for disk snapshot apply?
> >
>
> Similar to the libvirt qemu driver, is it possible to use both qmp and
> hmp monitors in libxl?
after check the qemu code, i found that there is a qmp command
(human-monitor-command) could send hmp through qmp. so i could use loadvm and
savevm in xen.
loadvm will restore vm state and disk snapshot. i could call savevm for domain
snapshot in order to provide the qemu save file for loadvm.
for the snapshot with external snapshot, i will call save_domain for memory
save and qmp transaction for disk snapshot.
as a result, similar to libvirt, create support external disk snapshot. but
revert do not support.
and i will call different vm memory save function: qemu_save_device_state and
qemu_savevm_state depends on.

                                create        revert      mem save api
without external disk snasphot  savevm        loadvm      qemu_save_device_state

with external disk snasphot     save_domain   no support  qemu_savevm_state
                                +transaction

is it make sense?


regards

bamvor
>
> Regards,
> Jim

2,
qmp_xen_save_devices_state

13:52 2014-04-23
backup, crash-consistent, application-consistent
1, http://searchdatabackup.techtarget.com/answer/Crash-consistent-vs-application-consistent-backups-of-virtual-machines
A crash-consistent backup set means the backup captured all of the virtual machine's data at exactly the same time. This is how essentially all modern backup software functions. Crash-consistent backups are fine and work well for the most part for nondatabase applications. When a crash-consistent backup is recovered and restored, the data is in the identical state it was in at the time of the backup.

Crash-consistent backups don't work nearly as well for database applications because they do not capture data in memory or any pending I/O operations. As such, restoring from a crash-consistent backup requires extra work, such as journaling forward, before an application can be brought back online.

In addition to providing a crash-consistent backup, application-consistent backups also capture all data in memory and all transactions in process. This is performed by using some type of client software co-resident with the database application or, in the case of Microsoft Windows and Hyper-V, the VSS API, to quiesce the database application, flush its memory cache, complete all its writes in order and then perform the backup.

When the backup or snapshot is complete, the software notifies the database application to resume. A restoration of an application-consistent backup requires no additional work to restore the database application.

2, http://www.altaro.com/hyper-v/vss-crash-consistent-vs-application-consistent-vss-backups-post-1-of-2/

17:15 2014-04-23
software, SCM, git, search changes
1, git blame -Lstart,end filename
2, git log -Sstring
3, git bisect
http://blog.morebits.org/?p=147
如何定位来自对方的哪个commit造成了bug？(当然，bug可能在对方的代码中并不存在，是合并后代码共同作用的结果。)如何找出是哪个commit造成的合并结果，也是同样麻烦。
学计算机的人都知道二分搜索，加快查找速度，git bisect做的正是此事。(注意这个命令的名字，非常贴切: bisect=BInary SEarch CommiT)通过使用bisect start 设置好二分的界限，之后bisect将本地代码的状态滚动到中间的某个commit，之后，我们验证当前代码库是否有bug存在，使用bisect good/bad标志当前commit。bisect接收到指令之后，会继续在剩下的区间进行二分查找。

12:52 2014-04-24
GTD
1, today
1), 12:53-15:20 bnc#874225. see"12:53 2014-04-24"
2), 10' help chunyan install xen hypervisor.
3), 30' nap.

3), chaoyang hospital.

12:53 2014-04-24
bnc#874225
1, install a system with qcow2.
2, reference eric reply.
Chun Yan Liu: https://www.redhat.com/archives/libvirt-users/2013-February/msg00095.html
Chun Yan Liu: https://www.redhat.com/archives/libvirt-users/2013-April/msg00137.html
3, reply
1), Customer reported that with 'virsh snapshot-create' the "disk size" can grow beyond "virtual size"
the virtual size is how much disk used from the vm point of view.
the disk size is how much disk used in host. So, it combine with two part. the first part is how much disk actual used by vm(if there is a back file for this disk, here is the differential). the second part is the sum of the vm size in each snapshot.
so, the disk size beyond virtual size is not a problem.

2), 'virsh snapshot-delete' doesn't free disk
virsh snapshot-delete will only decrease the reference count, it will not free the disk size.
i do not see any further changes about this.

reference:
https://www.redhat.com/archives/libvirt-users/2013-February/msg00095.html
https://www.redhat.com/archives/libvirt-users/2013-April/msg00137.html

14:25 2014-04-24
software skill, build service, obs, ibs, submit
[devel] submit request from external to internal OBS is working now
adrian@suse.de

Often requested, finally available:

submit requests from external OBS instance to internal instance is
working now.

You need to create it in internal instance and refer to the external
project using the openSUSE.org: prefix. For example:

 iosc sr openSUSE.org:openSUSE:Tools build SUSE:SLE-12:GA

creates a submit request for SLE 12 submission.

What is not working is the ---cleanup option, since the
internal OBS instance can not change source in external
one.

hope this makes live a bit easier for you.

PS: iosc is the recommend bash alias

alias iosc="osc -A https://api.suse.de"

15:01 2014-04-24
1, improve tmux copy

2, vim
some useful vim short cut

Ctrl+r,"

3, cscope getting started
Ctrl+\

4, translate git skill.

16:29 2014-04-24
snapshot, libvirt, qemu, snapshot commit howto
https://www.redhat.com/archives/libvirt-users/2013-February/msg00095.html
1, for external snapshot
Use 'virsh help blockcommit' or 'virsh help blockpull' to see more
details on the commands, and use 'virsh domblklist $dom' to see a list
of disk names tied to a given domain.  Personally, I like the '--wait
--verbose' flags, as it gives a nice log of progress in a potentially
long-running operation.
2, virsh blockcopy

18:32 2014-04-24
software skill, socket
1, could not connect host:port because of rpcbind not start.
# rcrpcbind start
# ps aux|grep rpcbind
root      4907  0.0  0.0  30308  1252 ?        Ss   18:31   0:00 /sbin/rpcbind -w -f
root      4930  0.0  0.0   8304   860 pts/2    S+   18:32   0:00 grep --color rpcbind

BTW: here is a socket tools: socat.

reference:
http://superuser.com/questions/502875/linux-named-sockets-howto
http://www.dest-unreach.org/socat/
http://www.cyberciti.biz/faq/linux-unix-tcp-port-forwarding/

18:46 2014-04-24
debug migration
1, socket issue, see"18:32 2014-04-24"1.
2, xs_watch will create a thread(read_thread) when it is called at the first time.

13:06 2014-04-25
bnc#865219, usb passthrough
1, machine
--- Comment #33 from Flavio Pereira <fpereira@suse.com> 2014-04-24 15:54:53 UTC ---
*** THIS IS A PRIVATE COMMENT ***
Yes, you can reboot the host if necessary.

Here are the credentials:

Xen host: 151.155.234.28
Username: root
Password: novell

Virtual Machines (You can access using rdesktop):

WIN2K8R2SP1-01: 151.155.232.217
Username: Administrator
Password: N0v3ll1234


Windows-2003: 151.155.232.135
Username: Administrator
Password: N0v3ll1234


USB dongle attached to the host server:

# xm usb-list-assignable-devices
4-2          : ID 0529:0001 AKS HASP HL 3.25

Let me know if you need any other information.

2, log
0xffffffffffffffff in ?? ()
(gdb) where
#0  0xffffffffffffffff in ?? ()
#1  0x00000000004702d1 in uhci_broadcast_packet (s=<optimized out>,
    p=0xb24210)
    at /usr/src/debug/xen-4.2.4-testing/tools/qemu-xen-traditional-dir/hw/usb-uhci.c:662
#2  0x0000000000470b56 in uhci_handle_td (int_mask=<optimized out>,
    td=<optimized out>, addr=<optimized out>, s=<optimized out>)
    at /usr/src/debug/xen-4.2.4-testing/tools/qemu-xen-traditional-dir/hw/usb-uhci.c:822
#3  uhci_process_frame (s=0xb1bb50)
    at /usr/src/debug/xen-4.2.4-testing/tools/qemu-xen-traditional-dir/hw/usb-uhci.c:967
#4  0x0000000000470d80 in uhci_async_complete (packet=<optimized out>,
    opaque=0xb24210)
    at /usr/src/debug/xen-4.2.4-testing/tools/qemu-xen-traditional-dir/hw/usb-uhci.c:855
#5  0x000000000049da85 in usb_packet_complete (p=<optimized out>)
    at hw/usb.h:224
#6  async_complete (opaque=<optimized out>) at usb-linux.c:286
#7  0x000000000040948e in main_loop_wait (timeout=0)
    at /usr/src/debug/xen-4.2.4-testing/tools/qemu-xen-traditional-dir/vl.c:3810
#8  0x000000000047fe0a in main_loop () at helper2.c:609
#9  0x000000000040d689 in main (argc=33, argv=0x7fff44c38928,
    envp=<optimized out>)
    at /usr/src/debug/xen-4.2.4-testing/tools/qemu-xen-traditional-dir/vl.c:6195

3,
Hi, Flavio

i could reproduce the seg fault you mentioned above. this seq fault is led by invalid function handles in dev in uhci_broadcast_packet(qemu-xen-tradition-dir/hw/usb-uhci.c). i am not dig into such code right now, but as a usb2.0 device(see my comment below), only pvusb is supported according to the xen doc[1]. as a pvusb device, we need a driver for xen usb virtual host(created by "xm usb-hc-create"), but i do not found it in vmdp 2.1 and i do not found relative desription in sles11 sp2 release notes. does anyone confirm whether we support pvusb in windows guest or not?

from lsusb result, we could know this is a usb2.0 device(bcdUSB 2.00). and there is no endpoint descriptor for customer device. it might explain why i get difference test result(usb2.0 not work and guest do not crash), i use usbdisk as usb2.0 device(two endpoint list in lsusb).

lsusb -vvv:
Bus 004 Device 002: ID 0529:0001 Aladdin Knowledge Systems HASP v0.06
Device Descriptor:
  bLength                18
  bDescriptorType         1
  bcdUSB               2.00
  bDeviceClass          255 Vendor Specific Class
  bDeviceSubClass         0
  bDeviceProtocol         0
  bMaxPacketSize0         8
  idVendor           0x0529 Aladdin Knowledge Systems
  idProduct          0x0001 HASP v0.06
  bcdDevice            3.25
  iManufacturer           1 AKS
  iProduct                2 HASP HL 3.25
  iSerial                 0
  bNumConfigurations      1
  Configuration Descriptor:
    ...
    Interface Descriptor:
      bLength                 9
      bDescriptorType         4
      bInterfaceNumber        0
      bAlternateSetting       0
      bNumEndpoints           0
      bInterfaceClass       255 Vendor Specific Class
      bInterfaceSubClass      0
      bInterfaceProtocol      0
      iInterface              0
      ** UNRECOGNIZED:  02 ff

[1] http://wiki.xen.org/wiki/XL_vs_Xend_Feature_Comparison

4, Jason
Hi, Jason, kirk

do we support pvusb on windows guest? it need a xen usb virtual host driver in guest, reference my preview reply.
if not, i guess we could not support customer's usb2.0 device.

reference:
[1] xen usb passthrough support:
http://wiki.xen.org/wiki/XL_vs_Xend_Feature_Comparison
[2] qemu-dm could not support usb2.0 device:
https://bugs.launchpad.net/qemu/+bug/685096

18:13 2014-04-25
GTD
0, -18:15

1, today
1), help liuhua wang debug clvm bug: memory allocation. "alloca"
2), 13:06-18:10 bnc#865219, usb passthrough. see"13:06 2014-04-25"
interrupted by go to bank. 40'

2, TODO
1), coding excise.
glob, alloca.
2, arm64
aarch64 small environment build up.

