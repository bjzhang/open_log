.LOG
09:54 2013-03-04
1, "Claudia Ping"_email_"Welcome Zhi Wei Sun, SUSE Business Development, APAC"_20130301_1600
Hi all,
 
Zhi Wei Sun joined SUSE as Business Development Manager for APAC based in Beijing office. 
 
Teaming with APAC Sales team, he is responsible for supporting SUSE strategy - Enterprise Linux, Cloud, and Integrated Systems - in penetrating existing markets and attracting new customers.
 
Zhi Wei brings over 16 years enterprise solution experience among business development, alliance & channel, go to market, product management and implementation. He has rich experience in building ISV partner ecosystem, product portfolios, and in solution selling.
 
Zhi Wei was ISV Business Development Manager and Channel Sales Manager at IBM China. Also he worked for Oracle Software System as Solution Manager. He holds MBA degree from Peking University & Vlerick Leuven & Gent Management School.
 
Please join me in welcoming Zhi Wei.
 
Naji
2, "Stanley Cheng"_email_"Re: Welcome Zhi Wei Sun, SUSE Business Development, APAC"_20130301_1613
Hi Zhi Wei, 
Great to know you ! We count on you to keep in touch with SUSE BU for expanding SUSE territory in greater China. Looking forward to meet you in nearest future !
Cheers, Stanley 

3, "Andy Jiang <ajiang@novell.com>"_email_"Re: Welcome Zhi Wei Sun, SUSE Business Development, APAC"_20130301_1643
Hello Zhi Wei,
Welcome on board! Look forward to working with you to expand our SUSE market share!
Cheers,
Andy

10:18 2013-03-04
suse, sle11 sp3, documentation, release notes
"Antoine Ginies <aginies@suse.com>"_email_"Documentation/RN for SL11 SP3"_20130301_0321
a short message to remind you that the content of the release notes/doc should
came from PrjMgr, PM and engineers. Try to keep our Doc/RN synchronise
and up to date is really important and is the best way to have a good product.
The team has spent time to work on features, improvements, bug fixes for
SP3, this should be visisble outside.

Thanks in advance to take care of your fate, and see if you can help in
the doc process, or RN.

regards.

Antoine

10:54 2013-03-04
GTD
0, 9:30-18:38

1, today
1), 15:49-18:38 libvirt libxl lock patch. see"14:14 2013-02-27"7.

11:28 2013-03-04
kernel, release, 3.8, f2fs
Summary: f2fs is a new filesystem for FTL enabled device, such as SSDs, eMMC, SD cards,
https://lwn.net/Articles/518988/
f2fs (interestingly not "f3s") is the "flash-friendly file system", a new filesystem for Linux recently announced by engineers from Samsung. Unlike jffs2 and logfs, f2fs is not targeted at raw flash devices, but rather at the specific hardware that is commonly available to consumers — SSDs, eMMC, SD cards, and other flash storage with an FTL (flash translation layer) already built in. It seems that as hardware gets smarter, we need to make even more clever software to manage that "smartness". Does this sound like parenting to anyone else?

f2fs is based on the log-structured filesystem (LFS) design — which is hardly surprising given the close match between the log-structuring approach and the needs of flash. For those not familiar with log-structured design, the key elements are:

    That it requires copy-on-write, so data is always written to previously unused space.

    That free space is managed in large regions which are written to sequentially. When the number of free regions gets low, data that is still live is coalesced from several regions into one free region, thus creating more free regions. This process is known as "cleaning" and the overhead it causes is one of the significant costs of log structuring.

ref: 
http://www.h-online.com/open/features/Kernel-Log-Coming-in-3-8-Part-1-Filesystems-and-storage-1788524.html
http://kernelnewbies.org/Linux_3.8#head-7affc538d5e61b00124c58fad8958324fa50bfb2

11:39 2013-03-04
company, air, BCD
"Gracie Guo"_email_"The new reason codes of purpose of trip"_20130304_1109
Dear All: 

From March 1,2013, BCD will be ask the Purpose of Trip when you booking the ticket. below is porpose code.

P:  Project 项目 
R:  Relocation 转职 
C:  Customer Meeting 客户会见 
I:    Internal Meeting 内部会见 
S:  Sales Meeting 销售会见 
T:  Training 培训 
E:  Conference/Convention 会议 
thank you
gg

16:50 2013-03-04
virtualization, libvirt, xen, patch, lock, cont2, modify for xen4.2, cont4
1, try to understand the libxl_event.

18:37 2013-03-04
virtualization, xen, move from hv to git; hg to git flow
"Ian Jackson <Ian.Jackson@xxxxxxxxxxxxx>"_email_"[Xen-devel] Moving xen*.hg to git"_20130213_1708
As previously agreed, we will be moving the main Xen trees to git.
The existing .hg trees will continue to exist, but as hg mirrors of
the git history.  Committers will push to the git repo.

The new git tree will be this one:
  http://xenbits.xen.org/gitweb/?p=xen.git
  git://xenbits.xen.org/xen.git
For committers it will be accessible via
  xenbits.xen.org:/home/xen/git/xen.git

It has a branch corresponding to each xen*.hg tree:
  master                xen-unstable.hg
  stable-4.0            xen-4.0-testing.hg
  stable-4.1            xen-4.1-testing.hg
  stable-4.2            xen-4.2-testing.hg
  staging               staging/xen-unstable.hg
  staging-4.0           staging/xen-4.0-testing.hg
  staging-4.1           staging/xen-4.1-testing.hg
  staging-4.2           staging/xen-4.2-testing.hg

We have some background infrastructure work which needs to be complete
before we make this switch, but we are currently expecting/hoping this
to be ready next week.  We tentatively intend to make the switch on
Thursday the 13th of February, assuming none of the committers object.

Committers please note that if you have commits (patch queues) in hg
at this point, they will need to be transferred into git somehow to be
committed and pushed.  After the switch it will not be possible to
accept changes from hg, because we won't have bidirectional mirroring.

If at the point we make the change there are changes in staging that
have not propagated to the corresponding stable or master tree, this
situation will be preserved.  However, revision history will be broken
(by the difference in revision ids), which will slightly weaken the
autotester's push gate.  I therefore recommend that we avoid making
this change if we have a big or scary backlog in any staging tree.

People posting and approving patches, including maintainers, are not
directly affected.

The process will be as follows:
  1. Autotester push gate shut down
  2. Announcement and coordination with committers
  3. hg trees made read-only (other than by forthcoming git->hg mirror)
  4. hg->git mirroring process stopped
  5. git tree made writeable by committers.
  6. git->hg mirror outputs checked for sanity
  7. git->hg mirror enabled, pointing at old hg trees
  8. Autotester push gate told to use git and restarted

If any committer needs help getting git to work please feel free to
ask.  git has many advantages but its user interface has received very
mixed reviews.  We appreciate that you might need handholding.  So if
you get confused, or into trouble, do consult.

Ian.

_______________________________________________
Xen-devel mailing list
Xen-devel@xxxxxxxxxxxxx
http://lists.xen.org/xen-devel

    Follow-Ups:
        Re: [Xen-devel] Moving xen*.hg to git
            From: William Dauchy
        Re: [Xen-devel] Moving xen*.hg to git
            From: Ian Campbell
        [Xen-devel] Moving xen*.hg to git
            From: Ian Jackson
        Re: [Xen-devel] Moving xen*.hg to git
            From: Keir Fraser

    Prev by Date: [Xen-devel] Xen Security Advisory 42 (CVE-2013-0228) - Linux kernel hits general protection if %ds is corrupt for 32-bit PVOPS.
    Next by Date: [Xen-devel] [xen-unstable test] 16161: tolerable FAIL - PUSHED
    Previous by thread: [Xen-devel] Xen Security Advisory 42 (CVE-2013-0228) - Linux kernel hits general protection if %ds is corrupt for 32-bit PVOPS.
    Next by thread: Re: [Xen-devel] Moving xen*.hg to git
    Index(es):
        Date
        Thread

10:55 2013-03-05
GTD
0, 10:50-11:56

1, today
1), libvirt libxl lock patch.

11:53 2013-03-05
virtualization, xen, GSOC2013
http://wiki.xen.org/wiki/GSoC_2013
1, VM Snapshots
Date of insert: 16/01/2013
Mentor: Stefano Stabellini <stefano.stabellini@eu.citrix.com>
Difficulty: Medium
Skills Needed: C programming
Description: Although xl is capable of saving and restoring a running VM, it is not currently possible to create a snapshot of the disk together with the rest of the VM.

QEMU is capable of creating, listing and deleting disk snapshots on QCOW2 and QED files, so even today, issuing the right commands via the QEMU monitor, it is possible to create disk snapshots of a running Xen VM. xl and libxl don't have any knowledge of these snapshots, don't know how to create, list or delete them.

This project is about implementing disk snapshots support in libxl, using the QMP protocol to issue commands to QEMU. Users should be able to manage the entire life-cycle of their disk snapshots via xl.
The candidate should also explore ways to integrate QEMU disk snapshots and disk mirroring into the regular Xen save/restore mechanisms and provide a solid implementation for xl/libxl.
Outcomes:  

Basic goal: disk snapshots can be handled entirely by xl.
Stretch goals: xl can automatically save a disk snapshot at the time of saving a VM. xl can also mirror the disk of a VM between two hosts and can do that automatically at the time of VM migration.
Steps:  

Basic steps:

    Study libxl APIs for storage
    Study QEMU QMP commands for VM snapshots
    Implement support for QMP snapshots commands in libxl
    Implement VM snapshots functionalities in libxl using the QMP functions previously written
    Add VM snapshot commands to XL 

Stretch goals:

    Add VM snapshot functionalities to libxl save/restore and migration functions
    Evaluate QEMU QMP disk mirroring capabilities (QMP command "drive-mirror")
    Implement support for QMP drive-mirror command in libxl
    Hook disk mirroring into libxl VM save/restore and migration functions (migrating a VM from one host to another is also capable of migrating the VM disk from the two hosts).
2, Mini-os for ARM (autotranslated) guests
Date of insert: 2013-02-13
Mentor: Ian Campbell <ian.campbell@citrix.com>
Difficulty: Difficult
Skills Needed: C programming. ARM (and optionally x86) assembly language debugging. Low-level kernel understanding (e.g. page tables)
Description: Mini-OS is a simple reference PV guest operating system which serves as both an example of how to write a PV guest as well as providing the base Operating Systems for StubDom Stub Domains such as Device Model Stub Domains and xenstored stub domains. Parts of Mini-OS are also used in projects such as Mirage and other exo-kernel projects.

Mini-OS supports a single address space application running directly in the bare Virtual Machine environment and contains PV drivers for disk, net and console as well as a simple co-operative threading model.

Currently minios supports only x86 PV guests however we would also like to eventually support stubdomains (in particular xenstored stub domains) and projects such as Mirage on the ARM port of Xen. This project would involve taking the existing Mini-OS code (see extras/mini-os in the Xen source code) and extending it to work in the ARM PV environment.

As well as authoring the initial bring up code targeting ARM this will also involve modifying the rest of Mini-OS to cope with the fact that Xen ARM guests do not use PV paging but instead rely on hardware virtual paging. This will require modifications to some of the core helper routines and PV drivers to understand this autotranslated physmap concept (which refers to the idea that guest address are automatically translated into host addresses, compared with x86 PV domains which must perform this translation themselves, using the physmap (or p2m) which is part of the X86 PV paging interfaces).
As an extension once Mini-OS has been extended to work in the ARM environment using autotranslated physmap this should allow a relatively easy port to an X86 HVM environment, which also differs from X86 PV in its use of autotranslated physmap. This would be useful for running fuzz testers, such as that proposed above as well as other test applications.
Outcomes: Mini-OS based domains running
Steps:  

    Simple Hello World on ARM
    stub C or ocaml xenstored running on ARM.
    Simple Hello World on x86 HVM.
    ...TBD...

References: Inline

16:42 2013-03-05
Chinese search engine giant Baidu forges ARM servers
Marvell notches another design win after Dell and Codethink boxes
http://www.theregister.co.uk/2013/02/20/baidu_marvell_arm_servers/
Chip maker Marvell has notched up its third public design win for an ARM server, this one at Baidu, one of the two big search engine giants in China.
Avi Liebermensch, manager of server products at the maker of ARM processors and other kinds of chips, tells El Reg that the Baidu server is based on the company's Armada XP MV78460. 

10:33 2013-03-06
virtualization, qemu, arm, enable kvm on qemu arm
1, qemu commit log
1), commit 76c48503c4c87afabf0c93acf78480f65276844d
Author: Aurelien Jarno <aurelien@aurel32.net>
Date:   Tue Mar 5 15:11:30 2013 +0100

    Merge branch 'target-arm.next' of git://git.linaro.org/people/pmaydell/qemu-
arm
    * 'target-arm.next' of git://git.linaro.org/people/pmaydell/qemu-arm:
      MAINTAINERS: add entry for ARM KVM guest cores
      configure: Enable KVM on ARM
      hw/kvm/arm_gic: Implement support for KVM in-kernel ARM GIC
      target-arm: Use MemoryListener to identify GIC base address for KVM
      hw/arm_gic: Convert ARM GIC classes to use init/realize
      hw/arm_gic: Add presave/postload hooks
      ARM KVM: save and load VFP registers from kernel
      ARM: KVM: Add support for KVM on ARM architecture
      target-arm: Drop CPUARMState* argument from bank_number()
      linux-headers: resync from mainline to add ARM KVM headers
      oslib-posix: Align to permit transparent hugepages on ARM Linux
      target-arm: Don't decode RFE or SRS on M profile cores
      target-arm: Factor out handling of SRS instruction

2), 68b05c427b0d220e38bfa21ee6df7970f158b377
configure: Enable KVM on ARM
    Enable KVM on ARM hosts, now that all the necessary components
    for it exist.
    Signed-off-by: Peter Maydell <peter.maydell@linaro.org>
    Reviewed-by: Paolo Bonzini <pbonzini@redhat.com>

10:50 2013-03-06
GTD
0, 9:30-18:35

1, today
1), 10:51-11:30 17:36-18;32 libvirt libxl lock patch. see"14:14 2013-02-27"8.

13:37 2013-03-06
"Robert Schweikert <rjschwei@suse.com>"_email_"[opensuse-project] Board Changes"_20130306_0840
Hi,

It is with great regret that we have to announce that Pascal has decided 
to leave the openSUSE board. Due to changes in Pascal's life he feels he 
is no longer able to commit the necessary time and energy to the 
openSUSE project and the openSUSE board.

As we all know, Pascal has given a lot of time to the project and the 
community. He has always been willing to help, teach, and maintain. We 
thank Pascal very much for his past contributions and wish him all the 
best. We hope that at some point in the future, life presents another 
opportunity for Pascal to get re-involved with the project and the 
community.

Pascal, thank you for everything you have contributed to the openSUSE 
project.

The board would like to welcome Richard Brown as its newest member to
fill the seat vacated by Pascal. Richard received the 3rd most votes
in the recent election, and was endorsed by Pascal as a preferred
candidate for the vacated seat. Richard's term will run to the next
election.

Regards,
Your openSUSE Board

18:36 2013-03-06
company, suse, all-hands, olaf, release manager
1, olaf
1), sap.
hana
in memory database.
run exclusive in sles.
2), support redhat linux while customer migrate.
3), 
different subscription: basic, standard, priority.
4), PLDP.
quick hardware enablement.
5), usually GA for customer evaluation, customer will use from SP1.

2, release manager.
GM, FCS.
GM: engineer ship point.
FCS(?): market ship.
between these, mirror, paper work and so on.

evaluation, development, alpha, beta, rc, GM(gold master).
beta for test, customer. could not add new feature usually.
update is started after gold master.

11:07 2013-03-07
GTD
0, 11:00

1, today
1), 11:11-11:40 14:32- libvirt libxl lock patch. see"14:14 2013-02-27"9.

16:18 2013-03-07
colleague, Brian Yang; Huawei; QA automatical testing, Hamsta
1, "Brian Yang"_email_"Farewell from Brian Yang"_20130307_1551
hello, Dear Colleagues 
 
Today is my last working day in Novell , I think it is my time to say good bye to everyone here after 8 years and 5 months with you.

It is my such great pleasure to meet and work with you in this great company, and so proud to work with you to win and accomplish so many successful projects and build up customers trust in either TEM or South China region, 
growing revenue from zero to near $10M per fiscal year for Attachmate group today.  Now we are happy to see SUSE standing out in China Linux market, Huawei becomes Top 1 OEM in global telecom industry, ZTE's SUSE business 
catching up as second one, won and grew Tencent as our global largest ELA customer at Internet industry, SUSE Hamsta has been adopted for Huawei Central R&D as own automatic testing system with $2.2M, Huawei signed up 
OEM with NetIQ Sentinel and shipping to global telecom customers, PlateSpin becomes No.1 disaster recovery choice for customers based on virtulization in SC region...

Everything is exciting here and unforgeable...I really cherish this great experience, honestly, working with you has been best experience in my professional career.  There are so many of you I should say Thank you so much! Here specially
appreciations for South China team, without your hard execution and amazing job done, we can not make it happened.  Specially thanks for management team as copied, without your fully support, we can not keep moving forward. 

Looking forward, I'd like pursuit another opportunity which maybe great challenge, still I believe life is a journey and changes bring up new opportunity.  I am confident to face with every challenge ahead,  your support and encourage is 
always important for me every day. Please don't hesitate to reach me if anything you need from me, my personal email address is brian.yangg@gmail.com. 

Sincerely from my bottom of heart, wish each of you has very splendid future, very healthy and very happy life with your family!

Goodbye again and take care!

Brian

Mar. 7th, 2013

2, Summary
1), growing revenue from zero to near $10M per fiscal year for Attachmate group today.
2), Now we are happy to see SUSE standing out in China Linux market, Huawei becomes Top 1 OEM in global telecom industry, ZTE's SUSE business catching up as second one, won and grew Tencent as our global largest ELA customer at Internet industry
3), SUSE Hamsta has been adopted for Huawei Central R&D as own automatic testing system with $2.2M
4), Huawei signed up OEM with NetIQ Sentinel and shipping to global telecom customers
5), PlateSpin becomes No.1 disaster recovery choice for customers based on virtulization in SC region...

10:52 2013-03-08
""Calen Chen" <cachen@suse.com>"_email_"[devel] Please welcome FeiXiang Zhang - new bugzilla screener"_20130307_2016
Hi all,

It's my pleasure to announce a new team member.
FeiXiang Zhang joined the QA-APAC II team as an intern today. He is a student from Science and Technology University of China, major is software engineering. He will focus on Bugzilla screening job.
Please join me welcome him, and also please support him in getting used to
SUSE and QA/Developer/Maintainer, across all teams.

Thanks and Regards!

Calen

10:54 2013-03-08
GTD
0, 10:30-17:10

1, today
1), 10:54-17:06 libvirt libxl lock patch. see"14:14 2013-02-27"10.

13:40 2013-03-11
GTD
0, 13:30-18:22

1, today
1), 13:41-14:30 16:15-18:22 libvirt libxl lock patch. see"14:14 2013-02-27"11.

16:37 2013-03-11
Chunyan在解决pci passthrough时, 需要考虑qemu(kvm)和LXC同存的情况. pci设备有冲突.

18:05 2013-03-11
software skill, perf
http://www.ibm.com/developerworks/cn/linux/l-cn-perf1/index.html
http://www.ibm.com/developerworks/cn/linux/l-cn-perf2/index.html
Perf -- Linux下的系统性能调优工具
perf record -e cpu-clock -g your_program
perf report -g

10:47 2013-03-12
GTD
0, 10:30-18:10

1, today
1), 10:47-11:40 14:38-18:00 libvirt libxl lock patch. see"14:14 2013-02-27"12.
2), Summary: 搞了半天, 完全没有思路阿.

15:02 2013-03-12
software skill, virtualization, xen, vm, SXP
1, xm create -F sxp_conf
create vm with SXP configuration file.
2, xm list -l domain_name
output all vm details in SXP format.

11:06 2013-03-13
company, suse, career
1, "Marie Louise van Deutekom"_email_"SUSE is Hiring!"_20130313_0610
Dear SUSE colleagues,

Over 25 positions have now been approved for SUSE in FY14 and we currently have 47 positions open for which we're actively recruiting.

Our recruiting focus for the next FY is to further develop what we've built this year.

   1. Continuously improving and refreshing our www.suse.com/careers website and other Internet sites (LinkedIn careers section)

      This project is spearheaded by Libusa Volekova, HRA in Prague, who's working with various stakeholders in the SUSE (and TAG) organization.


   2. Two weeks ago, the SUSE site optimized for SEO (search engine optimization) went live. Great work from Sandy Moselle and her team and a huge step forward for SUSE – now we are much easier to find online!

      You can find the SEO site at jobs.novell.com/careers/suse-jobs. I'm sure you want to know why it has a reference to Novell and not stand alone SUSE. The answer is that Novell had SEO for years. By piggy-bagging now on the Novell history, SUSE is much sooner showing up high in the search results then by organic searches then in a situation where SUSE had to start from scratch. And it works – if you type in Google "SUSE engineer Nurnberg" you will find SUSE jobs. A month ago you would not have been able to find much related to SUSE! If you type in "Software Engineer Nurnberg" we are on page 2 – again a major improvement from a before the SEO was active.


   3. Expanding our on- and offline network recruiting activities.

      Amongst others: Professionalizing event-recruiting: attached is the new recruiting flyer, see below for a small pic of the pull up and table top banner.

How Can You Help?

The recruiting team (Joe Goss, David Korbel, Nadine Pieper, Christian Roch, Libusa Volekova, Claudia Ping and many others) is making a fast start with sourcing candidates for all the open positions. But we need your continuous support!

    * Distribute open positions in your (online) network and actively look inside your network for potential candidates:

          o Feel free to share the attached flyer.
          o Follow us on Twitter: twitter.com/SUSECareers 


    * When you are at an event: always keep an eye open for potential candidates – get connected off line and/or online and share contact details with the SUSE recruiters


    * Don't forget the referral policy - we'd rather pay a referral bonus to you than pay an agency!


    * And share this through twitter/LinkedIn/Facebook/Google+: "SUSE is growing! Exciting new sales & engineering positions at SUSE locations globally http://bit.ly/Yu8ije" 

Please let me know if you have any questions.

Thanks for your ongoing support,

Marie Louise


Marie Louise van Deutekom
Global HR Director
SUSE

R. Wallenbergplein 23
2404 ND Alphen a/d Rijn
The Netherlands
mlouises@suse.com
(Ph)+31.172.505585
(M) +31.6.53239393
SUSE logo

For internal use only. 

11:14 2013-03-13
company, colleague, David Liang
"Olaf Kirch <okir@suse.com>"_email_"[devel] Announcing David Liang as Team Leader"_20130312_2108
Hi all,

it is my pleasure to announce David as the new head of the
Beijing Desktop Team in the SLE Department.

David has been with SUSE for six years, and has helped me as
interim manager for the team since Joey's departure end of last
year. Please support David in his new role!

Good luck to you, David :)

Regards,
Olaf
-- 
Neo didn't bring down the Matrix. SOA did. (soafacts.com)
--------------------------------------------
Olaf Kirch - Director SUSE Linux Enterprise; R&D (okir@suse.com)
SUSE LINUX Products GmbH, Maxfeldstr. 5, 90409 Nürnberg, Germany
GF: Jeff Hawn, Jennifer Guild, Felix Imendörffer, HRB 16746 (AG Nürnberg) 

11:17 2013-03-13
suse, opensuse
"Jos Poortvliet <jos@opensuse.org>"_email_"[devel] what's different coming from Ubuntu/Gentoo/Arch/etc"_20130312_1942
Heya,

We're ready for openSUSE 12.3 in terms of both marketing and technical 
preparation so we've decided to try and create a last article before the 
release announcement tomorrow: something for the Ubuntu refugees.

Will's idea, by the way, who has his last day on this team (but isn't actually 
here) before moving on to more webby pastures...

As many of you frequently check out or use other Linux'es, we'd like your 
braindumps on differences between openSUSE and these other distro's!

Give us something to work with :D

/Jos & the openSUSE team

14:23 2013-03-13
GTD
0, 10:30-18:10

1, today
1), 14:23-18:05 libvirt libxl lock patch. see"14:24 2013-03-13".

14:24 2013-03-13
virtualization, libvirt, xen, patch, lock, cont2, modify for xen4.2, cont4
1, AFAIK, libxl could not get the response message from libxl-save-helper.
try to debug and figure it out.
2, 
helper_setcallbacks_save set suspend function:
    cbs->suspend = (cbflags & (1u<<3)) ? helper_stub_suspend : 0;

called in xc_domain_save while it is a non-live suspend.
    suspend_and_state

So, suspend function should be called. even if i set ao_how wrong.
1), 第一次测试失败了
libxl: debug: libxl.c:762:libxl_domain_suspend: ao 0x7f2b80060a70: create: how=0x7f2b8da6c820 callback=0x7f2b882c3cf3 poller=(nil)
libxl: debug: libxl.c:765:libxl_domain_suspend: libxl_domain_suspend start
libxl: debug: libxl_dom.c:1218:libxl__domain_suspend: libxl__domain_suspend start
libxl: debug: libxl_dom.c:1249:libxl__domain_suspend: device model savefile</var/lib/xen/qemu-save.1>
xc: error: Can't create lock file for suspend event channel /var/lib/xen/suspend_evtchn_1_lock.d: Internal error
libxl: warning: libxl_dom.c:1269:libxl__domain_suspend: Suspend event channel initialization failed
libxl: debug: libxl_dom.c:1143:libxl__toolstack_save: domain=1 toolstack data size=8
libxl: debug: libxl_event.c:181:libxl__ev_fd_register: ev_fd=0x7f2b800639a0 register fd=50 events=3
libxl: debug: libxl_dom.c:1285:libxl__domain_suspend: libxl__domain_suspend end
libxl: debug: libxl.c:785:libxl_domain_suspend: libxl_domain_suspend end
l
2), second time got the same error
xc: error: Can't create lock file for suspend event channel /var/lib/xen/suspend_evtchn_1_lock.d: Internal error
disable gdb reverse debug and try again.
3), full virsh save log in libxl.log: libxl__domain_suspend_device_model is called.
libxl: debug: libxl.c:762:libxl_domain_suspend: ao 0x7fd088055160: create: how=0x7fd09540f820 callback=0x7fd090467cf3 poller=(nil)
libxl: debug: libxl.c:765:libxl_domain_suspend: libxl_domain_suspend start
libxl: debug: libxl_dom.c:1218:libxl__domain_suspend: libxl__domain_suspend start
libxl: debug: libxl_dom.c:1249:libxl__domain_suspend: device model savefile</var/lib/xen/qemu-save.2>
xc: error: Can't create lock file for suspend event channel /var/lib/xen/suspend_evtchn_2_lock.d: Internal error
libxl: warning: libxl_dom.c:1269:libxl__domain_suspend: Suspend event channel initialization failed
libxl: debug: libxl_dom.c:1143:libxl__toolstack_save: domain=2 toolstack data size=8
libxl: debug: libxl_event.c:181:libxl__ev_fd_register: ev_fd=0x7fd08805aa60 register fd=44 events=3
libxl: debug: libxl_dom.c:1285:libxl__domain_suspend: libxl__domain_suspend end
libxl: debug: libxl.c:785:libxl_domain_suspend: libxl_domain_suspend end
libxl: debug: libxl.c:786:libxl_domain_suspend: ao 0x7fd088055160: inprogress: poller=(nil), flags=i
libxl-save-helper: debug: starting save: Success
libxl: debug: libxl_dom.c:972:libxl__domain_suspend_common_callback: issuing PVHVM suspend request via XenBus control node
libxl: debug: libxl_dom.c:976:libxl__domain_suspend_common_callback: wait for the guest to acknowledge suspend request
libxl: debug: libxl_dom.c:1023:libxl__domain_suspend_common_callback: guest acknowledged suspend request
libxl: debug: libxl_dom.c:1027:libxl__domain_suspend_common_callback: wait for the guest to suspend
libxl: debug: libxl_dom.c:1041:libxl__domain_suspend_common_callback: guest has suspended
libxl: debug: libxl_dom.c:890:libxl__domain_suspend_device_model: Saving device model state to /var/lib/xen/qemu-save.2
libxl: debug: libxl_save_callout.c:361:libxl__srm_callout_sendreply: libxl__srm_callout_sendreply start
xc: debug: outbuf_write: 4194304 > 90092@16687124
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 999400@15777816
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: detail: type fail: page 0 mfn 000f2000
xc: detail: type fail: page 1 mfn 000f2001
xc: detail: type fail: page 2 mfn 000f2002
xc: detail: delta 5901ms, dom0 12%, target 0%, sent 733Mb/s, dirtied 0Mb/s 0 pages
xc: detail: Total pages sent= 132096 (0.13x)
xc: detail: (of which 0 were fixups)
xc: detail: All memory is saved
xc: detail: Save exit rc=0
libxl-save-helper: debug: complete r=0: Success
libxl: debug: libxl_save_callout.c:391:libxl__srm_callout_callback_complete: libxl__srm_callout_callback_complete start
libxl: debug: libxl_event.c:229:libxl__ev_fd_deregister: ev_fd=0x7fd08805aa60 deregister fd=44
libxl: debug: libxl_save_callout.c:361:libxl__srm_callout_sendreply: libxl__srm_callout_sendreply start
4), the last function in gdb log is libxl__srm_callout_sendreply in the last virsh save test. and because the libxl__srm_callout_callback_complete is called, i could know that the xl get the messsge from libxl-save-helper.
所以之前猜测的complete没有收到是不对的.
i need to know what should be done after libxl__srm_callout_callback_complete and libxl__srm_callout_sendreply. \TODO.

3, from jim commnet, i guess that i should use ao_how but do not use callback?
check how the NEW_EVENT works in xenlight.

4, (10:52 2013-03-14)
1), read the code about how NEW_EVENT works.
domain_death_occurred: NEW_EVENT and sent ev through libxl__event_occurred. but i do not know which switch will be chosed in libxl__event_occurred. add print info for it.
(1), from log: CTX->event_hooks exist:
libxl: debug: libxl_event.c:181:libxl__ev_fd_register: ev_fd=0x72b9d8 register fd=23 events=1
libxl: debug: libxl_event.c:559:libxl__ev_xswatch_register: watch w=0x72ba20 wpath=@releaseDomain token=3/0: register slotnum=3
libxl: debug: libxl_event.c:503:watchfd_callback: watch w=0x72ba20 wpath=@releaseDomain token=3/0: event epath=@releaseDomain
libxl: debug: libxl.c:1000:domain_death_xswatch_callback: [evg=0x735fc0:1] from domid=1 nentries=1 rc=1
libxl: debug: libxl.c:1011:domain_death_xswatch_callback: [evg=0x735fc0:1]   got=domaininfos[0] got->domain=1
libxl: debug: libxl.c:1038:domain_death_xswatch_callback:  exists shutdown_reported=0 dominf.flags=ffff0012
libxl: debug: libxl.c:1004:domain_death_xswatch_callback: [evg=0] all reported
libxl: debug: libxl.c:1068:domain_death_xswatch_callback: domain death search done
libxl: debug: libxl.c:762:libxl_domain_suspend: ao 0x722fb0: create: how=0x7ffbf5b53820 callback=(nil) poller=(nil)
libxl: debug: libxl.c:765:libxl_domain_suspend: libxl_domain_suspend start
libxl: debug: libxl_dom.c:1218:libxl__domain_suspend: libxl__domain_suspend start
libxl: debug: libxl_dom.c:1249:libxl__domain_suspend: device model savefile</var/lib/xen/qemu-save.1>
xc: error: Can't create lock file for suspend event channel /var/lib/xen/suspend_evtchn_1_lock.d: Internal error
libxl: warning: libxl_dom.c:1269:libxl__domain_suspend: Suspend event channel initialization failed
libxl: debug: libxl_dom.c:1143:libxl__toolstack_save: domain=1 toolstack data size=8
libxl: debug: libxl_event.c:181:libxl__ev_fd_register: ev_fd=0x7516f0 register fd=44 events=3
libxl: debug: libxl_dom.c:1285:libxl__domain_suspend: libxl__domain_suspend end
libxl: debug: libxl.c:785:libxl_domain_suspend: libxl_domain_suspend end
libxl: debug: libxl.c:786:libxl_domain_suspend: ao 0x722fb0: inprogress: poller=(nil), flags=i
libxl: debug: libxl_event.c:181:libxl__ev_fd_register: ev_fd=0x72ba08 register fd=23 events=1
libxl: debug: libxl_event.c:559:libxl__ev_xswatch_register: watch w=0x72ba50 wpath=@releaseDomain token=3/0: register slotnum=3
libxl: debug: libxl_event.c:503:watchfd_callback: watch w=0x72ba50 wpath=@releaseDomain token=3/0: event epath=@releaseDomain
libxl: debug: libxl.c:1000:domain_death_xswatch_callback: [evg=0x735fe0:1] from domid=1 nentries=1 rc=1
libxl: debug: libxl.c:1011:domain_death_xswatch_callback: [evg=0x735fe0:1]   got=domaininfos[0] got->domain=1
libxl: debug: libxl.c:1038:domain_death_xswatch_callback:  exists shutdown_reported=0 dominf.flags=ffff0012
libxl: debug: libxl.c:1004:domain_death_xswatch_callback: [evg=0] all reported
libxl: debug: libxl.c:1068:domain_death_xswatch_callback: domain death search done
libxl: debug: libxl.c:762:libxl_domain_suspend: ao 0x724e40: create: how=0x7fa1b70dd820 callback=(nil) poller=(nil)
libxl: debug: libxl.c:765:libxl_domain_suspend: libxl_domain_suspend start
libxl: debug: libxl_dom.c:1218:libxl__domain_suspend: libxl__domain_suspend start
libxl: debug: libxl_dom.c:1249:libxl__domain_suspend: device model savefile</var/lib/xen/qemu-save.1>
xc: error: Can't create lock file for suspend event channel /var/lib/xen/suspend_evtchn_1_lock.d: Internal error
libxl: warning: libxl_dom.c:1269:libxl__domain_suspend: Suspend event channel initialization failed
libxl: debug: libxl_dom.c:1143:libxl__toolstack_save: domain=1 toolstack data size=8
libxl: debug: libxl_event.c:181:libxl__ev_fd_register: ev_fd=0x7266a0 register fd=44 events=3
libxl: debug: libxl_dom.c:1285:libxl__domain_suspend: libxl__domain_suspend end
libxl: debug: libxl.c:785:libxl_domain_suspend: libxl_domain_suspend end
libxl: debug: libxl.c:786:libxl_domain_suspend: ao 0x724e40: inprogress: poller=(nil), flags=i
libxl-save-helper: debug: starting save: Success
libxl: debug: libxl_dom.c:972:libxl__domain_suspend_common_callback: issuing PVHVM suspend request via XenBus control node
libxl: debug: libxl_dom.c:976:libxl__domain_suspend_common_callback: wait for the guest to acknowledge suspend request
libxl: debug: libxl_dom.c:1023:libxl__domain_suspend_common_callback: guest acknowledged suspend request
libxl: debug: libxl_dom.c:1027:libxl__domain_suspend_common_callback: wait for the guest to suspend
libxl: debug: libxl_dom.c:1041:libxl__domain_suspend_common_callback: guest has suspended
libxl: debug: libxl_dom.c:890:libxl__domain_suspend_device_model: Saving device model state to /var/lib/xen/qemu-save.1
libxl: debug: libxl_save_callout.c:361:libxl__srm_callout_sendreply: libxl__srm_callout_sendreply start
libxl: debug: libxl_event.c:503:watchfd_callback: watch w=0x72ba50 wpath=@releaseDomain token=3/0: event epath=@releaseDomain
libxl: debug: libxl.c:1000:domain_death_xswatch_callback: [evg=0x735fe0:1] from domid=1 nentries=1 rc=1
libxl: debug: libxl.c:1011:domain_death_xswatch_callback: [evg=0x735fe0:1]   got=domaininfos[0] got->domain=1
libxl: debug: libxl.c:1038:domain_death_xswatch_callback:  exists shutdown_reported=0 dominf.flags=20006
libxl: debug: libxl.c:1050:domain_death_xswatch_callback:  shutdown reporting
libxl: debug: libxl_event.c:1213:libxl__event_occurred: event_hooks exist
libxl: debug: libxl.c:1004:domain_death_xswatch_callback: [evg=0] all reported
libxl: debug: libxl.c:1068:domain_death_xswatch_callback: domain death search done
libxl: debug: libxl_event.c:1154:egc_run_callbacks: event 0x724ea0 callback type=domain_shutdown
xc: debug: outbuf_write: 4194304 > 90092@16687124
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 999400@15777816
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: debug: outbuf_write: 4194304 > 4169716@12607500
xc: detail: type fail: page 0 mfn 000f2000
xc: detail: type fail: page 1 mfn 000f2001
xc: detail: type fail: page 2 mfn 000f2002
xc: detail: delta 4686ms, dom0 24%, target 0%, sent 923Mb/s, dirtied 0Mb/s 0 pages
xc: detail: Total pages sent= 132096 (0.13x)
xc: detail: (of which 0 were fixups)
xc: detail: All memory is saved
xc: detail: Save exit rc=0
libxl-save-helper: debug: complete r=0: Success
libxl: debug: libxl_save_callout.c:391:libxl__srm_callout_callback_complete: libxl__srm_callout_callback_complete start
libxl: debug: libxl_event.c:229:libxl__ev_fd_deregister: ev_fd=0x7266a0 deregister fd=44
libxl: debug: libxl_save_callout.c:361:libxl__srm_callout_sendreply: libxl__srm_callout_sendreply start
(2), egc->occurred_for_callback
libxl_event_wait/libxl__ao_inprogress -> libxl__egc_cleanup -> egc_run_callbacks
还是搞不明白, 只好直接看看libxlEventHandler是怎么被libxl__egc_cleanup调用的: 
$16 = "libxlEventHandler"
0314_191430_505551555
#0  libxlEventHandler (data=0x7279f0, event=0x6c24b0) at libxl/libxl_driver.c:674
#1  0x00007fc0791252b6 in egc_run_callbacks (egc=<optimized out>) at libxl_event.c:1155
#2  libxl__egc_cleanup (egc=0x7fff04a98130) at libxl_event.c:1186
#3  0x00007fc079126d58 in libxl_osevent_occurred_fd (ctx=<optimized out>, for_libxl=0x27, fd=78217504, events_ign=<optimized out>, revents_ign=<optimized out>) at libxl_event.c:1090
#4  0x00007fc079359145 in libxlFDEventCallback (watch=15, fd=39, vir_events=1, fd_info=0x7fc070003ef0) at libxl/libxl_driver.c:170
#5  0x00007fc0861f8e2e in virEventPollDispatchHandles (fds=<optimized out>, nfds=<optimized out>) at util/vireventpoll.c:500
#6  virEventPollRunOnce () at util/vireventpoll.c:646
#7  0x00007fc0861f787b in virEventRunDefaultImpl () at util/virevent.c:273
#8  0x00007fc086320625 in virNetServerRun (srv=0x6c1470) at rpc/virnetserver.c:1108
#9  0x000000000040f827 in main (argc=3, argv=0x7fff04a98a38) at libvirtd.c:1481
(3), 跟踪后才注意到EGC_FREE
#define EGC_FREE           libxl__egc_cleanup(egc)
上周如果注意到这一点, 早就往下走了. 
EGC_FREE is caleld the following functions: libxl_osevent_beforepoll, libxl_osevent_afterpoll, libxl_osevent_occurred_fd, libxl_osevent_occurred_timeout, libxl_event_check, libxl_event_wait, libxl_childproc_reaped, AO_INPROGRESS, AO_ABORT.
但问题是AO_INPROGESS也是会调用EGC_FREE, 感觉怪怪的.
(4), it seems that the EGC_FREE is not what i want. 
try to dig into the save process without ao_how.
(5), ao_how == NULL.
it looks like libxl__self_pipe_eatall get the result from libxl__poller_wakeup.
$1028 = "libxl__poller_wakeup"
#0  libxl__poller_wakeup (egc=0x7fafbbd826a0, p=0x7fafac002240) at libxl_event.c:1357
#1  0x00007fafb63a89e0 in libxl__ao_complete_check_progress_reports (egc=0x7fafbbd826a0, ao=0x7fafac002660) at libxl_event.c:1600
$1029 = "virDomainEventNewFromObj"
Detaching after fork from child process 5446.
$1030 = "eventloop_iteration"
Detaching after fork from child process 5475.
$1031 = "libxl__self_pipe_eatall"
#0  libxl__self_pipe_eatall (fd=37) at libxl_event.c:1378
#1  0x00007fafb63a84f8 in afterpoll_internal (egc=0x7fafbbd82680, poller=0x7fafac002240, nfds=4, fds=0x7fafac001c00, now=...) at libxl_event.c:999
$1032 = "libxl__self_pipe_eatall"
#0  libxl__self_pipe_eatall (fd=42) at libxl_event.c:1378
#1  0x00007fafb63a855b in afterpoll_internal (egc=0x7fafbbd82680, poller=0x7fafac002240, nfds=4, fds=0x7fafac001c00, now=...) at libxl_event.c:1006
$1033 = "libxl__fork_selfpipe_woken"
#0  libxl__fork_selfpipe_woken (egc=0x7fafbbd82680) at libxl_fork.c:282
#1  0x00007fafb63a8595 in afterpoll_internal (egc=0x7fafbbd82680, poller=0x7fafac002240, nfds=4, fds=0x7fafac001c00, now=...) at libxl_event.c:1008
$1034 = "eventloop_iteration"
#0  libxl__ao_complete (egc=0x7fafbbd82680, ao=0x74f230, rc=0) at libxl_event.c:1570
#1  0x00007fafb638396a in domain_destroy_cb (egc=0x7fafbbd82680, dds=0x6c2540, rc=0) at libxl.c:1272
$1035 = "libxl__ao_complete"
$1036 = (const libxl_event_hooks *) 0x7fafb6815d20
$1037 = {tqh_first = 0x0, tqh_last = 0x728858}
$1038 = {lh_first = 0x0}
$1039 = "libxl__ao_complete_check_progress_reports"
#0  libxl__ao_complete_check_progress_reports (egc=0x7fafbbd82680, ao=0x74f230) at libxl_event.c:1582
#1  0x00007fafb63a8b5f in libxl__ao_complete (egc=0x7fafbbd82680, ao=0x74f230, rc=0) at libxl_event.c:1578
#2  0x00007fafb638396a in domain_destroy_cb (egc=0x7fafbbd82680, dds=0x6c2540, rc=0) at libxl.c:1272
#3  0x00007fafb637f766 in destroy_finish_check (egc=0x7fafbbd82680, dds=0x74f230) at libxl.c:1357
#4  0x00007fafb63836d2 in domain_destroy_callback (egc=0x7fafbbd82680, dis=0x6c25d0, rc=0) at libxl.c:1348
#5  0x00007fafb6387fa5 in devices_destroy_cb (egc=0x7fafbbd82680, drs=<optimized out>, rc=49) at libxl.c:1479
#6  0x00007fafb639cbd9 in devices_remove_callback (egc=0x7fafbbd82680, multidev=<optimized out>, rc=0) at libxl_device.c:1037
#7  0x00007fafb639cc5a in multidev_one_callback (egc=0x7fafbbd82680, aodev=0x74eed0) at libxl_device.c:481
#8  0x00007fafb639dcef in device_hotplug_done (egc=0x7fafbbd82680, aodev=0x74eed0) at libxl_device.c:1020
#9  0x00007fafb639df60 in device_hotplug (egc=0x7fafbbd82680, aodev=0x74eed0) at libxl_device.c:943
#10 0x00007fafb639e125 in device_qemu_timeout (egc=0x7fafbbd82680, ev=0x74ef68, requested_abs=<optimized out>) at libxl_device.c:837
#11 0x00007fafb63a8668 in afterpoll_internal (egc=0x7fafbbd82680, poller=<optimized out>, nfds=<optimized out>, fds=0x7fafac001c00, now=...) at libxl_event.c:1027
#12 0x00007fafb63a9191 in eventloop_iteration (egc=0x7fafbbd82680, poller=0x7fafac002240) at libxl_event.c:1443
#13 0x00007fafb63a9720 in libxl__ao_inprogress (ao=0x74f230, file=<optimized out>, line=<optimized out>, func=<optimized out>) at libxl_event.c:1688
#14 0x00007fafb6389e54 in libxl_domain_destroy (ctx=<optimized out>, domid=<optimized out>, ao_how=<optimized out>) at libxl.c:1261
#15 0x00007fafb65dc26c in libxlVmReap (driver=0x7027a0, vm=0x72a380, reason=VIR_DOMAIN_SHUTOFF_SAVED) at libxl/libxl_driver.c:666
#16 0x00007fafb65dc794 in libxlDoDomainSave (driver=0x7027a0, vm=0x72a380, to=0x7fafac0025c0 "/home/bamvor/sles11_hvm_10_vm5.save") at libxl/libxl_driver.c:2189
#17 0x00007fafb65e17ad in libxlDomainSaveFlags (dom=0x7fafac0025f0, to=0x7fafac0025c0 "/home/bamvor/sles11_hvm_10_vm5.save", dxml=0x0, flags=0) at libxl/libxl_driver.c:2239
#18 0x00007fafb65e1852 in libxlDomainSave (dom=0x7fafac0025f0, to=0x7fafac0025c0 "/home/bamvor/sles11_hvm_10_vm5.save") at libxl/libxl_driver.c:2259
#19 0x00007fafc355d39f in virDomainSave (domain=0x7fafac0025f0, to=0x7fafac004740 "/home/bamvor/sles11_hvm_10_vm5.save") at libvirt.c:2617
#20 0x0000000000434531 in remoteDispatchDomainSave (server=0x6c1470, client=0x7fafac0011a0, msg=0x7fafac001860, rerr=0x7fafbbd82bf0, args=0x7fafac002630) at remote_dispatch.h:4758
#21 0x000000000043462d in remoteDispatchDomainSaveHelper (server=0x6c1470, client=0x7fafac0011a0, msg=0x7fafac001860, rerr=0x7fafbbd82bf0, args=0x7fafac002630, ret=0x7fafac004940) at remote_dispatch.h:4736
#22 0x00007fafc35a0e43 in virNetServerProgramDispatchCall (msg=<optimized out>, client=<optimized out>, server=<optimized out>, prog=<optimized out>) at rpc/virnetserverprogram.c:432
#23 virNetServerProgramDispatch (prog=0x6cc3b0, server=0x6c1470, client=0x7fafac0011a0, msg=0x7fafac001860) at rpc/virnetserverprogram.c:305
#24 0x00007fafc35a649e in virNetServerProcessMsg (srv=<optimized out>, client=0x7fafac0011a0, prog=0xb, msg=0x7fafac001860) at rpc/virnetserver.c:162
#25 0x00007fafc35a7143 in virNetServerHandleJob (jobOpaque=<optimized out>, opaque=0x6c1470) at rpc/virnetserver.c:183
#26 0x00007fafc34a3866 in virThreadPoolWorker (opaque=<optimized out>) at util/virthreadpool.c:144
#27 0x00007fafc34a2e57 in virThreadHelper (data=<optimized out>) at util/virthreadpthread.c:161
#28 0x00007fafc01027b6 in start_thread (arg=<optimized out>) at pthread_create.c:301
#29 0x00007fafbfa579cd in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:112
#30 0x0000000000000000 in ?? ()
$1040 = "libxl__poller_wakeup"
#0  libxl__poller_wakeup (egc=0x7fafbbd82680, p=0x7fafac002240) at libxl_event.c:1357
#1  0x00007fafb63a89e0 in libxl__ao_complete_check_progress_reports (egc=0x7fafbbd82680, ao=0x74f230) at libxl_event.c:1600

5, (11:05 2013-03-15)
sigchld_handler set to SIGCHLD by the libxl__ev_child_fork. which called while libxl-save-helper is forked.
总是忘了fork返回值的含义. 0: 返回子进程. n(>0): 返回父进程.
summary for xenlight save routine.
run_helper fork the child process for run libxl-save-helper.  
\TODO: what does the sigchld_handler for?

后来又仔细看了看代码, 感觉会不会是ao_how不是NULL时, 所有的fd和time callback都没有执行?
(1), from the debug log, libxl__srm_callout_callback_progress is called lots of times. this function is a logging function.
xtl_progress is added in commit 7f9a888a: xtl: New xentoollog mini-library
xtl means "xentoollog"
besides, log and progress, only suspend and complete is called during virsh save.
but these function are called by helper_stdout_readable which is definitely called by libvirt event handler. it is not make sense. why these function are not called while ao_how is not NULL.
再继续debug, helper_stdout_readable以及最终调用的log, progress, suspend, complete数目都相投, 也就是说到这里还是正确的.

6, (10:42 2013-03-18)
根据上周的debug, 需要看complete之后哪里出了问题.
1), 看看complete后libxl__srm_callout_sendreply之后干啥了.
it looks like libxl__domain_suspend_device_model is called after libxl__srm_callout_sendreply in libxl__ao_inprogress.
libxl__domain_suspend_common_callback/libxl__xc_domian_save_done -> libxl__domain_suspend_device_model

libvirtd得到fd event((shs->pipes[1])->fd), 然后调用helper_stdout_readable. save情况下后者调用libxl__srm_callout_received_save. 目前我是卡在处理event->type == complete. 这里面似乎只是注销helper_stdout_readable, 然后给一个反馈.
问题是这个反馈给谁了?
(1), 第一感觉是是否是给libvirtd了.
如果是libvirtd, 就应该是会调用helper_stdout_readable. 但是这个已经注销了, 所以肯定不是这个问题??? 先试一下再说.
的确后在sendreply后面有helper_stdout_readable调用, 但是这个是直接原因么? 先看下面这个问题.
2), remove progress breakpoint in libxl__srm_callout_received_save, and compare successful and fail log again.
(1), save刚开始地方:
libxl__self_pipe_eatall在libvirtd里面是没有调用的. 我是否可以理解为应该把afterpoll_internal的除了fd, time之外的内容也需要在libvirtd里面作为事件注册呢?
看看这个libxl__self_pipe_eatall起什么作用.
while save successful, libxl__self_pipe_eatall is called 4times. two called at line 999, two called at line 1006.
999: 
    if (afterpoll_check_fd(poller,fds,nfds, poller->wakeup_pipe[0],POLLIN)) {
        int e = libxl__self_pipe_eatall(poller->wakeup_pipe[0]);
        if (e) LIBXL__EVENT_DISASTER(egc, "read wakeup", e, 0);
    }
1006:
    int selfpipe = libxl__fork_selfpipe_active(CTX);
    if (selfpipe >= 0 &&
        afterpoll_check_fd(poller,fds,nfds, selfpipe, POLLIN)) {
        int e = libxl__self_pipe_eatall(selfpipe);
        if (e) LIBXL__EVENT_DISASTER(egc, "read sigchld pipe", e, 0);
        libxl__fork_selfpipe_woken(egc);
    }
似乎只有libxl__fork_selfpipe_woken是关键, 可是看代码不像. 假设如此, 把它注释掉就能得到和libvirt with ao_how一样的结果.
注释之后的确是连virsh start都不工作了. 看看到底干了什么坏事.
3), gdb log says:
$1152 = "libxl__self_pipe_eatall"
#0  libxl__self_pipe_eatall (fd=42) at libxl_event.c:1378
#1  0x00007fcf72f6155b in afterpoll_internal (egc=0x7fcf7893b690, poller=0x7fcf6c0016b0, 
    nfds=4, fds=0x7fcf6c002970, now=...) at libxl_event.c:1006
$1153 = "libxl__fork_selfpipe_woken"
#0  libxl__fork_selfpipe_woken (egc=0x7fcf7893b690) at libxl_fork.c:282
#1  0x00007fcf72f61595 in afterpoll_internal (egc=0x7fcf7893b690, poller=0x7fcf6c0016b0, 
    nfds=4, fds=0x7fcf6c002970, now=...) at libxl_event.c:1008
$1154 = "helper_exited"
$1155 = "libxl__carefd_close"
$1156 = "libxl__carefd_close"
$1157 = "libxl__xc_domain_save_done"
$1158 = "libxl__domain_suspend_device_model"
[New Thread 0x7fcf80b96700 (LWP 16570)]
[Thread 0x7fcf80b96700 (LWP 16570) exited]
$1159 = "libxl__domain_save_device_model"
$1160 = "libxl__ev_fd_register"
$1161 = "libxl__ev_fd_register"

15:02 2013-03-13
software skill, debug, gdb, get struct offset
1, from:
http://stackoverflow.com/questions/9788679/how-to-get-the-relative-adress-of-a-field-in-a-structure-dump-c
http://elinux.org/GDB_Tips
2, gdb command
(gdb) print (int)&((struct A*)0)->a
or
(gdb) print/d &((struct A*)0)->a
3, python
If you need to do it for a large number of fields, then you may find it handy to use GDB's new python interface (you'll need a recent version of GDB to use it, I'm using 7.4). I've created offsets.py:

import gdb

class Offsets(gdb.Command):
    def __init__(self):
        super (Offsets, self).__init__ ('offsets-of', gdb.COMMAND_DATA)

    def invoke(self, arg, from_tty):
        argv = gdb.string_to_argv(arg)
        if len(argv) != 1:
            raise gdb.GdbError('offsets-of takes exactly 1 argument.')

        stype = gdb.lookup_type(argv[0])

        print argv[0], '{'
        for field in stype.fields():
            print '    %s => %d' % (field.name, field.bitpos//8)
        print '}'

Offsets()

Then you can add to your .gdbinit:

python
sys.path.insert(0, '/path/to/script/dir')
import offsets
end

Then using it in GDB, like:

(gdb) offsets-of "struct A"
struct A {
    a => 0
    b => 4
    c => 6
}

10:43 2013-03-14
GTD
0, 9:30-11:40 13:00

1, today
1), 10:51-11:37 13:53- libvirt libxl lock patch. see"14:24 2013-03-13"4.
2), Summary: 明天要改正的习惯是来公司现开始工作, 下班前再处理其他事情. 另外晚上看mailing list比较适合.

16:31 2013-03-14
sles11 sp2 x86_64 md5sum
SLES-11-SP2-DVD-x86_64-GM-DVD1.iso     	461d82ae6e15062b0807c1338f040497
SLES-11-SP2-DVD-x86_64-GM-DVD2.iso     	8dcbdda57208acc39327548abbc0064c

16:36 2013-03-14
rpm cache location
1, zypper
/var/cache/zypp/pacakges
2, osc local build
/var/tmp/osbuild-packagecache

10:59 2013-03-15
company, suse, maintenance, sle11, sles11 sp3 only have sp3 repo do not have sp2 repo
highlight: SLES 11 SP3 will have only one official update repository (SP3-Updates).
1, ""Simona Arsene" <sarsene@suse.com>"_email_"[devel] SLES 11 SP3 Channel Setup"_20130314_2345
Hi, 

based on the questions raised in the last couple of days, I would like to share with everyone the channel setup for
SLES 11 SP3. 
(for the new colleagues, I have added some 'Background info' so that you can better understand the setup) 

==============================================
Highlights:
==============================================
SLES 11 SP3 will have only one official update repository (SP3-Updates), but customers are allowed
and educated how to manually add older repository (e.g.
SLES 11 SP1 Updates, SLES 11 SP2 Updates, etc), even when being registered directly to NCC.
Previously this was only possible when using SMT or SUSE Manager.


Background info: 
==============================================
Over the last years with a clear desire for improvements based on customers feedback,
SUSE has implemented various changes regarding the way we deliver updates to our users. 

- in SLES 9, there was only one update repository that collected all the updates; the most recent
release update was the only one to be supported.
– Starting with SLES 10 SP1, the concept of a “SP specific repository” has been introduced. This
means that all the updates for a specific Service Pack are delivered in one specific repository.
Once users migrate to a newer Service Pack, they lose access to the preceding repositories if
they registered directly to NCC. Users of SMT or SUSE Manager were able and are still able to
subscribe to any SP channel freely
The main reason for this change was the concept of a 6 months overlap period (n-1 service
pack support) to allow validation of the released service pack and a window of migration for
customers, where they would be continued to be maintained and supported fully within the old
SP
– SLES 11 GA and SLES 11 SP1 have followed the SLES 10 model. With SLES 11 SP2 we
introduced a new repository model, consisting of the following:
i.SLES 11 SP1 Updates repository remained subscribed. All updates that were also
applicable to SP2 were also or only released into the SP1 Updates repository, which
means that all the updates that don't break the ABI and API compatibility should
have continued to be delivered here.
ii. SLES 11 SP2 Updates repository includes only the latest and innovative updates that
can't be delivered on the SP1 Updates Repository (for various reasons).
In addition to this, we introduced a Core Repository, which provided the “gap” of
packages that were neither released into SP1-Updates or SP2-Updates repository.


SLES 11 SP3 Channel Setup
==============================================
SLES 11 SP3 will have only one official update repository (SP3-Updates), but users can access other patches via the
download webpage or by enabling older channels for their products. 

Q1: What channels should a SLES 11 SP3 user have? 
SLES11-SP3-Pool
SLES11-SP3-Updates
SLES11-SP3-Extensions
SLE11-SP3-Debuginfo-Pool
SLE11-SP3-Debuginfo-Updates 

As you know from SLES 11 SP1, the pool channel (SLES11-SP3-Pool) will include the media and will not change during the
lifetime of the Service Pack. 
The SLES11-SP3-Updates will be populated with updates that will be released for SP3. 

Q2: From where should a SP3 user get his update? 
All the updates for SP3 will be available in the SLES11-SP3-Updates (and only in this channel). 

Q3: Where can I get more info regarding the SLES 11 SP2 channel setup in order to understand this change? 
In case you want to learn more about the SP2 channel setup, please check the release notes
https://www.suse.com/documentation/sled11/singlehtml/book_sle_deployment/book_sle_deployment.html#cha.update.sle
and the available TID (http://www.novell.com/support/kb/doc.php?id=7010225 )

In case you have questions regarding the support statements, please don't hesitate to contact me. 

If there are additional questions that I have not covered in this email, please feel free to reach out to me. 

Simona 

11:03 2013-03-15
GTD
0, 10:20-18:20

1, today
1), 11:04-11:30 13:06-18:19 libvirt libxl lock patch. see"14:24 2013-03-13"5.
2), Summary: 昨天刚说完来公司要尽快开始工作, 今天又耽误很多时间. 以后时间管理要详细记录这些事情.

14:28 2013-3-16
1, 我会尽力改进自己的工作
hi, 家驹

首先很抱歉, 周五我态度不好.
我工作有很多要改进的地方, 多向chunyan和你学习对我工作会有很大帮助. 另外也不希望因为我影响team的performance.  
我工作中目前是lock patch卡住我很久, 我自己觉得除了自己动作慢, 还是对于xen还有事件处理不太了解. 打算找时间和chunyan讨论讨论.
其实xen4.2, xen4.3有一些改进，chunyan和我虽然做的东西不完全一样, 如你所说, 对于一些共同的内容, 大家多一起讨论也会提高工作效率.

hackweek我之前也考虑过, 但不成熟, 下次虚拟化开会时如果有机会可以向大家请教.

bamvor
2, Jiaju
呵呵，没事，我都没感觉到你态度不好；）
3, bamvor: 
其实事后想想, 没必要说自己态度不好, 重点应该放在如何改进上.

10:31 2013-03-18
GTD
0, 10:10-11:58 13:30-18:15

1, today
1), write letter for Jiaju. see"14:28 2013-3-16"
2), 10:41-11:58 13:36-18:09 libvirt libxl lock patch. see"14:24 2013-03-13"6.

16:07 2013-03-18
software skill, debugger, gdb, conditional breakpoint
1, ref:
http://blog.vinceliu.com/2009/07/gdbs-conditional-breakpoints.html
http://sourceware.org/gdb/current/onlinedocs/gdb/Conditions.html
2, gdb里面加入条件断点: 
break util/vireventpoll.c:484 if fds[n].fd == 7 

17:34 2013-03-18
"Dirk Müller<dirk@dmllr.de>"_email_"Re: [opensuse-arm] openSUSE 12.3 builds"_20130316_1854
2013/3/16 Michal Hrusecky <michal@hrusecky.net>:

> boards to 12.3, but my project with 12.3 enable rebuilt everything for
> Factory, but 12.3 is still in scheduled state for few days... Am I doing
> something wrong?

Hi Michal,

yes, this is a security feature.. in order to build something for 12.3
you need to migrate to a qemu build. Unfortunately
the 12.3:Ports repository was changed to do native builds, which is
blocked for everybody else.

You need to set the path to devel:ARM:12.3:Contrib project and then
abortbuild all the scheduled jobs (because the build service does not
notice
that you changed the path), and then call osc rebuild on them. Then it
should work.

For reference, have a look at the devel:ARM:12.3:Contrib:Chromebook
project, this is how you should set it up as well.

Greetings,
Dirk

17:50 2013-03-18
virtualization, xen, xend, vm configuration
/var/lib/xend/domains/<vm-uuid>

13:46 2013-03-19
GTD
0, 11:10

1, today
1), 14:00-18:20 find out whether xend have hook for migration. see"14:00 2013-03-19"

14:00 2013-03-19
virtualization, xen, find out whether xend have hook for migration
1, www.xen.org/files/xensummit_4/talk_Cully.pdf
said that there is a checkpoint in xen for it.
but i do not see it after read this doc.

2, http://blog.prgmr.com/mt/mt-search.cgi?blog_id=1&tag=migration&limit=20
[textbox title: Device Migration Hooks]
Xen includes the option of calling an external device migration script at each step of a save or migrate. Although the feature was originally added for the sake of TPM migration, it's since been extended to migrating arbitrary devices.

Enable the external-device-migrate script by setting the external-migration-tool directive in /etc/xen/xend-config.sxp. Most likely you'll want to set (external-migration-tool 'external-device-migrate') and let that script source appropriate scripts for external devices.
[end textbox]

3, check external-migration-tool in xen manpage
external-migration-tool
    The name of an application or script that can handle external device migration, such as for example virtual TPM migration. An example script is /etc/xen/scripts/external-device-migrate. 

4, mailing list
http://hg.vergenet.net/xen/xen-3.4-testing/rev/1fe63743a147
commit: abd30192c
there is explain about the step. ref""7

5, modify /etc/xen/xend-config.sxp
(external-migration-tool '/etc/xen/scripts/external-device-migrate')
got the log, same at from goole.
linux-vm4:/etc/xen/scripts # cat /var/log/xen/xend.log |grep "Calling external migration tool" -A2                                                              
[2013-03-19 15:41:53 5174] INFO (DevController:361) Calling external migration tool for step 0                                                                  
[2013-03-19 15:42:03 5174] INFO (DevController:361) Calling external migration tool for step 0                                                                  
[2013-03-19 15:42:15 5174] INFO (DevController:361) Calling external migration tool for step 0                                                                  
[2013-03-19 15:44:20 5174] INFO (DevController:361) Calling external migration tool for step 0                                                                  
[2013-03-19 15:45:31 5174] DEBUG (SrvServer:77) SrvServer.cleanup()             
[2013-03-19 15:45:31 5174] DEBUG (XMLRPCServer:251) XMLRPCServer.cleanup()      
--                                                                              
[2013-03-19 15:45:38 5310] INFO (DevController:361) Calling external migration tool for step 0                                                                  
[2013-03-19 15:45:38 5310] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vbd-migration.sh'                                            
[2013-03-19 15:45:38 5310] INFO (DevController:361) Calling external migration tool for step 0                                                                  
[2013-03-19 15:45:38 5310] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vif-migration.sh'                                            
[2013-03-19 15:45:38 5310] INFO (DevController:361) Calling external migration tool for step 1                                                                  
[2013-03-19 15:45:38 5310] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vbd-migration.sh'                                            
[2013-03-19 15:45:38 5310] INFO (DevController:361) Calling external migration tool for step 1                                                                  
[2013-03-19 15:45:38 5310] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vif-migration.sh'                                            
[2013-03-19 15:45:38 5310] DEBUG (XendCheckpoint:124) [xc_save]: /usr/lib64/xen/bin/xc_save 27 3 0 0 4
--
[2013-03-19 15:45:38 5310] INFO (DevController:361) Calling external migration tool for step 2
[2013-03-19 15:45:38 5310] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vbd-migration.sh'
[2013-03-19 15:45:38 5310] INFO (DevController:361) Calling external migration tool for step 2
[2013-03-19 15:45:38 5310] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vif-migration.sh'
[2013-03-19 15:45:38 5310] INFO (XendCheckpoint:135) Domain 3 suspended.
[2013-03-19 15:45:38 5310] INFO (DevController:361) Calling external migration tool for step 3
[2013-03-19 15:45:38 5310] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vbd-migration.sh'
[2013-03-19 15:45:38 5310] INFO (DevController:361) Calling external migration tool for step 3
[2013-03-19 15:45:38 5310] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vif-migration.sh'
[2013-03-19 15:45:38 5310] INFO (image:538) signalDeviceModel:restore dm state to running

6, cat vbd-migration.sh
#!/bin/bash

echo start
xm list
echo $*
echo $@
echo end

1), Error: Migration tool returned 127
2), it is ok if call exit.
#!/bin/bash
exit
3), i am wrong, the "wrapper" script external-device-migrate do the two type things.
the first one is source the $typ$stype-migration.sh, this script should set the environment variable e.g. script path.
the second one is execute the scipt named $typ_recover if migration fail or $typ_migration_step if migration successful.
the reason why i need exit in vbd-migration.sh is the actual script is not provided. e.g. vbd_migration_step is not located in system path.

7, mail to Jiaju
how to add the hook script in migration for devcie migration

there are 4 points in migration progress for device migration hook script. your could get the explaination of the steps in [1]. i guess that the 4th step(3 in code, it count from 0) is useful for your requirement.

here is the script howto
1), add following line in /etc/xen/xend-config.sxp
(external-migration-tool '/etc/xen/scripts/external-device-migrate')
2), add the script named "$type"-migration.sh in /etc/xen/scripts.
the type is the storage or network if in xen. e.g. vbd, vif.
this script is sourced by external-device-migrate. it should set the environment for the actual hook script. e.g. set the path.
linux-vm4:/etc/xen/scripts # cat vbd-migration.sh
#!/bin/sh
export BAMVOR_TEST="1"
export PATH=/etc/xen/scripts:$PATH
3), add device migration hook script with executable permission for both migration successful and migration failure recovery.
name: "$type"_migration_step, "$type"_recover
linux-vm4:/etc/xen/scripts # cat vbd_migration_step
#!/bin/bash
echo $@
echo $BAMVOR_TEST
notes: the log will output to /var/log/xen/xend.log

[1] http://hg.vergenet.net/xen/xen-3.4-testing/rev/1fe63743a147
or xen git commit: abd30192c

In a 1st step (step = 0 in the code) migration of all devices of a
domain is 'tested', that means their driver implementations (blkif.py,
netif.py, tpmif.py, usbif.py, pciif.py) are queried whether migration is
possible at all. Currently all device representations respond with a
'yes' (=0), although probably a VM mounting a hard drive partition
should respond with a 'no' (-1) already. This first step is a quick
check to see whether devices can be migrated.

The 2nd step is to do whatever can be done before the domain is
suspended. At this point migration of the device could be initiated, if
at all possible.

The 3rd step is to migrate a device after the domain has been suspended,
meaning that it is not scheduled anymore and the VM is 'settled'. All
devices are called again and a good implementation would initiate the
migration in a background process to achieve as much concurrency as
possible.

The 4th step is to synchronize with the 3rd step. At this point the
implementor has to make sure that anything that was initiated in step 3
has completed. Once all steps 4 have been processed, the VM will resume
on the remove machine.

8, continue to study how device migrate is called during migration.

09:22 2013-03-20
company, suse, hackweek 9
"Cornelius Schumacher <cschum@suse.de>"_email_"[devel] Hack Week 9"_20130319_1304
Dear colleagues,

The week of April 8th is Hack Week 9! Everybody in Ralf's organization is free 
to work on projects of passion of your choice. We use http://hackweek.suse.com 
to prepare and plan openly. External contributions are welcome. We invite you 
to add (or learn about) project ideas at http://github.com/SUSE/hackweek/wiki 
and also during a kick-off meeting (Nuremberg: March 28, Prague: March 29, 
Beijing: April 2, Taipei: April 2, Provo: April 8). The best Hack Week 
projects will receive a prize, so make a lot of noise about your project to 
get the attention of the judges. Feel free to contact hackweek@suse.de for 
suggestions or project ideas.

It's the ninth SUSE Hack Week. At this established event hundreds of SUSE 
engineers will spend an interruption-free week on hacking on projects of their 
passion. We will work on ideas in teams or alone, contribute to upstream or to 
openSUSE, or follow crazy ideas for projects we wanted to do but never found 
the time.

Hack Week will take place at the SUSE offices all over the world. Each 
location will have some local side-program, so follow the announcements there 
or look it up on the Hack Week web site at http://hackweek.suse.com/#agenda.

All engineers in the engineering organization of Ralf are eligible to 
participate in Hack Week. All other SUSE employess are invited to join, but 
please get the OK of your manager. External people from the community are 
welcome to join projects as well. Talk to the organization team if your 
project needs special arrangements. NetIQ is also doing their hack week at the 
same time, so this is your chance to peek into what they are doing and get 
together for some hacking across business-units.

To prepare for the Hack Week, we are collecting ideas, project proposals and 
plans at the Hack Week wiki. Instructions can be found at 
http://github.com/SUSE/hackweek/wiki. Everyone is looking forward to seeing 
your ideas there. Browse them for inspiration, team up with others with the 
same interest, and contribute your ideas and feedback to make good ideas 
great.

We are an open company, so the web site and the wiki are public. This allows 
us to share with the community and the rest of the world what we are doing, to 
get input from everybody interested, and demonstrate that SUSE is a special 
place where cool stuff is being done.

We will hold kick-off meetings to inform about Hack Week, and give you the 
opportunity to present and discuss project ideas and find collaborators. 
Details will be announced separately. The following dates are already fixed:

* Provo: mini-kick-off at Lunch and Learn March 20; official kickoff on day 1 
of hackweek
* Nuremberg: March 28, 12:00 (Lunch & Hack), all-hands area
* Prague: March 29, 14:00
* Beijing, April 2, noon
* Taipei, April 2, noon (mixed with openSUSE 12.3 release party)

Hacking is fun, but it's even more fun if others know what you are doing and 
what you have achieved. To facilitate this we'll have a series of short 
lightning talks on Friday afternoon of Hack Week. There you all can present 
your results, where you succeeded, and where you failed. The talks will be 
recorded (if wanted) to share them with colleagues and community.

As in previous years we will have prizes for the best projects. A jury led by 
the SUSE distinguished engineers will select the winners in a number of 
categories from best project, over best team effort, to most glorious failure. 
In addition we will have a people's choice award, where all employees get a 
vote to choose the most popular project. As prizes we will have Amazon 
vouchers, and for projects promising to add value to SUSE we will award 
additional hacking time to continue to work on them and drive them to 
completion. More details to follow.

Find all relevant information about Hack Week at the event's web site at 
http://hackweek.suse.com. If you are new to Hack Week check out the HOWTO at 
http://hackweek.suse.com/howto.html. The wiki with the project list and where 
you can add new ideas is at http://github.com/SUSE/hackweek/wiki.

If you have any questions or feedback or you need anything to turn your idea 
into reality, feel free to contact the Hack Week coordination team at 
hackweek@suse.de. Or get on #hackweek on freenode to chat about your projects, 
get feedback, ask question, or seek collaborators.

Have a lot of fun at Hack Week.

Regards,
the Hack Week coordination team (Antoine, Cassio, Cornelius, Craig, Jürgen, 
Michal, Sunny and Theo)

-- 
Cornelius Schumacher <cschum@suse.de>

10:07 2013-03-20
virtualization, xen, migration, add hook for lvm
1, Jiaju mail
Hi Bamvor,

Thanks for collecting the information for me;)

BTW,
https://bugzilla.novell.com/show_bug.cgi?id=801663
is a P0 bug which needs some Xen work currently,
if you have interest, maybe discuss that with Chunyan?;)

Thanks,
Jiaju

2, discuss with Jiaju. use NFS instead. umount/mount NFS during migraiton.
in detail, umount NFS in step 4 in source and mount NFS in destination at the asme time. and do continous I/O during migration. in order to in sure that disk usable during live migration.

3, xm migrate -live
Error: Disk image does not exist: /var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw (from linux-vm5)

linux-vm4:/etc/xen/scripts # virsh migrate --verbose --live --suspend bjz_04_sles11_sp2 xen+ssh://linux-vm5
error: Requested operation is not valid: xenDaemonDomainMigrate: xend cannot migrate paused domains

migration fail log on recv:
[2013-03-20 22:21:50 3834] ERROR (XendCheckpoint:357) Disk image does not exist: /var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw
Traceback (most recent call last):
  File "/usr/lib64/python2.6/site-packages/xen/xend/XendCheckpoint.py", line 266, in restore
    restore_image = image.create(dominfo, dominfo.info)
  File "/usr/lib64/python2.6/site-packages/xen/xend/image.py", line 66, in create
    return findImageHandlerClass(vmConfig)(vm, vmConfig)
  File "/usr/lib64/python2.6/site-packages/xen/xend/image.py", line 783, in __init__
    ImageHandler.__init__(self, vm, vmConfig)
  File "/usr/lib64/python2.6/site-packages/xen/xend/image.py", line 99, in __init__
    self.configure(vmConfig)
  File "/usr/lib64/python2.6/site-packages/xen/xend/image.py", line 1038, in configure
    HVMImageHandler.configure(self, vmConfig)
  File "/usr/lib64/python2.6/site-packages/xen/xend/image.py", line 791, in configure
    ImageHandler.configure(self, vmConfig)
  File "/usr/lib64/python2.6/site-packages/xen/xend/image.py", line 129, in configure
    self.dmargs = self.parseDeviceModelArgs(vmConfig)
  File "/usr/lib64/python2.6/site-packages/xen/xend/image.py", line 904, in parseDeviceModelArgs
    vbdparam)
VmError: Disk image does not exist: /var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw
[2013-03-20 22:21:50 3834] ERROR (XendDomain:1194) Restore failed
Traceback (most recent call last):
  File "/usr/lib64/python2.6/site-packages/xen/xend/XendDomain.py", line 1178, in domain_restore_fd
    dominfo = XendCheckpoint.restore(self, fd, paused=paused, relocating=relocating)
  File "/usr/lib64/python2.6/site-packages/xen/xend/XendCheckpoint.py", line 358, in restore
    raise exn
VmError: Disk image does not exist: /var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw

in parseDeviceModelArgs,  it will check all the vbd_refs whether the disk is existed or not. but it is only apply to file

    for devuuid in vmConfig['vbd_refs']:
        devinfo = vmConfig['devices'][devuuid][1]
        uname = devinfo.get('uname')
        if uname is not None and 'file:' in uname:
            (_, vbdparam) = string.split(uname, ':', 1)
            if not os.path.isfile(vbdparam):
                raise VmError('Disk image does not exist: %s' %
                              vbdparam)

4, the following is done before i know image.py only check file. 
1), test lvm whether it is a vbd or not, how to create lvm
Disk /dev/sdc: 2147 MB, 2147483648 bytes
255 heads, 63 sectors/track, 261 cylinders, total 4194304 sectors
Units = sectors of 1 * 512 = 512 bytes                           
Sector size (logical/physical): 512 bytes / 512 bytes            
I/O size (minimum/optimal): 512 bytes / 512 bytes                
Disk identifier: 0x00000000                                      

Disk /dev/sdc doesn't contain a valid partition table
linux-vm4:/home/bamvor # pvcreate /dev/sdc           
  Physical volume "/dev/sdc" successfully created    
linux-vm4:/home/bamvor # pvs
  PV         VG   Fmt  Attr PSize PFree
  /dev/sdc        lvm2 a-   2.00g 2.00g
linux-vm4:/home/bamvor # vgcreate vg /dev/sdc
  Volume group "vg" successfully created     
linux-vm4:/home/bamvor # vgs                 
  VG   #PV #LV #SN Attr   VSize VFree        
  vg     1   0   0 wz--n- 2.00g 2.00g        
linux-vm4:/home/bamvor # lvcreate -L1G -n lv1 vg
  Logical volume "lv1" created                  
linux-vm4:/home/bamvor # lvs                    
  LV   VG   Attr   LSize Origin Snap%  Move Log Copy%  Convert
  lv1  vg   -wi-a- 1.00g                                      
linux-vm4:/home/bamvor # cd /dev/vg/                          
linux-vm4:/dev/vg # ls                                        
lv1                                                           
linux-vm4:/dev/vg # ll                                        
total 0                                                       
lrwxrwxrwx 1 root root 7 Mar 20 12:28 lv1 -> ../dm-0 

2), note that in XendConfig.py device_add function. in vbd, vtpm, vif types.
So, it is OK for vTPM do something during migration. 

add in xm config
disk=['dmmd:lvm;/dev/vg/lv1,hdc,w',]

3), note: if the status is not available, should use the lvchange:
linux-vm4:~ # lvdisplay                                       
  --- Logical volume ---                                      
  LV Name                /dev/vg/lv1                          
  VG Name                vg                                   
  LV UUID                25TSlR-uIfD-c3dc-Ex0H-661M-Cdiy-DEkOpl
  LV Write Access        read/write                            
  LV Status              NOT available                         
  LV Size                1.00 GiB                              
  Current LE             256                                   
  Segments               1                                     
  Allocation             inherit                               
  Read ahead sectors     auto                                  
                                                               
linux-vm4:~ # lvs
  LV   VG   Attr   LSize Origin Snap%  Move Log Copy%  Convert
  lv1  vg   -wi--- 1.00g                                      
linux-vm4:~ # lvchange -ay vg/lv1
linux-vm4:~ # lvdisplay          
  --- Logical volume ---         
  LV Name                /dev/vg/lv1
  VG Name                vg         
  LV UUID                25TSlR-uIfD-c3dc-Ex0H-661M-Cdiy-DEkOpl
  LV Write Access        read/write                            
  LV Status              available                             
  # open                 0                                     
  LV Size                1.00 GiB                              
  Current LE             256                                   
  Segments               1                                     
  Allocation             inherit                               
  Read ahead sectors     auto                                  
  - currently set to     1024                                  
  Block device           253:0                                 
                                                               
linux-vm4:~ # cd /dev/vg/                                      
linux-vm4:/dev/vg # ll                                         
total 0                                                        
lrwxrwxrwx 1 root root 7 Mar 20 17:10 lv1 -> ../dm-0 

5, fail because of lvm?
也可能是因为mount dst时dst已经存在了, 所以失败. 后者没事, 属于测试的问题.
1), log in src
[2013-03-20 13:24:38 3818] INFO (DevController:361) Calling external migration tool for step 0
[2013-03-20 13:24:38 3818] INFO (DevController:365) linux-vm5 bjz_04_sles11_sp2 0
[2013-03-20 13:24:38 3818] INFO (DevController:365) 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) linux-vm5
[2013-03-20 13:24:38 3818] INFO (DevController:365) bjz_04_sles11_sp2
[2013-03-20 13:24:38 3818] INFO (DevController:365) 0
[2013-03-20 13:24:38 3818] INFO (DevController:365) not step 3
[2013-03-20 13:24:38 3818] INFO (DevController:361) Calling external migration tool for step 0
[2013-03-20 13:24:38 3818] INFO (DevController:365) linux-vm5 bjz_04_sles11_sp2 0
[2013-03-20 13:24:38 3818] INFO (DevController:365) 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) linux-vm5
[2013-03-20 13:24:38 3818] INFO (DevController:365) bjz_04_sles11_sp2
[2013-03-20 13:24:38 3818] INFO (DevController:365) 0
[2013-03-20 13:24:38 3818] INFO (DevController:365) not step 3
[2013-03-20 13:24:38 3818] INFO (DevController:361) Calling external migration tool for step 0
[2013-03-20 13:24:38 3818] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vif-migration.sh'
[2013-03-20 13:24:38 3818] INFO (DevController:361) Calling external migration tool for step 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) linux-vm5 bjz_04_sles11_sp2 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) linux-vm5
[2013-03-20 13:24:38 3818] INFO (DevController:365) bjz_04_sles11_sp2
[2013-03-20 13:24:38 3818] INFO (DevController:365) 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) not step 3
[2013-03-20 13:24:38 3818] INFO (DevController:361) Calling external migration tool for step 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) linux-vm5 bjz_04_sles11_sp2 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) linux-vm5
[2013-03-20 13:24:38 3818] INFO (DevController:365) bjz_04_sles11_sp2
[2013-03-20 13:24:38 3818] INFO (DevController:365) 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) not step 3
[2013-03-20 13:24:38 3818] INFO (DevController:361) Calling external migration tool for step 1
[2013-03-20 13:24:38 3818] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vif-migration.sh'
[2013-03-20 13:24:38 3818] DEBUG (XendCheckpoint:124) [xc_save]: /usr/lib64/xen/bin/xc_save 26 2 0 0 5
[2013-03-20 13:24:38 3818] INFO (XendCheckpoint:423) xc: error: Can't create lock file for suspend event channel /var/lib/xen/suspend_evtchn_2_lock.d: Internal error
[2013-03-20 13:24:38 3818] INFO (XendCheckpoint:423) xc_save: suspend event channel initialization failed, using slow path
[2013-03-20 13:24:47 3818] DEBUG (XendCheckpoint:394) suspend
[2013-03-20 13:24:47 3818] DEBUG (XendCheckpoint:127) In saveInputHandler suspend
[2013-03-20 13:24:47 3818] DEBUG (XendCheckpoint:129) Suspending 2 ...
[2013-03-20 13:24:47 3818] DEBUG (XendDomainInfo:524) XendDomainInfo.shutdown(suspend)
[2013-03-20 13:24:47 3818] DEBUG (XendDomainInfo:1882) XendDomainInfo.handleShutdownWatch
[2013-03-20 13:24:47 3818] DEBUG (XendDomainInfo:1882) XendDomainInfo.handleShutdownWatch
[2013-03-20 13:24:47 3818] INFO (XendDomainInfo:2079) Domain has shutdown: name=migrating-bjz_04_sles11_sp2 id=2 reason=suspend.
[2013-03-20 13:24:47 3818] INFO (DevController:361) Calling external migration tool for step 2
[2013-03-20 13:24:47 3818] INFO (DevController:365) linux-vm5 bjz_04_sles11_sp2 2
[2013-03-20 13:24:47 3818] INFO (DevController:365) 1
[2013-03-20 13:24:47 3818] INFO (DevController:365) linux-vm5
[2013-03-20 13:24:47 3818] INFO (DevController:365) bjz_04_sles11_sp2
[2013-03-20 13:24:47 3818] INFO (DevController:365) 2
[2013-03-20 13:24:47 3818] INFO (DevController:365) not step 3
[2013-03-20 13:24:47 3818] INFO (DevController:361) Calling external migration tool for step 2
[2013-03-20 13:24:47 3818] INFO (DevController:365) linux-vm5 bjz_04_sles11_sp2 2
[2013-03-20 13:24:47 3818] INFO (DevController:365) 1
[2013-03-20 13:24:47 3818] INFO (DevController:365) linux-vm5
[2013-03-20 13:24:47 3818] INFO (DevController:365) bjz_04_sles11_sp2
[2013-03-20 13:24:47 3818] INFO (DevController:365) 2
[2013-03-20 13:24:47 3818] INFO (DevController:365) not step 3
[2013-03-20 13:24:47 3818] INFO (DevController:361) Calling external migration tool for step 2
[2013-03-20 13:24:47 3818] INFO (DevController:365) Error: Could not find script '/etc/xen/scripts/vif-migration.sh'
[2013-03-20 13:24:47 3818] INFO (XendCheckpoint:135) Domain 2 suspended.
[2013-03-20 13:24:47 3818] INFO (DevController:361) Calling external migration tool for step 3
[2013-03-20 13:24:48 3818] INFO (DevController:365) linux-vm5 bjz_04_sles11_sp2 3
[2013-03-20 13:24:48 3818] INFO (DevController:365) 1
[2013-03-20 13:24:48 3818] INFO (DevController:365) linux-vm5
[2013-03-20 13:24:48 3818] INFO (DevController:365) bjz_04_sles11_sp2
[2013-03-20 13:24:48 3818] INFO (DevController:365) 3
[2013-03-20 13:24:48 3818] INFO (DevController:365) step 3
[2013-03-20 13:24:48 3818] INFO (DevController:365) COMMAND    PID USER   FD   TYPE DEVICE   SIZE/OFF    NODE NAME
[2013-03-20 13:24:48 3818] INFO (DevController:365) bash      4318 root  cwd    DIR   0,19       4096 1163265 /var/lib/xen/images_2/bjz_04_sles11_sp2 (147.2.207.77:/var/lib/xen/images_2/)
[2013-03-20 13:24:48 3818] INFO (DevController:365) qemu-dm   4593 root    9u   REG   0,19 2147483648 1163266 /var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw (147.2.207.77:/var/lib/xen/images_2/)
[2013-03-20 13:24:48 3818] INFO (DevController:365) vncviewer 4736 root  cwd    DIR   0,19       4096 1163265 /var/lib/xen/images_2/bjz_04_sles11_sp2 (147.2.207.77:/var/lib/xen/images_2/)
[2013-03-20 13:24:48 3818] INFO (DevController:365) xm        4950 root  cwd    DIR   0,19       4096 1163265 /var/lib/xen/images_2/bjz_04_sles11_sp2 (147.2.207.77:/var/lib/xen/images_2/)
[2013-03-20 13:24:48 3818] INFO (DevController:365) umount NFS in src
[2013-03-20 13:24:48 3818] INFO (DevController:365) umount.nfs: /var/lib/xen/images_2: device is busy
[2013-03-20 13:24:48 3818] INFO (DevController:365) umount.nfs: /var/lib/xen/images_2: device is busy
[2013-03-20 13:24:48 3818] INFO (DevController:365) mount NFS in dst
[2013-03-20 13:24:48 3818] INFO (DevController:365) mount.nfs: /var/lib/xen/images_2 is busy or already mounted
[2013-03-20 13:24:48 3818] INFO (DevController:378) Calling external migration tool
[2013-03-20 13:24:48 3818] INFO (DevController:382) Error: Could not find script '/etc/xen/scripts/vfb-migration.sh'
[2013-03-20 13:24:48 3818] INFO (DevController:378) Calling external migration tool
[2013-03-20 13:24:48 3818] INFO (DevController:382) Error: Could not find script '/etc/xen/scripts/console-migration.sh'
[2013-03-20 13:24:48 3818] INFO (DevController:378) Calling external migration tool
[2013-03-20 13:24:48 3818] INFO (XendCheckpoint:423) xc: error: Suspend request failed: Internal error
[2013-03-20 13:24:48 3818] INFO (XendCheckpoint:423) xc: error: Domain appears not to have suspended: Internal error
[2013-03-20 13:24:49 3818] ERROR (XendCheckpoint:185) Save failed on domain bjz_04_sles11_sp2 (2) - resuming.
Traceback (most recent call last):
  File "usr/lib64/python2.6/site-packages/xen/xend/XendCheckpoint.py", line 146, in save
    forkHelper(cmd, fd, saveInputHandler, False)
  File "usr/lib64/python2.6/site-packages/xen/xend/XendCheckpoint.py", line 395, in forkHelper
    inputHandler(line, child.tochild)
  File "usr/lib64/python2.6/site-packages/xen/xend/XendCheckpoint.py", line 137, in saveInputHandler
    domain_name)
  File "usr/lib64/python2.6/site-packages/xen/xend/XendDomainInfo.py", line 2470, in migrateDevices
    dst, step, domName)
  File "usr/lib64/python2.6/site-packages/xen/xend/XendDomainInfo.py", line 2481, in _recoverMigrateDevice
    deviceConfig, network, dst, step, domName)
  File "usr/lib64/python2.6/site-packages/xen/xend/server/DevController.py", line 385, in recover_migrate
    raise VmError('Migration tool returned %d' % (rc >> 8))
VmError: Migration tool returned 127
[2013-03-20 13:24:49 3818] DEBUG (XendDomainInfo:3141) XendDomainInfo.resumeDomain(2)
[2013-03-20 13:24:49 3818] DEBUG (XendDomainInfo:3182) XendDomainInfo.resumeDomain: completed
[2013-03-20 13:24:52 3818] ERROR (xmlrpclib2:181) Internal error handling xend.domain.migrate
Traceback (most recent call last):
  File "usr/lib64/python2.6/site-packages/xen/util/xmlrpclib2.py", line 134, in _marshaled_dispatch
    response = self._dispatch(method, params)
  File "/usr/lib64/python2.6/SimpleXMLRPCServer.py", line 418, in _dispatch
    return func(*params)
  File "usr/lib64/python2.6/site-packages/xen/xend/XendDomain.py", line 1385, in domain_migrate
    self._domain_migrate(dominfo, dst, live, port, node)
  File "usr/lib64/python2.6/site-packages/xen/xend/XendDomain.py", line 1478, in _domain_migrate
    dsterr = sock.recv(1024)
timeout: timed out

2), log in dst

[2013-03-21 00:25:08 3834] DEBUG (XendDomainInfo:237) XendDomainInfo.restore(['domain', ['domid', '2'], ['cpu_weight', '256'], ['cpu_cap', '0'], ['pool_name', 'Pool-0'], ['bootloader', ''], ['vcpus', '4'], ['cpus', [[], [], [], []]], ['on_poweroff', 'destroy'], ['description', 'None'], ['on_crash', 'destroy'], ['uuid', '5c84adcc-bd59-788a-96d2-195f9b599cfe'], ['bootloader_args', ''], ['name', 'bjz_04_sles11_sp2'], ['on_reboot', 'restart'], ['maxmem', '512'], ['memory', '512'], ['shadow_memory', '8'], ['vcpu_avail', '15'], ['features', ''], ['on_xend_start', 'ignore'], ['on_xend_stop', 'ignore'], ['start_time', '1363754682.9'], ['cpu_time', '419.10091792'], ['online_vcpus', '4'], ['image', ['hvm', ['kernel', ''], ['superpages', '0'], ['videoram', '4'], ['hpet', '0'], ['stdvga', '0'], ['loader', '/usr/lib/xen/boot/hvmloader'], ['xen_platform_pci', '1'], ['nestedhvm', '0'], ['rtc_timeoffset', '0'], ['pci', []], ['hap', '1'], ['localtime', '0'], ['timer_mode', '1'], ['pci_msitranslate', '1'], ['oos', '1'], ['apic', '1'], ['display', 'localhost:11.0'], ['vpt_align', '1'], ['serial', 'pty'], ['vncunused', '1'], ['boot', 'c'], ['pae', '1'], ['viridian', '0'], ['acpi', '1'], ['vnc', '1'], ['nographic', '0'], ['nomigrate', '0'], ['usb', '0'], ['tsc_mode', '0'], ['guest_os_type', 'default'], ['device_model', '/usr/lib/xen/bin/qemu-dm'], ['keymap', 'en-us'], ['pci_power_mgmt', '0'], ['xauthority', '/root/.xauth3KRtre'], ['isa', '0'], ['notes', ['SUSPEND_CANCEL', '1']]]], ['status', '2'], ['state', '-b----'], ['store_mfn', '1044476'], ['device', ['vif', ['bridge', 'br0'], ['uuid', '8f312b07-3119-3239-ed5b-6fd80d3cbb82'], ['script', '/etc/xen/scripts/vif-bridge'], ['mac', '00:16:3e:56:af:69'], ['type', 'netfront'], ['backend', '0']]], ['device', ['console', ['protocol', 'vt100'], ['location', '7'], ['uuid', 'c272b184-5c76-66a4-881e-e505d658a9a1']]], ['device', ['vbd', ['protocol', 'x86_64-abi'], ['uuid', '6fcac225-3294-fb0c-874d-a480d2efe34d'], ['bootable', '1'], ['dev', 'hda:disk'], ['uname', 'file:/var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw'], ['mode', 'w'], ['backend', '0'], ['VDI', '']]], ['device', ['vbd', ['protocol', 'x86_64-abi'], ['uuid', '7abd3c48-0107-621b-38c0-8ea229182a70'], ['bootable', '0'], ['dev', 'hdc:disk'], ['uname', 'dmmd:lvm;/dev/vg/lv1'], ['mode', 'w'], ['backend', '0'], ['VDI', '']]], ['device', ['vfb', ['vncunused', '1'], ['keymap', 'en-us'], ['vnc', '1'], ['uuid', '3a354454-d21e-f809-6c25-0fe7e20402f5'], ['location', '127.0.0.1:5900']]], ['change_home_server', 'False']])
[2013-03-21 00:25:08 3834] DEBUG (XendDomainInfo:2499) XendDomainInfo.constructDomain
[2013-03-21 00:25:08 3834] DEBUG (balloon:187) Balloon: 538340 KiB free; need 16384; done.
[2013-03-21 00:25:08 3834] DEBUG (XendDomain:476) Adding Domain: 19
[2013-03-21 00:25:08 3834] DEBUG (XendDomainInfo:3426) Storing VM details: {'on_xend_stop': 'ignore', 'pool_name': 'Pool-0', 'shadow_memory': '8', 'uuid': '5c84adcc-bd59-788a-96d2-195f9b599cfe', 'on_reboot': 'restart', 'start_time': '1363754682.9', 'on_poweroff': 'destroy', 'bootloader_args': '', 'on_xend_start': 'ignore', 'on_crash': 'destroy', 'xend/restart_count': '0', 'vcpus': '4', 'vcpu_avail': '15', 'bootloader': '', 'image': "(hvm (kernel '') (superpages 0) (videoram 4) (hpet 0) (stdvga 0) (loader /usr/lib/xen/boot/hvmloader) (xen_platform_pci 1) (nestedhvm 0) (rtc_timeoffset 0) (pci ()) (hap 1) (localtime 0) (timer_mode 1) (pci_msitranslate 1) (oos 1) (apic 1) (display localhost:11.0) (vpt_align 1) (serial pty) (vncunused 1) (boot c) (pae 1) (viridian 0) (acpi 1) (vnc 1) (nographic 0) (nomigrate 0) (usb 0) (tsc_mode 0) (guest_os_type default) (device_model /usr/lib/xen/bin/qemu-dm) (keymap en-us) (pci_power_mgmt 0) (xauthority /root/.xauth3KRtre) (isa 0) (notes (SUSPEND_CANCEL 1)))", 'name': 'bjz_04_sles11_sp2'}
[2013-03-21 00:25:08 3834] INFO (XendDomainInfo:2358) createDevice: console : {'protocol': 'vt100', 'location': '7', 'uuid': 'c272b184-5c76-66a4-881e-e505d658a9a1'}
[2013-03-21 00:25:08 3834] DEBUG (DevController:95) DevController: writing {'state': '1', 'backend-id': '0', 'backend': '/local/domain/0/backend/console/19/0'} to /local/domain/19/device/console/0.
[2013-03-21 00:25:08 3834] DEBUG (DevController:97) DevController: writing {'domain': 'bjz_04_sles11_sp2', 'frontend': '/local/domain/19/device/console/0', 'uuid': 'c272b184-5c76-66a4-881e-e505d658a9a1', 'frontend-id': '19', 'state': '1', 'location': '7', 'online': '1', 'protocol': 'vt100'} to /local/domain/0/backend/console/19/0.
[2013-03-21 00:25:08 3834] INFO (XendDomainInfo:2358) createDevice: vfb : {'vncunused': '1', 'vnc': '1', 'uuid': '3a354454-d21e-f809-6c25-0fe7e20402f5', 'other_config': {'vncunused': '1', 'keymap': 'en-us', 'vnc': '1'}, 'keymap': 'en-us', 'location': '127.0.0.1:5900'}
[2013-03-21 00:25:08 3834] DEBUG (DevController:95) DevController: writing {'state': '1', 'backend-id': '0', 'backend': '/local/domain/0/backend/vfb/19/0'} to /local/domain/19/device/vfb/0.
[2013-03-21 00:25:08 3834] DEBUG (DevController:97) DevController: writing {'vncunused': '1', 'domain': 'bjz_04_sles11_sp2', 'frontend': '/local/domain/19/device/vfb/0', 'uuid': '3a354454-d21e-f809-6c25-0fe7e20402f5', 'frontend-id': '19', 'state': '1', 'keymap': 'en-us', 'location': '127.0.0.1:5900', 'online': '1', 'vnc': '1'} to /local/domain/0/backend/vfb/19/0.
[2013-03-21 00:25:08 3834] INFO (XendDomainInfo:2358) createDevice: vbd : {'protocol': 'x86_64-abi', 'uuid': '6fcac225-3294-fb0c-874d-a480d2efe34d', 'bootable': 1, 'driver': 'paravirtualised', 'dev': 'hda:disk', 'uname': 'file:/var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw', 'mode': 'w', 'VDI': '', 'backend': '0'}
[2013-03-21 00:25:08 3834] DEBUG (DevController:95) DevController: writing {'virtual-device': '768', 'protocol': 'x86_64-abi', 'device-type': 'disk', 'backend-id': '0', 'state': '1', 'backend': '/local/domain/0/backend/vbd/19/768'} to /local/domain/19/device/vbd/768.
[2013-03-21 00:25:08 3834] DEBUG (DevController:97) DevController: writing {'domain': 'bjz_04_sles11_sp2', 'frontend': '/local/domain/19/device/vbd/768', 'uuid': '6fcac225-3294-fb0c-874d-a480d2efe34d', 'bootable': '1', 'dev': 'hda', 'state': '1', 'params': '/var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw', 'mode': 'w', 'online': '1', 'frontend-id': '19', 'type': 'file'} to /local/domain/0/backend/vbd/19/768.
[2013-03-21 00:25:08 3834] INFO (XendDomainInfo:2358) createDevice: vbd : {'protocol': 'x86_64-abi', 'uuid': '7abd3c48-0107-621b-38c0-8ea229182a70', 'bootable': 0, 'driver': 'paravirtualised', 'dev': 'hdc:disk', 'uname': 'dmmd:lvm;/dev/vg/lv1', 'mode': 'w', 'VDI': '', 'backend': '0'}
[2013-03-21 00:25:08 3834] DEBUG (DevController:95) DevController: writing {'virtual-device': '5632', 'protocol': 'x86_64-abi', 'device-type': 'disk', 'backend-id': '0', 'state': '1', 'backend': '/local/domain/0/backend/vbd/19/5632'} to /local/domain/19/device/vbd/5632.
[2013-03-21 00:25:08 3834] DEBUG (DevController:97) DevController: writing {'domain': 'bjz_04_sles11_sp2', 'frontend': '/local/domain/19/device/vbd/5632', 'uuid': '7abd3c48-0107-621b-38c0-8ea229182a70', 'bootable': '0', 'dev': 'hdc', 'state': '1', 'params': 'lvm;/dev/vg/lv1', 'mode': 'w', 'online': '1', 'frontend-id': '19', 'type': 'dmmd'} to /local/domain/0/backend/vbd/19/5632.
[2013-03-21 00:25:08 3834] INFO (XendDomainInfo:2358) createDevice: vif : {'bridge': 'br0', 'uuid': '8f312b07-3119-3239-ed5b-6fd80d3cbb82', 'script': '/etc/xen/scripts/vif-bridge', 'mac': '00:16:3e:56:af:69', 'type': 'netfront', 'backend': '0'}
[2013-03-21 00:25:08 3834] DEBUG (DevController:95) DevController: writing {'backend-id': '0', 'mac': '00:16:3e:56:af:69', 'handle': '0', 'state': '1', 'backend': '/local/domain/0/backend/vif/19/0'} to /local/domain/19/device/vif/0.
[2013-03-21 00:25:08 3834] DEBUG (DevController:97) DevController: writing {'bridge': 'br0', 'domain': 'bjz_04_sles11_sp2', 'handle': '0', 'uuid': '8f312b07-3119-3239-ed5b-6fd80d3cbb82', 'script': '/etc/xen/scripts/vif-bridge', 'mac': '00:16:3e:56:af:69', 'frontend-id': '19', 'state': '1', 'online': '1', 'frontend': '/local/domain/19/device/vif/0', 'type': 'netfront'} to /local/domain/0/backend/vif/19/0.
[2013-03-21 00:25:08 3834] DEBUG (XendDomainInfo:1795) Storing domain details: {'console/port': '7', 'cpu/3/availability': 'online', 'description': 'None', 'console/limit': '1048576', 'cpu/2/availability': 'online', 'vm': '/vm/5c84adcc-bd59-788a-96d2-195f9b599cfe', 'domid': '19', 'store/port': '6', 'cpu/0/availability': 'online', 'memory/target': '524288', 'control/platform-feature-multiprocessor-suspend': '1', 'console/type': 'ioemu', 'cpu/1/availability': 'online', 'control/platform-feature-xs_reset_watches': '1', 'image/suspend-cancel': '1', 'name': 'bjz_04_sles11_sp2'}
[2013-03-21 00:25:08 3834] INFO (XendCheckpoint:260) restore hvm domain 19, apic=1, pae=1
[2013-03-21 00:25:09 3834] DEBUG (image:339) No VNC passwd configured for vfb access
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: boot, val: c
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: fda, val: None
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: fdb, val: None
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: soundhw, val: None
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: localtime, val: 0
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: serial, val: ['pty']
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: std-vga, val: 0
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: isa, val: 0
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: acpi, val: 1
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: usb, val: 0
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: usbdevice, val: None
[2013-03-21 00:25:09 3834] DEBUG (image:891) args: gfx_passthru, val: None
[2013-03-21 00:25:09 3834] INFO (image:822) Need to create platform device.[domid:19]
[2013-03-21 00:25:09 3834] DEBUG (XendCheckpoint:278) restore:shadow=0x8, _static_max=0x20000000, _static_min=0x0, 
[2013-03-21 00:25:09 3834] DEBUG (XendCheckpoint:305) [xc_restore]: /usr/lib64/xen/bin/xc_restore 26 19 6 7 1 1 1 0

6, how about saveDeviceModel?
    def saveInputHandler(line, tochild):
        log.debug("In saveInputHandler %s", line)
        if line == "suspend":
            log.debug("Suspending %d ...", dominfo.getDomid())
            dominfo.shutdown('suspend')
            dominfo.waitForSuspend()
        if line in ('suspend', 'suspended'):
            dominfo.migrateDevices(network, dst, DEV_MIGRATE_STEP2,
                                   domain_name)
            log.info("Domain %d suspended.", dominfo.getDomid())
            dominfo.migrateDevices(network, dst, DEV_MIGRATE_STEP3,
                                   domain_name)
            if hvm:
                dominfo.image.saveDeviceModel()

        if line == "suspend":
            tochild.write("done\n")
            tochild.flush()
            log.debug('Written done')

7, do test and comment the file check in parseDeviceModelArgs in hvm. line 900-904.
in File "/usr/lib64/python2.6/site-packages/xen/xend/image.py".
force in umount NFS: umount -f -l
1), fail in destination: it seems that wait for device timeout.
enlarge the timeout in server/DevConstants.py:
DEVICE_CREATE_TIMEOUT  = xoptions.get_device_create_timeout();
but it is not work. even if Chunyan sleep 2 before waitForDevices.
 # this archive for more details.

+import time
 import os
         try:
+            time.sleep(2)
             dominfo.waitForDevices() # Wait for backends to set up
         finally:

8, Chunyan found that the hotplug is error. from the time stamp, we could not that this is before the suspend.
1), Wed Mar 20 16:16:38 CST 2013
xenstore-ls /local/domain/0/backend/vbd/
    vbd = ""
     38 = ""
      768 = ""
       domain = "bjz_04_sles11_sp2"
       frontend = "/local/domain/38/device/vbd/768"
       uuid = "8b34ca86-9010-bfa5-80c0-486f2f55f85e"
       bootable = "1"
       dev = "hda"
       state = "2"
       params = "/var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw"
       mode = "w"
       online = "1"
       frontend-id = "38"
       type = "file"
       hotplug-error = "/var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw do\..."
       hotplug-status = "error"
2), time stamp xend.log in src
[2013-03-20 16:16:37 3818] DEBUG (XendCheckpoint:124) [xc_save]: /usr/lib64/xen/bin/xc_save 26 20 0 0 5
[2013-03-20 16:16:53 3818] DEBUG (XendCheckpoint:394) suspended

9, Chunyan suggest me that read the xc restore code.
1), read xc_domain_restore.c, do not found anything.
2), found the error message in hotplug/Linux/block:
case "$commmand" in
  add)
  ...
    case $t in
      pyh)
      file)
        file=$(readlink -f "$p") || fatal "$p does not exist."
        ...
      "")
      
notes: "" means default in python switch case.

fatal defined in xen-hotplug-common.sh:
fatal() {
  _xenstore_write "$XENBUS_PATH/hotplug-error" "$*" \
                  "$XENBUS_PATH/hotplug-status" error
  log err "$@"
  exit 1
}

10, \TODO how to retrigger hotplug?

10:08 2013-03-20
GTD
0, 9:20-18:50

1, today
1), 9:50-11:40 12:40-18:40 xen migration hook, bnc#801663. see"10:07 2013-03-20"

1), libvirt libxl lock patch. see"14:24 2013-03-13"6.
2, \TODO
2), keep an eye on Xen Test Days. see"13:29 2013-02-22"1

2, daily work
1), tracking xen-arm update.
2), read libvirt and xen-devel quickly, should less that 30minutes.
3), read linux news
http://www.linux.com/
http://www.phoronix.com/scan.php?page=home

3, week plan
1), test Jim lastest Patch.
2), send console patch to upstream.
3), finish libxl block status and relative functions.

4, next
1), read code about lastest kernel porting. see"11:49 2013-02-07".
1), coding excise for pthread_atfork.
2), rt-thread moto control driver in lua. first version do not use the PWM.

1), for libxl xen4.2 bug, figure out why virsh got event after libxl think its done. see"10:41 2013-01-24".
2), write code for libxl qmp. see"17:15 2013-01-23"
4), read jim patch on libvirt and xen.
3), debug libvirt libxl console. see"16:50 2013-01-04"
1), send xen libexec patch.
1), test Jim patch for libxl xen4.2 bug. see"11:00 2012-12-21"
3), re-read all the patch about libxl xen4.2.
1), got arm technical symposia pdf.
2), libvirt blkstats:
(1), add block stats in libxl_qmp.c, add cmd in xl.
(2), add patch in libvirt, send it to Jim. if the former patch only accept by xen-unstable not xen4.2-testing. i could not send patch to libvirt upstream.
3), try xen on kvm.
4), 对于vi不能方便查找keywords这个事情, 实在不能忍了, 如果这周能把managed save和bridge-utils bug fix, 就把这个做一个.

3, next week
1), work on lock patch.
2), try to build MK802 kernel on obs. speed up. i want it work on opensuse12.3
2), read kernel doc: "10:36 2012-11-23"
1), read code for patch. see"10:25 2012-11-23"2-2)-(2).
2), after "1)" finish. try xen on kvm.
3), read the mail on "Andrew Wafaa <awafaa@opensuse.org>"_email_"[opensuse-arm] Fwd: [fedora-arm] ARMv8 Bootstrap Project"_20121122
3), work on xen on ARM. ref"22:33 2012-11-19"
4), check the error from "10:18 2012-11-15"2
2012-11-15 04:02:45.318+0000: 4307: error : virNodeGetSecurityModel:9567 : this function is not supported by the connection driver: virNodeGetSecurityModel
5), ask jim to invite me to xen irc.

3, next next
1), gsoc: "22:23 2012-11-17"
1), notes about Huawei from eet-china.
2), read bug:https://bugzilla.novell.com/show_bug.cgi?id=781425

2, next
1), try to improve attach-disk, detach-disk in libxl driver, see"18:17 2012-11-07"4
2), test attach-disk command. see"10:41 2012-10-30"2
3), maybe libxl and qemu could communicate with qemu through xenstore?

libxl_dm.c:
        /* Find uuid and the write the vnc password to xenstore for qemu. */
        t = xs_transaction_start(ctx->xsh);
        vm_path = libxl__xs_read(&gc,t,libxl__sprintf(&gc, "%s/vm", p->dom_path));
        if (vm_path) {
            /* Now write the vncpassword into it. */
            pass_stuff = libxl__calloc(&gc, 3, sizeof(char *));
            pass_stuff[0] = "vncpasswd";
            pass_stuff[1] = info->vncpasswd;
            libxl__xs_writev(&gc,t,vm_path,pass_stuff);

3, for Jim
1), xenlight event lock in libvirt. see"16:52 2012-11-06"2-1).

4, next month
1), opensuse on MK802
(1), generate the 512MB version with opensuse12.2 RC2 which enable yast fist run.
(2), try opensuse based on ubuntu kernel in order to solve the error from miniand.
2), try armv8 emulator and read armv8 kernel code.

17:28 2013-03-20
next X11: wayland
ubuntu: mir

