.LOG
09:43 2012-12-03
virtualization, libvirt, xen, xend, support management save, bugzilla, cont10, deal with Jim reply
1, Jim_email_20121201
Bamvor Jian Zhang wrote:
> Implement the domainManagedSave, domainHasManagedSaveImage, and
> domainManagedSaveRemove functions in the libvirt legacy xen driver.
>   

Cool, thanks for the patch!

In case others are interested, one motivation for adding this
functionality in the legacy xen driver is to avoid xen-only hacks in the
nova libvirt driver.

> domainHasManagedSaveImage check the managedsave image from filesystem
> everytime. This is different from qemu and libxl driver. In qemu or
> libxl driver, there is a hasManagesSave flags in virDomainObjPtr which
> is not used in xen legacy driver. This flag could not add into xen
> driver ptr either, because the driver ptr will be release at the end of
> every libvirt api calls. Meanwhile, AFAIK, xen store all the flags in
> xen not in libvirt xen driver. There is no need to add this flags in xen.
>   

I think checking the filesystem is the only way to go since xend doesn't
have the notion of managedsave.  Do others see any issues with this
approach?

> ---
> i have test the following case for this patch:
> 1), "virsh managedsave" save domain to /var/lib/xen/save/domain_name.save.
> call xenUnifiedDomainManagedSave.
> 2), "virsh start": if managedsave image is exist, it should be boot from
> managed save image.
> call xenUnifiedDomainHasManagedSaveImage.
> 3), "virsh start --force-boot": fresh boot, delete the managed save image
> if exists.
> call xenUnifiedDomainHasManagedSaveImage,
> xenUnifiedDomainManagedSaveRemove.
> 4), "virsh managedsave-remove": remove managed save image.
> call xenUnifiedDomainManagedSaveRemove
> 5), "virsh undefine": undefine the domain, it will fail if mananed save
> image exist.
> call xenUnifiedDomainHasManagedSaveImage.
> 6), "virsh undefine --managed-save": undefine the domain, and remove
> mananed save image.
> call xenUnifiedDomainHasManagedSaveImage and
> xenUnifiedDomainManagedSaveRemove.
> 7), "virsh list --all --with-managed-save". list domain if managed save
> image exist. got nothing if non-exists.
> call xenUnifiedDomainHasManagedSaveImage.
> 8), "virsh list --all --without-managed-save". do not list the domain if
> managed save image exist.
> call xenUnifiedDomainHasManagedSaveImage.
>   

Thanks for including your test cases.  I've tried these on your patch as
well and looks good!

>  src/xen/xen_driver.c | 109 ++++++++++++++++++++++++++++++++++++++++++++++++++-
>  src/xen/xen_driver.h |   2 +
>  2 files changed, 110 insertions(+), 1 deletion(-)
>
> diff --git a/src/xen/xen_driver.c b/src/xen/xen_driver.c
> index 5a40757..0b2418d 100644
> --- a/src/xen/xen_driver.c
> +++ b/src/xen/xen_driver.c
> @@ -67,6 +67,7 @@
>  #include "nodeinfo.h"
>  
>  #define VIR_FROM_THIS VIR_FROM_XEN
> +#define XEN_SAVE_DIR LOCALSTATEDIR "/lib/libvirt/xen/save"
>   

#include "configmake.h" is needed for LOCALSTATEDIR

>  
>  static int
>  xenUnifiedNodeGetInfo(virConnectPtr conn, virNodeInfoPtr info);
> @@ -267,6 +268,7 @@ xenUnifiedOpen(virConnectPtr conn, virConnectAuthPtr auth, unsigned int flags)
>  {
>      int i, ret = VIR_DRV_OPEN_DECLINED;
>      xenUnifiedPrivatePtr priv;
> +    char ebuf[1024];
>  
>  #ifdef __sun
>      /*
> @@ -406,6 +408,17 @@ xenUnifiedOpen(virConnectPtr conn, virConnectAuthPtr auth, unsigned int flags)
>      }
>  #endif
>  
> +    if (virAsprintf(&priv->saveDir, "%s", XEN_SAVE_DIR) == -1) {
> +        virReportOOMError();
> +        goto fail;
> +    }
> +
> +    if (virFileMakePath(priv->saveDir) < 0) {
> +        VIR_ERROR(_("Failed to create save dir '%s': %s"), priv->saveDir,
> +                  virStrerror(errno, ebuf, sizeof(ebuf)));
> +        goto fail;
> +    }
> +
>      return VIR_DRV_OPEN_SUCCESS;
>  
>  fail:
> @@ -437,6 +450,7 @@ xenUnifiedClose(virConnectPtr conn)
>          if (priv->opened[i])
>              drivers[i]->xenClose(conn);
>  
> +    VIR_FREE(priv->saveDir);
>      virMutexDestroy(&priv->lock);
>      VIR_FREE(conn->privateData);
>  
> @@ -1080,6 +1094,79 @@ xenUnifiedDomainSave(virDomainPtr dom, const char *to)
>      return xenUnifiedDomainSaveFlags(dom, to, NULL, 0);
>  }
>  
> +static char *
> +xenUnifiedDomainManagedSavePath(xenUnifiedPrivatePtr priv, virDomainPtr dom)
> +{
> +    char *ret;
> +
> +    if (virAsprintf(&ret, "%s/%s.save", priv->saveDir, dom->name) < 0) {
> +        virReportOOMError();
> +        return NULL;
> +    }
> +
> +    VIR_DEBUG("managed save image: %s", ret);
> +    return ret;
> +}
> +
> +static int
> +xenUnifiedDomainManagedSave(virDomainPtr dom, unsigned int flags)
> +{
> +    GET_PRIVATE(dom->conn);
> +    char *name;
> +    int ret = -1;
> +
> +    virCheckFlags(0, -1);
> +
> +    name = xenUnifiedDomainManagedSavePath(priv, dom);
> +    if (!name)
> +        goto cleanup;
> +
> +    if (priv->opened[XEN_UNIFIED_XEND_OFFSET])
> +        ret = xenDaemonDomainSave(dom, name);
> +
> +cleanup:
> +    VIR_FREE(name);
> +    return ret;
> +}
> +
> +static int
> +xenUnifiedDomainHasManagedSaveImage(virDomainPtr dom, unsigned int flags)
> +{
> +    GET_PRIVATE(dom->conn);
> +    char *name;
> +    int ret = -1;
> +
> +    virCheckFlags(0, -1);
> +
> +    name = xenUnifiedDomainManagedSavePath(priv, dom);
> +    if (!name)
> +        return ret;
> +
> +    ret = virFileExists(name);
> +    VIR_FREE(name);
> +    return ret;
> +}
> +
> +static int
> +xenUnifiedDomainManagedSaveRemove(virDomainPtr dom, unsigned int flags)
> +{
> +    GET_PRIVATE(dom->conn);
> +    char *name;
> +    int ret = -1;
> +
> +    virCheckFlags(0, -1);
> +
> +    name = xenUnifiedDomainManagedSavePath(priv, dom);
> +    if (!name)
> +        goto cleanup;
>   

I think we can do away with the cleanup label and simply return ret here.

> +
> +    ret = unlink(name);
> +    VIR_FREE(name);
> +
> +cleanup:
> +    return ret;
> +}
> +
>  static int
>  xenUnifiedDomainRestoreFlags(virConnectPtr conn, const char *from,
>                               const char *dxml, unsigned int flags)
> @@ -1504,16 +1591,33 @@ static int
>  xenUnifiedDomainCreateWithFlags(virDomainPtr dom, unsigned int flags)
>  {
>      GET_PRIVATE(dom->conn);
> +    char *name;
>      int i;
> +    int ret = -1;
>  
>      virCheckFlags(0, -1);
>  
> +    name = xenUnifiedDomainManagedSavePath(priv, dom);
> +    if (!name)
> +        goto cleanup;
> +
> +    if (virFileExists(name)) {
> +        if (priv->opened[XEN_UNIFIED_XEND_OFFSET]) {
> +            ret = xenDaemonDomainRestore(dom->conn, name);
> +            if (ret == 0)
> +                unlink(name);
> +        }
> +        VIR_FREE(name);
> +        goto cleanup;
> +    }
>   

name is leaked here if virFileExists() fails.  You can initialize name
to NULL and then unconditionally free it in cleanup.

> +
>      for (i = 0; i < XEN_UNIFIED_NR_DRIVERS; ++i)
>          if (priv->opened[i] && drivers[i]->xenDomainCreate &&
>              drivers[i]->xenDomainCreate(dom) == 0)
>              return 0;
>  
> -    return -1;
> +cleanup:
> +    return ret;
>  }
>  
>  static int
> @@ -2218,6 +2322,9 @@ static virDriver xenUnifiedDriver = {
>      .domainGetState = xenUnifiedDomainGetState, /* 0.9.2 */
>      .domainSave = xenUnifiedDomainSave, /* 0.0.3 */
>      .domainSaveFlags = xenUnifiedDomainSaveFlags, /* 0.9.4 */
> +    .domainManagedSave = xenUnifiedDomainManagedSave, /* 1.0.1 */
> +    .domainHasManagedSaveImage = xenUnifiedDomainHasManagedSaveImage, /* 1.0.1 */
> +    .domainManagedSaveRemove = xenUnifiedDomainManagedSaveRemove, /* 1.0.1 */
>      .domainRestore = xenUnifiedDomainRestore, /* 0.0.3 */
>      .domainRestoreFlags = xenUnifiedDomainRestoreFlags, /* 0.9.4 */
>      .domainCoreDump = xenUnifiedDomainCoreDump, /* 0.1.9 */
> diff --git a/src/xen/xen_driver.h b/src/xen/xen_driver.h
> index b3fbcff..078980e 100644
> --- a/src/xen/xen_driver.h
> +++ b/src/xen/xen_driver.h
> @@ -200,6 +200,8 @@ struct _xenUnifiedPrivate {
>      /* Location of config files, either /etc
>       * or /var/lib/xen */
>      const char *configDir;
> +    /* Location of managed save dir, default /var/lib/libvirt/xen/save */
> +    char *saveDir;
>  
>  # if WITH_XEN_INOTIFY
>      /* The inotify fd */
>   

With exception of the few nits, looks good!  I would like to hear what
others think about checking existence of the managed save image on each invocation of domainHasManagedSaveImage().

Thanks,
Jim

09:48 2012-12-03
GTD
0, 9:30-11:59 13:40-14:33 -17:40

1, today
1), 10' work on libvirt manage save for xen legacy: update patch and reply to Jim. see"09:43 2012-12-03".
2), 40' fix bug in bridge-utils: https://bugzilla.novell.com/show_bug.cgi?id=789275. sr id 22942. how to using quilt, see"10:29 2012-12-03"
3), mailing list. devel-server. see"13:54 2012-12-03"
4), 10' work report. see"17:25 2012-12-03"

10:29 2012-12-03
osc, build service, obs/ibs, patch, try quilt commands
doc: http://147.2.207.240/~dmzhang/osc-quilt.markdown
1, bamvor@linux-bjrd:bridge-utils-1.4> quilt new bridge-utils-1.4-show-selected-bridge.patch
Patch patches/bridge-utils-1.4-show-selected-bridge.patch is now on top
2, bamvor@linux-bjrd:bridge-utils-1.4> quilt edit brctl/brctl_cmd.c 
File brctl/brctl_cmd.c added to patch patches/bridge-utils-1.4-show-selected-bridge.patch
using gvim
bamvor@linux-bjrd:bridge-utils-1.4> EDITOR=gvim quilt edit brctl/brctl_cmd.c
File brctl/brctl_cmd.c is already in patch patches/bridge-utils-1.4-show-selected-bridge.patch
3, bamvor@linux-bjrd:bridge-utils-1.4> quilt diff
Index: bridge-utils-1.4/brctl/brctl_cmd.c     
===================================================================
--- bridge-utils-1.4.orig/brctl/brctl_cmd.c                        
+++ bridge-utils-1.4/brctl/brctl_cmd.c                             
...//show the patch file
bamvor@linux-bjrd:bridge-utils-1.4> quilt refresh
Refreshed patch patches/bridge-utils-1.4-show-selected-bridge.patch
now xxx.patch is actually created in the patches directory(the parent directory). 

13:54 2012-12-03
mailing list, devel-server, CI(Continous Integration), jenkin; obs, notification, hermes
1, Lin Ma
1), -CI server.
Contacted Bernhard M. Wiedemann to get some useful information about 
the jenkins scripts in SUSE-Cloud automation project.

Created a local jenkins instance for kvm autotest. defined my own trigger 
policy by creating two scripts:
One script monitors SLE 11 sp3 repo on ibs, if it detects any updates, it will 
analyzes the update info to determine if there is a new qemu-kvm package. 
If so, the another one will get the new qemu-kvm package name, remove
the old package and install the new package. Later,The test jobs will be 
triggered to perform one by one and send out real notification through email.

I've deployed 40% kvm autotests scripts in this jenkins instance. Based on 
aboved trigger policy, they works well. But the rest of kvm autotests scripts 
don't work well, some of them need certain utility packages in guest image, 
some of them need special configuration. I'm working on them to add/fix 
these dependency.
2), olaf kirch and Vincent Untz reply to Lin Ma
> Cool, this looks extremely useful!
> 
> This makes me wonder whether there's a mechanism to receive notifications
> for specific package updates from IBS without polling. Maybe you could ask
> Adrian Schröter if there are such notifications available somewhere in the
> dark depths of IBS...

You can configure hermes (https://mercurius.suse.de/ for IBS) to send
you a notification when there's a commit (by mail, rss feed, xmpp
message).

In hermes for OBS, the notifications can also be sent through a raw HTTP
GET query (which would probably be the simplest option for cases like
this, I guess).

Vincent

14:31 2012-12-03
mailing list, kernel, crash
1, "Mike Galbraith <mgalbraith@suse.de>"_answer_"Michal Kubecek <mkubecek@suse.cz>"_email_"[kernel] question: worker thread named [kworker/0:1] on every CPU"_20121130_2235
On Fri, 2012-11-30 at 15:35 +0100, Michal Kubecek wrote:
> Hello,
> 
> in crash dumps for bnc#790939 I found something I don't understand. On
> every CPU, there is a process named "[kworker/0:1]" in RU state. I
> always thought the first number after the slash should be the CPU the
> thread is running on (or 'u' for unbound). But here I have threads with
> '0' on all CPU's.

Check pid, the name is a lie.
 
> Another strange thing is that except NMI or normal interrupt stack, all
> of them have only cpu_idle on stack (and possibly an Intel specific
> implementation).

Because they're really swapper.
 
> Are these threads result of normal operation or sign of a problem?

It's normal.
 
crash: vmlinux: no .gnu_debuglink section
GNU gdb (GDB) 7.0
Copyright (C) 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-unknown-linux-gnu"...

      KERNEL: vmlinux
    DUMPFILE: /proc/kcore
        CPUS: 64
        DATE: Fri Nov 30 18:21:23 2012
      UPTIME: 00:57:39
LOAD AVERAGE: 0.12, 0.08, 0.11
       TASKS: 533
    NODENAME: vogelweide
     RELEASE: 3.0.38-0.5-default
     VERSION: #1 SMP Fri Aug 3 09:02:17 UTC 2012 (358029e)
     MACHINE: x86_64  (2261 Mhz)
      MEMORY: 8 GB
         PID: 6764
     COMMAND: "crash"
        TASK: ffff88026d2c4040  [THREAD_INFO: ffff88026c156000]
         CPU: 16
       STATE: TASK_RUNNING (ACTIVE)

crash> ps|less
   PID    PPID  CPU       TASK        ST  %MEM     VSZ    RSS  COMM
>     0      0   0  ffffffff81a0b020  RU   0.0       0      0  [swapper]
>     0      2   1  ffff8802714aa300  RU   0.0       0      0  [kworker/0:0]
>     0      2   2  ffff8802714c6440  RU   0.0       0      0  [kworker/0:1]
>     0      2   3  ffff880271502580  RU   0.0       0      0  [kworker/0:1]
...

crash> task_struct ffff8802714aa300|grep cfs_rq
    cfs_rq = 0xffff88027e6311f0, 
crash> struct cfs_rq 0xffff88027e6311f0|grep rq
struct cfs_rq {
  rq = 0xffff88027e631180, 
  leaf_cfs_rq_list = {
crash> struct rq 0xffff88027e631180|grep idle
  idle = 0xffff8802714aa300,

Newer kernels are honest.

crash: vmlinux: no .gnu_debuglink section
GNU gdb (GDB) 7.0
Copyright (C) 2009 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-unknown-linux-gnu"...

      KERNEL: vmlinux
    DUMPFILE: /proc/kcore
        CPUS: 64
        DATE: Fri Nov 30 18:51:18 2012
      UPTIME: 00:19:12
LOAD AVERAGE: 1.30, 1.35, 1.12
       TASKS: 1192
    NODENAME: vogelweide
     RELEASE: 3.0.50-rt74-0-rt
     VERSION: #1 SMP PREEMPT RT Fri Nov 9 13:48:16 UTC 2012 (c6efdc8)
     MACHINE: x86_64  (2260 Mhz)
      MEMORY: 8 GB
         PID: 7076
     COMMAND: "crash"
        TASK: ffff88026f21c400  [THREAD_INFO: ffff8802754a2000]
         CPU: 0
       STATE: TASK_RUNNING (ACTIVE)

crash> ps|less
   PID    PPID  CPU       TASK        ST  %MEM     VSZ    RSS  COMM
      0      0   0  ffffffff81a11020  RU   0.0       0      0  [swapper/0]
>     0      2   1  ffff880275818b30  RU   0.0       0      0  [swapper/1]
>     0      2   2  ffff880275870c70  RU   0.0       0      0  [swapper/2]
>     0      2   3  ffff8802758aadb0  RU   0.0       0      0  [swapper/3]
...


17:25 2012-12-03
work report - week 48
1, [devel-server] work report - week 48
1), working on bnc 782311: Snapshots stuck "queued" with Xen as HV. 
discuss with Jim about my patch in private and then send it to upstream.
2), help Yadan Fan(Beijing L3 team) work on bnc#790928. 
3), fix bug in bridge-utils. bnc#789275.

10:04 2012-12-04
GTD
0, 9:50-11:50 13:05-18:15

1, today
1), 40' libxl event: work on Ian Jackson comments. see"17:51 2012-11-30"
2), 30' talk with Jim. item""1-1), ""1-4).
3), 20' know something about fedora ARM status. 
4), 13:12-13:35 14:09-18:04 send patch V2 for management save to upstream. see"11:45 2012-12-04"
5), 20' prepare environment for building kernel with kvm nested. see"16:30 2012-12-04"
6), Summary: 上次Jim说发了Upstream patch之后把链接贴到bugzilla上, 结果我忘了. 

11:45 2012-12-04
virtualization, libvirt, xen, xend, support management save, bugzilla, cont11, work on patch v2 for upstream; test pass: ""6
1, Jim_20121204
1), email
>>  #define VIR_FROM_THIS VIR_FROM_XEN
>> +#define XEN_SAVE_DIR LOCALSTATEDIR "/lib/libvirt/xen/save"
>>   
>>     
>
> #include "configmake.h" is needed for LOCALSTATEDIR
>   

BTW, you will also need to install this directory and add it to %files
in the spec file.  Squashing in the attached patch should do it.
2), attachment
diff --git a/libvirt.spec.in b/libvirt.spec.in
index 5b3f4e4..ec6fc8b 100644
--- a/libvirt.spec.in
+++ b/libvirt.spec.in
@@ -1719,6 +1719,9 @@ rm -f $RPM_BUILD_ROOT%{_sysconfdir}/sysctl.d/libvirtd
 %ghost %dir %{_localstatedir}/run/libvirt/libxl/
 %dir %attr(0700, root, root) %{_localstatedir}/lib/libvirt/libxl/
 %endif
+%if %{with_xen}
+%dir %attr(0700, root, root) %{_localstatedir}/lib/libvirt/xen/
+%endif
 %if %{with_network}
 %ghost %dir %{_localstatedir}/run/libvirt/network/
 %dir %attr(0700, root, root) %{_localstatedir}/lib/libvirt/network/
diff --git a/src/Makefile.am b/src/Makefile.am
index b5c20c8..2d36380 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -1768,6 +1768,9 @@ if WITH_UML
 	$(MKDIR_P) "$(DESTDIR)$(localstatedir)/lib/libvirt/uml"
 	$(MKDIR_P) "$(DESTDIR)$(localstatedir)/run/libvirt/uml"
 endif
+if WITH_XEN
+	$(MKDIR_P) "$(DESTDIR)$(localstatedir)/lib/libvirt/xen"
+endif
 if WITH_NETWORK
 	$(MKDIR_P) "$(DESTDIR)$(localstatedir)/lib/libvirt/network"
 	$(MKDIR_P) "$(DESTDIR)$(localstatedir)/lib/libvirt/dnsmasq"
@@ -1814,6 +1817,9 @@ if WITH_UML
 	rmdir "$(DESTDIR)$(localstatedir)/lib/libvirt/uml" ||:
 	rmdir "$(DESTDIR)$(localstatedir)/run/libvirt/uml" ||:
 endif
+if WITH_XEN
+	rmdir "$(DESTDIR)$(localstatedir)/lib/libvirt/xen" ||:
+endif
 if WITH_NETWORK
 	rm -f $(DESTDIR)$(sysconfdir)/libvirt/qemu/networks/autostart/default.xml
 	rm -f $(DESTDIR)$(sysconfdir)/libvirt/qemu/networks/default.xml
2, compile and test
1), checking
(1), make check
pass
(2), make syntax-check
fail at(actual it always fail): 
vulnerable_makefile_CVE-2009-4029
./Makefile.in:2033:     -find $(distdir) -type d ! -perm -777 -exec chmod a+rwx {} \; -o \
maint.mk: the above files are vulnerable; beware of running
  "make dist*" rules, and upgrade to fixed automake
  see http://bugzilla.redhat.com/542609 for details
(3), make -C tests valgrind
2), test
~/log/novell/hypervisor_and_tools/libvirt/managedsave 
# ./loop_test.sh /etc/xen/vm/sles11_hvm_10_vm5.xml
3, study the Makefile.am and libvirt.spec.in
1), create directory during installation
(1), Makefile.am
install-data-local:
+if WITH_XEN
+	$(MKDIR_P) "$(DESTDIR)$(localstatedir)/lib/libvirt/xen"
+endif
(2), target call procedure
((1)), in top Makefile
$(RECURSIVE_TARGETS) -> make xxx-am
((2)), in src/Makefile
make dir: install-am -> install-data-am -> install-data-local
rm dir: uninstall-am -> uninstall-local
notes: using "make --debug=j" can prove that the calling from install-am to install-data-local, but "install-data-am" is not displayed.
2), libvirt.spec.in
@@ -1719,6 +1719,9 @@ rm -f $RPM_BUILD_ROOT%{_sysconfdir}/sysctl.d/libvirtd
 %ghost %dir %{_localstatedir}/run/libvirt/libxl/
 %dir %attr(0700, root, root) %{_localstatedir}/lib/libvirt/libxl/
 %endif
+%if %{with_xen}
+%dir %attr(0700, root, root) %{_localstatedir}/lib/libvirt/xen/
+%endif
 %if %{with_network}
 %ghost %dir %{_localstatedir}/run/libvirt/network/
 %dir %attr(0700, root, root) %{_localstatedir}/lib/libvirt/network/
4, write comment. 
1), comments unchanged
implement managedsave in libvirt xen legacy driver

Implement the domainManagedSave, domainHasManagedSaveImage, and
domainManagedSaveRemove functions in the libvirt legacy xen driver.

domainHasManagedSaveImage check the managedsave image from filesystem
everytime. This is different from qemu and libxl driver. In qemu or
libxl driver, there is a hasManagesSave flags in virDomainObjPtr which
is not used in xen legacy driver. This flag could not add into xen
driver ptr either, because the driver ptr will be release at the end of
every libvirt api calls. Meanwhile, AFAIK, xen store all the flags in
xen not in libvirt xen driver. There is no need to add this flags in xen.
2), comment after "---"
Changes since v1:
(1), add save dir in libvirt.spec.in and src/Makefile.am 
(2), misc changes for return value and memory leak.

5, send patch
git format-patch --signoff --subject-prefix="PATCH V2" f5f80cec9e43442d12a445db14e6c01c026d946a
git send-email --no-chain-reply-to --annotate --to bjzhang@suse.com  0001-implement-managedsave-in-libvirt-xen-legacy-driver.patch

6, (12:14 2012-12-05)
managedsave test result: 100times loop successful.
log/novell/hypervisor_and_tools/libvirt/managedsave/loop_test.sh

7, upstream patch: still memory leak. 
改还是没改干净. 结果还是Jim自己改了...
Jim_email_20121205
Bamvor Jian Zhang wrote:
> Implement the domainManagedSave, domainHasManagedSaveImage, and
> domainManagedSaveRemove functions in the libvirt legacy xen driver.
>
> domainHasManagedSaveImage check the managedsave image from filesystem
> everytime. This is different from qemu and libxl driver. In qemu or
> libxl driver, there is a hasManagesSave flags in virDomainObjPtr which
> is not used in xen legacy driver. This flag could not add into xen
> driver ptr either, because the driver ptr will be release at the end of
> every libvirt api calls. Meanwhile, AFAIK, xen store all the flags in
> xen not in libvirt xen driver. There is no need to add this flags in xen.
>
> Signed-off-by: Bamvor Jian Zhang <bjzhang@suse.com>
>   
[...]
> @@ -1505,15 +1591,32 @@ xenUnifiedDomainCreateWithFlags(virDomainPtr dom, unsigned int flags)
>  {
>      GET_PRIVATE(dom->conn);
>      int i;
> +    int ret = -1;
> +    char *name = NULL;
>  
>      virCheckFlags(0, -1);
>  
> +    name = xenUnifiedDomainManagedSavePath(priv, dom);
> +    if (!name)
> +        goto cleanup;
> +
> +    if (virFileExists(name)) {
> +        if (priv->opened[XEN_UNIFIED_XEND_OFFSET]) {
> +            ret = xenDaemonDomainRestore(dom->conn, name);
> +            if (ret == 0)
> +                unlink(name);
> +        }
> +        goto cleanup;
> +    }
> +
>      for (i = 0; i < XEN_UNIFIED_NR_DRIVERS; ++i)
>          if (priv->opened[i] && drivers[i]->xenDomainCreate &&
>              drivers[i]->xenDomainCreate(dom) == 0)
>              return 0;
>   

Still a memory leak here.  I've squashed in the below patch and pushed
the result.  Thanks Bamvor.

Regards,
Jim

diff --git a/src/xen/xen_driver.c b/src/xen/xen_driver.c
index 8b44f17..3786176 100644
--- a/src/xen/xen_driver.c
+++ b/src/xen/xen_driver.c
@@ -1611,10 +1611,13 @@ xenUnifiedDomainCreateWithFlags(virDomainPtr
dom, unsigned int flags)
         goto cleanup;
     }
 
-    for (i = 0; i < XEN_UNIFIED_NR_DRIVERS; ++i)
+    for (i = 0; i < XEN_UNIFIED_NR_DRIVERS; ++i) {
         if (priv->opened[i] && drivers[i]->xenDomainCreate &&
-            drivers[i]->xenDomainCreate(dom) == 0)
-            return 0;
+            drivers[i]->xenDomainCreate(dom) == 0) {
+            ret = 0;
+            goto cleanup;
+        }
+    }
 
 cleanup:
     VIR_FREE(name);

8, message send on bugzilla by Jim
https://bugzilla.novell.com/show_bug.cgi?id=782311
https://bugzilla.novell.com/show_bug.cgi?id=782311#c8

James Fehlig <jfehlig@suse.com> changed:

           What    |Removed                     |Added
----------------------------------------------------------------------------
             Status|ASSIGNED                    |NEEDINFO
       InfoProvider|                            |tbeitter@novell.com

--- Comment #8 from James Fehlig <jfehlig@suse.com> 2012-12-04 18:08:36 UTC ---
Ok, patch finally committed upstream

http://libvirt.org/git/?p=libvirt.git;a=commit;h=501bfad194140fe385704a01aa6c6125c6aba9dc

And a followup patch to fix a memory leak not noticed during review

http://libvirt.org/git/?p=libvirt.git;a=commit;h=cab0cfd5cfa9c2d2dfa9e04d586211f4db61ae32

I've backported and queued these patches for our next SP2 maintenance cycle,
although not quite sure when that will be.

Tilman, can you try the libvirt package from Devel:Virt:SLE-11-SP2?

http://download.suse.de/ibs/Devel:/Virt:/SLE-11-SP2/SUSE_SLE-11-SP2_Update_Test_standard/

13:50 2012-12-04
arm, server, fedora; qemu
1, fedora
https://fedoraproject.org/wiki/Architectures/ARM
includes support for Beagleboard-xM, Dreamplug, Guruplug, Highbank, iMX, Pandaboard, Sheevaplug, Trimslice, Versatile Express and more! 
Bamvor: fedora support arm Versatile Express(QEMU) is useful for developers. 
2, marvell arm based arm server. from 99$. support gigabit ethernet and wlan. 
http://fedoraproject.org/wiki/Architectures/ARM/Kirkwood
http://www.globalscaletechnologies.com/default.aspx
3, Trimslice
http://fedoraproject.org/wiki/Architectures/ARM/Trimslice
    1 GHz NVIDA Tegra 2 (dual-core ARM Cortex A9)
    1 GB DDR2-667 RAM
    HDMI 1.3 max resolution 1920 x 1080
    Gigabit Ethernet (Realtek RTL8111DL)
    802.11 b/g/n WiFi 

16:30 2012-12-04
virtualization, kvm, xen, xen on kvm, cont1, try to compile kernel
1, branch kernel
bamvor@linux-bjrd:suse> osc bco SUSE:SLE-11-SP2:Update kernel-default

Note: The branch has been created of a different project,
              SUSE:SLE-11-SP2:Update,
      which is the primary location of where development for
      that package takes place.
      That's also where you would normally make changes against.
      A direct branch of the specified package can be forced
      with the --nodevelproject option.
Bamvor: only got kernel-source package. seems all the kernel package in this package. 
2, quilt setup kernel-default.spec
The %prep section of kernel-default.spec failed; results may be incomplete
The -v option will show rpm's output
3, (16:28 2012-12-05)
suse kernel is not support it. 
maybe the only i could do is try opensuse.

13:57 2012-12-05
virtualization, libvirt, qemu, kvm, virtio hotplug
https://bugzilla.novell.com/show_bug.cgi?id=790928
1, report
Stephan Barth 2012-11-22 15:25:46 UTC

Created an attachment (id=514216) [details]
supportconfig from my lab machine

If a second disk is added to a KVM guest with

virsh attach-disk sles11-1 /var/lib/libvirt/images/sles11-1.img vdb

and then it is mounted on the guest and a single read operation like with

ll /mnt

is done, which is successful and after that the disk is removed with

virsh detach-disk sles11-1 vdb

the guest does not detect this. There is no event in dmesg or
/var/log/messages. Additionally if you run

fdisk -l

the command hangs when it tries to detect the second disk.
2, explain by developer
Bruce Rogers 2012-12-04 20:56:04 UTC

The hot-unplug support is at the pci device level. There is no automatic
notification to the block layer when the virtio pci-device is being removed, so
you do need to have the block device unused when the device is removed (eg
umount <device-file>).

So we do support hot-unplug of the virtio block pci device, but not in the same
way that you have come to expect for scsi, for example. The virtio protocol
does not include mechanisms for handling hotplug at that level, just at the pci
level.

We probably need to document this better.

13:58 2012-12-05
GTD
0, 12:00

1, today
1), 13:59-14:20 17:12- libxl event: work on Ian Jackson comments. see"17:51 2012-11-30"

10:10 2012-12-06
company, colleague, Joey Zheng, farewell
1, "Olaf Kirch <okir@suse.com>"_email_"[devel-server] Joey Zheng is about to leave us"_20121205_1906
Hi all,

Joey Zheng, leader of the Beijing Desktop team, is going to leave SUSE after
a long and very succesful carreer with us. He will move to his home town to
take care of his family. His last working day will be Friday this week.

We have not selected a successor for Joey yet. In the interim, David
Liang has agreed to step in as temporary supervisor for the team.
Please support David in this role.

Most of all, please join me in thanking Joey for his great contributions
to SUSE, and wishing him good luck for his personal and professional future.

Sincerely,
Olaf
-- 
Neo didn't bring down the Matrix. SOA did. (soafacts.com)
--------------------------------------------
Olaf Kirch - Director SUSE Linux Enterprise; R&D (okir@suse.com)
SUSE LINUX Products GmbH, Maxfeldstr. 5, 90409 Nürnberg, Germany
GF: Jeff Hawn, Jennifer Guild, Felix Imendörffer, HRB 16746 (AG Nürnberg) 

2, Joey
Hi Olaf,

Thanks a lot for your great support these years. :)

Best Regards,
Joey Zheng

3, "Stefan Behlert <behlert@suse.com>"_email_20121205_2344
Joey,

I wish you all the best for your future!

It was a sad day when I heard about you leaving, as it was always fun to
work with you. We have been working together now for quite a while, and I
can just say that I hope we will be working to gether sometime in the
future!

Again, a big THANK YOU from me for the years of co-operation and everything
you did for the products, the department, and the people of SUSE!

All the best to you and your family.

        ciao,
          Stefan

10:56 2012-12-06
company, colleague, openSUSE Team member, Alberto Planas, report to Agustin Benito Bethencourt 
"Agustin Benito Bethencourt <abebe@suse.com>"_"[devel] Please welcome Alberto Planas - new openSUSE Team member"_email_20121205_1838
Dear colleagues,

It's my pleasure to announce a new team member.

Alberto Planas Dominguez joined this Monday the openSUSE Team at SUSE. He will 
be located in Nuremebrg between 18 and 24 months before moving back to his 
country, to work for SUSE remotely.

Alberto has a wide experience working in different R&D projects and companies 
as researcher, developer or manager. During his 15 year carrer he has worked 
with many different technologies and frameworks (from Assembler to Ruby, from 
JBoss to Django...) in different sectors (Biotechnology, financial) in a 
variety of areas (analysis, tools development, monitoring, modelling...). He 
is also a reputed technical writer with articles published in different IT 
media. 

Please join me in giving him a warm welcome and support him in getting used to
SUSE, across all teams.

By the way, Alberto is very interested in the local culture, history, 
economy....as far as it do not goes through a fermentation process.

Next time I will add this as requirement in the opening description. :-) 
Alberto....stand strong! I couldn't.

Saludos
-- 
Agustin Benito Bethencourt
openSUSE Team Lead at SUSE
abebe@suse.com

11:00 2012-12-06
GTD
0, 9:40-13:18 15:00-18:06

1, today
1), 11:01-13:17 libxl event: work on Ian Jackson comments. see"17:51 2012-11-30"
1.5h discuss with Jim about it. see"log/novell/im/NM20121206_Jim_Fehlig__discuss_about_libxl_event_bug.txt".
2), 15:00-15:43 read some code in xen arm. see"15:00 2012-12-06"
nap 20'

2, daily work
1), tracking xen-arm update. 
2), read libvirt and xen-devel quickly, should less that 30minutes. 

3, next
1), libxl event: work on Ian Jackson comments. see"17:51 2012-11-30"
1), talk with Jim. do I need send console patch to upstream? 
1), reply upstream Ian Jackson comments.
2), review and test Jim xen4.2 patch. see"16:12 2012-11-26"
3), CANCEL? search and answer the question from Ian C, maybe i should create a new thread?. ref"10:31 2012-11-25"
4), 对于vi不能方便查找keywords这个事情, 实在不能忍了, 如果这周能把managed save和bridge-utils bug fix, 就把这个做一个. 

3, next week
1), got arm technical symposia pdf. 
2), read kernel doc: "10:36 2012-11-23"
1), read code for patch. see"10:25 2012-11-23"2-2)-(2). 
2), after "1)" finish. try xen on kvm. 
3), read the mail on "Andrew Wafaa <awafaa@opensuse.org>"_email_"[opensuse-arm] Fwd: [fedora-arm] ARMv8 Bootstrap Project"_20121122
3), work on xen on ARM. ref"22:33 2012-11-19"
4), check the error from "10:18 2012-11-15"2
2012-11-15 04:02:45.318+0000: 4307: error : virNodeGetSecurityModel:9567 : this function is not supported by the connection driver: virNodeGetSecurityModel
5), ask jim to invite me to xen irc. 

3, next next
1), gsoc: "22:23 2012-11-17"
1), notes about Huawei from eet-china.
2), read bug:https://bugzilla.novell.com/show_bug.cgi?id=781425 

2, next
1), try to improve attach-disk, detach-disk in libxl driver, see"18:17 2012-11-07"4
2), test attach-disk command. see"10:41 2012-10-30"2
3), maybe libxl and qemu could communicate with qemu through xenstore?

libxl_dm.c: 
        /* Find uuid and the write the vnc password to xenstore for qemu. */
        t = xs_transaction_start(ctx->xsh);
        vm_path = libxl__xs_read(&gc,t,libxl__sprintf(&gc, "%s/vm", p->dom_path));
        if (vm_path) {
            /* Now write the vncpassword into it. */
            pass_stuff = libxl__calloc(&gc, 3, sizeof(char *));
            pass_stuff[0] = "vncpasswd";
            pass_stuff[1] = info->vncpasswd;
            libxl__xs_writev(&gc,t,vm_path,pass_stuff);

3, for Jim
1), xenlight event lock in libvirt. see"16:52 2012-11-06"2-1). 

4, next month
1), opensuse on MK802
(1), generate the 512MB version with opensuse12.2 RC2 which enable yast fist run. 
(2), try opensuse based on ubuntu kernel in order to solve the error from miniand. 
2), try armv8 emulator and read armv8 kernel code.  

11:43 2012-12-06
software, skill, SCM: hg, extension, graph log, glog
http://mercurial.selenic.com/wiki/GraphlogExtension
Enable this extension by adding the following lines to your configuration file (hgrc):

[extensions]
graphlog = 

15:00 2012-12-06
virtualization, xen, arm, read xen code; clone linux-xen
1, head.S
init_uart: specific to the PL011 UART.
all the uart code include start_xen is pl011 specific.
2, enter into C code. start_xen
3, prepare and finally boot domain 0
1), construct_dom0
r2 could be atags or dtd pointer. 
/* FROM LINUX head.S

 * Kernel startup entry point.
 * ---------------------------
 *
 * This is normally called from the decompressor code.  The requirements
 * are: MMU = off, D-cache = off, I-cache = dont care, r0 = 0,
 * r1 = machine nr, r2 = atags or dtb pointer.
 *...
 */
2), init_idle_domain -> scheduler_init. calling domain_create() for what? 
2), domain_unpause_by_systemcontroller -> vcpu_wake: call scheduler to wake cpu. scheduler are: arinc653, credit, credit2, sedf. credit should be the default for vm. for credit, it will call csched_vcpu_wake.
4, 
5, others
1), clone xen linux dom0 kernel. for future. 
git clone git://xenbits.xen.org/people/ianc/linux.git
according to http://wiki.xen.org/wiki/Xen_ARMv7_with_Virtualization_Extensions
Linux kernel for dom0
The patches necessary to boot Linux as dom0 under Xen were merged upstream in v3.7. However in order to actually start guests a few additional patches are required. These patches can be found in the arm-privcmd-for-3.8 branch of git://xenbits.xen.org/people/ianc/linux.git 

