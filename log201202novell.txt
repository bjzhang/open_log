
10:11 2012-02-01
时间管理
0, 9:50-22:40

1, today
1), 20' ebook, 李洱, 《花腔》.
2), 10:12-10:47 xen/libvirt maillist. see"10:12 2012-02-01".
3), 10:48-10:59 read "SUSE Linux Customer Reference". see"10:50 2012-02-01".
4), 11:40-12:08 read xen source code. see"11:08 2012-02-01".
5), 11:23-11:40 python logging system. see"11:23 2012-02-01".
6), 12:10-13:31 吃饭
7), 花腔和xen的共同点就是, 大家说很美, 我自己却看不出哪里美. 
8), 下午出了装了三次虚拟机, 没干什么事情. 晚上好好看代码. 
9), 18:11- 吃饭. 
10), 虚拟机实验. see"16:40 2012-02-01".

10:12 2012-02-01
virtualization, suse, xen, maillist, xen-devel; libvirt
1, xen
from: http://lists.xen.org/archives/html/xen-devel/
1), 这几天经常看到PVOPS, 查一查. 
http://wiki.xen.org/wiki/XenParavirtOps
Linux 3.0 (and later) can run as guest (domU) and as host (dom0). All necessary backends (and frontends) are in the upstream kernel.
pvops domU support in the standard Linux kernel has started with 2.6.24 and anything newer than 2.6.32.10 should be fairly complete and stable for most use cases. pvops dom0 support is included in the upstream (2.6.37 and higher) Linux kernel. 
如何配置PVHVM drivers(also called PV-on-HVM drivers), http://wiki.xen.org/wiki/Xen_Linux_PV_on_HVM_drivers. 提高storage和network性能.
2), 关注xen MIPS port
http://lists.xen.org/archives/html/xen-devel/2012-01/msg02723.html

2, libvirt
https://www.redhat.com/archives/libvir-list/
https://www.redhat.com/archives/libvirt-users/
1), serach apparmor
2), ANNOUNCE: virt-manager 0.9.1 and virtinst 0.600.1 released
https://www.redhat.com/archives/libvir-list/2012-February/msg00007.html
virt-manager 0.9.1: virt-manager is a desktop application for managing
KVM and Xen virtual machines via libvirt.
virtinst 0.600.1: virtinst is a collection of command line tools for
provisioning libvirt virtual machines, including virt-install and
virt-clone.
3), 关于libvirt有个问题: xen PV libvirt也会支持么? 
虽然说libvirt只是做虚拟机的管理(也就是代替xen的libxc和python等工具), 这些工具似乎不关心是HVM or PV.

10:50 2012-02-01
suse, document, SUSE Linux Customer Reference; company, 同事信息
1, Alan Gao mail
Senior Marketing Manager, Asia
agao@novell.com
(86-10) 6533-9051
report to Renata Nelipa
Alan's team member: 	
1), Jia Liu
Vendor Worker
Contingent Worker
JLiu1@novell.com
2), Xue Wang
Marketing Assistant
Contingent Worker
XWang@novell.com

2, 文档位置: /home/novell/work/documents/customer/Novell SLES大客户成功案例.pptx
3, 基本都是从windows或UNIX迁移到sles. sles对于硬件的良好支持和上层软件的良好支持是优势.

11:08 2012-02-01
virtualization, suse, xen, source code, reading, python and libxc, cont1
1, object: 
1), 跟踪xen python很多看不懂, 学会看python的打印信息, 然后把这两天的疑点搞清楚.  
2), 回到python和lib层次, 继续看create. 这周希望把chunyan文档涉及的内容先扫一遍. 

11:23 2012-02-01
script, python, debug message; debugger
http://docs.python.org/library/logging.html
1, Basic Logging Tutorial
http://docs.python.org/howto/logging.html#logging-basic-tutorial
测试代码位置"/home/novell/work/script/python/logging_system".
1), 直接写成
novell@bjz-dev:logging_system> cat a_simple_example.py
import logging
logging.warning('Watch out!') # will print a message to the console
logging.info('I told you so') # will not print anything
设置执行权限, 执行提示:
novell@bjz-dev:logging_system> ./a_simple_example.py
./a_simple_example.py: line 1: import: command not found
./a_simple_example.py: line 3: syntax error near unexpected token `('
./a_simple_example.py: line 3: `def main():'
用python执行没错:
novell@bjz-dev:logging_system> python a_simple_example.py
WARNING:root:Watch out!
2), 没有打印info信息的原因是默认level是WARNING. 
2, (15:11 2012-12-07)
debugger
python -m pdb xxx.py

16:40 2012-02-01
virtualization, suse, xen, install; source code, reading, python and libxc, cont
2
1, vm-install, 在虚拟机上安装一个openSUSE12.1, HVM. 打算再尝试一下里面运行chrome的感觉. 
username: op12-1
passwd: novell
2, 安装后, 启动没法启动. 重新安装试试. 
重新安装仍然不行. 先安装在/dev/sda10, 使用file虚拟硬盘试试. 
3, 
username, passwd: opensuse12-1
4, (20:25 2012-02-01)
运行"vm-install --debug 2>&1 | tee logxxx.txt ", 就能看到参数该怎么配置
DEBUG    start recalculation
DEBUG    Setting options[connect] = <vminstall.xen_hypervisor.Xend instance at 0x1737cf8>
DEBUG    Setting options[use_libvirt] = False
DEBUG    Setting options[os_type] = opensuse
DEBUG    PXE boot specified
DEBUG    Setting options[pxe_boot] = True
DEBUG    Setting options[full_virt] = True
DEBUG    Setting options[install] = True
DEBUG    Setting options[upgrade_managed_vm] = False
DEBUG    Setting options[non_pae] = True
DEBUG    Setting options[no_install] = False
DEBUG    Setting options[preserve_on_error] = False
DEBUG    Setting options[memoryMB] = 1024
DEBUG    Setting options[max_memoryMB] = 1024
DEBUG    Setting options[vcpus] = 2
DEBUG    Setting options[cpuid] = []
DEBUG    Setting options[cpu_check] = []
DEBUG    Setting options[loader] = /usr/lib/xen/boot/hvmloader
DEBUG    Setting options[uuid] = d6b4160c-d8ff-f435-91ad-db01cb890d31
DEBUG    Setting options[on_crash] = destroy
DEBUG    Setting options[on_poweroff] = destroy
DEBUG    Setting options[on_reboot] = restart
DEBUG    Setting options[keymap] = en-us
DEBUG    Setting options[graphics_viewer] = virt-viewer
DEBUG    Setting options[graphics] = vesa
DEBUG    Setting options[disks] = [file:/var/lib/xen/images_2/opensuse12-1/disk0.raw,0,disk,w,8192.0,]
DEBUG    Checking for conflicts between disks: ['8.0 GB Hard Disk (file:/var/lib/xen/images_2/opensuse12-1/disk0.raw)']
DEBUG    Setting options[nics] = [,br0,rtl8139,1]
DEBUG    Setting options[extra_args] =
DEBUG    Setting options[source] = None
DEBUG    possible FV boot disks: []
DEBUG    Setting options[os_settings] =
DEBUG    Setting options[vncport] = None
DEBUG    Setting options[norestart] = None
DEBUG    Setting options[debug] = True
DEBUG    Setting options[ui] = None
DEBUG    Setting options[background] = None
DEBUG    Setting options[noautoconsole] = None
DEBUG    Setting options[_install_args] =
DEBUG    Setting options[_runtime_args] =
DEBUG    Setting options[config_dir] = /etc/xen/vm/
DEBUG    Setting options[apic] = False
DEBUG    Setting options[acpi] = None
DEBUG    Setting options[usb] = False
DEBUG    Setting options[pae] = None
DEBUG    Setting options[blkif] = None
DEBUG    Setting options[extid] = None
DEBUG    Setting options[hap] = None
DEBUG    Setting options[hpet] = None
DEBUG    Setting options[hpet] = False
DEBUG    Setting options[isa] = None
DEBUG    Setting options[localtime] = None
DEBUG    Setting options[memory_sharing] = None
DEBUG    Setting options[monitor] = None
DEBUG    Setting options[netif] = None
DEBUG    Setting options[nomigrate] = None
DEBUG    Setting options[oos] = None
DEBUG    Setting options[opengl] = None
DEBUG    Setting options[pci_msitranslate] = None
DEBUG    Setting options[pci_power_mgmt] = None
DEBUG    Setting options[sdl] = None
DEBUG    Setting options[superpages] = None
DEBUG    Setting options[suppress_spurious_page_faults] = None
DEBUG    Setting options[timer_mode] = None
DEBUG    Setting options[tpmif] = None
DEBUG    Setting options[viridian] = None
DEBUG    Setting options[vnc] = None
DEBUG    Setting options[vpt_align] = None
DEBUG    Setting options[xen_platform_pci] = None
DEBUG    end recalculation

安装后还是不行. 这个事情暂时放一放, 先看看能不能用命令行安装.

5, vm-install or xm 
1), check last log saved for vm-install, we can see that
INFO     Writing runtime configuration file...
so, i search the vm-install source code in "/home/novell/work/source/xen/suse_svn/branches/SLE11-SP1-Branch/vm-install/src/vminstall", find "job.py". 
log.info("Writing runtime configuration file...")
if self._options.install != OS_INSTALL_UPGRADE:
    self._write_conf()
2), can pdb debug for it?
bjz-dev:/home/novell/work/log/vm-install # python -m pdb /usr/bin/vm-install --d
ebug 
fail. 
直接加入打印信息试试. 
所以临时的配置文件是: 
INFO     Writing install-time configuration file...
DEBUG    bamvor test: /etc/xen/vm/sles11-1.xml
这个boot device是cdrom, 但是我设置的是pxe阿, 想不通, 先试试.
<type>hvm</type>
<loader>/usr/lib/xen/boot/hvmloader</loader>
<boot dev='cdrom'/>
结果我再去看看opensuse12-2这个配置文件, 发现里面也是这么写的. 
照葫芦画瓢建立一个opensuse12-3, copy opensuse12-2的硬盘和配置文件. 
3), 还真可以启动. HVM的基本配置脚本看来这样没有问题. 
bjz-dev:/etc/xen/vm # cat opensuse12-3
name="opensuse12-3"
description="None"
memory=1024
maxmem=1024
vcpus=2
on_poweroff="destroy"
on_reboot="destroy"
on_crash="destroy"
localtime=0
keymap="en-us"

builder="hvm"
device_model="/usr/lib/xen/bin/qemu-dm"
kernel="/usr/lib/xen/boot/hvmloader"
boot="n"
disk=[ 'file:/var/lib/xen/images_2/opensuse12-3/disk0.raw,hda,w', ]
vif=[ 'mac=00:16:3e:10:a1:f6,bridge=br0,model=rtl8139', ]

stdvga=1
vnc=1
vncunused=1
extid=0
apic=0
acpi=1
pae=1

serial="pty"

6, 今天晚上还是把前两天的疑惑看一看. 
1), 之前有个问题是想知道"_configureBootloader"后返回的config是什么, 这个必须是pv才行, 如果是hvm会直接返回. 
\todo 看hvm的流程.
2), 还是用vm-install看看
DEBUG    Setting options[source] = http://147.2.207.240/repo/sles-11-sp1-x86_64
DEBUG    Setting options[_install_args] =  install=http://147.2.207.240/repo/sles-11-sp1-x86_64

DEBUG    do_progress_change: 0.41
DEBUG    do_progress_change: 0.45
DEBUG    Media roots: ['.']
DEBUG    Checking for http://147.2.207.240/repo/sles-11-sp1-x86_64/./boot/x86_64/vmlinuz-xen...
DEBUG    Copying to temporary file '/tmp/kernel.ptf2FB'
DEBUG    Copying to temporary file '/tmp/install-initrd.C0TwPy'
DEBUG    Unpacked kernel/initrd found: /./boot/x86_64/vmlinuz-xen /./boot/x86_64/initrd-xen
INFO     Writing install-time configuration file...
DEBUG    bamvor test: /etc/xen/vm/sles11-3.xml
DEBUG    do_progress_change: 0.82
从日志可以看出, 是从服务器拿到了xen和initrd. 估计是复制到虚拟硬盘上, 然后启动虚拟机. 
明天自己按这个过程做一遍. 感觉用xm输入命令启动的虚拟机更容易分析一些. 

09:56 2012-02-02
时间管理
0, 9:50

1, today
0), 30' 在家: 边吃饭边读龙应台的《这个动荡的世界》
1), JiaJu mail: Olaf plan come to Beijing. see"09:57 2012-02-02".
2), 25' 新浪微博，微博用的时间确实有点多了, 以后每天控制在1小时以内吧. 
3), 30' 支持Vimicro caijin: 讨论trace问题. 
4), 10' 11:05-11:36 11:05-11:36 15:33-18:40 xen study: source code and command. see"10:00 2012-02-02".
5), 11:36-12:27 吃饭
6), 12:32-13:09 xen/libvirt maillist. see"12:32 2012-02-02".
含read xen userguide on Centor, see"13:07 2012-02-02".
7), company notebook: ssh root@147.2.207.154. passwd: novell
8), 找xen中文书: 51cto, "Xen虚拟化技术.pdf". 
9), 13:50-14:17 xen guide by ChunYan LIU. see"13:52 2012-02-02".
10), 14:20-15:26 买宝宝东西. 
11), 10' Jiaju问我进展, 建议我看看bug.
12), 总结: 今天效率还行, 比昨天看了很多微博强了很多. 明天要去办手续, 下周继续努力.

09:57 2012-02-02
company, suse, team, Olaf
"Jia Ju Zhang"mail"Olaf plans to come to Beijing from Feb 20 to Feb 24"
Olaf预定这个月的20－24号那周来北京，届时 他可能想和每一个人都聊聊。大家在那周都按 时来办公室吧，如果没有极特殊情况，就不要 请假了：）
如果有特殊情况确实需要请假，提前告诉我，我 好安排时间。
Olaf的行程还没有最后定下来，如果有变动， 我会及时通知大家。

谢谢！
家驹

10:00 2012-02-02
virtualization, suse, xen, source code, reading, python and libxc, cont3; "2-4)-(3)"rpm解包但是不安装(rpm unpack, extract file)
1, plan
1), 用xm create建立PV虚拟机. 
2), 跟踪create流程. libxc里面的东西考虑用gdb单步. 

2, xm create
1), 建立磁盘
bjz-dev:/var/lib/xen/images_2/sles11-pv-bamvor-1 # dd if=/dev/zero of=disk0.raw bs=1024k seek=2048 count=0
用seek好像挺好的, 不会实际的copy, 感觉相当于建立一个空的硬盘. 
如果用
bjz-dev:/var/lib/xen/images_2/sles11-pv-bamvor-1 # dd if=/dev/zero of=disk0.raw bs=1024k count=2048
就会实际copy 2G数据.
2), 准备启动kernel和initrd
昨天看vm-install, 知道是从
http://147.2.207.240/repo/sles-11-sp1-x86_64/boot/x86_64/复制的initrd-xen和vminuz-xen
(1), download image
novell@bjz-dev:sles11-sp1> wget http://147.2.207.240/repo/sles-11-sp1-x86_64/boot/x86_64/vmlinuz-xen
novell@bjz-dev:sles11-sp1> wget http://147.2.207.240/repo/sles-11-sp1-x86_64/boot/x86_64/initrd-xen
(2), 顺便看看这两个image, kernel
novell@bjz-dev:sles11-sp1> cat initrd-xen | gzip -d > initrd-xen_ungzip
novell@bjz-dev:sles11-sp1> file initrd-xen_ungzip
initrd-xen_ungzip: ASCII cpio archive (SVR4 with no CRC)
novell@bjz-dev:sles11-sp1> cat ../initrd-xen_ungzip | sudo cpio -i -d -H newc --no-absolute-filenames
novell@bjz-dev:sles11-sp1> ls initrd
bin   download  installkey.gpg  linuxrc.config  mounts  sbin  usr
dev   etc       lib             mnt             proc    sys   var
devz  init      lib64           modules         root    tmp
(3), kernel 
novell@bjz-dev:sles11-sp1> gzip -d < vmlinuz-xen > vmlinux-xen
novell@bjz-dev:sles11-sp1> file vmlinuz-xen
vmlinuz-xen: gzip compressed data, from Unix, last modified: Thu May 20 18:33:32 2010, max compression
(4), (15:38 2012-02-02)
copy initrd-xen and vmlinuz-xen to /var/lib/xen/image2_2/sles11-pv-bamvor-1
3), xm config file
bjz-dev:/etc/xen/vm # cat sles11-pv-bamvor-1
name="sles11-pv-bamvor-1"
description="None"
memory=512
maxmem=512
vcpus=2
on_poweroff="destroy"
on_reboot="destroy"
on_crash="destroy"
localtime=0
keymap="en-us"
builder="linux"
kernel="/var/lib/xen/images_2/sles11-pv-bamvor-1/vmlinuz-xen"
ramdisk="/var/lib/xen/images_2/sles11-pv-bamvor-1/initrd-xen"
extra=" install=http://147.2.207.240/repo/sles-11-sp1-x86_64 "
disk=[ 'file:/var/lib/xen/images_2/sles11-pv-bamvor-1/disk0.raw,xvda,w', ]
vif=[ 'mac=00:16:3e:3f:a6:c2,bridge=br0', ]
vfb=['type=vnc,vncunused=1']
4), 但是这样不行, kernel没法正常启动, 也没有启动安装界面. 
(1), 感觉这两句话很关键:
DEBUG    Copying to temporary file '/tmp/kernel.947GVD'
DEBUG    Copying to temporary file '/tmp/install-initrd.TNpUjF'
(2), 改着改着python, 发现log变了
DEBUG    do_progress_change: 0.45
DEBUG    Media roots: ['.']
DEBUG    Checking for http://147.2.207.240/repo/sles-11-sp1-x86_64/./boot/x86_64/vmlinuz-xen...
DEBUG    Checking for http://147.2.207.240/repo/sles-11-sp1-x86_64/./boot/i586/vmlinuz-xen...
DEBUG    Checking for http://147.2.207.240/repo/sles-11-sp1-x86_64/./boot/i386/vmlinuz-xen...
DEBUG    No unpacked kernel/initrd found
DEBUG    Searching for x86_64 kernel-xen-base
DEBUG    Found kernel line: './suse/x86_64/kernel-xen-base-2.6.32.12-0.7.1.x86_64.rpm'
DEBUG    Found initrd line: './suse/x86_64/install-initrd-11.114-0.2.36.x86_64.rpm'
DEBUG    URL of kernel is /suse/x86_64/kernel-xen-base-2.6.32.12-0.7.1.x86_64.rpm
DEBUG    Copying to temporary file '/tmp/kernel.I2qJ9u', fileobj: 14
DEBUG    do_progress_change: 0.47
DEBUG    URL of initrd is /suse/x86_64/install-initrd-11.114-0.2.36.x86_64.rpm
DEBUG    Copying to temporary file '/tmp/install-initrd.PRTvI0', fileobj: 15
DEBUG    do_progress_change: 0.49
INFO     Building inst-initrd...
DEBUG    do_progress_change: 0.52
DEBUG    do_progress_change: 0.63
DEBUG    do_progress_change: 0.65
INFO     Extracting kernel from '/tmp/kernel.I2qJ9u' to '/tmp/vmlinuz-xen.EoneU9'
DEBUG    do_progress_change: 0.77
DEBUG    Saving kernel '/tmp/tmpxnknO9/boot/vmlinuz-2.6.32.12-0.7-xen' -> '/tmp/vmlinuz-xen.EoneU9'
DEBUG    do_progress_change: 0.80
DEBUG    Extracted installation kernel/initrd: /tmp/vmlinuz-xen.EoneU9 /tmp/inst-initrd.4AoRCU
INFO     Writing install-time configuration file...
DEBUG    bamvor test: /etc/xen/vm/sles11-2.xml
可以看到这次是从rpm包提取的. 试试.
suse/x86_64/kernel-xen-base-2.6.32.12-0.7.1.x86_64.rpm
suse/x86_64/install-initrd-11.114-0.2.36.x86_64.rpm
不知道怎么提取, 暂时跳过. 
(3), 仔细看看log, 
DEBUG    do_progress_change: 0.49
INFO     Building inst-initrd...
DEBUG    do_progress_change: 0.52
参考脚本, 可以用如下命令给rpm解包
novell@bjz-dev:sles11-sp1> rpm2cpio install-initrd-11.114-0.2.36.x86_64.rpm > install-initrd-11.114-0.2.36.x86_64.cpio
novell@bjz-dev:sles11-sp1> mkdir install-initrd
novell@bjz-dev:sles11-sp1> cd install-initrd/
ovell@bjz-dev:install-initrd> cpio -idum < ../install-initrd-11.114-0.2.36.x86_
64.cpio
22610 blocks
根据脚本是可以生成install-initrd_image:
novell@bjz-dev:sles11-sp1> ./install-initrd/usr/sbin/mkinstallinitrd --kernel-rpm=${PWD}/kernel-xen-base-2.6.32.12-0.7.1.x86_64.rpm --libdir=install-initrd/usr/lib/install-initrd install-initrd_image
但我实际是copy了一个kernel-xen-base-2.6.32.12-0.7.1.x86_64-base.rpm和kernel-xen-base-2.6.32.12-0.7.1.x86_64.rpm一样, 否则会提示没有前者. 240服务器的repo里面没有base这个包. log信息和之前类似. 我突然灵机一动, 打开vncviewer. 发现其实是有界面的, 正好回去看看initrd-xen, 发现启动正常!!!
(19:31 2012-04-10)
notes:
(1), must add ${PWD} before kernel rpm package, because mkinstallinitrd will extract file in other directory. 
(2), according to the mkinstallinitrd help: if u the desired initrd using the same kernel as current system and it is already installed, "--kernel-rpm" parameter could be ignored.  
the "--libdir" parameter may be similar, i guess(not test yet). 
"19:31 2012-04-10"end
5), 终于可以正常使用了. 下一步详细看看create过程. 
(1), 安装之后怎么办? 看来要修改kernel和initrd.
参考/etc/xen/examples/xmexample.domUloader
注释并加入: 
#kernel="/var/lib/xen/images_2/sles11-pv-bamvor-1/vmlinuz-xen"
#ramdisk="/var/lib/xen/images_2/sles11-pv-bamvor-1/initrd-xen"
bootloader="/usr/lib/xen/boot/domUloader.py"
bootargs="--entry=xvda2:/boot/vmlinuz-xen,/boot/initrd-xen"
这里用bootargs entry使用xvda不行. 因为安装系统时分了两个区, 一个是swap, 一个是ext. 
这个可以用file查看:
# file /var/lib/xen/images_2/sles11-pv-bamvor-1/disk0.raw
/var/lib/xen/images_2/sles11-pv-bamvor-1/disk0.raw: x86 boot sector; partition 1: ID=0x82, starthead 1, startsector 63, 594342 sectors; partition 2: ID=0x83, active, starthead 0, startsector 594405, 3598560 sectors
修改后, 系统继续安装. 
autoyast: /root/autoinst.xml

用户名: sles11-pv-bavmor-1, 密码; sles11-pv-bamvor-1(root同).

3, xen命令
xm log: Print Xend log
\todo 这个看起来很有用, 对于我看xend, xm的代码.

12:32 2012-02-02
virtualization, suse, xen, maillist, xen-devel; libvirt
1, xen
1), libxl: save/restore qemu's physmap
http://lists.xen.org/archives/html/xen-devel/2012-02/msg00093.html
Read Qemu's physmap from xenstore and save it using toolstack_save.
Restore Qemu's physmap using toolstack_restore.
\todo search toolstack_save, toolstack_store

2, libvirt user
1), enable libvirt xen's support in Centos.
https://www.redhat.com/archives/libvirt-users/2012-February/msg00000.html
\todo 这个是libvirt和xen都有关系, 关注.
介绍xen使用的文章, 不错: http://www.howtoforge.com/virtualization-with-xen-on-centos-6.2-x86_64-paravirtualization-and-hardware-virtualization. 
see"13:07 2012-02-02"

13:07 2012-02-02
virtualization, suse, xen, Redhat, Centos, xen userguide on Centos
1, 介绍xen使用的文章, 不错: http://www.howtoforge.com/virtualization-with-xen-on-centos-6.2-x86_64-paravirtualization-and-hardware-virtualization. 
see"13:07 2012-02-02"
1), python-virtinst (which contains the virt-install tool)
2), \todo search LVM.
This chapter explains how you can set up LVM-based virtual machines instead of virtual machines that use disk images. Virtual machines that use disk images are very slow and heavy on disk IO.
3), 上次ChunYan提到的应该是virt-manager, 我这边不能启动阿.
bjz-dev:/var/lib/xen/images_2/sles11-pv-bamvor-1 # virt-manager --debug
2012-02-02 13:01:09,278 (virt-manager:161): Application startup
2012-02-02 13:01:09,360 (keyring:31): No support for gnome-keyring
2012-02-02 13:01:09,361 (virt-manager:420): Failed to contact configuration server; some possible causes are that you need to enable TCP/IP networking for ORBit, or you have stale NFS locks due to a system crash. See http://projects.gnome.org/gconf/ for information. (Details -  1: Failed to get connection to session: Did not receive a reply. Possible causes include: the remote application did not send a reply, the message bus security policy blocked the reply, the reply timeout expired, or the network connection was broken.)
Traceback (most recent call last):
File "/usr/share/virt-manager/virt-manager.py", line 414, in <module>
main()
File "/usr/share/virt-manager/virt-manager.py", line 331, in main
icon_dir, data_dir)
File "/usr/share/virt-manager/virtManager/config.py", line 89, in __init__
gconf.CLIENT_PRELOAD_NONE)
GError: Failed to contact configuration server; some possible causes are that you need to enable TCP/IP networking for ORBit, or you have stale NFS locks due to a system crash. See http://projects.gnome.org/gconf/ for information. (Details -  1: Failed to get connection to session: Did not receive a reply. Possible causes include: the remote application did not send a reply, the message bus security policy blocked the reply, the reply timeout expired, or the network connection was broken.)
Loading socket Config module ...
Creating backend ...
Loading x11 FrontEnd module ...
Failed to load x11 FrontEnd module.
2012-02-02 13:01:09,731 (error:86): Uncaught Error: Error starting Virtual Machine Manager: Failed to contact configuration server; some possible causes are that you need to enable TCP/IP networking for ORBit, or you have stale NFS locks due to a system crash. See http://projects.gnome.org/gconf/ for information. (Details -  1: Failed to get connection to session: Did not receive a reply. Possible causes include: the remote application did not send a reply, the message bus security policy blocked the reply, the reply timeout expired, or the network connection was broken.) : Traceback (most recent call last):
File "/usr/share/virt-manager/virt-manager.py", line 414, in <module>
main()
File "/usr/share/virt-manager/virt-manager.py", line 331, in main
icon_dir, data_dir)
File "/usr/share/virt-manager/virtManager/config.py", line 89, in __init__
gconf.CLIENT_PRELOAD_NONE)
GError: Failed to contact configuration server; some possible causes are that you need to enable TCP/IP networking for ORBit, or you have stale NFS locks due to a system crash. See http://projects.gnome.org/gconf/ for information. (Details -  1: Failed to get connection to session: Did not receive a reply. Possible causes include: the remote application did not send a reply, the message bus security policy blocked the reply, the reply timeout expired, or the network connection was broken.)
4), virsh
Xen guests can be managed through virsh, the "virtual shell"(the virtualization interactive terminal).

13:52 2012-02-02
virtualization, suse, xen, source code exploring; by ChunYan LIU, cont1
1, So after you have a grasp with create/start/destroy, you can experiment and have a look at the save/restore/migrate
2, storage优先级不高. 可以稍后了解. 
3, network pv driver is important. 
many costomer use hvm (with pv driver)

14:21 2012-02-02
virtualization, suse, xen, reading book, Xen虚拟化技术
1, processor virtualization and I/O virtualizaiton. \todo search.
3, Linux vServer. 操作系统级虚拟化. 支持arm. 
2, shadow page. 

18:28 2012-02-02
virtualzation, xen, book, \todo
Running Xen A Hands-On Guide to the Art of Virtualization
The Definitive Guide To The Xen Hypervisor 

09:02 2012-02-03
company, virtualization, suse, xen, regular meeting: US / China Virtualization Sync, meeting
1, bamvor, 准备
1), use xen.
2), read xen source code. 
(1), next create start destroy 
3), next
(1), xen bugzilla

2, jim sp2
kvm
qed: 虚拟机磁盘格式. 

3, Bo Yang
Bruce mail to Bo Yang. 

4, ChunYan
1), live migrate?
do not support sles(?) migrate?
xl
2), deamon. 
qemu driver
migration prepare, create socket

09:22 2012-02-03
时间管理
0, 9:00

1, today
1), US / China Virtualization Sync meeting. see"09:02 2012-02-03".
2), 办理调档手续，未完。

17:18 2012-02-06
时间管理
0, 9:10

1, today
1), 开干部转正定级表.
2), xen study: xen create for HVM. see"17:20 2012-02-06".

17:20 2012-02-06
virtualzation, suse, xen, create command, HVM
1, 尝试在sles11下安装windows7. 看看xen的config文件怎么写. 
试试在LVM下安装. 
2, windows7 xen config file:
bjz-dev:/etc/xen/vm # cat windows7_64_1
name="windows7_64_1"
description="None"
uuid="c48743ae-994c-e521-ccb8-b07286abd9c8"
memory=1024
maxmem=1024
vcpus=2
on_poweroff="destroy"
on_reboot="restart"
on_crash="destroy"
localtime=1
keymap="en-us"

builder="hvm"
device_model="/usr/lib/xen/bin/qemu-dm"
kernel="/usr/lib/xen/boot/hvmloader"
boot="d"
disk=[ 'file:/var/lib/xen/images_2/windows7_64_1/disk0.raw,hda,w', 'file:/home/novell/.mldonkey/incoming/files/cn_windows_7_ultimate_with_sp1_x64_dvd_618537.iso,hdc:cdrom,r', ]
vif=[ 'mac=00:16:3e:1b:97:bb,bridge=br0,model=rtl8139', ]


stdvga=1
vnc=1
vncunused=1
extid=0
usb=1
acpi=1
pae=1

usbdevice='tablet'

serial="pty"

3, 值得注意的:
1), builder="hvm", builder="linux"表示pv.
2), kernel="/usr/lib/xen/boot/hvmloader". \todo 看hvmloader
3), disk=[ 'file:/var/lib/xen/images_2/windows7_64_1/disk0.raw,hda,w', 'file:/home/novell/.mldonkey/incoming/files/cn_windows_7_ultimate_with_sp1_x64_dvd_618537.iso,hdc:cdrom,r', ]
把iso文件映射到cdrom的写法. windows7安装完成后, 就没必要写了. 
4), 另外windows7安装占用了8.5G.

18:36 2012-02-06
work report
1, devel-server@suse.de
Subject: 	[devel-server] Work report - week 06
[GREEN]
1), start to study xen command for xend/xm and so on.
2), start to study xen source code. currently focus on python tools and libxc code for xm create sequence.

09:38 2012-02-07
时间管理
0, 9:15

1, today
1), read programmer magzine 201202.  
2), xen command. see"10:38 2012-02-07".
3), 16:00-19:37 21:01-22:16 Jim希望我尝试解决libvirt和libxl编译问题. see"14:36 2012-02-07".
其中休息60'
4), subscribe maillist suggest by Jim. see"15:35 2012-02-07".

10:38 2012-02-07
virtualzation, suse, xen, command; source code, reading, python and libxc, cont4
1, xm command: xm config
1), boot表示启动设备. a,b软盘, c是硬盘. d是光驱. 

14:36 2012-02-07
virtualization, suse, xen, libvirt build error with upstream xen-unstable
upstream libvirt和libxl编译出错, 原因是libxl升级造成的. Jim希望我看看. 
1, Jim Fehlig <jfehlig@suse.com> mail to devel-server@suse.de
CC: CYLiu@suse.com
Chun Yan Liu wrote:
>
> [Green]
>
> - upstream work: continue working on migration APIs for libvirt
> xenlight driver.
>
>    - finish a graph implementation
>
>    - testing and debugging:
>
>    # upstream xen-unstable has changed some libxl header files and
> definitions of some functions and structures, which causes upstream
> libvirt cannot build successfully based on upstream xen-unstable
>

Yeah, the upstream folks have problems maintaining a backward-compatible
API :-(.  Hopefully the latest restructure of libxl will change that.
We'll need to add support in the libvirt libxl driver for current
upstream libxl, taking care not to break the driver when it is used with
libxl in Xen 4.1.x.  Perhaps this is something Bamvor can begin
investigating.

Regards,
Jim

2, "Chun Yan Liu"mail to "Bamvor"
When you have time (say you are tired to read xen source code), you can investigate and try to do some work to make upstream libvirt compiling with upstream xen-unstable. That might be more interesting then reading code :)
Currently, there are many errors and warnings caused by the fact that upstream xen-unstable
changed some libxl header files and some definitions of functions/structures.
You can get upstream xen-unstable by:
hg clone http://xenbits.xensource.com/xen-unstable.hg
Enter directory, try: make tools; make install-tools
Then there will be libxl libraries installed in your system. Then you can build libvirt based on that.
Get upstream libvirt by:
git clone git://libvirt.org/libvirt.git

14:59 2012-02-07
company, work, subscibe, mailing list, how to subscribe mailing list
1, 当时Jim建议我订阅:
For starters, you should subscribe to the following mailing lists

virtualization-dev@lists.novell.com
virtualization-xen@lists.novell.com
devel-server@suse.de
opensuse-virtual@opensuse.org

And consider these lists as well, depending on your area of focus

devel@suse.de
research@suse.de
kernel@suse.de
kvm@suse.de
opensuse-factory@opensuse.org
xen-devel@lists.xensource.com
qemu-devel@nongnu.org
libvir-list@redhat.com

2, 订阅
注: 开始不知道如何订阅, 直接发subscribe标题到地址. 系统会回复这个mail list的信息. 
1), 在https://lists.innerweb.novell.com/mailman/listinfo订阅
virtualization-dev@lists.novell.com
virtualization-xen@lists.novell.com
2), 在http://mailman.suse.de/mailman/listinfo订阅
devel-server@suse.de
3), 订阅opensuse-virtual@opensuse.org
发subscribe到这个地址, 系统提示: 
List-Post: <mailto:opensuse-virtual@opensuse.org>
List-Help: <mailto:opensuse-virtual+help@opensuse.org>
List-Subscribe:  <mailto:opensuse-virtual+subscribe@opensuse.org>
List-Unsubscribe:  <mailto:opensuse-virtual+unsubscribe@opensuse.org>
List-Owner: <mailto:opensuse-virtual+owner@opensuse.org>
List-Archive: <http://lists.opensuse.org/opensuse-virtual/>

于是发subscribe到opensuse-virtual+subscribe@opensuse.org, 系统会回一个邮件, 里面有说confirm邮件需要发到一个地址, 发送后很快系统就回复说已经成功订阅.

15:44 2012-02-07
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings; documentation, manual, 仅供参考, 这次编译由于repo没有加全都是手工下载的包自己编译的
1, download xen upstream
hg clone http://xenbits.xensource.com/xen-unstable.hg
结果没有hg这个命令, 去"http://mercurial.selenic.com/"下载编译. hg与svn, git命令对照表, see"18:20 2012-02-10"
make all
make install
hg debuginstall
最后一个命令提示没有设置姓名, 这个就先不管了. 再试一下hg clone:
novell@bjz-dev:upstream> hg clone http://xenbits.xensource.com/xen-unstable.hg
destination directory: xen-unstable.hg
requesting all changes
adding changesets
adding manifests
adding file changes
added 24702 changesets with 124726 changes to 11441 files
updating to branch default
3244 files updated, 0 files merged, 0 files removed, 0 files unresolved

2, download libvirt upstream
novell@bjz-dev:libvirt> git clone git://libvirt.org/libvirt.git
Initialized empty Git repository in /home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt/.git/
remote: Counting objects: 75251, done.
remote: Compressing objects: 100% (12007/12007), done.

3, compile: make tools
1), 编译时需要下载:
/home/novell/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/tools/qemu-xen-dir-remote.tmp/.git/
各种慢啊. 难道是需要设置什么东西?
2), require xgettext
Checking check_xgettext: which: no xgettext in (/home/novell/bin:/usr/local/bin:/usr/bin:/bin:/usr/bin/X11:/usr/X11R6/bin:/usr/games:/usr/lib/mit/bin:/usr/lib/mit/sbin:/sbin:/usr/sbin)
 *** check_xgettext FAILED: can't find xgettext
zypper in gettext-tools
3), require libaio_devel
Checking check_libaio_devel:
 *** check_libaio_devel FAILED: can't find libaio headers, install libaio devel package or set CONFIG_SYSTEM_LIBAIO=n
4), require yajl_devel
Checking check_yajl_devel:
 *** check_yajl_devel FAILED: can't find yajl/yajl_parse.h
zypper上没有, 直接下载一个"http://lloyd.github.com/yajl/".
configure需要ruby(zypper in ruby), cmake(自己下载http://cmake.org/cmake/resources/software.html的linux source code. 安装: configure, gmake, sudo gmake install)
安装yajl后仍然不行, 提示找不到头文件, 直接在"tools/check/funcs.sh"的has_header函数加入: 
if [ -r "$CROSS_SYS_ROOT/usr/local/include/$1" ]; then
	return 0
fi
又提示找不到so, 用funcs.sh的ldconfig -p | grep yajl, 没问题. 于是想加入打印信息"echo ${CHECK_SYS_ROOT}"调试, 结果这时"make tools"就可以了. 奇怪...
5), 又要下载
make -C firmware install
...
GIT=git /home/novell/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/tools/firmware/../../scripts/git-checkout.sh git://xenbits.xen.org/seabios.git rel-1.6.3.1 seabios-dir
6), 编译qemu过程中提示: glib-2.0 required to compile QEMU
但是用zypper看, glib2是安装了的. 
看configure(xen-unstable.hg/tools/qemu-xen-dir)脚本, 检查的是gthread-2.0
##########################################
# glib support probe
if $pkg_config --modversion gthread-2.0 > /dev/null 2>&1 ; then
	glib_cflags=`$pkg_config --cflags gthread-2.0 2>/dev/null`
	glib_libs=`$pkg_config --libs gthread-2.0 2>/dev/null`
	LIBS="$glib_libs $LIBS"
	libs_qga="$glib_libs $libs_qga"
else
	echo "glib-2.0 required to compile QEMU"
	exit 1
fi
用"zypper se gthread", libgthread-2_0-0也安装了.
如果直接删除上面几句话肯定不行(会导致编译时glib.h找不到), 所以考虑手工指定glib_cflags等:
但是还真没找到glib.h, 没办法, 考虑自己安装. 可是, glib是gtk和gnome的基础, 怎么可能没有呢? 也许是devel没有安装? 
用zypper se glibc查看, glibc-devel也安装了. 看看位置"rpm -ql glibc-devel", 确实没有glib.h.
上网查, 发现glib.h在glib2-devel里面, zypper里面没有这个包. 
系统目前是glib 2.22.5, 所以去官网下载了一个一样的(http://ftp.gnome.org/pub/gnome/sources/glib/2.22/).
7), (21:01 2012-02-07)
(1), 缺少libflask
/home/novell/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/tools/python/../../tools/cross-install -m0644 -p xen/xm/create.dtd /home/novell/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/dist/install/usr/share/xen
CC="gcc" CFLAGS="-O1 -fno-omit-frame-pointer -m64 -g -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wdeclaration-after-statement   -D__XEN_TOOLS__ -MMD -MF .install.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -fno-optimize-sibling-calls" python setup.py install \
                    --prefix="/usr" --root="/home/novell/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/dist/install" --force
running install
running build
running build_py
running build_ext
building 'flask' extension
error: ../../tools/flask/libflask/libflask.so: No such file or directory
make[3]: *** [install] Error 1
make[3]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/tools/python'
(2), 去看flask目录, 根本没有libflask这个目录啊. 去sles11-sp1的xen代码目录, 有libflask和对应Makefile.
novell@bjz-dev:libflask> pwd
/home/novell/work/source/virtualization/xen/suse_svn/branches/SLE11-SP1-Branch/xen/xen-4.0.3-testing/tools/flask/libflask
novell@bjz-dev:libflask> cat Makefile | grep libflask.so
LIB += libflask.so libflask.so.$(MAJOR) libflask.so.$(MAJOR).$(MINOR)
$(INSTALL_PROG) libflask.so.$(MAJOR).$(MINOR) $(DESTDIR)$(LIBDIR)
ln -sf libflask.so.$(MAJOR).$(MINOR) $(DESTDIR)$(LIBDIR)/libflask.so.$(MAJOR)
ln -sf libflask.so.$(MAJOR) $(DESTDIR)$(LIBDIR)/libflask.so
libflask.so: libflask.so.$(MAJOR)
libflask.so.$(MAJOR): libflask.so.$(MAJOR).$(MINOR)
libflask.so.$(MAJOR).$(MINOR): $(PIC_OBJS)
$(CC) $(CFLAGS) $(LDFLAGS) -Wl,$(SONAME_LDFLAG) -Wl,libflask.so.$(MAJOR) $(SHLIB_CFLAGS) -o $@ $^
(3), 之前下载的sles xen最新版本也是有libflask目录的. 看看xen upstream, flask目录变化情况. 
与
author  	Keir Fraser <keir@xen.org>
date 	Thu Mar 17 10:36:25 2011 +0000 (10 months ago)
parents 	1e5c3059d23b
children 	c3cfc4d4534d
版本相比, 当前版本是有意删除了libflask目录. 
view tools/flask/Makefile @ 24693:c3cfc4d4534d

find changesets by author, revision, files, or words in the commit message
tools/flask: remove libflask
This library has been deprecated since July 2010; remove the in-tree
users and library.

Signed-off-by: Daniel De Graaf <dgdegra@tycho.nsa.gov>
Committed-by: Keir Fraser <keir@xen.org>
author 	Daniel De Graaf <dgdegra@tycho.nsa.gov>
date 	Mon Feb 06 05:03:32 2012 -0800 (24 hours ago)
	parents 	ff3b7749008b
看来只能是是什么地方使用了libflask. 从Keir看, 应该可以不用libflask的. 
(4), 看看能否直接注释这个依赖关系
xen-unstable.hg/tools/python/setup.py
修改如下:
#               depends            = [ PATH_LIBXC + "/libxenctrl.so",
#                                      XEN_ROOT + "/tools/flask/libflask/libflask.so" ],
               depends            = [ PATH_LIBXC + "/libxenctrl.so"],
修改后终于编译通过了. 明天make install-tools and compile libvirt. 
(5), mail to Jiaju Zhang and ChunYan Liu(这个信没有发, 我看到已经有人在问了, 考虑到我也没有测试, 是否真的可用, 所以没有回信)
title: compile xen tools error due to the bug of xen upstream python
hi, Jiaju, ChunYan

today i compile xen tools successfully, but there is a bug while compiling xen tools(make tools), the file: xen-unstable.hg/tools/python/setup.py
need be changed from
               depends            = [ PATH_LIBXC + "/libxenctrl.so",
                                      XEN_ROOT + "/tools/flask/libflask/libflask.so" ],
to
               depends            = [ PATH_LIBXC + "/libxenctrl.so"],

otherwise, a error occurs:
CC="gcc" CFLAGS="-O1 -fno-omit-frame-pointer -m64 -g -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wdeclaration-after-statement   -D__XEN_TOOLS__ -MMD -MF .install.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -fno-optimize-sibling-calls" python setup.py install \
                    --prefix="/usr" --root="/home/novell/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/dist/install" --force
running install
running build
running build_py
running build_ext
building 'flask' extension
error: ../../tools/flask/libflask/libflask.so: No such file or directory
make[3]: *** [install] Error 1
make[3]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/tools/python'

while the hg info is as follows: 
view tools/flask/Makefile @ 24693:c3cfc4d4534d

find changesets by author, revision, files, or words in the commit message
tools/flask: remove libflask
This library has been deprecated since July 2010; remove the in-tree
users and library.

Signed-off-by: Daniel De Graaf <dgdegra@tycho.nsa.gov>
Committed-by: Keir Fraser <keir@xen.org>
author 	Daniel De Graaf <dgdegra@tycho.nsa.gov>
date 	Mon Feb 06 05:03:32 2012 -0800 (24 hours ago)
	parents 	ff3b7749008b


So, it seem that the committer forgot to remove the libflask dependence in setuppy. 

how do i deal with it? do i need to send to a email to Keir Fraser or Daniel De Graaf?

thanks

best wishes

bamvor

4, xen compile analysis
1), make world
# build xen, the tools, and a domain 0 plus unprivileged linux-xen images,
# and place them in the install directory. 'make install' should then
# copy them to the normal system directories
.PHONY: world
world: 
        $(MAKE) clean
	$(MAKE) kdelete
	$(MAKE) dist

其中make dist包括:
dist-xen dist-kernels dist-tools dist-stubdom dist-docs

10:16 2012-02-08
时间管理
0, 9:50

1. today
1), 20' 和liuzixi打电话. 
2), 10:15-11:10 maillist. see"10:31 2012-02-08"
被3)打断. 
3), 10' logAssistant命令实验. see"11:00 2012-02-08"
4), 11:36-12:41 吃饭
5), 13:10-14:17 17:20-17:28 install openSUSE12.1 pv/hvm on sles11-sp1 with LVM, see"13:32 2012-02-08"
6), 20' share clipboard between host and guest. see"15:13 2012-02-08". 后来想一想, 其实不是直接把guest的x回显到本地. 这样用chrome也就不存在共享剪贴板的问题了. 
7), 30' 休息.
8). 15:12-17:10 银行
9), 17:28-18:14 18:40-21:34 continue to compile xen tools and libvirt. 
10), 18:14-18:38 吃饭
11), 总结: 这几天都是下午才开始干活, 以后要注意. 还是正常一点比较好. 

10:31 2012-02-08
virtualization, suse, xen, maillist, xen-devel; libvirt
1, xen

2, libvirt
1), 修改libvirt依赖avahi-lib而不是avahi
keywords: avachi, 如何修改libvirt依赖关系, 如何测试
(1), 通过修改libvirt.spec, 使libvirt依赖avahi-lib而不是avahi. 
看看这个文件到底是怎么修改的. 
我知道libvirt checkout命令"git clone git://libvirt.org/libvirt.git", 浏览代码是在"http://libvirt.org/git/?p=libvirt.git;a=summary".
%if %{with_avahi}
-Requires: avahi
+Requires: avahi-libs
%endif
也就是把
%if %{with_avahi}
Requires: avahi
%endif
修改为
%if %{with_avahi}
Requires: avahi-libs
%endif
从注释看, 这个文件用于rpm安装时检查依赖关系. 

(2), 测试方法
Yes, forgot to mention that. I tested by doing this:

rpm -qa | grep avahi >/tmp/packages
cat packages | xargs rpm --erase --nodeps
yum install avahi-libs  # (this only installed the one package)

then I tried installing an unmodified libvirt rpm, which gave an error
due to the avahi package being absent. After that I installed the
modified libvirt rpm, and successfully restarted libvirt.

(After that, I reinstalled all the packages in /tmp/packages, because
there's a boatload of stuff that depends (directly or indirectly) on
avahi :-O )

(3), \todo 什么是avahi?

13:32 2012-02-08
virtualzation, suse, xen, install openSUSE on LVM
1, create LVM
http://linuxshellaccount.blogspot.com/2008/06/how-to-get-started-with-logical-volume.html
(1), using pvcreate to create physical volume
bjz-dev:/etc/xen/vm # pvcreate /dev/sda11
No physical volume label read from /dev/sda11
Physical volume "/dev/sda11" successfully created
bjz-dev:/etc/xen/vm # pvdisplay
"/dev/sda11" is a new physical volume of "29.84 GB"
--- NEW Physical volume ---
PV Name               /dev/sda11
VG Name
PV Size               29.84 GB
Allocatable           NO
PE Size (KByte)       0
Total PE              0
Free PE               0
Allocated PE          0
PV UUID               rfU5uH-yWfG-lEu0-tcg5-orYY-ioWR-C1RCOo

bjz-dev:/etc/xen/vm # 
(2), using "vgcreate" to create volume group base on physical volume
bjz-dev:/etc/xen/vm # vgcreate vg01 /dev/sda11
Volume group "vg01" successfully created
bjz-dev:/etc/xen/vm # vgdisplay
--- Volume group ---
VG Name               vg01
System ID
Format                lvm2
Metadata Areas        1
Metadata Sequence No  1
VG Access             read/write
VG Status             resizable
MAX LV                0
Cur LV                0
Open LV               0
Max PV                0
Cur PV                1
Act PV                1
VG Size               29.84 GB
PE Size               4.00 MB
Total PE              7638
Alloc PE / Size       0 / 0
Free  PE / Size       7638 / 29.84 GB
VG UUID               jALpGb-8Jve-1aKI-wfec-9A7X-n49x-l3Imu5
vgcreate creates a new volume group called  VolumeGroupName  using  the block  special  device PhysicalVolumePath previously configured for LVM with pvcreate(8).
3), using lvcreate to create logic volume on vg01
before lvcreate, alloc size is zero: 
bjz-dev:/etc/xen/vm # vgdisplay
--- Volume group ---
VG Name               vg01
System ID
Format                lvm2
Metadata Areas        1
Metadata Sequence No  1
VG Access             read/write
VG Status             resizable
MAX LV                0
Cur LV                0
Open LV               0
Max PV                0
Cur PV                1
Act PV                1
VG Size               29.84 GB
PE Size               4.00 MB
Total PE              7638
Alloc PE / Size       0 / 0
Free  PE / Size       7638 / 29.84 GB
VG UUID               jALpGb-8Jve-1aKI-wfec-9A7X-n49x-l3Imu5

using lvcreate to create a 2050M logic volume named vm_swap. this volume will be used as swap partition in virtual machine.
bjz-dev:/etc/xen/vm # lvcreate -L 2050M -n vm_swap vg01
Rounding up size to full physical extent 2.00 GB
Logical volume "vm_swap" created

now the alloc size change to 2G
bjz-dev:/etc/xen/vm # vgdisplay
--- Volume group ---
VG Name               vg01
System ID
Format                lvm2
Metadata Areas        1
Metadata Sequence No  2
VG Access             read/write
VG Status             resizable
MAX LV                0
Cur LV                1
Open LV               0
Max PV                0
Cur PV                1
Act PV                1
VG Size               29.84 GB
PE Size               4.00 MB
Total PE              7638
Alloc PE / Size       513 / 2.00 GB
Free  PE / Size       7125 / 27.83 GB
VG UUID               jALpGb-8Jve-1aKI-wfec-9A7X-n49x-l3Imu5

create the logic volume with rest disk for virtual machine root partition
bjz-dev:/etc/xen/vm # lvcreate -L 28498M -n vm_root vg01
Rounding up size to full physical extent 27.83 GB
Logical volume "vm_root" created

there is no free size at all.
bjz-dev:/etc/xen/vm # vgdisplay
--- Volume group ---
VG Name               vg01
System ID
Format                lvm2
Metadata Areas        1
Metadata Sequence No  3
VG Access             read/write
VG Status             resizable
MAX LV                0
Cur LV                2
Open LV               0
Max PV                0
Cur PV                1
Act PV                1
VG Size               29.84 GB
PE Size               4.00 MB
Total PE              7638
Alloc PE / Size       7638 / 29.84 GB
Free  PE / Size       0 / 0
VG UUID               jALpGb-8Jve-1aKI-wfec-9A7X-n49x-l3Imu5

bjz-dev:/etc/xen/vm # lvdisplay
--- Logical volume ---
LV Name                /dev/vg01/vm_swap
VG Name                vg01
LV UUID                Lu10D5-K7j9-FVbc-afIb-x6PV-imld-xBshOb
LV Write Access        read/write
LV Status              available
# open                 0
LV Size                2.00 GB
Current LE             513
Segments               1
Allocation             inherit
Read ahead sectors     auto
- currently set to     1024
Block device           253:0

--- Logical volume ---
LV Name                /dev/vg01/vm_root
VG Name                vg01
LV UUID                sd5hHr-O9vk-LLzI-CbSv-II3h-Vxlx-KXVPop
LV Write Access        read/write
LV Status              available
# open                 0
LV Size                27.83 GB
Current LE             7125
Segments               1
Allocation             inherit
Read ahead sectors     auto
- currently set to     1024
Block device           253:1

4), 但是没有"/dev/vg01/vm_root", 于是"lvremove /dev/vg01/vm_root", 再重新建立"lvcreate -L 28500M -n vm_root vg01".
故意容量设大一些, 结果建立倒是成功了. 

2, install
1), 第一次是用手动用xm create安装的, 结果安装后, 参考sles11-pv-bamvor-1用domUloader, 没法启动. 
第二次用lvm, vm-install里面harddisk选择browse, 类型也是phy不是file. 说明不是硬盘类型的问题. 

\todo: 之前在硬盘分区上两次安装openSUSE都失败了, 可能是因为xen config里面分区写的是phy而不是file. 看起来即使是实际的硬盘, 也应该是写成file. 

2), 这次还是不行. 还是走虚拟文件的老路.
注: boot=n表示从网络启动. 
还是不行. 难道是ext4?的问题? 

3), install openSUSE12.1 with ext3 in file disk0.raw

15:13 2012-02-08
software, virtualization, suse, xen, qemu, 在host和ghost之间共享clipboard
1, x2x or x2vnc or win2vnc
http://borderworlds.dk/blog/20070224-00.html
这个办法本质是没有考虑是否是虚拟机, 只是通过xwondows或vnc share mouse, keyboard and clipboard. 
2, remoteclip
http://bonzoli.com/docs/How_to_setup_Qemu_on_Fedora_8.html
3, share clip
http://www.instructables.com/id/Install-Fedora-8-Werewolf-on-Windows-XP-with-Qem/step10/SHARED-CLIPBOARD/

17:29 2012-02-08
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont1
1, compile libvirt
1), there is no configure in libvirt source code, i forget to how to generate. search in my working logs:
./bootstrap
(1), fail
novell@bjz-dev:libvirt> ./bootstrap
./bootstrap: one of these is required: glibtoolize libtoolize
(2), libvirt already has the auto script:
Building from a GIT checkout

The libvirt build process uses GNU autotools, so after obtaining a checkout it is necessary to generate the configure script and Makefile.in templates using the autogen.sh command, passing the extra arguments as for configure. As an example, to do a complete build and install it into your home directory run:

$ ./autogen.sh --prefix=$HOME/usr --enable-compile-warnings=error
$ make
$ sudo make install

the error is same:
novell@bjz-dev:libvirt> ./autogen.sh --prefix=$HOME/usr --enable-compile-warnings=error
running bootstrap...
./bootstrap: one of these is required: glibtoolize libtoolize
Failed to bootstrap, please investigate.
novell@bjz-dev:libvirt>
(3), from the bootstrap, i know that libtoolize is a part of libtool. so, 
novell@bjz-dev:libvirt> sudo zypper in libtool
(4), rerun autogen.sh
novell@bjz-dev:libvirt> ./autogen.sh --prefix=$HOME/usr --enable-compile-warnings=error
running bootstrap...
./bootstrap: Bootstrapping from checked-out http://libvirt.org sources...
./bootstrap: consider installing git-merge-changelog from gnulib
./bootstrap: getting gnulib files...
Submodule 'gnulib' (git://git.sv.gnu.org/gnulib.git) registered for path '.gnulib'
Initialized empty Git repository in /home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt/.gnulib/.git/
remote: Counting objects: 134773, done.
remote: Compressing objects: 100% (25093/25093), done.
(5), lack gnutls
checking for gnutls_handshake in -lgnutls... no
configure: error: You must install the GnuTLS library in order to compile and run libvirt

gnutls: The GNU Transport Layer Security Library.
sudo zypper in gnutls
(6), it is not work.
install gnutls from source code.
libnettle and libhogweed is needed by gnutls, but after i compile and install nettle, libhogweed is not found yes.
configure:8772: gcc -std=gnu99 -o conftest -g -O2   conftest.c  -lnettle -lhogweed -lgmp >&5
/usr/lib64/gcc/x86_64-suse-linux/4.3/../../../../x86_64-suse-linux/bin/ld: cannot find -lhogweed

i have to check to log for nettle configure:
checking for __gmpz_getlimbn in -lgmp... no
configure: WARNING: GNU MP not found, or not 3.1 or up, see http://gmplib.org/.
Support for public key algorithms will be unavailable.

(7), recompile gnutls
/usr/bin/guile-snarf -o core.x core.c -DHAVE_CONFIG_H  -I../../lib/includes -I../../lib/includes -I../../extra/includes -I../.. -I.  -g -O2 -Wno-strict-prototypes  -pthread
core.c:29:22: error: libguile.h: No such file or directory

(8), libunistring is needed by guile
checking how to link with libgmp... /usr/local/lib/libgmp.so -Wl,-rpath -Wl,/usr/local/lib
configure: error: GNU libunistring is required, please install it.

(9), libffi is need by guile
checking for LIBFFI... configure: error: Package requirements (libffi) were not met:

No package 'libffi' found

bamvor: 我高度怀疑, 我是否应该在openSUSE里面编译, 也许opensuse里面不会缺少这么多library吧.

(10), bdw-gc is needed by guile
checking for BDW_GC... configure: error: Package requirements (bdw-gc) were not met:

No package 'bdw-gc' found

(11), finally, the configure of guile is passed. 
recompile gnutls with the same error. So, re-configure gnutls, compile pass.

(12), devmapper greater than 1.0.0 is needed by libvirt
checking for DEVMAPPER... no
checking for dm_task_run in -ldevmapper... no
checking libdevmapper.h usability... no
checking libdevmapper.h presence... no
checking for libdevmapper.h... no
configure: error: You must install device-mapper-devel/libdevmapper >= 1.0.0 to compile libvirt

(13), compile devmapper from LVM2: 
The userspace code (dmsetup and libdevmapper) is now maintained alongside the LVM2 source available from http://sources.redhat.com/lvm2/. To build / install it without LVM2 use 'make device-mapper' / 'make device-mapper_install'. 

add devmapper.pc to pkg-config search path

novell@bjz-dev:pkgconfig> cp /home/novell/work/source/LVM2/LVM2.2.02.90/libdm/libdevmapper.pc .
novell@bjz-dev:pkgconfig> ln -s libdevmapper.pc devmapper.pc
novell@bjz-dev:pkgconfig> ll
total 4
lrwxrwxrwx 1 novell users  15 2012-02-08 20:57 devmapper.pc -> libdevmapper.pc
-rw-r--r-- 1 novell users 255 2012-02-08 20:55 libdevmapper.pc
novell@bjz-dev:pkgconfig> cat libdevmapper.pc
prefix=/home/novell/work/install
exec_prefix=
libdir=${exec_prefix}/lib
includedir=${prefix}/include

Name: devmapper
Description: device-mapper library
Version: 1.02.69
Cflags: -I${includedir}
Libs: -L${libdir} -ldevmapper
Requires.private: libselinux

novell@bjz-dev:pkgconfig> export PKG_CONFIG_PATH=/home/novell/work/install/lib/pkgconfig
novell@bjz-dev:pkgconfig> pkg-config --exists --print-errors devmapper

(14), lack libdevmapper.h
checking for DEVMAPPER... yes
checking libdevmapper.h usability... no
checking libdevmapper.h presence... no
checking for libdevmapper.h... no
configure: error: You must install device-mapper-devel/libdevmapper >= 1.0.0 to compile libvirt

change, libdevmapper.pc from
novell@bjz-dev:pkgconfig> cat libdevmapper.pc
prefix=/home/novell/work/install
to
novell@bjz-dev:pkgconfig> cat libdevmapper.pc
prefix=/home/novell/work/install/usr

it not work. so search in the internet.
http://www.network-theory.co.uk/docs/gccintro/gccintro_22.html say
The -I option or the INCLUDE_PATH variable described below should always be used to set the include path for header files. 
i set INCLUDE_PATH as 
novell@bjz-dev:libvirt> export INCLUDE_PATH=/home/novell/work/install/usr/includ
e

but it failed again. 
finally, i give up. just install the xen and devmapper to the default path. 

(15), rerun autogen.sh
pass. make

2, make libvirt
1), gcrypt.h not found
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I.. -I../gnulib/lib -I../gnulib/lib -I../include -I../include -I../src/util -DIN_LIBVIRT -I/usr/local/include -I../src/conf -I/usr/include/libxml2 -Wall -W -Wformat-y2k -Wformat-security -Winit-self -Wmissing-include-dirs -Wunused -Wunknown-pragmas -Wstrict-aliasing -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-align -Wwrite-strings -Wlogical-op -Waggregate-return -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wmissing-noreturn -Wmissing-format-attribute -Wredundant-decls -Wnested-externs -Winline -Winvalid-pch -Wvolatile-register-var -Wdisabled-optimization -Wattributes -Wcoverage-mismatch -Wmultichar -Wdeprecated-declarations -Wdiv-by-zero -Wendif-labels -Wextra -Wformat-contains-nul -Wformat-extra-args -Wformat-zero-length -Wformat=2 -Wmultichar -Wnormalized=nfc -Woverflow -Wpointer-to-int-cast -Wpragmas -Wno-missing-field-initializers -Wno-sign-compare -Wno-format-nonliteral -fstack-protector-all --param=ssp-buffer-size=4 -fexceptions -fasynchronous-unwind-tables -fdiagnostics-show-option -funit-at-a-time -fipa-pure-const -Werror -g -O2 -MT libvirt_driver_la-libvirt.lo -MD -MP -MF .deps/libvirt_driver_la-libvirt.Tpo -c libvirt.c  -fPIC -DPIC -o .libs/libvirt_driver_la-libvirt.o
libvirt.c:22:20: error: gcrypt.h: No such file or directory

11:08 2012-02-09
company, 公司未来中国市场不错
1, "SenMingChang"mail"鸿门宴"
   过去几个月，各位收到我的几个emails，在几个大的oppty里捷报连连，而红帽中国节节溃败，各位一定很奇怪，市场上发生了什么事情。在春节我看了一个DVD，名字叫做《鸿门宴》，目前我们跟红帽的竞争和鸿门宴的情节非常类似。两军相争，一比士气，二比谋略。
      一比士气。目前红帽中国的团队，乱的一塌糊涂，我有两条内线在红帽，所以我对他们的情况知道的非常清楚，第一，将帅不合，互斗激烈，二，有些领导以权谋私，三，quota 高得离谱，所以目前红帽中国销售团队士气涣散，几乎每个人都在外面找事，我手上就有好几份红帽的简历，跟他们面试时每个人都是抱怨连连，这种团队是毫无作战能力的。
        二比谋略。项羽刺杀楚怀王，自立为王，以粗暴的手段对付八路诸侯，所以八路诸侯纷纷倒向刘邦，同样的，红帽中国自以为是，废掉在中国和香港合作多年的独家总代，神州立诚和 ACW，目前这两个 partners 都跟我们密切合作，把红帽的合作伙伴跟客户转到 SuSe 来，昨天中午，我跟神州立诚和红帽过去的4个铁杆合作伙伴 连邦软件，雷州泰克，东方莱恩，友创天逸一起共商大计 (这是第三次了)，我们计划在一年内 convert 红帽20个合作伙伴以及10个主要的ISV，我相信红帽中国离四面楚歌的日子不远了，目前我们已经成功了一半，让我们继续努力！

2, "Sen Ming Chang"mail"转发： GSC - Business Updates and Sharing"
Team,

    过去我们都知道在 Peter 的领导下, Novell 在香港是一哥, 我以前  IBM 的老同事不止一次很哀怨的向我抱怨, IBM Tivoli team 已放弃香港政府, 在过去两年情势起了变化, 2 年前 Peter 与 Stanley 充分利用了一个 VAD 把 Forge 带进了市场, 目前已达到了 250K/quarter 的 runrate business.   去年 Peter 成功的赢下 Jockey Club, Dairy Farm 等 Linux 大单, 这个季度, Hong Kong team 已经赢了 Hong Kong Stock Exchange, HSBC, 目前在一家国内著名的银行香港分行做 POC, Peter 已经跟我 Commit 了 150K for this quarter.   难能可贵的是这 3 单都是 Red Hat 的用户.... 目前 Peter 也 recruited Red Hat 过去 8 年的独家总代 ACW 去win back 更多的 Red Hat 用户, 我们有句老话前人种树后人乘谅, 在香港是 Red Hat 种树, SuSe 乘谅....  sm
  
>>> Peter Man 2/9/2012 12:47 am >>>
各位同事，

相信大家都看到我發給大家的電郵關於我們已拿下香港交易所的第一個訂單，而全球第六大交易所也正式成為 Novell/SUSE 的客戶。

讓我跟大家分享一下股票交易所這個巿場，和我們可以怎樣利用 SUSE 最近的重要成功案例，跟其他潛在客戶分享。全球巿值最大的6個交易所，順次序為 1）紐約交易所 - NYSE Euronext, 2) 美國 Nasdaq 交易所，3）東京交易所，4）倫敦交易所，5）上海証卷交易所，和 6) 香港交易所。從今天的形勢來看， Redhat 和 SUSE 在全球六大交易所各佔3個，在我們的角度來說當然是勢均力敵，但 Redhat 也會向其他客戶說，他們所佔有的 NYSE, Nasdaq 和東京交易所比我們的大得多，也用了多年的 Redhat.

當遇到以上的問題，我們可以用以下的點子來回應：

（1）美國和日本的交易所都是比較早期決定使用 Linux, 而當時 SUSE 還只是歐洲的一哥，Novell 還未收購 SUSE 把它真正國際化，所以美國和親美的日本用美國品牌的 Redhat 是理所當然的 ●●●●●● 但 SUSE 國際化後情況便不同了。

（2） 在近兩三年才決定把交易平台搬到 Linux 上的如倫敦，和在計劃中的上海和香港，都投到 SUSE 旗下，足以証實 SUSE 的實力 ●●●●●●● 難道我們這三個客戶沒有考慮 Redhat 嗎?

（3）我從來都沒有刻意去說 SUSE 跟 Redhat 有什麼分別，反而，我採取的態度是 Linux 就是 Linux, 無論是 SUSE 或 Redhat, 我們的團隊都可以支援客戶，幫客戶打造一個最適合他們的 Linux 平台。只要我們拿到控制支援這個重要的控制點，往後便可部署對客戶最合適和對SUSE 最有利的配置。這個策略對重大的和對 SUSE 有少許疑慮的客戶最適用。而在大中華區，我們的支援比 Redhat 強得多。  

（4）令外一個比較有趣的點子，有時我會用 "德國科技＂來比喻 SUSE 對打造 Linux 的精細和嚴謹。大部分人都會同意德國汽車品牌如平治，寶馬，保時捷等，或高檔的廚具品牌 Miele, 都是有質量，有品味，耐用和安全的保證.  大家可以考慮借用這些已深入人心的印象，投射到 SUSE 身上，除時會有意想不到的效果。

大客戶對我們來說是十分重要的。對絶大部分公司來說，一個健康的客戶群必定包括一班大客戶來提供穩定的 recurrent 生意，和其他中小型客戶來提供 run rate 生意。兩者缺一都會帶來極大的風險。作為銷售的，在這方面要多作全面的考慮和計劃。
Peter

11:19 2012-02-09
时间管理
0, 10:00

1, today
1), 关注马小平老师. 
2), 11:19-11:40 14:10- continue to compile xen tools and libvirt. see"11:20 2012-02-09"

11:20 2012-02-09
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont2
1, make libvirt
1), gcrypt.h not found
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I.. -I../gnulib/lib -I../gnulib/lib -I../include -I../include -I../src/util -DIN_LIBVIRT -I/usr/local/include -I../src/conf -I/usr/include/libxml2 -Wall -W -Wformat-y2k -Wformat-security -Winit-self -Wmissing-include-dirs -Wunused -Wunknown-pragmas -Wstrict-aliasing -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-align -Wwrite-strings -Wlogical-op -Waggregate-return -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wmissing-noreturn -Wmissing-format-attribute -Wredundant-decls -Wnested-externs -Winline -Winvalid-pch -Wvolatile-register-var -Wdisabled-optimization -Wattributes -Wcoverage-mismatch -Wmultichar -Wdeprecated-declarations -Wdiv-by-zero -Wendif-labels -Wextra -Wformat-contains-nul -Wformat-extra-args -Wformat-zero-length -Wformat=2 -Wmultichar -Wnormalized=nfc -Woverflow -Wpointer-to-int-cast -Wpragmas -Wno-missing-field-initializers -Wno-sign-compare -Wno-format-nonliteral -fstack-protector-all --param=ssp-buffer-size=4 -fexceptions -fasynchronous-unwind-tables -fdiagnostics-show-option -funit-at-a-time -fipa-pure-const -Werror -g -O2 -MT libvirt_driver_la-libvirt.lo -MD -MP -MF .deps/libvirt_driver_la-libvirt.Tpo -c libvirt.c  -fPIC -DPIC -o .libs/libvirt_driver_la-libvirt.o
libvirt.c:22:20: error: gcrypt.h: No such file or directory

why the configure not check this one???
install: "sudo zypper in libgcrypt", but fail.
compile by myself.
(1), compile libgcrypt-1.5.0
checking for gpg-error-config... no
checking for GPG Error - version >= 1.8... no
configure: error: libgpg-error is needed.
See ftp://ftp.gnupg.org/gcrypt/libgpg-error/ .

2, finally, there are some libxl compiling errors.
1), libxl/libxl_config.c
the log from "tail -n `echo $((543-372+1))` /home/novell/work/source/virtualization/libvirt/libvirt/log_make_8_libxl_error". \todo save the log file.
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I.. -I../gnulib/lib -I../gnulib/lib -I../include -I../include -I../src/util -DIN_LIBVIRT -I../src/conf -I../src/xenxs -I/usr/include/libxml2 -Wall -W -Wformat-y2k -Wformat-security -Winit-self -Wmissing-include-dirs -Wunused -Wunknown-pragmas -Wstrict-aliasing -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-align -Wwrite-strings -Wlogical-op -Waggregate-return -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wmissing-noreturn -Wmissing-format-attribute -Wredundant-decls -Wnested-externs -Winline -Winvalid-pch -Wvolatile-register-var -Wdisabled-optimization -Wattributes -Wcoverage-mismatch -Wmultichar -Wdeprecated-declarations -Wdiv-by-zero -Wendif-labels -Wextra -Wformat-contains-nul -Wformat-extra-args -Wformat-zero-length -Wformat=2 -Wmultichar -Wnormalized=nfc -Woverflow -Wpointer-to-int-cast -Wpragmas -Wno-missing-field-initializers -Wno-sign-compare -Wno-format-nonliteral -fstack-protector-all --param=ssp-buffer-size=4 -fexceptions -fasynchronous-unwind-tables -fdiagnostics-show-option -funit-at-a-time -fipa-pure-const -Werror -g -O2 -MT libvirt_driver_libxl_la-libxl_conf.lo -MD -MP -MF .deps/libvirt_driver_libxl_la-libxl_conf.Tpo -c libxl/libxl_conf.c  -fPIC -DPIC -o .libs/libvirt_driver_libxl_la-libxl_conf.o
In file included from /usr/include/libxl.h:140,
                 from libxl/libxl_conf.c:29:
/usr/include/xen/sysctl.h:31:2: error: #error "sysctl operations are intended for use by node control tools only"
In file included from /usr/include/xen/sysctl.h:35,
                 from /usr/include/libxl.h:140,
                 from libxl/libxl_conf.c:29:
/usr/include/xen/domctl.h:32:2: error: #error "domctl operations are intended for use by node control tools only"
In file included from /usr/include/xen/sysctl.h:35,
                 from /usr/include/libxl.h:140,
                 from libxl/libxl_conf.c:29:
...
make[3]: *** [libvirt_driver_libxl_la-libxl_conf.lo] Error 1
make[3]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt/src'
make[2]: *** [all] Error 2
make[2]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt/src'
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt'
make: *** [all] Error 2

(1), it looks like  __XEN__ or __XEN_TOOLS__ not defined. but the xen/sysctl.h is not change comparing to the sles11_sp1. 
So, i compare the libxl.h, i found that "#include <xen/sysctl.h>" is new add.
\todo 看起来__XEN__ or __XEN_TOOLS__是希望保证只有xen的node维护工具才能调用. 怎么改才合理呢? 
sysctl operations are intended for use by node control tools only
(2), who defined "__XEN_TOOLS__".
在tools目录下: 
libxc/xenctrl.h:#ifndef __XEN_TOOLS__
libxc/xenctrl.h:#define __XEN_TOOLS__ 1
libxc/xenctrlosdep.h:#ifndef __XEN_TOOLS__
libxc/xenctrlosdep.h:#define __XEN_TOOLS__ 1
qemu-xen-traditional-dir/xen-setup-stubdom:TARGET_CPPFLAGS += $TARGET_CPPFLAGS -DCONFIG_STUBDOM -D__XEN_TOOLS__
qemu-xen-traditional-dir-remote/xen-setup-stubdom:TARGET_CPPFLAGS += $TARGET_CPPFLAGS -DCONFIG_STUBDOM -D__XEN_TOOLS__
Rules.mk:CFLAGS += -D__XEN_TOOLS__

(3), who defined "__XEN__", in tools and xen, only one definition: 
xen/Rules.mk:CFLAGS-y                += -g -D__XEN__ -include $(BASEDIR)/include/xen/config.h

(4), add these two defines in libxl_conf.c temporary. 
#define __XEN__
#define __XEN_TOOLS__
#include <libxl.h>

2), libxl_event.h
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I.. -I../gnulib/lib -I../gnulib/lib -I../include -I../include -I../src/util -DIN_LIBVIRT -I../src/conf -I../src/xenxs -I/usr/include/libxml2 -Wall -W -Wformat-y2k -Wformat-security -Winit-self -Wmissing-include-dirs -Wunused -Wunknown-pragmas -Wstrict-aliasing -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-align -Wwrite-strings -Wlogical-op -Waggregate-return -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wmissing-noreturn -Wmissing-format-attribute -Wredundant-decls -Wnested-externs -Winline -Winvalid-pch -Wvolatile-register-var -Wdisabled-optimization -Wattributes -Wcoverage-mismatch -Wmultichar -Wdeprecated-declarations -Wdiv-by-zero -Wendif-labels -Wextra -Wformat-contains-nul -Wformat-extra-args -Wformat-zero-length -Wformat=2 -Wmultichar -Wnormalized=nfc -Woverflow -Wpointer-to-int-cast -Wpragmas -Wno-missing-field-initializers -Wno-sign-compare -Wno-format-nonliteral -fstack-protector-all --param=ssp-buffer-size=4 -fexceptions -fasynchronous-unwind-tables -fdiagnostics-show-option -funit-at-a-time -fipa-pure-const -Werror -g -O2 -MT libvirt_driver_libxl_la-libxl_conf.lo -MD -MP -MF .deps/libvirt_driver_libxl_la-libxl_conf.Tpo -c libxl/libxl_conf.c  -fPIC -DPIC -o .libs/libvirt_driver_libxl_la-libxl_conf.o
In file included from libxl/libxl_conf.c:31:
/usr/include/libxl.h:676:25: error: libxl_event.h: No such file or directory
(1), there is a libxl_event.h in source code:
tools/libxl/libxl_event.h
(2), it looks like libxl_event.h is not copy to the install because the mistake in tools/libxl/Makefile.
\todo fix it. temporay change 
$(INSTALL_DATA) libxl.h libxl_json.h _libxl_types.h _libxl_types_json.h _libxl_list.h libxl_utils.h libxl_uuid.h $(DESTDIR)$(INCLUDEDIR)
to
$(INSTALL_DATA) libxl.h libxl_json.h _libxl_types.h _libxl_types_json.h _libxl_list.h libxl_utils.h libxl_uuid.h libxl_event.h $(DESTDIR)$(INCLUDEDIR)

3), there are some capatibility errors in libxl_conf.c
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I.. -I../gnulib/lib -I../gnulib/lib -I../include -I../include -I../src/util -DIN_LIBVIRT -I../src/conf -I../src/xenxs -I/usr/include/libxml2 -Wall -W -Wformat-y2k -Wformat-security -Winit-self -Wmissing-include-dirs -Wunused -Wunknown-pragmas -Wstrict-aliasing -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-align -Wwrite-strings -Wlogical-op -Waggregate-return -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wmissing-noreturn -Wmissing-format-attribute -Wredundant-decls -Wnested-externs -Winline -Winvalid-pch -Wvolatile-register-var -Wdisabled-optimization -Wattributes -Wcoverage-mismatch -Wmultichar -Wdeprecated-declarations -Wdiv-by-zero -Wendif-labels -Wextra -Wformat-contains-nul -Wformat-extra-args -Wformat-zero-length -Wformat=2 -Wmultichar -Wnormalized=nfc -Woverflow -Wpointer-to-int-cast -Wpragmas -Wno-missing-field-initializers -Wno-sign-compare -Wno-format-nonliteral -fstack-protector-all --param=ssp-buffer-size=4 -fexceptions -fasynchronous-unwind-tables -fdiagnostics-show-option -funit-at-a-time -fipa-pure-const -Werror -g -O2 -MT libvirt_driver_libxl_la-libxl_conf.lo -MD -MP -MF .deps/libvirt_driver_libxl_la-libxl_conf.Tpo -c libxl/libxl_conf.c  -fPIC -DPIC -o .libs/libvirt_driver_libxl_la-libxl_conf.o
In file included from libxl/libxl_conf.c:45:
(1), libxl_ctx definition has been changed:
libxl/libxl_conf.h:61: error: field 'ctx' has incomplete type
libxl/libxl_conf.h:80: error: field 'ctx' has incomplete type
a, suse_svn(libxl.h)
typedef struct {
           xentoollog_logger *lg;
       xc_interface *xch;
    struct xs_handle *xsh;

    /* for callers who reap children willy-nilly; caller must only
        * set this after libxl_init and before any other call - or
         * may leave them untouched */
    int (*waitpid_instead)(pid_t pid, int *status, int flags);
    libxl_version_info version_info;
} libxl_ctx;    

b, upstream
libxl.h: 
typedef struct libxl__ctx libxl_ctx;
libxl_internal.h: 
struct libxl__ctx {
    xentoollog_logger *lg;
    xc_interface *xch;
    struct xs_handle *xsh;

    const libxl_event_hooks *event_hooks;
    void *event_hooks_user;

    pthread_mutex_t lock; /* protects data structures hanging off the ctx */
      /* Always use libxl__ctx_lock and _unlock (or the convenience
       * macors CTX_LOCK and CTX_UNLOCK) to manipulate this.
       *
       * You may acquire this mutex recursively if it is convenient to
       * do so.  You may not acquire this lock at the same time as any
       * other lock.  If you need to call application code outside
       * libxl (ie, a callback) with this lock held then it is
       * necessaray to impose restrictions on the caller to maintain a
       * proper lock hierarchy, and these restrictions must then be
       * documented in the libxl public interface.
       */

    LIBXL_TAILQ_HEAD(libxl__event_list, libxl_event) occurred;

    int osevent_in_hook;
    const libxl_osevent_hooks *osevent_hooks;
    void *osevent_user;
      /* See the comment for OSEVENT_HOOK_INTERN in libxl_event.c
       * for restrictions on the use of the osevent fields. */

    libxl__poller poller_app; /* libxl_osevent_beforepoll and _afterpoll */
    LIBXL_LIST_HEAD(, libxl__poller) pollers_event, pollers_idle;

    LIBXL_LIST_HEAD(, libxl__ev_fd) efds;
    LIBXL_TAILQ_HEAD(, libxl__ev_time) etimes;

    libxl__ev_watch_slot *watch_slots;
    int watch_nslots;
    LIBXL_SLIST_HEAD(, libxl__ev_watch_slot) watch_freeslots;
    uint32_t watch_counter; /* helps disambiguate slot reuse */
    libxl__ev_fd watch_efd;

    LIBXL_TAILQ_HEAD(libxl__evgen_domain_death_list, libxl_evgen_domain_death)
        death_list /* sorted by domid */,
        death_reported;
    libxl__ev_xswatch death_watch;
    
    LIBXL_LIST_HEAD(, libxl_evgen_disk_eject) disk_eject_evgens;

    /* for callers who reap children willy-nilly; caller must only
     * set this after libxl_init and before any other call - or
     * may leave them untouched */
    int (*waitpid_instead)(pid_t pid, int *status, int flags);
    libxl_version_info version_info;
};

c, add struct define in libxl.h
novell@bjz-dev:libxl> diff libxl.h libxl.h.bak1657
203a204
> struct libxl__ctx;
it not work. 看来比需要把libxl_internal.h也复制到/usr/include? 还是只是把libxl__ctx复制到libxl.h? \todo 
这个很恶心啊. 是否封装一些操作比直接调用struct好一些呢?
经过实验, 多包含libxl_internal.h会引入更多问题, 看看复制struct libxl__ctx行不行.
如果简单复制过去也有问题. \todo 看来要好好看一看相关代码了. 

d, 经过手工查找hg log, 发现是在如下这个提交中把libxl__ctx定义在libxl_internal.h中, 且不在libxl.h中定义libxl_ctx:
http://xenbits.xensource.com/hg/xen-unstable.hg/rev/751c6dcec0d4
libxl: do not expose libxenctrl/libxenstore headers via libxl.h
This completely removes libxenstore from libxl users' view.
xl still needs libxenctrl directly due to the direct use of the
xentoollog functionality but it is not exposed to the indirect linkage
anymore.
Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
Acked-by: Ian Jackson <ian.jackson@eu.citrix.com>
Committed-by: Ian Jackson <ian.jackson@eu.citrix.com>
author 	Ian Campbell <ian.campbell@citrix.com>
date 	Wed Apr 06 16:50:16 2011 +0100 (10 months ago)
	parents 	94cef9aaf0cd
	children 	e5a750d1bf9b
	files 	tools/Rules.mk tools/libxl/Makefile tools/libxl/libxl.c tools/libxl/libxl.h tools/libxl/libxl_internal.h tools/libxl/libxlu_cfg.c tools/libxl/xl.c tools/libxl/xl.h tools/libxl/xl_cmdimpl.c tools/ocaml/libs/xl/xl_stubs.c tools/python/setup.py tools/python/xen/lowlevel/xl/xl.c

14:06 2012-02-09
company, leader, Jiaju Zhang找我聊
1, 希望我能体现自己的performance和可见度.
2, 尽快搞清楚Jim给我的libvirt编译问题是个什么问题. 
3, 提醒我如果依赖关系复杂, 可以用build service自动编译.

14:33 2012-02-09
software, vim, Arithmetic Expansion
1, according to the bash man page
Arithmetic expansion allows the evaluation of an arithmetic  expression
and  the  substitution of the result.  The format for arithmetic expan-
sion is:

$((expression))

2, so, i can get the minus result ( 543 - 372 + 1 ) from "$((543-372+1))". as a consequent, i can get the last ( 543 - 372 + 1 ) lines from file:
tail -n `echo $((543-372+1))` /home/novell/work/source/virtualization/libvirt/libvirt/log_make_2_libxl_error 

14:59 2012-02-09
virtualization, suse, xen, libvirt, libvirt study
1, libvirt FAQ
http://wiki.libvirt.org/page/FAQ
Some of the major libvirt features are:
* VM management
* Remote machine support
* Storage management
* Network interface management
* Virtual NAT and Route based networking

17:32 2012-02-09
company, software, linux, novell
"Alan Gao"mail"Novell产品技术小贴士 2012年02月"
本期主题1--/var/run目录误删除
解决方案
/var/run目录的作用为：
This directory contains system information data describing the system since it was booted. Files under this directory must be cleared (removed or truncated as appropriate) at the beginning of the boot process. Programs may have a subdirectory of /var/run; this is encouraged for programs that use more than one run-time file. [42] Process identifier (PID) files, which were originally placed in /etc, must be placed in /var/run. The naming convention for PID files is <program-name>.pid. For example, the crond PID file is named /var/run/crond.pid.
该目录下的文件是系统上进程产生的名为processname.pid文件，误删除之后重启就可以恢复类似于/var/log目录，不需要额外的操作。
本期主题2--FTP服务异常
问题描述
在有些ftp服务连接日志中会出现
FtpProtocolException: 425 Security: Bad IP connecting.
从工作流机器上执行命令直接ftp文件服务器2，发现同样会提示
425 Security: Bad IP connecting
解决方案
通过服务端添加参数：pasv_promiscuous=YES解决此问题。
当前通过对服务器主机放宽限制：
pasv_promiscuous
Set to YES if you want to disable the PASV security check that ensures the data connection originates from the same IP address as the control connection. Only enable if you know what you are doing! The only legitimate use for this is in some form of secure tunnelling scheme, or perhaps to facilitate FXP support.
Default: NO
本期主题3--net.ipv4.ip_conntrack_max 参数设置失败
防火墙被在开机自启动中为关闭状态。那么相关的iptables的相关控制模块不会被加载。
除非手工启动，或者第三方相关控制将iptables启动，否则不会加载模块。该参数的设置是需要该模块的支持，所以让其生效采用的简单方法是将防火墙启动后，设置该参数
成功后将防火墙再关闭。

10:19 2012-02-10
virtualization, suse, xen
1, "Jim Fehlig <jfehlig@suse.com>"mail"Re: [Virtualization-dev] Xen Migration Checks (was: NTS Transfer Training)"
It is possible, but I don't think it is something for the xm/xend
toolstack.  IMO, we should add these types of checks in the libvirt
libxl driver since the libvirt migration protocol supports
{pre,post}-migration checks.  Currently, the libxl driver doesn't even
support migration, but Chunyan has been working on an implementation.
Another improvement for the libxl driver would be providing control of
the cpu model and features presented to a guest.  libvirt has quite a
bit of flexibility wrt defining cpus, e.g.
<cpu match='exact'>
<model>core2duo</model>
<vendor>Intel</vendor>
<topology sockets='1' cores='2' threads='1'/>
<feature policy='disable' name='lahf_lm'/>
</cpu>

Administrators can then define vcpus that are compatible with all their
pcpus.  But I'm not sure if xen provides the same flexibility as qemu.
Certainly, qemu is more user-friendly :-)

qemu -cpu core2duo

vs

cpuid=[ '1:ecx=xxxxxxxxxxx00xxxxxxxxxxxxxxxxxxx,
eax=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx' ]

10:42 2012-02-10
时间管理
0, 10:00

1, today
1), check the mail. read virtualzation-xen maillist, see"10:19 2012-02-10".
2), how to using ctags and cscope in vim. see"11:30 2012-02-10".
3), -12:00 14:38 continue to compile xen tools and libvirt. see"11:44 2012-02-10".
4), 40' 午饭; 30' 休息.

11:30 2012-02-10
software, tools, code explore, ctags, cscope
相同的代码有不同的版本, 希望在不同的代码下使用不同的ctags和cscope文件. 实验中. \todo 发博客. 
novell@bjz-dev:libvirt> ctags -R
novell@bjz-dev:libvirt> cscope -bR
novell@bjz-dev:libvirt> cat .vimrc
"vim setting for code exploring
set tags+=/home/novell/work/source/virtualization/libvirt/libvirt/tags
cscope add /home/novell/work/source/virtualization/libvirt/libvirt/cscope.out /home/novell/work/source/virtualization/libvirt/libvirt

11:44 2012-02-10
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont3
1, yesterday, i install xen tools by "make install-tools", after reboot the compute, the xend can not start successful. 
today, i ask Chunyan LIU for help.
1), check /var/log/xen/xend.log
2012-02-10 11:33:27 26487] info (srvdaemon:332) xend daemon started
[2012-02-10 11:33:27 26487] info (srvdaemon:336) xend changeset: 21511.
[2012-02-10 11:33:27 26487] error (srvdaemon:349) exception starting xend ((13, 'permission denied'))
traceback (most recent call last):
  File "usr/lib64/python2.6/site-packages/xen/xend/server/SrvDaemon.py", line 341, in run
    servers = SrvServer.create()
  File "usr/lib64/python2.6/site-packages/xen/xend/server/SrvServer.py", line 258, in create
    root.putChild('xend', SrvRoot())
  File "usr/lib64/python2.6/site-packages/xen/xend/server/SrvRoot.py", line 40, in __init__
    self.get(name)
  File "usr/lib64/python2.6/site-packages/xen/web/SrvDir.py", line 84, in get
    val = val.getobj()
  File "usr/lib64/python2.6/site-packages/xen/web/SrvDir.py", line 52, in getobj
    self.obj = klassobj()
  File "usr/lib64/python2.6/site-packages/xen/xend/server/SrvNode.py", line 30, in __init__
    self.xn = XendNode.instance()
  File "usr/lib64/python2.6/site-packages/xen/xend/XendNode.py", line 1181, in instance
    inst = XendNode()
  File "usr/lib64/python2.6/site-packages/xen/xend/XendNode.py", line 94, in __init__
    self.other_config["xen_pagesize"] = self.xeninfo_dict()["xen_pagesize"]
  File "usr/lib64/python2.6/site-packages/xen/xend/XendNode.py", line 1087, in xeninfo_dict
    return dict(self.xeninfo())
  File "usr/lib64/python2.6/site-packages/xen/xend/XendNode.py", line 1030, in xeninfo
    info['xen_scheduler'] = self.xenschedinfo()
  File "usr/lib64/python2.6/site-packages/xen/xend/XendNode.py", line 1018, in xenschedinfo
    sched_id = self.xc.sched_id_get()
Error: (13, 'Permission denied')
[2012-02-10 11:33:27 26486] INFO (SrvDaemon:220) Xend exited with status 1.
2), the xc.sched_id_get call the do_sysctl to get sched_id. 
i do not know the reason from the do_sysctl point of view. 
Chunyan suggest that try "make world", and i can test it on the test machine in the lab(contact Chunyan or Lin ma to know which machine i can use).

2, continue to compile libvirt
1), change "libxl_ctx ctx;" to "libxl_ctx *ctx;" in order to avoid "error: field ‘ctx’ has incomplete type".
由于把结构体修改成了指针, 在vim中替换(libxl/libxl_conf.c):
":1,$s/&\(priv\->ctx\)/\1/gc"


2), libxl_waiter: 
libxl/libxl_conf.h:81: error: expected specifier-qualifier-list before 'libxl_waiter'
cc1: warnings being treated as errors

17:04 2012-02-10
vt-x, vtd(direct IO), pte.
8886449
1, Optiplex 990
19寸. 7500-8000.

2, Precision T3500, W3530, 
19寸, 13000

W3530技术比较旧. 还是得用E5530等比较新的cpu. W3530: 
http://ark.intel.com/products/41313/Intel-Xeon-Processor-W3530-%288M-Cache-2_80-GHz-4_80-GTs-Intel-QPI%29
Intel® Turbo Boost Technology Yes
Intel® Hyper-Threading Technology Yes
Intel® Virtualization Technology (VT-x) Yes
Intel® Trusted Execution Technology No
AES New Instructions No
Intel® 64 Yes
Idle States Yes
Enhanced Intel SpeedStep® Technology Yes
Intel® Demand Based Switching Yes
Thermal Monitoring Technologies No
Execute Disable Bit Yes

18:20 2012-02-10
software, skills, source code managerment tools, svn, hg, git
1, http://www.1uu2.com/archives/992是svn, hg, git命令对照表, 挺实用的. 
2, 如何显示指定版本的修改情况
1), git
http://www.cnblogs.com/flyme/archive/2011/11/28/2265899.html
(1), 用如下命令列出指定文件(src/libxl/libxl_conf.h)的修改情况, 按一行格式列出(--pretty=oneline):
novell@bjz-dev:libvirt> git log --pretty=oneline src/libxl/libxl_conf.h
db0274c9d757555a6dff4ccc24d42abe47b6dfc7 Add domainSave/Restore to libxl driver
648b521e0d004ebc6ba1dab39930c43de68f6a08 Populate domid field of devices for lib
xenlight
f59b71ac575c4daeac08a30ffe67484aca312881 Refactored libxl datastructure instanti
ation
7405aebe0190a8e24a6fb9be0d7bfbb0aac0e075 libxl: Convert to virDomainEventState
60d769a13ac0388472e531919f6de4d77c35a5d3 Remove virConnectPtr from virRaiseError
Full
cbf2717cfd3a44bc1488c57fa39ef1ff9fde9db5 List authors in copyright headers
68e103237867089f90710d46115d678422404f64 Add event callbacks to libxl driver
2b84e445d598894c711278afacfbb9247333bdd8 Add libxenlight driver
(2), 显示指定文件(src/libxl/libxl_conf.h)的提交信息:
novell@bjz-dev:libvirt> git show 7405aebe0190a8e24a6fb9be0d7bfbb0aac0e075 src/libxl/libxl_conf.h
commit 7405aebe0190a8e24a6fb9be0d7bfbb0aac0e075
Author: Cole Robinson <crobinso@redhat.com>
Date:   Thu May 12 10:47:08 2011 -0400

     libxl: Convert to virDomainEventState

diff --git a/src/libxl/libxl_conf.h b/src/libxl/libxl_conf.h
index 8c87786..65110cf 100644
--- a/src/libxl/libxl_conf.h
+++ b/src/libxl/libxl_conf.h
@@ -61,11 +61,7 @@ struct _libxlDriverPrivate {
     virBitmapPtr reservedVNCPorts;
     virDomainObjList domains;

-    /* A list of callbacks */
-    virDomainEventCallbackListPtr domainEventCallbacks;
-    virDomainEventQueuePtr domainEventQueue;
-    int domainEventTimer;
-    int domainEventDispatching;
+    virDomainEventStatePtr domainEventState;

     char *configDir;
     char *autostartDir;
(3), git默认会输出到less(-p, 默认有效), 可以用"--no-pager", 直接输出到当前std. 这样便于脚步处理git的结果. 

2), hg
novell@bjz-dev:xen-unstable.hg> for cs in `hg log tools/libxl/libxl.h | grep changeset | cut -d \:  -f 3`; do echo ${cs}libxl_waiter; hg diff -r ${cs} tools/libxl/libxl.h | grep "libxl_waiter"; done | less

4f3822ee1f43libxl_waiter
b3387ae40371libxl_waiter
-} libxl_waiter;
-int libxl_wait_for_domain_death(libxl_ctx *ctx, uint32_t domid, libxl_waiter *waiter);
-/* waiter is a preallocated array of num_disks libxl_waiter elements */
-int libxl_wait_for_disk_ejects(libxl_ctx *ctx, uint32_t domid, libxl_device_disk *disks, int num_disks, libxl_waiter *waiter);
-int libxl_stop_waiting(libxl_ctx *ctx, libxl_waiter *waiter);
-int libxl_free_waiter(libxl_waiter *waiter);
492914c65838libxl_waiter
-} libxl_waiter;
-int libxl_wait_for_domain_death(libxl_ctx *ctx, uint32_t domid, libxl_waiter *waiter);
-/* waiter is a preallocated array of num_disks libxl_waiter elements */
-int libxl_wait_for_disk_ejects(libxl_ctx *ctx, uint32_t domid, libxl_device_disk *disks, int num_disks, libxl_waiter *waiter);
-int libxl_stop_waiting(libxl_ctx *ctx, libxl_waiter *waiter);
-int libxl_free_waiter(libxl_waiter *waiter);

所以我知道4f3822ee1f43是去掉libxl_waiter的版本. 

2, git和hg比较
Git和Mercurial(Hg)的分析
http://article.yeeyan.org/view/243154/211055

12:38 2012-02-11
时间管理
1, today
1), qemu: install openSUSE12_1 on qemu1.0 windows. see"12:40 2012-02-11".

12:40 2012-02-11
simulator, virtualization, qemu, install openSUSE12_1 on qemu1.0 windows
1, download qemu1.0 windows version
http://virtuallyfun.superglobalmegacorp.com/?p=1627
x86, x86_64 version:
http://vpsland.superglobalmegacorp.com/install/qemu-1.0-i386-x86_64.7z
x86, x86_64 version with the ac97 and es1370 support:
http://vpsland.superglobalmegacorp.com/install/qemu-1.0-i386_x86_64-moresound.7z
other architecture version:
http://vpsland.superglobalmegacorp.com/install/qemu-1.0.7z

2, try qemu-1.0-i386_x86_64-moresound
crash after select installation and load kernel. 
qemu-1.0-i386-x86_64 got the same result.

3, download from
http://lassauge.free.fr/qemu/release/
http://lassauge.free.fr/qemu/
notes: there are qemu 0.15 for windows, but no x86 arch. 0.13 support windows. 

qemu.exe -drive if=ide,cache=writeback,file=k:\Downloads\software\linux\openSUSE-12.1-DVD-i586.iso -L bios -m 512

it is too slow to use it. qemu only use one physical cpu whatever how many cpus it emulate.

18:13 2012-02-11
opensuse, repo, chinese
1, openSUSE12.1国内源:
from: http://hi.baidu.com/ubuntuor/blog/calendar/201201
163-openSUSE-12.1-Update:  http://mirrors.163.com/openSUSE/update/12.1/
163-openSUSE-12.1-Oss:     http://mirrors.163.com/openSUSE/distribution/12.1/repo/oss
163-openSUSE-12.1-Non-Oss: http://mirrors.163.com/openSUSE/distribution/12.1/repo/non-oss
另一篇介绍:http://www.linuxsir.org/bbs/thread381602.html
2, (14:21 2012-06-04)
今天发现163的源文件不全，说是content找不到:
File '/content' not found on medium 'http://mirrors.163.com/openSUSE/distribution/12.1/repo/non-oss'
改成搜狐的源:
Sohu-openSUSE-12.1-Update:  http://mirrors.sohu.com/opensuse/update/12.1/
Sohu-openSUSE-12.1-Oss:     http://mirrors.sohu.com/opensuse/distribution/12.1/repo/oss
Sohu-openSUSE-12.1-Non-Oss: http://mirrors.sohu.com/opensuse/distribution/12.1/repo/non-oss

11:08 2012-02-13
时间管理
0, 10:05

1, today
1), 11:10-18:12 continue to compile xen tools and libvirt. see"11:10 2012-02-13".
2), 1h 午饭, 工会选举, 会议. 
3), vim技巧. see"14:18 2012-02-13".
4), 18:14-19:16 晚饭. 
3), send work report

11:10 2012-02-13
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont4
1, continue to compile libvirt
1), change "libxl_ctx ctx;" to "libxl_ctx *ctx;" in order to avoid "error: field ‘ctx’ has incomplete type".
这个问题上周已经修改了结构体到指针, 但是没有加入malloc. \todo 这个malloc不太好加, 因为没有priv可能都是在栈上分配的, 要不也在栈上加入?

2), libxl_waiter: 
(1), libxl/libxl_conf.h:81: error: expected specifier-qualifier-list before 'libxl_waiter'
cc1: warnings being treated as errors
the command for search the "libxl_waiter" changes:
novell@bjz-dev:xen-unstable.hg> for cs in `hg log tools/libxl/libxl.h | grep changeset | cut -d \:  -f 3`; do echo "${cs}: libxl_waiter"; hg diff -r ${cs} tools/libxl/libxl.h | grep "libxl_waiter"; done
we can found that: 
4f3822ee1f43: libxl_waiter
b3387ae40371: libxl_waiter
-} libxl_waiter;
(2), explore these two revision souce:
novell@bjz-dev:xen-unstable.hg> hg cat -r b3387ae40371 tools/libxl/libxl.h  | l
ess
novell@bjz-dev:xen-unstable.hg> hg cat -r 4f3822ee1f43 tools/libxl/libxl.h  | l
ess
(3), From the revision 4f3822ee1f43 struct has been deleted. check this revision commit log:
novell@bjz-dev:xen-unstable.hg> hg log -r 4f3822ee1f43 -v
changeset:   24598:4f3822ee1f43
user:        Ian Jackson <ian.jackson@eu.citrix.com>
date:        Fri Jan 27 17:01:22 2012 +0000
files:       tools/libxl/libxl.c tools/libxl/libxl.h tools/libxl/libxl_event.c tools/libxl/libxl_event.h tools/libxl/libxl_internal.h tools/libxl/libxl_types.idl tools/libxl/xl_cmdimpl.c tools/ocaml/libs/xl/genwrap.py
description:
libxl: New event generation API

Replace the existing API for retrieving high-level events (events
		about domains, etc.) from libxl with a new one.

This changes the definition and semantics of the `libxl_event'
structure, and replaces the calls for obtaining information about
domain death and disk eject events.

This is an incompatible change, sorry.  The alternative was to try to
provide both the previous horrid API and the new one, and would also
involve never using the name `libxl_event' for the new interface.

The new "libxl_event" structure is blacklisted in the ocaml bindings
for two reasons:
  - It has a field name "type" (which is a keyword in ocaml);
the ocaml idl generator should massage this field name on
output, to "type_" perhaps.
  - The ocaml idl generator does not support KeyedUnion.

Signed-off-by: Ian Jackson <ian.jackson@eu.citrix.com>
Acked-by: Ian Campbell <ian.campbell@citrix.com>
Committed-by: Ian Jackson <Ian.Jackson@eu.citrix.com>

(4), SO, the revision said that this is an INPCOMPATIBLE change. Maybe I should read the souce code to see how to fix these libxl_waiter errors.
reference "14:18 2012-02-13", set hg vimdiff tools. 
开始是去比较xen代码变化情况, 看着有点晕. 后来想一想, 其实关键是修改libvirt使其支持新的xen. 于是看看libvirt里面哪里使用了libxl_waiter, 关键函数其实就是
/*
* Register domain events with libxenlight and insert event handles
* in libvirt's event loop.
*/
static int
libxlCreateDomEvents(virDomainObjPtr vm)
{
	libxlDomainObjPrivatePtr priv = vm->privateData;
	int fd;

	if (VIR_ALLOC(priv->dWaiter) < 0) {
		virReportOOMError();
		return -1;
	}

	if (libxl_wait_for_domain_death(priv->ctx, vm->def->id, priv->dWaiter))
		goto error;

	libxl_get_wait_fd(priv->ctx, &fd);
	if (fd < 0)
		goto error;

	priv->waiterFD = fd;
	/* Add a reference to the domain object while it is injected in
	* the event loop.
	*/
	virDomainObjRef(vm);
	if ((priv->eventHdl = virEventAddHandle(
			fd,
			VIR_EVENT_HANDLE_READABLE | VIR_EVENT_HANDLE_ERROR,
			libxlEventHandler,
			vm, libxlDomainObjUnref)) < 0) {
		ignore_value(virDomainObjUnref(vm));
		goto error;
	}

	return 0;

error:
	libxl_free_waiter(priv->dWaiter);
	VIR_FREE(priv->dWaiter);
	priv->eventHdl = -1;
	return -1;
}

"libxlCreateDomEvents(virDomainObjPtr vm)"函数的里面的"libxl_wait_for_domain_death(priv->ctx, vm->def->id, priv->dWaiter)"如何修改?
这里面: 
if (libxl_wait_for_domain_death(priv->ctx, vm->def->id, priv->dWaiter))
	goto error;

libxl_get_wait_fd(priv->ctx, &fd);
if (fd < 0)
	goto error;
和xen tools/libxl/xl_cmdimpl.c的create_domain(): 
libxl_wait_for_domain_death(ctx, domid, w2);
libxl_get_wait_fd(ctx, &fd);     
很类似. 所以create_domain, 还是要好好看看. 代码关系很紧密阿, 不好看. 

前者其实就是需要给virEventAddHandle提供一个fd. 现在就是不知道该从哪里得到这个fd.

(5), 大概看了看libvirt里面virEventAddHandle及相关函数如何处理传入的fd, 最后也是用poll来做查询. 
现在在看一下去掉libxl_waiter后, xen里面是如何查询事件的. 这样感觉没办法改阿. 
看看libxl_get_wait_fd还有没有其它地方调用: 除了create, 只有shutdown调用. 
按理说, 只是create和shutdown的事情libvirt里面没必要搞这么复杂阿, 其实背靠libvirt的事件处理机制. 修改libvirt里面的事件处理机制肯定不可能. 所以还是需要看清楚怎么能搞出一个fd. 

(6), 看起来要看一下libvirt的create流程? 
libvirt create: virDomainCreate与xen libxc main_create对比. 
virDomainCreate() -> domainCreate(xenapiDomainCreate) -> 
		  -> domainCreate(xenUnifiedDomainCreate) -> 

a, 13   2225  /home/novell/work/source/virtualization/libvirt/libvirt/src/xen/xen_driver.c <<GLOBAL>>
.domainCreate = xenUnifiedDomainCreate,
xenUnifiedDomainCreate -> xenUnifiedDomainCreateWithFlags -> xenDomainCreate():
2   3890  /home/novell/work/source/virtualization/libvirt/libvirt/src/xen/xend_internal.c <<xenDomainCreate>>
.xenDomainCreate = xenDaemonDomainCreate,
xenDaemonDomainCreate -> xend_op: 后面就是通过http给xend发start命令了. 调xend的是否就不是调libxl的了? 暂时跳过. 
3     92  /home/novell/work/source/virtualization/libvirt/libvirt/src/xen/xm_internal.c <<xenDomainCreate>>
.xenDomainCreate = xenXMDomainCreate,
这个最后是调用xend的create命令. 

b, 14   1958  /home/novell/work/source/virtualization/libvirt/libvirt/src/xenapi/xenapi_driver.c <<GLOBAL>>
.domainCreate = xenapiDomainCreate,

-> xenapiDomainCreateWithFlags -> xen_vm_start -> xen_call_ ... 最后似乎是通过curl向server发的消息. 

(7), 不管怎么说, 上面是没有找到和"virEventAddHandle"有关的地方. 返回去重新看一看. 
xenUnifiedOpen -> xenInotifyOpen -> virEventAddHandle

virEventRegisterImpl设置:
addHandleImpl = addHandle;
a, 1   4075  /home/novell/work/source/virtualization/libvirt/libvirt/python/libvirt-override.c <<libvirt_virEventRegisterImpl>>
virEventRegisterImpl(libvirt_virEventAddHandleFunc,
libvirt_virEventRegisterImpl -> libvirt_virEventAddHandleFunc
这个看起来不像是主流程. 

b, 2    213  /home/novell/work/source/virtualization/libvirt/libvirt/src/util/event.c <<virEventRegisterDefaultImpl>>
virEventRegisterImpl(
virEventPollAddHandle -> 

(8), 对比新旧流程
((1)), 旧(b3387ae40371)流程
libxl_wait_for_disk_ejects
libxl_wait_for_domain_death
libxl_get_wait_fd
select
libxl_get_event
((2)), 新(4f3822ee1f43)流程
libxl_evenable_domain_death(ctx, domid, 0, &deathw);
for loop: libxl_evenable_disk_eject(ctx, domid, d_config.disks[i].vdev, 0, &diskws[i]);
domain_wait_event(&event)

11:56 2012-02-13
company, suse发展概况
1, "Alan Gao"mail"2012年SUSE Linux之年".
Hi Team
 
2012年将是SUSE Linux之年！
 
- 众多的大型客户均采用SUSE Linux （工行、人行、国税、气象局、浦发银行、上海证交所、港交所、汇丰银行等等），
- 众多Linux代理商转至SUSE Linux（原红帽中国区总代普华，ACW，联邦软件、东方莱恩、友创天逸、威科姆等等），
- 众多OEM厂商加大SUSE Linux销售（Dell、HP、IBM、曙光、浪潮、联想、宝德等等，尤其是IBM将SUSE Linux作为唯一的Linux合作伙伴），
- 众多国际IT厂商寻求与SUSE Linux合作（Intel、VMware、SAP等等，尤其是VMware的Unix到Linux项目，SUSE Linux是唯一的Linux合作伙伴），
 
2012年， 还是SUSE Linux成立20周年，我们将会有一系列的市场推广活动。例如发布20周年庆典新闻，媒体专访，新Logo发布，各种大型广告，以及9月18-21日在美国佛罗里达奥兰多市举办SUSECon大会等等。
 
在中国，我们从2月份开始在《IT经理世界》杂志刊登SUSE Linux广告，上周五SM接受了4家媒体的专访，从本周起，在CSDN（创立于1999年，是中国最大的中文IT网站）上刊登SUSE Linux Banner广告 （http://bbs.csdn.net/）和成功案例免费下载阅读（http://surveies.csdn.net/survey/comein/389）。
 
2012年将是SUSE Linux之年，我们将在业务上、市场上、品牌上全面击败Redhat！同志们加油！！
 
12:49 2012-02-13
install windows on sles11-sp1
1, qemu crash(both 1.0 and 0.15).
2, virtualBox start failed:
novell@bjz-dev:~> sudo /etc/init.d/vboxdrv setup
Stopping VirtualBox kernel modules                                   done
Uninstalling old VirtualBox DKMS kernel modules                      done
Trying to register the VirtualBox kernel modules using DKMS          failed
(Failed, trying without DKMS)
Recompiling VirtualBox kernel modules^[[A^[[A                        done
Starting VirtualBox kernel modules                                   failed
(Running VirtualBox in a Xen environment is not supported)

Bamvor: it looks like I should not use the Xen environment. 
Reboot sles11 without xen support.

14:18 2012-02-13
software, skill, SCM: hg, extension, hg external diff tools; vim/gvim directory diff tool
1, mercurial(hg) external diff tools:
http://mercurial.selenic.com/wiki/ExtdiffExtension
novell@bjz-dev:~> cat .hgrc
[extensions]
hgext.extdiff =

[extdiff]
cmd.vimdiff = vimdiff
opts.vimdiff =

这样就可以用"hg vimdiff"比较代码。但是vim默认不支持目录比较。 

2, vim/gvim DirDiff for directory diff
http://www.vim.org/scripts/script.php?script_id=102
修改为:
cmd.vimdiff = vim
opts.vimdiff = -f '+next' '+execute "DirDiff" argv(0) argv(1)'
这样就支持目录比较了. 到底是传给了vim什么命令呢? 
知道这个命令就可以用同样方法比较工作日志了. 

1), 自己建立一个vim bash脚本, 可以打印出命令是: 
-f +next +execute "DirDiff" argv(0) argv(1) xen-unstable.hg.b3387ae40371 xen-unstable.hg.4f3822ee1f43
对比".hgrc"脚本, 命令应该是
vim -f +next '+execute "DirDiff" argv(0) argv(1) dir1 dir2'
(11:02 2012-09-13)
所以目录比较命令是:
vim "+DirDiff dir1 dir2"
"11:02 2012-09-13"end

3, PS: vim plugin introduction
http://edyfox.codecarver.org/html/vimplugins.html
http://blog.csdn.net/tge7618291/article/details/4216977

4, vim wiki: a useful html editor: 
http://edyfox.codecarver.org/html/viki.html

5, (14:27 2012-06-01)
summary the changes(diff -up f1 f2):
--- /home/bamvor/.hgrc.old	2012-05-15 11:09:47.637768070 +0800
+++ /home/bamvor/.hgrc	2012-06-01 14:26:21.478662223 +0800
@@ -4,6 +4,7 @@ username = Bamvor Jian Zhang <bjzhang@su
 [extensions]
 mq=
 hgext.patchbomb = 
+hgext.extdiff =
 
 [email]
 method = smtp
@@ -17,4 +18,12 @@ username = bjzhang
 
 [diff]
 showfunc=True
+ 
+[extdiff]
+#cmd.vimdiff = vimdiff
+#opts.vimdiff =
+cmd.vimdiff = vim
+opts.vimdiff = -f '+next' '+execute "DirDiff" argv(0) argv(1)'
+cmd.gvimdiff = gvim
+opts.gvimdiff = -f '+next' '+execute "DirDiff" argv(0) argv(1)'
 
16:57 2012-02-13
uuid, http://www.ietf.org/rfc/rfc4122.txt

19:22 2012-02-13
work report, week 06
1, bamvor jian zhang work report
[devel-server] work report - week 06
[GREEN]
about upstream libvirt compiling problem based on upstream xen-unstable: 
fixed 3 errors. it seem that lots of struct and interface has been changed. 

11:06 2012-02-14
(20:22 2012-02-22)
(17:19 2012-04-11)
(11:00 2012-04-25)
(16:04 2012-08-29)
software, skill, Linux environment setup; vim, bash, link, font, novell software
log/novell/Linux_environment
1, vim
1), cat vimrc >> ~/.vimrc
2), set vim plugin: currently support ctags, cscope for source code explore; DirDiff for directory diff; ".lvimrc" local vim configuration. 
copy plugin to ~/.vim/
copy doc to ~/.vim/

2, bash
1), copy alias to ~/.alias; for alias setting.
right now, ls and grep color alias set. 
2), make sure bashrc including the follow lines:
test -s ~/.alias && . ~/.alias || true
PS1='\[\e]0;\u@\h: \w\a\]${debian_chroot:+($debian_chroot)}\u@\h:\W> '
3), add helper function in "/etc/bash.bashrc", see"09:51 2012-04-25":
1), gdb helper function: launch gdb with process name
2), logAssistant perl script helper function

3, setup short cut for gnome-terminal: reference "10:53 2012-01-29".

4, mount disk and set symbol link
1), mount data disk:
mkdir ~/sda3
sudo /dev/sda3 ~/sda3
2), add the following line to "/etc/fstab"
/dev/disk/by-id/ata-WDC_WD3200AAKS-75L9A0_WD-WCAV2U494851-part3 /home/bamvor/sda3    ext3       acl,user_xattr        1 2
3), create symbol link
ln -s ~/sda3/home/novell/log
ln -s ~/sda3/home/novell/personal
ln -s ~/sda3/home/novell/work
ln -s ~/sda3/home/novell/VirtualBox\ VMs
ln -s ~/sda3/home/novell/xen_vm
ln -s ~/sda3/home/novell/vmware

5, install
1), novell messager client
http://147.2.207.240/packages/groupwise/novell-messenger-client-2.2.0-20101111.i586.rpm
server: im.novell.com
port: 443
2), chrome

6, font setup
1), wenquanyi. 
ref "16:04 2012-04-11".
2), gnome-terminal configuration file: "17:16 2012-04-11". 
3), gvim configuration: "18:00 2012-03-23". 

7, (17:16 2012-05-09)
1), registration, see"13:38 2012-03-16".
2), add sdk repo
http://147.2.207.240/repo/sle-11-sp2-sdk-x86_64-dvd1/
after add sdk repo, i can find cscope, fdupes packages. the latter one is needed by "zypper si libvirt". 

12:00 2012-02-14
时间管理
0, 10:10-22:50

1, today
1), 1h re-install openSUSE12.1 for work.
2), 40' write Linux environment setup doc for myself. see""2), write Linux environment setup doc for myself. see"11:06 2012-02-14".
3), 14:19-19:26 continue to compile xen tools and libvirt. see"14:19 2012-02-14".
其中休息1h.
4), 20:30-22:40 preparing Valentine's Day gift.

14:19 2012-02-14
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont5;software, skill, SCM, hg, search update or changes automatically, 1-3)-(4)-((1))
1, continue
1), from "11:10 2012-02-13": 1-2)-(8)-((3)), 实质是隐藏了fd这个东东. 所以说关键是要把隐藏的东西挖出来. 
(1), figure out how to register event and how to get the event.
((1)), set wait event path:
libxl_evenable_disk_eject -> libxl__ev_xswatch_register
libxl_evenable_domain_death -> libxl__ev_xswatch_register
libxl__ev_xswatch_register -> libxl__ev_fd_isregistere
			   -> libxl__ev_fd_register: set fd to libxl_ctx.watch_efd.fd
			   -> xs_watch
			   -> libxl__set_watch_slot_contents
Here, the fd is get from "xs_fileno(CTX->xsh)":
rc = libxl__ev_fd_register(gc, &CTX->watch_efd, watchfd_callback, xs_fileno(CTX->xsh), POLLIN);

突然有个问题, 现在这个fd和原来的fd管的事情是一样的么? 

((2)), wait and get event path:
domain_wait_event -> libxl_event_wait -> libxl__poller_get
				      -> event_check_internal
				      -> eventloop_iteration

我发现我现在看代码能力很弱阿. 
    LIBXL_LIST_FOREACH(efd, &CTX->efds, entry)
	        REQUIRE_FD(efd->fd, efd->events, efd);

#define LIBXL_LIST_FIRST(head)  ((head)->lh_first)
#define LIBXL_LIST_NEXT(elm, field)     ((elm)->field.le_next)
#define LIBXL_LIST_FOREACH(var, head, field)             \
      for ((var) = LIBXL_LIST_FIRST((head));             \
	  (var);                                         \
	  (var) = LIBXL_LIST_NEXT((var), field))

for( efd = &CTX->efds->lh_first; efd; efd = efd->field.le_next)
所以是set efd->fd到beforepoll_internal传入的fds. 
但是前面libxl__ev_fd_register是set到watch_efd, 这两个还不太一样. 

有种感觉, 如果只是把fd挖出来给libvirt, 感觉不是很符合xen libxl的修改意图. 难道还是要大改libvirt??!?

((3)), 又花时间看了看, libxl, 结论是: 没看明白...
感觉libxl是希望用户用封装好的函数, 所以还是看看libvirt怎么利用新接口把. 
看看virEventAddHandle等几个结构是libvirt libxl接口自己定义的, 还是通用的. 如果是通用的接口, 就很难改了, 就先看看后面的error.
是通用的接口, 这些函数定义在(libvirt/src/util/event.c)
static virEventAddHandleFunc addHandleImpl = NULL;
static virEventUpdateHandleFunc updateHandleImpl = NULL;
static virEventRemoveHandleFunc removeHandleImpl = NULL;
static virEventAddTimeoutFunc addTimeoutImpl = NULL;
static virEventUpdateTimeoutFunc updateTimeoutImpl = NULL;
static virEventRemoveTimeoutFunc removeTimeoutImpl = NULL;
Conclusion: I can not handle this error, just skip it...

2), libxl_init_create_info参数定义变化:
from 
int libxl_init_create_info(libxl_domain_create_info *c_info)
to
int libxl_init_create_info(libxl_ctx *ctx, libxl_domain_create_info *c_info)

libxl/libxl_conf.c: In function 'libxlMakeDomCreateInfo':
libxl/libxl_conf.c:367: error: passing argument 1 of 'libxl_init_create_info' from incompatible pointer type
libxl/libxl_conf.c:367: error: too few arguments to function 'libxl_init_create_info'

call sequence: 
libxlDomainCreate -> libxlDomainCreateWithFlags -> libxlVmStart -> libxlBuildDomainConfig -> libxlMakeDomCreateInfo

libxlMakeDomBuildInfo, libxlMakeDiskList, libxlMakeNicList, libxlMakeVfbList里面也有同样的问题.
((1)), libxlMakeDomBuildInfo
libxl/libxl_conf.c: In function 'libxlMakeDomBuildInfo':
libxl/libxl_conf.c:408: error: passing argument 1 of 'libxl_init_build_info' from incompatible pointer type
libxl/libxl_conf.c:408: error: passing argument 2 of 'libxl_init_build_info' from incompatible pointer type
libxl/libxl_conf.c:408: error: too few arguments to function 'libxl_init_build_info'
((2)), libxlMakeDiskList:
libxl/libxl_conf.c: In function 'libxlMakeDiskList':
libxl/libxl_conf.c:588: error: passing argument 1 of 'libxl_device_disk_destroy' from incompatible pointer type
libxl/libxl_conf.c:588: error: too few arguments to function 'libxl_device_disk_destroy'
\todo: xen libxl和libvirt的domain id是否相同?
((3)), libxlMakeNicList:
libxl/libxl_conf.c: In function 'libxlMakeNicList':
libxl/libxl_conf.c:668: error: passing argument 1 of 'libxl_device_nic_destroy' from incompatible pointer type
libxl/libxl_conf.c:668: error: too few arguments to function 'libxl_device_nic_destroy'
((4)), libxlMakeVfbList:
libxl/libxl_conf.c: In function 'libxlMakeVfbList':
libxl/libxl_conf.c:755: error: passing argument 1 of 'libxl_device_vfb_init' from incompatible pointer type
libxl/libxl_conf.c:755: error: passing argument 2 of 'libxl_device_vfb_init' makes pointer from integer without a cast
libxl/libxl_conf.c:756: error: passing argument 1 of 'libxl_device_vkb_init' from incompatible pointer type
libxl/libxl_conf.c:756: error: passing argument 2 of 'libxl_device_vkb_init' makes pointer from integer without a cast
libxl/libxl_conf.c:770: error: passing argument 1 of 'libxl_device_vfb_destroy' from incompatible pointer type
libxl/libxl_conf.c:770: error: too few arguments to function 'libxl_device_vfb_destroy'
libxl/libxl_conf.c:771: error: passing argument 1 of 'libxl_device_vkb_destroy' from incompatible pointer type
libxl/libxl_conf.c:771: error: too few arguments to function 'libxl_device_vkb_destroy'

3), the definition of libxl_domain_create_info has been changed:
libxl/libxl_conf.c: In function 'libxlMakeDomCreateInfo':
libxl/libxl_conf.c:369: error: 'libxl_domain_create_info' has no member named 'hvm'

hvm is the type, we can see that from do_domain_create()(xen tools/libxl/libxl_create.c):
    libxl__domain_make: "if (info->type == LIBXL_DOMAIN_TYPE_HVM) {"
    if ( d_config->c_info.type == LIBXL_DOMAIN_TYPE_PV && cb ) {            

这个type, 在libxl里面是通过枚举类型得到的. 
typedef enum libxl_domain_type {
	LIBXL_DOMAIN_TYPE_HVM = 1, 
	LIBXL_DOMAIN_TYPE_PV = 2,
} libxl_domain_type;

((1)), libxlMakeDomBuildInfo
libxl/libxl_conf.c: In function 'libxlMakeDomBuildInfo':
libxl/libxl_conf.c:410: error: 'libxl_domain_build_info' has no member named 'hvm'
((2)), libxlMakeDeviceModelInfo
libxl/libxl_conf.c: In function 'libxlMakeDeviceModelInfo':
libxl/libxl_conf.c:829: error: 'libxl_domain_build_info' has no member named 'hvm'

(4), the definition of libxl_domain_create_info_destroy(c_info) was missing!!
libxl/libxl_conf.c: In function 'libxlMakeDomCreateInfo':
libxl/libxl_conf.c:385: error: implicit declaration of function 'libxl_domain_create_info_destroy'
libxl/libxl_conf.c:385: error: nested extern declaration of 'libxl_domain_create_info_destroy' [-Wnested-externs]
libxl/libxl_conf.c: In function 'libxlBuildDomainConfig':
libxl/libxl_conf.c:975: error: implicit declaration of function 'libxl_domain_config_destroy'
libxl/libxl_conf.c:975: error: nested extern declaration of 'libxl_domain_config_destroy' [-Wnested-externs]
((1)), search when and why:
search=libxl_domain_create_info_destroy; for cs in `hg log | grep changeset | cut -d \:  -f 3`; do echo "${cs}: ${search}"; hg diff -r ${cs} | grep ${search}; done
result:
224359634904: libxl_domain_create_info_destroy
03850b265306: libxl_domain_create_info_destroy
-    libxl_domain_create_info_destroy(&d_config->c_info);
((2)), check the commit log:
bamvor@linux-bhi8:xen-unstable.hg_sles11> hg log -v -r 224359634904
changeset:   24016:224359634904
user:        Ian Campbell <ian.campbell@citrix.com>
date:        Tue Oct 18 10:35:55 2011 +0100
files:       tools/libxl/gentest.py tools/libxl/gentypes.py tools/libxl/idl.txt tools/libxl/libxl.c tools/libxl/libxl.h tools/libxl/libxl_cpuid.c tools/libxl/libxl_create.c tools/libxl/libxl_types.idl tools/libxl/libxl_utils.c tools/libxl/libxltypes.py tools/libxl/xl_cmdimpl.c tools/python/genwrap.py tools/python/xen/lowlevel/xl/xl.c
description:
libxl: idl: use "dispose" rather than "destroy" for function to free IDL types

Destroy is an overloaded term which would commonly like to be used for actual
destructive operations, such as destroying a domain etc.

Dispose isn't a great term but it does the job.

Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
Acked-by: Ian Jackson <ian.jackson.citrix.com>
Committed-by: Ian Jackson <ian.jackson.citrix.com>
((3)), hg diff -r 03850b265306 | less
search "libxl_domain_create_info_destroy":
diff -r 03850b265306 tools/libxl/libxl_create.c
-void libxl_domain_config_destroy(libxl_domain_config *d_config)
+void libxl_domain_config_dispose(libxl_domain_config *d_config)
-    libxl_domain_create_info_destroy(&d_config->c_info);
-    libxl_domain_build_info_destroy(&d_config->b_info);
-    libxl_device_model_info_destroy(&d_config->dm_info);
+    libxl_domain_create_info_dispose(&d_config->c_info);
+    libxl_domain_build_info_dispose(&d_config->b_info);
看起来这个函数是生成出来的(gentypes.py?). 
libxl_domain_create_info_destroy修改为libxl_domain_create_info_dispose. \todo 没有确认这两个函数是否完全等价.

((4)), same error:
libxl/libxl_conf.c: In function 'libxlMakeDomBuildInfo':
libxl/libxl_conf.c:489: error: implicit declaration of function 'libxl_domain_build_info_destroy'
libxl/libxl_conf.c:489: error: nested extern declaration of 'libxl_domain_build_info_destroy' [-Wnested-externs]

09:30 2012-02-15
时间管理
0, 9:15

1, today
1), 9:42-10:58 xen/devel-server maiilist. see"09:48 2012-02-15"
2), 10:59-11:53 15:38- continue to compile xen tools and libvirt. see"10:59 2012-02-15"
3), 给Chenzi Cao发我的照片; 收集同事资料. see"11:24 2012-02-15".
4), 11:53-13:08 吃饭.

09:48 2012-02-15
virtualization, suse, xen, maillist, xen-devel; devel-server
1, xen
1), keep an eye on: Google Summer of Code. \todo
http://lists.xen.org/archives/html/xen-devel/2012-02/msg00834.html
2), Pay attention to "libxl - Remus support"
http://lists.xen.org/archives/html/xen-devel/2012-02/msg00810.html
\todo search Remus
3), libxl: "amd iommu: support ats/gpgpu passthru on iommuv2 systems"
http://lists.xen.org/archives/html/xen-devel/2012-02/msg00889.html
It includes all pending patches that are needed to enable 
gpgpu passthrough and heterogeneous computing in guest OSes. Basically, this 
patch set gives guest VM the same capability of running openCL applications on 
amd platforms as native OSes. Upstream Linux 3.3 rc2 with amd iommuv2 kernel 
driver has been tested well as guest OS
4), RFC: Automatically adjust dom0 weight
http://lists.xen.org/archives/html/xen-devel/2012-02/msg00680.html
5), cdrom support in xen domU. "how to display the xenstore debug message"
got the following link from xen's maillist:
http://xen.1045712.n5.nabble.com/Cdrom-on-Linux-domU-PV-td5460198.html#a5466814
It(cdrom in domU) should be(work). Please can you provide the output of "xenstore-ls -fp" 
when the guest is running with the device attached. 

Also from within the guest can you run (as root): 
udevadm info --query=all --path /block/xvdb 
and post the output. 

2, devel-server
learn from others work report
1), GaoYan
(1), "[devel-server] Work report (week 6 - 20120210)"
[red]
[amber]
[green]
- Pacemaker:
* More validations on configurations related to resource templates::
Code merged upstream with some logging tweaks.
* Wrote up the documentation "Utilization and Placement Strategy".
Posted to pacemaker ML for review
* Converted the documentation "Resource templates" to asciidoc format.
* Been writing documentation "Cluster Ticket".
- Helped diagnose bnc#743666 - L3-Question: can't start Master/Slave SAP
ERS/ASC resource on HAESP1
- Submitted fixes of pacemaker for the next HAE SLE11SP1 maintenance update.
- bnc#738043 - crm_gui: Remote node did not respond
WORKSFORME. Closed.

Regards,
Gao,Yan
-- 
Gao,Yan <ygao@suse.com>
Software Engineer
China Server Team, SUSE.

(2), notes:
use different verb tense for the report:
((1)), "simple past" for the finished work.
((2)), "persent perfect continuous" for the work "doing but not finished". (I guess".
((3)), verb tense referece: "http://www.englishpage.com/verbpage/verbtenseintro.html". (英语学习网站, 动词时态)

10:59 2012-02-15
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont6
1, continue
1), bootloader_args type change:
libxl/libxl_conf.c: In function 'libxlMakeDomBuildInfo':
libxl/libxl_conf.c:459: error: assignment from incompatible pointer type
((1)), source code:
libvirt: src/conf/domain_conf.h
char *bootloaderArgs;
xen: tools/libxl/_libxl_types.h
libxl_string_list bootloader_args;
tools/libxl/libxl.h
typedef char **libxl_string_list;
((2)), it looks like i need to convert from "char *" to "char **"?
copy parse_cmdline and get_str from qemu monitor.c

2), libxl_domain_build_info has been changed.
libxl/libxl_conf.c: In function 'libxlMakeDomBuildInfo':
libxl/libxl_conf.c:472: error: 'libxl_domain_build_info' has no member named 'kernel'
libxl/libxl_conf.c:472: error: 'libxl_domain_build_info' has no member named 'kernel'
libxl/libxl_conf.c:473: error: 'libxl_domain_build_info' has no member named 'kernel'
((1)), 原来是'libxlMakeDomBuildInfo'里面有"libxl_file_reference kernel;", 现在只是在pv里面有"libxl_file_reference kernel;" 
I guess there is no need to pass kernel to hvm. So, using pv.kernel instead.

3), 'DISK_FORMAT_QCOW' undeclared:
libxl/libxl_conf.c: In function 'libxlMakeDisk':
libxl/libxl_conf.c:512: error: 'DISK_FORMAT_QCOW' undeclared (first use in this function)
libxl/libxl_conf.c:512: error: (Each undeclared identifier is reported only once
libxl/libxl_conf.c:512: error: for each function it appears in.)
libxl/libxl_conf.c:515: error: 'DISK_FORMAT_QCOW2' undeclared (first use in this function)
libxl/libxl_conf.c:518: error: 'DISK_FORMAT_VHD' undeclared (first use in this function)
libxl/libxl_conf.c:522: error: 'DISK_FORMAT_RAW' undeclared (first use in this function)
libxl/libxl_conf.c:513: error: 'DISK_BACKEND_QDISK' undeclared (first use in this function)
libxl/libxl_conf.c:519: error: 'DISK_BACKEND_TAP' undeclared (first use in this function)
libxl/libxl_conf.c:535: error: 'DISK_BACKEND_PHY' undeclared (first use in this function)
libxl/libxl_conf.c: In function 'libxlMakeNic':
libxl/libxl_conf.c:608: error: 'NICTYPE_IOEMU' undeclared (first use in this function)
libxl/libxl_conf.c:610: error: 'NICTYPE_VIF' undeclared (first use in this function)
((1)), old: libxl.h
typedef enum {
	DISK_FORMAT_UNKNOWN = 0,
	DISK_FORMAT_QCOW,
	DISK_FORMAT_QCOW2,
	DISK_FORMAT_VHD,
	DISK_FORMAT_RAW,
	DISK_FORMAT_EMPTY,
} libxl_disk_format;
new, _libxl_types.h: 
typedef enum libxl_disk_format {
	LIBXL_DISK_FORMAT_UNKNOWN = 0,
	LIBXL_DISK_FORMAT_QCOW = 1,
	LIBXL_DISK_FORMAT_QCOW2 = 2,
	LIBXL_DISK_FORMAT_VHD = 3,
	LIBXL_DISK_FORMAT_RAW = 4,
	LIBXL_DISK_FORMAT_EMPTY = 5,
} libxl_disk_format;

4), change from unpluggable to removable(I guess)
libxl/libxl_conf.c: In function 'libxlMakeDisk':
ibxl/libxl_conf.c:549: error: 'libxl_device_disk' has no member named 'unpluggable'

5), domid may be not used in libxl_device_disk, libxl_device_nic,
libxl/libxl_conf.c: In function 'libxlMakeDisk':
libxl/libxl_conf.c:558: error: 'libxl_device_disk' has no member named 'domid'
libxl/libxl_conf.c: In function 'libxlMakeNic':
libxl/libxl_conf.c:600: error: 'libxl_device_nic' has no member named 'domid'
libxl/libxl_conf.c: In function 'libxlMakeVfb':
libxl/libxl_conf.c:727: error: 'libxl_device_vfb' has no member named 'domid'

6), libxl_device_vfb definition changed:
libxl/libxl_conf.c: In function 'libxlMakeVfb':
libxl/libxl_conf.c:682: error: incompatible types in assignment
libxl/libxl_conf.c:684: error: 'libxl_device_vfb' has no member named 'display'
libxl/libxl_conf.c:689: error: 'libxl_device_vfb' has no member named 'xauthority'
libxl/libxl_conf.c:696: error: incompatible types in assignment
libxl/libxl_conf.c:698: error: 'libxl_device_vfb' has no member named 'vncunused'
libxl/libxl_conf.c:708: error: 'libxl_device_vfb' has no member named 'vncdisplay'
libxl/libxl_conf.c:713: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:713: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:714: error: 'libxl_device_vfb' has no member named 'vnclisten'

16:26 2012-02-15
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont7
1, re-compile xen
make world
1), seabios is not found while the first compile
make[6]: Entering directory `/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg/tools/firmware/seabios-dir'
make[6]: *** No rule to make target `clean'.  Stop.

So, add a fake seabios Makefile for "make clean" temperary.
tools/firmware:
bamvor@linux-bhi8:firmware> diff Makefile Makefile.bak0215_1623
37,45c37
< clean: seabios_create_tmp subdirs-clean seabios_delete_tmp
<
< seabios_create_tmp:
<       mkdir seabios-dir -p
<       echo "clean:" > seabios-dir/Makefile
<
< seabios_delete_tmp:
<       rm seabios-dir/Makefile
<       rmdir seabios-dir
---
> clean: clean

11:24 2012-02-15
company, colleague, information
1, 曹晨子
chcao@novell.com
report to Gracie Guo
北京office的SUSE R&D 组织结构图制作者.

2, 黄婷婷
TingTing Huang
THuang@novell.com
(86-10)6533 9001/9000
(86)15120021501

report to Gracie Guo
中国区同事的联系表制作者.

3, 工会
(1)郭晓昕(Gracie Guo)参选工会主席
(1)魏超(Charles Wei)同志参选工会副主席
(2)王欣(Xin Wang)同志参选工会副主席

11:24 2012-02-16
时间管理
0, 11:00

1, today
1), 13:54-16;36 continue to compile xen tools and libvirt. see"11:25 2012-02-16"
20' sleep
2), 11:30-12:40 午饭.
3), 12:30-13:52 weibo: 痛恨假的捐款微博; 感动: 《一个人的西藏》.
4), 16:40-17:36 活动, weibo. 
5), 17:36-18:54 21:12-22:50 write libvirt libxl_conf.c patch mail. see"18:54 2012-02-16"
20' sleep

11:25 2012-02-16
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont8
1, continue to compile libvirt. fix error in libxl_conf.c
1), continue: libxl_device_vfb definition change:
libxl/libxl_conf.c: In function 'libxlMakeDeviceModelInfo':
libxl/libxl_conf.c:871: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:874: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:874: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:874: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:874: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:874: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:874: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:874: error: 'libxl_device_vfb' has no member named 'vnclisten'
libxl/libxl_conf.c:884: error: 'libxl_device_vfb' has no member named 'vncdisplay'
libxl/libxl_conf.c:885: error: 'libxl_device_vfb' has no member named 'vncpasswd'
libxl/libxl_conf.c:887: error: 'libxl_device_vfb' has no member named 'vncpasswd'
libxl/libxl_conf.c:887: error: 'libxl_device_vfb' has no member named 'vncpasswd'
libxl/libxl_conf.c:887: error: 'libxl_device_vfb' has no member named 'vncpasswd'
libxl/libxl_conf.c:887: error: 'libxl_device_vfb' has no member named 'vncpasswd'
libxl/libxl_conf.c:887: error: 'libxl_device_vfb' has no member named 'vncpasswd'
libxl/libxl_conf.c:887: error: 'libxl_device_vfb' has no member named 'vncpasswd'
libxl/libxl_conf.c:887: error: 'libxl_device_vfb' has no member named 'vncpasswd'

2), 'libxl_device_model_info' not definied:
libxl/libxl_conf.c: In function 'libxlMakeDeviceModelInfo':
libxl/libxl_conf.c:823: error: 'libxl_device_model_info' undeclared (first use in this function)
libxl/libxl_conf.c:823: error: 'dm_info' undeclared (first use in this function)
libxl/libxl_conf.c:823: error: 'libxl_domain_config' has no member named 'dm_info'
libxl/libxl_conf.c:827: error: implicit declaration of function 'libxl_init_dm_info'
libxl/libxl_conf.c:827: error: nested extern declaration of 'libxl_init_dm_info' [-Wnested-externs]
libxl/libxl_conf.c:831: error: 'XENFV' undeclared (first use in this function)
libxl/libxl_conf.c:862: error: 'XENPV' undeclared (first use in this function)
libxl/libxl_conf.c:867: error: used struct type value where scalar is required
libxl/libxl_conf.c:891: error: used struct type value where scalar is required
libxl/libxl_conf.c:908: error: implicit declaration of function 'libxl_device_model_info_destroy'
libxl/libxl_conf.c:908: error: nested extern declaration of 'libxl_device_model_info_destroy' [-Wnested-externs]

compare the parse_config_data()(xl_cmdimpl.c) and other file. i can see that the libxl_device_model_info is not used in current libxl. part of it functions are replace by b_info(libxl_domain_build_info) which is set in (libxlMakeDomBuildInfo from libxlBuildDomainConfig. So the 'libxlMakeDeviceModelInfo' can be deleted.
((1)), compare whether all the variable in the libxl_device_model_info are contain in libxl_domian_build_info.
type(for pv and hvm), boot and serial(only for hvm) is set by virDomainDefPtr.
((2)), serial and boot can be found in libxl_domain_build_info.u.hvm, but not set during libxlMakeDomBuildInfo process.
add it.
((3)), type: this is a memory type for qemu.
in the old function(libxl_build_device_model_args_old)
if (info->type == XENPV)
	flexarray_append(dm_args, "xenpv");
else
	flexarray_append(dm_args, "xenfv");

in the new function(libxl__build_device_model_args_old), use libxl_domain_build_info.type to set xenpv or xenfv.
switch (b_info->type) {
	case LIBXL_DOMAIN_TYPE_PV:
		flexarray_append(dm_args, "xenpv");
		for (i = 0; b_info->extra_pv && b_info->extra_pv[i] != NULL; i++)
		flexarray_append(dm_args, b_info->extra_pv[i]);
		break;
	case LIBXL_DOMAIN_TYPE_HVM:
		flexarray_append(dm_args, "xenfv");
		for (i = 0; b_info->extra_hvm && b_info->extra_hvm[i] != NULL; i++)
		flexarray_append(dm_args, b_info->extra_hvm[i]);
		break;
}

So, I can safely delete "dm_info->type = XENFV;" and "dm_info->type = XENPV;".

3), Ok, I fix all the errors in libxl_conf.c except libxl_waiter

make[3]: *** [libvirt_driver_libxl_la-libxl_conf.lo] Error 1
make[3]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt/src'
make[2]: *** [all] Error 2
make[2]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt/src'
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt'
make: *** [all] Error 2

4), compile. fix some small error in libxl_conf.c, finally, libxl_conf.c compile pass. there are lots of error in libxl_driver.c

5), write the patch and mail it.

18:04 2012-02-16
libvirt maillist archieve is openPGP format. 
openPGP
http://www.openpgp.org/index.shtml
gnupg
http://www.gnupg.org/download/index.en.html
 
18:54 2012-02-16
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont9
1, write libvirt libxl_conf.c patch mail. 
1), read my work log.
2), mail
(1), Subject: [libvirt] [PATCH 0/5] libxl driver(libxl_conf.c) backward-compatible

Jim wrote:
>Yeah, the upstream folks have problems maintaining a backward-compatible
>API :-(.  Hopefully the latest restructure of libxl will change that.
>We'll need to add support in the libvirt libxl driver for current
>upstream libxl, taking care not to break the driver when it is used with
>libxl in Xen 4.1.x.  Perhaps this is something Bamvor can begin
>investigating.

In the recent weeks, I worked on the compile errors in libvirt and xen upstream. Right now, I modified all the errors in the file libxl_conf.c(src/libxl/) except one.
the following emails records how and why i modified the code. 

Some modification may be not proper just for compiling pass. I wanted to know whether there are some "big" error in the others code. after fix all the libxl driver errors, I plan to review all the modification.

There is a compile error about event communication in libvirt and xen, I can not fix it right now. You can get the details in [PATCH 03]. 

affected files: xen/tools/libxl/Makefile, libvirt/src/libxl/libxl_conf.h, libvirt/src/libxl/libxl_conf.c

(2), Subject: [libvirt] [PATCH 1/5] libxl driver(libxl_conf.c) backward-compatible

libxl_event.h in xen is needed by libxl.h. The latter one is needed by libvirt libxl driver, So, I add libxl_event.h in the install files.

diff -r 3574f4d67843 tools/libxl/Makefile
--- a/tools/libxl/Makefile      Mon Feb 06 13:23:41 2012 -0800
+++ b/tools/libxl/Makefile      Thu Feb 16 21:53:45 2012 +0800
@@ -163,7 +163,7 @@
        ln -sf libxlutil.so.$(XLUMAJOR).$(XLUMINOR) $(DESTDIR)$(LIBDIR)/libxlutil.so.$(XLUMAJOR)
        ln -sf libxlutil.so.$(XLUMAJOR) $(DESTDIR)$(LIBDIR)/libxlutil.so
$(INSTALL_DATA) libxlutil.a $(DESTDIR)$(LIBDIR)
-       $(INSTALL_DATA) libxl.h libxl_json.h _libxl_types.h _libxl_types_json.h _libxl_list.h libxl_utils.h libxl_uuid.h $(DESTDIR)$(INCLUDEDIR)
+       $(INSTALL_DATA) libxl.h libxl_json.h _libxl_types.h _libxl_types_json.h _libxl_list.h libxl_utils.h libxl_uuid.h libxl_event.h $(DESTDIR)$(INCLUDEDIR)
        $(INSTALL_DATA) bash-completion $(DESTDIR)$(BASH_COMPLETION_DIR)/xl.sh

(3), Subject: [libvirt] [PATCH 2/5] libxl driver(libxl_conf.c) backward-compatible

the "<xen/sysctl.h>" is included in "libxl.h" in upstream. So, __XEN__ and __XEN_TOOLS__ are needed to add while compiled the code of libvirt libxl driver. 
But I had no idea where to add it. SO, just add at the beginning of the libxl_conf.c

@@ -26,6 +26,8 @@
 #include <config.h>

 #include <regex.h>
+#define __XEN__
+#define __XEN_TOOLS__
 #include <libxl.h>
 #include <sys/types.h>
 #include <sys/socket.h>
@@ -42,6 +44,7 @@
 #include "libxl_driver.h"
 #include "libxl_conf.h"

(4), Subject: [libvirt] [PATCH 3/5] libxl driver(libxl_conf.c) backward-compatible

modifed libxl_conf.h

a, the definition of libxl_ctx had been changed. The REAL definition of libxl_ctx is hided in the internal of xen. 
So, I changed the struct to struct pointer. But I do not add the alloc function for the pointer, I will add it later. 

b, add libxl_waiter. Actual, the event machanism of xen had beed changed. Xen not provides the file descriptor the upper software event polling. But in the libvirt, all the event channel is maintain by the virEventxxxHandlerFunc throw the ffile descriptor. It is hard for me to do this backward. I will figure it out later.

c, remove "virDomainDefPtr def" from the following functions: libxlMakeDisk, libxlMakeNic, libxlMakeVfb. In the old code, virDomainDefPtr only provided domid in these functions. But in the upsteam code, the domid is not used in the coropending struct.

diff --git a/src/libxl/libxl_conf.h b/src/libxl/libxl_conf.h
index 2820afb..f4b1ae5 100644
--- a/src/libxl/libxl_conf.h
+++ b/src/libxl/libxl_conf.h
@@ -36,7 +36,6 @@
 # include "configmake.h"
 # include "bitmap.h"
 
-
 # define LIBXL_VNC_PORT_MIN  5900
 # define LIBXL_VNC_PORT_MAX  65535
 
@@ -58,7 +57,7 @@ struct _libxlDriverPrivate {
     FILE *logger_file;
     xentoollog_logger *logger;
     /* libxl ctx for driver wide ops; getVersion, getNodeInfo, ... */
-    libxl_ctx ctx;
+    libxl_ctx *ctx;
 
     virBitmapPtr reservedVNCPorts;
     virDomainObjList domains;
@@ -75,9 +74,15 @@ struct _libxlDriverPrivate {
 
 typedef struct _libxlDomainObjPrivate libxlDomainObjPrivate;
 typedef libxlDomainObjPrivate *libxlDomainObjPrivatePtr;
+
+typedef struct {
+    char *path;
+    char *token;
+} libxl_waiter;
+
 struct _libxlDomainObjPrivate {
     /* per domain libxl ctx */
-    libxl_ctx ctx;
+    libxl_ctx *ctx;
     libxl_waiter *dWaiter;
     int waiterFD;
     int eventHdl;
@@ -104,13 +109,11 @@ virCapsPtr
 libxlMakeCapabilities(libxl_ctx *ctx);
 
 int
-libxlMakeDisk(virDomainDefPtr def, virDomainDiskDefPtr l_dev,
-              libxl_device_disk *x_dev);
+libxlMakeDisk(virDomainDiskDefPtr l_dev, libxl_device_disk *x_dev);
 int
-libxlMakeNic(virDomainDefPtr def, virDomainNetDefPtr l_nic,
-             libxl_device_nic *x_nic);
+libxlMakeNic(virDomainNetDefPtr l_nic, libxl_device_nic *x_nic);
 int
-libxlMakeVfb(libxlDriverPrivatePtr driver, virDomainDefPtr def,
+libxlMakeVfb(libxlDriverPrivatePtr driver, 
              virDomainGraphicsDefPtr l_vfb, libxl_device_vfb *x_vfb);
 
 int
@@ -118,3 +121,4 @@ libxlBuildDomainConfig(libxlDriverPrivatePtr driver,
                        virDomainDefPtr def, libxl_domain_config *d_config);
 
 #endif /* LIBXL_CONF_H */
+

(5), Subject: [libvirt] [PATCH 4/5] libxl driver(libxl_conf.c) backward-compatible

the definition of libxl_domain_config.os.bootloaderArgs had been changed from "char *" to "char **". So, I added a converted function parse_cmdline(copy from qemu monitor.c, not test yes). 

diff --git a/src/libxl/libxl_conf.c b/src/libxl/libxl_conf.c
index 62621f1..d69da75 100644
--- a/src/libxl/libxl_conf.c
+++ b/src/libxl/libxl_conf.c
@@ -42,6 +44,7 @@
 #include "libxl_driver.h"
 #include "libxl_conf.h"
 
+#include <ctype.h>	//for isspace, used by get_str and parse_cmdline
 
 #define VIR_FROM_THIS VIR_FROM_LIBXL
 
@@ -384,6 +387,100 @@ error:
     return -1;
 }
 
+//copy from qemu monitor.c: start
+//TODO: there is a limit in MAX_ARGS and buf. FIXME.
+#define MAX_ARGS 16
+static int get_str(char *buf, int buf_size, const char **pp)
+{
+    const char *p;
+    char *q;
+    int c;
+
+    q = buf;
+    p = *pp;
+    while (isspace(*p))
+        p++;
+    if (*p == '\0') {
+    fail:
+        *q = '\0';
+        *pp = p;
+        return -1;
+    }
+    if (*p == '\"') {
+        p++;
+        while (*p != '\0' && *p != '\"') {
+            if (*p == '\\') {
+                p++;
+                c = *p++;
+                switch(c) {
+                case 'n':
+                    c = '\n';
+                    break;
+                case 'r':
+                    c = '\r';
+                    break;
+                case '\\':
+                case '\'':
+                case '\"':
+                    break;
+                default:
+                    //("unsupported escape code: '\\%c'\n", c);
+                    goto fail;
+                }
+                if ((q - buf) < buf_size - 1) {
+                    *q++ = c;
+                }
+            } else {
+                if ((q - buf) < buf_size - 1) {
+                    *q++ = *p;
+                }
+                p++;
+            }
+        }
+        if (*p != '\"') {
+            //("unterminated string\n");
+            goto fail;
+        }
+        p++;
+    } else {
+        while (*p != '\0' && !isspace(*p)) {
+            if ((q - buf) < buf_size - 1) {
+                *q++ = *p;
+            }
+            p++;
+        }
+    }
+    *q = '\0';
+    *pp = p;
+    return 0;
+}
+
+//bootloader_args ends with NULL string
+static void parse_cmdline(const char *cmdline, char **args)
+{
+    const char *p;
+    int nb_args, ret;
+    char buf[1024];
+
+    p = cmdline;
+    nb_args = 0;
+    for(;;) {
+        while (isspace(*p))
+            p++;
+        if (*p == '\0')
+            break;
+        if (nb_args >= MAX_ARGS)
+            break;
+        ret = get_str(buf, sizeof(buf), &p);
+        args[nb_args] = strdup(buf);
+        nb_args++;
+        if (ret < 0)
+            break;
+    }
+    args[nb_args] = NULL;
+}
+//copy from qemu monitor.c: end
+
 static int
 libxlMakeDomBuildInfo(virDomainDefPtr def, libxl_domain_config *d_config)
 {
@@ -454,7 +551,8 @@ libxlMakeDomBuildInfo(virDomainDefPtr def, libxl_domain_config *d_config)
             }
         }
         if (def->os.bootloaderArgs) {
-            if ((b_info->u.pv.bootloader_args = strdup(def->os.bootloaderArgs)) == NULL) {
+            parse_cmdline(def->os.bootloaderArgs, b_info->u.pv.bootloader_args);
+            if ( b_info->u.pv.bootloader_args == NULL) {
                 virReportOOMError();
                 goto error;
             }

(6), Subject: [libvirt] [PATCH 5/5] libxl driver(libxl_conf.c) backward-compatible

the function or struct argument had beed changed. 

diff --git a/src/libxl/libxl_conf.c b/src/libxl/libxl_conf.c
index 62621f1..9f7c3bd 100644
--- a/src/libxl/libxl_conf.c
+++ b/src/libxl/libxl_conf.c
@@ -26,6 +26,8 @@
 
 
 #define VIR_FROM_THIS VIR_FROM_LIBXL
 
@@ -358,13 +360,13 @@ libxlMakeCapabilitiesInternal(const char *hostmachine,
 }
 
 static int
-libxlMakeDomCreateInfo(virDomainDefPtr def, libxl_domain_create_info *c_info)
+libxlMakeDomCreateInfo(libxlDriverPrivatePtr driver, virDomainDefPtr def, libxl_domain_create_info *c_info)
 {
     char uuidstr[VIR_UUID_STRING_BUFLEN];
 
-    libxl_init_create_info(c_info);
+    libxl_init_create_info(driver->ctx, c_info);
 
-    c_info->hvm = STREQ(def->os.type, "hvm");
+    c_info->type = STREQ(def->os.type, "hvm") ? LIBXL_DOMAIN_TYPE_HVM : LIBXL_DOMAIN_TYPE_PV;
     if ((c_info->name = strdup(def->name)) == NULL) {
         virReportOOMError();
         goto error;
@@ -380,16 +382,153 @@ libxlMakeDomCreateInfo(virDomainDefPtr def, libxl_domain_create_info *c_info)
     return 0;
 
 error:
-    libxl_domain_create_info_destroy(c_info);
+    libxl_domain_create_info_dispose(c_info);
     return -1;
 }
 

 static int
-libxlMakeDomBuildInfo(virDomainDefPtr def, libxl_domain_config *d_config)
+libxlMakeChrdevStr(virDomainChrDefPtr def, char **buf)
+{
+    const char *type = virDomainChrTypeToString(def->source.type);
+
+    if (!type) {
+        libxlError(VIR_ERR_INTERNAL_ERROR,
+                   "%s", _("unexpected chr device type"));
+        return -1;
+    }
+
+    switch (def->source.type) {
+        case VIR_DOMAIN_CHR_TYPE_NULL:
+        case VIR_DOMAIN_CHR_TYPE_STDIO:
+        case VIR_DOMAIN_CHR_TYPE_VC:
+        case VIR_DOMAIN_CHR_TYPE_PTY:
+            if (virAsprintf(buf, "%s", type) < 0) {
+                virReportOOMError();
+                return -1;
+            }
+            break;
+
+        case VIR_DOMAIN_CHR_TYPE_FILE:
+        case VIR_DOMAIN_CHR_TYPE_PIPE:
+            if (virAsprintf(buf, "%s:%s", type,
+                            def->source.data.file.path) < 0) {
+                virReportOOMError();
+                return -1;
+            }
+            break;
+
+        case VIR_DOMAIN_CHR_TYPE_DEV:
+            if (virAsprintf(buf, "%s", def->source.data.file.path) < 0) {
+                virReportOOMError();
+                return -1;
+            }
+            break;
+    }
+
+    return 0;
+}
+
+static int
+libxlMakeDomBuildInfo(libxlDriverPrivatePtr driver, virDomainDefPtr def, libxl_domain_config *d_config)
 {
     libxl_domain_build_info *b_info = &d_config->b_info;
     int hvm = STREQ(def->os.type, "hvm");
     int i;
+    char b_order[VIR_DOMAIN_BOOT_LAST+1];
 
     /* Currently, libxenlight only supports 32 vcpus per domain.
      * cur_vcpus member of struct libxl_domain_build_info is defined
@@ -403,9 +542,9 @@ libxlMakeDomBuildInfo(virDomainDefPtr def, libxl_domain_config *d_config)
         return -1;
     }
 
-    libxl_init_build_info(b_info, &d_config->c_info);
+    libxl_init_build_info(driver->ctx, b_info, &d_config->c_info);
 
-    b_info->hvm = hvm;
+    b_info->type = hvm ? LIBXL_DOMAIN_TYPE_HVM : LIBXL_DOMAIN_TYPE_PV;
     b_info->max_vcpus = def->maxvcpus;
     if (def->vcpus == 32)
         b_info->cur_vcpus = (uint32_t) -1;
@@ -446,6 +585,34 @@ libxlMakeDomBuildInfo(virDomainDefPtr def, libxl_domain_config *d_config)
          */
         b_info->shadow_memkb = 4 * (256 * b_info->cur_vcpus +
                                     2 * (b_info->max_memkb / 1024));
+        if (def->os.nBootDevs > 0) {
+            VIR_FREE(b_info->u.hvm.boot);
+            for (i = 0; i < def->os.nBootDevs; i++) {
+                switch (def->os.bootDevs[i]) {
+                    case VIR_DOMAIN_BOOT_FLOPPY:
+                        b_order[i] = 'a';
+                        break;
+                    default:
+                    case VIR_DOMAIN_BOOT_DISK:
+                        b_order[i] = 'c';
+                        break;
+                    case VIR_DOMAIN_BOOT_CDROM:
+                        b_order[i] = 'd';
+                        break;
+                    case VIR_DOMAIN_BOOT_NET:
+                        b_order[i] = 'n';
+                        break;
+                }
+            }
+            b_order[def->os.nBootDevs] = '\0';
+            if ((b_info->u.hvm.boot = strdup(b_order)) == NULL) {
+                virReportOOMError();
+                goto error;
+            }
+        }
+        if (def->serials &&
+            (libxlMakeChrdevStr(def->serials[0], &b_info->u.hvm.serial) < 0))
+            goto error;
     } else {
         if (def->os.bootloader) {
             if ((b_info->u.pv.bootloader = strdup(def->os.bootloader)) == NULL) {
@@ -454,7 +621,8 @@ libxlMakeDomBuildInfo(virDomainDefPtr def, libxl_domain_config *d_config)
             }
         }
         if (def->os.bootloaderArgs) {
+            if ( b_info->u.pv.bootloader_args == NULL) {
                 virReportOOMError();
                 goto error;
             }
@@ -467,8 +635,8 @@ libxlMakeDomBuildInfo(virDomainDefPtr def, libxl_domain_config *d_config)
         }
         if (def->os.kernel) {
             /* libxl_init_build_info() sets kernel.path = strdup("hvmloader") */
-            VIR_FREE(b_info->kernel.path);
-            if ((b_info->kernel.path = strdup(def->os.kernel)) == NULL) {
+            VIR_FREE(b_info->u.pv.kernel.path);
+            if ((b_info->u.pv.kernel.path = strdup(def->os.kernel)) == NULL) {
                 virReportOOMError();
                 goto error;
             }
@@ -484,13 +652,12 @@ libxlMakeDomBuildInfo(virDomainDefPtr def, libxl_domain_config *d_config)
     return 0;
 
 error:
-    libxl_domain_build_info_destroy(b_info);
+    libxl_domain_build_info_dispose(b_info);
     return -1;
 }
 
 int
-libxlMakeDisk(virDomainDefPtr def, virDomainDiskDefPtr l_disk,
-              libxl_device_disk *x_disk)
+libxlMakeDisk(virDomainDiskDefPtr l_disk, libxl_device_disk *x_disk)
 {
     if (l_disk->src && (x_disk->pdev_path = strdup(l_disk->src)) == NULL) {
         virReportOOMError();
@@ -507,30 +674,30 @@ libxlMakeDisk(virDomainDefPtr def, virDomainDiskDefPtr l_disk,
             STREQ(l_disk->driverName, "tap2")) {
             if (l_disk->driverType) {
                 if (STREQ(l_disk->driverType, "qcow")) {
-                    x_disk->format = DISK_FORMAT_QCOW;
-                    x_disk->backend = DISK_BACKEND_QDISK;
+                    x_disk->format = LIBXL_DISK_FORMAT_QCOW;
+                    x_disk->backend = LIBXL_DISK_BACKEND_QDISK;
                 } else if (STREQ(l_disk->driverType, "qcow2")) {
-                    x_disk->format = DISK_FORMAT_QCOW2;
-                    x_disk->backend = DISK_BACKEND_QDISK;
+                    x_disk->format = LIBXL_DISK_FORMAT_QCOW2;
+                    x_disk->backend = LIBXL_DISK_BACKEND_QDISK;
                 } else if (STREQ(l_disk->driverType, "vhd")) {
-                    x_disk->format = DISK_FORMAT_VHD;
-                    x_disk->backend = DISK_BACKEND_TAP;
+                    x_disk->format = LIBXL_DISK_FORMAT_VHD;
+                    x_disk->backend = LIBXL_DISK_BACKEND_TAP;
                 } else if (STREQ(l_disk->driverType, "aio") ||
                             STREQ(l_disk->driverType, "raw")) {
-                    x_disk->format = DISK_FORMAT_RAW;
-                    x_disk->backend = DISK_BACKEND_TAP;
+                    x_disk->format = LIBXL_DISK_FORMAT_RAW;
+                    x_disk->backend = LIBXL_DISK_BACKEND_TAP;
                 }
             } else {
                 /* No subtype specified, default to raw/tap */
-                    x_disk->format = DISK_FORMAT_RAW;
-                    x_disk->backend = DISK_BACKEND_TAP;
+                    x_disk->format = LIBXL_DISK_FORMAT_RAW;
+                    x_disk->backend = LIBXL_DISK_BACKEND_TAP;
             }
         } else if (STREQ(l_disk->driverName, "file")) {
-            x_disk->format = DISK_FORMAT_RAW;
-            x_disk->backend = DISK_BACKEND_TAP;
+            x_disk->format = LIBXL_DISK_FORMAT_RAW;
+            x_disk->backend = LIBXL_DISK_BACKEND_TAP;
         } else if (STREQ(l_disk->driverName, "phy")) {
-            x_disk->format = DISK_FORMAT_RAW;
-            x_disk->backend = DISK_BACKEND_PHY;
+            x_disk->format = LIBXL_DISK_FORMAT_RAW;
+            x_disk->backend = LIBXL_DISK_BACKEND_PHY;
         } else {
             libxlError(VIR_ERR_INTERNAL_ERROR,
                         _("libxenlight does not support disk driver %s"),
@@ -539,12 +706,12 @@ libxlMakeDisk(virDomainDefPtr def, virDomainDiskDefPtr l_disk,
         }
     } else {
         /* No driverName - default to raw/tap?? */
-        x_disk->format = DISK_FORMAT_RAW;
-        x_disk->backend = DISK_BACKEND_TAP;
+        x_disk->format = LIBXL_DISK_FORMAT_RAW;
+        x_disk->backend = LIBXL_DISK_BACKEND_TAP;
     }
 
-    /* How to set unpluggable? */
-    x_disk->unpluggable = 1;
+    /* How to set un removable? */
+    x_disk->removable = 1;
     x_disk->readwrite = !l_disk->readonly;
     x_disk->is_cdrom = l_disk->device == VIR_DOMAIN_DISK_DEVICE_CDROM ? 1 : 0;
     if (l_disk->transient) {
@@ -553,13 +720,11 @@ libxlMakeDisk(virDomainDefPtr def, virDomainDiskDefPtr l_disk,
         return -1;
     }
 
-    x_disk->domid = def->id;
-
     return 0;
 }
 
 static int
-libxlMakeDiskList(virDomainDefPtr def, libxl_domain_config *d_config)
+libxlMakeDiskList(libxlDriverPrivatePtr driver, virDomainDefPtr def, libxl_domain_config *d_config)
 {
     virDomainDiskDefPtr *l_disks = def->disks;
     int ndisks = def->ndisks;
@@ -572,7 +737,7 @@ libxlMakeDiskList(virDomainDefPtr def, libxl_domain_config *d_config)
     }
 
     for (i = 0; i < ndisks; i++) {
-        if (libxlMakeDisk(def, l_disks[i], &x_disks[i]) < 0)
+        if (libxlMakeDisk(l_disks[i], &x_disks[i]) < 0)
             goto error;
     }
 
@@ -583,19 +748,17 @@ libxlMakeDiskList(virDomainDefPtr def, libxl_domain_config *d_config)
 
 error:
     for (i = 0; i < ndisks; i++)
-        libxl_device_disk_destroy(&x_disks[i]);
+        libxl_device_disk_destroy(driver->ctx, def->id, &x_disks[i]);	//TODO: domain_id. i do not know that whether the libvirt domain id is same as the xen domain id. 
     VIR_FREE(x_disks);
     return -1;
 }
 
 int
-libxlMakeNic(virDomainDefPtr def, virDomainNetDefPtr l_nic,
-             libxl_device_nic *x_nic)
+libxlMakeNic(virDomainNetDefPtr l_nic, libxl_device_nic *x_nic)
 {
     // TODO: Where is mtu stored?
     //x_nics[i].mtu = 1492;
 
-    x_nic->domid = def->id;
     memcpy(x_nic->mac, l_nic->mac, sizeof(libxl_mac));
 
     if (l_nic->model && !STREQ(l_nic->model, "netfront")) {
@@ -603,9 +766,9 @@ libxlMakeNic(virDomainDefPtr def, virDomainNetDefPtr l_nic,
             virReportOOMError();
             return -1;
         }
-        x_nic->nictype = NICTYPE_IOEMU;
+        x_nic->nictype = LIBXL_NIC_TYPE_IOEMU;
     } else {
-        x_nic->nictype = NICTYPE_VIF;
+        x_nic->nictype = LIBXL_NIC_TYPE_VIF;
     }
 
     if (l_nic->ifname && (x_nic->ifname = strdup(l_nic->ifname)) == NULL) {
@@ -637,7 +800,7 @@ libxlMakeNic(virDomainDefPtr def, virDomainNetDefPtr l_nic,
 }
 
 static int
-libxlMakeNicList(virDomainDefPtr def,  libxl_domain_config *d_config)
+libxlMakeNicList(libxlDriverPrivatePtr driver, virDomainDefPtr def,  libxl_domain_config *d_config)
 {
     virDomainNetDefPtr *l_nics = def->nets;
     int nnics = def->nnets;
@@ -652,7 +815,7 @@ libxlMakeNicList(virDomainDefPtr def,  libxl_domain_config *d_config)
     for (i = 0; i < nnics; i++) {
         x_nics[i].devid = i;
 
-        if (libxlMakeNic(def, l_nics[i], &x_nics[i]))
+        if (libxlMakeNic(l_nics[i], &x_nics[i]))
             goto error;
     }
 
@@ -663,13 +826,13 @@ libxlMakeNicList(virDomainDefPtr def,  libxl_domain_config *d_config)
 
 error:
     for (i = 0; i < nnics; i++)
-        libxl_device_nic_destroy(&x_nics[i]);
+        libxl_device_nic_destroy(driver->ctx, def->id, &x_nics[i]);	//TODO: id
     VIR_FREE(x_nics);
     return -1;
 }
 
 int
-libxlMakeVfb(libxlDriverPrivatePtr driver, virDomainDefPtr def,
+libxlMakeVfb(libxlDriverPrivatePtr driver, 
              virDomainGraphicsDefPtr l_vfb, libxl_device_vfb *x_vfb)
 {
     int port;
@@ -677,23 +840,23 @@ libxlMakeVfb(libxlDriverPrivatePtr driver, virDomainDefPtr def,
 
     switch (l_vfb->type) {
         case VIR_DOMAIN_GRAPHICS_TYPE_SDL:
-            x_vfb->sdl = 1;
+            x_vfb->sdl.enable = 1;
             if (l_vfb->data.sdl.display &&
-                (x_vfb->display = strdup(l_vfb->data.sdl.display)) == NULL) {
+                (x_vfb->sdl.display = strdup(l_vfb->data.sdl.display)) == NULL) {
                 virReportOOMError();
                 return -1;
             }
             if (l_vfb->data.sdl.xauth &&
-                (x_vfb->xauthority =
+                (x_vfb->sdl.xauthority =
                     strdup(l_vfb->data.sdl.xauth)) == NULL) {
                 virReportOOMError();
                 return -1;
             }
             break;
         case  VIR_DOMAIN_GRAPHICS_TYPE_VNC:
-            x_vfb->vnc = 1;
+            x_vfb->vnc.enable = 1;
             /* driver handles selection of free port */
-            x_vfb->vncunused = 0;
+            x_vfb->vnc.findunused = 0;
             if (l_vfb->data.vnc.autoport) {
                 port = libxlNextFreeVncPort(driver, LIBXL_VNC_PORT_MIN);
                 if (port < 0) {
@@ -703,13 +866,13 @@ libxlMakeVfb(libxlDriverPrivatePtr driver, virDomainDefPtr def,
                 }
                 l_vfb->data.vnc.port = port;
             }
-            x_vfb->vncdisplay = l_vfb->data.vnc.port - LIBXL_VNC_PORT_MIN;
+            x_vfb->vnc.display = l_vfb->data.vnc.port - LIBXL_VNC_PORT_MIN;
 
             listenAddr = virDomainGraphicsListenGetAddress(l_vfb, 0);
             if (listenAddr) {
                 /* libxl_device_vfb_init() does strdup("127.0.0.1") */
-                VIR_FREE(x_vfb->vnclisten);
-                if ((x_vfb->vnclisten = strdup(listenAddr)) == NULL) {
+                VIR_FREE(x_vfb->vnc.listen);
+                if ((x_vfb->vnc.listen = strdup(listenAddr)) == NULL) {
                     virReportOOMError();
                     return -1;
                 }
@@ -722,7 +885,6 @@ libxlMakeVfb(libxlDriverPrivatePtr driver, virDomainDefPtr def,
             }
             break;
     }
-    x_vfb->domid = def->id;
     return 0;
 }
 
@@ -750,10 +912,10 @@ libxlMakeVfbList(libxlDriverPrivatePtr driver,
     }
 
     for (i = 0; i < nvfbs; i++) {
-        libxl_device_vfb_init(&x_vfbs[i], i);
-        libxl_device_vkb_init(&x_vkbs[i], i);
+        libxl_device_vfb_init(driver->ctx, &x_vfbs[i]);
+        libxl_device_vkb_init(driver->ctx, &x_vkbs[i]);
 
-        if (libxlMakeVfb(driver, def, l_vfbs[i], &x_vfbs[i]) < 0)
+        if (libxlMakeVfb(driver, l_vfbs[i], &x_vfbs[i]) < 0)
             goto error;
     }
 
@@ -765,148 +927,14 @@ libxlMakeVfbList(libxlDriverPrivatePtr driver,
 
 error:
     for (i = 0; i < nvfbs; i++) {
-        libxl_device_vfb_destroy(&x_vfbs[i]);
-        libxl_device_vkb_destroy(&x_vkbs[i]);
+        libxl_device_vfb_destroy(driver->ctx, def->id, &x_vfbs[i]);
+        libxl_device_vkb_destroy(driver->ctx, def->id, &x_vkbs[i]);
     }
     VIR_FREE(x_vfbs);
     VIR_FREE(x_vkbs);
     return -1;
 }
 
-static int
-libxlMakeChrdevStr(virDomainChrDefPtr def, char **buf)
-{
-    const char *type = virDomainChrTypeToString(def->source.type);
-
-    if (!type) {
-        libxlError(VIR_ERR_INTERNAL_ERROR,
-                   "%s", _("unexpected chr device type"));
-        return -1;
-    }
-
-    switch (def->source.type) {
-        case VIR_DOMAIN_CHR_TYPE_NULL:
-        case VIR_DOMAIN_CHR_TYPE_STDIO:
-        case VIR_DOMAIN_CHR_TYPE_VC:
-        case VIR_DOMAIN_CHR_TYPE_PTY:
-            if (virAsprintf(buf, "%s", type) < 0) {
-                virReportOOMError();
-                return -1;
-            }
-            break;
-
-        case VIR_DOMAIN_CHR_TYPE_FILE:
-        case VIR_DOMAIN_CHR_TYPE_PIPE:
-            if (virAsprintf(buf, "%s:%s", type,
-                            def->source.data.file.path) < 0) {
-                virReportOOMError();
-                return -1;
-            }
-            break;
-
-        case VIR_DOMAIN_CHR_TYPE_DEV:
-            if (virAsprintf(buf, "%s", def->source.data.file.path) < 0) {
-                virReportOOMError();
-                return -1;
-            }
-            break;
-    }
-
-    return 0;
-}
-
-static int
-libxlMakeDeviceModelInfo(virDomainDefPtr def, libxl_domain_config *d_config)
-{
-    libxl_device_model_info *dm_info = &d_config->dm_info;
-    int i;
-    char b_order[VIR_DOMAIN_BOOT_LAST+1];
-
-    libxl_init_dm_info(dm_info, &d_config->c_info, &d_config->b_info);
-
-    if (d_config->b_info.hvm) {
-        /* HVM-specific device model info */
-        dm_info->type = XENFV;
-        if (def->os.nBootDevs > 0) {
-            VIR_FREE(dm_info->boot);
-            for (i = 0; i < def->os.nBootDevs; i++) {
-                switch (def->os.bootDevs[i]) {
-                    case VIR_DOMAIN_BOOT_FLOPPY:
-                        b_order[i] = 'a';
-                        break;
-                    default:
-                    case VIR_DOMAIN_BOOT_DISK:
-                        b_order[i] = 'c';
-                        break;
-                    case VIR_DOMAIN_BOOT_CDROM:
-                        b_order[i] = 'd';
-                        break;
-                    case VIR_DOMAIN_BOOT_NET:
-                        b_order[i] = 'n';
-                        break;
-                }
-            }
-            b_order[def->os.nBootDevs] = '\0';
-            if ((dm_info->boot = strdup(b_order)) == NULL) {
-                virReportOOMError();
-                goto error;
-            }
-        }
-        if (def->serials &&
-            (libxlMakeChrdevStr(def->serials[0], &dm_info->serial) < 0))
-            goto error;
-    } else {
-        /* PV-specific device model info */
-        dm_info->type = XENPV;
-    }
-
-    /* Build qemu graphics options from previously parsed vfb */
-    if (d_config->num_vfbs > 0) {
-        if (d_config->vfbs[0].vnc) {
-            dm_info->vnc = 1;
-            /* driver handles selection of free port */
-            dm_info->vncunused = 0;
-            if (d_config->vfbs[0].vnclisten) {
-                VIR_FREE(dm_info->vnclisten);
-                if ((dm_info->vnclisten =
-                     strdup(d_config->vfbs[0].vnclisten)) == NULL) {
-                    virReportOOMError();
-                    goto error;
-                }
-            }
-            if (d_config->vfbs[0].keymap &&
-                (dm_info->keymap = strdup(d_config->vfbs[0].keymap)) == NULL) {
-                virReportOOMError();
-                goto error;
-            }
-            dm_info->vncdisplay = d_config->vfbs[0].vncdisplay;
-            if (d_config->vfbs[0].vncpasswd &&
-                (dm_info->vncpasswd =
-                 strdup(d_config->vfbs[0].vncpasswd)) == NULL) {
-                virReportOOMError();
-                goto error;
-            }
-        } else if (d_config->vfbs[0].sdl) {
-            dm_info->sdl = 1;
-            dm_info->vnc = 0;
-        }
-    } else if (d_config->num_vfbs == 0) {
-        dm_info->nographic = 1;
-        dm_info->vnc = 0;
-    }
-
-    // TODO
-    //dm_info->usb = ;
-    //dm_info->usbdevice = ;
-    //dm_info->soundhw = ;
-
-    return 0;
-
-error:
-    libxl_device_model_info_destroy(dm_info);
-    return -1;
-}
-
 virCapsPtr
 libxlMakeCapabilities(libxl_ctx *ctx)
 {
@@ -940,18 +968,18 @@ libxlBuildDomainConfig(libxlDriverPrivatePtr driver,
                        virDomainDefPtr def, libxl_domain_config *d_config)
 {
 
-    if (libxlMakeDomCreateInfo(def, &d_config->c_info) < 0)
+    if (libxlMakeDomCreateInfo(driver, def, &d_config->c_info) < 0)
         return -1;
 
-    if (libxlMakeDomBuildInfo(def, d_config) < 0) {
+    if (libxlMakeDomBuildInfo(driver, def, d_config) < 0) {
         goto error;
     }
 
-    if (libxlMakeDiskList(def, d_config) < 0) {
+    if (libxlMakeDiskList(driver, def, d_config) < 0) {
         goto error;
     }
 
-    if (libxlMakeNicList(def, d_config) < 0) {
+    if (libxlMakeNicList(driver, def, d_config) < 0) {
         goto error;
     }
 
@@ -959,10 +987,6 @@ libxlBuildDomainConfig(libxlDriverPrivatePtr driver,
         goto error;
     }
 
-    if (libxlMakeDeviceModelInfo(def, d_config) < 0) {
-        goto error;
-    }
-
     d_config->on_reboot = def->onReboot;
     d_config->on_poweroff = def->onPoweroff;
     d_config->on_crash = def->onCrash;
@@ -970,6 +994,7 @@ libxlBuildDomainConfig(libxlDriverPrivatePtr driver,
     return 0;
 
 error:
-    libxl_domain_config_destroy(d_config);
+    libxl_domain_config_dispose(d_config);
     return -1;
 }
+

22:55 2012-02-16
mail to jim

hi, Jim

this is bamvor jian zhang. 
i have send my modification about the libvirt/src/libxl_conf.c  to the virtualization-dev mail list. 
i have modify almost all the compiling error in the libxl_conf.c. because of the lack of the knowledge in libvirt and xen, I was modifying the code while learning the libvirt and xen, So, i do not know that whether my work is fulfil your expection. 
in the next step, i will modify other libxl driver in libvirt. e.g. libxl_driver.c. 

could you do me a favor to take some time to check my work. 
I am looking forward your suggestions. thanks

best wishes

bamvor

08:54 2012-02-17
company, virtualization, suse, xen, regular meeting: US / China Virtualization Sync, meeting
1, Lin Ma
vmdp test with auto script.

2, Bo Yang
hotplug?
virtual io.
windows 2008?

3, ChunYan
local migration, remote migration. debug.

4, Bamvor
Jim will contact me and Chunyan?

09:23 2012-02-17
时间管理
0, 8:50

1, today
1), 9:00-9:24 US / China Virtualization Sync meeting, see"08:54 2012-02-17".
2), 9:25-10:55 xen, libvirt, devel-server maillist.
3), -18:37 continue to compile xen tools and libvirt. see"10:56 2012-02-17".
4), -13:31 午饭.

10:06 2012-02-17
software, Linux, get system run level
1, runlevel(by root)
bjz-dev:/home/novell # runlevel
N 5

2, who -r (by anyone)
novell@bjz-dev:~> who -r
         run-level 5  2012-02-16 13:48                   last=S

3, runlevel read /var/run/utmp and print result. 
"who -r" maybe call runlevel to get the run level result.

10:56 2012-02-17
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont10
1, deal with Jim's reply
1), about __XEN__, __XEN_TOOLS__
(1), Bamvor Jian Zhang wrote:
>
> the "<xen/sysctl.h>" is included in "libxl.h" in upstream. So, __XEN__
> and __XEN_TOOLS__ are needed to add while compiled the code of libvirt
> libxl driver.

sysctl.h has

#if !defined(__XEN__) && !defined(__XEN_TOOLS__)
#error "sysctl operations are intended for use by node control tools only"
#endif

libxl is a node control tool :-).

> But I had no idea where to add it. SO, just add at the beginning of
> the libxl_conf.c

It seems libxl should define these.  Why do all libxl apps have to
define these values?  xl is a libxl app, how is it handled in xl?  Maybe
a question for upstream xen.

Jim

(2), search the commit info of xen. why need __XEN__ and __XEN_TOOLS__?
从libxc看, 应该是在libxl的头文件里面定义这两个宏, 所以这个可能又是xen的patch? 
\todo 回复Jim邮件. 

novell@bjz-dev:xen-4.1.2-testing> grep __XEN_TOOLS__ tools/ -R
tools/libxc/xenctrl.h:#ifndef __XEN_TOOLS__
tools/libxc/xenctrl.h:#define __XEN_TOOLS__ 1
tools/libxc/ia64/xc_dom_ia64_util.h:#ifdef __XEN_TOOLS__
tools/libxc/xenctrlosdep.h:#ifndef __XEN_TOOLS__
tools/libxc/xenctrlosdep.h:#define __XEN_TOOLS__ 1
tools/Rules.mk:CFLAGS += -D__XEN_TOOLS__
tools/ioemu-qemu-xen/xen-setup-stubdom:TARGET_CPPFLAGS += $TARGET_CPPFLAGS -DCONFIG_STUBDOM -D__XEN_TOOLS__

(3), send email to Jim
hi, Jim

I found that there are __XEN_TOOLS__ definitions in the xen libxc public headers(tools/libxc/xenctrl.h and tools/libxc/xenctrlosdep.h). 

So, I add the __XEN_TOOLS__ into the libxl.h(Ha, it is also a patch of Xen): 
diff -r 3574f4d67843 tools/libxl/libxl.h
--- a/tools/libxl/libxl.h       Mon Feb 06 13:23:41 2012 -0800
+++ b/tools/libxl/libxl.h       Fri Feb 17 17:39:59 2012 +0800
@@ -127,6 +127,11 @@
 #ifndef LIBXL_H
 #define LIBXL_H

+/* Tell the Xen public headers we are a user-space tools build. */
+#ifndef __XEN_TOOLS__
+#define __XEN_TOOLS__ 1
+#endif
+
 #include <stdbool.h>
 #include <stdint.h>
 #include <stdarg.h>

2, fix compile errors of libxl_driver.c
0), compile command
/bin/sh ../libtool --tag=CC   --mode=compile gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I.. -I../gnulib/lib -I../gnulib/lib -I../include -I../include -I../src/util -DIN_LIBVIRT     -I../src/conf -I../src/xenxs  -I/usr/include/libxml2   -Wall -W -Wformat-y2k -Wformat-security -Winit-self -Wmissing-include-dirs -Wunused -Wunknown-pragmas -Wstrict-aliasing -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-align -Wwrite-strings -Wlogical-op -Waggregate-return -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wmissing-noreturn -Wmissing-format-attribute -Wredundant-decls -Wnested-externs -Winline -Winvalid-pch -Wvolatile-register-var -Wdisabled-optimization -Wattributes -Wcoverage-mismatch -Wmultichar -Wdeprecated-declarations -Wdiv-by-zero -Wendif-labels -Wextra -Wformat-contains-nul -Wformat-extra-args -Wformat-zero-length -Wformat=2 -Wmultichar -Wnormalized=nfc -Woverflow -Wpointer-to-int-cast -Wpragmas -Wno-missing-field-initializers -Wno-sign-compare -Wno-format-nonliteral -fstack-protector-all --param=ssp-buffer-size=4 -fexceptions -fasynchronous-unwind-tables -fdiagnostics-show-option -funit-at-a-time -fipa-pure-const -Werror    -g -O2 -MT libvirt_driver_libxl_la-libxl_driver.lo -MD -MP -MF .deps/libvirt_driver_libxl_la-libxl_driver.Tpo -c -o libvirt_driver_libxl_la-libxl_driver.lo `test -f 'libxl/libxl_driver.c' || echo './'`libxl/libxl_driver.c
libtool: compile:  gcc -std=gnu99 -DHAVE_CONFIG_H -I. -I.. -I../gnulib/lib -I../gnulib/lib -I../include -I../include -I../src/util -DIN_LIBVIRT -I../src/conf -I../src/xenxs -I/usr/include/libxml2 -Wall -W -Wformat-y2k -Wformat-security -Winit-self -Wmissing-include-dirs -Wunused -Wunknown-pragmas -Wstrict-aliasing -Wshadow -Wpointer-arith -Wbad-function-cast -Wcast-align -Wwrite-strings -Wlogical-op -Waggregate-return -Wstrict-prototypes -Wold-style-definition -Wmissing-prototypes -Wmissing-declarations -Wmissing-noreturn -Wmissing-format-attribute -Wredundant-decls -Wnested-externs -Winline -Winvalid-pch -Wvolatile-register-var -Wdisabled-optimization -Wattributes -Wcoverage-mismatch -Wmultichar -Wdeprecated-declarations -Wdiv-by-zero -Wendif-labels -Wextra -Wformat-contains-nul -Wformat-extra-args -Wformat-zero-length -Wformat=2 -Wmultichar -Wnormalized=nfc -Woverflow -Wpointer-to-int-cast -Wpragmas -Wno-missing-field-initializers -Wno-sign-compare -Wno-format-nonliteral -fstack-protector-all --param=ssp-buffer-size=4 -fexceptions -fasynchronous-unwind-tables -fdiagnostics-show-option -funit-at-a-time -fipa-pure-const -Werror -g -O2 -MT libvirt_driver_libxl_la-libxl_driver.lo -MD -MP -MF .deps/libvirt_driver_libxl_la-libxl_driver.Tpo -c libxl/libxl_driver.c  -fPIC -DPIC -o .libs/libvirt_driver_libxl_la-libxl_driver.o
cc1: warnings being treated as errors
1), 'libxl_ctx_init' undefined
libxl/libxl_driver.c: In function 'libxlDomainObjPrivateAlloc':
libxl/libxl_driver.c:89: error: implicit declaration of function 'libxl_ctx_init'
libxl/libxl_driver.c:89: error: nested extern declaration of 'libxl_ctx_init' [-Wnested-externs]
(1), due the change of definition of libxl_ctx, libxl_ctx_init is replaced by the libxl_ctx_alloc. 

int libxl_ctx_init(libxl_ctx *ctx, int version, xentoollog_logger *lg)
int libxl_ctx_alloc(libxl_ctx **pctx, int version,
		                    unsigned flags, xentoollog_logger * lg) 

diff file: libxl_driver.c.diff_ctx

11:52 2012-02-17
subscibe, mailing, list
1, subscribe the follow maillist
1), devel@suse.de
2), opensuse-arm@opensuse.org
http://en.opensuse.org/Portal:ARM

13:44 2012-02-17
install groupwise
1, libXm.so.3 is included in openmotif
ftp://ftp.kddlabs.co.jp/X11/openmotif/R2.1.30/tars/
ftp://ftp.uvsq.fr/pub/X11/openmotif/opengroup/R2.1.30/tars/

2, change config file
novell@bjz-dev:cf> diff site.def site.def.bak
66,67c66,67
< # define ProjectRoot  /usr
< # define VirtualBindingsPath /usr/lib/bindings
---
> # define ProjectRoot  /usr/dt
> # define VirtualBindingsPath /usr/dt/lib/bindings

3, make World BOOTSTRAPCFLAGS="-Di386" >& world.log
make install BOOTSTRAPCFLAGS="-Di386" >& install.log

4, 安装后仍然不行, 后来去
http://rpmfind.net/linux/rpm2html/search.php?query=libXm.so.3
下载, ftp://rpmfind.net/linux/opensuse/distribution/11.4/repo/oss/suse/i586/openmotif22-libs-2.2.4-189.1.i586.rpm
安装后, 重新安装
novell@bjz-dev:Downloads> sudo rpm -e novell-groupwise-client-8.0.2-92614.i586.r
pm
error: package novell-groupwise-client-8.0.2-92614.i586.rpm is not installed
novell@bjz-dev:Downloads> sudo rpm -ivh novell-groupwise-client-8.0.2-92614.i586
.rpm
Preparing...                ########################################### [100%]
package novell-groupwise-client-8.0.2-92614.i586 is already installed
居然提示已经安装了, erase居然提示没有安装: 
novell@bjz-dev:Downloads> sudo rpm -e novell-groupwise-client-8.0.2-92614.i586.r
pm
error: package novell-groupwise-client-8.0.2-92614.i586.rpm is not installed
什么情况啊, 没办法只能用"--force", 可以了.
novell@bjz-dev:Downloads> sudo rpm -ivh novell-groupwise-client-8.0.2-92614.i586.rpm  --force

5, 安装之后, 没有中文字体. 下周再搞了.

6, (17:05 2012-02-20)
Dongmao提醒说其实就是在java环境里面设置字体, 找到如下资料
http://docs.oracle.com/javase/1.5.0/docs/guide/intl/fontconfig.html
http://java.sun.com/javase/technologies/core/basic/intl/faq.jsp
http://www.builder.com.cn/2008/0619/935502.shtml
http://hiei.yeax.com/archives_48.html
http://wiki.openrays.org/index.php?title=%E8%AF%B7%E9%97%AE%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AEjava%E4%B8%AD%E6%96%87%E5%AD%97%E4%BD%93%3F

系统里面已经安装了中文字体(zypper se ttf可以看到
i | ttf-arphic          | Chinese TrueType fonts by Arphic Techno-> | package
), 所以根据文档, 只要把安装的字体链接到groupvise的java字体目录(/opt/novell/groupwise/client/java/lib/fonts). 

系统安装的字体在什么地方? 
1), rpm -ql 查询
novell@bjz-dev:office> rpm -ql ttf-arphic
/usr/share/doc/packages/ttf-arphic
/usr/share/doc/packages/ttf-arphic/license
/usr/share/doc/packages/ttf-arphic/license/big5
/usr/share/doc/packages/ttf-arphic/license/big5/ARPHICPL.TXT
/usr/share/doc/packages/ttf-arphic/license/english
/usr/share/doc/packages/ttf-arphic/license/english/ARPHICPL.TXT
/usr/share/doc/packages/ttf-arphic/license/gb
/usr/share/doc/packages/ttf-arphic/license/gb/ARPHICPL.TXT
2), 查看rpm包, 从"man zypper"可以知道zypper下载目录是"/var/cache/zypp/packages/", 所以可以找到:
novell@bjz-dev:packages> find . -name ttf*
./SUSE-Linux-Enterprise-Server-11-SP1 11.1.1-1.152/suse/noarch/ttf-arphic-20001125-765.17.noarch.rpm
(16:25 2012-09-13)
在zypper ar或zypper mr时加"-k"参数, 文件才会保存到这个目录. 否则安装后删除rpm包.
"16:25 2012-09-13"
这样同样可以看到安装的文件
novell@bjz-dev:packages> rpm -pql "`find . -name ttf*`"
/usr/share/doc/packages/ttf-arphic
/usr/share/doc/packages/ttf-arphic/license
/usr/share/doc/packages/ttf-arphic/license/big5
/usr/share/doc/packages/ttf-arphic/license/big5/ARPHICPL.TXT
/usr/share/doc/packages/ttf-arphic/license/english
/usr/share/doc/packages/ttf-arphic/license/english/ARPHICPL.TXT
/usr/share/doc/packages/ttf-arphic/license/gb
/usr/share/doc/packages/ttf-arphic/license/gb/ARPHICPL.TXT

可以没有看到自己的配置文件进入别的字体目录看看:
/usr/share/doc/packages/ttf-arphic-uming/
novell@bjz-dev:ttf-arphic-uming> ls
CONTRIBUTERS   fonts.alias  fonts.scale  README         ttf-arphic-uming
encodings.dir  fonts.dir    license      README.Bitmap

似乎执行这个命令就可以, 可以去掉也居然还可以用, 奇怪, 难道有cache? 
cd /opt/novell/groupwise/client/java/lib/fonts
ln -s /usr/share/doc/packages/ttf-arphic-uming fallback
注: fallback这个名字是从网上学的, 应该用什么名字都行.

09:21 2012-02-20
maillist
1, work report(devel-server):
1), Frederic Crozat <fcrozat@suse.com>
 converted my SLES11 SP2 server from ext3 to btrfs, without reinstallation : a bit tricky but it is doable

14:13 2012-02-20
时间管理
0, 9:15

1, today
1), 40' 14:17-14:34 Chunyan introduciton Wireshark. write notes. see"14:17 2012-02-20".
2), Ralf and Olaf Kirk introduce suse. 
3), 10' work report: week 07. see"14:37 2012-02-20".
4), 15:10-18:35 continue to fix libvirt compile error. see"15:13 2012-02-20". 

14:17 2012-02-20
company, network, wireshark
1, http://www.wireshark.org
Wireshark® is a network protocol analyzer.
2, take over the maintenance of wireshark during ChunYan's sick leave.
1), get the bug from company bugzilla website. 
2), check whether the bug has been fixed by the wireshark upstream. 
(usually: yes).
3), fix bug
I need fix the bug of all the distribution: sles9, sles10, sles11, opensuse11.3, opensuse11.4, opensuse12.1
(1), for all distribution(except sles9): update the wireshark to the upstream version which fix the bug.
CAUTION: I do not have the permission to update the major version for wareshark. For example, update from Wireshark from 1.4.11 to 1.6.x
(2), for sles9: fix the Wireshark by hand with the reference from the Wireshark. Because, Wireshark in sles9 is too old(1.0.x). 
就是说, sles9的Wireshark版本很低, 没法升级到1.4.x, 只能手动fix bug. 不过sles9里面也许没有这个问题. 
4), commit bug and get the autobuild rpm package. install rpm and run Wireshark. I must ensure Wireshark can start and run normally. 
sles9 use the old auto build verison: named autobuild. The others use ibs(for sle) or obs(for opensuse).
sles9 autobuild doc: "work/documents/doc_from_ChunYanLIU/autobuild"

14:37 2012-02-20
work report, week 07
1, bamvor jian zhang work report
[devel-server] work report - week 07
[GREEN]
fixing upstream libvirt compile error based on upstream xen-unstable: 
1), make one of the libvirt libxl driver(libxl_conf.c) compile pass; 
2), send part of the patch to the virtualization-dev maillist, Jim and Chunyan gave me some feedback and suggestion. 

15:13 2012-02-20
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont11
1, Chunyan suggestion me submit the patch of xen to the upstream(xen-devel):
1), I found that I had four changes:
Files [A]/tools/check/funcs.sh and [B]/tools/check/funcs.sh differ
Files [A]/tools/libxl/Makefile and [B]/tools/libxl/Makefile differ
Files [A]/tools/libxl/libxl.h and [B]/tools/libxl/libxl.h differ
Files [A]/tools/python/setup.py and [B]/tools/python/setup.py differ
(1), the first one, maybe not a bug, so, skip it.
(2), the forth one: has been submit by Olaf Hering. 
novell@bjz-dev:xen-unstable.hg> diff tools/python/setup.py ../xen-unstable.hg_sles11/tools/python/setup.py
48,49c48,50
<                include_dirs       = [ PATH_XEN, PATH_LIBXC, "xen/lowlevel/flask" ],
<                library_dirs       = [ PATH_LIBXC ],
---
>                include_dirs       = [ PATH_XEN, PATH_LIBXC, "xen/lowlevel/flask",
>                                       "../flask/libflask/include" ],
>                library_dirs       = [ PATH_LIBXC, "../flask/libflask" ],
(3), send email
[xen-devel] [PATCH] libxl: fix compile error of libvirt

a, libxl_event.h is included in libxl.h. So, the former one also need to be installed. 
b, define __XEN_TOOLS__ in libxl.h:
the head file "xen/sysctl.h" need check this macro. 
It is the same way used by the xen libxc public headers(tools/libxc/xenctrl.h and tools/libxc/xenctrlosdep.h). 

Signed-off-by: Bamvor Jian Zhang <bjzhang@suse.com>

diff -r 87218bd367be tools/libxl/Makefile
--- a/tools/libxl/Makefile	Fri Feb 17 12:24:38 2012 +0000
+++ b/tools/libxl/Makefile	Mon Feb 20 15:36:09 2012 +0800
@@ -163,7 +163,7 @@
 	ln -sf libxlutil.so.$(XLUMAJOR).$(XLUMINOR) $(DESTDIR)$(LIBDIR)/libxlutil.so.$(XLUMAJOR)
 	ln -sf libxlutil.so.$(XLUMAJOR) $(DESTDIR)$(LIBDIR)/libxlutil.so
 	$(INSTALL_DATA) libxlutil.a $(DESTDIR)$(LIBDIR)
-	$(INSTALL_DATA) libxl.h libxl_json.h _libxl_types.h _libxl_types_json.h _libxl_list.h libxl_utils.h libxl_uuid.h $(DESTDIR)$(INCLUDEDIR)
+	$(INSTALL_DATA) libxl.h libxl_json.h _libxl_types.h _libxl_types_json.h _libxl_list.h libxl_utils.h libxl_uuid.h libxl_event.h $(DESTDIR)$(INCLUDEDIR)
 	$(INSTALL_DATA) bash-completion $(DESTDIR)$(BASH_COMPLETION_DIR)/xl.sh
 
 .PHONY: clean

diff -r 87218bd367be tools/libxl/libxl.h
--- a/tools/libxl/libxl.h	Fri Feb 17 12:24:38 2012 +0000
+++ b/tools/libxl/libxl.h	Mon Feb 20 15:36:09 2012 +0800
@@ -127,6 +127,11 @@
 #ifndef LIBXL_H
 #define LIBXL_H
 
+/* Tell the Xen public headers we are a user-space tools build. */
+#ifndef __XEN_TOOLS__
+#define __XEN_TOOLS__ 1
+#endif 
+
 #include <stdbool.h>
 #include <stdint.h>
 #include <stdarg.h>

(4), (10:59 2012-02-22)
((1)), It takes 20 hours to revice my PATCH email by the xen-devel. and Ian revice the mail: 
Bamvor Jian Zhang writes ("[Xen-devel] [xen-devel] [PATCH] libxl: fix compile error of libvirt"):
> 
> a, libxl_event.h is included in libxl.h. So, the former one also need to be
> installed.

Well spotted.  However, I'm afraid your mail has been very badly
mangled by whatever program you used to send it.  For this patch I
reconstructed the change by hand and have committed it.

> b, define __XEN_TOOLS__ in libxl.h:
> the head file "xen/sysctl.h" need check this macro.

I don't think this is correct.

> It is the same way used by the xen libxc public headers(tools/libxc/xenctrl.h
> and tools/libxc/xenctrlosdep.h).

Users of libxl should not be using libxc directly and therefore should
not be including xenctrl.h.

Note that the API for libxl has changed in xen-unstable.hg compared to
4.1, and further changes are forthcoming.  So there will have to be
changes in libvirt.

Thanks,
Ian.

((2)), the code of libxl has been changing. So, in Ian's opinion, add __XEN_TOOLS__ to libxl.h is not a good way to fix the compile errors. So, ..., wait for a moment. wait for the upstream updating the libxl.
discuss with Jiaju and Chunyan.
a, about "badly mangled". They said that because of the groupwise. different mail send tools maybe have different setting in order to send the patch with correct format.
b, about the patch denied by Ian. Chunyan suggest that after Ian removed xenctrl.h "23174:751c6dcec0d4", how should I use libxl.h for application. 就是说, Ian既然已经这样修改libxl.h, 那我该怎么在应用程序中使用这个头文件呢? 

((3)), reply to Ian' email

but after your commit "23174:751c6dcec0d4"(remove xenctrl.h from libxl.h), the aplication(like libvirt) compile fail. How do i deal with it? 
it seems that add __XEN_TOOLS_ to libvirt code is not good. 

"10:59 2012-02-22"end

18:34 2012-02-20
virtualization, suse, xen, xen memory management
Currently, there have two types of way to manage guest memory: one is
using hardware assist paging which known as EPT, and for those CPU
which not suppont EPT, xen use shadow page table. You can google them
to get more detail.

2012/2/19, 吴锐 <19890121wr@xxxxxxxxx>:
> Hi, everyone
>             I am newbie here. And now I am trying to understand about
> Xen's memory management.
>             When a Guest VM try to modify its page table. How does Xen
> handle that?
>             In PV it seems like Guest VM will use a hypercall
> do_update_va_mapping or do_mmu_update. What's the difference?
>             How about HVM
>             Thanks for answering.
>

09:41 2012-02-21
virtualization, maillist, xen
http://lists.xen.org/archives/html/xen-devel/2012-02/msg01311.html
These mailing lists, and the other Open Source Xen mailing lists, have
for a long time used the domain name "xensource.com".  This is rather
out of date now :-) and also it makes the listserver produce links to
some old list archives.

So we are going to change the hostname which is used by the mailing
list software in its outgoing messages, for example in the various
headers like List-Id etc., and the mailing list footer.

If you are filtering your list email you will probably need to update
your filters.

This change will take place some time in the next few days.

NB this change affects only the contents of outgoing email headers,
links, etc.; the mechanisms for subscribing/unsubscribing, and for
posting to the list, will remain unchanged.  But we would encourage
people who want to post to the lists to use the address @xen.org
rather the old one @xensource.com.

Thanks,
Ian.

10:04 2012-02-21
时间管理
0, 9:20

1, today

10:46 2012-02-21
1, analysis libxlCreateDomEvents:
1    698  /home/novell/work/source/virtualization/libvirt/libvirt/src/libxl/libxl_driver.c <<libxlVmStart>>
	if (libxlCreateDomEvents(vm) < 0)
2    781  /home/novell/work/source/virtualization/libvirt/libvirt/src/libxl/libxl_driver.c <<libxlReconnectDomain>>
	libxlCreateDomEvents(vm);
1), libxlVmStart -> libxlCreateDomEvents

2, compile the xen branches and libvirt in sles11 sp1, try to find out how the libvirt works.
1), missing lib bz2:
gcc  -O2 -fomit-frame-pointer -m64 -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wno-unused-value -Wdeclaration-after-statement  -D__XEN_TOOLS__ -MMD -MF .xc_restore.o.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE  -Werror -I../../tools/libxc -I../../tools/include -I../../tools/libxc -I../../tools/include -I../../tools/xenstore -I../../tools/include -c -o xc_restore.o xc_restore.c
gcc -O2 -fomit-frame-pointer -m64 -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wno-unused-value -Wdeclaration-after-statement  -D__XEN_TOOLS__ -MMD -MF .xc_restore.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE  -Werror -I../../tools/libxc -I../../tools/include -I../../tools/libxc -I../../tools/include -I../../tools/xenstore -I../../tools/include    xc_restore.o -L../../tools/libxc -lxenctrl -L../../tools/libxc -lxenguest -L../../tools/xenstore -lxenstore -lbz2 -o xc_restore
/usr/lib64/gcc/x86_64-suse-linux/4.3/../../../../x86_64-suse-linux/bin/ld: cannot find -lbz2
link 32bit版本地址不正确, 于是link 64bit版本. 
novell@bjz-dev:lib> cd ../lib64/
novell@bjz-dev:lib64> sudo ln -s libbz2.so.1 libbz2.so
2), yajl interface change:
  CC     libvirt_util_la-json.lo
  util/json.c:884: warning: initialization from incompatible pointer type
  util/json.c:885: warning: initialization from incompatible pointer type
  util/json.c:887: warning: initialization from incompatible pointer type
  util/json.c: In function 'virJSONValueFromString':
  util/json.c:897: error: 'yajl_parser_config' undeclared (first use in this function)
download yajl older version: 1.0.12
3), virBitmapClearBit undefined while linking. 
  CCLD   libvirtd
../src/.libs/libvirt_driver_qemu.a(libvirt_driver_qemu_la-qemu_driver.o): In function `qemudShutdownVMDaemon':
/home/novell/work/source/virtualization/xen/suse_svn/branches/SLE11-SP1-Branch/libvirt/libvirt-0.7.6/src/qemu/qemu_driver.c:2972: undefined reference to `virBitmapClearBit'
(1), clean and rebuild with verbose mode(make V=1).
很奇怪为什么没有编译bitmap.c, 后来才想起需要做"autogen.sh".
4), run autogen.sh:
./autogen.sh --enable-compile-warnings=error
there are errors in gnutls(warning treated as error). So, run "./autogen.sh", make clean, make(pass), make install.

11:09 2012-02-22
company, virtualization, suse
1, Desktop Virtualization
https://fate.novell.com/310440

Customer benefit:
Page_white_edit Edit customer benefit

Customer:Novell

Both corporations and educational institutions are aiming for desktop virtualization. The openSUSE Education team has already done some development in this area and we should work together with them to enable openSUSE for desktop virtualization.

Benefit:

openSUSE: Better deployment for the education market will benefit the openSUSE Education team.

SLEPOS, SLED: IT Standarization feature.

2, the Spice projext: 
http://www.spice-space.org/
The Spice project aims to provide a complete open source solution for interaction with virtualized desktop devices.

11:12 2012-02-22
时间管理
0, 9:30

1, today
1), continue to fix libvirt compile error: run libvirt and xen in order to understant how it works. see"11:14 2012-02-22".
2), reply the email from Jim and Ian. see"11:14 2012-02-22"1, "15:13 2012-02-20"1-1)-(4). 

11:14 2012-02-22
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont12, run libvirt and xen in order to understant how it works
1, Jim's reply and reply to Jim
1), Jim reply
Hi Bamvor,

I haven't had time for a thorough review of patches 3-5 yet, but do have
some initial comments.
First, you'll need to make sure any changes you make to the libvirt
libxl driver don't break building it with Xen 4.1.x.  With your patches
applied, we must be able to build the driver against Xen 4.1.2 (xen
version in sles11 sp2) and xen-unstable.
Also, read through HACKING in root of libvirt source for details of
upstream coding standards.
I should have time for more review and comments tomorrow.

Thanks!
Jim

2), reply to Jim
>First, you'll need to make sure any changes you make to the libvirt
>libxl driver don't break building it with Xen 4.1.x.  With your patches
>applied, we must be able to build the driver against Xen 4.1.2 (xen
>version in sles11 sp2) and xen-unstable.
I compared the changes between Xen 4.1.2 and xen-unstable. There are lots of changes(function interface, struct definition) which lead to the compile error in libvirt upstream. So, I cannot guarantee that my patch apply to xen-unstable and xen 4.1.2 at the same time.
>Also, read through HACKING in root of libvirt source for details of
>upstream coding standards.
I will read it.
>I should have time for more review and comments tomorrow.
thanks.
For the two patches of xen, upstream(Ian Jackson) accept one(about install libxl_event.h to the system). For the denied patch, I sent a email and discuss with Ian. 

2, run libvirt and xen. fail. 

3, the remaining error. 
1), libxl_stop_waiting undefined.
libxl/libxl_driver.c: In function 'libxlDomainObjPrivateFree':
libxl/libxl_driver.c:105: error: implicit declaration of function 'libxl_stop_waiting'
libxl/libxl_driver.c:105: error: nested extern declaration of 'libxl_stop_waiting' [-Wnested-externs]
libxl/libxl_driver.c:106: error: implicit declaration of function 'libxl_free_waiter'
libxl/libxl_driver.c:106: error: nested extern declaration of 'libxl_free_waiter' [-Wnested-externs]
libxl/libxl_driver.c: In function 'libxlCreateDomEvents':
libxl/libxl_driver.c:469: error: implicit declaration of function 'libxl_wait_for_domain_death'
libxl/libxl_driver.c:469: error: nested extern declaration of 'libxl_wait_for_domain_death' [-Wnested-externs]
libxl/libxl_driver.c:472: error: implicit declaration of function 'libxl_get_wait_fd'
libxl/libxl_driver.c:472: error: nested extern declaration of 'libxl_get_wait_fd' [-Wnested-externs]
(1), this is because libxl_waiter is removed.
compare the latest version and b3387ae40371. update to b3387ae40371 version:  
novell@bjz-dev:xen-unstable.hg> hg update -r b3387ae40371
253 files updated, 0 files merged, 120 files removed, 0 files unresolved

there is libxl_stop_waiting examples in the code of xen tools.

3), 
libxl/libxl_driver.c: In function 'libxlDoNodeGetInfo':
libxl/libxl_driver.c:163: error: passing argument 1 of 'libxl_get_physinfo' from incompatible pointer type
libxl/libxl_driver.c:169: error: passing argument 1 of 'libxl_get_version_info' from incompatible pointer type
libxl/libxl_driver.c: In function 'libxlVmReap':
libxl/libxl_driver.c:357: error: too many arguments to function 'libxl_domain_destroy'
libxl/libxl_driver.c: In function 'libxlEventHandler':
libxl/libxl_driver.c:400: error: implicit declaration of function 'libxl_get_event'
libxl/libxl_driver.c:400: error: nested extern declaration of 'libxl_get_event' [-Wnested-externs]
libxl/libxl_driver.c:403: error: 'LIBXL_EVENT_DOMAIN_DEATH' undeclared (first use in this function)
libxl/libxl_driver.c:403: error: (Each undeclared identifier is reported only once
libxl/libxl_driver.c:403: error: for each function it appears in.)
libxl/libxl_driver.c:408: error: implicit declaration of function 'libxl_event_get_domain_death_info'
libxl/libxl_driver.c:408: error: nested extern declaration of 'libxl_event_get_domain_death_info' [-Wnested-externs]
libxl/libxl_driver.c:451: error: implicit declaration of function 'libxl_free_event'
libxl/libxl_driver.c:451: error: nested extern declaration of 'libxl_free_event' [-Wnested-externs]
libxl/libxl_driver.c: In function 'libxlFreeMem':
libxl/libxl_driver.c:563: error: 'libxl_domain_config' has no member named 'dm_info'
libxl/libxl_driver.c:564: error: too many arguments to function 'libxl_domain_need_memory'
libxl/libxl_driver.c: In function 'libxlVmStart':
libxl/libxl_driver.c:719: error: implicit declaration of function 'libxl_domain_config_destroy'
libxl/libxl_driver.c:719: error: nested extern declaration of 'libxl_domain_config_destroy' [-Wnested-externs]
libxl/libxl_driver.c:726: error: too many arguments to function 'libxl_domain_destroy'
libxl/libxl_driver.c: In function 'libxlReconnectDomain':
libxl/libxl_driver.c:758: error: passing argument 1 of 'libxl_domain_info' from incompatible pointer type
libxl/libxl_driver.c:769: error: passing argument 1 of 'libxl_userdata_retrieve' from incompatible pointer type
libxl/libxl_driver.c: In function 'libxlShutdown':
libxl/libxl_driver.c:806: error: passing argument 1 of 'libxl_ctx_free' from incompatible pointer type
libxl/libxl_driver.c: In function 'libxlStartup':
libxl/libxl_driver.c:949: error: passing argument 1 of 'libxl_get_version_info' from incompatible pointer type
libxl/libxl_driver.c:957: error: passing argument 1 of 'libxlMakeCapabilities' from incompatible pointer type
libxl/libxl_driver.c: In function 'libxlGetMaxVcpus':
libxl/libxl_driver.c:1120: error: passing argument 1 of 'libxl_get_max_cpus' from incompatible pointer type
libxl/libxl_driver.c: In function 'libxlDomainShutdownFlags':
libxl/libxl_driver.c:1441: error: too many arguments to function 'libxl_domain_shutdown'
libxl/libxl_driver.c: In function 'libxlDomainReboot':
libxl/libxl_driver.c:1494: error: too many arguments to function 'libxl_domain_shutdown'
libxl/libxl_driver.c: In function 'libxlDomainGetInfo':
libxl/libxl_driver.c:1766: error: passing argument 1 of 'libxl_domain_info' from incompatible pointer type
libxl/libxl_driver.c: In function 'libxlDomainGetVcpus':
libxl/libxl_driver.c:2514: error: implicit declaration of function 'libxl_vcpuinfo_destroy'
libxl/libxl_driver.c:2514: error: nested extern declaration of 'libxl_vcpuinfo_destroy' [-Wnested-externs]
libxl/libxl_driver.c: In function 'libxlDomainXMLFromNative':
libxl/libxl_driver.c:2572: error: passing argument 1 of 'libxl_get_version_info' from incompatible pointer type
libxl/libxl_driver.c: In function 'libxlDomainXMLToNative':
libxl/libxl_driver.c:2615: error: passing argument 1 of 'libxl_get_version_info' from incompatible pointer type
libxl/libxl_driver.c: In function 'libxlDomainChangeEjectableMedia':
libxl/libxl_driver.c:2875: error: passing argument 1 of 'libxlMakeDisk' from incompatible pointer type
libxl/libxl_driver.c:2875: error: passing argument 2 of 'libxlMakeDisk' from incompatible pointer type
libxl/libxl_driver.c:2875: error: too many arguments to function 'libxlMakeDisk'
libxl/libxl_driver.c: In function 'libxlDomainAttachDeviceDiskLive':
libxl/libxl_driver.c:2930: error: passing argument 1 of 'libxlMakeDisk' from incompatible pointer type
libxl/libxl_driver.c:2930: error: passing argument 2 of 'libxlMakeDisk' from incompatible pointer type
libxl/libxl_driver.c:2930: error: too many arguments to function 'libxlMakeDisk'
libxl/libxl_driver.c: In function 'libxlDomainDetachDeviceDiskLive':
libxl/libxl_driver.c:2984: error: passing argument 1 of 'libxlMakeDisk' from incompatible pointer type
libxl/libxl_driver.c:2984: error: passing argument 2 of 'libxlMakeDisk' from incompatible pointer type
libxl/libxl_driver.c:2984: error: too many arguments to function 'libxlMakeDisk'
libxl/libxl_driver.c:2987: error: implicit declaration of function 'libxl_device_disk_del'
libxl/libxl_driver.c:2987: error: nested extern declaration of 'libxl_device_disk_del' [-Wnested-externs]
libxl/libxl_driver.c: In function 'libxlNodeGetFreeMemory':
libxl/libxl_driver.c:3366: error: passing argument 1 of 'libxl_get_physinfo' from incompatible pointer type
libxl/libxl_driver.c:3371: error: passing argument 1 of 'libxl_get_version_info' from incompatible pointer type
make[3]: *** [libvirt_driver_libxl_la-libxl_driver.lo] Error 1
make[3]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt/src'
make[2]: *** [all] Error 2
make[2]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt/src'
make[1]: *** [all-recursive] Error 1
make[1]: Leaving directory `/home/novell/sda3/home/novell/work/source/virtualization/libvirt/libvirt'
make: *** [all] Error 2

10:20 2012-02-23
时间管理
0, 9:00

1, today
1), 1h 微博.
2), 10:23- discuss through email: about the libvirt compile error. see"10:25 2012-02-23".
3), 13:30-15:00 Olaf meeting: communication; openstack overview.
4), 15:58- about the libvirt compile error. see"15:59 2012-02-23".

13:33  2012-2-23
Olaf
1, Olaf try to illustrate how important the staff communicate with other sites.
1), mailing list for transparency.
engage in it.
useful maillist: research@suse
2), bugzilla.
3), work report.
4), www.suse.de/~m ...

2, openstack
1), NOT
(1), cloud manager
MCM NCM? meaning.
(2), application stack

10:25 2012-02-23
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont13, discuss through email
1, xen patch
1), Ian Campbell <Ian.Campbell@citrix.com>mail"Re: [Xen-devel] [xen-devel] [PATCH] libxl: fix compile error of libvirt"_20120222_2010
On Wed, 2012-02-22 at 11:52 +0000, Ian Jackson wrote:
> Bamvor Jian Zhang writes ("Re: [Xen-devel] [xen-devel] [PATCH] libxl: fix compile error of libvirt"):
> > Ian Jackson wrote: 
> > > Users of libxl should not be using libxc directly and therefore should 
> > > not be including xenctrl.h. 
> ...
> > but after your commit "23174:751c6dcec0d4"(remove xenctrl.h from libxl.h), the aplication(like libvirt) compile fail. How do i deal with it? 
> > it seems that add __XEN_TOOLS_ to libvirt code is not good. 
> 
> Can you tell us the error message you get ?  I think the problem is
> probably that libvirt is trying to use libxc directly.

Is the problem here libxc or the Xen public headers?

I thought we'd decided the latter was OK in users of libxl. e.g. xl has
to use the SHUTDOWN_{poweroff,reboot,suspend} constants from
xen/include/public/sched.h (and indeed libxl.h includes this header).

libxl.h also includes Xen's sysctl.h -- seems to be for
XEN_SYSCTL_PHYSCAP_*. Really this case would be better exposing as a
series of bools which are initialised from the hypercall provided flags
mask by libxl (like we do for the various dominfo flags)

Personally I'd be happy to have libxl always define its own constants
and remove this need for libxl users to use the Xen headers.

If we are going to do that it should go onto the 4.2 TODO list.

2), reply errors message to Ian Jackson.

3), after my reply, I found that Jim reply Ian Jackson too. Maybe I should check all the email before my reply.
"Jim Fehlig <jfehlig@suse.com>"email"Re: [Xen-devel] [xen-devel] [PATCH] libxl: fix compile error of libvirt"_20120223_0540
Ian Jackson wrote:
> Bamvor Jian Zhang writes ("Re: [Xen-devel] [xen-devel] [PATCH] libxl: fix compile error of libvirt"):
>   
>> Ian Jackson wrote: 
>>     
>>> Users of libxl should not be using libxc directly and therefore should 
>>> not be including xenctrl.h. 
>>>       
> ...
>   
>> but after your commit "23174:751c6dcec0d4"(remove xenctrl.h from libxl.h), the aplication(like libvirt) compile fail. How do i deal with it? 
>> it seems that add __XEN_TOOLS_ to libvirt code is not good. 
>>     
>
> Can you tell us the error message you get ?  I think the problem is
> probably that libvirt is trying to use libxc directly.
>   

The libvirt libxl driver doesn't use libxc directly. AFAICT, the problem
is that libxl.h includes <xen/sysctl.h>, which has this

#if !defined(__XEN__) && !defined(__XEN_TOOLS__)
#error "sysctl operations are intended for use by node control tools only"
#endif

Without the defines, Bamvor is hitting the #error directive.

Regards,
Jim

2, libvirt(Jim)
1), about my patch for adding "parse_cmdline" in the libxl_conf.c.
(1), Jim suggest that: 
I think it would be better to use something like
split_string_into_string_list() in $xen_root/tools/libxl/xl_cmdimpl.c.
(2), I had search the familiar method in the source code of xen. But I have not find the "split_string_into_string_list()". 
(3), this fucntion parse string "str" by the delimiter "delim" and save the result to libxl_string_list(psl).
This is the same scenario in the libxl_conf.c: convert from string to libxl_string_list. 
But "split_sting_info_string_list" is a static functin, I need to export it. 
(4), Add this function to libxl_utils.c
patch file: patch_for_split_string_into_string_list__compile_not_pass

15:59 2012-02-23
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont14, run libvirt
1, start libvirt fail
15:57:22.395: 29565: info : libvirt version: 0.9.6
15:57:22.395: 29565: error : virGetUserID:2122 : Failed to find user record for name 'qemu': Success
15:57:22.395: 29565: error : virStateInitialize:862 : Initialization of QEMU state driver failed
15:57:22.463: 29565: error : daemonRunStateInit:1153 : Driver state initialization failed
2, (16:46 2012-02-24)
1), yestoday, I puzzled about the libvirtd shell script in the daemon directory.
Today, I found that it only used before installation:
# libvirtd - temporary wrapper script for .libs/libvirtd
# Generated by libtool (GNU libtool) 2.2.10
#
# The libvirtd program cannot be directly executed until all the libtool
# libraries that it depends on are installed.
#
# This wrapper script should never be moved out of the build directory.
# If it is, it will not operate correctly.
2), look libvird log
17:35:01.512: 27107: debug : do_open:1071 : trying driver 0 (Test) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 0 Test returned DECLINED
17:35:01.512: 27107: debug : do_open:1071 : trying driver 1 (Xen) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 1 Xen returned DECLINED
17:35:01.512: 27107: debug : do_open:1071 : trying driver 2 (OPENVZ) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 2 OPENVZ returned DECLINED
17:35:01.512: 27107: debug : do_open:1071 : trying driver 3 (VMWARE) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 3 VMWARE returned DECLINED
17:35:01.512: 27107: debug : do_open:1071 : trying driver 4 (VBOX) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 4 VBOX returned DECLINED
17:35:01.512: 27107: debug : do_open:1071 : trying driver 5 (ESX) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 5 ESX returned DECLINED
17:35:01.512: 27107: debug : do_open:1071 : trying driver 6 (remote) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 6 remote returned DECLINED
17:35:01.512: 27107: debug : do_open:1071 : trying driver 7 (xenlight) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 7 xenlight returned DECLINED
17:35:01.512: 27107: debug : do_open:1071 : trying driver 8 (QEMU) ...
17:35:01.512: 27107: debug : do_open:1077 : driver 8 QEMU returned SUCCESS

18:43 2012-02-23
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont15, about xl(xenlight)
1, I searched the initial email for the xenlight. Here it is:
1), [Xen-devel] [ANNOUNCE] libxenlight
http://lists.xen.org/archives/html/xen-devel/2009-11/msg00436.html
The goals of libxenlight are:
- be easy to use and to extend
- provide a simple and robust API for tool stacks to do xen operations
- create a common codebase for the lower-level implementation of all the
  various xen tool stacks
2), [libvirt] [RFC] libxenlight driver
https://www.redhat.com/archives/libvir-list/2011-January/msg00875.html
3), [libvirt] [PATCH V4] Add libxenlight driver
https://www.redhat.com/archives/libvir-list/2011-March/msg00263.html

16:02 2012-02-24
virtualization, suse, xen, source code, upstream libvirt and libxl compile errors and warnings, cont16, discussion, GSoC
1, discuss(Ian.C and Jim).
"Jim Fehlig <jfehlig@suse.com>"mailto"Ian.Campbell@citrix.com""Re: [Xen-devel] [xen-devel] [PATCH] libxl: fix compile error of libvirt"_20120224_2307
>  From 4.2 onwards we
> will make changes in a compatible way or provide compatibility shims etc
> or in extreme circumstances do things in a way which is easily
> detectable e.g. via configure tests.
That would be much appreciated.  Maybe we'll start seeing more libxl apps...

> I was wondering the other day if "libxl v2" support for libvirt might
> make a nice GSoC project, what do you think? Would you be interested in
> mentoring such a project?
I agree that it would make a nice GSoC project, but I had encouraged
Bamvor to take on the task.  It's a good project for becoming familiar
with xen and libvirt.

2, about GSoC
1), about GSoC project
http://code.google.com/soc/
http://www.google-melange.com/gsoc/events/google/gsoc2012
http://www.google-melange.com/document/show/gsoc_program/google/gsoc2012/faqs#ideas_list
2), about GSoC in China
高校如何参与Google开源之夏
http://hi.baidu.com/opbsder/blog/item/581fb6c8fe9ffe1b7f3e6f9f.html
a GSoC studect
http://www.beijing-open-party.org/post/beijing-gnome-usergroup-12th-meeting

16:22 2012-02-24
(14:17 2012-08-02)
virtualization, suse, xen, about xen ARM virtualization
1, Initial patches for Xen ARMv7 with Virtualization Extensions applied to xen-unstable.
http://blog.xen.org/index.php/2012/02/21/initial-patches-for-xen-armv7-with-virtualization-extensions-applied-to-xen-unstable/
1), Xen port to Cortex-A15 / ARMv7 with virt extensions
http://lists.xen.org/archives/html/xen-arm/2011-11/msg00015.html
A git tree is available here: 
git://xenbits.xen.org/people/sstabellini/xen-unstable.git arm 
the gitweb url is the following: 
http://xenbits.xen.org/gitweb/?p=people/sstabellini/xen-unstable.git/.git;a=shortlog;h=refs/heads/arm 
And here is the full diff: 
http://xenbits.xen.org/people/sstabellini/diff

2, xen arm project
1), arm HVM and PV:
http://wiki.xen.org/wiki/Xen_ARMv7_with_Virtualization_Extensions
http://wiki.xen.org/wiki/Xen_ARM_(PV)
2), emulator for arm HVM:
http://wiki.xen.org/wiki/Xen_ARMv7_with_Virtualization_Extensions/FastModels

16:25 2012-02-24
时间管理
0, 11:50

1, today
1), about the libvirt compile error. see"15:59 2012-02-23".

14:21 2012-02-27
work report - week 08
1, bamvor jian zhang work report
[devel-server] work report - week 08
[GREEN]
1), continue to fix upstream libvirt compile error based on upstream xen-unstable: still some errors in libvirt libxl driver. The event process implement was not match between libvirt and libxl. 
2), all-hands with Ralf, Olaf
3), one on one with Olaf

15:09 2012-02-27
时间管理
0, 14:00-20:04

1, today
1), send work report. see"14:21 2012-02-27"
2), 我觉得我简直就是一坨屎，Ian和Jim的意思理解错了。
3), 和chunyan讨论，在sles11-sp2下使用libvirt和xenlight控制虚拟机。
	
next
),  买电脑的事情。
), follow xen blog: blog.xen.org; install a rss feed software? 
1), continue to fix libvirt compile error: run libvirt and xen in order to understant how it works. see"11:14 2012-02-22".
5), Jiaju: 建议我看看libvirt和xen的maillist, 看看有没有人讨论这个问题; 另外给Jim发邮件, 汇报一下最近的进展(Jiaju建议发到virtualization-dev)
\todo linux: halt, shutdown, poweroff的区别?

2), source code version control helper scripts. 尝试在编写自动查找版本变化的脚本, 便于做backport. 

15:56 2012-02-27
company, disk parition
   Device Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048   419428351   209713152    f  W95 Ext'd (LBA)
/dev/sda2       620943360   625141759     2099200   82  Linux swap / Solaris
/dev/sda3       419428352   620912639   100742144   83  Linux
	sles11 sp1 old: /
/dev/sda5            4096      321535      158720   83  Linux
	opensuse12.1, ext4, /boot
/dev/sda6          323584    84211711    41944064   83  Linux
	opensuse12.1, btrfs, / 
/dev/sda7        84213760   189069311    52427776   83  Linux
	opensuse12.1, btrfs, /home
/dev/sda8       189085113   231014699    20964793+  83  Linux
	sles11 sp1 bamvor, ext3, /
/dev/sda9       231014763   293925239    31455238+  83  Linux
	sles11 sp1 bamvor, ext3, /home
/dev/sda10      293925303   356835779    31455238+  83  Linux
	virtual machine disk image partition
/dev/sda11      356837376   357156863      159744   83  Linux
/dev/sda12      357158912   419428351    31134720   83  Linux

17:22 2012-02-27
1, stop xend
linux-bjzhang-2:/var/lib/xen/images_2 # xend stop
linux-bjzhang-2:/var/lib/xen/images_2 # /etc/init.d/libvirtd restart
or rclibvirtd restart
Shutting down libvirtd                                               done
Starting libvirtd                                                    done
linux-bjzhang-2:/var/lib/xen/images_2 # xl list
Name                                        ID   Mem VCPUs      State   Time(s)
(null)                                       0  3765     4     r-----     283.3
2, 开始实验时，可能修改配置文件时没有destroy vm. virsh create可能工作的有问题。
应该是先destroy再修改配置文件再create。 

18:39 2012-3-25
virtualization, xen, compile, make xen-unstable; documentation, manual
1, download
hg clone http://xenbits.xensource.com/xen-unstable.hg
or
hg clone http://xenbits.xen.org/hg/xen-unstable.hg/

2, make
1), qemu-xen-traditional-dir-remote
bamvor@localhost:~/work/virtualization/xen/upstream/xen-unstable.hg/tools/qemu-xen-traditional-dir-remote> make clean
Makefile:3: config-host.mak: No such file or directory
Makefile:4: /rules.mak: No such file or directory
make: *** No rule to make target `/rules.mak'.  Stop.

the reason: config-host.mak and SRC_PATH is not exists. So, add "-" at the beginning of include to void raising the error message while include file is not exist.
ref: http://blog.sina.com.cn/s/blog_6cc850810100r8fr.html

bamvor@localhost:~/work/virtualization/xen/upstream/xen-unstable.hg/tools/qemu-xen-traditional-dir-remote> diff Makefile.bak Makefile
3,4c3,4
< include config-host.mak
< include $(SRC_PATH)/rules.mak
---
> -include config-host.mak
> -include $(SRC_PATH)/rules.mak

2), bios
(1), make[11]: Entering directory `/home/bamvor/work/virtualization/xen/upstream/xen-unstable.hg/tools/firmware/rombios/32bit/tcgbios'
gcc   -O1 -fno-omit-frame-pointer -m32 -march=i686 -g -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wdeclaration-after-statement -Wno-unused-but-set-variable   -D__XEN_TOOLS__ -MMD -MF .tcgbios.o.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -fno-optimize-sibling-calls -mno-tls-direct-seg-refs -Werror -fno-stack-protector -fno-exceptions -fno-builtin -msoft-float -I/home/bamvor/work/virtualization/xen/upstream/xen-unstable.hg/tools/firmware/rombios/32bit/tcgbios/../../../../../tools/include -I.. -I../..  -c -o tcgbios.o tcgbios.c
In file included from /usr/include/features.h:382:0,
                 from /usr/include/stdint.h:26,
                 from /usr/lib64/gcc/x86_64-suse-linux/4.6/include/stdint.h:3,
                 from ../rombios_compat.h:8,
                 from tcgbios.c:24:
/usr/include/gnu/stubs.h:7:27: fatal error: gnu/stubs-32.h: No such file or directory
compilation terminated.
make[11]: *** [tcgbios.o] Error 1
(2), sudo zypper in glibc-devel-32bit 

3), bison and flex is not installed which lead to error: 
gcc  -O1 -fno-omit-frame-pointer -m64 -g -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wdeclaration-after-statement -Wno-unused-but-set-variable   -D__XEN_TOOLS__ -MMD -MF .libxlu_cfg_y.o.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -fno-optimize-sibling-calls -Werror -Wno-format-zero-length -Wmissing-declarations -Wno-declaration-after-statement -Wformat-nonliteral -I. -fPIC -I/home/bamvor/work/virtualization/xen/upstream/xen-unstable.hg/tools/libxl/../../tools/libxc -I/home/bamvor/work/virtualization/xen/upstream/xen-unstable.hg/tools/libxl/../../tools/include   -c -o libxlu_cfg_y.o libxlu_cfg_y.c
gcc: error: libxlu_cfg_y.c: No such file or directory
gcc: fatal error: no input files
compilation terminated.
make[4]: *** [libxlu_cfg_y.o] Error 1

(1), review the log
make[4]: Entering directory `/home/bamvor/work/virtualization/xen/upstream/xen-unstable.hg/tools/libxl'
output=libxlu_cfg_y.c libxlu_cfg_y.y
/bin/sh: libxlu_cfg_y.y: command not found
make[4]: [libxlu_cfg_y.h] Error 127 (ignored)
header-file=libxlu_cfg_l.h --outfile=libxlu_cfg_l.c libxlu_cfg_l.l
/bin/sh: header-file=libxlu_cfg_l.h: command not found
make[4]: [libxlu_cfg_l.h] Error 127 (ignored)

from the Makefile, I can found that i need bison and flex
bamvor@localhost:~/work/virtualization/xen/upstream/xen-unstable.hg/tools/libxl> vim Makefile

%.c %.h: %.y
        @rm -f $*.[ch]
        $(BISON) --output=$*.c $<

%.c %.h: %.l
        @rm -f $*.[ch]
        $(FLEX) --header-file=$*.h --outfile=$*.c $<

(3), ref: http://xen.1045712.n5.nabble.com/xen-unstable-td5542356.html#a5542514

You need to configure the path to BISON and FLEX in /config/Tools.mk 

Add lines BISON_PATH and FLEX_PATH and set them to where your BISON and 
FLEX binaries are, then add bison and flex to the BISON and FLEX 
variables.  Rerun make tools and it'll finish. 
Mike 

(4), generate by hand
bamvor@localhost:~/work/virtualization/xen/upstream/xen-unstable.hg/tools/libxl> bison --output=libxlu_cfg_y.c libxlu_cfg_y.y
bamvor@localhost:~/work/virtualization/xen/upstream/xen-unstable.hg/tools/libxl> flex --header-file=libxlu_cfg_l.h --outfile=libxlu_cfg_l.c libxlu_cfg_l.l
bamvor@localhost:~/work/virtualization/xen/upstream/xen-unstable.hg/tools/libxl> flex --header-file=libxlu_disk_l.h --outfile=libxlu_disk_l.c libxlu_disk_l.l

3, (15:29 2012-04-20)
new error
1), find 
sed 's/@VERSION@/4.1/g' < META.in >META.new && mv -f META.new META
make[7]: ocamlfind: Command not found
make[7]: ocamlfind: Command not found
make[7]: ocamlfind: Command not found
mkdir -p /usr/src/packages/SOURCES/xen-4.1.2-testing/dist/install
ocamlfind remove -destdir /usr/src/packages/SOURCES/xen-4.1.2-testing/dist/install uuid
make[7]: ocamlfind: Command not found
make[7]: *** [install] Error 127
make[7]: Leaving directory `/usr/src/packages/SOURCES/xen-4.1.2-testing/tools/ocaml/libs/uuid'
make[6]: *** [subdir-install-uuid] Error 2
2), install ocaml repo from obs
http://download.opensuse.org/repositories/home:/NaCl:/ocaml/openSUSE_11.4/
3), another error
make[7]: Entering directory `/usr/src/packages/SOURCES/xen-4.1.2-testing/tools/ocaml/libs/mmap'
 MLI      mmap.cmi
 /usr/lib64/ocaml/pervasives.cmi is not a compiled interface
 make[7]: *** [mmap.cmi] Error 2
 make[7]: Leaving directory `/usr/src/packages/SOURCES/xen-4.1.2-testing/tools/ocaml/libs/mmap'

V=1
make -C mmap install
make[7]: Entering directory `/usr/src/packages/SOURCES/xen-4.1.2-testing/tools/ocaml/libs/mmap'
ocamlc -g  -w F -warn-error F -c -o mmap.cmi mmap.mli
/usr/lib64/ocaml/pervasives.cmi is not a compiled interface
make[7]: *** [mmap.cmi] Error 2

bamvor@linux-bvirt:xen-4.1.2-testing> cat tools/Makefile  | grep OCAML_TOOLS
SUBDIRS-$(OCAML_TOOLS) += ocaml

4), after search in google, i do not know how to fix it. compile without ocaml. 
(1), how to disable it?
bamvor@linux-bvirt:xen-4.1.2-testing> cat tools/Makefile | grep -i ocaml
SUBDIRS-$(OCAML_TOOLS) += ocaml
(2), sudo make OCAML_TOOLS=n 2>&1 | tee log_make_0420_4
compile pass.

