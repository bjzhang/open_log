.LOG
21:27 2013-01-01
opensuse, arm, build sun4i image, cont1, build u-boot
1, ref u-boot build doc on git hub
https://github.com/linux-sunxi/u-boot-sunxi/wiki

10:59 2013-01-04
GTD
0, 10:45-19:55

1, today
1), 10:59-11:40 mail.
2), Jim email. "11:00 2013-01-04"
3), debug libvirt libxl console. see"16:50 2013-01-04"

11:00 2013-01-04
virtualization, libvirt, xen, xenlight, libxl, xen4.2 support, cont17, Jim's email
1, Jim
Jim Fehlig wrote:
> Bamvor Jian Zhang wrote:
>   
>> i patch u two patches to libvirt upstream code. and test hvm start, shutdown, save and pv start.
>> hvm shutdown, hvm save and pv start fail. hvm shutdown and pv start both fail at seqfault in the pthread_mutex_lock in which lock is 0. and called from libxlFDDeregisterEventHook.
>>   
>>     
>
> That is interesting.  I haven't seen this problem, but I'm back to
> testing on our Xen 4.2 packages (which include backports of Ian's
> patches).  I'll have to remove our Xen packages and try xen-untable again.
>   
>   
>> at first, i thought the failure in pv start is because libxlDomainObjPrivateFree is called before libxlFDDeregisterEventHook, but it is not happened from code or from gdb log.
>> So, what if libxlFDDeregisterEventHook is failed at the first time? it is in the pv start. and it will be failed while libxlFDDeregisterEventHook is called before libxlDomainObjPrivateAlloc. test it in gdb, gdb log approve it.
>> from gdb log, the priv is 0x712d60 same in fd register and deregister. the but virMutex is different:
>> in fd register: 0x717d60
>> in fd deregister: 0x712d70
>>   
>>     
>
> I'm testing another version of my libvirt patch that seems to work with
> Xen 4.2.  I'll try it with xen-unstable and if all goes well, I'll send
> you the updated patch for testing on your side.
>   

Ok, I've tested the attached patches on xen-unstable and do not see the
races.  I don't see any problem with hvm guests, but there is a problem
with the console on pv guests.  When viewing the guest's vnc console, I
see "serial0 console" and nothing else.  Seems like the guest is waiting
for the console to initialize before continuing booting.  The vfb setup
in xenstore is quite strange too.  xenstore-ls shows a backend vfb path
of '/local/domain/0/backend/vfb/11/-1' with the following contents

       frontend = "/local/domain/11/device/vfb/-1"
       frontend-id = "11"
       online = "1"
       state = "4"
       domain = "sles11sp2-pv"
       vnc = "1"
       vnclisten = "127.0.0.1"
       vncdisplay = "0"
       vncunused = "0"
       sdl = "0"
       opengl = "0"
       feature-resize = "1"
       hotplug-status = "connected"
       request-update = "1"

The '-1' is odd.  I haven't looked into this problem yet, but don't
think it is related to these patches.  IMO this problem is related to
some console initialization bug.

Can you review and test these patches?  I'd like to get the race issues
resolved and patches committed upstream soon.

Thanks!
Jim
2, 
Jim Fehlig wrote:
> Jim Fehlig wrote:
>   
>> Bamvor Jian Zhang wrote:
>>   
>>     
>>> i patch u two patches to libvirt upstream code. and test hvm start, shutdown, save and pv start.
>>> hvm shutdown, hvm save and pv start fail. hvm shutdown and pv start both fail at seqfault in the pthread_mutex_lock in which lock is 0. and called from libxlFDDeregisterEventHook.
>>>   
>>>     
>>>       
>> That is interesting.  I haven't seen this problem, but I'm back to
>> testing on our Xen 4.2 packages (which include backports of Ian's
>> patches).  I'll have to remove our Xen packages and try xen-untable again.
>>   
>>   
>>     
>>> at first, i thought the failure in pv start is because libxlDomainObjPrivateFree is called before libxlFDDeregisterEventHook, but it is not happened from code or from gdb log.
>>> So, what if libxlFDDeregisterEventHook is failed at the first time? it is in the pv start. and it will be failed while libxlFDDeregisterEventHook is called before libxlDomainObjPrivateAlloc. test it in gdb, gdb log approve it.
>>> from gdb log, the priv is 0x712d60 same in fd register and deregister. the but virMutex is different:
>>> in fd register: 0x717d60
>>> in fd deregister: 0x712d70
>>>   
>>>     
>>>       
>> I'm testing another version of my libvirt patch that seems to work with
>> Xen 4.2.  I'll try it with xen-unstable and if all goes well, I'll send
>> you the updated patch for testing on your side.
>>   
>>     
>
> Ok, I've tested the attached patches on xen-unstable and do not see the
> races.

Hmm, spoke too soon.  When doing save/restore in a loop, I eventually
hit a race between libxlEventHandler() and domain cleanup in
libxlDoDomainSave().

>   I don't see any problem with hvm guests, but there is a problem
> with the console on pv guests.  When viewing the guest's vnc console, I
> see "serial0 console" and nothing else.  Seems like the guest is waiting
> for the console to initialize before continuing booting.  The vfb setup
> in xenstore is quite strange too.  xenstore-ls shows a backend vfb path
> of '/local/domain/0/backend/vfb/11/-1' with the following contents
>
>        frontend = "/local/domain/11/device/vfb/-1"
>        frontend-id = "11"
>        online = "1"
>        state = "4"
>        domain = "sles11sp2-pv"
>        vnc = "1"
>        vnclisten = "127.0.0.1"
>        vncdisplay = "0"
>        vncunused = "0"
>        sdl = "0"
>        opengl = "0"
>        feature-resize = "1"
>        hotplug-status = "connected"
>        request-update = "1"
>
> The '-1' is odd.  I haven't looked into this problem yet, but don't
> think it is related to these patches.  IMO this problem is related to
> some console initialization bug.
>   

I sent a patch to xen-devel to fix this issue

http://lists.xen.org/archives/html/xen-devel/2013-01/msg00137.html

The devid field of vfb and vkb could also have been initialized in the
libxl driver, similar to how we set it in libxlMakeNicList().  But libxl
already sets devid for other devices, so seems the right place to do it
for vfb and vkb devices too.

> Can you review and test these patches?  I'd like to get the race issues
> resolved and patches committed upstream soon.
>   

No need to test the patches.  Maybe we need to rethink this whole
problem and see if there isn't a more elegant solution...

Jim

11:01 2013-01-04
company, colleague, QA, Yoonsuk Cho, report to Sebastian Vollath
"Sebastian Vollath <svollath@suse.de>"_email
it's my pleasure to announce a new team member.
Yoonsuk Cho joined the QA-EMEA team in Nuremberg today. Yoonsuk - also called
Brian - has a strong background in IBM's System Z/s390, where he will focus on
within QA.
Please join me in giving him a warm welcome and support him in getting used to
SUSE and QA.

Thanks,
  Sebastian

16:50 2013-01-04
suse, virtualization, libvirt, qemu, xen, libxlDomainOpenConsole, base on xen4.2, cont1, debug
1, seqfault
#0  0x00007f16f80e9c80 in __errno_location@plt () from /usr/lib64/libvirt.so.0
#1  0x00007f16f8217410 in virNetServerFatalSignal (sig=11,
    siginfo=0x7f16f03be570, context=0x7f16f03be440) at rpc/virnetserver.c:337
#2  <signal handler called>
#3  __pthread_mutex_lock (mutex=0x0) at pthread_mutex_lock.c:50
#4  0x00007f16f817eaec in virConsoleOpen (cons=0x0, pty=0x706b40 "/dev/pts/4",
    st=0x705900, force=false) at conf/virconsole.c:345

and the mutex is empty:
(gdb) frame 3
#3  __pthread_mutex_lock (mutex=0x0) at pthread_mutex_lock.c:50
(gdb) p mutex
$7 = (pthread_mutex_t *) 0x0
1), this is because of missing alloc and free in private alloc and free.
add virConsoleAlloc and VirConsoleFree to libxlDomainObjPrivateAlloc and libxlDomainObjPrivateFree.
2), successful in pv. add console and test it in hvm.

2, even xl and xenconsole could not got it
# xl console 5
xenconsole: Could not read tty from store: No such file or directory
1), test it on xen4.1.2
linux-work:~ # xenstore-read /local/domain/1/serial/0/tty
/dev/pts/1
2), it is not exist in xen4.2

10:14 2013-01-05
GTD
0, 9:50-10:50 12:25-13:35 15:04-18:05

1, today
1), 20' talk with Shawn. about arm multi-processor.
2), 10:23-10:50 15:04-16:11 fix xen install issue, try to update patch. see"14:30 2012-12-25". "10:30 2013-01-05"
nap 30'
3), 40' read ARM_ARM doc. see"14:04 2013-01-05"
4), 16:43-17:59 libvirt libxl blkstats: write the code for libxl qmp. see"16:44 2013-01-05"

2, daily work
1), tracking xen-arm update.
2), read libvirt and xen-devel quickly, should less that 30minutes.
3), read linux news
http://www.linux.com/
http://www.phoronix.com/scan.php?page=home

3, week plan
2), send console patch to upstream.
3), test Jim lastest Patch.

4, next
3), debug libvirt libxl console. see"16:50 2013-01-04"
1), send xen libexec patch.
1), test Jim patch for libxl xen4.2 bug. see"11:00 2012-12-21"
3), re-read all the patch about libxl xen4.2.
1), got arm technical symposia pdf.
2), libvirt blkstats:
(1), add block stats in libxl_qmp.c, add cmd in xl.
(2), add patch in libvirt, send it to Jim. if the former patch only accept by xen-unstable not xen4.2-testing. i could not send patch to libvirt upstream.
3), try xen on kvm.
4), 对于vi不能方便查找keywords这个事情, 实在不能忍了, 如果这周能把managed save和bridge-utils bug fix, 就把这个做一个.

3, next week
1), work on lock patch.
2), try to build MK802 kernel on obs. speed up. i want it work on opensuse12.3
2), read kernel doc: "10:36 2012-11-23"
1), read code for patch. see"10:25 2012-11-23"2-2)-(2).
2), after "1)" finish. try xen on kvm.
3), read the mail on "Andrew Wafaa <awafaa@opensuse.org>"_email_"[opensuse-arm] Fwd: [fedora-arm] ARMv8 Bootstrap Project"_20121122
3), work on xen on ARM. ref"22:33 2012-11-19"
4), check the error from "10:18 2012-11-15"2
2012-11-15 04:02:45.318+0000: 4307: error : virNodeGetSecurityModel:9567 : this function is not supported by the connection driver: virNodeGetSecurityModel
5), ask jim to invite me to xen irc.

3, next next
1), gsoc: "22:23 2012-11-17"
1), notes about Huawei from eet-china.
2), read bug:https://bugzilla.novell.com/show_bug.cgi?id=781425

2, next
1), try to improve attach-disk, detach-disk in libxl driver, see"18:17 2012-11-07"4
2), test attach-disk command. see"10:41 2012-10-30"2
3), maybe libxl and qemu could communicate with qemu through xenstore?

libxl_dm.c:
        /* Find uuid and the write the vnc password to xenstore for qemu. */
        t = xs_transaction_start(ctx->xsh);
        vm_path = libxl__xs_read(&gc,t,libxl__sprintf(&gc, "%s/vm", p->dom_path));
        if (vm_path) {
            /* Now write the vncpassword into it. */
            pass_stuff = libxl__calloc(&gc, 3, sizeof(char *));
            pass_stuff[0] = "vncpasswd";
            pass_stuff[1] = info->vncpasswd;
            libxl__xs_writev(&gc,t,vm_path,pass_stuff);

3, for Jim
1), xenlight event lock in libvirt. see"16:52 2012-11-06"2-1).

4, next month
1), opensuse on MK802
(1), generate the 512MB version with opensuse12.2 RC2 which enable yast fist run.
(2), try opensuse based on ubuntu kernel in order to solve the error from miniand.
2), try armv8 emulator and read armv8 kernel code.

14:04 2013-01-05
architecture, arm, read ARM_ARM doc, Long-descriptor format
1, system mmu
The field marked as Reserved for System MMU use is ignored by a processor that is using the Large Physical
Address Extension. When a processor is using this extension, the architecture guarantees that the hardware
does not alter this field.
2, Contiguous hint
Use of this hint means that the TLB can cache a single entry to cover the 16 translation table entries.
3, Use of TTBR0 and TTBR1, Long-descriptor format
Table B3-2
introduce T1SZ in TTBCR. it will use with T0SZ. 看起来这个是为了支持大于32位地址空间时，application和kernel可以用不连续的区域。是否在armv7A里面，hypervisor可以利用这个把自己放在高地址？类似x86_64里面user space and kernel space的划分。

16:44 2013-01-05
virtualization, libvirt, xenlight, add libxl api, cont3, domainBlockStats, cont2, qemu, QMP, add qmp in libxl
1, found a libxl__qmp_query_serial in libxl_qmp.c, could i get the serial device?
if serial device is found, store_serial_port_info will write it to xenstore. So, in my test, xenstore fail is because serial device is not found in qemu. but why? is it mean that libvirt do not give the serial info to libxl? \TODO. 

2, how to write the qmp for querying block stats?
qmp_run_command ->  libxl__qmp_initialize
                    qmp_synchronous_send
                    libxl__qmp_close

3, install a qemu vm and see how does the domblklist, domblkstats used in libvirt and how blockstats used in qemu monitor.

