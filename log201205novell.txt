
12:37 2012-05-03
work, virtualization, libvirt, libxl(xenlight), priority
1, "Jim Fehlig <jfehlig@suse.com>"email"libxl work"_20120427_1033
Hi Bamvor,

As mentioned on the call, I think the priorities for the libxl driver are:

1. Finish your console patches and get them upstream.  This could be
tricky if your xen patch changes the libxl interface.  Does it add or
change an API, or is it simply a bug fix?  BTW, you can send me your
current patches if you want an internal review before submitting upstream.

2. Finish Chunyan's migration patch and get it upstream.  This shouldn't
be too difficult since the patch basically works.  You will just need to
address the upstream comments, test, and submit a V2.

You can do 1 and 2 against Xen 4.1.x, which is what the current upstream
libvirt lixl driver supports.

3. Add support for xen-unstable (soon to be Xen 4.2) in the upstream
libvirt libxl driver.  I'm not sure what the best approach is for
supporting both Xen 4.1.x and >= Xen 4.2, depends on how much changed in
libxl.  If the changes aren't too bad, you could detect the libxl
version in configure.ac, and define that in config.h (see existing
examples in configure.ac, e.g. policykit0 vs policykit1).  You could
then use preprocessor conditionals to handle the changes, e.g.

#if LIBXL_V2
 blabla;
#else
  barbar;
#end

If the changes are significant, then this approach clutters the code and
you will have to think of some clever way to handle it :-).

Thanks for taking on this work!

Cheers,
Jim

2, (12:40 2012-05-08)
Hi, Jim
>
>As mentioned on the call, I think the priorities for the libxl driver are:
>
>1. Finish your console patches and get them upstream.  This could be
>tricky if your xen patch changes the libxl interface.  Does it add or
>change an API, or is it simply a bug fix?  BTW, you can send me your
>current patches if you want an internal review before submitting upstream.
I had sent the patch to upstream before my annual leave. But no response from upstream. maybe the title of the patch is not clear. I append that patch as attachment in this email, do you think it is ok to send to upstream?

>2. Finish Chunyan's migration patch and get it upstream.  This shouldn't
>be too difficult since the patch basically works.  You will just need to
>address the upstream comments, test, and submit a V2.
>
>You can do 1 and 2 against Xen 4.1.x, which is what the current upstream
>libvirt lixl driver supports.
Ok, I will do it from today.
>
>3. Add support for xen-unstable (soon to be Xen 4.2) in the upstream
>libvirt libxl driver.  I'm not sure what the best approach is for
>supporting both Xen 4.1.x and >= Xen 4.2, depends on how much changed in
>libxl.  If the changes aren't too bad, you could detect the libxl
>version in configure.ac, and define that in config.h (see existing
>examples in configure.ac, e.g. policykit0 vs policykit1).  You could
>then use preprocessor conditionals to handle the changes, e.g.
>
>#if LIBXL_V2
> blabla;
>#else
>  barbar;
>#end
>
>If the changes are significant, then this approach clutters the code and
>you will have to think of some clever way to handle it :-).
>
>Thanks for taking on this work!
>
>Cheers,
>Jim
>

12:36 2012-05-08
GTD
0, 11:55

1, today
1), reply Jim email. see"12:37 2012-05-03"2.
2), send email to HR: annual leave.
3), work report. see"13:25 2012-05-08".
4), \TODO send email to Jason, annual leave. "13:20 2012-05-08"
5), read chunyan's code. build migration test environment(not finished).

13:20 2012-05-08
work, company, virtualization team
1, Send email to Jason. about annual leave.
\TODO

13:25 2012-05-08
work report - week 17, 18
1, bamvor jian zhang work report
[devel-server] work report - week 17, week 18
[green]
1), about libvirt libxl driver.
libxlDomainOpenConsole work in para vm and hvm.
This patch for libvirt depends on a patch for xen-unstable. So, I send a patch to xen-unstable.
2), discuss with Jim about my work priorities.
3), FTO in 5.2. 5.3. 5.4

13:45 2012-05-08
virtualization, xen, libvirt, migrate; doc, document, summary, libvirt, certificate, 3-2)
1, patch chunyan's patch failed.
1), error message
bamvor@linux-bhi8:libvirt-0.9.6> patch -p1 < /home/bamvor/log/novell/xen/migrate/Chunyan\ Liu\ patch/20120327/\[PATCH\ v2\]\ Add\ migration\ APIs\ for\ libxl\ driver__only_patch.txt
patching file src/libxl/libxl_conf.c
patch: **** malformed patch at line 6: static const char *xen_cap_re = "(xen|hvm)-[[:digit:]]+\\.[[:digit:]]+-(x86_32|x86_64|ia64|powerpc64)(p|be)?";
2), ref:
(1), http://www.markusbe.com/2009/11/how-to-apply-a-patch-and-solve-hunk-failed-cant-find-file-to-patch-and-others/
The patch file is damaged. If you copy-pasted the patch from somewhere, be careful not to damage it. A patch file contains spaces at the start of lines, and these often get lost in copy-paste. The safest bet is to download the patch file. If the browser doesn’t download the patch, but instead displays it, use File -> Save.
(2), http://hi.baidu.com/comcat/blog/item/39c087d84239d33133fa1cb3.html
patch: **** malformed patch at line 129
出现这中错误，一般是 patch 生成后被手工修改了 （造成行数不匹配）
3), So, I resave Chunyan' patch from groupwise. It almost work.
bamvor@linux-bvirt:libvirt-0.9.6> patch -p1 < /home/bamvor/log/novell/xen/migrate/Chunyan\ Liu\ patch/20120327/\[PATCH\ v2\]\ Add\ migration\ APIs\ for\ libxl\ driver.txt
(Stripping trailing CRs from patch.)
patching file src/libxl/libxl_conf.c
Hunk #1 succeeded at 60 (offset -1 lines).
Hunk #2 succeeded at 93 (offset -1 lines).
Hunk #3 succeeded at 110 (offset -1 lines).
Hunk #4 succeeded at 682 (offset -8 lines).
(Stripping trailing CRs from patch.)
patching file src/libxl/libxl_conf.h
(Stripping trailing CRs from patch.)
patching file src/libxl/libxl_driver.c
Hunk #2 FAILED at 51.
Hunk #3 succeeded at 67 (offset -1 lines).
Hunk #4 succeeded at 846 (offset 23 lines).
Hunk #5 succeeded at 902 (offset 23 lines).
Hunk #6 succeeded at 1140 (offset 27 lines).
Hunk #7 FAILED at 3898.
Hunk #8 succeeded at 4621 (offset 105 lines).
2 out of 8 hunks FAILED -- saving rejects to file src/libxl/libxl_driver.c.rej
(Stripping trailing CRs from patch.)
4), the failed patch is not match between chunyan'patch and code.
I guess this patch is for libvirt upstream, try to patch with libvirt upstream successful.

2, read Chunyan's code.
1), notes
(1), doMigrateReceive
using accept directly. is that right?
2), sequence
/*
 * Sequence v3:
 *
 *  Src: Begin
 *        - Generate XML to pass to dst
 *        - Generate optional cookie to pass to dst
 *
 *  Dst: Prepare
 *        - Get ready to accept incoming VM
 *        - Generate optional cookie to pass to src
 *
 *  Src: Perform
 *        - Start migration and wait for send completion
 *        - Generate optional cookie to pass to dst
 *
 *  Dst: Finish
 *        - Wait for recv completion and check status
 *        - Kill off VM if failed, resume if success
 *        - Generate optional cookie to pass to src
 *
 *  Src: Confirm
 *        - Kill off VM if success, resume if failed
 *
 */


3, run chunyan's libvirt
1), CA error
2012-05-08 07:07:20.348+0000: 17470: debug : virEventPollAddHandle:141 : EVENT_POLL_ADD_HANDLE: watch=4 fd=11 events=0 cb=0x7f012604ba10 opaque=0x7b11f0 ff=0x7f012604d0a0
2012-05-08 07:07:20.348+0000: 17470: debug : virNetTLSContextLocateCredentials:753 : pkipath=(null) isServer=1 tryUserPkiPath=0
2012-05-08 07:07:20.348+0000: 17470: debug : virNetTLSContextLocateCredentials:825 : Using default TLS CA certificate path
2012-05-08 07:07:20.348+0000: 17470: debug : virNetTLSContextLocateCredentials:831 : Using default TLS CA revocation list path
2012-05-08 07:07:20.348+0000: 17470: debug : virNetTLSContextLocateCredentials:837 : Using default TLS key/certificate path
2012-05-08 07:07:20.348+0000: 17470: error : virNetTLSContextCheckCertFile:92 : Cannot read CA certificate '/etc/pki/CA/cacert.pem': No such file or directory
2012-05-08 07:07:20.348+0000: 17470: error : virNetlinkEventServiceStop:553 : internal error libnl was not available at build time

2), ref: http://libvirt.org/remote.html
"zypper in gnutls" for certtool
(1), generate CA
bamvor@linux-bvirt:CA> certtool --generate-privkey > cakey.pem
Generating a 2048 bit RSA private key...
bamvor@linux-bvirt:CA> cat ca.info
cn = SUSE
ca
cert_signing_key
bamvor@linux-bvirt:CA> certtool --generate-self-signed --load-privkey cakey.pem --template ca.info --outfile cacert.pem
Generating a self signed certificate...
X.509 Certificate Information:
	Version: 3
	Serial Number (hex): 4fa8c603
	Validity:
		Not Before: Tue May 08 07:06:43 UTC 2012
		Not After: Wed May 08 07:06:43 UTC 2013
	Subject: CN=SUSE
	Subject Public Key Algorithm: RSA
		Modulus (bits 2048):
			ba:a1:d8:0e:f3:d6:86:d4:5d:7e:96:d7:e0:85:5a:a4
			14:66:28:c8:3b:8c:df:ff:b7:06:09:cb:72:3c:bd:c7
			65:76:87:a1:ab:ee:d8:18:28:18:47:70:1a:68:df:40
			e5:a2:2f:13:2e:c7:84:37:52:ec:e9:46:e9:8b:3d:37
			3e:6b:03:08:8e:ca:ec:80:51:ac:b4:aa:ca:21:90:8f
			ea:b3:94:18:69:45:bb:2c:16:4b:2a:5e:a3:ea:b0:b2
			d4:2b:e5:b1:62:ea:72:49:d8:40:e4:26:51:34:35:7b
			2f:84:09:83:51:ad:16:bb:7d:cd:58:74:7d:be:dc:1b
			8f:e5:2e:8b:80:6b:51:46:05:62:93:d3:3d:32:db:ee
			29:0c:d2:6d:48:cf:33:1f:2e:d1:c5:d1:7c:1e:a3:a0
			ec:f9:45:ff:d2:d5:7f:6b:01:c7:33:1e:30:14:71:56
			36:7c:c9:60:df:49:06:97:a2:52:f0:ed:49:8c:3a:d2
			05:6a:db:f8:08:51:ee:e9:fb:b0:25:c4:cb:32:ef:d4
			ee:13:16:6d:47:31:37:89:de:c6:13:f7:b1:78:4b:9f
			ec:81:11:23:f0:62:09:68:b6:7b:e1:58:ca:ff:a8:fa
			0b:19:74:c7:c8:c4:4f:20:b0:d1:0a:df:82:e8:90:cd
		Exponent:
			01:00:01
	Extensions:
		Basic Constraints (critical):
			Certificate Authority (CA): TRUE
		Key Usage (critical):
			Certificate signing.
		Subject Key Identifier (not critical):
			d13f2e9f779ee4bda91b47e79257847f887cb2fc
Other Information:
	Public Key Id:
		d13f2e9f779ee4bda91b47e79257847f887cb2fc



Signing certificate...
bamvor@linux-bvirt:CA> sudo mkdir /etc/pki/CA
bamvor@linux-bvirt:CA> sudo cp cacert.pem /etc/pki/CA -p
root's password:

(2), another error
2012-05-08 07:07:43.406+0000: 17489: debug : virNetTLSContextLocateCredentials:753 : pkipath=(null) isServer=1 tryUserPkiPath=0
2012-05-08 07:07:43.406+0000: 17489: debug : virNetTLSContextLocateCredentials:825 : Using default TLS CA certificate path
2012-05-08 07:07:43.406+0000: 17489: debug : virNetTLSContextLocateCredentials:831 : Using default TLS CA revocation list path
2012-05-08 07:07:43.406+0000: 17489: debug : virNetTLSContextLocateCredentials:837 : Using default TLS key/certificate path
2012-05-08 07:07:43.406+0000: 17489: debug : virNetTLSContextLoadCredentials:575 : loading CA cert from /etc/pki/CA/cacert.pem
2012-05-08 07:07:43.407+0000: 17489: debug : virNetTLSContextLoadCredentials:604 : Skipping non-existent CA CRL /etc/pki/CA/cacrl.pem
2012-05-08 07:07:43.407+0000: 17489: error : virNetTLSContextCheckCertFile:92 : Cannot read certificate '/etc/pki/libvirt/servercert.pem': No such file or directory
2012-05-08 07:07:43.407+0000: 17489: error : virNetlinkEventServiceStop:553 : internal error libnl was not available at build time

(3), server certificates
bamvor@linux-bvirt:CA> certtool --generate-privkey > serverkey.pem
Generating a 2048 bit RSA private key...
bamvor@linux-bvirt:CA> cat server.info
organization = SUSE_virt
cn = SUSE_cn
tls_www_server
encryption_key
signing_key
bamvor@linux-bvirt:CA> certtool --generate-certificate --load-privkey serverkey.pem --load-ca-certificate cacert.pem --load-ca-privkey cakey.pem --template server.info --outfile servercert.pem
Generating a signed certificate...
X.509 Certificate Information:
	Version: 3
	Serial Number (hex): 4fa8c912
	Validity:
		Not Before: Tue May 08 07:19:46 UTC 2012
		Not After: Wed May 08 07:19:46 UTC 2013
	Subject: O=SUSE_virt,CN=SUSE_cn
	Subject Public Key Algorithm: RSA
		Modulus (bits 2048):
			c1:83:4b:a3:f9:97:8d:ad:a9:9d:82:a3:00:0f:46:97
			fc:b9:d0:4a:56:7c:18:03:84:6b:4b:86:67:0b:0f:e8
			57:51:d2:4e:b7:6c:9c:8d:29:1a:c9:84:9e:e2:ca:a9
			ee:63:74:93:e9:1e:2d:a1:9e:95:7e:82:2f:da:51:89
			dd:b9:35:4a:20:dd:6a:c4:f8:fb:f9:b7:84:1d:36:8a
			bd:bd:ab:3e:12:1f:ed:3f:91:5b:1c:93:2a:4c:a6:5a
			1c:f5:b0:3e:69:5e:18:78:02:1f:dd:88:d9:45:9f:b7
			f5:3e:ae:26:02:74:e0:32:f7:52:e4:57:85:c2:66:85
			65:67:72:8b:cb:c6:81:12:17:00:09:5b:ef:08:d6:92
			5a:66:dc:56:5e:6a:2d:16:d7:bf:b6:cd:47:07:52:81
			0c:1b:9e:39:34:e4:5d:d9:d8:89:6f:88:22:18:3b:d1
			59:4f:de:fc:ad:2e:15:13:81:c1:13:96:dd:d4:68:6d
			11:20:6e:8c:5c:35:be:5e:19:4f:41:16:f6:81:24:72
			34:f7:a1:d7:15:08:e9:56:6c:92:b3:ce:40:15:41:c5
			41:d1:b1:0b:b8:6f:68:ca:c5:50:55:1f:a8:d4:21:36
			2e:25:a1:ec:6e:02:78:cf:60:cd:60:ae:1c:09:9f:55
		Exponent:
			01:00:01
	Extensions:
		Basic Constraints (critical):
			Certificate Authority (CA): FALSE
		Key Purpose (not critical):
			TLS WWW Server.
		Key Usage (critical):
			Digital signature.
			Key encipherment.
		Subject Key Identifier (not critical):
			c280402993b0157f68f2f6278b95b9b11d6af6f0
		Authority Key Identifier (not critical):
			d13f2e9f779ee4bda91b47e79257847f887cb2fc
Other Information:
	Public Key Id:
		c280402993b0157f68f2f6278b95b9b11d6af6f0



Signing certificate...

(4), successful
2012-05-08 07:28:40.059+0000: 18152: debug : virNetTLSContextLocateCredentials:753 : pkipath=(null) isServer=1 tryUserPkiPath=0
2012-05-08 07:28:40.059+0000: 18152: debug : virNetTLSContextLocateCredentials:825 : Using default TLS CA certificate path
2012-05-08 07:28:40.059+0000: 18152: debug : virNetTLSContextLocateCredentials:831 : Using default TLS CA revocation list path
2012-05-08 07:28:40.059+0000: 18152: debug : virNetTLSContextLocateCredentials:837 : Using default TLS key/certificate path
2012-05-08 07:28:40.059+0000: 18152: debug : virNetTLSContextLoadCredentials:575 : loading CA cert from /etc/pki/CA/cacert.pem
2012-05-08 07:28:40.059+0000: 18152: debug : virNetTLSContextLoadCredentials:604 : Skipping non-existent CA CRL /etc/pki/CA/cacrl.pem
2012-05-08 07:28:40.059+0000: 18152: debug : virNetTLSContextLoadCredentials:617 : loading cert and key from /etc/pki/libvirt/servercert.pem and /etc/pki/libvirt/private/serverkey.pem
2012-05-08 07:28:40.314+0000: 18152: debug : virNetTLSContextNew:723 : RPC_TLS_CONTEXT_NEW: ctxt=0x7aac70 refs=1 cacert=/etc/pki/CA/cacert.pem cacrl=/etc/pki/CA/cacrl.pem cert=/etc/pki/libvirt/servercert.pem key=/etc/pki/libvirt/private/serverkey.pem sanityCheckCert=0 requireValidCert=0 isServer=1
2012-05-08 07:28:40.314+0000: 18152: debug : virNetTLSContextRef:939 : RPC_TLS_CONTEXT_REF: ctxt=0x7aac70 refs=2
2

(16:21 2013-12-18)
it will not encounter this error if disable listen_tls:
(04:15:04 PM) Chun Yan Liu: /etc/libvirt/libvirtd.conf
(04:15:07 PM) Chun Yan Liu: listen_tls=0

18:07 2012-05-08
virtualization, xen, hvm, 我发现在vmware下不启动xen时cpu flags有vmx, 启动xen后反而没有vmx了, 不知道为什么
cpu flags boot with desktop
flags		: fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss syscall nx rdtscp lm constant_tsc arch_perfmon pebs bts nopl xtopology tsc_reliable nonstop_tsc aperfmperf pni pclmulqdq vmx ssse3 cx16 sse4_1 sse4_2 popcnt aes xsave avx hypervisor lahf_lm ida arat epb xsaveopt pln pts dts tpr_shadow vnmi ept vpid

cpu flags boot with xen
flags		: fpu de tsc msr pae mce cx8 apic sep mtrr mca cmov pat clflush acpi mmx fxsr sse sse2 ss syscall nx lm constant_tsc nopl nonstop_tsc aperfmperf pni pclmulqdq ssse3 cx16 sse4_1 sse4_2 popcnt aes xsave avx hypervisor lahf_lm ida arat epb xsaveopt pln pts dts

18:23 2012-05-08
power management, acpi, xen
1, while boot with xen, support acpi mode: s0, s1, s5. while booting without xen, support acpi mode: s0, s1, s4, s5.
notes: both set acpi disable while boot.

2, Advanced Configuration and Power Interface
http://en.wikipedia.org/wiki/Advanced_Configuration_and_Power_Interface
In computing, the Advanced Configuration and Power Interface (ACPI) specification provides an open standard for device configuration and power management by the operating system.

First released in December 1996, ACPI defines platform-independent interfaces for hardware discovery, configuration, power management and monitoring. The specification is central to Operating System-directed configuration and Power Management (OSPM), a term used to describe a system implementing ACPI, which removes device management responsibilities from legacy firmware interfaces.

The standard was originally developed by Intel, Microsoft, and Toshiba, then later joined by HP, and Phoenix.[1] The latest version is "Revision 5.0," published on November 23, 2011.

Power states
[edit]Global states
The ACPI specification defines the following four Global "Gx" states and six Sleep "Sx" states for an ACPI-compliant computer-system:

G0 (S0): Working. "Awaymode" is a subset of S0, where monitor is off but background tasks are running.
G1, Sleeping subdivides into the four states S1 through S4:
S1: All processor caches are flushed, and the CPU(s) stop executing instructions. Power to the CPU(s) and RAM is maintained; devices that do not indicate they must remain on may be powered down.
S2: CPU powered off. Dirty cache is flushed to RAM.
S3: Commonly referred to as Standby, Sleep, or Suspend to RAM. RAM remains powered
S4: Hibernation or Suspend to Disk. All content of main memory is saved to non-volatile memory such as a hard drive, and is powered down.
G2 (S5), Soft Off: G2/S5 is almost the same as G3 Mechanical Off, except that the PSU still supplies power, at a minimum, to the power button to allow return to S0. A full reboot is required. No previous content is retained. Other components may remain powered so the computer can "wake" on input from the keyboard, clock, modem, LAN, or USB device.
G3, Mechanical Off: The computer's power has been totally removed via a mechanical switch (as on the rear of a PSU). The power cord can be removed and the system is safe for dis-assembly (typically, only the real-time clock continues to run - using its own small battery).[8]
Furthermore, the specification defines a Legacy state: the state on an operating system which does not support ACPI. In this state, the hardware and power are not managed via ACPI, effectively disabling ACPI.

10:43 2012-05-09
virtualization, xen, libvirt
1, vmware vm boot warning fix:
The virtual machines operating system has attempted to enable promiscuous mode on adapter Ethernet0. This is not allowed for security reasons.
ref http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&cmd=displayKC&externalId=287
chmod a+rw /dev/vmnet*

2, libvirtd start fail in vmware vm.
1), error message
linux-vm3:~ # libvirtd -l

10:36:04.513: 4776: info : libvirt version: 0.9.6
10:36:04.513: 4776: error : ebiptablesDriverInit:3779 : internal error firewall tools were not found or cannot be used
2), verbose error message
libvir: error : cannot execute binary /tmp/virtdbXPzTF: Permission denied
'
10:53:48.722: 5003: debug : ebiptablesExecCLI:2621 : rc = 0, status = 1
10:53:48.722: 5003: debug : ebiptablesExecCLI:2593 : cmd='/usr/sbin/ip6tables -n -L FORWARD'
eval res=\$\("${cmd}"\)
if [ $? -ne 0 ]; then  echo "Failure to execute command '${cmd}'.";  exit 1;fi

10:53:48.722: 5003: debug : virCommandRunAsync:2043 : About to run /tmp/virtdeRJXkn
10:53:48.723: 5003: debug : virCommandRunAsync:2059 : Command result 0, with PID 5005
10:53:48.725: 5003: debug : virCommandRun:1865 : Result exit status 1, stdout: '' stderr: '10:53:48.725: 5005: info : libvirt version: 0.9.6
10:53:48.725: 5005: debug : virCommandHook:1962 : Hook is done 0
libvir: error : cannot execute binary /tmp/virtdeRJXkn: Permission denied
'
3), on windows. no this error.

3, 但是不论wndows还是linux做host, xen vm都没法通过dhcp获得ip地址. 不知道为什么.

13:10 2012-5-9
1, EMEA: Europe, Middle East, Africa.
2, Q1 FY13 Key Opportunities
Lockhead Martin 7300K$. New MS certs: SLERT
3, brand update
1), tomorrow:
smart innovation
more than a Linux company.
2), we adapt, you secceed.
4, R&D update

17:06 2012-05-09
GTD
1, today

2, next
1), try to compile chunyan's libvirt(upstream) in ibs

17:07 2012-05-09
virtualization, vmware, xen
1, using xen vm on vmware player.
1), libvirtd work wired. and xen vm network is not right.

17:26 2012-05-09
software, skill, zypper, pattern, install kde through kde pattern
1,
zypper info -t pattern kde
Loading repository data...
Reading installed packages...


Information for pattern kde:

Repository: SLES11-SP2-Core
Name: kde
Version: 11-38.39.11
Arch: x86_64
Vendor:
Installed: Yes
Summary: KDE Desktop Environment
Description:
KDE is a powerful free software graphical desktop environment for Linux workstations. It combines ease of use, contemporary functionality, and outstanding graphical design with the technology of the Linux operating system.
Contents:

S | Name                          | Type    | Dependency
--+-------------------------------+---------+-----------
i | kfind                         | package |
i | ktimetracker                  | package |
...
i | akonadi-runtime               | package |
i | qtcurve-gtk2                  | package |
i | kdebase4-wallpapers           | package |

2,
zypper in -t pattern kde

18:08 2012-05-09
build libvirt in build service
1, ref
1), bamvor@linux-bvirt:wireshark> osc branch SUSE:SLE-11-SP2:Update:Test wireshark home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test wireshark
2), http://download.suse.de/ibs/home:/cyliu:/branches:/Devel:/Virt:/SLE-11-SP2/SLE_11_SP2_GA/

2, fail:
osc branch home:cyliu:branches:Devel:Virt:SLE-11-SP2 SLE_11_SP2_GA home:bjzhang:branches:Devel:Virt:SLE-11-SP2 SLE_11_SP2_GA home:bjzhang:branches
Server returned an error: HTTP Error 404: Not Found
home:cyliu:branches:Devel:Virt:SLE-11-SP2

3, pass
osc branch SUSE:SLE-11-SP2:Update:Test libvirt home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test libvirt

4, study: how to add my patch.
1), libvirt.spec include patch discription. i guess "series" is generate by the patch list in "%prep".
2), try it tomorrow.

9:48 2012-05-10
GTD
0, 9:30

1, today
1), install vmware tools. i wish libvirtd work right after installation.
2), build libvirt upstream with build service.
3), -18:51 try migrate with sles11 sp2 libvirt and xen. after 2) complete try it.
4), try chunyan migration patch.

10:47 2012-05-10
virtualization, xen, libvirt, build service, ibs, build libvirt upstream with build service
1, osc local build
bamvor@linux-work:libvirt> osc build SUSE:SLE-11-SP2:Update:Test
SUSE:SLE-11-SP2:Update:Test is not a valid repository, use one of: standard
bamvor@linux-work:libvirt> osc build SUSE:SLE-11-SP2:Update:Test:standard
SUSE:SLE-11-SP2:Update:Test:standard is not a valid repository, use one of: standard
bamvor@linux-work:libvirt> osc build standard
Building libvirt.spec for standard/x86_64
Getting buildinfo from server and store to /home/bamvor/sda3/home/novell/work/virtualization/build_service/home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt/.osc/_buildinfo-standard-x86_64.xml
Getting buildconfig from server and store to /home/bamvor/sda3/home/novell/work/virtualization/build_service/home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt/.osc/_buildconfig-standard-x86_64
buildinfo is broken... it says:
unresolvable: nothing provides libyajl-devel, nothing provides libcap-ng-devel >= 0.5.0, nothing provides libnetcontrol-devel >= 0.2.0
2, after check in, osc build service report the same error as osc local build.

11:48 2012-05-10
software, skill, debugger, gdb, gdbtui, command
1, ref: http://davis.lbl.gov/Manuals/GDB/gdb_21.html
C-x C-a
C-x a
C-x A
    Enter or leave the TUI mode. When the TUI mode is left, the curses window management is left and GDB operates using its standard mode writing on the terminal directly. When the TUI mode is entered, the control is given back to the curses windows. The screen is then refreshed.

C-x 1
    Use a TUI layout with only one window. The layout will either be `source' or `assembly'. When the TUI mode is not active, it will switch to the TUI mode.

    Think of this key binding as the Emacs C-x 1 binding.

C-x 2
    Use a TUI layout with at least two windows. When the current layout shows already two windows, a next layout with two windows is used. When a new layout is chosen, one window will always be common to the previous layout and the new one.

    Think of it as the Emacs C-x 2 binding.
C-L
    Refresh the screen.

In the TUI mode, the arrow keys are used by the active window for scrolling. This means they are not available for readline. It is necessary to use other readline key bindings such as C-p, C-n, C-b and C-f.

11:58 2012-05-10
virtualization, libvirt, xen, try libvirt 0.9.11 on sles11 sp2
1, libvirtd start fail with xenlight internal error.
1), "xl list" not work. even xend does not started.
xen raise "errno 13: permission denied" error.
2), debug it.
(1), fail at ioctl send xen cmd into kernel. maybe xen hypervisor not work?
(2), check the privcmd file in the linux-work which "xl list" is good.
the permission is same.
linux-work:/home/bamvor # ps -e | grep xl
14130 pts/6    00:00:00 xl
linux-work:/home/bamvor # cd /proc/14130/fd
linux-work:/proc/14130/fd # ll
total 0
lrwx------ 1 root root 64 May 10 14:36 0 -> /dev/pts/6
lrwx------ 1 root root 64 May 10 14:36 1 -> /dev/pts/6
lrwx------ 1 root root 64 May 10 14:36 2 -> /dev/pts/6
lrwx------ 1 root root 64 May 10 14:36 3 -> socket:[135077]
lrwx------ 1 root root 64 May 10 14:36 4 -> socket:[135078]
lr-x------ 1 root root 64 May 10 14:36 5 -> pipe:[135079]
l-wx------ 1 root root 64 May 10 14:36 6 -> pipe:[135079]
lrwx------ 1 root root 64 May 10 14:36 7 -> /proc/xen/privcmd
lrwx------ 1 root root 64 May 10 14:36 8 -> socket:[130750]
linux-work:/proc/14130/fd # ll /proc/xen/privcmd
-r-------- 1 root root 0 May  9 15:38 /proc/xen/privcmd
linux-work:/proc/14130/fd #
3, it work on my rd pc after downgrad xen to "4.1.2_14-0.5.5".
zypper in -f -r SLE11-SP2-Debuginfo-Core -r SLES11-SP2-Core -r sdk_dvd1 xen-tools xen-libs xen xen-debuginfo xen-debugsource xen-devel
4, libvirt-0.9.11 fail on linux-work, but successful on linux-bvirt.
1), libvirt warning:
linux-work:/etc/xen/vm # rclibvirtd restart
Shutting down libvirtd                                               done
Starting libvirtd                                                    done
linux-work:/etc/xen/vm # 2012-05-10 08:01:21.867+0000: 5649: info : libvirt version: 0.9.11
2012-05-10 08:01:21.867+0000: 5649: warning : virGetHostname:2108 : getaddrinfo failed for 'linux-work': Name or service not known

18:03 2012-05-10
virtualization, libvirt, xen, xenlight, try migrate between vm in vmware vm
1, known problem:
1), libvirt in vmware vm still not work.
unless using gdb interrupt the listen of libvirtd then continue, libvirtd will work properly.
2), vm in vmware vm can not get ip address from DHCP.
apparmer print some info while vm try to get ip address.

2, virsh create successful on local disk. but fail on remote disk.
fixed: the reason is disk image path is wrong.

3, try remote connect
1), fail because of no CA certificate
linux-vm4:/etc/xen/vm # virsh connect xen://147.2.207.157/
error: Failed to connect to the hypervisor
error: Cannot read CA certificate '/etc/pki/CA/cacert.pem': No such file or directory
add certificate ref "13:45 2012-05-08"3-2).

2), connection refused:
linux-vm4:/etc/pki/libvirt/private # export VIRSH_DEBUG=1
linux-vm4:/etc/pki/libvirt/private # export LIBVIRT_DEBUG=2
linux-vm4:/etc/pki/libvirt/private # virsh -c xen://147.2.207.157/
libvir: RPC error : unable to connect to server at '147.2.207.157:16514': Connection refused
error: unable to connect to server at '147.2.207.157:16514': Connection refused
error: failed to connect to the hypervisor

3), after change xend-config.sxp, still not work.

4, try migrate
1), fail
linux-vm5:/etc/xen/vm # virsh migrate sles11_hvm_10 xen+ssh://147.2.207.55
The authenticity of host '147.2.207.55 (147.2.207.55)' can't be established.
RSA key fingerprint is 7c:02:f4:3d:98:87:21:5e:a2:70:40:0e:4f:0f:ac:80.
Are you sure you want to continue connecting (yes/no)? yes
Password:
error: internal error getaddrinfo failed for 'linux-vm4': Name or service not known
2), try to add hostname and ip address into /etc/hosts. still not work.
(15:37 2013-01-24)
but it should be work.

10:19 2012-05-11
GTD
0, 10:00

1, today
1), from morning to 16:18 continue to try migrate. see"10:20 2012-05-11".
interrupt by lunch and company birthday party.
2), continue to try build libvirt upstream on build service. see"16:20 2012-05-11".
3), summary. libvirt migrate pass(should add ipaddress and hostname for both dst and src machine in src "/etc/hosts"). build service still failed. i should install libvirt-0.9.11 in this week.

10:20 2012-05-11
virtualization, libvirt, xen, migrate, migrate successful on libvirt xend and xm
1, continue try migrate.
1), current status
(1), connect fail
linux-vm4:/etc/xen/vm # virsh -c xen://147.2.207.157/
libvir: RPC error : unable to connect to server at '147.2.207.157:16514': Connection refused
error: unable to connect to server at '147.2.207.157:16514': Connection refused
error: failed to connect to the hypervisor
(2), migrate fail
linux-vm4:/etc/xen/vm # virsh -d 0 -l virsh_migrate_log_0511_1 migrate sles11_hvm_10_2 xen+ssh://147.2.207.157/
migrate: domain(optdata): sles11_hvm_10_2
migrate: desturi(optdata): xen+ssh://147.2.207.157/
migrate: found option <domain>: sles11_hvm_10_2
migrate: <domain> trying as domain NAME
migrate: found option <domain>: sles11_hvm_10_2
migrate: <domain> trying as domain NAME
Password:
libvir: error : internal error getaddrinfo failed for 'linux-vm5': Name or service not known
error: internal error getaddrinfo failed for 'linux-vm5': Name or service not known

2, ssh fail with hostname
linux-vm4:/etc/xen/vm # tail -n1 /etc/hosts
linux-vm5       147.2.207.157
linux-vm4:/etc/xen/vm # ssh linux-vm5
ssh: Could not resolve hostname linux-vm5: Name or service not known

ok, my god. it is because ipaddress and name is swapped!!
linux-vm4:/etc/xen/vm # tail -n2 /etc/hosts
147.2.207.77    linux-work
147.2.207.157   linux-vm5

after update the "/etc/hosts" as above. ssh is ok.

3, but virsh migrate remain failed.
try xen migrate.
xm migrate in both direction is sucessful.
"xm migrate sles11_hvm_10 linux-vm5" pass
"xm migrate sles11_hvm_10 linux-vm4" pass

4, debug
1),
doMigrate -> virDomainMigrate2 -> virDomainMigrateVersion1
virDomainMigrateVersion1 -> domainGetInfo
                         -> remoteDomainMigratePrepare

2), remote migrate
#0  remoteDomainMigratePrepare (dconn=0x6a72a0, cookie=0x7ffff1bb2b08,
    cookielen=0x7ffff1bb2b1c, uri_in=0x0, uri_out=0x7ffff1bb2b10, flags=0,
    dname=0x0, resource=0) at remote/remote_driver.c:1799
#1  0x00007ffff7abed64 in virDomainMigrateVersion1 (domain=0x6a7160,
    dconn=0x6a72a0, flags=0, dname=0x0, uri=0x0, bandwidth=0) at libvirt.c:4003
#2  0x00007ffff7ac17af in virDomainMigrate2 (domain=0x6a7160, dconn=0x6a72a0,
    dxml=0x0, flags=0, dname=0x0, uri=0x0, bandwidth=0) at libvirt.c:4908
#3  0x0000000000420178 in doMigrate (opaque=0x7fffffffdf50) at virsh.c:5564
#4  0x00007ffff7a46322 in virThreadHelper (data=0x7ffff7dd9900)
    at util/threads-pthread.c:157
#5  0x00007ffff57747b6 in start_thread () from /lib64/libpthread.so.0
#6  0x00007ffff489f9cd in clone () from /lib64/libc.so.6

3), after add ip address and hostname(147.2.207.77 linux-work) into linux-work "/etc/hosts". error message
linux-vm5:/etc/xen/vm # virsh migrate sles11_hvm_10 xen+ssh://linux-work
Password:
error: internal error getaddrinfo failed for 'linux-work': Name or service not known
change to:
linux-vm5:/etc/xen/vm # virsh migrate sles11_hvm_10 xen+ssh://linux-work
Password:
error: POST operation failed: xend_post: error from xen daemon: (xend.err "can't connect: [Errno 111] Connection refused")

4), this is because xend-config.sxp is configured in linux-work.
it is work in between linux-vm4 and linux-vm5.

16:20 2012-05-11
virtualization, libvirt, build service, build libvirt upstream on build service; software, skill, osc, update, resolved; execute cmd with auto root permission, ""6
1, after generate rpm through "make rpm" in libvirt upstream directory. osc build still failed:
bamvor@linux-x12:libvirt> osc build
Building libvirt.spec for standard/x86_64
Getting buildinfo from server and store to /home/bamvor/sda3/home/novell/work/virtualization/build_service/home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt/.osc/_buildinfo-standard-x86_64.xml
Getting buildconfig from server and store to /home/bamvor/sda3/home/novell/work/virtualization/build_service/home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt/.osc/_buildconfig-standard-x86_64
buildinfo is broken... it says:
unresolvable: nothing provides xhtml1-dtds, nothing provides iptables-ipv6, nothing provides ebtables, nothing provides /usr/bin/qemu-img, nothing provides iscsi-initiator-utils, nothing provides numactl-devel, nothing provides libwsman-devel >= 2.2.3, nothing provides scrub, nothing provides libblkid-devel >= 2.17

2, restore to orignial status, and try build
1), using "osc resolved" to clear the conflict flags
bamvor@linux-x12:libvirt> osc update -r 10303d538833ff64dced7b5c04a66aa5
skipping 'libvirt.spec' (this is due to conflicts)
At revision 10303d538833ff64dced7b5c04a66aa5.
bamvor@linux-x12:libvirt> osc resolved libvirt.spec
Resolved conflicted state of "libvirt.spec"
bamvor@linux-x12:libvirt> osc update -r 10303d538833ff64dced7b5c04a66aa5
Restored 'libvirt.spec'
At revision 10303d538833ff64dced7b5c04a66aa5.
2), fail
bamvor@linux-x12:libvirt> osc build
Building libvirt.spec for standard/x86_64
Getting buildinfo from server and store to /home/bamvor/sda3/home/novell/work/virtualization/build_service/home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt/.osc/_buildinfo-standard-x86_64.xml
Getting buildconfig from server and store to /home/bamvor/sda3/home/novell/work/virtualization/build_service/home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt/.osc/_buildconfig-standard-x86_64
buildinfo is broken... it says:
unresolvable: nothing provides libyajl-devel, nothing provides libcap-ng-devel >= 0.5.0, nothing provides libnetcontrol-devel >= 0.2.0

3, after disable unresolvable package, build starts
bamvor@linux-x12:libvirt> osc build
Building libvirt.spec for standard/x86_64
Getting buildinfo from server and store to /home/bamvor/sda3/home/novell/work/virtualization/build_service/home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt/.osc/_buildinfo-standard-x86_64.xml
Getting buildconfig from server and store to /home/bamvor/sda3/home/novell/work/virtualization/build_service/home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt/.osc/_buildconfig-standard-x86_64
Updating cache of required packages

The build root needs packages from project 'SUSE:SLE-11:Update:Test'.
Note that malicious packages can compromise the build result or even your system.
Would you like to ...
0 - quit (default)
1 - trust packages from 'SUSE:SLE-11:Update:Test' always
2 - trust them just this time
? 1
...
.
adding 'SUSE:SLE-11:GA' to ~/.oscrc: ['https://api.suse.de']['trusted_prj']
100.0% cache miss. 0/197 dependencies cached.
...
(SUSE:SLE-11:GA) rpmlint-mini-1. 100% |================| 1.1 MB    00:42
Verifying integrity of cached packages
using keys from SUSE
Writing build configuration
Running build
root's password:

The buildroot was: /var/tmp/build-root

4, \TODO: if local build libvirt 0.9.6 successful, try to build libvirt upstream.

5, (20:43 2012-05-11)
1), build error
Checking for unpackaged file(s): /usr/lib/rpm/check-files /var/tmp/libvirt-0.9.6-build
Checking for unpackaged file(s): /usr/lib/rpm/check-files /var/tmp/libvirt-0.9.6-build


RPM build errors:
    cannot open Pubkeys index using db3 - No such file or directory (2)
    File not found: /var/tmp/libvirt-0.9.6-build/var/lib/libvirt/libxl
    File not found: /var/tmp/libvirt-0.9.6-build/var/log/libvirt/libxl

The buildroot was: /var/tmp/build-root
2), try it again, build log changes
Checking for unpackaged file(s): /usr/lib/rpm/check-files /var/tmp/libvirt-0.9.6-build
Checking for unpackaged file(s): /usr/lib/rpm/check-files /var/tmp/libvirt-0.9.6-build


RPM build errors:
    File not found: /var/tmp/libvirt-0.9.6-build/var/lib/libvirt/libxl
    File not found: /var/tmp/libvirt-0.9.6-build/var/log/libvirt/libxl

3), try to build it on linux-work.
i will also fail. because xen-devel version is 3.x.x
why? see"7"

6, set root permission on osc build
1), ref: http://en.opensuse.org/openSUSE:Build_Service_Tutorial#Build_your_package_locally
If you start the build as normal user (good idea!), you will be asked for the root password of your local machine. You can avoid that if you add your user to /etc/sudoers and edit your ~/.oscrc:

su-wrapper = sudo

and with `visudo`, add the line (as root):

<your login name> ALL = NOPASSWD: /usr/bin/build
2), So, i add the following line in visudo
bamvor ALL = NOPASSWD: /usr/bin/build

7, add project throught osc meta:
if format is wrong, you will see error message, type y to edit and try again.
bamvor@linux-x12:libvirt> osc meta prj -e home:bjzhang
Sending meta data...
BuildService API error: unknown_project (404)
SUSE:SLE-11:SP2
Try again? ([y/N]): y
Sending meta data...
BuildService API error: unknown_project (404)
SLE-11:SP2
Try again? ([y/N]): y
Sending meta data...
BuildService API error: unknown_project (404)
SLE_11_SP2
Try again? ([y/N]): y
Sending meta data...
Done.

<project name="home:bjzhang">
  <title>bjzhang's Home Project</title>
  <description></description>
  <person userid="bjzhang" role="maintainer"/>
  <person userid="bjzhang" role="bugowner"/>
  <repository name="SLE_11_SP2_Update_Test">
    <path repository="standard" project="SUSE:SLE-11-SP2:Update:Test"/>
    <arch>x86_64</arch>
    <arch>i586</arch>
  </repository>
</project>

8, it is not work. try to build rpm on local machine.
if i have time, try build service later.

12:13 2012-05-12
virtualization, libvirt, xen, try libvirt 0.9.11 migrate
1, rpmbuild
ref: http://www.mail-archive.com/libvirt-users@redhat.com/msg02722.html
bamvor@linux-work:~/work/source/virtualization/libvirt/rpm/0.9.11> rpmbuild -ta libvirt-0.9.11.tar.gz  --define "_without-numactl 1"
error: Failed build dependencies:
        xhtml1-dtds is needed by libvirt-0.9.11-1.x86_64
        iptables-ipv6 is needed by libvirt-0.9.11-1.x86_64
        iscsi-initiator-utils is needed by libvirt-0.9.11-1.x86_64
        scrub is needed by libvirt-0.9.11-1.x86_64

2, I do not know the reason. maybe something is wrong for my envrionment.
3, compile libvirt upstream in each vm own.
after compile, libvirt migrate for xen is successful.
try libvirt xl migrate.

linux-vm5:~ # virsh migrate sles11_hvm_10 xen+ssh://linux-vm4
Password:
error: An error occurred, but the cause is unknown

4, \TODO: try chunyan previous patch and debug the current error.

5, (15:31 2012-05-12)
1), current status
(1), libvirt + xend live migrate pass. vm4<->vm5 both succesful.
(2), libvirt + xenlight migrate fail. vm4<->vm5 both fail.

6, debug
1), the comment of virGetHostname illustrate how to get full hostname through gethostname and getaddrinfo.
getaddrinfo is defined in netdb.h
bamvor@linux-x12:log> man getaddrinfo
Man: find all matching manual pages (set MAN_POSIXLY_CORRECT to avoid this)
 * getaddrinfo (3)
   getaddrinfo (3p)
Man: What manual page do you want?
Man: 3
bamvor@linux-x12:log> whereis netdb.h
netdb: /usr/include/netdb.h
bamvor@linux-x12:log> rpm -qf /usr/include/netdb.h
glibc-devel-2.14.1-14.12.5.x86_64
2), debug step by step, maybe fail @ virDomainMigratePerform3 -> doMigrateSend
3), but it pass while debug
(1), first banner received ok.
(2), virDomainMigratePerform3 successful.
4), debug maybe pass. but direct run must fail.
From log, I can see that Confirm is called. So, Perform must be error?
add log and recompile, fail at cannot get the second banner.
2012-05-12 09:13:39.251+0000: 25576: debug : doMigrateSend:4078 : doMigrateSend: check migrate_receiver_ready banner fail

7, try cyliu migrate patch(0.9.6-74.1) in vmware vm.

15:27 2012-05-12
GTD
0, 11:00-12:40 15:30-

1, today
1), xenlight migration on libvirt 0.9.11

11:10 2012-05-14
GTD
1, today
1), build libvirt sp2 on build service. see"11:11 2012-05-14".
2), debug why chunyan migrate patch v2 not work.
3), summary: confirm the how bug arrise is very important.

2, next
2), reply upstream email tomorrow. (already done in 5/14).

11:11 2012-05-14
virtualization, libvirt, xen, build libvirt sp2 on build service
1, rebranch sle 11 sp2 update test libvirt and compile it.
1), branch
osc branch SUSE:SLE-11-SP2:Update:Test libvirt home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test libvirt_migrate
2), checkout
osc co home:bjzhang:branches:SUSE:SLE-11-SP2:Update:Test/libvirt_migrate
3), build fail, package unresolved.

2, Jiaju suggest me change another package.
1), search all the package
bamvor@linux-bvirt:build_service> osc list | grep SP2 | grep 11 | grep -v branches
Devel:AmazonEC2:SLE-11-SP2
Devel:HAE:SLE11SP2
Devel:RTE:SLE11SP2
Devel:SAP:SLE-11:SP2
Devel:SLEPOS:SLE-11-POS-SP2
Devel:SLES4VMware:SLES11-SP2
Devel:SMT:SLE-11-SMT-SP2
Devel:SMT:SLE-11-SMT-SP2:Appliance
Devel:Virt:SLE-11-SP2
Devel:Virt:svn_autotest-xen:SLE11-SP2-Branch
QA:SLE11SP2
QA:SLE11SP2:Test
SUSE:SLE-11-SP2:GA
SUSE:SLE-11-SP2:GA:Products
SUSE:SLE-11-SP2:GA:Products:Test
SUSE:SLE-11-SP2:Remaster
SUSE:SLE-11-SP2:Update
SUSE:SLE-11-SP2:Update:AmazonEC2
SUSE:SLE-11-SP2:Update:Preload
SUSE:SLE-11-SP2:Update:Preload:2012-A
SUSE:SLE-11-SP2:Update:Products
SUSE:SLE-11-SP2:Update:Products:Test
SUSE:SLE-11-SP2:Update:Test
SUSE:icecream:SUSE:SLE-11-SP2:Update:Test

2), suddenly, I realise that chunyan use "Devel:Virt:SLE-11-SP2" to build the package. I thought "http://download.suse.de/ibs/home:/cyliu:/branches:/Devel:/Virt:/SLE-11-SP2/SLE_11_SP2_GA" was totally created by herself. how foolish I am.
osc branch Devel:Virt:SLE-11-SP2 libvirt home:bjzhang:Devel:Virt:SLE-11-SP2 libvirt
compile successful. So, last week i failed because the package is not correct.

3), enable my repo in the download.suse.de
ref "12:26 2012-05-14"

4), install
zypper ar -f http://download.suse.de/ibs/home:/bjzhang:/branches:/Devel:/Virt:/SLE-11-SP2/SLE_11_SP2_GA/ Bjzhang_Devel_Virt_SLE_11_SP2_GA
zypper mr -p 80 Bjzhang_Devel_Virt_SLE_11_SP2_GA
zypper ar -f http://download.suse.de/ibs/Devel:/Virt:/SLE-11-SP2/SLE_11_SP2_GA Devel_Virt_SLE_11_SP2_GA
zypper mr -p 81 Bjzhang_Devel_Virt_SLE_11_SP2_GA
zypper refresh
zypper in -f -r Bjzhang_Devel_Virt_SLE_11_SP2_GA libvirt libvirt-client libvirt-python

5), after install.
(1), libvirtd daemon start successful. "virsh list" works good.
but still iptables error(linux-bvirt, sles11 sp2, xen vm base on realy hardware).
12:29:08.207: 6815: info : libvirt version: 0.9.6
12:29:08.207: 6815: error : virCommandWait:2173 : internal error Child process (/usr/sbin/iptables --table mangle --delete POSTROUTING --out-interface virbr0 --protocol udp --destination-port 68 --jump CHECKSUM --checksum-fill) status unexpected: exit status 2
12:29:08.246: 6815: error : virCommandWait:2173 : internal error Child process (/usr/sbin/iptables --table mangle --insert POSTROUTING --out-interface virbr0 --protocol udp --destination-port 68 --jump CHECKSUM --checksum-fill) status unexpected: exit status 2
12:29:08.246: 6815: warning : networkAddGeneralIptablesRules:1269 : Could not add rule to fixup DHCP response checksums on network 'default'.
12:29:08.246: 6815: warning : networkAddGeneralIptablesRules:1270 : May need to update iptables package & kernel to support CHECKSUM rule.
12:29:08.498: 6815: error : virNWFilterDefParseXML:2026 : internal error unknown chain suffix 'arp-mac'
12:29:08.498: 6815: error : virNWFilterDefParseXML:2026 : internal error unknown chain suffix 'arp-ip'
12:29:08.683: 6815: warning : qemuCapsInit:842 : Failed to get host CPU

3, test Chunyan migrate v1 patch(20120302) successful 6times.
1), test on linux-x12 linux-vm4 and linux-vm5. both is vmware vm.
libvirtd still have problem on boot. manaually boot and step in gdb.

4, after serveral tries, finally compile pass.
1), try it in vmware vm.
virsh migrate not work, error message is same as last week.
but if i break in libxlCheckMessageBanner and sleep 1 second migrate is successful.(6times).
2), try it in linux-bvirt.
fail. src hang while add breakpoints

5, disscuss with jiaju. jiaju suggest me find the error path. how error generate and transfer to virsh.

12:26 2012-05-14
software, skills, build service, ibs, enable repo download in the download.suse.de
1, skill: how to export repo to download directroy.
notes: this doc could fix the error while click the link named "Go to download repository". thanks to dongmao's help.
(1), goto one branch which you want to export
e.g.
https://build.suse.de/project/show?project=home%3Abjzhang%3Abranches%3ADevel%3AVirt%3ASLE-11-SP2
(2), click the repositories button on the top of web
"Overview Sources Repositories Revisions Requests Users Advanced"
Then you will jump to the link where you can change the repo flags:
https://build.suse.de/package/repositories?package=libvirt&project=home%3Abjzhang%3Abranches%3ADevel%3AVirt%3ASLE-11-SP2
(3), explicit Publish Flag, then you can download the repo in the "http://download.suse.de/ibs/home:/bjzhang:/branches:/Devel:/Virt:/SLE-11-SP2/SLE_11_SP2_GA/"

2, you can do the same thing to generate debuginfo and debugsource rpm.

10:59 2012-05-15
GTD
0, 10:40-18:45 20:48-22:27

1, today
1), 40' reply to upstream about my libvirt patch. see"11:00 2012-05-15".
2), work report. see"13:06 2012-05-15".
3), afternoon: debug chunyan' patch, migration pass after my patch. see"14:17 2012-05-15".
4), 20:48-21:30 check upstream reply. see"11:00 2012-05-15"
5), try to build libvirt upstream again(just download the lastest code).

11:00 2012-05-15
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream
1, "Ian Jackson <Ian.Jackson@eu.citrix.com>"_email_"Re: [Xen-devel] [PATCH] [mq]: patch_libxl_get_console_tty.diff"_20120511_0102
Bamvor Jian Zhang writes ("[Xen-devel] [PATCH] [mq]: patch_libxl_get_console_tty.diff"):
> diff -r 9dda0efd8ce1 -r 4a6043e1434a tools/libxl/libxl.c
> --- a/tools/libxl/libxl.c	Fri Apr 27 17:57:55 2012 +0200
> +++ b/tools/libxl/libxl.c	Sat Apr 28 22:36:56 2012 +0800
> @@ -15,6 +15,8 @@
>   */
>
>  #include "libxl_osdeps.h"
> +//#include "libxl_osdeps.h"
> +//#include "libxl_osdeps.h"

Thanks for posting this but was int actually inteded for inclusion in
the tree ?  If so we need a commit message and a Signed-off-by and so
forth.  Also we may be too late for 4.2 considering the feature
freeze.

> +int libxl_get_console_tty(libxl_ctx *ctx, uint32_t domid, char **path)
> +{

We already have various functions to refer to and open consoles, which
have much of this functionality in them already.  That shouldn't be
duplicated.

Also we need to make a policy decision about whether the fact that the
console looks like a tty is a part of the API.

> +/* libxl_get_console_tty get the tty path from xenstore according to the
> + * domain id.
> + */
> +int libxl_get_console_tty(libxl_ctx *ctx, uint32_t domid, char **path);

In any case the doc comment should not mention xenstore.  It should
also document the memory allocation behaviour.

Ian.

2, I do not know why the format is not correct, try it later.

3, reply
Hi, Ian

thanks your reply.
>Bamvor Jian Zhang writes ("[Xen-devel] [PATCH] [mq]: patch_libxl_get_console_tty.diff"):
>> diff -r 9dda0efd8ce1 -r 4a6043e1434a tools/libxl/libxl.c

>Thanks for posting this but was int actually inteded for inclusion in
>the tree ?  If so we need a commit message and a Signed-off-by and so
>forth.  Also we may be too late for 4.2 considering the feature
>freeze.
I am sorry maybe there are something wrong in my hgrc settings. the patch including comments and Signed-off-by in my ".hg/patches" directory.
I understand that 4.2 is almost release. meanwhile, my patch is useful for adding a api in libvirt for xenlight open console commands.

>> +int libxl_get_console_tty(libxl_ctx *ctx, uint32_t domid, char **path)
>> +{
>
>We already have various functions to refer to and open consoles, which
>have much of this functionality in them already.  That shouldn't be
>duplicated.
>
>Also we need to make a policy decision about whether the fact that the
>console looks like a tty is a part of the API.
sorry i only found one api about open console is libxl_console_exec. libxl_console_exec call xenconsole command directly which is not compatible with libvirt open console api. libvirt open console want a console device path and handle the console by libvirt itself. libvirt xen(not xenlight) driver read console path from xenstore directly which is prohibited by libvirt xenlight drvier.
So, because these reasons, i guess add this simple api to return console path to libvirt is a good choice. it is useful for libvirt and do not break libxl api.
>
>> +/* libxl_get_console_tty get the tty path from xenstore according to the
>> + * domain id.
>> + */
>> +int libxl_get_console_tty(libxl_ctx *ctx, uint32_t domid, char **path);
>
>In any case the doc comment should not mention xenstore.  It should
>also document the memory allocation behaviour.
I will change it in my next version.
>
>Ian.

4, (20:52 2012-05-15)
"Ian Campbell <Ian.Campbell@citrix.com>"_email_20120515_1714

On Tue, 2012-05-15 at 06:06 +0100, Bamvor Jian Zhang wrote:
> >> +int libxl_get_console_tty(libxl_ctx *ctx, uint32_t domid, char **path)
> >> +{
> >
> >We already have various functions to refer to and open consoles, which
> >have much of this functionality in them already.  That shouldn't be
> >duplicated.
> >
> >Also we need to make a policy decision about whether the fact that the
> >console looks like a tty is a part of the API.

> sorry i only found one api about open console is libxl_console_exec.
> libxl_console_exec call xenconsole command directly which is not
> compatible with libvirt open console api. libvirt open console want a
> console device path and handle the console by libvirt itself. libvirt
> xen(not xenlight) driver read console path from xenstore directly
> which is prohibited by libvirt xenlight drvier.
> So, because these reasons, i guess add this simple api to return
> console path to libvirt is a good choice. it is useful for libvirt and
> do not break libxl api.

We actually discussed the existing interface in the context of the libxl
stable API (sub-thread starting at
<20357.44324.27939.514126@mariner.uk.xensource.com> which has a lot of
sub-threads. Another interesting bit starts at
<20358.47143.994639.76453@mariner.uk.xensource.com>)

In that thread IanJ said:
> ]   int libxl_vncviewer_exec(libxl_ctx *ctx, uint32_t domid, int autopass);
> ]   int libxl_console_exec(libxl_ctx *ctx, uint32_t domid, int cons_num, libxl_console_type type);
> ]   /* libxl_primary_console_exec finds the domid and console number
> ]    * corresponding to the primary console of the given vm, then calls
> ]    * libxl_console_exec with the right arguments (domid might be different
> ]    * if the guest is using stubdoms).
> ]    * This function can be called after creating the device model, in
> ]    * case of HVM guests, and before libxl_run_bootloader in case of PV
> ]    * guests using pygrub. */
> ]   int libxl_primary_console_exec(libxl_ctx *ctx, uint32_t domid_vm);
>
> These functions should not exec things for you; they should tell you
> the parameters.  Any execing helpers should be in libxlu.

and later on he said, in response to some of my musings:
> But what if your vnc viewer doesn't have the command line options
> these functions expect ?  libxl_vncviewer_* should give you an idl
> struct containing the ip address (or perhaps the domain name), port
> number, and password.

I think the same can be said of libxl_console_*.

In the end I decided:
> this seems like 4.3 material at this stage.
>
> I'd expect that the functions which behaved this way would not be
> called ..._exec (perhaps ..._get_params or so) so implementing the
> proper interface in 4.3 won't cause a compat issue.

I think I'd be happy to make a freeze exception for a patch which
implemented the returning of an IDL struct representing the console
device for the benefit of libvirt, so long as it is pretty much self
contained (which I think it will be).

I don't see any need for it to be a requirement to switch xl over to
this new interface at this stage, but we could mark the exec functions
as already deprecated in 4.2 and plan to do so (with associated libxlu
helpers) in 4.3.

This still leaves us having to decide if we want to expose the fact that
the console is a tty. Perhaps a compromise would be to include a
libxl_console_type enum and KeyedUnion of params, currently the only
possible value for the enum would be "PTY" (or "TTY")? (or maybe we can
leave that until the second one comes along...)

Ian.

5, read this reply carefully.
1), summary
(1), it is my fault, not search the existing maillist.
and all this discuss happen in the April. There is not doubt that i should read the xen and libvirt mailing list everyday.
(2), i indeed considered that maybe i could add a item in console relative struct.  但是我没有做进一步的工作。
2), From Ian'reply, I think if i update my patch with proper struct and good extension, Ian will ack my patch.
discuss with jiaju tomorrow.
3), upstream relative discuss
http://lists.xen.org/archives/html/xen-devel/2012-04/msg00040.html

13:06 2012-05-15
work report - week 19
[devel-server] work report - week 19
[green]
1), start work on Chunyan liu's patch for libvirt migration.
(1), read the patch and test it.
v2 patch do not works on my computer while v1 works.
(2), if i sleep 1 second before and after source vm suspend through gdb "commands" v2 patch works.

13:38 2012-05-15
maillist, devel-server, bootloader.
1, "Michael Chang <mchang@suse.com>"
work on bootloader: grub and UEFI.

14:17 2012-05-15
virtulization, libvirt, xen, migration, debug chunyan'patch
1, read migrate code.
1), xc_domain_save: core function for suspend. write all status and memory through fd passed from suspend or migration.

2, add debug info in gdb
1), .gdbinit
set breakpoint pending on
break libxlCheckMessageBanner
commands 1
print libxlCheckMessageBanner
cont
end

break virDispatchError
commands 2
print virDispatchError
if ( 0 ==  virLastErrorObject()->code )
    where
end
cont
end

2), virDispatchError back trace
Breakpoint 2, virDispatchError (conn=0x7ad660)
    at util/virterror.c:607
607     {
$3 = {void (virConnectPtr)} 0x7ffff7007890 <virDispatchError>
#0  virDispatchError (conn=0x7ad660) at util/virterror.c:607
#1  0x00007ffff7072b24 in virDomainMigratePerform3 (
    domain=0x7db5e0, xmlin=0x0, cookiein=0x0, cookieinlen=0,
    cookieout=0x7fffeeefab30, cookieoutlen=0x7fffeeefab3c,
    dconnuri=0x0, uri=0x7a91e0 "linux-vm5:49512", flags=0,
    dname=0x0, bandwidth=0) at libvirt.c:5702
#2  0x0000000000427457 in remoteDispatchDomainMigratePerform3 (
    ret=<optimized out>, args=<optimized out>,
    rerr=<optimized out>, hdr=<optimized out>,
    client=<optimized out>, server=<optimized out>) at remote.c:3000
#3  remoteDispatchDomainMigratePerform3Helper (
    server=<optimized out>, client=0x7dc850, hdr=<optimized out>,
    rerr=0x7fffeeefabf0, args=0x7db650, ret=0x7d0be0)
    at remote_dispatch.h:3014
#4  0x00000000004442f7 in virNetServerProgramDispatchCall (
    msg=<optimized out>, client=<optimized out>,
    server=<optimized out>, prog=<optimized out>)
    at rpc/virnetserverprogram.c:401
#5  virNetServerProgramDispatch (prog=0x7993c0, server=0x78f1b0,
    client=0x7dc850, msg=0x7fffe4000c10)
    at rpc/virnetserverprogram.c:287
#6  0x0000000000446e1c in virNetServerHandleJob (
    jobOpaque=<optimized out>, opaque=0x78f1b0)
    at rpc/virnetserver.c:136
#7  0x00007ffff6ffedd4 in virThreadPoolWorker (
    opaque=<optimized out>) at util/threadpool.c:144
#8  0x00007ffff6ffe6a2 in virThreadHelper (data=0xffffffff)
    at util/threads-pthread.c:157
#9  0x00007ffff31ae7b6 in start_thread ()
   from /lib64/libpthread.so.0
#10 0x00007ffff2d069cd in clone () from /lib64/libc.so.6
#11 0x0000000000000000 in ?? ()

3, add more debug message
1),
set breakpoint pending on

break virDispatchError
commands
print virDispatchError
if ( 0 ==  virLastErrorObject()->code )
    where
end
continue
end

break libxl/libxl_driver.c:4093
commands
p "libxlCheckMessageBanner 1st"
continue
end

break libxl/libxl_driver.c:4102
commands
p "libxl_domain_suspend"
continue
end

break libxl/libxl_driver.c:4110
commands
p "libxlCheckMessageBanner 2nd"
cont
end

2, i found dst will dispatch error in Finish3:
Breakpoint 1, virDispatchError (conn=0x7fffe40811d0)
    at util/virterror.c:607
607     {
$3 = {void (virConnectPtr)} 0x7ffff7007890 <virDispatchError>
#0  virDispatchError (conn=0x7fffe40811d0) at util/virterror.c:607
#1  0x00007ffff7063353 in virDomainMigrateFinish3 (
    dconn=0x7fffe40811d0, dname=0x7a4900 "sles11_hvm_10",
    cookiein=0x0, cookieinlen=0, cookieout=0x7fffedef8b60,
    cookieoutlen=0x7fffedef8b6c, dconnuri=0x0,
    uri=0x75e990 "linux-vm4:49512", flags=0, cancelled=1)
    at libvirt.c:5756
#2  0x0000000000427243 in remoteDispatchDomainMigrateFinish3 (
    ret=<optimized out>, args=<optimized out>,
    rerr=<optimized out>, hdr=<optimized out>,
    client=<optimized out>, server=<optimized out>) at remote.c:3049
#3  remoteDispatchDomainMigrateFinish3Helper (
    server=<optimized out>, client=0x7fffe4000c50,
    hdr=<optimized out>, rerr=0x7fffedef8bf0, args=0x7a4b40,
    ret=0x7d4ec0) at remote_dispatch.h:2875
#4  0x00000000004442f7 in virNetServerProgramDispatchCall (
    msg=<optimized out>, client=<optimized out>,
    server=<optimized out>, prog=<optimized out>)
    at rpc/virnetserverprogram.c:401
#5  virNetServerProgramDispatch (prog=0x7993c0, server=0x78f1b0,
    client=0x7fffe4000c50, msg=0x8278a0)
    at rpc/virnetserverprogram.c:287
#6  0x0000000000446e1c in virNetServerHandleJob (
    jobOpaque=<optimized out>, opaque=0x78f1b0)
    at rpc/virnetserver.c:136
#7  0x00007ffff6ffedd4 in virThreadPoolWorker (
    opaque=<optimized out>) at util/threadpool.c:144
#8  0x00007ffff6ffe6a2 in virThreadHelper (data=0x0)
    at util/threads-pthread.c:157
#9  0x00007ffff31ae7b6 in start_thread ()
   from /lib64/libpthread.so.0
#10 0x00007ffff2d069cd in clone () from /lib64/libc.so.6
#11 0x0000000000000000 in ?? ()

3, continue debugging
1), confirm that libxlCheckMessageBanner do not get the message
$5 = "libxlCheckMessageBanner 2nd"
111: buf is , errno is 11, ret is 0
$6 = "libxl_domain_resume"
2), using reverse debug it
(1), .gdbinit
#using target record and record stop to record the history about saferead.
set breakpoint pending on

break libxl/libxl_driver.c:4110
commands
silent
p "libxlCheckMessageBanner 2nd"
target record
continue
end

break libxl_domain_resume
commands
silent
p "libxl_domain_resume"
#continue
record stop
end

(2), debug
set exec-direction reverse
next program to libxlCheckMessageBanner
set exec-direction forward
step into saferead
(16:40 2013-03-13)
unlimit the instruction in gdb record:
set record insn-number-max 0
the default limit is 200000 instructions.
"16:40 2013-03-13"end

3), result: saferead read buf twice, first time get a EINTR, second time get a EAGAIN.
how xl handle the process?

4), modify libxlCheckMessageBanner
from
static int libxlCheckMessageBanner(int fd, const char *banner, int banner_sz)
{
    char buf[banner_sz];

    if (saferead(fd, buf, banner_sz) != banner_sz || memcmp(buf, banner, banner_sz)) {
        return -1;
    }

    return 0;
}

to
static int libxlCheckMessageBanner(int fd, const char *banner, int banner_sz)
{
    char buf[banner_sz];
    int ret = 0;

    do {
        ret = saferead(fd, buf, banner_sz);
    } while ( -1 == ret && EAGAIN == errno );

    if ( ret != banner_sz || memcmp(buf, banner, banner_sz) )
        return -1;

    return 0;
}

5), notes: previous version is 0.9.6-25.1


4, debug new rpm: 0.9.6-26.1
test pass. 4times.

5, discuss with jiaju. next step:
1), read xl code in xen. try to find out why using sting to sync between source and destination. whether block and non-block socket used by xl. whether handle the EAGAIN error while read failed.
2), read libvirt qemu migration code. check the samething as above.

10:22 2012-05-16
GTD
0, 10:22-17:15

1, today
1), check email and mailing list.
2), discuss with jiaju about upstream reply to my libxl console api patch. ref: "11:00 2012-05-15"
3), 40' try to build libvirt-0.9.12 on vm4 and vm5, successful. see"13:56 2012-05-16".
4), 14:55-16:49 read xl migrate and libvirt qemu migrate code. see"10:26 2012-05-16"

10:26 2012-05-16
virtualization, libvirt, xen, xenlight, migration, read xl migrate and libvirt qemu migrate code; software, skill, run command on ssh connection: 1-1).
1, xl code.
1), using xl migrate-receice at the dst
asprintf(&rune, "exec %s %s xl migrate-receive%s%s",
     ssh_command, host,
     daemonize ? "" : " -e",
     debug ? " -d" : "")
2), libxl_userdata_retrieve
(1), read domain config from "/var/lib/xen/userdata-xxx" in userdata_path function.
(2), read config from this file.
3), xl use two block pipe for check banner and suspend respectively.
using migrate_read_fixedmessage sync serveral times.
4), read "xl migrate-receive".
both "xl migrate" and "xl migrate-receive" execute: "signal(SIGPIPE, SIG_IGN);". what does it mean?
"man 2 signal"
*  If the disposition is set to SIG_IGN, then the signal is ignored.
"man 7 signal"
       SIGPIPE      13       Term    Broken pipe: write to pipe with no
                                     readers

2, libvirt
1), virNetSocketNew: set sock fd as non block through set_nonblocking_flag functions:
return ioctl (desc, FIONBIO, &v);
2), libvirt qemu migrate.
(1), there are lots of cookie functions. i do not know what does these mean.

3, \TODO check pipe and socket attribute by software in order to comfirm the current analysis.

10:33 2012-05-16
virtualization, mailing list, libvirt; devel-server: openstack, provo
1, libvirt
1), How to use a Virtio-serial port
"Michal Privoznik <mprivozn redhat com>"_email_"Re: [libvirt] How to use a Virtio-serial port"_20120515_1043
https://www.redhat.com/archives/libvir-list/2012-May/msg00786.html
When you start your domain and then dump its XML it will look like this:

    <channel type='pty'>
      <source path='/dev/pts/12'/>
      <target type='virtio' name='arbitrary.virtio.serial.port.name'/>
      <alias name='channel0'/>
      <address type='virtio-serial' controller='0' bus='0' port='2'/>
    </channel>

So one end of the channel is inside the domain under
/dev/virtio-ports/arbitrary.virtio.serial.port.name and the other one is
under /dev/pts/12 in the host. Therefore running:

(guest) cat /dev/virtio-ports/arbitrary.virtio.serial.port.name
(host) echo "Hello world" > /dev/pts/12

will do all the magic. You can use any tool that is able to work with
unix domain sockets. I personally use socat [1].

1: http://www.dest-unreach.org/socat/

2), about unprivileged socket
\TODO: what does "@" mean?
"Daniel P. Berrange <berrange redhat com>"_email_"[libvirt] [PATCH] Move user libvirtd socket out of abstract namespace"_20120514_1518
https://www.redhat.com/archives/libvir-list/2012-May/msg00742.html

The current unprivileged user libvirtd sockets are in the abstract
namespace. This has a number of problems

 - You can't connect to them remotely using the nc/ssh tunnel
 - This is not portable for OS-X
 - Parent directory permissions don't apply
---
 daemon/libvirtd.c          |    2 +-
 src/remote/remote_driver.c |    2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/daemon/libvirtd.c b/daemon/libvirtd.c
index 5830069..2696c54 100644
--- a/daemon/libvirtd.c
+++ b/daemon/libvirtd.c
@@ -300,7 +300,7 @@ daemonUnixSocketPaths(struct daemonConfig *config,
             }
             umask(old_umask);

-            if (virAsprintf(sockfile, "@%s/libvirt-sock", rundir) < 0) {
+            if (virAsprintf(sockfile, "%s/libvirt-sock", rundir) < 0) {
                 VIR_FREE(rundir);
                 goto no_memory;
             }
diff --git a/src/remote/remote_driver.c b/src/remote/remote_driver.c
index 4a9299a..5c87561 100644
--- a/src/remote/remote_driver.c
+++ b/src/remote/remote_driver.c
@@ -583,7 +583,7 @@ doRemoteOpen (virConnectPtr conn,
                 if (!userdir)
                     goto failed;

-                if (virAsprintf(&sockname, "@%s/" LIBVIRTD_USER_UNIX_SOCKET, userdir) < 0) {
+                if (virAsprintf(&sockname, "%s/" LIBVIRTD_USER_UNIX_SOCKET, userdir) < 0) {
                     VIR_FREE(userdir);
                     goto out_of_memory;
                 }
--
1.7.10.1

3), libvirt 0.9.12 release
https://www.redhat.com/archives/libvir-list/2012-May/msg00707.html
about 1.0.0 release
https://www.redhat.com/archives/libvir-list/2012-May/msg00090.html

consider the libvirt 0.9.12 is release, i will try to work on this version for chunyan migrate patch.

4), about lock
(1), "Daniel P. Berrange <berrange redhat com>"_email_20120510
On Thu, May 10, 2012 at 11:20:20PM +0800, Oscar Ben wrote:
> In the discussion :
>          http://thread.gmane.org/gmane.comp.emulators.libvirt/53534
>
> People mentioned about long-term operations' LOCKs there. It seems that, in
> libxl_driver, certain opeations may hold a lock for too long, thus other
> operations, even those just do query jobs, would be blocked.
>
> In qemu_driver, there seems to be a more complexy way to solve this
> problem, by employing a condition variable.

Yep, that's pretty much the approach we'd want to take for libxl too
I believe.

> My question is :
>    Is "Fixing such problem in libxl_driver" in our todo-list?

Yes

>    If yes, what's the detailed solution? Will that be similar to qemu's
> CONDITION VARIABLE method?

Yes

Daniel
(2), Jim_email_20120510
Agreed.

Chunyan, the author of the patch Oscar mentions, is on maternity leave
now.  Bamvor (cc'd) is becoming familiar with the patch, review
comments, etc. and will submit a new version.  Part of that work will
need to include addressing the locking issues noted in the thread.

Regards,
Jim

5), Report error when parsing character device target type
Jim_email_"[libvirt] [PATCH] Report error when parsing character device target type"_20120509_1148
https://www.redhat.com/archives/libvir-list/2012-May/msg00529.html
this is a bug reported to bugzilla:
https://bugzilla.novell.com/show_bug.cgi?id=761314

No useful error was being reported when an invalid character device
target type is specified in the domainXML. E.g.

    ...
    <console type="pty">
      <source path="/dev/pts/2"/>
      <target type="kvm" port="0"/>
    </console>
    ...

resulted in

error: Failed to define domain from x.xml
error: An error occurred, but the cause is unknown

With this small patch, the error is more helpful

error: Failed to define domain from x.xml
error: XML error: unknown target type 'kvm' specified for character device
---
 src/conf/domain_conf.c |    3 +++
 1 files changed, 3 insertions(+), 0 deletions(-)

diff --git a/src/conf/domain_conf.c b/src/conf/domain_conf.c
index 976e42b..54ac1db 100644
--- a/src/conf/domain_conf.c
+++ b/src/conf/domain_conf.c
@@ -4895,6 +4895,9 @@ virDomainChrDefParseTargetXML(virCapsPtr caps,
     if ((def->targetType =
          virDomainChrTargetTypeFromString(caps, vmdef,
                                           def->deviceType, targetType)) < 0) {
+        virDomainReportError(VIR_ERR_XML_ERROR,
+                             _("unknown target type '%s' specified for character device"),
+                             targetType);
         goto error;
     }

--
1.7.8.3

2, devel-sever
1), provo openstack work
Jim_email_work_report_week19
Jason, Bo Yang, and myself managed to resolve all the networking issues in
the provo cloud (cloud.virt.lab.novell.com).  Everything seems to be working
on a basic level.  I've put some kvm and xen (pv and hvm) images in glance,
started instances from those, and attached volumes and public IPs to the
instances.  auto_assign_floating_ip isn't working - needs further
investigation.  In general, seems stable enough to let the SUSE provo folks
have at it :-).

11:33 2012-05-16
company, document, presentation, training
1, http://147.2.207.240/presentations/
including "12.03.2012 	Kernel Crash Dump Training 	Petr Tesarik"

13:56 2012-05-16
virtualization, libvirt, compile, try to build libvirt-0.9.12 on vm
1, build sucessful on linux-work.

2, fail on vm4 and vm5.
1), error message
In file included from util/virnetlink.c:37:
util/virnetlink.h:43: error: expected declaration specifiers or '...' before 'uint32_t'
util/virnetlink.h:43: error: expected declaration specifiers or '...' before 'uint32_t'
util/virnetlink.c:635: error: expected declaration specifiers or '...' before 'uint32_t'
util/virnetlink.c:636: error: expected declaration specifiers or '...' before 'uint32_t'
make[3]: *** [libvirt_util_la-virnetlink.lo] Error 1
2), compare the configure log for linux-work and linux-vm4.
the key different is OPENWSMAN and LIBNL.
930,931c930
< checking for OPENWSMAN... no
< configure: openwsman is required for the Hyper-V driver, disabling it
---
> checking for OPENWSMAN... yes
954c953
< checking for LIBNL... no
---
> checking for LIBNL... yes
3), install libnl-devel and re-configure
notes: if enable hyper-v, need install openwsman-client and openwsman-python.

3, libvirt-0.9.12 run successful on vm4 and vm5: test create and migrate commands on xen.
migrate on xenlight will fail with the same error: "error: An error occurred, but the cause is unknown"
after add sleep one second while enter libxlCheckMessageBanner, migrate 6times pass.

test commands
1), migrate from linux-vm5 to linux-vm4
linux-vm4:/etc/xen/vm # virsh -c xen+ssh://linux-vm5
Password:
Welcome to virsh, the virtualization interactive terminal.

Type:  'help' for help with commands
       'quit' to quit

virsh # list
 Id    Name                           State
----------------------------------------------------
 3     sles11_hvm_10                  running

virsh # quit

linux-vm4:/etc/xen/vm # virsh -c xen+ssh://linux-vm5 migrate sles11_hvm_10 xen+ssh://linux-vm4
Password:
The authenticity of host 'linux-vm4 (147.2.207.55)' can't be established.
RSA key fingerprint is 7c:02:f4:3d:98:87:21:5e:a2:70:40:0e:4f:0f:ac:80.
Are you sure you want to continue connecting (yes/no)? yes
Password:

linux-vm4:/etc/xen/vm # virsh list
 Id    Name                           State
----------------------------------------------------
 5     sles11_hvm_10                  running

2), migrate from linux-vm4 to linux-vm5
linux-vm4:/etc/xen/vm # virsh migrate sles11_hvm_10 xen+ssh://linux-vm5
Password:

11:37 2012-05-17
GTD
0, 11:10-12:20 13:30-19:02 20:35-22:37

1, today
1), 20' check email. see"11:29 2012-05-17"
2), 12:11-12:20 13:30-14:20 reply to Jim about my work. see"11:39 2012-05-17"
3), continue to read libvirt qemu driver. see"16:29 2012-05-17", ref "10:26 2012-05-16".
4), summary: it takes me 1.5 hour to draw libvirt migrate graph, but the process is slow.

11:29 2012-05-17
openSUSE, SUSE, mailing list, get suse version
1, best way to detect SLE service pack?
1), "Scott Bahling <sbahling@suse.com>"_email_"[Research] Packaging: best way to detect SLE service pack?"
We have the %sles_version rpm macro, but this does not reflect a service
pack level. The only option I have found is parsing /etc/SuSE-release.
2), bamvor: test it.
(1), sles11 sp2
# cat /etc/SuSE-release
SUSE Linux Enterprise Server 11 (x86_64)
VERSION = 11
PATCHLEVEL = 2
# cat /etc/SuSE-brand
SLES
VERSION = 11
CO-BRANDS = SLE openSUSE
(2), opensuse12.1
> cat /etc/SuSE-brand
openSUSE
VERSION = 12.1
> cat /etc/SuSE-release
openSUSE 12.1 (x86_64)
VERSION = 12.1
CODENAME = Asparagus

11:35 2012-05-17
company, suse, build service, obs, new maintenance model, FAQ; check the maintenance version, osc sm
1, FAQ about new maintenance model
1), [devel] FAQ for the New Maintenance Model
h14:36 2014-04-08ttps://wiki.innerweb.novell.com/index.php/Maintenance/SLE11_SP2_MM_FAQ
notes: save as /home/bamvor/log/novell/suse/SLE11_SP2_MM_FAQ.pdf
(1), Which products participate in it?
    SLES 11 SP1/SP2, also SLES for VMware and SLES for SAP
    SLED 11 SP1/SP2
    SDK 11 SP1/SP2
All other products use individual update policies that are sometimes similar (e.g. for SLE11 HA), but they continue to use the traditional channel layout well known from SLE10.
(2), With the deployment of OBS 2.3 in the internal build service, the osc commands "osc sm" (for searchmaintained) and "osc mbranch" (for branch maintained packages) have become a lot more useful for SLE maintenance.
with osc 0.134 or newer the commands should give you valid information about what to do:
 $ iosc sm curl
 ...
 SUSE:SLE-11-SP1:Update:Test/curl
 ...
(3), You can use these commands to prepare a maintenance update:
 $ iosc bco SUSE:SLE-11-SP1:Update:Test curl
 ...
 $ osc vc
 ...
 $ osc ci
 ...
 $ osc sr

2), test it. i found that wireshark only have 10_sp3, 11, 9_sp3 three maintenance. this is the same result while i fix security bug on wireshark.
bamvor@linux-work:~> osc sm libvirt
SUSE:SLE-10-SP4:Update:Test/libvirt
SUSE:SLE-11-SP1:Update:Test/libvirt
SUSE:SLE-11-SP2:Update:Test/libvirt
bamvor@linux-work:~> osc sm wireshark
SUSE:SLE-10-SP3:Update:Test/wireshark
SUSE:SLE-11:Update:Test/wireshark
SUSE:SLE-9-SP3:Update:Teradata:Test/wireshark

2, (16:29 2014-04-08)
some additional doc:
maintenance model changes after sle11 sp2
there is some explanation about osc sm(search maintained), mbranch(branch maintained package) and other commands:
https://wiki.innerweb.novell.com/index.php/Maintenance/SLE11_SP2_MM_FAQ#How_to_do_all_that_with_the_build_service_.3F

11:39 2012-05-17
company, work, Jim; virtualization, libvirt, xenlight, migrate, reply to Jim about my work
1, Jim_email_20120516_2253
Trimming the list and adding Bamvor...

Jason Douglas wrote:
> I have an appointment that conflicts with this weeks call. I see two options: a) continue with the call in my absence or b) reschedule for next week. Please reply with your preferences. Thanks.
>

I need to talk to Bamvor, but that can happen on IM or IRC.

Bamvor, I looked for you on IM yesterday (probably near your lunch time)
but didn't see you online.  I would like to get a status update on the
libvirt libxl work.  Would you prefer talking on IM or having the phone
call?  We could use the time scheduled for this week's meeting.

Thanks,
Jim

2, reply to Jim
Hi, Jim

here is the status of my work.
1), libvirt libxl work
(1), current status
chunyan migrate patch v2 work with my a little patch(libxlCheckMessageBanner function in xl_migrate_patchv2_sles11sp2__bamvor_fix_migrate_failed.patch in attachment)(still need to update).

chunyan v2 patch is not work on libvirt 0.9.6 and libvirt 0.9.12(lastest stable version). after some debug, i found that migration failed because the source vm did not receive the handshake message from destination vm after source vm suspend finished. if i add a infinite loop for re-reading while EAGAIN encountered, migrate successful.
compare with v2 and v1 migrate patch, non-block socket is instead of block socket because Chunyan call libvirt socket api to create the socket. virNetSocketNewConnectTCP set non-block attribute while create the socket.

for non-block file, poll and read is more suitable than infinite read loop. but i could not know how long the time out is ok.

(2), So, I plan to change the libvirt lixl migrate as libvirt qemu migrate code: remove the handshake message.
it looks like the handshake message add in libvirt libxl driver is inherited from xl light driver which do not have the dedicate daemon for vm management like libvirtd.
In libvirt qemu driver, there is no more handshake message bwteewn dstination and source qemu process except transfer the virtual machine state(cpu status, memory, etc).

(3), the following work for chunyan migration patch is not started
((1)), lock.
((2)), unfinished test for chunyan migrate. chuyan mentioned in her mail.
Update vm status to VIR_DOMAIN_PAUSED and event when migration failed and vm resume failed on source
((3)), migrate bug found by chunyan herself.
The problem issuing virsh command will kill live migration still unsolved.

2), about xen patch for my libvirt libxlDomainOpenConsole API.
I have discuss with Ian at:
http://lists.xen.org/archives/html/xen-devel/2012-05/msg00970.html
http://lists.xen.org/archives/html/xen-devel/2012-05/msg00984.html

Ian said
> I think I'd be happy to make a freeze exception for a patch which
> implemented the returning of an IDL struct representing the console
> device for the benefit of libvirt, so long as it is pretty much self
> contained (which I think it will be).

So, Should I update my patch and try again? But if i add a api which return a struct, it maybe affect the struct in libxl.h and libvirt. Looks more work need to do.
Do i have a chance to commit my patch before xen4.2 release?

3, reply to Jason
Hi, Jason

I have discussed with Jim today. We agree with that talk on IM on tomorrow meeting time.
before talk on IM, i will send i work status to Jim.

Bamvor

16:29 2012-05-17
virtualizaton, libvirt, qemu, migrate; install qemu vm from scratch; qemu migration; qemu configuration file location: 6
1, install qemu and restart libvirtd.
# virsh -c qemu:///system version
Compiled against library: libvir 0.9.12
Using library: libvir 0.9.12
Using API: QEMU 0.9.12
error: failed to get the hypervisor version
error: internal error Cannot find suitable emulator for x86_64

# rclibvirtd restart

# virsh -c qemu:///system version
Compiled against library: libvir 0.9.12
Using library: libvir 0.9.12
Using API: QEMU 0.9.12
Running hypervisor: QEMU 0.10.1

2, create qemu vm
1), create image
ref: http://en.wikibooks.org/wiki/QEMU/Images
linux-vm4:/var/lib/xen/images_2/sles11_qemu_12 # qemu-img create -f qcow2 disk0.img 2G
Formatting 'disk0.img', fmt=qcow2 size=2147483648 encryption=off cluster_size=65536
linux-vm4:/var/lib/xen/images_2/sles11_qemu_12 # file disk0.img
disk0.img: Qemu Image, Format: Qcow , Version: 2
linux-vm4:/var/lib/xen/images_2/sles11_qemu_12 # ll disk0.img
-rw-r--r-- 1 nobody nogroup 197120 May 17  2012 disk0.img
2), convert qemu command lines libvirt xml
(1), ref the command line create by libvirt
/usr/bin/qemu -S -M pc-0.14 -m 512 -smp 1,sockets=1,cores=1,threads=1 -name opensuse12_qemu_9 -uuid 55c53a6e-49f6-adea-6b3b-d162f3c80ab4 -nodefconfig -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/opensuse12_qemu_9.monitor,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc -no-shutdown -drive file=/var/lib/qemu/images/opensuse11_qemu_9/disk0.raw,if=none,id=drive-virtio-disk0,format=raw -device virtio-blk-pci,bus=pci.0,multifunction=on,addr=0x5.0x0,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=21,id=hostnet0 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:1b:f6:14,bus=pci.0,multifunction=on,addr=0x3.0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -usb -vnc 127.0.0.1:0 -vga cirrus -device AC97,id=sound0,bus=pci.0,multifunction=on,addr=0x4.0x0 -device virtio-balloon-pci,id=balloon0,bus=pci.0,multifunction=on,addr=0x6.0x0"}
(2), my commands
qemu-system-x86_64 -m 512 -smp 2 -name sles11_qemu_12 -drive file=/var/lib/xen/images_2/sles11_qemu_12/disk0.img,if=ide -usb -vga cirrus -cdrom /home/bamvor/work/download/sles11/SLES-11-SP2-DVD-x86_64-GMC-DVD1.iso -vnc 127.0.0.1:0
notes:
((1)), qemu 0.10 does support some options, disable. using -cdrom instead of "-drive".
((2)), if do not add vnc parameter, qemu will exit while you close vnc viewer.
(3), convert to libvirt xml
((1)), linux-vm4:/etc/xen/vm # virsh -c qemu:///system  domxml-from-native qemu-argv sles11_qemu_12__qemu_config
error: internal error missing index/unit/bus parameter in drive 'file=/var/lib/xen/images_2/sles11_qemu_12/disk0.img,if=ide'
((2)), qemu-system-x86_64 -m 512 -smp 2 -name sles11_qemu_12 -drive file=/var/lib/xen/images_2/sles11_qemu_12/disk0.img,if=ide -usb -vga cirrus -cdrom /home/bamvor/work/download/sles11/SLES-11-SP2-DVD-x86_64-GMC-DVD1.iso -vnc 127.0.0.1:0
create vm successful.
(4), boot
linux-vm4:/etc/xen/vm # virsh -c qemu:///system create sles11_qemu_12.xml
error: Failed to create domain from sles11_qemu_12.xml
error: Cannot find QEMU binary qemu-system-x86_64: No such file or directory
((1)), add full path for qemu-system-x86_64
linux-vm4:/etc/xen/vm # diff sles11_qemu_12.xml sles11_qemu_12.xml.1
18c18
<     <emulator>/usr/bin/qemu-system-x86_64</emulator>
---
>     <emulator>qemu-system-x86_64</emulator>

linux-vm4:/etc/xen/vm # virsh -c qemu:///system  domxml-from-native qemu-argv sles11_qemu_12__qemu_config  > sles11_qemu_12.xml
((2)), fail at display
linux-vm4:/etc/xen/vm # virsh -c qemu:///system create sles11_qemu_12.xml error: Failed to create domain from sles11_qemu_12.xml
error: internal error process exited while connecting to monitor: Could not initialize SDL - exiting
add "-vnc 127.0.0.1:0" in sles11_qemu_12__qemu_config, convert to xml again.
((3)), create vm successful
linux-vm4:/etc/xen/vm # virsh -c qemu:///system create sles11_qemu_12.xml Domain sles11_qemu_12 created from sles11_qemu_12.xml

linux-vm4:/etc/xen/vm # virsh -c qemu:///system list
 Id    Name                           State
----------------------------------------------------
 3     sles11_qemu_12                 running

linux-vm4:/etc/xen/vm # virsh -c qemu:///system vncdisplay
error: command 'vncdisplay' requires <domain> option
linux-vm4:/etc/xen/vm # virsh -c qemu:///system vncdisplay 3
127.0.0.1:0
((4)), but do not boot from cdrom
add "-boot d" in sles11_qemu_12__qemu_config.
((5)), do not point vnc port:
change
    <graphics type='vnc' port='5900' autoport='no' listen='127.0.0.1'>
      <listen type='address' address='127.0.0.1'/>
    </graphics>
to
    <graphics type='vnc'/>
((6)), disk size is wrong(192k) while installation. i should set disk type as qcow2 in xml:
linux-vm4:/etc/xen/vm # diff sles11_qemu_12.xml_disk_wrong_missing sles11_qemu_12.xml
20a21
>       <driver name='qemu' type='qcow2'/>
((7)), change ps2 mouse as usb tablet. ref "11:29 2012-03-19".
but it does not improve the mouse.

3, draw libvirt qemu migrate graph.
1), bamvor@linux-x12:migrate> dot -Tjpg libvirt_qemu_migrate.dot -o libvirt_qemu_migrate.jpg
Error: libvirt_qemu_migrate.dot:3: syntax error near line 3
context:     >>>  Src_Begin[label="Begin"; <<<  shape = plaintext];
fix: using ";" cause the error:
change
    Src_Begin[label="Begin"; shape = plaintext];
to
    Src_Begin[label="Begin", shape = plaintext];

4, (11:00 2012-05-18)
redirect monitor
1), ref:
-mon chardev=charmonitor,id=monitor,mode=control
failed.

5, migrate
1), try migrate in qemu
http://www.linux-kvm.org/page/Migration
A is the source host, B is the destination host:
TCP example:
1. Start the VM on B with the exact same parameters as the VM on A, in migration-listen mode:
B: <qemu-command-line> -incoming tcp:0:4444 (or other PORT))
2. Start the migration (always on the source host):
A: migrate -d tcp:B:4444 (or other PORT)
3. Check the status (on A only):
A: (qemu) info migrate

2), try migrate in libvirt
virsh # migrate --live sles11_qemu_12 qemu+ssh://linux-vm5/system
Password:
error: Unsafe migration: Migration may lead to data corruption if disks use cache != none
(1), set cache=none:
<driver name='qemu' type='qcow2' cache='none'/>

3), uuid is same
virsh # migrate --live sles11_qemu_12 qemu+ssh://linux-vm5/system
Password:
error: internal error Attempt to migrate guest to the same host 564d4cec-93b7-860c-380f-66f07406362b
(1), compare these two vmware vm xxx.vmx configuration file. the uuid.bios is same, uuid.locatio is different.
bamvor@linux-x12:log> cat /home/bamvor/work_bak/sles11_sp2_x86_64_5/sles11_sp2_x86_64_4.vmx | grep uuid
uuid.location = "56 4d a6 d2 5e 53 71 d9-cf 6e 97 83 9e 76 25 c6"
uuid.bios = "56 4d 4c ec 93 b7 86 0c-38 0f 66 f0 74 06 36 2b"
bamvor@linux-x12:log> cat /home/bamvor/work_bak/sles11_sp2_x86_64_4/sles11_sp2_x86_64_4.vmx | grep uuid
uuid.location = "56 4d 4c ec 93 b7 86 0c-38 0f 66 f0 74 06 36 2b"
uuid.bios = "56 4d 4c ec 93 b7 86 0c-38 0f 66 f0 74 06 36 2b"
change vm5 uuid.location as uuid.bios
(2), migration successful

6, qemu configuration file location
1), # ll /var/run/libvirt/qemu/
total 8
-rw------- 1 root root    5 May 16 18:44 sles11_qemu_12.pid
-rw------- 1 root root 3005 May 16 18:44 sles11_qemu_12.xml

linux-vm5:/var/run/libvirt # cat qemu/sles11_qemu_12.pid
11009linux-vm5:/var/run/libvirt #
linux-vm5:/var/run/libvirt # ps -e| grep qemu
11009 ?        00:02:42 qemu-system-x86
2), # file sles11_qemu_12.monitor
sles11_qemu_12.monitor: socket
3), (11:58 2012-05-24)
the file under "/var/run/libvirt/qemu/" only exist while the vm exist in vm management list(e.g. "virsh list"). it will be deleted after destroy or migration.

7:56 2012-5-18
company, virtualization, libvirt, xen, migrate, "virsh console", talk with Jim on IM
1, notes:
1), xen patch
Jim Fehlig: but instead of returning a string, return an IDL struct containing the console device info
Jim Fehlig: similar to the way libxl_device_disk_getinfo(), libxl_device_nic_getinfo(), etc. do

Jim Fehlig: you'll need to get that done before anything else
Bamvor Jian Zhang: ok.
Jim Fehlig: if you wait too long, he wont accept it
Jim Fehlig: maybe even respond to his mail saying that you are working on his suggested approach
Jim Fehlig: so he knows it will be coming
Bamvor Jian Zhang: ok. i could reply to him today.

2), libxl new lock.

3), libxl migration.

2, I do not know change the sequence whether affect live migration or not.
about lock.

11:36 2012-05-18
GTD
0, 7:50-9:00 10:20-11:50 12:52-14:20 nap 14:50-15:30 16:20-17:31

1, today
1), talk with Jim on IM. see"7:56 2012-5-18".
2), 1h send email to Ian.
3), 1h try qemu migration and libvirt qemu migration. see"16:29 2012-05-17"4
4), 15:30-16:20  取公积金支取记录单。see"14:49 2012-01-30"3-2).

11:39 2012-05-18
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream, cont1, reply to Ian
1, reply to Ian.
Hi, Ian

> I think I'd be happy to make a freeze exception for a patch which
> implemented the returning of an IDL struct representing the console
> device for the benefit of libvirt, so long as it is pretty much self
> contained (which I think it will be).
thanks. I am working on it. i will send the patch v2 soon.

Bamvor

2, notes
it takes a lots time to write this reply. i am not sure how to reply it.

17:13 2012-05-18
virtualization, libvirt, build service, obs/ibs, build libvirt on suse/sles
1, Jim Fehlig try to compile libvirt 0.9.12 on opensuse12.2 factory, I could try to build libvirt 0.9.12 on sles11_sp2 base on his works:
1), osc -A https://api.opensuse.org branch home:jfehlig libvirt home:bjzhang:branches:home:jfehlig libvirt
2), from the libvirt.spec, i can see that he using open-iscsi instead of iscsi-initiator-utils
< Recommends:     open-iscsi
> Requires: iscsi-initiator-utils

17:15 2012-05-18
virtualization, xen, arm; opensuse, arm
1, website and slide
http://wiki.xen.org/wiki/XenARM
http://www.slideshare.net/xen_com_mgr/12-sangbum-sxenarmprojectupdate
http://www.slideshare.net/xen_com_mgr/hardware-accelerated-virtualization-in-the-arm-cortex-processors
http://www.slideshare.net/xen_com_mgr/9-xs-asia11jnakajimamobilevirt

2, code
http://xenbits.xen.org/ext/arm/xen-unstable.hg
http://xenbits.xen.org/gitweb/?p=people/jm77ryu/xen-arm.git;a=summary
http://xenbits.xen.org/gitweb/?p=people/jm77ryu/xen-unstable-arm.git;a=summary

3, (12:26 2012-05-22)
http://en.opensuse.org/Portal:ARM
http://en.opensuse.org/openSUSE:OpenSUSE_on_your_ARM_board

4, (13:52 2012-05-22)
useful link for opensuse arm
1), docs
(1), openSUSE:ARM distribution howto
http://en.opensuse.org/openSUSE:ARM_distribution_howto
The openSUSE Build Service hosts a shadow project of openSUSE:Factory which builds all sources for ARM architectures.
You must use osc, build, qemu, qemu-linux-user and build-initvm from openSUSE:Tools:Unstable project to get all required fixes.
(2), getting started
http://lizards.opensuse.org/2012/01/19/running-opensuse-on-arm/
http://lizards.opensuse.org/2012/01/21/opensuse-arm-image/
chroot script for opensuse arm
http://michal.hrusecky.net/2011/10/opensuse-arm-chroot-less-then-alpha/
2), supportted arm boards
http://en.opensuse.org/openSUSE:Supported_ARM_boards
omap2plus 	OMAP3 BEAGLE board (xM) 		http://beagleboard.org/
omap2plus 	DEVKIT8000 board
support beagle and devkit 8000 is great for me. i should found a possible configuation board for my ema3530.
3), prebuild image
http://download.opensuse.org/repositories/openSUSE:/Factory:/ARM/images/

11:55 2012-05-19
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream, cont2, Ian new email, reply
1, Ian change his mind.
"Ian Jackson <Ian.Jackson@eu.citrix.com>"_email_"Re: [Xen-devel] [PATCH] [mq]: patch_libxl_get_console_tty.diff"_20120518_1601

Bamvor Jian Zhang writes ("Re: [Xen-devel] [PATCH] [mq]: patch_libxl_get_console_tty.diff"):
> Hi, Ian
> > I think I'd be happy to make a freeze exception for a patch which
> > implemented the returning of an IDL struct representing the console
> > device for the benefit of libvirt, so long as it is pretty much self
> > contained (which I think it will be).
>
> thanks. I am working on it. i will send the patch v2 soon.

Sorry to throw a spanner in the works, but I think actually that this
isn't really the right approach.

Having the considered the question I think we should indeed expose the
fact that there is (or can be) a tty as part of the libxl API.  And I
don't really want to introduce a new complex IDL struct with only one
user.

So your old interface, along these lines, is good:

  int libxl_get_console_tty(libxl_ctx *ctx, uint32_t domid, char **path)

However, it should probably be in teh same pattern as
libxl_console_exec and libxl_primary_console_exec.

So:

  int libxl_console_get_tty(libxl_ctx *ctx, uint32_t domid,
                            int cons_num, libxl_console_type type,
                            char **path);
  int libxl_primary_console_get_tty(libxl_ctx *ctx, uint32_t domid,
                            char **path);

These should probably reuse the same innards as the _exec functions.


Are you planning to do anything about libxl_vncviewer_exec ?

Ian.

2, thinking
1), console and vnc is differenct for libvirt.
libvirt manage the console by itself(open, read, write, etc...) while call vncviewer directly for vnc.
So, the api for console and vnc maybe different.
2), about libxl_console_exec.
i do not consider the num of console which is handered in xenconsole.
3), next
(1), rewrite libxl_get_console_tty as libxl_console_get_tty and libxl_primary_console_get_tty.
((1)), coding
考虑如何缩进。
((2)), change comment according to Jim and Ian's comments.
((3)), send patch in new mail. and reply the original mail to inform Ian.
(2), read the code about libxl vncviewer in xen and libvirt. know that does this .

3, coding
1), what does studdom_id mean?

11:56 2012-05-19
GTD
0, 11:50-13:03 14:50-17:42

1, today
1), 1h mailing list. see"15:01 2012-05-19".
2), summarise the build service in my log. see"16:05 2012-05-19".
3), xen patch. see"11:55 2012-05-19".

15:01 2012-05-19
virtualization, maillist, list, devel-server; openstack; cpufreq module auto load while system booting
1, Bo yang
1), follow up
bnc#760753: scp between two vms on the same machine fails.
2), openstack: vm instance creatation flow:
* openstack with Jim, architecture of openstack, interactions between
main components of openstack, some of the request flow. rabbit queue and
nova database are the core part of nova, they interact with nova-api,
nova-scheduler, nova-network, nova-compute, nova-volume. learned about
the jobs being did by each component. Have no much idea about how glance
works, I mean I still have no much idea how images are added to glance,
but for the vm instance part, images are pulled out from glance to the
proper compute node. which would be: cli -> nova-api -> rabbit queue ->
scheduler -> database [find out the proper computing node] -> glance
[find out the proper image] -> nova-compute [pull image and start vm
instance] -> nova-network[configure private ip and floating/public ip],
roughly. :)
I decide to ignore the authentication/authorization[keystone] part and
the storage[swift] part for now, have a look at it later if time permits.

2, Thomas Renninger <trenn@suse.de>
keywords: system boot up, initrd, module auto load, cpufreq
[Bug 756085] cpufreq modules are not being loaded
-> fix submitted mainline
https://bugzilla.novell.com/show_bug.cgi?GoAheadAndLogIn=1&id=756085
1), Thomas fimiliar with system boot up process. About this bug, He mentioned that
" Use x86 CPU autoloading (est feature) for acpi-cpufreq driver loading.
The idea is to use the new X86 CPU autoloading feature and try to load the
driver if the est (Enhanced Speed Step) feature is detected."
The bug is fininal fixed by this est. this key code of this patch is:
+++ linux-3.4-rc6-master/drivers/cpufreq/acpi-cpufreq.c
+static const struct x86_cpu_id acpi_cpufreq_ids[] = {
+	/* Enhanced Speed Step */
+	X86_FEATURE_MATCH(X86_FEATURE_EST),
+	{}
+};
+MODULE_DEVICE_TABLE(x86cpu, acpi_cpufreq_ids);

16:05 2012-05-19
software, skill, opensuse, suse, sle, build serivce: obs/ibs, osc; document, collection, summary
1, build service(obs/ibs) osc tutorial:
1), http://en.opensuse.org/openSUSE:Build_Service_Tutorial
2), http://linuxtoy.org/archives/learn-obs-with-marguerite-1.html

2, usage log:
1), maintenance package: how to fix bug and commit update to suse upstream on build service: "13:07 2012-04-17", "12:32 2012-04-16".

3, skill
1), how to publish rpm from build service to download.suse.de/ibs/home/yourname: "12:26 2012-05-14".
2), how to build debugsource and debuginfo on buildservice: "12:26 2012-05-14".
3), opensuse new maintenance model, a little affect on build serivce: "11:35 2012-05-17".

20:58 2012-05-20
GTD
0, 20:50-22:50

1, today
1), xen patch. see"21:09 2012-05-20"

21:09 2012-05-20
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream, cont3, write new patch
1, "domain_path/image/device-model-domid" is written by "libxl_create_stubdom" while libxl_device_model_info.device_model is "stubdom-dm".

do_domain_create -> libxl__create_device_model
libxl__create_xenpv_qemu -> libxl__create_device_model
libxl__create_device_model -> libxl_create_stubdom

2, build error on ibs
very foolise errors...
gcc  -fmessage-length=0 -O2 -Wall -D_FORTIFY_SOURCE=2  -funwind-tables -fasynchronous-unwind-tables -O2 -fomit-frame-pointer -m64 -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wno-unused-value -Wdeclaration-after-statement  -O2 -fomit-frame-pointer -m64 -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wno-unused-value -Wdeclaration-after-statement  -O2 -fomit-frame-pointer -m64 -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wno-unused-value -Wdeclaration-after-statement  -D__XEN_TOOLS__ -MMD -MF .subdirs-install.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE  -O2 -fomit-frame-pointer -m64 -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wno-unused-value -Wdeclaration-after-statement  -D__XEN_TOOLS__ -MMD -MF .subdir-install-libxl.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE  -O2 -fomit-frame-pointer -m64 -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wno-unused-value -Wdeclaration-after-statement  -D__XEN_TOOLS__ -MMD -MF .libxl_create.o.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE  -Werror -Wno-format-zero-length -Wmissing-declarations -I. -fPIC -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/libxc -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/include -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/libxc -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/include -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/xenstore -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/include -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/blktap2/control -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/blktap2/include -I/usr/src/packages/BUILD/xen-4.1.2-testing/tools/libxl/../../tools/include -c -o libxl_create.o libxl_create.c
libxl.c: In function 'libxl_console_get_tty':
libxl.c:813: error: incompatible type for argument 1 of 'libxl__xs_get_dompath'
libxl.c:816: error: incompatible type for argument 1 of 'libxl__sprintf'
libxl.c:820: error: incompatible type for argument 1 of 'libxl__sprintf'
libxl.c:822: error: 'num' undeclared (first use in this function)
libxl.c:822: error: (Each undeclared identifier is reported only once
libxl.c:822: error: for each function it appears in.)
libxl.c:822: error: incompatible type for argument 1 of 'libxl__sprintf'
libxl.c:828: error: incompatible type for argument 1 of 'libxl__xs_read'
cc1: warnings being treated as errors
libxl.c:811: error: unused variable 'vm_uuid'
libxl.c:811: error: unused variable 'os_type'
libxl.c:810: error: unused variable 'vm_uuid_path'
libxl.c:810: error: unused variable 'os_type_path'

2), error again
libxl.c: In function 'libxl_console_exec':
libxl.c:778: error: 'domid_vm' undeclared (first use in this function)
libxl.c:778: error: (Each undeclared identifier is reported only once
libxl.c:778: error: for each function it appears in.)

3), i586 compile successful. waiting x86_64 build finish.
build the xen unstable at the same time on the linux-work.

3, thinking
Ian Jackson and Ian Campbell say difference approach. what should i do?

12:22 2012-05-21
GTD
0, 11:10-12:22 14:01-19:07

1, today
1), install and test my new patch for xen console get tty.
2), 30' check the mail. HDD rescure. see"14:15 2012-05-21".
3), spend all the afternoon for compile upstream and send patch. see"14:54 2012-05-21"

14:15 2012-05-21
mailing list, research, hardware, HDD rescure; raid; hdparm
1, "Jean Delvare <jdelvare@novell.com>"_email_"[Research] HDD rescue options"_20120503_1705
I plan to put the drive in one of my Linux systems, and then use the
right tool for the job. I thought the right tool was dd_rescue, but now
I see that there exists another one named gnu_ddrescue, and the
articles I found [1] suggest that gnu_ddrescue is better.

[1] http://ubuntu-rescue-remix.org/node/51

2, "Reinhard Max <max@suse.de>"_email
ddrescue did work great and so is TestDisk and Photorec.  However, one limitation about Photorec is it doesn't preserve the directory structure and filenames.  So, you will have to find other ways to figure out what has been recovered.
As Frederic said, Photorec could be quite useful for smaller disks and not for those that contains GBs of data.
I also used a tool from the UBCD (Ultimate Boot CD [1]) that recovered some important pieces of data for me.
HTH,
V. Varadhan
[1] - http://www.ultimatebootcd.com/

3, "Jean Delvare <jdelvare@suse.de>"_email_20120509_1530
Thanks for all the replies. For anyone interested, here are the results
from my work last week-end.

I started by trying to mount the dying disk under openSUSE 11.4, but
that wouldn't work. So I used dd_rescue to create an image of the disk.
It took about 13 hours and reported 16 errors (2 groups of 8 consecutive
512-byte sectors). Then I flushed the image to another physical disk,
and put that disk in a Windows machine, asking it to repair the
filesystem. It was able to do so and my brother-in-law could recover all
the personal data he was interested in.

Then I looked at the kernel logs and found complaints about only 2
unreadable sectors on the disk. I also looked at the SMART log and found
errors claiming that sector auto-reallocation did not happen, plus a
mention of 2 reads pending. This is when I found this very interesting
article:

http://www.sjvs.nl/?p=12

The author explains that hard disk drives won't reallocate sectors on
read errors, only on write errors. So you can have a completely dead
sector on the drive and it will never be reallocated even after a
hundred read errors. If it happens to be used for the filesystem
structure or metadata then too bad for you, your disk is unmountable.

I followed the instructions in the article and used hdparm to force a
write to the two dead sectors. Then I moved the original disk to the
Windows machine and let fsck happen. It worked just fine, with fewer
errors than I had had when doing the same on the flushed image. By now
the dying disk is back to its original host and everything works just
fine. And my brother-in-law has bought an external disk to make backups
from times to times. Lessons learned :)

One interesting thing to notice is that, while there were only 2 dead
sectors on the disk, dd_rescue failed to copy 16. That's not what I
would expect from a tool specialized in hard disk rescue and reading the
disk as slowly as 6 MB/s. This makes me suspect that I would have had
the same results from just using dd with the proper options, and it may
even have been faster. Maybe this is a bug in dd_rescue that should get
fixed, if it did not happen already.

4, ""Mike Latimer" <mlatimer@suse.com>"_email_20120521_1031
Thanks for following up, Jean. Your findings matched my HDD problems exactly - but I had a couple of surprises waiting.

I received 3 hard drives. One external backup drive, and two "mirrored" drives. The external drive was seriously damaged and sector zero could not even be read. If I would have had a donor drive, I would have been tempted to physically tear into that drive, but as it was just a backup, I turned my attention to the other two drives.

The two "mirrored" drives were actually an 80GB drive, and a 160GB drive, so I was immediately suspicious of a mirrored configuration. I tried the 80GB first, and was able to dd a complete image without issue. (I also noted that this drive did not contain a partition record, or obvious RAID signature.) The 160GB drive reported two bad sectors during the first imaging attempt. Using your hdparm trick, I wrote to the two problem sectors, and then was able to successfully grab a complete image of the disk.

After I had the two disk images, I found that the 160GB disk had a valid MBR and partition table, which showed two partitions - a Dell utility partition, and a 160GB NTFS partition. The Dell partition was on the 160GB disk, but the beginning of the NTFS partition was not found at the offset specified. However, I was able to locate the NTFS signature on the 80GB disk. At that point in time, I decided I was dealing with some type of striping (at least).

Since I could not find a RAID signature, I thought I must be dealing with some type of hardware RAID. Using trial and error, I figured out that the RAID chunk size was 128k. I then wrote a quick script to build a non-raid version of the disk by alternating 128k chunks from each disk, and writing them into a new file. I only did this for the first 200 chunks from each disk. The resulting image put the NTFS header 128k too far into the new image. It took a bit more thinking, but I realized this could only be due to a RAID 5 configuration, with distributed parity. I was able to confirm this by having my script write 128k chunks from 3 disks (2 real, and 1 zero filled disk, and skipping the lefthand parity chunk). This new disk was aligned perfect, and the NTFS partition was exactly where it was supposed to be. (Obviously, the disk itself was not usable, due to the zero byte filler.)

After finally proving this was a three disk, left-hand aligned RAID 5 set, I found the fakeRAID Intel ISW header at the end of each disk. The RAID header only contained two disk serial numbers though, so I was not sure where the third disk was (and it seemed that it was missing from the RAID set). Either the disk was still in the original machine, or it came from the second half of the 160GB drive. I checked the second 80GB on the larger drive, and it was zeros as far as I could see. So, I finally decided disk 3 was gone.

As this was RAID 5, I knew it was possible to rebuild the missing disk. However, software RAID (mdadm) would not recognize the disks without overwriting the first partition. That partition was not critical, but I didn't really want to change the on disk structure if I could avoid it. (I thought --build would work, but that mode does not support RAID5.) I then moved to dmraid. Originally, this would not work on the loop devices I had assigned to the disk images. I worked past this by serving the images up with iSCSI. However, dmraid still would not work with the disks due to the serial number on disk not matching what dmraid was reading from the block device. I tried editing the disks, but couldn't come up with a matching serial number. I finally gave up, and decided to do it manually.

As a proof of concept, I wrote a script to read 16 bytes from each disk, xor the data together and write the results to a new disk. This actually worked great, but a quick bit of math showed it would take about 45 days to complete! I decided to then re-write the program in C. The program was not difficult, and David Mair was very helpful in ironing out a few bugs and speeding the code up. After all was said and done, my program rebuilt the third 80GB disk in about 75 minutes. Using all three images, and a second C program to de-raid the disks, I ended up with a new 160GB disk - which contained a valid NTFS filesystem. The first time I mounted the disk, I received a message about the drive having not been cleanly dismounted. The mount fixed that, and the drive was good - with all the data intact. :)

So, the important things I learned:

 - Never believe what anyone tells you
 - Using hdparm to rewrite sectors with read errors is a GREAT trick
 - Check the end of the disk for fakeRAID singatures
 - Using iSCSI instead of loop devices for use with dmraid
 - Worst case situation - do the work yourself  :)

Anyway, thanks again for the very timely discussion!

-Mike

14:49 2012-05-21
software, skill, network, nfs, root access
0, error
permission denied while create directory on NFS with root user.

1, ref
Root Access On NFS
http://www.togaware.com/linux/survivor/Root_Access.html
contents previous up next index
By default root on a client is mapped to user nobody on an NFS server. This is a security measure. However, this may mean that evolution, for example, will not be able to read NFS mounted mail directories (i.e., where on machine Cultus (112.32) you mount /var/spool/mail from, for example, Alpine (112.33)). evolution (or something used by evolution) seems to be root when accessing the email. The solution is to allow root mapping to root for this export from Alpine (112.33). Thus, on Alpine (112.33) ensure the following exists in /etc/exports:
/var/spool/mail  cultus(rw,no_root_squash)

2, it works
linux-work:/home/bamvor # cat /etc/exports
#/home/bamvor/sda3/home/        *(fsid=0,crossmnt,rw,root_squash,sync,no_subtree_check)
/home/bamvor/sda3/home/ *(fsid=0,crossmnt,rw,no_root_squash,sync,no_subtree_check)
#/var/lib/xen/images_2  *(rw,root_squash,sync,no_subtree_check)
/var/lib/xen/images_2   *(rw,no_root_squash,sync,no_subtree_check)

notes: after change the exports file, restart nfsserver through "rcnfsserver restart".

14:54 2012-05-21
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream, cont4, test new patch
1, talk with jiaju, jiaju agree with write patch according to Ian Jackson's comments.
2, test pass.
3, compile with upstream code, prepare patch.
1), compile pass. install and test it.
2), prepare patch.
[PATCH] libxl: Add API to retrieve domain console tty

This api retrieve domain console from xenstore. With this new api, it is easy to implement "virsh console" command in libvirt libxl driver.

Signed-off-by: Bamvor Jian Zhang <bjzhang@suse.com>
3),
hg email -o --plain --to  xen-devel@lists.xen.org --cc Ian.Jackson@eu.citrix.com --cc Ian.Campbell@citrix.com --cc jfehlig@suse.com --cc bjzhang@suse.com

15:29 2012-05-21
software, skill, two utilities in socat, filan, procan
linux-vm4:/etc/xen/vm # filan
  FD  type      device  inode   mode    links   uid     gid     rdev    size    blksize blocks  atime                           mtime                        ctime                            cloexec flags   sigown  sigio
   0: chrdev    0,11    3       020620  1       0       5       136,0   0       1024    0       Sat May 19 19:23:48 2012        Sat May 19 19:23:48 2012     Sat May 19 18:28:03 2012 0       x008002 0       0       (no STREAMS modules)    /dev/pts/0      IFLAGS=00000500 OFLAGS=00000005 CFLAGS=000000bf LFLAGS=00008a3b cc[0]=^C cc[1]=^\ cc[2]=x7F cc[3]=^U cc[4]=^D cc[5]=^@ cc[6]=^A cc[7]=^@ cc[8]=^Q cc[9]=^S cc[10]=^Z cc[11]=^@ cc[12]=^R cc[13]=^O cc[14]=^W cc[15]=^V cc[16]=^@ cc[17]=^@ cc[18]=^@ cc[19]=^@ cc[20]=^@ cc[21]=^@ cc[22]=^@ cc[23]=^@ cc[24]=^@ cc[25]=^@ cc[26]=^@ cc[27]=^@ cc[28]=^@ cc[29]=^@ cc[30]=^@ cc[31]=^@poll: OUT,
   1: chrdev    0,11    3       020620  1       0       5       136,0   0       1024    0       Sat May 19 19:23:48 2012        Sat May 19 19:23:48 2012     Sat May 19 18:28:03 2012 0       x008002 0       0       (no STREAMS modules)    /dev/pts/0      IFLAGS=00000500 OFLAGS=00000005 CFLAGS=000000bf LFLAGS=00008a3b cc[0]=^C cc[1]=^\ cc[2]=x7F cc[3]=^U cc[4]=^D cc[5]=^@ cc[6]=^A cc[7]=^@ cc[8]=^Q cc[9]=^S cc[10]=^Z cc[11]=^@ cc[12]=^R cc[13]=^O cc[14]=^W cc[15]=^V cc[16]=^@ cc[17]=^@ cc[18]=^@ cc[19]=^@ cc[20]=^@ cc[21]=^@ cc[22]=^@ cc[23]=^@ cc[24]=^@ cc[25]=^@ cc[26]=^@ cc[27]=^@ cc[28]=^@ cc[29]=^@ cc[30]=^@ cc[31]=^@poll: OUT,
   2: chrdev    0,11    3       020620  1       0       5       136,0   0       1024    0       Sat May 19 19:23:48 2012        Sat May 19 19:23:48 2012     Sat May 19 18:28:03 2012 0       x008002 0       0       (no STREAMS modules)    /dev/pts/0      IFLAGS=00000500 OFLAGS=00000005 CFLAGS=000000bf LFLAGS=00008a3b cc[0]=^C cc[1]=^\ cc[2]=x7F cc[3]=^U cc[4]=^D cc[5]=^@ cc[6]=^A cc[7]=^@ cc[8]=^Q cc[9]=^S cc[10]=^Z cc[11]=^@ cc[12]=^R cc[13]=^O cc[14]=^W cc[15]=^V cc[16]=^@ cc[17]=^@ cc[18]=^@ cc[19]=^@ cc[20]=^@ cc[21]=^@ cc[22]=^@ cc[23]=^@ cc[24]=^@ cc[25]=^@ cc[26]=^@ cc[27]=^@ cc[28]=^@ cc[29]=^@ cc[30]=^@ cc[31]=^@poll: OUT,
linux-vm4:/etc/xen/vm # procan
process id = 5648
process parent id = 4152
controlling terminal: "/dev/tty"
process group id = 5648
process session id = 4152
process group id if fg process / stdin = 5648
process group id if fg process / stdout = 5648
process group id if fg process / stderr = 5648
process has a controlling terminal
user id  = 0
effective user id  = 0
group id = 0
effective group id = 0

RESOURCE LIMITS
resource                         current         maximum
cpu time (seconds)                    -1              -1
file size (blocks)                    -1              -1
data seg size (kbytes)                -1              -1
stack size (blocks)              8388608              -1
core file size (blocks)                0              -1
max resident set size                 -1              -1
max user processes                 14067           14067
open files                          1024            4096
max locked-in-memory address space            65536           65536
virtual memory (kbytes)               -1              -1

IP INTERFACES
 1: lo
 1: lo
 3: br0
 4: virbr0

11:21 2012-05-22
GTD
0, 10:30-12:27 13:26-17:51 20:39-22:30

1, today
1), check mail. Novell and SUSE DNS/DHCP Rollout, see"11:21 2012-05-22".
2), 11:41-12:08 work report. see"11:41 2012-05-22".
3), subscribe the devel mailing list. waiting approval.
4), install kernel source find the patch checker. see"15:15 2012-05-22".
5), compile xen unstable on linux-vm6. see"15:11 2012-05-22".
6), xen patch. write patch v2. simple test patch. see"15:21 2012-05-22".

11:21 2012-05-22
compay, mailing, list, Upcoming new DNS/DHCP Solution week 21, Novell and SUSE DNS/DHCP Rollout, new DNS server address; software, openVPN, doc, automatic script
0, summary
1), As part of this move, the DNS zones for *.suse.de and *.suse.cz will be splitted into "external" and "internal" DNS zones.
2), china DNS
China please use:
-		  147.2.136.1
-		  137.65.247.1

1, "Lars Vogdt <lrupp@suse.de>"_email_"Upcoming new DNS/DHCP Solution week 21"
Dear colleagues,
IS & T will be migrating Novell to a new DNS/DHCP solution the week of May 21st. The plan is to move off the current, aging DNS/DHCP environment and onto a new environment that runs InfoBlox appliances at the core.
As part of this move, the DNS zones for *.suse.de and *.suse.cz will be splitted into "external" and "internal" DNS zones.
The external DNS zones will just contain the host names and IP addresses that are reachable from the Internet - and nothing more.
The internal DNS zones for suse.de and suse.cz will still contain all host names and also sub-zones (like .qam.suse.de or .qa.suse.cz). Those zones will also be distributed inside the Attachmate network. So nothing should change for employees working in their standard offices.
If you are using the provided VPN solutions ("Novell VPN" or "openVPN"), please be sure to use the offered (internal) DNS servers - otherwise you might not be able to resolve internal host names any more.
With kind regards,
Lars
2, Daniel Rahn <drahn@suse.com>
> What I would like to see is DNS settings being updated automatically to
> use the internal DNS servers when I start openvpn, and restored
> automatically when I stop openvpn. Can openvpn be configured that way?

The client.up/client.down scripts do that for you if you configure
openVPN as described here:

https://wiki.innerweb.novell.com/index.php/Services_Team/Policies/openVPN/client_setup
3, Lars Vogdt <lrupp@suse.de>
Yes, it already is configured this way since a long time now.
So the above note is only for those people who are using really complex
setups in their external environments. The "normal" openVPN user should
not run into any problems.

The documentation here:
https://wiki.innerweb.novell.com/index.php/Services_Team/Policies/openVPN
and here:
https://wiki.innerweb.novell.com/index.php/Services_Team/Policies/openVPN/client_setup

will be updated in case something really strange change is needed. We
will also announce problems (and hopefully also resolutions) to the
openvpn mailinglists.

4, IS & T(Novell NewsBriefs)_email_"Novell and SUSE DNS/DHCP Rollout"
Note: we are resending this message to a wider audience in an effort to reach everyone who may be impacted. Thank you.


Date:
Monday, May 21st - Going Forward

Detail:
IS & T will be migrating Novell and SUSE to a new DNS solution the week of May 21st.  We will move off of the current, aging DNS environment and onto a new environment.
NOTE: The new DNS servers will have new IP addresses that will be different from the DNS IPs currently being used.

SUSE BU Engineering and Lab users please refer to the attached message that Lars Vogdt sent to you earlier for those changes that are specific to you.

POSSIBLE ACTION NEEDED:
If you have computers where you have manually assigned the DNS entries, those will continue to work after the migration for 6 weeks.  During that 6 week period we will need you to reconfigure the network settings to use the new DNS server IP addresses.  Those IP addresses are:

Countries in N. America and S. America please use:
-		  137.65.247.1
-		  149.44.160.160
Countries in Europe, Africa and the Middle East please use:
-		  149.44.160.160
-		  137.65.247.1
India please use:
-		  164.99.201.201
-		  149.44.160.160
China please use:
-		  147.2.136.1
-		  137.65.247.1
Countries in Asia Pacific please use:
-		  147.2.136.1
-		  137.65.247.1

***If you are unsure then you most likely do not have manually assigned DNS entries and can safely ignore this part of the email.***

External DNS will change as well over the course of next week as we transition to our new external DNS servers.   We will no longer be publishing DNS entries for workstations or other devices externally.  In the past you could resolve your internal computers if you were outside of the network.  This will no longer be the case.  After next week you will need to connect via VPN (and use DNS servers provided by VPN or those listed above) before being able to resolve internal computers and devices.

  Services Affected:
DNS for Novell and SUSE
Remote access to your internal computers

11:41 2012-05-22
work report - week 20
[devel-server] work report - week 20
[green]
1, xen patch for retrieving domain console tty
update this patch according to the upstream response. it almost done except some small changes in this week.
2, libvirt migrate
for solving the migrate bug in libvirt libxl migration in chunyan's patch v2, read the code of xen libxl migration and libvirt qemu migration.
It looks like it is good choice using the libvirt migration sequence instead of xen libxl handshake message.
3, discuss with Jim about my libvirt libxl work.
thanks to clear and important advice for my work from Jim.
4, misc
1), study the xen/libvirt bug fix by Jim.
2), try to compile libvirt upstream code on sles11 sp2. Jim had finish this work, learn from his package.

15:11 2012-05-22
virtualization, libvirt, xen, compile xen-unstable on linux-vm6
1, install
there are lots of packages need to install.
network is very slow while download kernel source.
2, configure and make
1), compile autoconf 2.69 according to the requirement of autogen.sh
2), install git
3, successful

15:15 2012-05-22
software, skill, kernel, patch checker, checkpatch.pl
> pwd
/usr/src/linux-3.1.0-1.2
> ./scripts/checkpatch.pl patch_filename

15:21 2012-05-22
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream, cont5, small update
1, Ian Campbell
"retrieves the specified domain's *primary* console tty path? Otherwise
this description doesn't differ from the previous function's...

2, Ian Jackson
Bamvor Jian Zhang writes ("[PATCH] [PATCH] libxl: Add API to retrieve domain console tty"):
> This api retrieve domain console from xenstore. With this new api, it is easy to implement "virsh console" command in libvirt libxl driver.

Thanks.  This is coming along in the right direction.  I have just a
few comments.

> Signed-off-by: Bamvor Jian Zhang <bjzhang@suse.com>
>
> diff -r f8279258e3c9 -r a1dc373628e4 tools/libxl/libxl.c
> --- a/tools/libxl/libxl.c	Mon May 14 17:15:36 2012 +0100
> +++ b/tools/libxl/libxl.c	Mon May 21 18:51:17 2012 +0800
> @@ -1552,6 +1552,61 @@ out:
>      return rc;
>  }
>
> +int libxl_console_get_tty(libxl_ctx *ctx, uint32_t domid, int cons_num,
> +                          libxl_console_type type, char **path)
> +{
...
> +            tty_path = libxl__sprintf(gc, "%s/console/tty", dom_path);

You could profitably make use of the GCSPRINTF helper macro here.

> +        else
> +            tty_path = libxl__sprintf(gc, "%s/device/console/%d/tty", dom_path, cons_num);

This line needs to be reformatted to be less than 75-80 characters.
There are a couple of other long lines in your patch too.

> +
> +    tty = libxl__xs_read(gc, XBT_NULL, tty_path);
> +    *path = strdup(tty);
> +

You need to check for errors here.  libxl__xs_read is not infallible.

> +int libxl_primary_console_get_tty(libxl_ctx *ctx, uint32_t domid_vm, char **path)
> +{
> +    GC_INIT(ctx);
> +    uint32_t stubdomid = libxl_get_stubdom_id(ctx, domid_vm);
> +    int rc;
> +    if (stubdomid)
> +        rc = libxl_console_get_tty(ctx, stubdomid,
> +                STUBDOM_CONSOLE_SERIAL, LIBXL_CONSOLE_TYPE_PV, path);
> +    else {
> +        switch (libxl__domain_type(gc, domid_vm)) {
> +        case LIBXL_DOMAIN_TYPE_HVM:
> +            rc = libxl_console_get_tty(ctx, domid_vm, 0, LIBXL_CONSOLE_TYPE_SERIAL, path);

This recapitules the logic in libxl_primary_console_exec.  I think you
should refactor this so that the substance of it is in a single
function eg

  int libxl__primary_console_find(libxl__gc *gc, uint32_t domid_vm
                                  int *num_out, libxl_console_type *type_out);

Also aborting if libxl__domain_type fails is not correct, but if you
refactor this and use the existing code in the middle of
libxl_primary_console_exec you'll handle that case correctly.

Thanks,
Ian.

3, update
1), GCSPRINTF
(1), defined in tools/libxl/libxl_internal.h

/*
 * Expression            char *GCSPRINTF(const char *fmt, ...);
 * Uses                  libxl__gc *gc;
 *
 * Trivial convenience wrapper for libxl__sprintf.
 */
#define GCSPRINTF(fmt, ...) (libxl__sprintf((gc), (fmt), __VA_ARGS__))
(2), GCSPRINTF is introduced from f3c835decf46 with ARRAY_SIZE_OK, GCNEW, GCNEW_ARRAY, GCREALLOC_ARRAY, LOG, LOGE, LOGEV.
bamvor@linux-x12:xen-unstable.hg.build> hg log -r f3c835decf46changeset:   25183:f3c835decf46
user:        Ian Jackson <ian.jackson@eu.citrix.com>
date:        Wed Apr 11 14:14:14 2012 +0100
summary:     libxl: Introduce some convenience macros

hg diff tools/libxl/libxl_internal.h -r 6c3345d7e9d9 -r f3c835decf46

2), "libxl__xs_read is not infallible."
bamvor: but lots of people not check this error.

3), merge common function in libxl_primary_console_exec and libxl_primary_console_get_tty as libxl__primary_console_find.
  int libxl__primary_console_find(libxl__gc *gc, uint32_t domid_vm
                                  int *num_out, libxl_console_type *type_out);

4), check return value(-1) instead of abort.
this changes is a new update after i push i patch v1. So, i do not understand what does Ian Jackson say. After pull the lastest code, i understand finally.

5), compile, install xen-unstable on sles11 sp2(linux-vm6) successful.

6), (21:52 2012-05-22)
how about using struct instead of pass individual parameter?
i need add new struct. no exist struct suitable for me.

7), poor coding. losts of foolish error araised while compile.
i want to execise!!!!

8), simple test pass. write full test case tomorrow. tired.

17:31 2012-05-22
software, skill, doc, markdown, pandoc

17:38 2012-05-22
company, document, DongMao Zhang
http://code.google.com/p/opensuse-topics

21:31 2012-05-22
software, skill, SCM, mercurial, hg, update repo and discard the changes
1, I want to update xen repo. but there are some changes in it.
1), backup the changes.
2), pull: update from remote.
bamvor@linux-x12:xen-unstable.hg> hg pull
pulling from http://xenbits.xen.org/hg/xen-unstable.hg/
searching for changes
adding changesets
adding manifests
adding file changes
added 42 changesets with 107 changes to 62 files (+1 heads)
(run 'hg heads' to see heads, 'hg merge' to merge)
3), update local version, use "--check" for force update.
bamvor@linux-x12:xen-unstable.hg> hg update
abort: crosses branches (merge branches or update --check to force update)
bamvor@linux-x12:xen-unstable.hg> hg update --check
62 files updated, 0 files merged, 0 files removed, 0 files unresolved

2, if there are uncommited changes, "hg update --check" will fail.
backup the changes and discard the changes through "hg revert -a".
bamvor@linux-x12:xen-unstable.hg.build> hg update --check
abort: uncommitted local changes
bamvor@linux-x12:xen-unstable.hg.build> hg revert -a
reverting tools/libxl/libxl.c
reverting tools/libxl/libxl.h
bamvor@linux-x12:xen-unstable.hg.build> hg update --check
163 files updated, 0 files merged, 2 files removed, 0 files unresolved

10:22 2012-05-23
GTD
0, 10:20-12:20 13:05-18:48

1, today
1), 5' check email. devel-server: work report.
2), 10:32-12:20 13:14-14:35 xen patch. write ful test case on xl command line, see""10:32 2012-05-23.
3), 14:40-15:20 xen mailing list. see"14:47 2012-05-23".
interrupt by personnal stuff: 15:20-16:35
4), filesystem resize. see"16:53 2012-05-23".
5), migrate. see"16:37 2012-05-23".

10:32 2012-05-23
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream, cont6, write full test case for small update yestoday; software, skill, hg, pop current patch
1, write test case: add console_get_tty command to xl commands.
code: /home/bamvor/log/novell/hypervisor_and_tools/console/20120523
2, generate new patch
1), pop the previous patch
bamvor@linux-x12:xen-unstable.hg> hg qpop
popping patch01.diff
patch queue now empty
2), tabs found, regenerate patch
bamvor@linux-x12:xen-unstable.hg> hg qdelete patch02
abort: patch patch02 not in series
(1), pop the patch
bamvor@linux-x12:xen-unstable.hg> hg qseries
patch02.diff
patch01.diff
bamvor@linux-x12:xen-unstable.hg> hg  qpop
abort: local changes found, refresh first
bamvor@linux-x12:xen-unstable.hg> hg qrefresh
bamvor@linux-x12:xen-unstable.hg> hg  qpop
popping patch02.diff
patch queue now empty
bamvor@linux-x12:xen-unstable.hg> hg qapplied
bamvor@linux-x12:xen-unstable.hg> hg qseries
patch02.diff
patch01.diff
(2), delete the patch
bamvor@linux-x12:xen-unstable.hg> hg qdelete patch02.diff
bamvor@linux-x12:xen-unstable.hg> ls .hg/patches/
patch01.diff   patch01.diff~  patch02.diff~  series         status
(3), test patch with "-n" parameter, hg will output the result to "less" command.
-n --test                print messages that would be sent
(4), final commit message
[PATCH v2] libxl: Add API to retrieve domain console tty

This api retrieve domain console from xenstore. With this new api, it is easy to implement "virsh console" command in libvirt libxl driver.

Signed-off-by: Bamvor Jian Zhang <bjzhang@suse.com>

Changes since v1:
 * Replace function libxl__sprintf with macro GSPRINTF
 * check return value and handle error for libxl__xs_read and libxl__domain_type
 * merge common code for libxl_primary_console_get_tty and
   libxl_primary_console_exec as libxl__primary_console_find
 * Reformat code to be less than 80 characters.
(5), send email
hg email -o --plain --to  xen-devel@lists.xen.org --cc Ian.Jackson@eu.citrix.com --cc Ian.Campbell@citrix.com --cc jfehlig@suse.com --cc bjzhang@suse.com

2, \TODO: read libxl__openpty. 和我新加的这个libxl_console_get_tty/libxl_primary_console_get_tty有关系么?

13:07 2012-05-23
mailing, list, kernel, compile kernel with symref
1, ""Gilson Melo" <gmelo@suse.com>"_email_"[kernel] Do you have any idea of what are kernel .symref files for and how these work when building a kernel?"_20120523_1232_forward_"Ann Davis"
1)  cd /usr/src/linux-2.6.32.54-0.3
2)  copy the /boot/config* file from the 2.6.32.54-0.3 kernel-default-base.rpm into this directory, rename it to .config
3)  copy the /boot/symtypes* file from the 2.6.32.54-0.3 kernel-default-devel.rpm into this directory.
4)  copy the modversions file from  the kernel-default-2.6.32.54-0.3.1.nosrc.rpm into this directory.
5)  export KBUILD_SYMTYPES=1
6)  export KBUILD_OVERRIDE=1
7)  ./modversions --unpack .<./symtypes*
8)  Do a "find . -name *.symref" to make sure that *.symref files got made in the tree.
9)  make -j16
10) make modules_install
11) make install
12) check the Module.symvers file, I think the sk_free checksum will match the SLES 11 SP1 GA kernel.
13) reboot and try loading your module.  My sample module loaded fine.

14:47 2012-05-23
mailing list, xen, kernel commit; libxl suspend/resume mechanism update
1, "Konrad Rzeszutek Wilk"_email_"[Xen-devel] [GIT PULL] (xen) stable/for-linus-3.5-rc0-tag"_20120522_1546
http://lists.xen.org/archives/html/xen-devel/2012-05/msg01638.html
Hey Linus,

Please git pull the following tag:

git://git.kernel.org/pub/scm/linux/kernel/git/konrad/xen.git
stable/for-linus-3.5-rc0-tag

which has:
 * support for 'perf' running. Perf depends on APIC ops to send IPIs, not SMP
ops.
   Re-using the existing SMP ops and also adding code to deal IRQ_WORKER vector
makes it work.
 * enhancements to the self-ballooning code
 * fix to auto-balloon the initial domain to the original boot-up size (it would
   return to the hypervisor around 1GB of memory that overlapped PCI and
non-E820 RAM regions -
   this brings it back).
 * move some of the debugfs code dealing with printing u32 arrays to the
generic code-base.
 * allow fronted modules to unload with grants in usage and lazily free them
 * further disintegrate the XenBus and initial domain coupling - so that there
can be
   a separate XenBus domain - and the concept of initial domain shrinks even
further.
 * perf improvements in the M2P calls to utilize the batching of PTEs.
 * bug-fixes

Please pull!

Ben Guthro (1):
      xen: implement apic ipi interface

Dan Carpenter (1):
      hvc_xen: NULL dereference on allocation failure

Daniel De Graaf (1):
      xenbus: Add support for xenbus backend in stub domain

David Vrabel (1):
      xen/setup: update VA mapping when releasing memory during setup

Jan Beulich (1):
      xen/gnttab: add deferred freeing logic

Jana Saout (1):
      xen: Add selfballoning memory reservation tunable.

Konrad Rzeszutek Wilk (9):
      xen/p2m: Move code around to allow for better re-usage.
      xen/p2m: Allow alloc_p2m_middle to call reserve_brk depending on argument
      xen/p2m: Collapse early_alloc_p2m_middle redundant checks.
      xen/p2m: An early bootup variant of set_phys_to_machine
      xen/setup: Only print "Freeing XXX-YYY pfn range: Z pages freed" if Z > 0
      xen/setup: Populate freed MFNs from non-RAM E820 entries and gaps to E820
RAM
      xen/setup: Combine the two hypercall functions - since they are quite
similar.
      xen/acpi/sleep: Enable ACPI sleep via the __acpi_os_prepare_sleep
      xen/smp: unbind irqworkX when unplugging vCPUs.

Lin Ming (1):
      xen: implement IRQ_WORK_VECTOR handler

Srivatsa Vaddagiri (1):
      debugfs: Add support to print u32 array in debugfs

Stefano Stabellini (2):
      xen: enter/exit lazy_mmu_mode around m2p_override calls
      xen: do not map the same GSI twice in PVHVM guests.

2, "Ian Jackson"_email_"[Xen-devel] [RFC PATCH 0/5] libxl: domain save/restore: run in a separate process"_20120517_1953
bamvor: \TODO: need to know whether it affect the libvirt migration patch or not.
original email:
1), This is a first cut of my proposal to fix the libxl save/restore
machinery so that it is suitable for use in a single-process daemon.
See 5/5 for the full rationale.
Note that i have not executed this series, although I have compiled
it.  Nor have I reread the patches particularly carefully.  This is an
initial posting to get comments on the approach.
 1/5 libxc: xc_domain_restore, make toolstack_restore const-correct
 2/5 libxl: domain save: rename variables etc.
 3/5 libxl: domain restore: reshuffle, preparing for ao
 4/5 libxl: domain save: API changes for asynchrony
 5/5 libxl: domain save/restore: run in a separate process
2), libxenctrl expects to be able to simply run the save or restore
operation synchronously.  This won't work well in a process which is
trying to handle multiple domains.
The options are:
 - Block such a whole process (eg, the whole of libvirt) while
   migration completes (or until it fails).
 - Create a thread to run xc_domain_save and xc_domain_restore on.
   This is quite unpalatable.  Multithreaded programming is error
   prone enough without generating threads in libraries, particularly
   if the thread does some very complex operation.
 - Fork and run the operation in the child without execing.  This is
   no good because we would need to negotiate with the caller about
   fds we would inherit (and we might be a very large process).
 - Fork and exec a helper.
Of these options the latter is the most palatable.
Consequently:
 * A new helper program libxl-save-helper (which does both save and
   restore).  It will be installed in /usr/lib/xen/bin.  It does not
   link against libxl, only libxc, and its error handling does not
   need to be very advanced.  It does contain a plumbing through of
   the logging interface into the callback stream.
 * A small ad-hoc protocol between the helper and libxl which allows
   log messages and the libxc callbacks to be passed up and down.
   Protocol doc comment is in libxl_save_helper.c.
 * To avoid a lot of tedium the marshalling boilerplate (stubs for the
   helper and the callback decoder for libxl) is generated with a
   small perl script.
 * The callback functions in libxl are renamed to the systematic
   naming scheme from the marshalling boilerplate.  This hardwires the
   libxl callbacks.
 * Implement new functionality to spawn the helper, monitor its
   output, provide responses, and check on its exit status.
 * The functions libxl__xc_domain_restore_done and
   libxl__xc_domain_save_done now turn out to want be called in the
   same place.  So make their state argument a void* so that the two
   functions are type compatible.
The domain save path still writes the qemu savefile synchronously.
This will need to be fixed in a subsequent patch.

16:53 2012-05-23
software, skill, Linux, filesystem, btrfs, shinking; tools, partition, pqmagic replacement
1, btrfsctl
ref: http://kerneltrap.org/Linux/Btrfs_Online_Resizing_Ext3_Conversion_and_More
but btrfsctl is deprecated.
linux-x12:/home/bamvor # btrfsctl
**
** WARNING: this program is considered deprecated
** Please consider to switch to the btrfs utility
**

2, try "btrfs filesystem resize".
http://askubuntu.com/questions/75120/how-can-i-safely-resize-shrink-a-btrfs-partition
To shrink the filesystem by 4 GiB: btrfs filesystem resize -4g /mnt or btrfsctl -r -4g /mnt Set the FS size . To set the filesystem to a specific size, omit the leading + or - from the size.
(1), try
linux-x12:/home/bamvor # df -h | grep sda7
/dev/sda7                             301G  147G  146G  51% /home/bamvor/sda7_rd
linux-x12:/home/bamvor # btrfs filesystem resize -8g /home/bamvor/sda7_rd/
Resize '/home/bamvor/sda7_rd/' of '-8g'
linux-x12:/home/bamvor # df -h | grep sda7
/dev/sda7                             293G  147G  138G  52% /home/bamvor/sda7_rd
(2), but the partition size in "fdisk /dev/sda" is not changed. why?
after reboot, it is still same.
this article said that btrfs only shink the filesystem size not the partition size. you should change partition table by yourself. But gparted finish all the things.

3, try gparted.
http://gparted.sourceforge.net/livecd.php
http://gparted.sourceforge.net/livehd.php
1), restore the size:
btrfs filesystem resize +8g /home/bamvor/sda7_rd/
2), edit grub menu to add gparted into it.
tail /boot/grub/menu.lst -n 4
title GParted live
    root (hd0,7)
    kernel /mnt/gparted-live-0.12.1-5/live/vmlinuz root=/dev/sda8 boot=live config union=aufs noswap noprompt vga=788 ip=frommedia live-media-path=/mnt/gparted-live-0.12.1-5/live bootfrom=/dev/sda8 toram=filesystem.squashfs
    initrd /mnt/gparted-live-0.12.1-5/live/initrd.img

4, (11:40 2012-05-24)
it seems that fail fail at btrfs check. But i do not see the error messsage after come back to company.
resize the ext4 and create new 8Gbytes swap.

11:41 2012-05-24
GTD
0, 10:30-23:05
11:45-12:15 13:36-14:46 15:34-18:32 20:15-21:28 22:21-23:05

1, today
1), resize file system.
2), 11:47-11:53 check the mail.
3), 13:36-14:46 15:34-18:32 20:15-21:28 22:21-23:05 migration: try to update code for chunyan's patch. see"13:37 2012-05-24".
nap. 14:46-15:10
4), 10' check xen mailing list.
5), summary: seems no process today...

11:50 2012-05-24
cloud, openstack, virtualization, document, manual
1, "DongMao Zhang"_email_"[分享]安装openstack文档与新版openstack"_20120523_1726
hi,all

    上周尝试安装了openstack，使用源http://download.suse.de/ibs/Devel:
/Cloud/SLE_11_SP2的 代码，之前的vnc的问题看起来也已经修复了,
server team安装了一台openstack环境.http://147.2.207.105/, 有兴趣同学可以
看看，
登录密码 admin/novell

此外，我也简单的记下了oepnstack的安装步骤。
http://147.2.207.240/~dmzhang/openstack-install/
可以参考，

谢谢

13:37 2012-05-24
virtualization, libvirt, xen, xenlight, migration, do some test and debug in order to know deeper about libxl migration
1, try to delete the handshake message in the libxl migration.
if successful, read the code about libxl lock, compare with qemu lock. should reference Jim's comment on IM.

2, libxl migration test.
1), connection refused while connect to libxl
(1),
linux-vm4:/etc/xen/vm # rcxend stop
Stopping xend (pid 3707 3706)                                        done
linux-vm4:/etc/xen/vm # rclibvirtd restart
Shutting down libvirtd                                               done
Starting libvirtd                                                    done
linux-vm4:/etc/xen/vm # virsh version
error: Failed to reconnect to the hypervisor
error: no valid connection
error: unable to connect to 'localhost:8000': Connection refused
(2), open debug message, it seem that virsh try to connect to xend. but i want it use libxl instead.
linux-vm4:/etc/xen/vm # export VIRSH_DEBUG=0
linux-vm4:/etc/xen/vm # virsh version
libvir: Xen Daemon error : unable to connect to 'localhost:8000': Connection refused
error: Failed to reconnect to the hypervisor
error: no valid connection
error: unable to connect to 'localhost:8000': Connection refused
(3), check build message. libxl is disable, why? compile failed??
2), build. see"13:40 2012-05-24"
3), in chunyan's code, there is no thread_join, is it normal?
usually, pthread_create and phread_join is a pair. and in other libvirt code, virThreadCreate and virThreadJoin is a pair too.
Maybe I should add a virThreadJoin at MigreteFinish3.
But virThreadJoin drop the return value from pthread_join. why?
Because virsh use vshWatchJob for watching the thread return. I can not call vshWatchJob in libvirtd, but maybe i could use the same mechanism.
4), compare with libvirt qemu migration. libxl using api to receive the domain suspend dump, but qemu start a qemu process to do the same thing. this is why Chunyan need a dedicated virsh thread for migration receiving.

3, about the lock
1), Jim:
log/novell/im/NM20120518_Jim_Fehlig__my_work__xen_patch_for_libxlDomainOpenConsole__libvirt_libxl_lock__libvirt_libxl_migration__libvirt_libxl_4.1_4.2_support.txt
the libxl driver already has the same thing as struct qemud_driver: RWLock
and it uses the  virDomainObjPtr:  Mutex
the libxl driver needs the functionality described under "qemuMonitorPrivatePtr: Job conditions" in THREADS.txt

4, (20:45 2012-05-24)
i could not understand how qemu can issue other commands while migration is processing.
print something with gdb.
continue do it tomorrow. print the sequence of the lock and the migrate.

16:52 2012-05-24
virtualization, mailing list, xen, xen-arm; emulator, android, adb
1, "mabel mary joy <maryjoy883@gmail.com>"_email_"[XenARM] The Qemu window doesn't open"_20120523_1837
1),
I was able to compile the tool qemu-xen_arm-081120.tar.bz2

When the script run.sh is executed. it show the following messages

guest0-mini-os
guest1-mini-os
Waiting gdb connection on port 1234
emulator: control console listening on port 5554, ADB on port 5555
emulator: can't connect to ADB server: errno 111: Connection refused
 emulator: ping program: /home/mabel/xen_arm/android-emulator-xen_arm/ddms

But it doesnt open any qemu / emulation window after that.

Is there something to be done in order to get the window opened and running
mini-os?

2), bamvor: there are other people ask the same question.
\TODO: keep an eye on this. this may help me in future.

13:40 2012-05-24
virtualization, libvirt, xen, xenlight, migration, build libvirt 0.9.12
1, replace local build libvirt 0.9.12 as opensuse build service.
(1), libxl is disable maybe because of the version checker:
# libxenlight driver requires Xen >= 4.1, which is only
# available in openSUSE >= 12.1 or SLE >= 11sp2
%if 0%{?suse_version} < 1210
%define with_libxl         0
%endif

Jim do not modify it right now.
i will comment it. because i only use on sles11 sp2.
try to modify it later.
(2), commit it to obs
but obs not rebuild. ???

2, build it by my self.
0), build sles11 sp2 on openSUSE12.1 failed. packge version mismatch error.
switch to sles11 sp2 to build it.
1), notes: avoid input password for "/usr/bin/build"
a, uncomment the sudo wrapper line in "~/.oscrc"
su-wrapper = sudo
b, add the "bamvor" line in "visudo"
# User privilege specification
root ALL=(ALL) ALL
bamvor ALL = NOPASSWD: /usr/bin/build

osc build SLE_11_SP2 x86_64

2), but libxl is not configure either.
(1), define with libxl explicitly:
# libxenlight driver requires Xen >= 4.1, which is only
# available in openSUSE >= 12.1 or SLE >= 11sp2
#%if 0%{?suse_version} < 1210
#%define with_libxl         0
#%endif
%define with_libxl         1
(2), libxl is compiled this time.
install this package through "rpm -ivh --force":
linux-vm4:/etc/xen/vm # rpm -ivh  /home/bamvor/work/virtualization/build_service/backup/20120524_Jim_Libvirt_Upstream__Bjzhang_enable_libxl/libvirt-*
Preparing...                ########################################### [100%]
        package libvirt-client-0.9.12-3.1.x86_64 (which is newer than libvirt-client-0.9.12-0.x86_64) is already installed
        package libvirt-0.9.12-3.1.x86_64 (which is newer than libvirt-0.9.12-0.x86_64) is already installed
        package libvirt-python-0.9.12-3.1.x86_64 (which is newer than libvirt-python-0.9.12-0.x86_64) is already installed
        ......
        file /usr/lib64/python2.6/site-packages/libvirtmod.so from install of libvirt-python-0.9.12-0.x86_64 conflicts with file from package libvirt-python-0.9.12-3.1.x86_64
        file /usr/lib64/python2.6/site-packages/libvirtmod_qemu.so from install of libvirt-python-0.9.12-0.x86_64 conflicts with file from package libvirt-python-0.9.12-3.1.x86_64
linux-vm4:/etc/xen/vm # rpm -ivh --force /home/bamvor/work/virtualization/build_service/backup/20120524_Jim_Libvirt_Upstream__Bjzhang_enable_libxl/libvirt-*
Preparing...                ########################################### [100%]
   1:libvirt-client         ########################################### [ 14%]
   2:libvirt-debuginfo      ########################################### [ 29%]
   3:libvirt                ########################################### [ 43%]
libvirtd  on
Updating etc/sysconfig/libvirt-guests...
   4:libvirt-debugsource    ########################################### [ 57%]
   5:libvirt-devel          ########################################### [ 71%]
   6:libvirt-doc            ########################################### [ 86%]
   7:libvirt-python         ########################################### [100%]

(3), libvirt works good with xenlight4.1, but hang with xenlight4.2(using gdb single step could work around for this). maybe xen4.2 is not compiled properly.

3, after build, migrate fails:
linux-vm5:/etc/xen/vm # virsh migrate sles11_hvm_10_2 xen+ssh://linux-vm4
Password:
error: this function is not supported by the connection driver: virDomainMigrate2

it works in my libvirt 0.9.12(compile by myself).

21:10 2012-05-24
software, skill, debugger, gdb; trust gdbinit; run shell command
1, warning: not using untrusted file ".gdbinit"
1), method 1: change owner of ".gdbinit" to the owner of gdb user.
it will fix this warning while i change .gdbinit as root.
2), method 2: run ".gdbinit" as a gdb command sequence with "-ex" parameter.
e.g.
gdb -ex='source .gdbinit'

  --eval-command=COMMAND, -ex
                     Execute a single GDB command.
                     May be used multiple times and in conjunction

ref: 在挂载的 NTFS 盘上运行 gdb 会遇到权限问题，导致无法初始化
http://www.cnblogs.com/dabaopku/archive/2012/02/17/2356368.html

2, display date and time through "shell date" commands

3, \TODO: do not display "---Type <return> to continue, or q <return> to quit---"

7:55 2012-5-25
company, virtualization, suse, xen, regular meeting: US / China Virtualization Sync, meeting
1, guy in German: Andreas Faerber
qemu migration.

2, Bo yang
debug HA bug with Jiaju: using core dump.

3, Jiaju Zhang
1), thanks for provo team.

4, Bamvor
1), chunyan migration patch.

new lock for migration, coredump or anything else.

2), xen patch for getting console path.
send patch twice.

5, Jim
sp3
openstack packaging

6, bruce, Bo yang
1), pci pass through.

8:53 2012-5-25
company, Attachmate, contact, phone list
1, "Rose Yaranon <Rose.Yaranon@Attachmate.com>"_email_"	New Attachmate phone list"0120525_0507
Hi there,

A new Attachmate printable phone list is now available.
Previously this was the Attachmate/NetIQ phone list.
Because of so many changes to the list you can now view
a new phone list and an old phone list

New - http://intranet.attachmate.com/Depts/IT/Telecom/Documents/phonelist.doc

Old- with deletions and corrections in red
http://intranet.attachmate.com/Depts/IT/Telecom/Documents/oldphonelist.doc

Information on all employees worldwide can be found in the Outlook Global Address Listing and the Novell Innerweb/eGuide.

This list is updated monthly.
If you or your location is not listed or listed incorrectly, please let me know.

Thank you,
Rosey

8:54 2012-5-25
opensuse, arm, mailing list, switch armv7l to arv7hl
1, "Adrian Schröter<adrian@suse.de>"_email_"[opensuse-arm]armv7l vs. armv7hl rpm arch"20120525_0436
to avoid package incompatibilities with other rpm based distros,
I am about to switch the rpm architecture to "armv7hl" again.
"armv7l" will be used as backward compatibility, so it should not
cause trouble.

However, I will wait for the new gcc with new runtime linker path
before doing an entire rebuild. Just in case you wonder why we will
have both rpm architectures for some time.

We will not hack the kernel to report (the not existing) armv7hl
architecture, we will go with a hack in rpm instead assuming that
armv7l hardware is always armv7hl.

In case we want to have armv7l (or armv7nhl or whatever) later on
in parallel, we will need to enhance the rpm dependency scripts to
extend the keys similar to the 64bit approach. But there is no
cross distro standard atm.

10:45 2012-05-25
GTD
0, 8:00-8:40 10:51-11:40 13:49-16:55

1, today
1), regular meeting: US / China Virtualization Sync, see"7:55 2012-5-25".
2), 10:51-11:40 13:49-14:47 migration auto test case. see"10:57 2012-05-25".
nap 14:47-15:17

10:57 2012-05-25
virtualization, libvirt, xen, xenlight, qemu, migration, write migration test case
1, want to write a test case, automatic test migration and execute command while migration is processing.
2, configure ssh login without password instead of "keyboard-interactive". see"14:05 2012-05-25".
3, try virsh remote migration
linux-vm5:/etc/xen/vm # virsh -c qemu+ssh://linux-vm4/system  migrate sles11_qemu_12 qemu+ssh://linux-vm5/system
linux-vm5:/etc/xen/vm # virsh -c qemu:///system  migrate sles11_qemu_12 qemu+ssh://linux-vm4/system
linux-vm5:/etc/xen/vm # ssh linux-vm4 'virsh -c qemu:///system  migrate sles11_qemu_12 qemu+ssh://linux-vm5/system'
but, the following command stil need password, i don't why.
linux-vm5:/etc/xen/vm # virsh -c qemu+ssh://linux-vm4/system  migrate sles11_qemu_12 qemu+ssh://linux-vm5/system
Password:

14:05 2012-05-25
software, skill, network, ssh, SSH login without password; document, summary
1, ref: "11:11 2007-05-09", http://www.linuxproblem.org/art_9.html
2, generate rsa key
linux-vm4:~/.ssh # ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
6f:0f:93:96:ad:a8:84:0e:15:35:d4:c6:3e:80:36:7a root@linux-vm4
The key's randomart image is:
+--[ RSA 2048]----+
|     o+o         |
|    +...+        |
|   o.. +         |
|  . E.  o        |
|   ..   S.       |
|   . .   . +     |
|  . . .   O .    |
|   o .   + =     |
|    . ... . .    |
+-----------------+
linux-vm4:~/.ssh # ls
id_rsa  id_rsa.pub  known_hosts

2, copy public key to the host your want to ssh login(linux-vm5 for me). and ad into authorized_keys.
1), method 1:
linux-vm4:~/.ssh # scp id_rsa.pub root@linux-vm5:/root/.ssh
Password:
id_rsa.pub                                    100%  396     0.4KB/s   00:00

add this key to authorized_keys:
linux-vm5:~/.ssh # cat id_rsa.pub >> authorized_keys

2), method 2: do the samething in one line.
linux-vm4:/etc/xen/vm # cat /root/.ssh/id_rsa.pub | ssh linux-x12 'cat >> .ssh/authorized_keys'
The authenticity of host 'linux-x12 (147.2.207.143)' can't be established.
RSA key fingerprint is ee:77:ea:8b:96:ae:87:f0:70:4a:e3:37:86:b7:44:aa.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'linux-x12' (RSA) to the list of known hosts.
Password:
linux-x12:~ # cat /root/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAsuIccJVzN9cR6S1bejEP8H1xTocj8qo3Ml/+bwZ8nu9a5fOVpAqPgWwWg6Wp/5S9+N1V8dS/2kRXEcq0Kqd4s0eaac+S2gO6Pk1kyXtPF0sbOAXiLaVENN8WgVNnMKw3fBsTD4qYC5KH5nYcK50CBWa4Bj54y9FfhdkKENvhr+POWmFUd0pNVgy9ihWWeVZCXtiDiHYF06BQZ63wwwyNUaxRUJfJJk5wWVDFbI9dU1MytPYXmypQFKl5lLCrOVMhZ/lN8OcGZVLma3HYnIcdWsQ2v1vGEA7pkE8yLFQFxHnIcRlubmdpJknBluvkoBZIXed4QItwwTH4/GP5AZXr4Q== root@linux-vm4

11:42 2012-5-27
company, colleague, Product Manager, PlateSpin, Steve Stavridis
1, "Alan Gao"_email_"New hire - APAC PlateSpin Product Manager"_20120525_1847
Please welcome Steve Stavridis to the APAC marketing team.

Steve joins us as the APAC Product Manager for PlateSpin.  In the role he will work with all the APAC countries to identify and develop PlateSpin opportunities and focus on the revenue growth for PlateSpin across the region.  He will initially focus on:

1.      Review and document the go-to-market model each location to ensure that we have maximum coverage via a channel led model
2.      Look at best practices globally and locally to leverage and develop channel strategies, alliance opps, OEM deals etc…
3.      APAC key spokesperson for PlateSpin for end user, channel, PR, social media and marketing events.
4.      Assist channel in conjunction with local resources where required to identity and close sales
5.      Product specialist and key communicator in the region to corporate in US and Canada

Some background
Steve has more than seventeen years’ experience in the IT industry with extensive industry knowledge of data centre solutions including storage architecture and design, information management, backup and disaster recovery.

Prior to joining The Attachmate Group, Steve was a Senior Systems Engineer for Symantec. Here, he was responsible for providing technical pre-sales and architecture design support to large enterprise corporations and government agencies across Australia and New Zealand.

Previously, Steve was the Product Marketing Manager at Sun Microsystems for Sun’s Storage Portfolio across Australia and New Zealand. Steve has also held positions at Dimension Data, CNI Group and Integration Design, where he implemented a variety of high calibre consulting projects for several major corporations.

Steve is a graduate of La Trobe University and holds majors in Computer Science and Mathematics.


Alan Gao

Senior Marketing Manager, Asia
agao@novell.com
(86-10) 6533-9051

11:08 2012-05-28
mailing, list, devel-server, work report; research
1, ""Jason Douglas" <jdouglas@suse.com>"_email. work report 21
* Review of SLES 11 SP2 Virtualization Whitepaper (additional review still required)
* Assisted with setup of Windows 8 Hyper-V for testing of SLE 11 SP2 guests

2, the flow of a package update.
1), question
"Darcy Partridge" <dpartrid@novell.com>
(1), 20120526_0356
I'm curious if it's known what version (from upstream) of pure-ftpd will be present in SLES 12?
Or any other plans to bring a new major version of pure-ftpd into any of our SLE products?  We're current on 1.0.22 and it's a bit older now.
2), "Kai Dupke <kdupke@suse.com>"
If there is a business case to do so for SLES we handle this as other
feature requests as well.
If this is a request for OES please check with Glen.
3), ""Matthias G. Eckermann" <mge@suse.com>"
searching our FATE database, the only SLE related request
in this area is FATE#313230: "Add support for FTP-S implicit
ssl to SLES" where you wanted to deliver more information.
All other requests are OES related and handled by the OES
team, as pointed out by Kai.
4), bamvor:
with the openFATE system, i can get some discussion about openSUSE arm:
https://features.opensuse.org/310070

11:25 2012-05-28
What Will Be The Fate Of SUSE Linux?
http://blogs.forrester.com/richard_fichera/10-11-27-what_will_be_the_fate_of_suse_linux
With the inescapable caveat that this is a developing situation, my current take on SUSE Linux is that there is no reason to back away from it or to fear that it will disappear into the maw of some giant IT company.

11:47 2012-05-28
GTD
0, 10:30-11:50 15:30-16:47 17:10-18:18

1, today
1), check the mail. mailing list. see"11:08 2012-05-28".
2), bugzilla can not access. it is ok soon.
3), 13:30-15:30 go back home, waiting and testing Kawai CL26IIB
4), wireshark bug. see"15:50 2012-05-28"

15:50 2012-05-28
company, network, wireshark, fix 3 bugs from upstream, using new maintenance model for branching and checking out
0, ref
[devel] FAQ for the New Maintenance Model, see"11:35 2012-05-17".

1, status
1), bug list
https://bugzilla.novell.com/show_bug.cgi?id=763855
https://bugzilla.novell.com/show_bug.cgi?id=763857
https://bugzilla.novell.com/show_bug.cgi?id=763859
2), should update to 1.4.13
3), this bug is mark as duplicated as bnc 7120.
https://bugs.wireshark.org/bugzilla/show_bug.cgi?id=7123

2, branch and checkout
1), obs
bamvor@linux-x12:~/work/wireshark> osc sm wireshark
SUSE:SLE-10-SP3:Update:Test/wireshark
SUSE:SLE-11:Update:Test/wireshark
SUSE:SLE-9-SP3:Update:Teradata:Test/wireshark
bamvor@linux-x12:~/work/wireshark> osc mbranch wireshark
Project home:bjzhang:branches:OBS_Maintained:wireshark created.
bamvor@linux-x12:~/work/wireshark> osc co home:bjzhang:branches:OBS_Maintained:wireshark
A    home:bjzhang:branches:OBS_Maintained:wireshark
A    home:bjzhang:branches:OBS_Maintained:wireshark/wireshark.SUSE_SLE-10-SP3_Update_Test
...
A    home:bjzhang:branches:OBS_Maintained:wireshark/wireshark.SUSE_SLE-9-SP3_Update_Teradata_Test/wireshark.spec
At revision 307eeb39145d6d74a634cafba5077c6f.
bamvor@linux-x12:~/work/wireshark>
2), ibs
bamvor@linux-x12:~/work/wireshark/openSUSE> osc -A https://api.opensuse.org sm wireshark
openSUSE:11.4:Update/wireshark
openSUSE:12.1:Update/wireshark
bamvor@linux-x12:~/work/wireshark/openSUSE> osc -A https://api.opensuse.org mbranch wireshark
Project home:bjzhang:branches:OBS_Maintained:wireshark created.
bamvor@linux-x12:~/work/wireshark/openSUSE> osc -A https://api.opensuse.org co home:bjzhang:branches:OBS_Maintained:wireshark
A    home:bjzhang:branches:OBS_Maintained:wireshark
A    home:bjzhang:branches:OBS_Maintained:wireshark/wireshark.openSUSE_11.4_Update
...

3, edit wireshark.spec and wireshark.changes
1), "osc vc" for edit wireshark.changes
osc will add date, time and user name automatically.

4, "openSUSE_11.4_Update" has already update by andreas.stieger@gmx.de in "Tue May 22 19:20:17 UTC 2012". and also openSUSE_12.1_Update.
here is the bugzilla trace for openSUSE_11.4, create by "Andreas Stieger":
https://bugzilla.novell.com/show_bug.cgi?id=763634

5, wireshark sles11/sles10 build successful, but no test yet.

13:47 2012-05-29
GTD
0, -17:27 20:20-22:20

1, today
1), wireshark bug. see"14:34 2012-05-29".
2), libvirt qemu migration study. see"16:25 2012-05-29".
3), work report. see"15:32 2012-05-29".

14:29 2012-05-29
software, skill, openSUSE, audio, player, install the restricted format(mp3 and etc)
http://help.opensuse.org/ksuseinstall/
http://opensuse-community.org/Restricted_formats/12.1
zypper addrepo -r http://packman.inode.at/suse/12.1/packman.repo
zypper addrepo -r http://www.opensuse-guide.org/repo/12.1/libdvdcss.repo

notes: I got these links from kaffeine.

14:34 2012-05-29
company, network, wireshark, fix 3 bugs from upstream, using new maintenance model for branching and checking out, cont1
1, test wireshark 1.4.13 on sles11 sp2.
start wireshark through root. start with normal user will fail at get the interface list.
wireshark works well.

2, send request
bamvor@linux-x12:wireshark.SUSE_SLE-11_Update_Test> osc sr -m "update to 1.4.13: fix bnc#763855(CVE-2012-2392), bnc#763857(CVE-2012-2393), bnc#763859(CVE-2012-2394)(fixed upstream)"
created request id 19477
bamvor@linux-x12:wireshark.SUSE_SLE-10-SP3_Update_Test> osc sr -m "update to 1.4.13: fix bnc#763855(CVE-2012-2392), bnc#763857(CVE-2012-2393), bnc#763859(CVE-2012-2394)(fixed upstream)"
created request id 19478
2), (18:24 2012-06-04)
after several days, my request is accepted. here is the message for sle10-sp3. sle11 is similar.
""ro" <ro@suse.de>"_email_"[ci_new_pac] JFYI wireshark -> sle10-sp3"_20120604_1813
Script 'mail_helper' called by ro
Hello packager,

This is just FYI.  Your package was checked in in distribution "sle10-sp3"
by autobuild-member: ro.

Here comes the log...

---------------------------%<------------------------------
Hi,

here is the log from ci_new_pac /work/src/done/SLE10-SP3/wireshark -> sle10-sp3



## BNC# 763855 : "VUL-1: CVE-2012-2392: wireshark: denial of service in multiple dissectors / parsers" (NEW/)
## BNC# 763857 : "VUL-1: CVE-2012-2393: wireshark: DIAMETER memory allocation flaw" (NEW/)
## BNC# 763859 : "VUL-1: CVE-2012-2394: wireshark: denial of service via memory alignment flaw" (NEW/)

Changes:
--------
--- /work/SRC/old-versions/10.1/SLE-SP3-UPDATES/all/wireshark/wireshark.changes	2012-04-17 07:33:10.000000000 +0200
+++ /work/src/done/SLE10-SP3/wireshark/wireshark.changes	2012-05-28 11:50:53.000000000 +0200
@@ -1,0 +2,19 @@
+Mon May 28 09:40:53 UTC 2012 - bjzhang@suse.com
+
+- update to 1.4.13
+  - fix bnc#763855(CVE-2012-2392), bnc#763857(CVE-2012-2393), bnc#763859(CVE-2012-2394)(fixed upstream)
......
+-------------------------------------------------------------------

calling whatdependson for sle10-sp3-i386
Packages directly triggered for rebuild:
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Comparing /work/SRC/old-versions/10.1/SLE-SP3-UPDATES/all/wireshark (Old)
 and      /work/src/done/SLE10-SP3/wireshark (BS:build ID:19478 MAIL:bjzhang@suse.com) (New)
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Package is "wireshark", Maintainer is "BJZhang@suse.com"


Old:
----
  wireshark-1.4.12.tar.bz2

New:
----
  wireshark-1.4.13.tar.bz2

.....

++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

continue with "q"...


Checked in at Mon Jun 4 12:13:52 CEST 2012 by ro

Remember to have fun...
"18:24 2012-06-04"end.

3, check the code in sles9.
1), wireshark 1.0.16 "quilt setup wireshark.spec" fail:
Patch #5 (wireshark-1.0.16-CVE-2011-4102.patch):
+ /bin/cat /home/bamvor/work/wireshark/home:bjzhang:branches:OBS_Maintained:wireshark/wireshark.SUSE_SLE-9-SP3_Update_Teradata_Test/wireshark-1.0.16-CVE-2011-4102.patch
+ /tmp/inspect.slwPGp/bin/patch -s -p1 --fuzz=0
1 out of 2 hunks FAILED -- saving rejects to file wiretap/erf.c.rej
error: Bad exit status from /var/tmp/rpm-tmp.aTZ1mW (%prep)

but patch successful if "patch -p1 < ../this_patch_file".

2),
http://anonsvn.wireshark.org/viewvc?view=revision&revision=42200

15:32 2012-05-29
work report - week 21
[devel-server] work report - week 21
[green]
1, xen patch for retrieving domain console tty
send this patch on Wednesday last week, but no further response right now.
2, libvirt libxl migration.
learn libvirt qemu migration and lock relative code for libvirt libxl lock patch.

16:25 2012-05-29
virtualization, libvirt, xen, xenlight, qemu, migration, study the lock
1, gdb log
(gdb) cont
Continuing.
[Switching to Thread 0x7fbaf19ac700 (LWP 3897)]
170043
qemudOpen[Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170043
qemudNumDomains170043
qemuDriverLock, driver 170043
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170043
qemudOpen[Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170043
qemudListDomains170043
qemuDriverLock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170043
qemudOpen[Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170043
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170043
qemudNumDomains170043
qemuDriverLock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170043
qemudDomainLookupByID170044
qemuDriverLock, driver [Switching to Thread 0x7fbaf19ac700 (LWP 3897)]
170044
qemudDomainLookupByName170044
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf19ac700 (LWP 3897)]
170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170044
qemudListDomains[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170044
qemuDomainGetState[Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170044
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170044
qemuDriverLock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170044
qemudDomainLookupByName[Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170044
qemudDomainLookupByID170044
qemuDriverLock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170044
qemuDriverLock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170044
qemudClose170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170044
qemudClose170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170044
qemudSupportsFeature[Switching to Thread 0x7fbaf11ab700 (LWP 3898)]
170044
qemudSupportsFeature[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170044
qemuDomainMigrateBegin3170044
qemuDriverLock, driver 170044
qemuDomainObjBeginAsyncJobWithDriver170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
virGetHostname170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170044
qemudDomainGetInfo170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170044
qemuDomainMigratePerform3170044
qemuDriverLock, driver 170044
virGetHostname170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170044
qemuDriverLock, driver 170044
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf11ab700 (LWP 3898)]
170045
qemudOpen[Switching to Thread 0x7fbaf09aa700 (LWP 3899)]
170045
qemudOpen[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverLock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170045
qemudNumDomains170045
qemuDriverLock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170045
qemudNumDomains170045
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf19ac700 (LWP 3897)]
170045
qemudListDomains170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170045
qemudListDomains[Switching to Thread 0x7fbaf29ae700 (LWP 3895)]
170045
qemudDomainLookupByID170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170045
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverLock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170045
qemudClose170045
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf29ae700 (LWP 3895)]
170045
qemudDomainLookupByID170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170045
qemuDomainGetState[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170045
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverLock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170045
qemudClose170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver 170045
qemuDriverLock, driver 170045
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf29ae700 (LWP 3895)]
170046
qemudOpen[Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170046
qemudOpen[Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170046
qemudNumDomains170046
qemuDriverLock, driver 170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170046
qemudNumDomains170046
qemuDriverLock, driver 170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170046
qemudListDomains170046
qemuDriverLock, driver 170046
qemuDriverUnlock, driver 170046
qemudListDomains170046
qemuDriverLock, driver 170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf11ab700 (LWP 3898)]
170046
qemudDomainLookupByID170046
qemuDriverLock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170046
qemudDomainLookupByID170046
qemuDriverLock, driver [Switching to Thread 0x7fbaf11ab700 (LWP 3898)]
170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170046
qemuDriverLock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170046
qemudClose170046
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170046
qemuDomainGetState170046
qemuDriverLock, driver 170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170046
qemudClose170046
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170046
qemuDriverLock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170046
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170046
qemuDriverUnlock, driver 170046
qemuDriverLock, driver 170046
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver 170047
qemuDriverLock, driver 170047
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf09aa700 (LWP 3899)]
170047
qemudOpen[Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170047
qemudOpen[Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170047
qemudNumDomains170047
qemuDriverLock, driver [Switching to Thread 0x7fbaf19ac700 (LWP 3897)]
170047
qemudNumDomains170047
qemuDriverLock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170047
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverLock, driver [Switching to Thread 0x7fbaf19ac700 (LWP 3897)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170048
qemudListDomains[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverLock, driver [Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170048
qemudListDomains170048
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170048
qemuDriverLock, driver [Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverLock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170048
---Type <return> to continue, or q <return> to quit---
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170048
qemudDomainLookupByID170048
qemuDriverLock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170048
qemudDomainLookupByID170048
qemuDriverLock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverLock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170048
qemudClose[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170048
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverLock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170048
qemuDomainGetState170048
qemuDriverLock, driver 170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverLock, driver 170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170048
qemudClose170048
qemuDriverLock, driver 170048
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170048
qemuDriverLock, driver 170048
qemuDriverUnlock, driver 170048
qemuDriverLock, driver 170048
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver 170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf11ab700 (LWP 3898)]
170049
qemudOpen[Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170049
qemudNumDomains[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170049
qemuDriverLock, driver [Switching to Thread 0x7fbaf29ae700 (LWP 3895)]
170049
qemudOpen[Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170049
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170049
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170049
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170049
qemuDriverLock, driver 170049
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170049
qemudNumDomains[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170049
qemuDriverLock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170049
qemuDriverLock, driver [Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170049
qemudListDomains[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170050
qemudListDomains170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverLock, driver [Switching to Thread 0x7fbaf29ae700 (LWP 3895)]
170050
qemudDomainLookupByID[Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170050
qemudDomainLookupByID[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver [Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170050
qemuDriverLock, driver [Switching to Thread 0x7fbaf29ae700 (LWP 3895)]
170050
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver [Switching to Thread 0x7fbaf29ae700 (LWP 3895)]
170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170050
qemudClose[Switching to Thread 0x7fbaf31af700 (LWP 3894)]
170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170050
qemuDomainGetState[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170050
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverLock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170050
qemudClose170050
qemuDriverLock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver 170050
qemuDriverLock, driver 170050
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170051
qemuDomainMigrateConfirm3170051
qemuDriverLock, driver 170051
virGetHostname170051
qemuDriverUnlock, driver 170051
qemuDriverLock, driver 170051
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170051
qemudOpen[Switching to Thread 0x7fbaf39b0700 (LWP 3893)]
170051
qemudOpen[Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170051
qemudNumDomains170051
qemuDriverLock, driver 170051
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170051
qemudNumDomains[Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170051
qemudClose170051
qemuDriverLock, driver 170051
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170051
qemuDriverLock, driver 170051
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170051
qemudClose170051
qemuDriverLock, driver 170051
qemuDriverUnlock, driver 170051
qemudClose170051
qemuDriverLock, driver 170051
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf11ab700 (LWP 3898)]
170051
qemudOpen[Switching to Thread 0x7fbaf21ad700 (LWP 3896)]
170051
qemudSupportsFeature[Switching to Thread 0x7fbaf49b2700 (LWP 3891)]
170051
qemuDomainMigratePrepare3170051
qemuDriverLock, driver 170051
virGetHostname170051
virGetHostname170051
qemuDomainObjBeginAsyncJobWithDriver170051
qemuDriverUnlock, driver 170051
qemuDriverLock, driver Detaching after fork from child process 5136.
Detaching after fork from child process 5137.
170051
qemuDriverUnlock, driver 170052
qemuDriverLock, driver 170052
qemuDriverUnlock, driver 170052
qemuDriverLock, driver 170052
qemuDriverUnlock, driver 170052
qemuDriverLock, driver 170052
qemuDriverUnlock, driver 170052
qemuDriverLock, driver 170052
nodeGetInfo170052
qemuDriverUnlock, driver 170052
qemuDriverLock, driver 170052
qemuDriverUnlock, driver 170052
qemuDriverLock, driver 170052
qemuDriverUnlock, driver 170052
qemuDriverLock, driver 170052
qemuDriverUnlock, driver [Switching to Thread 0x7fbaf41b1700 (LWP 3892)]
170058
qemuDomainMigrateFinish3170058
qemuDriverLock, driver 170058
virGetHostname170058
qemuDriverUnlock, driver 170058
qemuDriverLock, driver 170058
qemuDriverUnlock, driver 170058
qemuDriverLock, driver 170058
qemuDriverUnlock, driver [Switching to Thread 0x7fbafcb9b860 (LWP 3890)]
170059
qemudClose170059
qemuDriverLock, driver 170059
qemuDriverUnlock, driver

2, i found that  there is no libxlDriverLock while libxlMigratePerform3?
\TODO: add it and test migration.
看看会不会和上面qemu类似，在migration perform3 过程中有多次driver lock/unlock.

3, add libxlDriverLock in libxlMigratePerform3

4, fix libxlCheckMessageBanner bug. add retry while EAGAIN. this is not the final fix. just fix it for debug the corrupt between "virsh list" and "virsh migrate".

5, log for libxl migrate
Breakpoint 1, libxlDomainMigrateBegin3 (domain=0x7f2bc8003510, xmlin=0x0, cookieout=0x7f2be5ea2b10, cookieoutlen=0x7f2be5ea2b1c,
    flags=0, dname=0x0, resource=0) at libxl/libxl_driver.c:3944
3944        libxlDriverLock(driver);
libxlDriverLock[Switching to Thread 0x7f2be7ea7700 (LWP 6459)]

Breakpoint 1, libxlDomainGetInfo (dom=0x7f2bdc010220, info=0x7f2be7ea6af0) at libxl/libxl_driver.c:1775
1775        libxlDriverLock(driver);
libxlDriverLock
Breakpoint 2, libxlDomainGetInfo (dom=0x7f2bdc010220, info=0x7f2be7ea6af0) at libxl/libxl_driver.c:1777
1777        libxlDriverUnlock(driver);
libxlDriverUnlock[Switching to Thread 0x7f2be6ea5700 (LWP 6461)]

Breakpoint 1, libxlDomainMigratePerform3 (dom=0x7f2bc8000e50, xmlin=0x0, cookiein=0x0, cookieinlen=0, cookieout=0x7f2be6ea4b10,
    cookieoutlen=0x7f2be6ea4b1c, dconnuri=0x0, uri=0x7f2bc8003920 "linux-vm5:49512", flags=0, dname=0x0, resource=0)
---Type <return> to continue, or q <return> to quit---
    at libxl/libxl_driver.c:4273
4273        libxlDriverLock(driver);
libxlDriverLockDetaching after fork from child process 16983.
[Switching to Thread 0x7f2be66a4700 (LWP 6462)]

Breakpoint 1, libxlNumDomains (conn=0x7f2bdc010990) at libxl/libxl_driver.c:1192
1192        libxlDriverLock(driver);
libxlDriverLock[New Thread 0x7f2bc5ffd700 (LWP 16984)]
[Thread 0x7f2bc5ffd700 (LWP 16984) exited]
[Switching to Thread 0x7f2be6ea5700 (LWP 6461)]

Breakpoint 2, libxlDomainMigratePerform3 (dom=0x7f2bc8000b70, xmlin=<optimized out>, cookiein=<optimized out>,
    cookieinlen=<optimized out>, cookieout=<optimized out>, cookieoutlen=<optimized out>, dconnuri=0x0,
    uri=0x7f2bc8003920 "linux-vm5:49512", flags=0, dname=0x0, resource=0) at libxl/libxl_driver.c:4301
4301        libxlDriverUnlock(driver);
libxlDriverUnlock[Switching to Thread 0x7f2be66a4700 (LWP 6462)]

Breakpoint 2, libxlNumDomains (conn=<optimized out>) at libxl/libxl_driver.c:1194
1194        libxlDriverUnlock(driver);
libxlDriverUnlock[Switching to Thread 0x7f2be4ea1700 (LWP 6465)]

Breakpoint 1, libxlListDomains (conn=0x7f2bdc010990, ids=0x7f2bc8001250, nids=1) at libxl/libxl_driver.c:1179
1179        libxlDriverLock(driver);
libxlDriverLock
Breakpoint 2, libxlListDomains (conn=<optimized out>, ids=0x7f2bc8001250, nids=1) at libxl/libxl_driver.c:1181
1181        libxlDriverUnlock(driver);
libxlDriverUnlock[Switching to Thread 0x7f2be76a6700 (LWP 6460)]

Breakpoint 1, libxlDomainMigrateConfirm3 (domain=0x7f2bdc010d50, cookiein=0x0, cookieinlen=0, flags=0, cancelled=0)
    at libxl/libxl_driver.c:4400
4400        libxlDriverLock(driver);
libxlDriverLock[Switching to Thread 0x7f2be7ea7700 (LWP 6459)]

Breakpoint 1, libxlDomainLookupByID (conn=0x7f2bdc010990, id=15) at libxl/libxl_driver.c:1250
1250        libxlDriverLock(driver);
libxlDriverLock[Thread 0x7f2bccbf9700 (LWP 16337) exited]
[Switching to Thread 0x7f2be76a6700 (LWP 6460)]

Breakpoint 2, libxlDomainMigrateConfirm3 (domain=<optimized out>, cookiein=<optimized out>, cookieinlen=<optimized out>, flags=0,
    cancelled=0) at libxl/libxl_driver.c:4454
4454        libxlDriverUnlock(driver);
libxlDriverUnlock[Switching to Thread 0x7f2be7ea7700 (LWP 6459)]

Breakpoint 2, libxlDomainLookupByID (conn=0x7f2bdc010990, id=15) at libxl/libxl_driver.c:1252
1252        libxlDriverUnlock(driver);
libxlDriverUnlock[Switching to Thread 0x7f2bf0090860 (LWP 6458)]

Breakpoint 1, libxlClose (conn=0x7f2bdc010990) at libxl/libxl_driver.c:1102
1102        libxlDriverLock(driver);
libxlDriverLock
Breakpoint 2, libxlClose (conn=0x7f2bdc010990) at libxl/libxl_driver.c:1105
1105        libxlDriverUnlock(driver);
libxlDriverUnlock
Breakpoint 1, libxlClose (conn=0x7f2bc80039a0) at libxl/libxl_driver.c:1102
1102        libxlDriverLock(driver);
libxlDriverLock
Breakpoint 2, libxlClose (conn=0x7f2bc80039a0) at libxl/libxl_driver.c:1105
1105        libxlDriverUnlock(driver);
libxlDriverUnlockDetaching after fork from child process 17092.

5, i can not understand why qemu can process list commands while migration processing. debug qemu code to get it.

10:48 2012-05-30
GTD 0, 10:40-11:55 13:49-15:00 17:36-

1, today
1), 20' check the mail. get partition size from filesystem. see"11:02 2012-05-30"
2), 11:16-11:55 14:14-15:00 17:36- xen upstream patch. see"10:49 2012-05-30".
3), 40' piano forum.
4), 20' wireshark comments:  我现在很糊涂阿，连简单的comments都能写错。

10:49 2012-05-30
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream, cont7, upstream reply to patch v2
1, 现在真是心态不行了，看到upstream回信，我都紧张。调整一下。
2, upstream replay
1), choice the proper return value in libxl_console_get_tty
(1), Ian C
> +    switch (type) {
> +    case LIBXL_CONSOLE_TYPE_SERIAL:
    ...
> +        rc = ERROR_FAIL;
Strictly this ought to be ERROR_INVAL.
(2), Ian J
> Strictly this ought to be ERROR_INVAL.
Yes.

2), discuss about choose GC_INIT/GC_FREE or gc between Ian C and Ian J.
Finally, I do not need to change my code for this one.
> Generally since this is an internal function it should take a libxl__gc
> *gc not a ctx and drop the GC_INIT and GC_FREE. You can use the CTX
> macro to get a ctx where you need one.
I think this is fine.  In fact in the future we might want to make
this a public function (but not now).
> However since the two callers are thinish wrappers around this and you'd
> then need the GC_INIT, GC_FREE stuff there I'm inclined to suggest we
> make an exception here and leave it as is, Ian J what do you think?
I think there is no rule against internal functions taking ctx.  gc is
more conventional but here I think the balance of convenience is in
favour of what Bamvor has done.
Particularly since the outer two functions are so simple.

3), bamvor: maybe delete out here?
(1), Ian C:
> +int libxl_primary_console_exec(libxl_ctx *ctx, uint32_t domid_vm)
> +{
> +    uint32_t domid_out;
> +    int cons_num_out;
> +    libxl_console_type type_out;

These aren't really _out vars here...

There isn't much here which warrants a resend IMHO, if Ian J is happy
with the libxl__primary_console_find interface (as discussed above) I'd
be inclined to take it as is unless you really want to do a respin.
(2), Ian J:
((1)),
I think my comment about the log message ought to be addressed with a
resend.

The nits could have been fixed in-tree at our leisure but if we're
going to have a resend it would be best to address them all.

((2)), As Ian C says, these shouldn't be called "*_out".

4), lots of update here:
Ian J:
> +    if (tty)
> +        *path = strdup(tty);
> +    else
> +        rc = ERROR_FAIL;

Firstly, you need to log something on error here or this function will
fail without logging anything if the console is broken.

Secondly, you should use
    libxl__strdup(0, tty)
to get the right error behaviour (if strdup's malloc fails).  Ie,

Thirdly, this is a rather odd error handling pattern.  I would write
       tty = libxl__xs_read(gc, XBT_NULL, tty_path);
       if (!tty) {
           LOGE(ERROR,"unable to read console tty path `%s'",tty_path);
           rc = ERROR_FAIL;
           goto out;
       }
leaving the main flow to carry on:
       *path = libxl__strdup(0, tty);
       rc = 0;

Fourthly, you can then leave rc uninitialised at the top of the
function.  Any path which as a result gets to the exit with it
uninitialised will produce a compiler warning which would previously
have been erroneously suppressed.

5), bamvor: about white space
Ian J:
> -            LOG(ERROR,"unable to get domain type for domid=%"PRIu32,domid_vm);
> +            LOG(ERROR,"unable to get domain type for domid=%"PRIu32, domid_vm);

Unrelated whitespace change.

6), bamvor: i should add empty line between my comment and other function.
Ian J:
A formatting nit: I think if we're going to have multi-line comments
associated with functions we should have a blank line either side of
the information about the function to visually associate the comment
with the right function.

7), Ian J
(1), bamvor: there is only one good news.
> This api retrieve domain console from xenstore. With this new api, it is easy to implement "virsh console" command in libvirt libxl driver.
It's looking pretty good.

11:02 2012-05-30
mailing, list, research; filesystem, partition, how to get the end of a partition from a filesystem
1, how to get the end of a partition from a filesystem
1), "Jean Delvare <jdelvare@suse.de>"_email_"[Research] Filesystem size"_20120529_0456
Is it possible to ask a filesystem (in my case: ext4) how much partition
space it thinks it is operating on?
I have a disk which lost some partitioning information, I was able to
restore it using TestDisk [1] and while the partition starts are
definitely correct, I am a bit skeptical about the partition ends.
That's why I would like to ensure that the filesystem is happy with the
partition space it is currently granted access to.
I tried tune2fs -l but either it doesn't print that information or I
don't know where to look.
[1] http://www.cgsecurity.org/wiki/TestDisk
2), "Thomas Fehr <fehr@suse.de>"
I would assume it can be computed from the "Block count:", "Block size:"
and "First block:" of tune2fs -l output. At least on the ext4 filesystems
I checked bcount*bsize = volume_size holds (first block is always zero
in my filesystems).
3), "Jan Kara <jack@suse.cz>"
Yes, that is correct. "First block" will be 1 on filesystems with <= 1KB
blocksize and 0 everywhere else so you can disregard that in most cases.
4), try it
(1), get the Block count, Block size and First block from tune2fs. take /dev/sda8(ext4 filesystem) as example.
linux-x12:~ # tune2fs -l /dev/sda8 | grep "\(Block\)\|\(First block\)"
Block count:              16252927
First block:              0
Block size:               4096
Blocks per group:         32768
(2), So, volume_size = 16252927 * 4096 / 1024 = 65011708
But, it is 65011712 in fdisk, one block is missing from tune2fs result, why?
linux-x12:~ # fdisk -l /dev/sda | grep sda8
/dev/sda8       823140352   953163775    65011712   83  Linux
IT IS CORRECT IN /dev/sda9.
MAYBE, it depends on the first block as "Jan Kara" said.

17:13 2012-05-30
software, skill, audio, gstreamer, gst-launch, audio player, recorder; gstreamer web camera video capture
1, audio
1), ref: http://lists.affinix.com/pipermail/delta-affinix.com/2009-April/001493.html
(1), play record.ogg
gst-launch-0.10 filesrc location=record.ogg ! decodebin ! audioconvert ! audioresample ! alsasink
(2), record mic to record.ogg
gst-launch-0.10 alsasrc ! audioconvert ! audioresample ! vorbisenc ! oggmux ! filesink location=record.ogg
(3), play mic on speaker
bamvor@linux-x12:temp> gst-launch-0.10 alsasrc ! audioconvert ! audioresample ! alsasink
Setting pipeline to PAUSED ...
Pipeline is live and does not need PREROLL ...
Setting pipeline to PLAYING ...
New clock: GstAudioSrcClock
^CCaught interrupt -- handling interrupt.
Interrupt: Stopping pipeline ...
Execution ended after 11513056332 ns.
Setting pipeline to PAUSED ...
Setting pipeline to READY ...
Setting pipeline to NULL ...
Freeing pipeline ...

2), Webcam and Linux – GStreamer tutorial
http://www.twm-kd.com/linux/webcam-and-linux-gstreamer-tutorial/

11:23 2012-05-31
入职, change email address domain, change email suffix; upload your photo; get your badge
1, find your personal infomation through employee search toolbar in top right of the novell innerweb.
2, edit your infomation:
change your email domain from novell.com to suse.com
3, send your photo to "securityservices@novell.com".  you can also apply your badge from this team.

11:34 2012-05-31
company, suse, SLES12 plan
"Olaf Kirch <okir@suse.com>"_email_"[devel] Set the Controls for SLE12"
Since we've still got quite some time to go until SLE12 (I currently assume it be will released around mid 2014)

Since that kick-off meeting, we have begun to form virtual teams around
a variety of topics that have come up. The purpose of these teams is to
address functional areas of SLE that either need several teams to cooperate,
or that need a long preparation phase to get them done for SLE12.
You can find the current list of teams a
https://wiki.innerweb.novell.com/index.php/SUSE/SLE12/Virtual_Teams

I won't go much into the details on these in this email - we'll save that
for a later date. However, if you're curious, you can find the current
"SLE 12 Themes" document at http://w3.suse.de/~aj/SLE_XII_BigPicture.odt
(NOTE: this document is *confidential* and must not be shared outside of
SUSE)

13:03 2012-05-31
GTD
0, 11:20-11:50 13:42-17:50 21:00-21:30 22:02-22:50

1, today
1), 5' write doc for  on boarding. see"11:23 2012-05-31"
2), 10' SLES12 plan, see"11:34 2012-05-31".
3), 13:03-13:42 piano website.
4), 13:42-17:50 21:00-21:30 22:02-22:50 xen upstream patch. see"13:45 2012-05-31".
5), 10' support QA to get xen virt-caps from xm or xl. see"13:55 2012-05-31"
6), 21:30-22:02 phone call.

13:45 2012-05-31
virtualization, libvirt, xen, libxlDomainOpenConsole need a new api in xen, patch, resend patch to upstream, cont8, write patch v3, test done
1, plan
1), write patch v3.
2), test it on xen4.1 on sles11 sp2. (cancel. because some update is relative to xen4.2)
3), test it on xen4.2 on sles11 sp2.

2, write patch, ref"10:49 2012-05-30"
3, done, compile.
try to compile xen4.2(aka xen-unstable) on build service.
It pained me to compile xen on myself computer.

4, compile error
1), _paths.h not found
gcc  -O1 -fno-omit-frame-pointer -m64 -g -fno-strict-aliasing -std=gnu99 -Wall -Wstrict-prototypes -Wdeclaration-after-statement   -D__XEN_TOOLS__ -MMD -MF .xl.o.d  -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE -fno-optimize-sibling-calls -Werror -Wno-format-zero-length -Wmissing-declarations -Wno-declaration-after-statement -Wformat-nonliteral -I. -fPIC -pthread -I/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools/libxl/../../tools/libxc -I/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools/libxl/../../tools/include  -I/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools/libxl/../../tools/libxl -I/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools/libxl/../../tools/libxc -I/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools/libxl/../../tools/include -I/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools/libxl/../../tools/include -include /home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools/libxl/../../tools/config.h   -c -o xl.o xl.c
In file included from xl.c:33:
xl.h:20:20: error: _paths.h: No such file or directory
xl.c: In function ‘parse_global_config’:
xl.c:76: error: ‘XEN_LOCK_DIR’ undeclared (first use in this function)
xl.c:76: error: (Each undeclared identifier is reported only once
xl.c:76: error: for each function it appears in.)
xl.c:76: error: expected ‘)’ before string constant
xl.c:76: error: expected ‘)’ before string constant
xl.c:76: error: expected ‘)’ before string constant
xl.c:76: error: expected ‘)’ before string constant
xl.c:76: error: expected ‘)’ before string constant
xl.c:76: error: expected ‘)’ before string constant
xl.c:76: error: too few arguments to function ‘memcpy’
xl.c:76: error: expected ‘)’ before string constant
xl.c: In function ‘main’:
xl.c:230: error: ‘XEN_CONFIG_DIR’ undeclared (first use in this function)
xl.c:230: error: expected ‘)’ before string constant
xl.c:231: error: too few arguments to function ‘libxl_read_file_contents’
xl.c:234: error: expected ‘)’ before string constant
cc1: warnings being treated as errors
xl.c:234: error: too few arguments for format
xl.c:235: error: expected ‘)’ before string constant
xl.c:235: error: too few arguments to function ‘parse_global_config’
xl.c:197: error: unused variable ‘config_len’
make[4]: *** [xl.o] Error 1
make[4]: Leaving directory `/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools/libxl'
make[3]: *** [subdir-install-libxl] Error 2
make[3]: Leaving directory `/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools'
make[2]: *** [subdirs-install] Error 2
make[2]: Leaving directory `/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build/tools'
make[1]: *** [install-tools] Error 2
make[1]: Leaving directory `/home/bamvor/sda3/home/novell/work/source/virtualization/xen/upstream/xen-unstable.hg.build'
make: *** [world] Error 2
2), _paths.h is renamed from libxl_paths in version 894493e84fe7
(1),
((1)), log
bamvor@linux-x12:xen-unstable.hg.build> hg log -r 25413:894493e84fe7 -v
changeset:   25413:894493e84fe7
user:        Ian Campbell <ian.campbell@citrix.com>
date:        Tue May 29 16:44:06 2012 +0100
files:       tools/libxl/Makefile tools/libxl/libxl.h tools/libxl/libxl_internal.h tools/libxl/libxl_paths.c tools/libxl/xl.c tools/libxl/xl.h
description:
libxl: remove lockdir and config dir from the API

These are only used by xl.

Rename _libxl_paths.h -> _paths.h, these are not actually "libxl" paths but
rather are part of the Xen build time configuration. It is fine for xl to also
consume them.

Signed-off-by: Ian Campbell <ian.campbell@citrix.com>
Acked-by: Ian Jackson <ian.jackson@eu.citrix.com>
Committed-by: Ian Campbell <ian.campbell@citrix.com>

((2)), changes:
bamvor@linux-x12:xen-unstable.hg.build> hg diff -r 894493e84fe7 -r b60afa0611a3 | grep paths
-genpath-target = $(call buildmakevars2file,_paths.h.tmp)
+genpath-target = $(call buildmakevars2file,_libxl_paths.h.tmp)
-_paths.h: genpath
+_libxl_paths.h: genpath
-libxl_internal.h: _libxl_types_internal.h _paths.h
+libxl_internal.h: _libxl_types_internal.h _libxl_paths.h
-       $(RM) -f _*.c *.pyc _paths.*.tmp
+       $(RM) -f _*.c *.pyc _libxl_paths.*.tmp
+/* common paths */
-#include "_paths.h"
+#include "_libxl_paths.h"
diff -r 894493e84fe7 -r b60afa0611a3 tools/libxl/libxl_paths.c
--- a/tools/libxl/libxl_paths.c Tue May 29 16:44:06 2012 +0100
+++ b/tools/libxl/libxl_paths.c Tue May 29 16:36:53 2012 +0100
-#include "_paths.h"

(2),
bamvor@linux-x12:xen-unstable.hg.build> hg log -r e53a1d3c212c
changeset:   25430:e53a1d3c212c
user:        Ian Campbell <ian.campbell@citrix.com>
date:        Wed May 30 10:57:10 2012 +0100
summary:     xl: xl.h depends on geenrated file _paths.h

bamvor@linux-x12:xen-unstable.hg.build> hg diff -r e53a1d3c212c -r 29aa5da5a18c
diff -r e53a1d3c212c -r 29aa5da5a18c tools/libxl/Makefile
--- a/tools/libxl/Makefile      Wed May 30 10:57:10 2012 +0100
+++ b/tools/libxl/Makefile      Wed May 30 09:40:44 2012 +0100
@@ -120,7 +120,6 @@ libxl.h: _libxl_types.h
 libxl_json.h: _libxl_types_json.h
 libxl_internal.h: _libxl_types_internal.h _paths.h
 libxl_internal_json.h: _libxl_types_internal_json.h
-xl.h: _paths.h

 $(LIBXL_OBJS) $(LIBXLU_OBJS) $(XL_OBJS): libxl.h
 $(LIBXL_OBJS): libxl_internal.h

3), compile xl.o manaully. then make tools instead of "make world".
4), "make tools" successful, install and test it.

5, xl abort:
linux-vm6:/etc/xen/vm # xl console_get_tty 1
domain 1 console 0 type serial path �9b.
*** glibc detected *** xl: double free or corruption (fasttop): 0x0000000000623a00 ***
======= Backtrace: =========
/lib64/libc.so.6(+0x75358)[0x7f6b4dd91358]
/lib64/libc.so.6(cfree+0x6c)[0x7f6b4dd962fc]
xl[0x410fd5]
xl[0x406c4c]
/lib64/libc.so.6(__libc_start_main+0xe6)[0x7f6b4dd3ac36]
xl[0x406639]
======= Memory map: ========
00400000-00420000 r-xp 00000000 08:02 565410                             /usr/sbin/xl
00620000-00621000 r--p 00020000 08:02 565410                             /usr/sbin/xl
00621000-00623000 rw-p 00021000 08:02 565410                             /usr/sbin/xl
00623000-00624000 rw-p 00000000 00:00 0                                  [heap]
00624000-00625000 rw-p 00000000 00:00 0                                  [heap]
00625000-00626000 rw-p 00000000 00:00 0                                  [heap]
00626000-00627000 rw-p 00000000 00:00 0                                  [heap]
00627000-00644000 rw-p 00000000 00:00 0                                  [heap]
7f6b48000000-7f6b48021000 rw-p 00000000 00:00 0
7f6b48021000-7f6b4c000000 ---p 00000000 00:00 0
7f6b4ca9a000-7f6b4caaf000 r-xp 00000000 08:02 884860                     /lib64/libgcc_s.so.1
7f6b4caaf000-7f6b4ccae000 ---p 00015000 08:02 884860                     /lib64/libgcc_s.so.1
7f6b4ccae000-7f6b4ccaf000 r--p 00014000 08:02 884860                     /lib64/libgcc_s.so.1
7f6b4ccaf000-7f6b4ccb0000 rw-p 00015000 08:02 884860                     /lib64/libgcc_s.so.1
7f6b4ccb0000-7f6b4ccc5000 r-xp 00000000 08:02 884782                     /lib64/libz.so.1.2.3
7f6b4ccc5000-7f6b4cec4000 ---p 00015000 08:02 884782                     /lib64/libz.so.1.2.3
7f6b4cec4000-7f6b4cec5000 r--p 00014000 08:02 884782                     /lib64/libz.so.1.2.3
7f6b4cec5000-7f6b4cec6000 rw-p 00015000 08:02 884782                     /lib64/libz.so.1.2.3
7f6b4cec6000-7f6b4ced4000 r-xp 00000000 08:02 884825                     /lib64/libbz2.so.1.0.5
7f6b4ced4000-7f6b4d0d3000 ---p 0000e000 08:02 884825                     /lib64/libbz2.so.1.0.5
7f6b4d0d3000-7f6b4d0d4000 r--p 0000d000 08:02 884825                     /lib64/libbz2.so.1.0.5
7f6b4d0d4000-7f6b4d0d5000 rw-p 0000e000 08:02 884825                     /lib64/libbz2.so.1.0.5
7f6b4d0d5000-7f6b4d0d7000 r-xp 00000000 08:02 884751                     /lib64/libdl-2.11.3.so
7f6b4d0d7000-7f6b4d2d7000 ---p 00002000 08:02 884751                     /lib64/libdl-2.11.3.so
7f6b4d2d7000-7f6b4d2d8000 r--p 00002000 08:02 884751                     /lib64/libdl-2.11.3.so
7f6b4d2d8000-7f6b4d2d9000 rw-p 00003000 08:02 884751                     /lib64/libdl-2.11.3.so
7f6b4d2d9000-7f6b4d2dd000 r-xp 00000000 08:02 884855                     /lib64/libuuid.so.1.3.0
7f6b4d2dd000-7f6b4d4dc000 ---p 00004000 08:02 884855                     /lib64/libuuid.so.1.3.0
7f6b4d4dc000-7f6b4d4dd000 r--p 00003000 08:02 884855                     /lib64/libuuid.so.1.3.0
7f6b4d4dd000-7f6b4d4de000 rw-p 00004000 08:02 884855                     /lib64/libuuid.so.1.3.0
7f6b4d4de000-7f6b4d4e0000 r-xp 00000000 08:02 884779                     /lib64/libutil-2.11.3.so
7f6b4d4e0000-7f6b4d6df000 ---p 00002000 08:02 884779                     /lib64/libutil-2.11.3.so
7f6b4d6df000-7f6b4d6e0000 r--p 00001000 08:02 884779                     /lib64/libutil-2.11.3.so
7f6b4d6e0000-7f6b4d6e1000 rw-p 00002000 08:02 884779                     /lib64/libutil-2.11.3.so
7f6b4d6e1000-7f6b4d6e8000 r-xp 00000000 08:02 623241                     /usr/lib64/libblktapctl.so.1.0.0
7f6b4d6e8000-7f6b4d8e7000 ---p 00007000 08:02 623241                     /usr/lib64/libblktapctl.so.1.0.0
7f6b4d8e7000-7f6b4d8e8000 r--p 00006000 08:02 623241                     /usr/lib64/libblktapctl.so.1.0.0
7f6b4d8e8000-7f6b4d8e9000 rw-p 00007000 08:02 623241                     /usr/lib64/libblktapctl.so.1.0.0
7f6b4d8e9000-7f6b4d8ee000 r-xp 00000000 08:02 623240                     /usr/lib64/libxenstore.so.3.0.1
7f6b4d8ee000-7f6b4daee000 ---p 00005000 08:02 623240                     /usr/lib64/libxenstore.so.3.0.1
7f6b4daee000-7f6b4daef000 r--p 00005000 08:02 623240                     /usr/lib64/libxenstore.so.3.0.1
7f6b4daef000-7f6b4daf0000 rw-p 00006000 08:02 623240                     /usr/lib64/libxenstore.so.3.0.1
7f6b4daf0000-7f6b4daf3000 rw-p 00000000 00:00 0
7f6b4daf3000-7f6b4db1b000 r-xp 00000000 08:02 623239                     /usr/lib64/libxenguest.so.4.2.0
7f6b4db1b000-7f6b4dd1a000 ---p 00028000 08:02 623239                     /usr/lib64/libxenguest.so.4.2.0
7f6b4dd1a000-7f6b4dd1b000 r--p 00027000 08:02 623239                     /usr/lib64/libxenguest.so.4.2.0
7f6b4dd1b000-7f6b4dd1c000 rw-p 00028000 08:02 623239                     /usr/lib64/libxenguest.so.4.2.0
7f6b4dd1c000-7f6b4de87000 r-xp 00000000 08:02 884745                     /lib64/libc-2.11.3.so
7f6b4de87000-7f6b4e086000 ---p 0016b000 08:02 884745                     /lib64/libc-2.11.3.so
7f6b4e086000-7f6b4e08a000 r--p 0016a000 08:02 884745                     /lib64/libc-2.11.3.so
7f6b4e08a000-7f6b4e08b000 rw-p 0016e000 08:02 884745                     /lib64/libc-2.11.3.so
7f6b4e08b000-7f6b4e090000 rw-p 00000000 00:00 0
7f6b4e090000-7f6b4e0a7000 r-xp 00000000 08:02 884771                     /lib64/libpthread-2.11.3.so
7f6b4e0a7000-7f6b4e2a7000 ---p 00017000 08:02 884771                     /lib64/libpthread-2.11.3.so
7f6b4e2a7000-7f6b4e2a8000 r--p 00017000 08:02 884771                     /lib64/libpthread-2.11.3.so
7f6b4e2a8000-7f6b4e2a9000 rw-p 00018000 08:02 884771                     /lib64/libpthread-2.11.3.so
7f6b4e2a9000-7f6b4e2ad000 rw-p 00000000 00:00 0
7f6b4e2ad000-7f6b4e2b4000 r-xp 00000000 08:02 1164468                    /usr/lib64/libyajl.so.1.0.11
7f6b4e2b4000-7f6b4e4b4000 ---p 00007000 08:02 1164468                    /usr/lib64/libyajl.so.1.0.11
7f6b4e4b4000-7f6b4e4b5000 r--p 00007000 08:02 1164468                    /usr/lib64/libyajl.so.1.0.11
7f6b4e4b5000-7f6b4e4b6000 rw-p 00008000 08:02 1164468                    /usr/lib64/libyajl.so.1.0.11
7f6b4e4b6000-7f6b4e4d8000 r-xp 00000000 08:02 623237                     /usr/lib64/libxenctrl.so.4.2.0
7f6b4e4d8000-7f6b4e6d7000 ---p 00022000 08:02 623237                     /usr/lib64/libxenctrl.so.4.2.0
7f6b4e6d7000-7f6b4e6d8000 r--p 00021000 08:02 623237                     /usr/lib64/libxenctrl.so.4.2.0
7f6b4e6d8000-7f6b4e6d9000 rw-p 00022000 08:02 623237                     /usr/lib64/libxenctrl.so.4.2.0
7f6b4e6d9000-7f6b4e723000 r-xp 00000000 08:02 623185                     /usr/lib64/libxenlight.so.2.0.0
7f6b4e723000-7f6b4e923000 ---p 0004a000 08:02 623185                     /usr/lib64/libxenlight.so.2.0.0
7f6b4e923000-7f6b4e924000 r--p 0004a000 08:02 623185                     /usr/lib64/libxenlight.so.2.0.0
7f6b4e924000-7f6b4e926000 rw-p 0004b000 08:02 623185                     /usr/lib64/libxenlight.so.2.0.0
7f6b4e926000-7f6b4e934000 r-xp 00000000 08:02 623206                     /usr/lib64/libxlutil.so.1.0.0
7f6b4e934000-7f6b4eb33000 ---p 0000e000 08:02 623206                     /usr/lib64/libxlutil.so.1.0.0
7f6b4eb33000-7f6b4eb34000 r--p 0000d000 08:02 623206                     /usr/lib64/libxlutil.so.1.0.0
7f6b4eb34000-7f6b4eb35000 rw-p 0000e000 08:02 623206                     /usr/lib64/libxlutil.so.1.0.0
7f6b4eb35000-7f6b4eb54000 r-xp 00000000 08:02 884738                     /lib64/ld-2.11.3.so
7f6b4ed14000-7f6b4ed1c000 rw-p 00000000 00:00 0
7f6b4ed51000-7f6b4ed53000 rw-p 00000000 00:00 0
7f6b4ed53000-7f6b4ed54000 r--p 0001e000 08:02 884738                     /lib64/ld-2.11.3.so
7f6b4ed54000-7f6b4ed55000 rw-p 0001f000 08:02 884738                     /lib64/ld-2.11.3.so
7f6b4ed55000-7f6b4ed56000 rw-p 00000000 00:00 0
7fffc592e000-7fffc594f000 rw-p 00000000 00:00 0                          [stack]
7fffc59ff000-7fffc5a00000 r-xp 00000000 00:00 0                          [vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                  [vsyscall]
Aborted
6, (21:26 2012-05-31)
1), abort is caused by "*path = libxl__strdup(gc, tty);", the allocated memory will be freed in GC_FREE.
i also notice that Ian J want me to use the "*path = libxl__strdup(gc, tty);" to avoid the free.
but it will not work, when strdup allocate memory fails. So, it means that user can not get the error message. It is not we want to.
ref the code:
char *libxl__strdup(libxl__gc *gc, const char *c)
{
    char *s = strdup(c);

    if (!s) libxl__alloc_failed(CTX, __func__, strlen(c), 1);

    libxl__ptr_add(gc, s);

    return s;
}

#define CTX           libxl__gc_owner(gc)
static inline libxl_ctx *libxl__gc_owner(libxl__gc *gc)
{
    return gc->owner;
}

2), using the same handling as libxl__strdup
3), test pass. send patch tomorrow.

13:55 2012-05-31
software, skill; virtualization, xen, check xen capabilities
1, how to find out whether hvm or pv in system while system is boot up with xen kernel?
there is a parameter named "virt_caps". its value is hvm in my PC. I assume that this should be a different value in the PC not support the hvm.
notes: it is empty after virt_caps in the machine do not support hvm. i know this from other colleague.

linux-vm4:/home/bamvor # xm info
host                   : linux-vm4
release                : 3.0.13-0.27-xen
version                : #1 SMP Wed Feb 15 13:33:49 UTC 2012 (d73692b)
machine                : x86_64
nr_cpus                : 4
nr_nodes               : 1
cores_per_socket       : 1
threads_per_core       : 1
cpu_mhz                : 3392
hw_caps                : 0febfbff:28100800:00000000:00003f40:96982223:00000000:00000001:00000000
virt_caps              : hvm
total_memory           : 3071
free_memory            : 141
free_cpus              : 0
max_free_memory        : 2522
max_para_memory        : 2518
max_hvm_memory         : 2504
xen_major              : 4
xen_minor              : 1
xen_extra              : .2_18-6.1
xen_caps               : xen-3.0-x86_64 xen-3.0-x86_32p hvm-3.0-x86_32 hvm-3.0-x86_32p hvm-3.0-x86_64
xen_scheduler          : credit
xen_pagesize           : 4096
platform_params        : virt_start=0xffff800000000000
xen_changeset          : 23174
xen_commandline        :
cc_compiler            : gcc version 4.3.4 [gcc-4_3-branch revision 152973] (SUSE Linux)
cc_compile_by          : abuild
cc_compile_domain      :
cc_compile_date        : Sun May 20 14:39:47 UTC 2012
xend_config_format     : 4
linux-vm4:/home/bamvor # rcxend stop
Stopping xend (pid 3763 3762)                                                                                                                      done
linux-vm4:/home/bamvor # xl info
host                   : linux-vm4
release                : 3.0.13-0.27-xen
version                : #1 SMP Wed Feb 15 13:33:49 UTC 2012 (d73692b)
machine                : x86_64
nr_cpus                : 4
nr_nodes               : 1
cores_per_socket       : 1
threads_per_core       : 1
cpu_mhz                : 3392
hw_caps                : 0febfbff:28100800:00000000:00003f40:96982223:00000000:00000001:00000000
virt_caps              : hvm
total_memory           : 3071
free_memory            : 141
free_cpus              : 0
xen_major              : 4
xen_minor              : 1
xen_extra              : .2_18-6.1
xen_caps               : xen-3.0-x86_64 xen-3.0-x86_32p hvm-3.0-x86_32 hvm-3.0-x86_32p hvm-3.0-x86_64
xen_scheduler          : credit
xen_pagesize           : 4096
platform_params        : virt_start=0xffff800000000000
xen_changeset          : 23174
xen_commandline        :
cc_compiler            : gcc version 4.3.4 [gcc-4_3-branch revision 152973] (SUSE Linux)
cc_compile_by          : abuild
cc_compile_domain      :
cc_compile_date        : Sun May 20 14:39:47 UTC 2012
xend_config_format     : 4

17:30 2012-05-31
Linux, distribution, fedora; suse, openSUSE, bootloader, UEFI, security boot
1, "Tim Serong <tserong@suse.com>"_email_"[Research] Fwd: UEFI Secure Boot in Fedora"_0531_0335
Juat a heads-up for those who didn't see it yet:

  Implementing UEFI Secure Boot in Fedora
  http://mjg59.dreamwidth.org/12368.html

TL;DR:

- All Windows 8 hardware will ship with secure boot enabled.
- Fedora doesn't want to have to make users fiddle with their firmware
  settings in order to run Fedora, so must support secure boot.
- They're doing a multi-layer thing:
  - A tiny bootloader, signed with a microsoft key, loads:
  - a real bootloader (grub 2), signed with a fedora key which loads:
  - the kernel (& thus modules), also signed with fedora keys.

Presumably it's worth evaluating this to see if a similar approach is
suitable for openSUSE.

2, Implementing UEFI Secure Boot in Fedora
http://mjg59.dreamwidth.org/12368.html
MJG59

What about ARM

Microsoft's certification requirements for ARM machines forbid vendors from offering the ability to disable secure boot or enrol user keys. While we could support secure boot in the same way as we plan to on x86, it would prevent users from running modified software unless they paid money for a signing key. We don't find that acceptable and so have no plans to support it.

Thankfully this shouldn't be anywhere near as much of a problem as it would be in the x86 world. Microsoft have far less influence over the ARM market, and the only machines affected by this will be the ones explicitly designed to support Windows. If you want to run Linux on ARM then there'll be no shortage of hardware available to you.

17:51 2012-05-31
colleague, farewell letter
1, "Sen Ming Chang"_email_"谢谢过去的支持, 希望以后还有共事的机会"_20120531_1749
各位同仁

今天是我在Novell的最后一天，整整七年零三个月。在这七年间，公司的发展从最初的8个人到今天的120多人，离不开各位的大力支持，更离不开各位的努力坚守。虽然我今天要离开了，但是相信在各位的继续努力下，公司仍然会保持健康的发展。

回首这七年的历程，2005年全球董事会成员首次访华宣布中国投资计划，我们的Linux业务从IDC的第五名跃居第一名，也是全球唯一的超过Redhat的国家。2006年SUSE 10北京海洋馆5000人发布会。2007年中国移动、国家电网、曙光等过百万美金的大单。2008年全球所有高管及亚太区主管近百人访华并宣布第二期中国投资计划。2009年Dell OEM业务迅猛发展。2010年香港国泰和台湾行政署大单。2011年华为和腾讯超2M大单。2012年渠道拓展等等。每一个前进的脚步都留下了我们共同努力的汗水。再次感谢大家的努力。

七年来我们风风雨雨，但是我们以骄人的成绩给了总公司满意的答卷，也给我们自己一个欣慰的成果。天下没有不散的筵席，希望各位更加努力地工作，为公司，也为自己。更加积极地去迎接未来的变化, 更希望以后还有共事的机会! 再次祝各位工作顺利，身体健康。

以下是我的联系方式，我们后会有期！
手机：1380-118-9410
eMail: senmchang@gmail.com

Regards,
sm

2, Alan Gao
IBM18年将您铸成宝剑！Novell7年您开天辟地闯天下！！今天的您宝刀未老，必能再创出一片新天地！！！您永远是中国Linux业界尊敬的张博士！！！！

21:06 2012-05-31
virtualization, xen, xen-unstable, try to build xen-4.2 on build service; ibs
1, build error:
+ cd xen-4.2-testing
/var/tmp/rpm-tmp.54614: line 29: cd: xen-4.2-testing: No such file or directory
error: Bad exit status from /var/tmp/rpm-tmp.54614 (%prep)

2, change build directory in xen.spec
Index: xen.spec
===================================================================
--- xen.spec    (revision ce660dff0d980064f08da296954c9ab4)
+++ xen.spec    (working copy)
@@ -22,8 +22,8 @@
 ExclusiveArch:  %ix86 x86_64
 %define xvers 4.2
 %define xvermaj 4
-%define changeset 23174
-%define xen_build_dir xen-4.2-testing
+%define changeset 25376
+%define xen_build_dir xen-unstable.hg
 %define with_kmp 1
 %define with_stubdom 1
 # EFI requires gcc46 or newer

3, (15:37 2012-06-01)
1), fail again:
make: Entering directory `/usr/src/packages/BUILD/xen-unstable.hg/tools/include/xen-foreign'
/usr/src/packages/BUILD/xen-unstable.hg/tools/include/xen-foreign/../../../tools/Rules.mk:114: *** You have to run ./configure before building or installing the tools.  Stop.
make: Leaving directory `/usr/src/packages/BUILD/xen-unstable.hg/tools/include/xen-foreign'
error: Bad exit status from /var/tmp/rpm-tmp.2999 (%build)
2), comment make ... xen-foreign line.

