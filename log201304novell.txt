.LOG
14:08 2013-04-01
software, skill, locale的设定及其LANG、LC_ALL、LANGUAGE环境变量的区别
ref: http://hi.baidu.com/edeed/item/c23752f36abdd916ce9f3289
> locale
LANG=zh_CN.UTF-8
LC_CTYPE="zh_CN.UTF-8"
LC_NUMERIC="zh_CN.UTF-8"
LC_TIME="zh_CN.UTF-8"
LC_COLLATE="zh_CN.UTF-8"
LC_MONETARY="zh_CN.UTF-8"
LC_MESSAGES="zh_CN.UTF-8"
LC_PAPER="zh_CN.UTF-8"
LC_NAME="zh_CN.UTF-8"
LC_ADDRESS="zh_CN.UTF-8"
LC_TELEPHONE="zh_CN.UTF-8"
LC_MEASUREMENT="zh_CN.UTF-8"
LC_IDENTIFICATION="zh_CN.UTF-8"
LC_ALL=
> export LANG=en_US.UTF8
> locale
LANG=en_US.UTF8
LC_CTYPE="en_US.UTF8"
LC_NUMERIC="en_US.UTF8"
LC_TIME="en_US.UTF8"
LC_COLLATE="en_US.UTF8"
LC_MONETARY="en_US.UTF8"
LC_MESSAGES="en_US.UTF8"
LC_PAPER="en_US.UTF8"
LC_NAME="en_US.UTF8"
LC_ADDRESS="en_US.UTF8"
LC_TELEPHONE="en_US.UTF8"
LC_MEASUREMENT="en_US.UTF8"
LC_IDENTIFICATION="en_US.UTF8"
LC_ALL=

14:12 2013-04-01
software skill, SCM, git, am: apply patch
1, bamvor@localhost:libvirt> git am 0004-add-alloc-and-free-function-for-virConsole.patch
previous rebase directory /home/bamvor/work_home/source/virtualization/libvirt/.git/rebase-apply still exists but mbox given.
2, this is because the previous git am is paused:
bamvor@localhost:libvirt> git am 0002-fix-comile-fail.patch
正应用：fix comile fail
error: patch failed: src/libxl/libxl_conf.h:36
error: src/libxl/libxl_conf.h: patch does not apply
Patch failed at 0001 fix comile fail
When you have resolved this problem run "git am --resolved".
If you would prefer to skip this patch, instead run "git am --skip".
To restore the original branch and stop patching run "git am --abort".
because i already patch and commit manaully, i should run "git am --skip" to give previous patch.
then git am will ok.

18:01 2013-04-01
suse, virtualization, libvirt, qemu, xen, libxlDomainOpenConsole, base on xen4.3, cont1
1, "/local/domain/11/serial/0/tty" is missing.
check the xenconsole code. the code is never changed.
meanwhile if i create vm with xl, it is ok.
1), in xl cfg:
serial="pty"
2), in libvirt cfg:
<serial type='pty'>
  <source path='/dev/pts/2'/>
  <target port='0'/>
</serial>
<console type='pty'>
  <source path='/dev/pts/3'/>
  <target port='0'/>
</console>
2, check how the cfg is passed to xenstore.
3, ref: qemu-dm command line:
/usr/lib/xen/bin/qemu-dm -d 3 -domain-name bjz_04_sles11_sp2 -vnc 127.0.0.1:0 -vncunused -serial pty -videoram 8 -boot c -acpi -vcpus 4 -vcpu_avail 0x01 -net none -M xenfv

12:13 2013-4-2
suse, hackweek 9
1, yifan
openNI api. 体感设备通用api.
2, bin wei LIU.
3, fei xiang ZHANG.
4, calen
1), HA automation in Hamsta.
5, jia YAO
selenium: 模拟交互测试，浏览器。
6, Han zhibin, Hao Junwei.
VirtOnline.
7, David liang
Gtg on Android. Gtg: get thing Gnome.
8, Lance Wang
a parted shell in lua.
9, Chunyan LIU
1), storage motion.
10, Shawn
web security: webgoat.
11, Forrest Kong
智能小车。
xbox. 无线手柄：linux userspace tools.

23:36 2013-04-02
suse, virtualization, libvirt, qemu, xen, libxlDomainOpenConsole, base on xen4.3, cont2
1, libxl_dm.c, libxl__build_device_model_args_new()
add serial to qemu-dm command-line.
        if (b_info->u.hvm.serial) {
            flexarray_vappend(dm_args, "-serial", b_info->u.hvm.serial, NULL);
        }
2, user should set hvm.serial in domain build info.
in xl_cmdimpl.c, parse_config_data():
        xlu_cfg_replace_string (config, "serial", &b_info->u.hvm.serial, 0);

3, but in libxlMakeDomBuildInfo, hvm.serial is not set.
本来这个东西是在libxl_device_model_info保存, 并且在libxlMakeDeviceModelInfo由libvirt def设置到这里.
但是xen4.2去掉了libxl_device_model_info, 原有功能都并入libxl_domain_build_info, 并在libvirt中用libxlMakeDomBuildInfo处理.
所以现在需要在后者加入写入hvm.serial的代码.
4, (13:48 2013-04-03)
struct _virDomainDef {
...
    size_t nserials;
    virDomainChrDefPtr *serials;

    size_t nparallels;
    virDomainChrDefPtr *parallels;

    size_t nchannels;
    virDomainChrDefPtr *channels;

    size_t nconsoles;
    virDomainChrDefPtr *consoles;
...

def->serials->source.type

08:02 2013-04-03
sync
1, Jiaju attend.
2, Boyang: virt-io bug.

12:50 2013-04-03
suse, hackweek 9, opensuse on ARM
1, https://github.com/SUSE/hackweek/wiki/Geeko-Pumping-Iron-%28ARM%29-Session
1), Description
Now that openSUSE 12.3 is out, the openSUSE ARM Team want to step up a gear. As the cycle was shorter than normal, there are a few wrinkles that need to be ironed out and also a whole heap of new things that can be added. After some discussion at FOSDEM, it was decided to hold a Hackathon to address these items. The Hackathon will take place on 08 to 12 April, both at the SUSE offices in Nuremberg as well as online for those that can't attend in person.

We have a long TODO list:

    AArch64 fixes for 12.3 & Factory
    Build openSUSE 12.3 for Raspberry Pi
    Resolve outstanding 12.3 ARM Image issues
    Release 12.3 images
    Create OpenStack images for ARM
    Setup KVM capable hardware as workers for external build service
    Build OBS Worker image for armv7l
    Setup emulator hardware for AArch64
    Get Xen on Chromebook & Arndale running
    Tune OBS for more optimized ARM builds

There will also be the opportunity for new device bring up for those that want to, but our intention is to work through and complete as much of the above TODO list as possible first. For those interested in joining in the fun, please either join us in Nuremberg and/or join the opensuse-arm mailing list, the #opensuse-arm IRC channel on Freenode and also keep an eye on the openSUSE on ARM Trello board. If you have any questions please let us know on the mailing list or on IRC.
2), People
Andrew Wafaa originated this idea.
Alexander Graf
Dirk Müller
Marcus Schäfer

2, \TODO: how to join in trello? 
https://trello.com/board/opensuse-on-arm/5007cfc12cf0ae352e21d8dc


01:28 2013-4-3
company, virtualization, suse, xen, regular meeting: US / China Virtualization Sync, meeting, prepare notes
1, console patch. hvm fail because of xen4.2 changes.
2. will send to chunyan for review.

10:17 2013-04-07
software skill, SCM, git
Your name and email address were configured automatically based
on your username and hostname. Please check that they are accurate.
You can suppress this message by setting them explicitly:

    git config --global user.name "Your Name"
    git config --global user.email you@example.com

After doing this, you may fix the identity used for this commit with:

    git commit --amend --reset-author

10:26 2013-04-07
GTD
0, 9:40-11:30 12:52-13:44 14:44-18:03

1, today
1), 10:27- work report. 4weeks. see"18:01 2013-03-22"
2), 12:56-13:35 14:45-18:03  work in libxl console patch. "13:35 2013-04-07"
nap 30'
discuss with Lance about mobile and pad. 30'

13:35 2013-04-07
suse, virtualization, libvirt, qemu, xen, libxlDomainOpenConsole, base on xen4.3, cont3, send console patch to Chunyan for review
1, test patch pass.
commit时用了"-a", 结果不需要的修改push到github了.
2, 整理patch and send it to Chunyan for review.
1), when did libxlMakeChrdevStr add in libvirt?
it was 2b84e445 by Jim on 10, Feb 2011: Add libxenlight driver
2), is it covery all the souce.type in libxlMakeChrdevStr?
i could ref how qemu works. because in libxl hvm, it will pass to qemu-dm.
ref: qemuBuildChrArgStr and qemuBuildChrChardevStr.
VIR_DOMAIN_CHR_TYPE_UDP, VIR_DOMAIN_CHR_TYPE_TCP, VIR_DOMAIN_CHR_TYPE_UNIX.
but VIR_DOMAIN_CHR_TYPE_SPICEVMC only exist in qemuBuildChrChardevStr.
(1), check qemu mannual(qemu-dm and qemu upstream), spicevmc only support in -chardev parameter in qemu upstream not in qemu-dm:
http://qemu.weilnetz.de/qemu-doc.html
-chardev spicevmc ,id=id ,debug=debug, name=name
    spicevmc is only available when spice support is built in.
    debug debug level for spicevmc
    name name of spice channel to connect to
    Connect to a spice virtual machine channel, such as vdiport. 
So, will xen using qemu xen?

(2), in qemu-dm, libxl__build_device_model_args_new for qemu xen, libxl__build_device_model_args_old for qemu old

domcreate_bootloader_done->domcreate_rebuild_done->domcreate_launch_dm->libxl__spawn_stub_dm/libxl__spawn_local_dm->libxl__domain_device_model
                                  ->libxl__build_device_model_args

libxl__domain_device_model: will determine whether use qemu-dm or qemu-system-i386
libxl__domain_build_info_setdefault: set qemu-dm in hvm and set qemu upstream in pv. but will fall back to qemu-dm when qemu-xen was not found.

if i want to enable spicevmc in libvirt libxl console, i need to modify the libxl_domain_build_info struct and libxl__build_device_model_args_new, maybe it had better do it in the dedicated patch? \TODO: write this in the email review.

(3), summary: 
add VIR_DOMAIN_CHR_TYPE_UDP, VIR_DOMAIN_CHR_TYPE_TCP, VIR_DOMAIN_CHR_TYPE_UNIX in libxlMakeChrdevStr, reference qemuBuildChrArgStr.
add VIR_DOMAIN_CHR_TYPE_SPICEVMC in another patch in future.

3, summary for where libxl handle the serial
1), libxl_qmp.c: store_serial_port_info
write hvm serial device(chardev) to xenstore path/to/domain/serial/port/tty

13:37 2013-04-07
software skill, SCM, git, push
1, push all local branch to remote(even if such branch do not exist on remote):
> git push --all 
> git push --all github
2, push one local branch to remote
> git push github libxl_api_console_xen43_review
Counting objects: 957, done.
Delta compression using up to 8 threads.
Compressing objects: 100% (207/207), done.
Writing objects: 100% (757/757), 119.02 KiB, done.
Total 757 (delta 660), reused 644 (delta 550)
To git@github.com:bjzhang/libvirt.git
 * [new branch]      libxl_api_console_xen43_review -> libxl_api_console_xen43_review
3, git push fail:
bamvor@linux-bjrd:libvirt> git push github                                      
Counting objects: 169, done.                                                    
Delta compression using up to 8 threads.                                        
Compressing objects: 100% (49/49), done.                                        
Writing objects: 100% (49/49), 41.27 KiB, done.                                 
Total 49 (delta 46), reused 0 (delta 0)                                         
To git@github.com:bjzhang/libvirt.git                                           
   f0ac5b9..4327bf4  libxl_api_console_xen42 -> libxl_api_console_xen42         
   292a1528..665a5c6 libxl_api_console_xen43 -> libxl_api_console_xen43         
 ! [rejected]        master -> master (non-fast-forward)                        
error: failed to push some refs to 'git@github.com:bjzhang/libvirt.git'         
hint: Updates were rejected because a pushed branch tip is behind its remote    
hint: counterpart. If you did not intend to push that branch, you may want to   
hint: specify branches to push or set the 'push.default' configuration          
hint: variable to 'current' or 'upstream' to push only the current branch.  

原因很清楚, 但是我为了简单, 不希望每次都push master, 于是打算删除github上的master:
git checkout another_branch
git branch -D master
git push github :master

16:59 2013-04-07
software skill, editor, vim, vertical split, vsplit

17:46 2013-04-07
hackweek
1, hi,
i was interested in "Get Xen on Chromebook & Arndale running". and i buy Arndale from vendor(howchip) in the early of March. But now, they said that my board will ship within two weeks, definitely after hackweek...
meanwhile, i want to try to add opensuse support for cubieboard(based on Allwinner A10 SOC). Allwinner A10 has good support on kernel 3.0, i am not sure whether i could run opensuse 12.3 on kenel 3.0, if not i need to update the kernel then learn how to use kiwi generate the image.

15:13 2013-04-08
GTD
0, 14:00

1, today
1), opensuse12.3 on cubieboard. see"15:14 2013-04-08"

15:14 2013-04-08
suse, opensuse, opensuse12.3 on cubieboard
1, plan
1), try opensuse12.3 + kernel 3.0 on cubieboard.
2), if successful, packaging all the package and build it on obs.
2, (13:18 2013-04-09)
plan: compile X11 driver
3, fb device missing. 
ref: http://linux-sunxi.org/Framebuffer
compile hdmi into kernel:
CONFIG_FB_SUNXI=y
CONFIG_FB_SUNXI_LCD=y
CONFIG_FB_SUNXI_HDMI=y

CONFIG_FRAMEBUFFER_CONSOLE=y
CONFIG_FONT_8x8=y
CONFIG_FONT_8x16=y

opensuse 12.3 xfce start successful.
4, write u-boot to sd card
dd if=spl/sunxi-spl.bin of=/dev/sdd bs=1024 seek=8
dd if=u-boot.bin of=/dev/sdd bs=1024 seek=32
5, if i add console=tty0 and disp.screen0_output_mode=EDID, framebuffer console will worked. the full bootargs is:
console=ttyS0,115200 console=tty0 root=/dev/mmcblk0p2 init=/init loglevel=8 rootfstype=ext4 rootwait disp.screen0_output_mode=EDID  
6, other ref:
http://linux-sunxi.org/Binary_drivers#Mali_kernel_driver
http://linux-sunxi.org/Mali400
7, issue:
1), could not install package because could not connect to host at opensuse.cs.utah.edu:80
\TODO: bamvor: i could direct add mirror instead automatic select by opensuse.org
2), no webbrower(firefox) installed.
3), yast do not recognize the eth0 by automatically. report a bug?
8, plan
1), compile kernel and u-boot on obs and try kiwi.

16:02 2013-04-08
software skill, disk, delete useless device mapper device: loop device
0, status
linux-bjrd:/home/bamvor/work_bak/arm/Allwinner/source/a10-tools # ll /dev/mapper/loop1p1
lrwxrwxrwx 1 root root 7 Apr  8 15:56 /dev/mapper/loop1p1 -> ../dm-0
1, losetup fail:
linux-bjrd:/home/bamvor/work_bak/arm/Allwinner/source/a10-tools # losetup -d /dev/mapper/loop1p1 -v
loop: can't delete device /dev/mapper/loop1p1: No such device or address
2, delete by dmsetup(device mapper setup):
linux-bjrd:/home/bamvor/work_bak/arm/Allwinner/source/a10-tools # dmsetup table
loop1p1: 0 32768 linear 7:1 2048
linux-bjrd:/home/bamvor/work_bak/arm/Allwinner/source/a10-tools # dmsetup ls
loop1p1 (253, 0)
linux-bjrd:/home/bamvor/work_bak/arm/Allwinner/source/a10-tools # dmsetup remove loop1p1

17:28 2013-04-08
hackweek
1, run opensuse12.3 XFCE rootfs version successful on cubieboard.
compile X11 driver.

13:13 2013-04-09
mailing list, virtualization, xen, libvirt, libvirt libxl driver support
"Stefano Stabellini <stefano.stabellini@eu.citrix.com>"_email_"Re: [Xen-devel] OT: xen libvirt issue"_20130409_0122
> > Looking at the patch i totally agree that it isn't trivial...
> >   
> 
> It will certainly help, but I've heard reports there are still problems
> even with that patch.  IIRC, Bamvor has seen a similar segfault using
> git master of libvirt and xen-unstable, although it is a bit harder to
> trigger.
 
Do you have a link to a bug report somewhere?


> I think we need to rework the code for handling shutdown events.  The
> current code worked with libxl in Xen 4.1, but has proven to be racy
> with libxl in Xen 4.2.  I plan to work on this, but unfortunately not
> for a few weeks.  I'm busy with another project this week and will be
> traveling the week of April 15.

I realize that it actually takes time but it would be great if you could
write down in a bit more details the proposed fix, in case somebody else
volunteers to fix the issue in the meantime.


> > i'll hold off for now. and will work more towards libvirt integration for 
> > Mageia 4 (our release freeze is now in effect for Mageia 3).
> >   
> 
> FYI, although it is deprecated, the xm/xend toolstack works well with
> Xen 4.2, and the legacy libvirt xen driver is quite stable.  It was the
> first hypervisor driver in libvirt  :).

The problem is that xend doesn't support upstream QEMU as a disk
backend, and the status of blktap in most distros is pretty poor.

13:16 2013-04-09
mailing list, virtualization, xen, libvirt
""Ralf Dannert" <rdannert@suse.com>"_email_"Re: [virtualization-xen] supported software for SUSE's Xen backup"_20130408_1853
Hi Sebastián,

you should have a look at:
http://wiki.sepsoftware.com/wiki/index.php/Online_backup_of_virtual_XEN_machines
http://www.sep.de/products/virtual-machine-backup/xen/


SEP is an ISV (SEP sesam was the first 3rd party software certified on SUSE in 1997)
SEP sesam is an automatic data backup system for heterogenous network environments.

 System Requirements:

    A working XEN environment on LVM (Logical Volume Manager)
    An installed SEP sesam client on the XEN host system
    The XEN host systems must be added as a client to the SEP sesam server 


hth,
Ralf



>>> On 4/8/2013 at 11:16 AM, in message
<5162A71D0200008C0008A87F@nat28.tlf.novell.com>, "Sebastian Martinez"
<smartinez@suse.com> wrote: 

> Hi all, 
> 
> I am working in a Xen project and I would like to know if any of you knows a 
> backup solution for SUSE's Xen, that could
> run on the host ( without agents in the VMs ). Xen VMs are going to be 
> created in CLVM "raw" disks. 
> 
> Best regards, 
> Sebastián Martínez
> Business Development Manager
> C/José Echegaray 8 Edif. III, 1ª, oficina 5 y 6.  
> 28232. Las Rozas. Spain.
> +34 652 86 19 49
> smartinez@suse.com
> SUSE

13:18 2013-04-09
GTD
0, 12:40-20:49

1, today
1), 6h opensuse12.3 on cubieboard. see"15:14 2013-04-08"2

16:20 2013-04-10
GTD
0, 11:40-18:12

1, today
1), 16:22-18:10 opensuse12.3 on cubieboard. see"16:21 2013-04-10".

16:21 2013-04-10
suse, opensuse, opensuse12.3 on cubieboard, cont1
1, build u-boot and kernel on obs for both opensuse 12.2 and opensuse 12.3
2, create uboot package
1), input the following command and input package info then save and exit.
> osc meta pkg -e home:bjzhang:sun4i uboot-sun4i
Sending meta data...                                                            
Done.
2), checkout
> osc co home:bjzhang:sun4i uboot-sun4i
A    home:bjzhang:sun4i
A    home:bjzhang:sun4i/uboot-sun4i
At revision None.
3, create subproject: devel:ARM:12.3:Contrib:sun4i, ref"19:54 2012-12-29"
1), create subproject on obs website.
(1), modify prj meta ref "devel:ARM:12.3:Contrib:IMX53":
suse@prodclientoct99:~/work_bak/arm/arm_linux/opensuse/build_service/devel:ARM:12.3:Contrib:IMX53> osc meta prj
<project name="devel:ARM:12.3:Contrib:IMX53">
  <title>openSUSE 12.3 for Freescale i.MX53 based devices</title>
  <description>There seem to be less i.MX53 devices than i.MX51 devices out there. Unfortunately, we can't push everything into openSUSE proper, so this repo keeps all the bits that we need to allow i.MX53 devices to run openSUSE easily.&#13;
</description>
  <person userid="algraf" role="maintainer"/>
  <person userid="algraf" role="bugowner"/>
  <build>
    <enable/>
  </build>
  <debuginfo>
    <enable/>
  </debuginfo>
  <repository name="standard">
    <path project="devel:ARM:12.3:Contrib" repository="ports"/>
    <arch>armv7l</arch>
  </repository>
  <repository name="images">
    <path project="devel:ARM:12.3:Contrib:IMX53" repository="standard"/>
    <arch>armv7l</arch>
    <arch>local</arch>
  </repository>
</project>

mine:
<project name="home:bjzhang:devel:ARM:12.3:Contrib:sun4i" kind="maintenance">
  <title>opensuse for Allwinner A10 SOC</title>
  <description></description>
  <person userid="bjzhang" role="maintainer"/>
  <person userid="bjzhang" role="bugowner"/>
  <build>
    <enable/>
  </build>
  <debuginfo>
    <enable/>
  </debuginfo>
  <repository name="standard">
    <path project="devel:ARM:12.3:Contrib" repository="ports"/>
    <arch>armv7l</arch>
  </repository>
  <repository name="images">
    <path project="home:bjzhang:devel:ARM:12.3:Contrib:sun4i" repository="standard"/>
    <arch>armv7l</arch>
    <arch>local</arch>
  </repository>
</project>
(2), modify prjconf ref: devel:ARM:12.3:Contrib:Cubox
%if "%_repository" == "images"
Type: kiwi
Repotype: staticlinks
Patterntype: none
%endif
2), create kernel-sun4i
bjzhang@macintyre:~/opensuse_arm/home:bjzhang:devel:ARM:12.3:Contrib:sun4i> osc mkpac kernel-sun4i
A    kernel-sun4i 
bjzhang@macintyre:~/opensuse_arm/home:bjzhang:devel:ARM:12.3:Contrib:sun4i> cd kernel-sun4i/                                                                    
bjzhang@macintyre:~/opensuse_arm/home:bjzhang:devel:ARM:12.3:Contrib:sun4i/kernel-sun4i> ls                                                                     
bjzhang@macintyre:~/opensuse_arm/home:bjzhang:devel:ARM:12.3:Contrib:sun4i/kernel-sun4i> osc commit -m "create package kernel-sun4i"
Sending meta data...
Done.
Sending    kernel-sun4i
nothing to do for package kernel-sun4i
bjzhang@macintyre:~/opensuse_arm/home:bjzhang:devel:ARM:12.3:Contrib:sun4i/kernel-sun4i> osc meta pkg
<package name="kernel-sun4i" project="home:bjzhang:devel:ARM:12.3:Contrib:sun4i">
  <title></title>
  <description></description>
</package>
3), create uboot-sun4i
(1), compile command:
make cubieboard_config 
make all -j4
(2), build u-boot fail
[  139s] ... running 04-check-filelist
[  139s] ... checking filelist
[  139s] uboot-sun4i-3.0.52-1.1.armv7hl.rpm: directories not owned by a package:
[  139s]  - /spl
ref: "12:15 2013-04-11"1-2)

12:15 2013-04-11
suse, opensuse, opensuse12.3 on cubieboard, cont2
1, fix build error.
1), 
[ 1841s] Checking for unpackaged file(s): /usr/lib/rpm/check-files /home/abuild/rpmbuild/BUILDROOT/kernel-sun4i-3.0.52-1.1.arm
[ 1842s] error: Installed (but unpackaged) file(s) found:
[ 1842s]    /lib/firmware/kaweth/new_code.bin
[ 1842s]    /lib/firmware/kaweth/new_code_fix.bin
[ 1842s]    /lib/firmware/kaweth/trigger_code.bin
[ 1842s]    /lib/firmware/kaweth/trigger_code_fix.bin
add kaweth directory in %files:
/lib/firmware/kaweth/*
2), 
[ 4181s] ... running 04-check-filelist
[ 4183s] ... checking filelist
[ 4183s] kernel-sun4i-3.0.52-2.1.armv7hl.rpm: directories not owned by a package:
[ 4183s]  - /lib/firmware/kaweth
modify in %files:
+%dir /lib/firmware/
+%dir /lib/firmware/kaweth/
 /lib/firmware/kaweth/*

notes: uboot get the similar error.
3), uboot
[  719s] Executing(%install): /bin/sh -e /var/tmp/rpm-tmp.z2XjwD                
[  719s] + umask 022                                                            
[  719s] + cd /home/abuild/rpmbuild/BUILD                                       
[  719s] + cd u-boot-sunxi                                                      
[  719s] + install -m644 spl/sunxi-spl.bin /home/abuild/rpmbuild/BUILDROOT/uboot-sun4i-3.0.52-6.1.arm/boot/
[  726s] install: target '/home/abuild/rpmbuild/BUILDROOT/uboot-sun4i-3.0.52-6.1.arm/boot/' is not a directory: No such file or directory
[  726s] error: Bad exit status from /var/tmp/rpm-tmp.z2XjwD (%install)

Index: uboot-sun4i.spec
===================================================================
--- uboot-sun4i.spec    (revision 6)
+++ uboot-sun4i.spec    (working copy)
@@ -38,6 +38,7 @@
 make all -j4

 %install
+mkdir -p $RPM_BUILD_ROOT/boot/
 install -m644 spl/sunxi-spl.bin $RPM_BUILD_ROOT/boot/
 install -m644 u-boot.bin $RPM_BUILD_ROOT/boot/


2, kiwi
ref: openSUSE_for_ARM_on_your_device.pdf
1), copy from IMX53:
> osc copypac devel:ARM:12.3:Contrib:IMX53 JeOS-loco home:bjzhang:devel:ARM:12.3:Contrib:sun4i Jeos-cubieboard
Sending meta data...
Copying files...
<revision rev="1" vrev="1">
  <srcmd5>e5be612f30711f2604ff534d0792b57b</srcmd5>
  <version>unknown</version>
  <time>1365665896</time>
  <user>bjzhang</user>
  <comment>osc copypac from project:devel:ARM:12.3:Contrib:IMX53 package:JeOS-loco revision:11</comment>
  <requestid/>
</revision>
2), 
> osc co home:bjzhang:devel:ARM:12.3:Contrib:sun4i Jeos-cubieboard

3, modify script:
1), uboot-image-install: put spl and uboot to disk.
2), uboot-image-setup: generate boot.scr. 

4, local build
> osc build JeOS-cubieboard.kiwi images armv7l --clean
Building armv7l for JeOS-cubieboard.kiwi/images
Unknown build type: ''. Build description should end in .spec, .dsc or .kiwi.

5, email to opensuse-arm@opensuse.org
fail on generate kiwi image for cubieboard(Allwinner A10) for opensuse 12.3
hi, 

cubieboard is  Allwinner A10 based board, including 1GHz Cortex-A8 and Mali-400 GPU.
i am trying to build a kiwi image for Allwinner A10. i have already run opensuse 12.3 successful on kernel 3.0. the kernel and uboot is build on obs:
home:bjzhang:devel:ARM:12.3:Contrib:sun4i/kernel-sun4i
home:bjzhang:devel:ARM:12.3:Contrib:sun4i/uboot-sun4i

i reference "openSUSE for ARM on your device" slide and modify Image.kiwi.in then generate kiwi through "sh pre_checkin.sh". but i got lots of problems. i do not use kiwi before this, sorry for the noise:

1), when will uboot-setup.tgz used?
it seems that it only used when kernel update on opensuse arm?
So, i could just ignore it when build image at the beginning?

2), Jeos-cubieboard build successful, but xz image seems empty and tar.bz2 is generated. i could only see xz package on http://download.opensuse.org/ports/armv7hl/distribution/12.3/images/ except XFCE-rootfs.
do i miss something important in Jeos-cubieboard.kiwi?

3), build image on server is very slow, i want to build locally, but i failed on both x86_64 and arm.
(1), if i build on x64_64 on opensuse 12.3: 
XFCE-cubieboard> osc build XFCE-cubieboard.kiwi images armv7l --clean
Building armv7l for XFCE-cubieboard.kiwi/images
Unknown build type: ''. Build description should end in .spec, .dsc or .kiwi.
(2), if i build on arm on opensuse12.2, lots of package not found, e.g. gawk, patch.

4), i could not find my package on https://build.opensuse.org/project/show?project=home%3Abjzhang%3Adevel%3AARM%3A12.3%3AContrib%3Asun4i, but i could search and access the package on obs, why?

5), some name of my packages is not correct, but i do not know how to rename it, e.g. it had better rename uboot-sun4i to u-boot-sun4i and rename Jeos-cubieboard to JeOS-cubieboard. 

beside, i could not find firefox on my opensuse arm 12.3, do i missing something?

thanks in advance.

Bamvor

6, Dirk say kiwi should at the end of command.
osc build images armv7l XFCE-cubieboard.kiwi 

2:20 2013-4-12
hackweek, opensuse, arm, cubieboard, packaging, kiwi
1, kiwi
1), fail because without conv=notrunc.
2), todo: need load kernel from ext. test cmd and add it.
(09:14 2013-04-12)
#!/bin/bash

set -x

file=boot/boot.script

echo 'printenv kerneladdr || setenv kerneladdr ${kernel_addr_r}'   >> $file
echo 'setenv lk "ext2load mmc 0:2 ${kerneladdr} boot/uImage"'      >> $file
echo -n 'setenv bootcmd "'                                         >> $file
echo -n 'run lk; '                                                 >> $file
echo 'bootm ${kerneladdr}";'                                       >> $file

#==========================================
# Create machine readable uboot format
#------------------------------------------
mkopts="-A arm -O linux -a 0 -e 0 -T script -C none";
inputf="boot/boot.script";
result="boot/boot.scr";
if ! mkimage $mkopts -n 'Boot-Script' -d $inputf $result;then
        echo "Failed to create uboot script image"
        exit 1
fi

2, ref
kiwi
http://en.opensuse.org/SDB:KIWI_Cookbook_Data_Separation#Partitioning_vs._Data_separation_via_partitions
a10 boot process
http://rhombus-tech.net/allwinner_a10/a10_boot_process/
Editing AllWinner A10 Board Configuration Files (script.bin)
http://www.cnx-software.com/2012/05/06/editing-allwinner-a10-board-configuration-files-script-bin/
A10 Boot process and an UPDATED Uboot for the A10
http://forum.doozan.com/read.php?6,8481

11:08 2013-04-12
hackweek, opensuse 12.3 on cubieboard
prepare specific package for opensuse arm for my arm board.
how arm board boot up. what is the different between x86 and arm.
how to build a image through kiwi.

11:15 2013-04-12
GTD
0, 11:00

1, today
1), Yan SUN给我报销了150元开发板费用: cubieboard.

13:33 2013-04-12
1, try to load kernel from ext /boot partition
1), original env:
sun4i#printenv                   
baudrate=115200
boot_mmc=fatload mmc 0 0x48000000 uImage; bootm 0x48000000
bootargs=console=ttyS0,115200 root=/dev/mmcblk0p2 init=/init loglevel=8 rootfstype=ext4 rootwait
bootcmd=run load1 boot_mmc
bootdelay=3
console=ttyS0,115200
filesize=A4A0
init=/init
load=fatload mmc 0 43000000 sys_config1_evb_hdmi.bin
load1=fatload mmc 0 43000000 evb.bin
load2=fatload mmc 0 43000000 mele.bin
load3=fatload mmc 0 43000000 sys_config1.mele_mod.bin
loglevel=8
mmc_root=/dev/mmcblk0p2
setargs=setenv bootargs console=${console} root=${mmc_root} init=${init} loglevel=${loglevel}
stderr=serial
stdin=serial
stdout=serial
2), modify:
boot_mmc_e=ext2load mmc 0:2 0x48000000 /boot/uImage; bootm 0x48000000          
bootargs=console=ttyS0,115200 console=tty0 root=/dev/mmcblk0p2 init=/init loglevel=8 rootfstype=ext4 rootwait disp.screen0_output_mode=EDID                   
bootcmd=run loade boot_mmc_e                                                   
loade=ext2load mmc 0:2 43000000 /boot/evb.bin

14:32 2013-4-12
lance
1, embeded shell. 
结合shell和源语言的优势。
2. why?
脚本太多，不容易掌握，用通用语言。
3, how
lua: 功能强大。便于嵌入长字符串。

jerry:
hamsta: get dmc 信息。

22:38 2013-04-13
(19:46 2013-04-14)
introduce my image in Allwinner A10 community
1, Linux on small ARM machines <arm-netbook@lists.phcomp.co.uk>
Re: [Arm-netbook] Mele doing updates of the A1000 with A20 (Dual-Core) and A31 (Quad-Core)
>On Fri, Apr 12, 2013 at 3:52 PM, Albert ARIBAUD
><albert.u.boot@aribaud.net> wrote:
>> Hi Jean-Luc,
>>
>> On Fri, 12 Apr 2013 12:33:34 +0700, Jean-Luc Aufranc
>> <cnxsoft@cnx-software.com> wrote:
>>
>>> On Friday, April 12, 2013 12:30 AM, luke.leighton wrote:
>>> > well, a nice surprise: someone from mele contacted me, because they
>>> > were surprised i think by the large interest shown in the A1000, so
>>> > they'd like to build on that and so would like to offer engineering
>>> > types the opportunity to buy the A20-based and A31-based versions of
>>> > the same product.
>>> >
>>> > as with all these things the spec needs lots of clarification :)  the
>>> > A31 version definitely has SATA in the spec, i've a query outstanding
>>> > about the A20 version.  yes to the RJ45 on both.  yes to built-in
>>> > 802.11n WIFI on both.  yes to SD/MMC Card reader on both.  the A31
>>> > version has 2gb RAM and 8gb NAND, 3 USB2s and 1 USB-OTG, as well as an
>>> > SATA Dock.  the A20 version is listed as 1GB RAM, 4GB NAND and 1 USB2
>>> > - no mention of SATA yet.
>>> >
>>> > i'll try and push them on the SATA for the A20 version.
>>> >
>>> > so.
>>> >
>>> > question!
>>> >
>>> > please spread the word: who would be interested to buy early versions
>>> > of these as developer systems?
>>> >
>>> > l.
>>> >
>>> Let's try to "recruit" a few more people then:
>>> http://www.cnx-software.com/2013/04/12/mele-a1000g-quad-set-top-box-features-allwinner-a31-soc/
>>>
>>> It's about $140 on Aliexpress with shipping, hopefully, they can provide
>>> a discount to developers.
>>
>> Alright... Where do developers apply?
>
>numbers / declarations of interest at the moment (although as
>jean-luc's found the mele aliexpress link you could probably just
>order one!)
>
> i can use the numbers / declarations of interest to get better
>pricing for you from mele.
i am interested in it. i have mele A1000, MK802 and cubieboard and build
opensuse image from them, u could get the cubieboard image from
http://download.opensuse.org/repositories/home:/bjzhang:/devel:/ARM:/12.3:/Contrib:/sun4i/images
i test it on cubieboard, this should be work on mele A10 1G memory STB.
BTW, i am in China, will u have a "quick" link from taobao other than Aliexpress?
>l.

2, opensuse 12.3 with XFCE on cubieboard
1), cubieboard@googlegroups.com
hi, 

i built opensuse 12.3 with XFCE on cubieboard. u could get it from
http://download.opensuse.org/repositories/home:/bjzhang:/devel:/ARM:/12.3:/Contrib:/sun4i/images/openSUSE-12.3-ARM-XFCE-cubieboard.armv7l-1.12.1-Build38.1.raw.xz
and dd to sdcard(at least 8G sdcard) through:
unxz -d -c image.raw.xz | dd of=/path/to/sdcard

u could generate the specific image by branching: 
https://build.opensuse.org/package/show?package=XFCE-cubieboard&project=home%3Abjzhang%3Adevel%3AARM%3A12.3%3AContrib%3Asun4i

thanks.

Bamvor
2), reply
(1), Silverio Diquigiovanni <silverio.android@gmail.com> Apr 13 10:02AM -0700  
Unfortunately download link don't works ... "Object not found!"
(2), Scott Castaline <skotchman@gmail.com> Apr 13 11:19PM -0400  
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1
 
On 04/13/2013 01:02 PM, Silverio Diquigiovanni wrote:
> cubieboard+unsubscribe@googlegroups.com. Visit this group at
> http://groups.google.com/group/cubieboard?hl=en. For more options,
> visit https://groups.google.com/groups/opt_out.
 
Try this:
http://download.opensuse.org/repositories/home:/bjzhang:/devel:/ARM:/12.3:/Contrib:/sun4i/images/
I stepped through the directories myself until I found them and copied
the URL, hope this one works.
(3),
hi, 

sorry for inconvenience. i am update the image after i send this email. the image the name is openSUSE-12.3-ARM-XFCE-cubieboard.armv7l-1.12.1-BuildXX.X.raw.xz, while the version changes automatically. this is the rules defined by opensuse build service. i could not set a permanent name.
currently, the link is http://download.opensuse.org/repositories/home:/bjzhang:/devel:/ARM:/12.3:/Contrib:/sun4i/images/openSUSE-12.3-ARM-XFCE-cubieboard.armv7l-1.12.1-Build41.1.raw.xz
BTW, if u have any problem about common issues about opensuse arm, u could send it to opensuse-arm@opensuse.org

bamvor

3, reply to Matt Chen

>>> Matt Chen <machen@suse.com> 2013-3-22 上午 11:14 >>>
> Hi,
> 
> I just bought a cubieboard and found a image in
> https://www.miniand.com/forums/forums/development/topics/install-opensuse-12-2-with-xfce.
this image was created manually.
> This image is without enabling the LAN driver but is working fine to me.
> And I am wondering where I can find the source of the image ?
i put 12.3 XFCE image source at: home:bjzhang:devel:ARM:12.3:Contrib:sun4i XFCE-cubieboard, link[1].
> 
> Or is there any project in our obs for building the image for cubieboard ?
> 
> Thanks.

[1] https://build.opensuse.org/package/show?package=XFCE-cubieboard&project=home%3Abjzhang%3Adevel%3AARM%3A12.3%3AContrib%3Asun4i

19:41 2013-04-14
GTD
2, plan
1), try my console on PV and HVM.
2), opensuse 12.3 on cubieboard: check mali X11 driver on it. I guess, currently, no mali support, it should be affect the performance.  
3), work on libvirt libxl driver. ref"13:13 2013-04-09": Jim said that it is a shutdown issue.
disuss with Jim on Tuesday.

15:03 2013-4-14
mali 400 debian drivers
Siarhei Siamashka <siarhei.siamashka@gmail.com> Apr 13 01:06PM -0700
If you really want to use mali drivers for accelerating a small part of the video playback pipeline (just scaling to fullscreen), you can try mplayer:

$ wget http://www.mplayerhq.hu/MPlayer/releases/MPlayer-1.1.tar.xz $ tar -xJf MPlayer-1.1.tar.xz $ cd MPlayer-1.1 $ ./configure --extra-cflags="-mfpu=neon"

Now pay special attention to the output and make sure that you have the following two lines there:

Checking for ARM NEON ... yes Checking for OpenGL ... yes (backends: egl_x11 sdl)

16:26 2013-04-16
GTD
0, 11:30-18:13

1, today
1), 16:26- work report.
2), write a question for virtualization team sync. "17:35 2013-04-16".

16:28 2013-04-16
suse, sle12; opensuse arm status
1, "Andreas Jaeger <aj@suse.com>"_email_"[devel] Some SLE 12 Updates"_20130415_2015
The SLE 12 blog at http://sle12.nue.suse.com/ has been recently updated 
with these three blog posts:

SLE 12 Update
openSUSE and SLE 12 schedule
SLE 12 will focus on 64-bit architectures

Andreas
-- 
 Andreas Jaeger aj@{suse.com,opensuse.org} Twitter/Identica: jaegerandi
  SUSE LINUX Products GmbH, Maxfeldstr. 5, 90409 Nürnberg, Germany
   GF: Jeff Hawn,Jennifer Guild,Felix Imendörffer,HRB16746 (AG Nürnberg)
    GPG fingerprint = 93A3 365E CE47 B889 DF7F  FED1 389A 563C C272 A126
2, SLE 12 Update
http://sle12.nue.suse.com/2013/04/sle-12-update/
1), SLE2 Schedule
    2013-07-12 Feature Submission Deadline
    2013-09-30 Feature Feedback Deadline
    2014-01-06 Partner Code Drop Deadline
    2014-02-20 Beta1
    2014-09-xx First customer shipment
2), Planned interlocks in April
The virtual teams plan to bring the following topics to interlock in April:
    Enterprise Community Package Repository (contact: Scott Bahling)
    Xen vs KVM, hypervisors for SLE12 (contact: Michal Svec)
    Security: Common Criteria and FIPS Certifications (ELT decision) (contact: Matthias Eckermann and Thomas Biege)
    Desktop (contact: Jan Weber and Stefan Behlert)
3, SLE 12 will focus on 64-bit architectures
http://sle12.nue.suse.com/2013/04/sle-12-will-focus-on-64-bit-architectures/
Posted on April 15, 2013 by Andreas Jaeger
we will have at least three different architectures to support: Intel/AMD x86-64, IBM POWER and IBM System z.
We do not have any plans to support the 32-bit ARM architecture in SLE 12. The upcoming 64-bit ARM AArch64 architecture is another story. There is no hardware available yet and we discuss with partners under NDA what they are planning to do and whether we shall release an enterprise distribution for it. Note that the openSUSE community has both 32-bit and initial 64-bit ARM distributions done now.  For an Note that the end of Intel Itanium support is not publically announced and will not be announced for some more time!
4, openSUSE and SLE 12 schedule
http://sle12.nue.suse.com/2013/04/opensuse-and-sle-12-schedule/
Posted on April 11, 2013 by Andreas Jaeger
openSUSE 13.1 will be released in November 2013 and openSUSE 13.2 in July 2014. We’re currently considering when to branch SLE 12 off. There are two options:
    Base SLE 12 basically on openSUSE 13.1 but take some newer packages from Factory, for example sharing the kernel between openSUSE 13.2 and SLE 12.
    Branch SLE 12 from Factory after openSUSE 13.1 release but before openSUSE 13.2 beta.
5, ref: About ARMv7 progress and ARMing for AArch64 
https://news.opensuse.org/2013/04/15/about-armv7-progress-and-arming-for-aarch64-and/

17:32 2013-04-16
virtualization, xen, libxl, libvirt
1, from Xen Roadmap 4.3, i could see that the "xl QXL Spice support" is complete. and from qemu_driver.c in libvirt, it is simple to implement it in libvirt.
\TODO: check it next week.

17:35 2013-04-16
company, virtualization, suse, xen, regular meeting: US / China Virtualization Sync, meeting, question
1, i get from sle12.nue.suse.com that there is some planned interlocks in April: Xen vs KVM, hypervisors for SLE12 (contact: Michal Svec).
i am interested in how will these decided. is it decided now?
2, no sync after two weeks? 

17:53 2013-04-16
(14:17 2013-04-22)
1, work report - week 15, 16
1), hackweek
working on generate opensuse 12.3 image for cubieboard:
(1), build u-boot, kernel and board configuration and put them to obs.
(2), learn how to build image through kiwi. and eventually build JeOS and XFCE image successful.
BTW: it seems that cubieboard is very popular in this hackweek, me, Dirk Müller, Matt Chen all work on it.

2), working on fix bug on libvirt libxl driver.
this bug is reported by libvirt users in mailing list. it sometimes failed after save operation.
after some debug, it fail because pointer is not valid while the callback entered.
after modify the code, it test 24 round pass compare to fail within 3 rounds without this patch. 
thanks for Boyang and Chunyan's help.

3), 3 days off.

18:38 2013-04-16
(11:58 2013-04-17)
mailing list, virtualization, xen; about mini-os stack protector; 
1, mini-os not implement stack protector because in different system(linux, freebsd...), the stack protector of gcc is different.
cyliu@suse.com Re: [Xen-devel] pv-grub will cause page fault if build with flag -fstack-protector
1), Ian Compbell
If you can figure out a way to override this in stubdom/* regardless of the flags set by the user (or RPM) at the toplevel (e.g. by inserting -fno-stack-protector in the right place) then that might be a patch we could consider for upstream.

> I checked the objdump of problem pv-grub, the page fault place is in > xc_interface_open_common, the detail line is a line inserted by > -fstack-protector (see 0x404bb in following):

If you wanted to get really advanced you could implement stack protector support for mini-os. I've no idea how hard that would be though.

Ian.
2), Samuel Thibault
> I agree with Jan.

mini-os, which stubdoms are based on, explicitly tries to disable
stack-protector, see extras/mini-os/minios.mk

> > I checked the objdump of problem pv-grub, the page fault place is in
> > xc_interface_open_common, the detail line is a line inserted by
> > -fstack-protector (see 0x404bb in following):
> 
> If you wanted to get really advanced you could implement stack protector
> support for mini-os. I've no idea how hard that would be though.

Actually we can't really support it, because the code introduced by
gcc, which typically uses fs: or gs: adressing, is host-dependent, i.e.
depending on being built on linux, or on freebsd, etc. mini-os would
have to behave differently because the code introduced by gcc behaves
differently... The solution would be to use a separate host triplet, but
we ended up avoiding doing it due to the introduced complexity.
3), Ian Compbell
> The solution would be to use a separate host triplet, but
> we ended up avoiding doing it due to the introduced complexity.

Right. I've occasionally flirted with implementing the separate triplet
but it's a lot of pieces to get right (binutils etc etc).

Ian.
4), Samuel Thibault
> > Actually we can't really support it, because the code introduced by
> > gcc, [...] is host-dependent,
> 
> I didn't know about this. Does this not affect the hypervisor itself
> too?

Yes.

> I don't see any stack protector disabling going on there. Maybe I'm
> looking in the wrong places.

Probably:

./Config.mk:EMBEDDED_EXTRA_CFLAGS := -nopie -fno-stack-protector 
-fno-stack-protector-all
./xen/arch/x86/Rules.mk:$(call 
cc-options-add,CFLAGS,CC,$(EMBEDDED_EXTRA_CFLAGS))

> > The solution would be to use a separate host triplet, but
> > we ended up avoiding doing it due to the introduced complexity.
> 
> Right. I've occasionally flirted with implementing the separate triplet
> but it's a lot of pieces to get right (binutils etc etc).

Yes.  That was mostly why we dropped the support I had initially
written.

Samuel

2, Xen to Become Linux Foundation Collaborative Project
1),http://www.linuxfoundation.org/news-media/announcements/2013/04/xen-become-linux-foundation-collaborative-project 
(1), no suse? 
Amazon Web Services, AMD, Bromium, Calxeda, CA Technologies, Cisco, Citrix, Google, Intel, Oracle, Samsung and Verizon affirm commitment to the Xen Project, 
(2),In addition to providing the necessary framework to support the Xen Project community’s growth, The Linux Foundation also supports the KVM community by hosting KVM Forum and other activities that support the project. 
(3), Recent Xen Project highlights include: 
    The addition of Mirage OS, a library OS that supports the most common web protocols and enables the development of sealed Xen Project appliances that can be run without a guest operating system on any Xen Project based cloud - led by Cambridge University
    Support for ARMv7 and ARMv8 based servers - led by Citrix
    Improvements to Nested Virtualization - led by Intel
    Significant extensions to the Xen Project Security Modules and Flask - led by the National Security Agency
    A new virtualization mode called PVH, which promises to combine the best aspects of hardware virtualization and paravirtualization - led by Oracle
    Significant performance and scalability improvements - led by SUSE

2), simple version on lwn: 
http://lwn.net/Articles/547341/

12:19 2013-04-17
GTD
0, 11:30-18:22

1, today
1), work on libvirt libxl driver. ref"13:13 2013-04-09": Jim said that it is a shutdown issue. see"15:21 2013-04-17"

12:20 2013-04-17
mailing list, lwn.net, ARM kernel floating-point emulation code removed
https://lwn.net/Articles/546840/
1, Russell King
This I have done after it has been brought to my attention by the OSADL's
GPL-violations project that the license for the softfloat library is
incompatible with GPLv2.  This is because the FSF have ruled that
indemnification clauses consitute an "additional restriction" which is
incompatible with the GPLv2 section 6.  NWFPE contains the softfloat
library, and VFP's emulation code is a derivative of softfloat.

This will be very disruptive for ARMv4 and ARMv5 CPUs, which will no
longer be able to run userspace with NWFPE support removed.  A possible
solution there is to resurrect FASTFPE support and merge that into
mainline in place of NWFPE.  FASTFPE's hooks are all present in the
kernel, and it should just be a case of adding the FASTFPE code.
However, FASTFPE is probably lacking GDB and signal stack support.
(FastFPE's per-thread workspace is different from NWFPE.)

2, Posted Apr 10, 2013 21:35 UTC (Wed) by gb (subscriber, #58328) [Link]
I am familiar with debian-based things. Debian comes in 3 favor on arm: arm, armel, and armhf. Armhf is unaffected by any emulation stuff. Armel is eabi port with softfloat, not affected too. Read here: http://wiki.debian.org/ArmEabiPort.

Only affected thing as i understand is arm port in case your arm cpu does not support emulation. And arm port is deprecated long ago, you can see on debian popcon that there are 55 total arm machines reporting. n900 is not affected (armel) openmoko gta02 - armel, gta04 - armhf, who knows may be some ancient machines?

15:21 2013-04-17
virtualization, libvirt, xen, libxl, shutdown issue; software skill, debug, gdb, disassemble ""6
1, add debug info in libxlEventHookInfoFree, see who free the priv and does it lead to the segment fault.
今天在linux-vm5上测试(sles11_sp2_pv), 遇到create时没法注册设备的问题. 但是没有遇到之前的segfault问题.
/var/lib/xen/images_2/sles11_sp2_pv/sles11_sp2_pv.xml
难道是因为在libxlEventHookInfoFree设置断点, 影响了时序?
去掉断点试试. 似乎在linux-vm5难以复现. 
2, (17:05 2013-04-18)
1), test on linux-work(phy machine), fail on 3rd times: destroy sles11_sp2_pv.
while fail, the libxlEventHookInfoPtr is NULL.
i need to track where the info is freed.
2), virEventPollCleanupHandles will call libxlEventHookInfoFree when the eventLoop.handles[i].deleted is true.
this function will called twice: before virEventPollMakePollFDs and after virEventPollDispatchHandles. i believe that it is the latter one lead to the segfault.
3, check all the patch, which maybe lead to fd_deregister.
1), datacopier_check_state: deregister fd while "nothing buffered, but still reading"
2), datacopier_readable: deregister fd while read return value is 0.
is it the same fd(ev->fd) for which libvirt waiting?
i guess so. it is both poll a fd in the struct libxl__ev_fd.
So, if the poll is POLLIN in libxlFDEventCallback, maybe it is the point why fd event handler seqfault. continue to analysis it:
libvirt poll fd -> get it -> call datacopier_readable -> call fd_deregister if read return value is 0 -> call virEventRemoveHandle(mark delete in eventLoop) in fd_deregister -> datacopier_readable return, enter cleanup -> unref info->priv and free info.
So, it seems that no problem here, it is because of the patch from Jim in which only drop ref in cleanup function(virEventPollCleanupHandles).
3), in save operation: 
helper_failed, helper_done, libxl__srm_callout_callback_complete. 
4, it is hard to analysis for me. how about debug it?
if i know who mark delete and who free the info, and after this, segfault arised. i could be able to avoid it.
1), .gdbinit
set breakpoint pending on
set logging on

break libxlEventHookInfoFree
commands
silent
printf "libxlEventHookInfoFree: info<%p>, info->priv<%p>\n", info, info->priv
cont
end

break libxlFDDeregisterEventHook
commands
silent
printf "libxlFDDeregisterEventHook: info<%p>, info->id<%d>\n", (libxlEventHookInfoPtr)hnd, ((libxlEventHookInfoPtr)hnd)->id
where
cont
end

cont
2), lots of free, but no FDDeregister
libxlEventHookInfoFree: info<0x7f2b25cdc030>, info->priv<0x45475255505f4c4c>
Detaching after fork from child process 9476.
libxlEventHookInfoFree: info<0x7f2b25cdc030>, info->priv<0x45475255505f4c4c>
libxlEventHookInfoFree: info<0x7f2b25cdc030>, info->priv<0x45475255505f4c4c>
libxlEventHookInfoFree: info<0x7f2b25cdc030>, info->priv<0x45475255505f4c4c>
libxlEventHookInfoFree: info<0x7f2b25cdc030>, info->priv<0x45475255505f4c4c>
libxlEventHookInfoFree: info<0x7f2b25cdc030>, info->priv<0x45475255505f4c4c>
Detaching after fork from child process 9535.
Detaching after fork from child process 9551.
Detaching after fork from child process 9565.

Program received signal SIGSEGV, Segmentation fault.
0x00007f2b18beb760 in libxlFDEventCallback (watch=<optimized out>, fd=<optimized out>, vir_events=<optimized out>, fd_info=<optimized out>) at libxl/libxl_driver.c:170
3), i could not understand.
(1), what does watch mean?
watch is a increase number for counting how many times AddHandles calls.
when crash, the watch 156 do not exist in virEventPollCleanupHandles.
(2), trace watch in add handle and in libxlFDRegisterEventHook.
libxlFDRegisterEventHook
#0  libxlFDRegisterEventHook (priv=0x7fcef3a57120, fd=46, hndp=0x7fcedc002428, events=3, xl_priv=0x7fcedc002420) at libxl/libxl_driver.c:176
#1  0x00007fcee5aedb39 in libxl__ev_fd_register (gc=0x7fcef3a62620, ev=0x7fcef3a64908, func=0x7fcee5ae88e0 <helper_stdout_readable>, fd=46, events=3) at libxl_event.c:183
#2  0x00007fcee5ae85be in run_helper (egc=0x7fceec4ba4e0, shs=0x7fcef3a64890, mode_arg=0xa <Address 0xa out of bounds>, stream_fd=39, preserve_fds=0x0, num_preserve_fds=0, argnums=0x7fceec4ba3c0, num_argnums=10) at libxl_save_callout.c:224
#3  0x00007fcee5ae8cdb in libxl__xc_domain_restore (egc=0x7fceec4ba4e0, dcs=<optimized out>, hvm=<optimized out>, pae=<optimized out>, superpages=0, no_incr_generationid=1) at libxl_save_callout.c:74
#4  0x00007fcee5ad29e6 in domcreate_bootloader_done (egc=0x7fceec4ba4e0, bl=0x7fcef3a63f38, rc=<optimized out>) at libxl_create.c:744
#5  0x00007fcee5ad34b8 in initiate_domain_create (dcs=<optimized out>, egc=<optimized out>) at libxl_create.c:642
#6  do_domain_create (ctx=<optimized out>, d_config=<optimized out>, domid=0x7fceec4ba5f8, restore_fd=<optimized out>, ao_how=<optimized out>, aop_console_how=0x0) at libxl_create.c:1209
#7  0x00007fcee5ad3699 in libxl_domain_create_restore (ctx=0x7fcef3a57120, d_config=0x2e, domid=0x7fcedc002428, restore_fd=3, ao_how=0x7fcedc002420, aop_console_how=0x7fcee5f56d20) at libxl_create.c:1241
#8  0x00007fcee5d1f7b4 in libxlVmStart (driver=0x7fcef3a22010, vm=0x7fcef3a5cd40, start_paused=false, restore_fd=39) at libxl/libxl_driver.c:962
#9  0x00007fcee5d25479 in libxlDomainRestoreFlags (conn=0x7fcedc008f70, from=0x7fcef3a0aac0 "/home/bamvor/sda3/home/novell/log/novell/hypervisor_and_tools/libvirt/xen4.2_support/20130205/sles11_sp2_pv.save", dxml=0x0, flags=0) at libxl/libxl_driver.c:2279
#10 0x00007fcee5d25593 in libxlDomainRestore (conn=0x7fcedc008f70, from=0x7fcef3a0aac0 "/home/bamvor/sda3/home/novell/log/novell/hypervisor_and_tools/libvirt/xen4.2_support/20130205/sles11_sp2_pv.save") at libxl/libxl_driver.c:2298
#11 0x00007fcef2c939f3 in virDomainRestore (conn=0x7fcedc008f70, from=0x7fcef3a4d2c0 "/home/bamvor/sda3/home/novell/log/novell/hypervisor_and_tools/libvirt/xen4.2_support/20130205/sles11_sp2_pv.save") at libvirt.c:2768
#12 0x00007fcef375da66 in remoteDispatchDomainRestore (args=<optimized out>, rerr=<optimized out>, msg=<optimized out>, client=<optimized out>, server=<optimized out>) at remote_dispatch.h:4679
#13 remoteDispatchDomainRestoreHelper (server=<optimized out>, client=0x7fcef3a4cf20, msg=<optimized out>, rerr=0x7fceec4babf0, args=0x7fcef3a62360, ret=<optimized out>) at remote_dispatch.h:4661
#14 0x00007fcef2cda0fc in virNetServerProgramDispatchCall (msg=<optimized out>, client=<optimized out>, server=<optimized out>, prog=<optimized out>) at rpc/virnetserverprogram.c:439
#15 virNetServerProgramDispatch (prog=0x7fcef39f9a50, server=0x7fcef39f01f0, client=0x7fcef3a4cf20, msg=0x7fcef3a60f70) at rpc/virnetserverprogram.c:305
#16 0x00007fcef2cdfb7e in virNetServerProcessMsg (srv=<optimized out>, client=0x7fcef3a4cf20, prog=0x7fcef3a57870, msg=0x7fcef3a60f70) at rpc/virnetserver.c:162
#17 0x00007fcef2ce0823 in virNetServerHandleJob (jobOpaque=<optimized out>, opaque=0x7fcef39f01f0) at rpc/virnetserver.c:183
#18 0x00007fcef2bda556 in virThreadPoolWorker (opaque=<optimized out>) at util/virthreadpool.c:144
#19 0x00007fcef2bd9b47 in virThreadHelper (data=<optimized out>) at util/virthreadpthread.c:161
#20 0x00007fceef8387b6 in start_thread (arg=<optimized out>) at pthread_create.c:301
#21 0x00007fceef18d9cd in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:112
#22 0x0000000000000000 in ?? ()
virEventPollAddHandle: nextWatch<123>
#0  virEventPollAddHandle (fd=46, events=5, cb=0x7fcee5d20f6e <libxlFDEventCallback>, opaque=0x7fcef3a52900, ff=0x7fcee5d1e81a <libxlEventHookInfoFree>) at util/vireventpoll.c:106
#1  0x00007fcee5d20ef8 in libxlFDRegisterEventHook (priv=0x7fcef3a57120, fd=46, hndp=0x7fcedc002428, events=3, xl_priv=0x7fcedc002420) at libxl/libxl_driver.c:189
#2  0x00007fcee5aedb39 in libxl__ev_fd_register (gc=0x7fcef3a62620, ev=0x7fcef3a64908, func=0x7fcee5ae88e0 <helper_stdout_readable>, fd=46, events=10496) at libxl_event.c:183
#3  0x00007fcee5ae85be in run_helper (egc=0x7fceec4ba4e0, shs=0x7fcef3a64890, mode_arg=0xa <Address 0xa out of bounds>, stream_fd=39, preserve_fds=0x0, num_preserve_fds=0, argnums=0x7fceec4ba3c0, num_argnums=10) at libxl_save_callout.c:224

Program received signal SIGSEGV, Segmentation fault.
[Switching to Thread 0x7fcef36d57e0 (LWP 29732)]
0x00007fcee5d21009 in libxlFDEventCallback (watch=123, fd=46, vir_events=1, fd_info=0x7fcef3a52900) at libxl/libxl_driver.c:170
170	    libxl_osevent_occurred_fd(info->priv->ctx, info->xl_priv, fd, 0, events);

(3), the info will definitely alloc successful. So, i guess there is only one branch for fail: virEventAddHandle return value(info->id) less than zero.
why info->id less than zero? only one reasone in this function, VIR_RESIZE_N fail. 
after debug, i found that the info, info->priv is valid, but info->priv->lock is NULL.
info->priv is transfered from libxl. priv is libxlDomainObjPrivatePtr, allocated in libxlDomainObjPrivateAlloc, and freed in libxlDomainPrivateFree. 
So, is it the point? 
freed by virDomainObjDispose. So, it is freed when domain is destoryed.
add debug info when virDomainObjDispose call the free function(conf/domain_conf.c:1929)
the debug log do not support my guess. work on it tomorrow.
5, (14:56 2013-04-19)
曾经以为是virEventPollAddHandle加入时priv为NULL是异常, 后来发现priv本来就是在add handle之后加入的, 这个没有问题. 目前集中精力看看info->priv->lock为什么会为空.
debug发现, 在fd_register时就是空的. 
1), 正常来说lock是啥时候分配的?
2), Chunyan help:
和chunyan讨论, 感觉还是要看看lock是啥时候分配的.

6, Boyang help:
1), 首先还是怀疑是进入libxl_osevent_occurred_fd前后有问题. 
但是关于lock, bo指出, lock地址是有效的就没问题, lock的内容是0不一定是问题.
另外, 用gdb看进入该函数后的几个变量, 包括ctx和xl_priv, 都没有问题. 同时, 考虑到libxl_osevent_occurred_fd我加了断点打印, 没有打印说明根本没有进入这个函数.
所以还是要看进入函数这个"瞬间". 
2), 反汇编(disassemble):
the segfault position is before call libxl_osevent_osccurred_fd: "mov 0x38(%rax),%rd" 
   0x00007ff0e3886fe6 <libxlFDEventCallback+120>:	mov    -0x18(%rbp),%rax
   0x00007ff0e3886fea <libxlFDEventCallback+124>:	mov    0x8(%rax),%rdi
   0x00007ff0e3886fee <libxlFDEventCallback+128>:	callq  0x7ff0e387f578 <virObjectUnlock@plt>
   0x00007ff0e3886ff3 <libxlFDEventCallback+133>:	mov    -0xc(%rbp),%eax
   0x00007ff0e3886ff6 <libxlFDEventCallback+136>:	movswl %ax,%ecx
   0x00007ff0e3886ff9 <libxlFDEventCallback+139>:	mov    -0x18(%rbp),%rax
   0x00007ff0e3886ffd <libxlFDEventCallback+143>:	mov    0x10(%rax),%rsi
   0x00007ff0e3887001 <libxlFDEventCallback+147>:	mov    -0x18(%rbp),%rax
   0x00007ff0e3887005 <libxlFDEventCallback+151>:	mov    0x8(%rax),%rax
=> 0x00007ff0e3887009 <libxlFDEventCallback+155>:	mov    0x38(%rax),%rdi
   0x00007ff0e388700d <libxlFDEventCallback+159>:	mov    -0x28(%rbp),%edx
   0x00007ff0e3887010 <libxlFDEventCallback+162>:	mov    %ecx,%r8d
   0x00007ff0e3887013 <libxlFDEventCallback+165>:	mov    $0x0,%ecx
   0x00007ff0e3887018 <libxlFDEventCallback+170>:	callq  0x7ff0e387ff08 <libxl_osevent_occurred_fd@plt>
(1), info register: rax is 0x0.
So, the move will fail. but why?
(2), check the code while calling virObjectUnlock, we could get that rpb - 0x18 is info, and rax + 0x8 is priv. note that the pointer is 8bytes in 64bit.
/* Object used to store info related to libxl event registrations */
struct _libxlEventHookInfo {
    libxlEventHookInfoPtr next;
    libxlDomainObjPrivatePtr priv;
    void *xl_priv;
    int id;
};
So, rax + 0x38 is ctx. but right now rax is zero.
\TODO: how to get struct offset in GDB.
3), why?
两个人讨论了一下, 因为priv是整个domain全局的. 而info是每次注册fd时alloc的.
如果有线程在我正要进入libxl_osevent_occurred_fd时free priv. 就会把瞬间的info->priv赋值为0. 
后来我再看code, free这个事情肯定没有, 但是注册时是先注册handle在给priv, xl_priv赋值. 而且没有锁的保护. 最早Jim是先赋值后注册的, 不知道为什么二月份改了, 目前我的patch: 
From aa525a3aaf2648f7358cca049a87ea18a285ef9a Mon Sep 17 00:00:00 2001
From: Bamvor Jian Zhang <bjzhang@suse.com>
Date: Fri, 19 Apr 2013 19:28:36 +0800
Subject: [PATCH] try to fix segfault during virsh save

move assign before virEventAddHandle. i do not know why jim move it in e0622ca2.
---
 src/libxl/libxl_driver.c | 14 ++++++++------
 1 file changed, 8 insertions(+), 6 deletions(-)

diff --git a/src/libxl/libxl_driver.c b/src/libxl/libxl_driver.c
index 9980b38..96cd2c0 100644
--- a/src/libxl/libxl_driver.c
+++ b/src/libxl/libxl_driver.c
@@ -186,12 +186,6 @@ libxlFDRegisterEventHook(void *priv, int fd, void **hndp,
         vir_events |= VIR_EVENT_HANDLE_READABLE;
     if (events & POLLOUT)
         vir_events |= VIR_EVENT_HANDLE_WRITABLE;
-    info->id = virEventAddHandle(fd, vir_events, libxlFDEventCallback,
-                                 info, libxlEventHookInfoFree);
-    if (info->id < 0) {
-        VIR_FREE(info);
-        return -1;
-    }
 
     info->priv = priv;
     /*
@@ -204,6 +198,14 @@ libxlFDRegisterEventHook(void *priv, int fd, void **hndp,
     info->xl_priv = xl_priv;
     *hndp = info;
 
+    info->id = virEventAddHandle(fd, vir_events, libxlFDEventCallback,
+                                 info, libxlEventHookInfoFree);
+    if (info->id < 0) {
+        virObjectUnref(info->priv);
+        VIR_FREE(info);
+        return -1;
+    }
+
     return 0;
 }
 
-- 
1.7.12
4), 加入patch后测试, 之前是测试三轮会挂. 现在是测试5轮通过.

6, gdb commands summary
thread apply all bt: print all backtrace in each thread.
disassemable start,+len: disassembly from start to start+len.


15:27 2013-04-17
software skill, rpm, search
# search the package name containing xen.
rpm -qa |grep xen

16:45 2013-04-17
"Alan Gao"_email_"新闻稿: SUSE正式加入中国开源云联盟"
引全球开源之云 助中国产业前行 - SUSE正式加入中国开源云联盟

2013年4月18日，北京 近日， 全球企业级开源软件行业先锋SUSE公司正式宣布加入中国开源云联盟，成为其核心成员。作为OpenStack重要成员的SUSE，在加入中国开源云联盟后，将与核心成员英特尔、联想、中兴通讯股份有限公司、新浪网、中标软件、上海交通大学、爱奇艺、华胜天成等共同致力于整合企业用户对云计算基础架构平台的需求，基于OpenStack开源框架协同研发，推动中国云计算产业发展，打造易于部署、功能丰富且易于扩展的云计算平台。

作为OpenStack社区项目的白金会员，长久以来SUSE积极投身于相关产品的研发，并在去年推出了SUSE Cloud，首个基于OpenStack架构的自动化的云管理平台，帮助企业客户快速轻松地构建私有云基础设施。同时，SUSE在中国还扮演着桥梁的角色，把国外先进的架构和技术，与中国国内的需求相结合，使之能够适合中国的发展。此次，SUSE正式加入中国开源云联盟，必将更好的帮助整合中国的OpenStack开发资源，深入参与OpenStack社区项目开发，传播开源价值与文化，加大中国开发者和公司在国际OpenStack社区中的贡献力量，更好地为中国客户提供基于云架构的解决方案。

SUSE不仅是一家领先的企业Linux和云计算解决方案提供商，同时也是多个开源社区的领导者和支持者。 英特尔中国首席开源科学家、中国开源云联盟主席冯晓焰先生认为，我们有理由相信，SUSE的加入必将更好的帮助中国开源云计算联盟的发展，促进OpenStack社区在中国的开发与推广，并针对不同的应用领域，探索基于OpenStack的解决方案，以加速OpenStack在中国的产业化应用发展。

OpenStack项目的市场需求强劲，拥有超过8000名个人会员和超过150家企业和组织会员。OpenStack 基金会主席，SUSE行业创新、新兴标准和开源总监的 Alan Clark先生也指出， 在这么庞大的社区里，OpenStack还不断帮助贡献者提升自身的竞争力。例如，SUSE正帮助中国的开源支持者和贡献者，进一步深化与OpenStack社区的沟通与交流，这将有助于吸引更多优秀的人才和资源加入到这一群体之中。

长期以来，SUSE一直为众多开源社区项目和合作，提供着服务与支持。其中最大也是最有影响的，是为大家所熟知的openSUSE项目。 Attachmate大中华地区及韩国总经理江永清先生表示，作为Linux的开拓先锋，我们有着深厚的历史。我们不仅是开源社区的一部分，我们也为在企业Linux领域做出的长期贡献而倍感自豪。未来，我们还将继续为OpenStack以及开源云项目，提供我们最大的技术与服务支持，通过SUSE实际而高效的创新，帮助企业客户更好地解决当今难以置信的复杂IT挑战。
 
17:56 2013-04-17
Texas Instruments OMAP 5 Cortex A15 Systems-on-Module Galore
http://www.cnx-software.com/2012/11/13/texas-instruments-omap-5-cortex-a15-systems-on-module-galore/

18:02 2013-04-17
1, http://www.cnx-software.com/2013/04/06/allwinner-a20-linux-source-code-evb-schematics-and-product-brief/
Linux for A20  has been imported into github at https://github.com/amery/linux-allwinner/tree/import/lichee-3.3/a20-dev. AllWinner A20 is known as sun7i in the code.
http://www.cnx-software.com/2013/04/13/allwinner-showcases-a20-a31-and-a31s-devices-tablets-phablets-mini-pcs-projectors-laptops-development-boards/
Tom Cubie: so far tested what works: Nand, usb host, usb otg, uSD, hdmi, vga, 100M Ethernet, IR. 
https://plus.google.com/117677652709931793641/posts/SwH5raDWeJq
2, not 100% pin2pin compatibility:
Allwinner’s A10 and A20 are they really pin-to-pin compatible and drop-in replacement 
http://olimex.wordpress.com/2013/04/05/allwinners-a10-and-a20-are-they-really-pin-to-pin-compatible-and-drop-in-replacement/
A10 have two chip-select one clock and two clock enables (second is not used in our schematic) and addresses up to A14
A20 have one clock enable with two pairs of clocks (one not wired on the A20 reference schematic) and addresses up to A15
so both chips can address up to 2GB RAM but in different way.
We didn’t complete our A10 schematic this info comes right on time, so we can make our schematic compatible with both A10 and A20 and to may support up to 2GB RAM
Conclusion: YES, it’s possible to design board which to may work with both A10 and A20, but not if you have not received the A20 info when you made your A10 board :)  

09:08 2013-4-18
1, "Anthony PERARD <anthony.perard@citrix.com>"_email_"Linux based stub-domain"
Here is the long overdue patch series to bring support for a Linux based stubdom which will enable to use QEMU upstream as device model in a stubdom.

The first three patches will provide the necessary to build Linux and a disk image for the stubdomain itself. This is created in a separated directory "stubdom-linux". Calling `make` in this directory will build Linux and the disk. Then a `make install` will copy the two files to the same directory as the MiniOS use.

The last three patches are the libxl support. There is a field called "stubdomain_version" which is automatically set to the appropriate value, depending on the QEMU version used. It call also be set from VM config file.

So, to start a Linux stubdomain, just set those two variables and it shoud start: device_model_stubdomain_override = 1 device_model_version = "qemu-xen"

There is few things that does not have support yet and are on my todo list: - video output - save/restore So for now, we have the network and the console and the disk of the domain.

Regards,

Anthony PERARD (6): linux-stubdomain: Compile QEMU linux-stubdomain: Compile Linux linux-stubdomain: Build a disk image. libxl: Add "stubdomain_version" to domain_build_info. libxl: Handle Linux stubdomain specifique QEMU option. libxl: Build the domain with a Linux based stubdomain.

16:59 2013-04-18
GTD
0, 11:30-13:00 16:50-23:48

1, today
1), work on libvirt libxl driver. ref"13:13 2013-04-09": Jim said that it is a shutdown issue. see"15:21 2013-04-17"

19:38 2013-04-19
GTD
0, 11:30-19:45

1, today
1), work on libvirt libxl driver. ref"13:13 2013-04-09": Jim said that it is a shutdown issue. see"15:21 2013-04-17"

23:56 2013-04-20
opensuse on cubieboard
1, put cfg file to build service.

21:57 2013-04-21
1, fail @ 25 around test.
domainbuilder: detail: xc_dom_release: called
libxl: debug: libxl_device.c:229:libxl__device_disk_set_backend: Disk vdev=xvda spec.backend=tap
libxl: debug: libxl_event.c:559:libxl__ev_xswatch_register: watch w=0x7f7edb4f7448 wpath=/local/domain/0/backend/vbd/252/51712/state token=3/3e0: register slotnum=3
libxl: debug: libxl_event.c:503:watchfd_callback: watch w=0x7f7edb4f7448 wpath=/local/domain/0/backend/vbd/252/51712/state token=3/3e0: event epath=/local/domain/0/backend/vbd/252/51712/state
libxl: debug: libxl_event.c:643:devstate_watch_callback: backend /local/domain/0/backend/vbd/252/51712/state wanted state 2 ok
libxl: debug: libxl_event.c:596:libxl__ev_xswatch_deregister: watch w=0x7f7edb4f7448 wpath=/local/domain/0/backend/vbd/252/51712/state token=3/3e0: deregister slotnum=3
libxl: debug: libxl_event.c:608:libxl__ev_xswatch_deregister: watch w=0x7f7edb4f7448: deregister unregistered
libxl: debug: libxl_device.c:920:device_hotplug: calling hotplug script: /etc/xen/scripts/block add
libxl: debug: libxl_event.c:472:watchfd_callback: watch epath=/local/domain/0/backend/vbd/252/51712/state token=3/3e0: empty slot
libxl: debug: libxl_device.c:956:device_hotplug_timeout_cb: killing hotplug script /etc/xen/scripts/block add because of timeout
libxl: error: libxl_exec.c:129:libxl_report_child_exitstatus: /etc/xen/scripts/block add [8166] died due to fatal signal Killed
libxl: error: libxl_create.c:901:domcreate_launch_dm: unable to add disk devices
libxl: debug: libxl_event.c:559:libxl__ev_xswatch_register: watch w=0x7f7edb506708 wpath=/local/domain/0/backend/vbd/252/51712/state token=3/3e1: register slotnum=3
libxl: debug: libxl_event.c:503:watchfd_callback: watch w=0x7f7edb506708 wpath=/local/domain/0/backend/vbd/252/51712/state token=3/3e1: event epath=/local/domain/0/backend/vbd/252/51712/state
libxl: debug: libxl_event.c:643:devstate_watch_callback: backend /local/domain/0/backend/vbd/252/51712/state wanted state 6 ok
libxl: debug: libxl_event.c:596:libxl__ev_xswatch_deregister: watch w=0x7f7edb506708 wpath=/local/domain/0/backend/vbd/252/51712/state token=3/3e1: deregister slotnum=3
libxl: debug: libxl_event.c:503:watchfd_callback: watch w=0x7f7edb506708 wpath=/local/domain/0/backend/vbd/252/51712/state token=3/3e1: event epath=/local/domain/0/backend/vbd/252/51712/state
libxl: debug: libxl_event.c:643:devstate_watch_callback: backend /local/domain/0/backend/vbd/252/51712/state wanted state 6 ok
libxl: debug: libxl_event.c:596:libxl__ev_xswatch_deregister: watch w=0x7f7edb506708 wpath=/local/domain/0/backend/vbd/252/51712/state token=3/3e1: deregister slotnum=3
libxl: debug: libxl_event.c:608:libxl__ev_xswatch_deregister: watch w=0x7f7edb506708: deregister unregistered
libxl: debug: libxl_device.c:920:device_hotplug: calling hotplug script: /etc/xen/scripts/block remove
libxl: debug: libxl_event.c:472:watchfd_callback: watch epath=/local/domain/0/backend/vbd/252/51712/state token=3/3e1: empty slot
libxl: debug: libxl_device.c:956:device_hotplug_timeout_cb: killing hotplug script /etc/xen/scripts/block remove because of timeout
libxl: error: libxl_exec.c:129:libxl_report_child_exitstatus: /etc/xen/scripts/block remove [8169] died due to fatal signal Killed
libxl: debug: libxl_event.c:1569:libxl__ao_complete: ao 0x7f7edb4ffd30: complete, rc=-3
libxl: debug: libxl_event.c:1541:libxl__ao__destroy: ao 0x7f7edb4ffd30: destroy
xc: debug: hypercall buffer: total allocations:42326 total releases:42326
xc: debug: hypercall buffer: current allocations:0 maximum allocations:4
xc: debug: hypercall buffer: cache current size:4
xc: debug: hypercall buffer: cache hits:41446 misses:4 toobig:876

11:22 2013-04-22
GTD
0, 10:50-17:59 20:31-23:40

1, today
1), 20:31- work report. see"17:53 2013-04-16".
2), 2h Jiaju talk with me and chunyan.
3), 1h work on libvirt libxl driver: send email to Jim. see"22:46 2013-04-22".

17:26 2013-04-22
mailing list, opensuse, arm
1, "Alexander Graf <agraf@suse.de>"_email_"[opensuse-arm] ARM mini-summit at kernel summit"_20120829_0900
Hi guys,

I managed to sneak into the arm mini summit at kernel summit. Here are a few notes I and others took throughout:

- openSUSE got recognized for working on ARM
- we should report bugs / problems to the respective MLs (panda crash, origen issues, ...)
- generic zImage coming (one kernel for all SoCs), some technical / political roadblocks still but should show up soon'ish


----- etherpad notes -------

 
Info: https://sites.google.com/site/kernelsummit2012/workshops/arm
Agenda: https://docs.google.com/spreadsheet/ccc?key=0AqglsllX3y3fdGoxY2lTc3RoTE9zTFcxSGZoR21WYWc#gid=0
IRC: #armsummit on Freenode
WIFI: "Linux Foundation", password "linux2012"
 
Monday
Secure Monitor APIs [WD]
- OMAP calls: http://git.kernel.org/?p=linux/kernel/git/tmlind/linux-omap.git;a=blob;f=arch/arm/mach-omap2/include/mach/omap-secure.h;hb=HEAD
- Calxeda copied the SMC calls from OMAP
- Samsung has reset and boot CPU calls:http://thread.gmane.org/gmane.linux.ports.arm.kernel/183607/http://thread.gmane.org/gmane.linux.ports.arm.kernel/183608/
- On hypervisor guests, HVC instead of SMC might be used, currently none on KVM, Xen uses paravirtualization
- Some SMCs (e.g. l2 cache setup) might be called very early, necessary since it affects boot time - for any future SMCs we would like to avoid this, preferably push to device drivers, for some errata this might be unavoidable
- Another level of APIs is used for secure software on OMAP (audio/video encryption paths)
- We need to agree on which services exist and how to access them, atleast define them in the device tree
- Also secure monitor calls can be redefined by dynamically-loaded software (e.g. "PPA") - these are not simply defined by the boot ROM
- ux500 pushed all secure calls behind the TEE (Trusted Execution Environment) APIs: http://git.linaro.org/gitweb?p=bsp/st-ericsson/linux-3.0-ux500.git;a=tree;f=drivers/tee;hb=HEAD
- We have two classes of problems:
 - Really early stuff that needs to be done before the MMU is turned on
 - Less early stuff that can be handled in a more generic way using device tree and all
- Samsung suggested high-level abstraction:
    http://lists.infradead.org/pipermail/linux-arm-kernel/2012-August/115785.html
 - Useful for everybody apart from OMAP?
 
 
Stale Platform Deprecation [OJ]
 
- Easy to build-test, but do the older platforms still boot?
- Deprecate non-DT platforms after some time of inactivity? (1-2yrs?)
- OMAP1 not a burden, mainline still actively used
- Some (many) drivers still to be updated for DT...
- Appended dtb blob to deal with legacy (non-DT) bootloaders
- Tony to post list of OMAP board files marked for deprecation
- Magnus to write git plugin to identify dead boards
- In-tree defconfigs should be superset of options => shmobile needs to do this!!
- mother of all defconfigs for single zImage
- A patch to delete pnx-4008 is in the pipe
- What to do with  mach-bcmring? Broken for 2 years, but hobbyists now working on it.  Horrible OS abstraction layer. Move to staging?
- Dead platforms: mach-ks8695, mach-h720x, mach-l7200, mach-netx, mach-w90x900
- Long term deprecation: mach-ixp4xx,
- mach-msm/<some board files> ...tricky.
 
 
Virtualisation (Xen vs KVM)
 
- Xen and KVM under active development for ARM, although both currently out-of-tree
- Virtualisation extensions introduced in latest revision of ARMv7 (Cortex-A7, A15)
    * HYP mode (PL2), non-secure only, higher privilege level than svc (OS) but different system interface (translation, registers etc)
    * VMID to identify virtual machine (guest), used to tag TLBs and caches
    * Some peripherals virtualised in hardware (GIC, generic timers)
    * Second-stage translation: IPA => PA
- KVM doesn't support nesting or CPU emulation (ie. guest CPU matches the real hardware)
- Paul: What if HYP is used for other purposes (power management etc)? KVM: Tough. Mutual exclusion of privilege level (one or the other)
- SMC interface should be used for power management / cluster switching instead of HVC:
    https://silver.arm.com/download/download.tm?pv=1303201    [free registration required...]
- Boot protocol: kernel must be entered in hyp mode in order to make use of virtualisation extensions
- Major performance issue is due to QEMU (probably due to the traps)
    ? possibility of creating a new subarch that uses virtio
        - may be best to simply strip down the Versatile Express platform
- Development done on the kvm-arm mailing list
- Magnus: what about virtualized IOMMU development?
- Xen
    * no QEMU used, so no emulated hardware - only minimal set of devices supported (serial)
        - serial needed due to kernel assembly language code that touches UART
    * extensive use of DT
        - very concerned about ACPI on ARM
            - 50% of Xen codebase for x86 is ACPI parser - so big it does not fit into the hypervisor
            - ACPI generator also required; would be bloated
        - concerned also about DT format changes across kernel releases, since Xen is modifying this
            - Stephen: when will DT device bindings be declared as concrete & stable?
                - Olof/Arnd: once the main platforms are completely described in DT
    * bootloaders need modification to load hypervisor, etc.
        - grub for ARM?
    * two different Xen ports for ARM
        - one relies on the hypervisor instructions and so only works on A7/A15
        - the other (Samsung) can run on older ARM cores
    * patch status:
        - hypervisor side almost fully upstream
        - Linux side: sent to the lists
        - devicetree patches sent to the DT mailing list
    * console is paravirtualized, rather than emulated hardware
 
 
DMA Mapping [MS]
 
- Many changes in last year, most of it merged for 3.5
- Conversion to dma_map_ops-based implementation
Per-device mapping operations
Support for DMA bounce
w/ IOMMU
Mixture of coherent and non-coherent devices
- Core DMA mapping code is architecture-independent, but the integration layer is currently only implemented for ARM
    - not very difficult to add integration support for other architectures
- CMA stuck in catch-22 situation of not being enabled / not being used
    * Could enable by default with warnings on allocation failures => see how many bug reports we receive
    * Convert carve-out (?) code to CMA for all platforms
        - i.mx?, OMAP, SH/Mobile, msm?
        - also get rid of GFP_DMA tricks for carve-outs
- Use of highmem with CMA still needs work
- Arnd: for callers who require mappings at specific virtual addresses, IOMMU API calls should be used
    - Stephen: needed because nVidia chips use address 0 for some boot-related code
    - Marek: our codec device requires firmware to be loaded at the lowest address, we just assume that the first allocated buffer for codec device gets the lowest address
 
 
Hacking
 
- Virtualisation (KVM / Xen guys)
- randconfig
- SMP ops
- PMU (PaulW!)
- Timer-based delay loop
- Platform data testing
- Common clock
 
 
Tuesday
 
arm-soc Process Review
 
- Keeping everybody happy is impossible!
- work split between arnd and ojn working well
    * Arnd dislikes rejecting patches
    * Late patches/pull requests also a problem
- multiple branches vs single linear histor
    * Although some (Tegra) prefer the latter, can live with the current approach
- Used to have many conflicts and dependendies, although this seems to have died down (why?)
    * Moving stuff to drivers/ may have helped
- Signed-tags are `really nice' => allows some commentary for the merge
    * Most pull requests should use them [upgrade your git!]
    * http://git-blame.blogspot.com/2012/01/using-signed-tag-in-pull-requesyts.html
- shmobile needs to follow same topic branch style as everyone else
- Requirements for merging new platform code into arm-soc are somehow now coming from customers too (!)
 
 
single zImage (again)
 
- Work done to eliminate duplicate header files across platforms (mostly done)
    * Problem now device drivers including platform-specific headers (mach/*.h)
    * Including these headers is not something we *want* to do, but unfortunately it happens
    * Rename mach/* headers to include platform name as prefix (at least fixes the build)
    * rmk: break drivers including mach/ headers as incentive for people to fix their code
    * Magnus to extend checkpatch.pl to flag up code including these headers
- Three remaining problematic headers: uncompress.h, gpio.h, timex.h
- CLOCK_TICK_RATE problematic (timex.h) but not required for NO_HZ...
    * tlindgren: not required for platforms using clocksource/clockevents (? -- needs to be checked)
    * arnd: value is usually different and usually wrong
- Rob: highbank, picoxcell, socfgpa, vexpress, (zynq) can all be built together without the header prefixing
- Arnd: Samsung platforms huge problem with mach/ includes due to earlier work to reduce the amount of code
- After header prefixing, drivers including mach files hit largely in mach-pxa, mach-sa1100
    * To make it worse, many of these are common...
    * for plat- includes, omap the main one, although largely platform data
- First cleanup pass should be straightforward
    * Remaining drivers can be annoted with depends on !ARM_MULTIPLATFORM
    * tlindgren can do first pass for omap in next week or so for drivers/
- Frameworks required for single zImage: common clock, sparse IRQ
- Arnd will fix Marc's smp_ops patch series and re-post
- Kconfig changes add new option `allow multiple platforms to be selected'
    * Architecture level {v4,v4T,v5}, {v6,v7}
    * Choice of SoC family with default selection
    * linker barfs if no machine selected (empty mach_info)
    * Choice of whether to expose individual board files in Kconfig left to the platform
 
 
AArch64
 
- Catalin has a talk at LinuxCon to introduce the architecture in more depth (please attend!)
- 2nd version of patches on LKML
- DT-only, etc
- Potentially ACPI coming from server folks / our friends in Washington
- Initial platform code for very simple vexpress model
- Aim as high as we can wrt late initialisation of platform code (as a module?) for the moment
- timers, gic under drivers/ -- could also be used by arch/arm/ with ifdefs for the inline asm
- device initialisation via DT as opposed to early hooks in the platform code
- Push back on platforms with things like broken secure interface, etc
    * Olof: difficult if popular platform turns up with another OS but let's start from this position and see
- Not clear when platform code will turn up from silicon vendors but not expected within the next year
- v8 CPUs may be drop-in replacements for v7 CPUs on existing SoCs
    * Server guys more likely to start from scratch
- Arnd: vexpress could be pushed as it's the only `hardware' available at the moment
- Catalin: prefer to push only the core code initially, then cleanup SoC code prior to posting (use as an example)
- Upstreaming: aiming to be in -next for 3.7-rc1
    * Arnd: nah, just stick it in -next now and aim for 3.7 in mainline
    * Action: Arnd to Ack all the patches
- personality discussion ongoing...
    * Arnd: just copy x86
    * Catalin: no. <long discussion about PER_LINUX>
- 2MB limit on size of dtb
    * Rob: 1MB limit for AArch32 already
    * Mark Brown: multi-megabyte co-efficient data for baseband processors could also come via device-tree (for example)
    * Turns out dtb header contains size information, so let's just use that and be done with it
- DMA operations
    * Single set of ops, currently untested (model doesn't have any DMA-capable devices)
    * DMA32 likely to be required
    * swiotlb currently implemented but will be dropped for initial posting as untested
- Stuff to share between arch/arm and arch/arm64
    * dts files
    * perf
    * generic timer
    * gic
    * kvm / Xen    [if/when merged]
 
 
big.LITTLE
 
- Linux Plumbers scheduling micro-conference
- big.LITTLE => DVFS by other means
    * big cores and little cores, architecturally identical
    * Different approaches
- Switching: switch between big and little cores transparently
    * Complications where cluster size not identical (i.e. more of one type than the other)
- MP: kernel aware of all cores
    * Paul Turner has patches to track per-task load history => can be used to pick appropriate target core for a given task
    * v3 posted to LKML, will publish git tree
    * `more accurate load tracking at lower cost'
- Morten Rasmussen has scheduler patches based on the above
    * Reduces wakeups on the big cores
- spreading vs race-to-idle -- related discussion on LKML
- tglx making CPU hotplug suck less
    * parking/unparking kthreads rather than killing/creating
    * worst-case scenario an order or magnitude faster with new approach
    * stop_machine() needs to be removed when CPU is offlined
- topology static in header files, cache-level descriptions
    * need more for big.LITTLE description as micro-architecture radically different
 
 
DMA Engine
 
- no device-tree bindings
    * many things currently blocked on it
    * Patches from Jon Hunter
- Other Patches from Vinod Koul
    * Arnd doesn't think good idea (the DT information in the client should be enough information for the DMAEngine driver)
    * The controversy is over the client not needing to know any of the information.
- Discussing patches from Jon
    * The managing of these properties should be hidden within the DMA subsystem.  The clients and DMA driver shouldn't have to deal with these properties.
    * (It should be like regulators, etc do it)
    * Propose binding uses integer flags field for describing things like direction
        * Mark Brown: `not exactly a readability triumph'
        * Suggestion: why not use a fixed index for read/write/ etc
          But, it is more complex.  We want the request API to be simple.
          It can't be just an index. <Arnd lists bunch of implementation problems with DT>
        * Stephen Warren: we could use multiple properties?  One property is hard to read.
          (Mark Brown argues we really need preprocessor support for dtc)
          Arnd suggests 'dmas' lists all of them, and another 'dma-names' that names them. (key,value) pairs like we do with irqs and regs.
          Arnd: having fixed property names allows something to scan the whole tree to find properties.  If the property has a different name for each device, it is hard to find the dma properties.
          Stephen: You would have to scan for prefixes anyway, as well as regulator.
          The flags are only needed if we want to name the channels.  Makes it more complex for devices with only one channel.
          Paul W: By forcing naming to be consistent, it helps with HW changesintroducing additional channels for existing IP.  Consensus on having name.
        * Q: Which direction are 'read' and 'write'? A: Don't say read or write. :)  See macros in dmaengine.h (enum dma_transfer_direction) [clarification from Vinod Koul - Intel]
        * What about a virtual channel manager that handles the mappings.  Vinod: Drivers shouldn't be knowing about channels, etc.  Argues for platform handling this.  Allocating and filtering channels should be handled by generic code, not individual drivers.


Alex
2, "Andrew Wafaa <awafaa@opensuse.org>"_email_"Re: [opensuse-arm] Fwd: [fedora-arm] ARMv8 Bootstrap Project"_20121122_2034
> In any case, it would be helpfull if people can find out which patches esp.
> for binutils and gcc are used to support that aarch and adapt them for the suse
> packages, so that they apply at least.
>
Do you mean go through [0] and pull out all the aarch64 patches and
try and apply them to factory based packages?

Interestingly enough, Fedora also have a list of unchanged packages
[1] which may help with prioritising what packages need work. Not sure
how similar things would be for us, but...

Regards,

Andy

0-http://fedorapeople.org/groups/armv8/SRPMs/f17/changed/
1-http://fedorapeople.org/groups/armv8/SRPMs/f17/unchanged/

3, "Andrew Wafaa <awafaa@opensuse.org>"_email_"Re: [opensuse-arm] Re: AArch64 status and Debian/Ubuntu announcement"_20130301_1204
I know it may sound pedantic, but it would be better if we reword it
to AArch64, the 64-bit execution state of the ARMv8 architecture.
I'm not sure if it is worth saying that we will also support AArch32,
although we are not directly building it. This is a key differentiator
between us and Fedora. Debian/Ubuntu will support both execution
states via MultiArch.

18:09 2013-04-22
a blog about arm
http://blog.csdn.net/qianlong4526888/article/month/2013/01

21:39 2013-04-22
mailing list, devel-server
1, "Lars Marowsky-Bree <lmb@suse.com>"_email_"[devel-server] Work report lmb"_20130422_0524
[green]
- [Bug 813139] OCFS2 fails to start and causes a fence
 - Very impressed by analysis by Lidong/Guangliang!

- Some shepherding for [Bug 801663] L3: performance of mirror lvm
 unsuitable for production
 - PTF provided to PSA, and a brief setup guide. Waiting for
   feedback.

- SP3 work
 - Quite happy with the state of SLE HA 11 SP3 right now.

- SLE department off-site with the team
 - We covered a lot of ground, a day longer would have been useful to
   go into more depth

- Good meeting with Jiaju & Anja

- Begun thinking about the road ahead to SLE HA 12. Woah. There's a lot
 to do!

- HackWeek:
 - Wrote a paper for IBM System magazine about Geo clustering; still
   need to incorporate feedback from editors that I got this week. Note
   to self: LibreOffice with 4 commentators is a mess to merge.

 - Played a bit with my Arduino Due. Needs a beta release of the
   crosscompilation environment, yay me. ;-) Made an RGB LED cycle
   through its various colors as a start; end-goal is obviously a bit
   more powerful, possibly with a Pi as a web server to remote control
   it. Microcontrollers: limited resources, no libraries, no sensible
   multi-tasking. Yay. I hadn't touched a soldering iron in 15 years
   ;-)

   The AT91SAM3X8E does feature an ARM CPU, but at 84 Mhz and 16 bit
   certainly not an openSUSE architecture ;-) Even though the Cortex M3
   *does* have an MPU and is theoretically
   multi-tasking/multi-threading capable, but that doesn't appear
   exposed in the typical arduino libraries. (Or if it is, it is not
   well documented.)

 - (I think I got the wrong display shield, that one will require too
   many of the precious IO/PWM ports. Probably have to swap it for
   something like http://www.adafruit.com/products/714 that only uses
   two pins.)

 - I had two days off during that week.

- Regular calls:
 - 1:1 Olaf
 - TCM
 - Engineering/PM sync
 - SLE HA team calls
 - HA Trinity with Anja and Kai

- A bit behind on e-mail.


Regards,
   Lars

-- 
Architect Storage/HA
SUSE LINUX Products GmbH, GF: Jeff Hawn, Jennifer Guild, Felix Imendörffer, HRB 21284 (AG Nürnberg)
"Experience is the name everyone gives to their mistakes." -- Oscar Wilde

2, 
>  - Played a bit with my Arduino Due. Needs a beta release of the
>    crosscompilation environment, yay me. ;-) Made an RGB LED cycle
>    through its various colors as a start; end-goal is obviously a bit
>    more powerful, possibly with a Pi as a web server to remote control
>    it. Microcontrollers: limited resources, no libraries, no sensible
>    multi-tasking. Yay. I hadn't touched a soldering iron in 15 years
>    ;-)
> 
>    The AT91SAM3X8E does feature an ARM CPU, but at 84 Mhz and 16 bit
>    certainly not an openSUSE architecture ;-) Even though the Cortex M3
>    *does* have an MPU and is theoretically
>    multi-tasking/multi-threading capable, but that doesn't appear
>    exposed in the typical arduino libraries. (Or if it is, it is not
>    well documented.)

how about try another rtos for your board? AT91SAM3X8E is 32bit arm MCU
(Cortex-M3), lots of rtos base on it.
i'd like introduce a rtos "rt-thread" for u. it is maintained by a Chinese team.
i had run rt-thread on a cortex-M3(STM32F3), it is indeed easy to use: support
multi-task, shell, file system, lightweight TCP/IP(LwIP), GUI. especially, 
it support Arduino code running in a individual thread and support lua script.
and it support the AT91SAM7s/7x series, i guess that support 3X is not difficult.
official website: cn: http://www.rt-thread.org/, en: http://en.rt-thread.org/
source code: https://github.com/RT-Thread/rt-thread

22:46 2013-04-22
virtualization, libvirt, xen, libxl, shutdown issue, send email to Jim
1, send patch to Jim:
From aa525a3aaf2648f7358cca049a87ea18a285ef9a Mon Sep 17 00:00:00 2001
From: Bamvor Jian Zhang <bjzhang@suse.com>
Date: Fri, 19 Apr 2013 19:28:36 +0800
Subject: [PATCH][RFC] fix segfault during virsh save in pv guest

set point in info and increase info->priv ref count before virEventAddHandle.
if do this after virEventAddHandle, the fd callback or fd deregister maybe got
the empty priv, xl_priv or wrong ref count.

the sequence was right in dfa1e1dd, but it changed in e0622ca2. AFAIK, the
latter one introduce virObjectLockable and add ref count while fd register.
i do not know why the location of priv and xl_priv assign is changed.

after apply this patch, test 24 around passed compare to fail within 3round
without this patch. each round includes define -> start -> destroy -> create ->
suspend -> resume -> reboot -> shutdown -> save -> resotre -> dump -> destroy ->
create -> setmem -> setvcpus -> destroy.

2, about libvirt libxl xen4.2 support
hi, Jim

i just send a patch to u about fixing the segfault in virsh save.
i have some issue while using git send-email in my home, so i direct copy my patch and paste to mail.
i am sorry if there is some malform in it.

at i said in previous email, test pass 24 round with my patch, but in 25th round "virsh create", it fail because of the hotplug script timeout:
libxl: debug: libxl_device.c:920:device_hotplug: calling hotplug script: /etc/xen/scripts/block add
libxl: debug: libxl_event.c:472:watchfd_callback: watch epath=/local/domain/0/backend/vbd/252/51712/state token=3/3e0: empty slot
libxl: debug: libxl_device.c:956:device_hotplug_timeout_cb: killing hotplug script /etc/xen/scripts/block add because of timeout
libxl: error: libxl_exec.c:129:libxl_report_child_exitstatus: /etc/xen/scripts/block add [8166] died due to fatal signal Killed
libxl: error: libxl_create.c:901:domcreate_launch_dm: unable to add disk devices

i hope i could debug it tomorrow.

thanks.

16:53 2013-04-23
GTD
0, 15:30

1, today
1), 1h test console patch and send it to chunyan. see"17:02 2013-04-23"
2), install opensuse12.3

17:02 2013-04-23
suse, virtualization, libvirt, qemu, xen, libxlDomainOpenConsole, base on xen4.3, cont3, send console patch to Chunyan for review, cont1
1, test pass
2, commit messsage
add console support in libxl

this patch introduce the console api in libxl driver for both pv and
hvm guest.  and import and update the libxlMakeChrdevStr function which
was deleted in commit dfa1e1dd.

17:13 2013-04-23
virtualization, tools, libvirt, libvirt-designer
""Daniel P. Berrange" <berrange redhat com>"_email_"[Libvirt-announce] [ANNOUNCE] libvirt-designer 0.0.1 release"_20121009_1138
    Date: Tue, 9 Oct 2012 11:38:53 +0100
I am pleased to announce that the first release of the libvirt-designer
package, version 0.0.1, is now available from

  ftp://ftp.libvirt.org/libvirt/designer/

The packages are GPG signed with

    Key fingerprint: DAF3 A6FD B26B 6291 2D0E  8E3F BE86 EBB4 1510 4FDF (4096R)

New in this release:

  - Everything !

The libvirt-designer package provides a library that integrates libosinfo
and libvirt-gconfig. Given an operating system identifier and libvirt
host capabilities, it queries the libosinfo database to determine optimal
hardware configuration and uses this information to design suitable domain
XML for running the OS as a guest. In a similar manner it facilitates the
setup of guest hardware devices such as disks, network interfaces, video
cards, etc. These APIs are inspired by experience creating internal APIs
for similar tasks in the virt-install/virt-manager projects.

Since it builds on libosinfo and libvirt-gconfig, the libvirt-designer
library relies on GObject introspection to provide access to its APIs
for non-C programming languages. In addition it explicitly avoids a
direct depedancy on libvirt.so, to enable usage by applications using
alternative SNMP, CIM, etc bindings to libvirt, or those applications
which simply need to construct libvirt XML without actually booting
the guests afterwards.

These early releases of libvirt-designer should be considered experimental.
While we don't actively plan to change/break the API/ABI, we are not going
to guarantee API/ABI stability of libvirt-designer at this time.

Follow up comments about libvirt-designer should be directed to the
regular libvir-list redhat com development list.

Thanks to all the people involved in contributing to this release, in
particular Michal who is actually doing the vast majority of the hard
work here.

Regards,
Daniel

21:04 2013-4-23
mailing list, virtualzation, xen, arm
ian c 20130409_2209
On Thu, 2013-03-21 at 18:42 +0000, Stefano Stabellini wrote:

It's possible that we might want to restrict the available operations? e.g. remove VPCUOP_initialize/up if we are doing this via PSCI instead?

My concern is that there have been security bugs in VCPUOP_initialize on x86 in the past and if we don't have to expose that possibility on ARM lets not.

Ian.

11:29 2013-04-24
virtualization, libvirt, xen, libxl, segfault, discuss with Jim, continue testing
1, reply to Jim
>Bamvor Jian Zhang wrote:
>> set point in info and increase info->priv ref count before virEventAddHandle.
>> if do this after virEventAddHandle, the fd callback or fd deregister maybe got
>> the empty priv, xl_priv or wrong ref count.
>>   
>
>Thanks for the analysis.
>
>> the sequence was right in dfa1e1dd, but it changed in e0622ca2. AFAIK, the
>> latter one introduce virObjectLockable and add ref count while fd register.
>> i do not know why the location of priv and xl_priv assign is changed.
>>   
>
>I'm not sure why I changed it either :-/.  Maybe it just seemed more
>logical at the time, and hopefully not an attempt to fix some other bug.
>
>> after apply this patch, test 24 around passed compare to fail within 3round
>> without this patch. each round includes define -> start -> destroy -> create ->
>> suspend -> resume -> reboot -> shutdown -> save -> resotre -> dump -> destroy ->
>> create -> setmem -> setvcpus -> destroy.
>>   
>
>My testing was a subset of this, so I think you would have found any bug
>I was trying to fix by the change in e0622ca2.  Moving those lines was
>probably just unintentional.  BTW, have you done your testing with
>libvirtd not running in gdb? :)  I found running in gdb changed the
>behavior of my tests.
No. i am tesing it right now.
>
>> ---
>>  src/libxl/libxl_driver.c |   14 ++++++++------
>>  1 file changed, 8 insertions(+), 6 deletions(-)
>>
>> diff --git a/src/libxl/libxl_driver.c b/src/libxl/libxl_driver.c
>> index 9980b38..96cd2c0 100644
>> --- a/src/libxl/libxl_driver.c
>> +++ b/src/libxl/libxl_driver.c
>> @@ -186,12 +186,6 @@ libxlFDRegisterEventHook(void *priv, int fd, void **hndp,
>>          vir_events |= VIR_EVENT_HANDLE_READABLE;
>>      if (events & POLLOUT)
>>          vir_events |= VIR_EVENT_HANDLE_WRITABLE;
>> -    info->id = virEventAddHandle(fd, vir_events, libxlFDEventCallback,
>> -                                 info, libxlEventHookInfoFree);
>> -    if (info->id < 0) {
>> -        VIR_FREE(info);
>> -        return -1;
>> -    }
>>  
>>      info->priv = priv;
>>      /*
>> @@ -204,6 +198,14 @@ libxlFDRegisterEventHook(void *priv, int fd, void **hndp,
>>      info->xl_priv = xl_priv;
>>      *hndp = info;
>>  
>> +    info->id = virEventAddHandle(fd, vir_events, libxlFDEventCallback,
>> +                                 info, libxlEventHookInfoFree);
>> +    if (info->id < 0) {
>> +        virObjectUnref(info->priv);
>> +        VIR_FREE(info);
>> +        return -1;
>> +    }
>> +
>>   
>
>I wonder if we should do the same for timeouts, for consistency's sake
>if nothing else.  Huh, come to think of it, I probably changed FD
>registration to be consistent with timeouts in e0622ca2...
yes. I think so. i will change the code in timeouts and test again.
>
>Thanks!
>Jim
>
>>      return 0;
>>  }
>>  

2, reply to Jim
>Bamvor Jian Zhang wrote: > hi, Jim
>>
>> i just send a patch to u about fixing the segfault in virsh save.
>> i have some issue while using git send-email in my home, so i direct copy my patch and paste to mail.
>> i am sorry if there is some malform in it.
>>   
>
>Looks fine for review.  I'll respond to it with comments.
>
>> at i said in previous email, test pass 24 round with my patch, but in 25th round "virsh create", it fail because of the hotplug script timeout:
>> libxl: debug: libxl_device.c:920:device_hotplug: calling hotplug script: /etc/xen/scripts/block add
>> libxl: debug: libxl_event.c:472:watchfd_callback: watch epath=/local/domain/0/backend/vbd/252/51712/state token=3/3e0: empty slot
>> libxl: debug: libxl_device.c:956:device_hotplug_timeout_cb: killing hotplug script /etc/xen/scripts/block add because of timeout
>>   
>
>So libxl hit a timeout waiting for the block script to complete.  Maybe
>there is something useful in /var/log/messages.  Did udev even invoke
>the block script?  If so, you would see something like the following in
>/var/log/messages
>
>Feb 27 09:11:28 xen141 logger: /etc/xen/scripts/block: add
>XENBUS_PATH=backend/vbd/1/51712
yes, I could see the following, it seems that fail because of tap connect failure?
Apr 19 20:42:21 linux-work logger: /etc/xen/scripts/block: add XENBUS_PATH=backend/vbd/251/51712
Apr 19 20:42:21 linux-work logger: /etc/xen/scripts/vif-bridge: online type_if=vif XENBUS_PATH=backend/vif/251/0
Apr 19 20:42:21 linux-work kernel: [91065.569659] device vif251.0 entered promiscuous mode
Apr 19 20:42:21 linux-work kernel: [91065.571501] br0: port 2(vif251.0) entering forwarding state
Apr 19 20:42:21 linux-work kernel: [91065.571504] br0: port 2(vif251.0) entering forwarding state
Apr 19 20:42:21 linux-work logger: /etc/xen/scripts/vif-bridge: Successful vif-bridge online for vif251.0, bridge br0.
Apr 19 20:42:21 linux-work logger: /etc/xen/scripts/vif-bridge: Writing backend/vif/251/0/hotplug-status connected to xenstore.
Apr 19 20:42:22 linux-work kernel: [91066.016235] blkback: ring-ref 8, event-channel 9, protocol 1 (x86_64-abi)
Apr 19 20:42:22 linux-work kernel: [91066.268053] br0: port 2(vif251.0) entering forwarding state
Apr 19 20:42:22 linux-work kernel: [91066.268256] br0: port 2(vif251.0) entering disabled state
Apr 19 20:42:22 linux-work logger: /etc/xen/scripts/block: remove XENBUS_PATH=backend/vbd/251/51712
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10166: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10212: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10983: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl13680: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl14888: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15684: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15769: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15929: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl16543: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl21494: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl22322: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl24085: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl24915: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl25153: 111
Apr 19 20:42:22 linux-work tapdisk2[28218]: received 'pid' message (uuid = 0)
Apr 19 20:42:22 linux-work tapdisk2[28218]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl29480: 111
Apr 19 20:42:22 linux-work tapdisk2[30164]: received 'pid' message (uuid = 0)
Apr 19 20:42:22 linux-work tapdisk2[30164]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl31841: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl32239: 111
Apr 19 20:42:22 linux-work logger: /etc/xen/scripts/vif-bridge: offline type_if=vif XENBUS_PATH=backend/vif/251/0
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4111: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4122: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4187: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4280: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4471: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4517: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4666: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4686: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4767: 111
Apr 19 20:42:22 linux-work logger: /etc/xen/scripts/vif-bridge: brctl delif br0 vif251.0 failed
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4846: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4982: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5051: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5420: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5550: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5631: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5787: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7065: 111
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7174: 111
Apr 19 20:42:22 linux-work logger: /etc/xen/scripts/vif-bridge: ifconfig vif251.0 down failed
Apr 19 20:42:22 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7180: 111
Apr 19 20:42:23 linux-work tapdisk2[7190]: received 'pid' message (uuid = 0)
Apr 19 20:42:23 linux-work tapdisk2[7190]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:23 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7323: 111
Apr 19 20:42:23 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7356: 111
Apr 19 20:42:23 linux-work tapdisk2[7579]: received 'pid' message (uuid = 0)
Apr 19 20:42:23 linux-work tapdisk2[7579]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:23 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7824: 111
Apr 19 20:42:23 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8192: 111
Apr 19 20:42:23 linux-work logger: /etc/xen/scripts/vif-bridge: Successful vif-bridge offline for vif251.0, bridge br0.
Apr 19 20:42:23 linux-work tapdisk2[8220]: received 'pid' message (uuid = 0)
Apr 19 20:42:23 linux-work tapdisk2[8220]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:23 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8306: 111
Apr 19 20:42:23 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8602: 111
Apr 19 20:42:23 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8944: 111
Apr 19 20:42:23 linux-work tapdisk2[7190]: received 'list' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[7190]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[7190]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[7579]: received 'list' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[7579]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[7579]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[8220]: received 'list' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[8220]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[8220]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[28218]: received 'list' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[28218]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[28218]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[30164]: received 'list' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[30164]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[30164]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:23 linux-work tapdisk2[7579]: received 'close' message (uuid = 11)
Apr 19 20:42:23 linux-work tapdisk2[7579]: closed image /var/lib/xen/images_2/sles11_sp2_pv/disk0.raw (0 users, state: 0x00000000, type: 0)
Apr 19 20:42:23 linux-work tapdisk2[7579]: sending 'close response' message (uuid = 11)
Apr 19 20:42:23 linux-work tapdisk2[7579]: received 'detach' message (uuid = 11)
Apr 19 20:42:23 linux-work tapdisk2[7579]: sending 'detach response' message (uuid = 11)
Apr 19 20:42:23 linux-work kernel: [91067.479552] blktap_ring_vm_close: unmapping ring 11
Apr 19 20:42:23 linux-work kernel: [91067.479558] blktap_ring_release: freeing device 11
Apr 19 20:42:23 linux-work kernel: [91067.480261] blktap_device_destroy: destroy device 11 users 0
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10166: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10212: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10983: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl13680: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl14888: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15684: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15769: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15929: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl16543: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl21494: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl22322: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl24085: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl24915: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl25153: 111
Apr 19 20:42:34 linux-work tapdisk2[28218]: received 'pid' message (uuid = 0)
Apr 19 20:42:34 linux-work tapdisk2[28218]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl29480: 111
Apr 19 20:42:34 linux-work tapdisk2[30164]: received 'pid' message (uuid = 0)
Apr 19 20:42:34 linux-work tapdisk2[30164]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl31841: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl32239: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4111: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4122: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4187: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4280: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4471: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4517: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4666: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4686: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4767: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4846: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4982: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5051: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5420: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5550: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5631: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5787: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7065: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7174: 111
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7180: 111
Apr 19 20:42:34 linux-work tapdisk2[7190]: received 'pid' message (uuid = 0)
Apr 19 20:42:34 linux-work tapdisk2[7190]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:34 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7323: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7356: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7824: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8192: 111
Apr 19 20:42:35 linux-work tapdisk2[8220]: received 'pid' message (uuid = 0)
Apr 19 20:42:35 linux-work tapdisk2[8220]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8306: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8602: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8944: 111
Apr 19 20:42:35 linux-work tapdisk2[7190]: received 'list' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[7190]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[7190]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[8220]: received 'list' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[8220]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[8220]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[28218]: received 'list' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[28218]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[28218]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[30164]: received 'list' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[30164]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:35 linux-work tapdisk2[30164]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:35 linux-work kernel: [91079.472223] blktap_control_allocate_tap: allocated tap ffff880090e5f000
Apr 19 20:42:35 linux-work tapdisk2[8157]: I/O queue driver: lio
Apr 19 20:42:35 linux-work tapdisk2[8157]: received 'attach' message (uuid = 11)
Apr 19 20:42:35 linux-work tapdisk2[8157]: sending 'attach response' message (uuid = 11)
Apr 19 20:42:35 linux-work tapdisk2[8157]: received 'open' message (uuid = 11)
Apr 19 20:42:35 linux-work tapdisk2[8157]: block-aio open('/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw')
Apr 19 20:42:35 linux-work tapdisk2[8157]: open(/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw) with O_DIRECT
Apr 19 20:42:35 linux-work tapdisk2[8157]: Image size:  	pre sector_shift  [2147483648] 	post sector_shift [4194304]
Apr 19 20:42:35 linux-work tapdisk2[8157]: opened image /var/lib/xen/images_2/sles11_sp2_pv/disk0.raw (1 users, state: 0x00000001, type: 0)
Apr 19 20:42:35 linux-work tapdisk2[8157]: VBD CHAIN:
Apr 19 20:42:35 linux-work tapdisk2[8157]: /var/lib/xen/images_2/sles11_sp2_pv/disk0.raw: 0
Apr 19 20:42:35 linux-work tapdisk2[8157]: sending 'open response' message (uuid = 11)
Apr 19 20:42:35 linux-work kernel: [91079.489330] blktap_ring_open: opening device blktap11
Apr 19 20:42:35 linux-work kernel: [91079.489336] blktap_ring_open: opened device 11
Apr 19 20:42:35 linux-work kernel: [91079.489357] blktap_ring_mmap: blktap: mapping pid is 8158
Apr 19 20:42:35 linux-work kernel: [91079.490812] blktap_validate_params: aio:/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw: capacity: 4194304, sector-size: 512
Apr 19 20:42:35 linux-work kernel: [91079.490820] blktap_validate_params: aio:/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw: capacity: 4194304, sector-size: 512
Apr 19 20:42:35 linux-work kernel: [91079.490825] blktap_device_create: minor 11 sectors 4194304 sector-size 512
Apr 19 20:42:35 linux-work kernel: [91079.491145] blktap_device_create: creation of 252:11: 0
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10166: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10212: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10983: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl13680: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl14888: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15684: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15769: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15929: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl16543: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl21494: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl22322: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl24085: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl24915: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl25153: 111
Apr 19 20:42:35 linux-work tapdisk2[28218]: received 'pid' message (uuid = 0)
Apr 19 20:42:35 linux-work tapdisk2[28218]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl29480: 111
Apr 19 20:42:35 linux-work tapdisk2[30164]: received 'pid' message (uuid = 0)
Apr 19 20:42:35 linux-work tapdisk2[30164]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl31841: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl32239: 111
Apr 19 20:42:35 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4111: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4122: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4187: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4280: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4471: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4517: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4666: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4686: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4767: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4846: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4982: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5051: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5420: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5550: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5631: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5787: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7065: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7174: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7180: 111
Apr 19 20:42:36 linux-work tapdisk2[7190]: received 'pid' message (uuid = 0)
Apr 19 20:42:36 linux-work tapdisk2[7190]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7323: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7356: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7824: 111
Apr 19 20:42:36 linux-work tapdisk2[8157]: received 'pid' message (uuid = 0)
Apr 19 20:42:36 linux-work tapdisk2[8157]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8192: 111
Apr 19 20:42:36 linux-work tapdisk2[8220]: received 'pid' message (uuid = 0)
Apr 19 20:42:36 linux-work tapdisk2[8220]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8306: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8602: 111
Apr 19 20:42:36 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8944: 111
Apr 19 20:42:36 linux-work tapdisk2[7190]: received 'list' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[7190]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[7190]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[8157]: received 'list' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[8157]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[8157]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[8220]: received 'list' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[8220]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[8220]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[28218]: received 'list' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[28218]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[28218]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[30164]: received 'list' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[30164]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[30164]: sending 'list response' message (uuid = 65535)
Apr 19 20:42:36 linux-work tapdisk2[8157]: received 'close' message (uuid = 11)
Apr 19 20:42:36 linux-work tapdisk2[8157]: closed image /var/lib/xen/images_2/sles11_sp2_pv/disk0.raw (0 users, state: 0x00000000, type: 0)
Apr 19 20:42:36 linux-work tapdisk2[8157]: sending 'close response' message (uuid = 11)
Apr 19 20:42:36 linux-work tapdisk2[8157]: received 'detach' message (uuid = 11)
Apr 19 20:42:36 linux-work tapdisk2[8157]: sending 'detach response' message (uuid = 11)
Apr 19 20:42:36 linux-work kernel: [91080.888255] blktap_ring_vm_close: unmapping ring 11
Apr 19 20:42:36 linux-work kernel: [91080.888261] blktap_ring_release: freeing device 11
Apr 19 21:02:36 linux-work -- MARK --

>
>> libxl: error: libxl_exec.c:129:libxl_report_child_exitstatus: /etc/xen/scripts/block add [8166] died due to fatal signal Killed
>> libxl: error: libxl_create.c:901:domcreate_launch_dm: unable to add disk devices
>>
>> i hope i could debug it tomorrow.
>>
>> thanks.
>>
>>   
>>>   

3, error in /var/log/message 
Apr 19 20:42:34 linux-work tapdisk2[30164]: sending 'pid response' message (uuid = 0)
Apr 19 20:42:34 linux-work tapdisk2[7190]: received 'pid' message (uuid = 0)

4, reply to Jim
>BTW, what version of xen are you using in your testing?  xen-ustable? 
>Our latest xen-4.2.x packages?
xen-unstable, commit 66eb6f8b7, including the your patch on 24th Jan.
I build it on ibs: https://build.suse.de/package/show?package=xen_4.3&project=home%3Abjzhang
I was want to test it on our lastest xen-4.2.x package after all test passed in xen-unstable.

5, modify timeout as same as fd, test
1), failt @ 41 round
(1), log
test libxlDomainCreateXML: create
error: Failed to create domain from /var/lib/xen/images_2/sles11_sp2_pv/sles11_sp2_pv.xml
error: internal error libxenlight failed to create new domain 'sles11_sp2_pv'
(2), log in libxl: 
libxl: debug: libxl_device.c:229:libxl__device_disk_set_backend: Disk vdev=xvda spec.backend=tap
libxl: error: libxl.c:2101:device_disk_add: failed to get blktap devpath for 0x7f9e34017130
libxl: error: libxl_create.c:901:domcreate_launch_dm: unable to add disk devices
2), fail @ 17 round, restore
same at create: fail at block add.
(1), libxl
libxl: debug: libxl_device.c:920:device_hotplug: calling hotplug script: /etc/xen/scripts/block add
libxl: debug: libxl_device.c:956:device_hotplug_timeout_cb: killing hotplug script /etc/xen/scripts/block add because of timeout
libxl: error: libxl_exec.c:129:libxl_report_child_exitstatus: /etc/xen/scripts/block add [21406] died due to fatal signal Killed
libxl: error: libxl_create.c:901:domcreate_launch_dm: unable to add disk devices
3), discuss with Chunyan
(1), enable hotplug debug: add "set -x" in /etc/xen/scripts/block-common.sh, the log will output to "/var/log/xen/xen-hotplug.log"
linux-work:/etc/xen/scripts # diff -urp block-common.sh block-common.sh~
--- block-common.sh     2013-04-24 16:47:36.000000000 +0800
+++ block-common.sh~    2013-01-30 13:34:28.000000000 +0800
@@ -16,7 +16,6 @@
 #
 
 
-set -x
 dir=$(dirname "$0")
 . "$dir/xen-hotplug-common.sh"

(2), check the message in /var/log/message
linux-work:/home/bamvor # tail -f /var/log/messages
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10166: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10212: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl10983: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl13680: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl14888: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15684: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15769: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl15929: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl16543: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl21494: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl22322: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl24085: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl24915: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl25153: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl28219: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl29480: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl30165: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl31841: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl32239: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4111: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4122: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4187: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4280: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4471: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4517: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4666: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4686: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4767: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4846: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl4982: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5051: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5420: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5550: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5631: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl5787: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7065: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7174: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7180: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7191: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7323: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7356: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl7824: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8192: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8221: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8306: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8602: 111
Apr 24 17:00:13 linux-work libvirtd: tap-err:tap_ctl_connect: couldn't connect to /var/run/blktap-control/ctl8944: 111
Apr 24 17:00:13 linux-work kernel: [  655.966703] blktap_control_allocate_tap: allocated tap ffff8800d324e000
Apr 24 17:00:14 linux-work tapdisk2[4927]: I/O queue driver: lio
Apr 24 17:00:14 linux-work tapdisk2[4927]: received 'attach' message (uuid = 0)
Apr 24 17:00:14 linux-work tapdisk2[4927]: sending 'attach response' message (uuid = 0)
Apr 24 17:00:14 linux-work tapdisk2[4927]: received 'open' message (uuid = 0)
Apr 24 17:00:14 linux-work kernel: [  656.027125] blktap_ring_open: opening device blktap0
Apr 24 17:00:14 linux-work kernel: [  656.027131] blktap_ring_open: opened device 0
Apr 24 17:00:14 linux-work kernel: [  656.027153] blktap_ring_mmap: blktap: mapping pid is 4928
Apr 24 17:00:14 linux-work tapdisk2[4927]: block-aio open('/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw')
Apr 24 17:00:14 linux-work tapdisk2[4927]: open(/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw) with O_DIRECT
Apr 24 17:00:14 linux-work tapdisk2[4927]: Image size:          pre sector_shift  [2147483648]  post sector_shift [4194304]
Apr 24 17:00:14 linux-work tapdisk2[4927]: opened image /var/lib/xen/images_2/sles11_sp2_pv/disk0.raw (1 users, state: 0x00000001, type: 0)
Apr 24 17:00:14 linux-work tapdisk2[4927]: VBD CHAIN:
Apr 24 17:00:14 linux-work tapdisk2[4927]: /var/lib/xen/images_2/sles11_sp2_pv/disk0.raw: 0
Apr 24 17:00:14 linux-work tapdisk2[4927]: sending 'open response' message (uuid = 0)
Apr 24 17:00:14 linux-work kernel: [  656.260188] blktap_validate_params: aio:/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw: capacity: 4194304, sector-size: 512
Apr 24 17:00:14 linux-work kernel: [  656.260194] blktap_validate_params: aio:/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw: capacity: 4194304, sector-size: 512
Apr 24 17:00:14 linux-work kernel: [  656.260199] blktap_device_create: minor 0 sectors 4194304 sector-size 512
Apr 24 17:00:14 linux-work kernel: [  656.260468] blktap_device_create: creation of 252:0: 0
Apr 24 17:00:14 linux-work logger: /etc/xen/scripts/block: add XENBUS_PATH=backend/vbd/1/51712
Apr 24 17:00:14 linux-work logger: /etc/xen/scripts/vif-bridge: online type_if=vif XENBUS_PATH=backend/vif/1/0
Apr 24 17:00:14 linux-work kernel: [  656.858359] device vif1.0 entered promiscuous mode
Apr 24 17:00:14 linux-work kernel: [  656.860201] br0: port 2(vif1.0) entering forwarding state
Apr 24 17:00:14 linux-work kernel: [  656.860204] br0: port 2(vif1.0) entering forwarding state
Apr 24 17:00:14 linux-work logger: /etc/xen/scripts/vif-bridge: Successful vif-bridge online for vif1.0, bridge br0.
Apr 24 17:00:14 linux-work logger: /etc/xen/scripts/vif-bridge: Writing backend/vif/1/0/hotplug-status connected to xenstore.
Apr 24 17:00:15 linux-work kernel: [  657.329151] blkback: ring-ref 8, event-channel 9, protocol 1 (x86_64-abi)
Apr 24 17:00:16 linux-work avahi-daemon[3116]: Registering new address record for fe80::fcff:ffff:feff:ffff on vif1.0.*.
Apr 24 17:00:25 linux-work kernel: [  667.868096] vif1.0: no IPv6 routers presen
(3), Chunyan suggest that read the code, found that what it is done after "blktap_device_create: creation of 252:0: 0", maybe the front end driver do not get the reply, so, xen timeout occurred.

6, send my lastest patch to Jim.
Hi, Jim

here is my lastest patch. the first patch is unchanged, i simple add a patch for fixing timeout register function. i will merge the patch when i send it out if needed.
today, i test this patch two times. on sles11 sp2. with xen and libvirt upstream. xen commit: 66eb6f8b, libvirt commit: fd1432c7.  kernel: 3.0.13-0.27-xen
there are 42 round test successful and 17 round test successful respectively. and fail at create and restore, and both fail because of block add timeout. it seems that they both timeout after "blktap_device_create: creation of 252:2: 0"
i plan read the backend driver code in order to check what happens after blktap_device_create.

right now, and another same test is running, 14 round successful.

notes: each round includes define -> start -> destroy -> create -> suspend -> resume -> reboot -> shutdown -> save -> resotre -> dump -> destroy -> create -> setmem -> setvcpus -> destroy.

thanks

Bamvor

14:43 2013-04-24
mailing list, virtualization, virtualization-dev, windows iso
""Charles Arnold" <carnold@suse.com>"_email_"Re: [Virtualization-dev] w2k3 image?"_20130423_2245
We have the ISO's for all windows releases on xen100
For win2k3, see /share/iso/windows/2k3 (also accessible via ftp).
If you use win-2k3-sp2-64-auto.iso, it will do a complete install without user interaction.
Depending on your need, you may want to run updates but don't try to activate the license.
- Charles

>>> On 4/23/2013 at 05:41 AM, in message
<51768F8502000078000CFF23@nat28.tlf.novell.com>, "Jan Beulich"
<JBeulich@suse.com> wrote: 
>>>> On 23.04.13 at 13:36, "Jan Beulich" <JBeulich@suse.com> wrote:
>> Do we have a w2k3 image that I could copy over for testing purposes?
> 
> Sorry, meant this to go to the internal list. It would really help if
> the mailing list names were distinguishable by more than the 14th
> and 16th character...
> 
> Thanks, Jan
> 
> _______________________________________________
> virtualization-dev mailing list
> virtualization-dev@lists.novell.com
> https://lists.innerweb.novell.com/mailman/listinfo/virtualization-dev
> Search Archives: https://lists.innerweb.novell.com/search

14:45 2013-04-24
mailing list, virtualization, virtualization-xen, how to debug guest kernel crash
1), ""Jared Hudson" <jahudson@novell.com>"_email_"[virtualization-xen] Antw: Re: How to kdump when issue occures within XEN, soonr"
> Can you please point us in the correct direction, thanks. 

You must not have the debug repositories added.

http://en.opensuse.org/Package_repositories#Debug

You should add all of the openSUSE 12.2 debug repositories then you can just use zypper to find the  kernel-xen-debuginfo, kernel-xen-base-debuginfo and kernel-xen-devel-debuginfo RPM packages you will need.

Here is a direct link to the RPMs as well.
http://download.opensuse.org/debug/update/12.2/x86_64/kernel-xen-debuginfo-3.4.33-2.24.1.x86_64.rpm
http://download.opensuse.org/debug/update/12.2/x86_64/kernel-xen-base-debuginfo-3.4.33-2.24.1.x86_64.rpm
http://download.opensuse.org/debug/update/12.2/x86_64/kernel-xen-devel-debuginfo-3.4.33-2.24.1.x86_64.rpm

Within the kernel-xen-devel-debuginfo-3.4.33-2.24.1.x86_64.rpm RPM is the file /usr/lib/debug/boot/vmlinux-3.4.33-2.24-xen.debug which is the debug kernel I mentioned in my last e-mail. Technically it's a normal kernel's debug symbols.

You may also want to set your Xen VM configuration to produce a crash dump automatically by setting
on_crash="coredump-destroy" in /etc/xen/vm/vmname
You would want to do this so you can produce a crash dump closer to the point where the problem actually happens.

In addition to editing your configuration file you can probably apply that setting without restarting the VM by using
xenstore-write /vm/169cf645-c5f9-fcef-2551-a8ac4f604750/on_crash coredump-destroy

substituting 169cf645-c5f9-fcef-2551-a8ac4f604750 with your own VM's UUID of course.

If you choose not to, then shutdown and startup a fresh copy of your VM.

Then enable the setting panic_on_oops inside of your VM by editing /etc/sysctl.conf and add
kernel.panic_on_oops=1
then run sysctl -p

The next time your VM experiences the issue it will hopefully trigger the host OS to start producing a crash dump of the VM. If it doesn't then just run xm dump-core command as Jan recommended.

Jared H.

14:55 2013-04-24
GTD
0, 11:00

1, today
1), reply to Jim and talk with Jim about libvirt libxl driver segfault.
2), send libvirt libxl driver patch to Jim before leaving.

17:38 2013-04-24
software skill, communication, Wine_QQ
http://linux-wiki.cn/wiki/Wine_QQ
http://www.longene.org/forum/viewtopic.php?t=4700
http://www.linuxdiyf.com/viewarticle.php?id=378468

22:35 2013-04-24
software skill, blog, dropbox
1, http://www.farbox.com/ 
http://geektu.com/post/2013-01-09-farbox-shang-shou-zhi-nan
http://www.nerdyang.com/post/yongfarbox-jian-ge-ren-wang-zhan
2, using markdown for your blog
http://blog.lihaixin.name/2012/02/how-to-use-markdown-in-blogger.html

23:48 2013-04-24
software skill, blog, dropbox, doc, summary
使用farbox建立自己的博客
1, 
> tree
.
└── xen_on_arm
    ├── domains.config
    └── hello.txt

1 directory, 2 files
> cat xen_on_arm/domains.config
xen_on_arm.farbox.com
> cat xen_on_arm/hello.txt
hello. 
my first blog

dropbox.py start -i successful, dropbox start -i, got network connection error

08:07 2013-04-25
software skill, network, console, connection, print all connection in current machine; ssh; ip address
> pinky
Login    Name                 TTY      Idle   When             Where
bamvor   bamvor jian zhang   ?:0       ?????  2013-04-24 16:50 console
bamvor   bamvor jian zhang    pts/0    13:25  2013-04-24 16:50 147.2.207.58
bamvor   bamvor jian zhang    pts/1    15:08  2013-04-24 16:50
bamvor   bamvor jian zhang    pts/2    13:50  2013-04-24 16:56 147.2.207.58
bamvor   bamvor jian zhang    pts/3           2013-04-25 07:54 149.44.166.178
bamvor   bamvor jian zhang    pts/4    14:40  2013-04-24 17:17 147.2.207.58
bamvor   bamvor jian zhang    pts/6    14:29  2013-04-24 17:22 147.2.207.58
bamvor   bamvor jian zhang    pts/5    13:48  2013-04-24 18:04 147.2.207.58

08:35 2013-04-25
virtualization, libvirt, xen, libxl, segfault, send final patch to Jim, cont1
1, Jim reply 20130425_0633
Re: [PATCH][RFC] fix segfault during virsh save in pv guest
Bamvor Jian Zhang wrote:
> Hi, Jim
>
> here is my lastest patch. the first patch is unchanged, i simple add a patch for fixing timeout register function. i will merge the patch when i send it out if needed.
>   

Yeah, I think one patch is fine.

> today, i test this patch two times. on sles11 sp2. with xen and libvirt upstream. xen commit: 66eb6f8b, libvirt commit: fd1432c7.  kernel: 3.0.13-0.27-xen
> there are 42 round test successful and 17 round test successful respectively. and fail at create and restore, and both fail because of block add timeout. it seems that they both timeout after "blktap_device_create: creation of 252:2: 0"
> i plan read the backend driver code in order to check what happens after blktap_device_create.
>   

Ok, thanks.  Seems like a problem unrelated to the libvirt libxl driver.

> right now, and another same test is running, 14 round successful.
>
> notes: each round includes define -> start -> destroy -> create -> suspend -> resume -> reboot -> shutdown -> save -> resotre -> dump -> destroy -> create -> setmem -> setvcpus -> destroy.
>
>   

> From aa525a3aaf2648f7358cca049a87ea18a285ef9a Mon Sep 17 00:00:00 2001
> From: Bamvor Jian Zhang <bjzhang@suse.com>
> Date: Fri, 19 Apr 2013 19:28:36 +0800
> Subject: [PATCH 1/2][RFC] fix segfault during virsh save in pv guest
>
> set point in info and increase info->priv ref count before virEventAddHandle.
> if do this after virEventAddHandle, the fd callback or fd deregister maybe got
> the empty priv, xl_priv or wrong ref count.
>
> the sequence was right in dfa1e1dd, but it changed in e0622ca2.

You can add this sentence to the previous paragraph

>  AFAIK, the
> latter one introduce virObjectLockable and add ref count while fd register.
> i do not know why the location of priv and xl_priv assign is changed.
>   

and remove this part of the commit message.

> after apply this patch, test 24 around passed compare to fail within 3round
> without this patch. each round includes define -> start -> destroy -> create ->
> suspend -> resume -> reboot -> shutdown -> save -> resotre -> dump -> destroy ->
> create -> setmem -> setvcpus -> destroy.
>
>
> move assign before virEventAddHandle. i do not know why jim move it in e0622ca2.
>   

This last sentence can be killed as well :).

> ---
>  src/libxl/libxl_driver.c | 14 ++++++++------
>  1 file changed, 8 insertions(+), 6 deletions(-)
>
> diff --git a/src/libxl/libxl_driver.c b/src/libxl/libxl_driver.c
> index 9980b38..96cd2c0 100644
> --- a/src/libxl/libxl_driver.c
> +++ b/src/libxl/libxl_driver.c
> @@ -186,12 +186,6 @@ libxlFDRegisterEventHook(void *priv, int fd, void **hndp,
>          vir_events |= VIR_EVENT_HANDLE_READABLE;
>      if (events & POLLOUT)
>          vir_events |= VIR_EVENT_HANDLE_WRITABLE;
> -    info->id = virEventAddHandle(fd, vir_events, libxlFDEventCallback,
> -                                 info, libxlEventHookInfoFree);
> -    if (info->id < 0) {
> -        VIR_FREE(info);
> -        return -1;
> -    }
>  
>      info->priv = priv;
>      /*
> @@ -204,6 +198,14 @@ libxlFDRegisterEventHook(void *priv, int fd, void **hndp,
>      info->xl_priv = xl_priv;
>      *hndp = info;
>  
> +    info->id = virEventAddHandle(fd, vir_events, libxlFDEventCallback,
> +                                 info, libxlEventHookInfoFree);
> +    if (info->id < 0) {
> +        virObjectUnref(info->priv);
> +        VIR_FREE(info);
> +        return -1;
> +    }
> +
>   

Hmm, maybe best to move all the libvirt event loop stuff together, e.g.

diff --git a/src/libxl/libxl_driver.c b/src/libxl/libxl_driver.c
index 9980b38..9889062 100644
--- a/src/libxl/libxl_driver.c
+++ b/src/libxl/libxl_driver.c
@@ -182,6 +182,15 @@ libxlFDRegisterEventHook(void *priv, int fd, void
**hndp,
        return -1;
    }

+    info->priv = priv;
+    /*
+     * Take a reference on the domain object.  Reference is dropped in
+     * libxlEventHookInfoFree, ensuring the domain object outlives the fd
+     * event objects.
+     */
+    virObjectRef(info->priv);
+    info->xl_priv = xl_priv;
+
    if (events & POLLIN)
        vir_events |= VIR_EVENT_HANDLE_READABLE;
    if (events & POLLOUT)
@@ -189,19 +198,11 @@ libxlFDRegisterEventHook(void *priv, int fd, void
**hndp,
    info->id = virEventAddHandle(fd, vir_events, libxlFDEventCallback,
                                 info, libxlEventHookInfoFree);
    if (info->id < 0) {
+        virObjectUnref(info->priv);
        VIR_FREE(info);
        return -1;
    }

-    info->priv = priv;
-    /*
-     * Take a reference on the domain object.  Reference is dropped in
-     * libxlEventHookInfoFree, ensuring the domain object outlives the fd
-     * event objects.
-     */
-    virObjectRef(info->priv);
-
-    info->xl_priv = xl_priv;
    *hndp = info;

    return 0;


>      return 0;
>  }
>  
> -- 1.8.1.4
> ------------------------------------------------------------------------
>
> From 255ff4445b3192cb4294b11168fa06331d0dbf59 Mon Sep 17 00:00:00 2001
> From: Bamvor Jian Zhang <bamv2005@gmail.com>
> Date: Wed, 24 Apr 2013 15:14:07 +0800
> Subject: [PATCH 2/2][RFC] modify libxlTimeoutRegisterEventHook as same as
>  libxlFDRegisterEventHook
>   

As mentioned, squash this into the first patch.

> ---
>  src/libxl/libxl_driver.c | 15 +++++++++------
>  1 file changed, 9 insertions(+), 6 deletions(-)
>
> diff --git a/src/libxl/libxl_driver.c b/src/libxl/libxl_driver.c
> index 96cd2c0..baeb71d 100644
> --- a/src/libxl/libxl_driver.c
> +++ b/src/libxl/libxl_driver.c
> @@ -296,12 +296,6 @@ libxlTimeoutRegisterEventHook(void *priv,
>      } else {
>          timeout = res.tv_sec * 1000 + (res.tv_usec + 999) / 1000;
>      }
> -    info->id = virEventAddTimeout(timeout, libxlTimerCallback,
> -                                  info, libxlEventHookInfoFree);
> -    if (info->id < 0) {
> -        VIR_FREE(info);
> -        return -1;
> -    }
>  
>      info->priv = priv;
>      /*
> @@ -317,6 +311,15 @@ libxlTimeoutRegisterEventHook(void *priv,
>      info->xl_priv = xl_priv;
>      *hndp = info;
>  
> +    info->id = virEventAddTimeout(timeout, libxlTimerCallback,
> +                                  info, libxlEventHookInfoFree);
> +    if (info->id < 0) {
> +        virObjectUnref(info->priv);
> +        VIR_FREE(info);
> +        return -1;
> +    }
>   

It looks like you moved this a bit too far, since the timer has already
been added to the list of timerRegistrations.  I think it is safe to add
the timeout to libvirt event loop right after taking a ref on
info->priv, e.g.

diff --git a/src/libxl/libxl_driver.c b/src/libxl/libxl_driver.c
index 9980b38..97f5035 100644
--- a/src/libxl/libxl_driver.c
+++ b/src/libxl/libxl_driver.c
@@ -284,6 +284,14 @@ libxlTimeoutRegisterEventHook(void *priv,
        return -1;
    }

+    info->priv = priv;
+    /*
+     * Also take a reference on the domain object.  Reference is dropped in
+     * libxlEventHookInfoFree, ensuring the domain object outlives the
timeout
+     * event objects.
+     */
+    virObjectRef(info->priv);
+
    gettimeofday(&now, NULL);
    timersub(&abs_t, &now, &res);
    /* Ensure timeout is not overflowed */
@@ -297,18 +305,11 @@ libxlTimeoutRegisterEventHook(void *priv,
    info->id = virEventAddTimeout(timeout, libxlTimerCallback,
                                  info, libxlEventHookInfoFree);
    if (info->id < 0) {
+        virObjectUnref(info->priv);
        VIR_FREE(info);
        return -1;
    }

-    info->priv = priv;
-    /*
-     * Also take a reference on the domain object.  Reference is dropped in
-     * libxlEventHookInfoFree, ensuring the domain object outlives the
timeout
-     * event objects.
-     */
-    virObjectRef(info->priv);
-
    virObjectLock(info->priv);
    LIBXL_EV_REG_APPEND(info->priv->timerRegistrations, info);
    virObjectUnlock(info->priv);

> +
> +
>      return 0;
>  }
>  
> -- 1.8.1.4

2, in timeout register
i put "info->xl_priv = xl_priv;" after virObjectRef, and put "*hndp = info;" before function return.
3, make libvirt. need make clean first. because src/rpc/gendispatch.pl and "src/remote/remote_protocol.x" changes.
if not, will lead to function undefined in src/remote/remote_driver.c
(16:33 2013-04-25)
"make clean" is not necessary. need delete the output file.
and there is similar problem in src/locking:
libtool: link: gcc -std=gnu99 -I/usr/include/libxml2 -W -Waddress -Wall -Warray-bounds -Wattributes -Wbad-function-cast -Wchar-subscripts -Wclobbered -Wcomment -Wcomments -Wcoverage-mismatch -Wdeprecated-declarations -Wdisabled-optimization -Wdiv-by-zero -Wempty-body -Wendif-labels -Wextra -Wformat-contains-nul -Wformat-extra-args -Wformat-security -Wformat-y2k -Wformat-zero-length -Wformat=2 -Wignored-qualifiers -Wimplicit -Wimplicit-function-declaration -Wimplicit-int -Winit-self -Winline -Wint-to-pointer-cast -Winvalid-pch -Wlogical-op -Wmain -Wmissing-braces -Wmissing-field-initializers -Wmissing-format-attribute -Wmissing-include-dirs -Wmissing-noreturn -Wmissing-parameter-type -Wmultichar -Wnested-externs -Wnonnull -Wnormalized=nfc -Wold-style-declaration -Wold-style-definition -Woverflow -Woverride-init -Wparentheses -Wpointer-arith -Wpointer-sign -Wpointer-to-int-cast -Wpragmas -Wreturn-type -Wsequence-point -Wshadow -Wstrict-aliasing -Wstrict-prototypes -Wswitch -Wtrigraphs -Wtype-limits -Wuninitialized -Wunknown-pragmas -Wunused -Wunused-function -Wunused-label -Wunused-parameter -Wunused-value -Wunused-variable -Wvariadic-macros -Wvolatile-register-var -Wwrite-strings -Wno-missing-field-initializers -Wno-sign-compare -Wno-format-nonliteral -fstack-protector-all --param=ssp-buffer-size=4 -fexceptions -fasynchronous-unwind-tables -fdiagnostics-show-option -funit-at-a-time -fipa-pure-const -Werror -fPIE -DPIE -g -O2 -pie -Wl,-z -Wl,relro -Wl,-z -Wl,now -o virtlockd virtlockd-lock_daemon.o virtlockd-lock_daemon_config.o virtlockd-lock_daemon_dispatch.o virtlockd-lock_protocol.o  ./.libs/libvirt-net-rpc-server.a /usr/lib64/libavahi-client.so -L/lib64 /usr/lib64/libavahi-common.so -lpolkit-dbus -lpolkit ./.libs/libvirt-net-rpc.a -lgnutls -lgcrypt /usr/lib64/libsasl2.so -lresolv ./.libs/libvirt_util.a -lcap-ng -lyajl -lnl -laudit -ldevmapper -ldbus-1 /usr/lib64/libxml2.so -lz -lm -lselinux -lapparmor -lnuma ../gnulib/lib/.libs/libgnu.a -lrt -lpthread -lutil -ldl -pthread
virtlockd-lock_daemon.o: In function `main':
/home/bamvor/work/source/virtualization/libvirt/libvirt/src/locking/lock_daemon.c:1376: undefined reference to `virLockSpaceProtocolNProcs'
/home/bamvor/work/source/virtualization/libvirt/libvirt/src/locking/lock_daemon.c:1376: undefined reference to `virLockSpaceProtocolProcs'
collect2: ld returned 1 exit status
4, test log
log/novell/hypervisor_and_tools/libvirt/xen4.2_support/20130425_final_test/log_20130425_1638_49__test_fail_at_create.txt

17:23 2013-04-25
virtualization, libvirt, xen, libxl, segfault, send final patch to Jim, cont2
1, send email to Jim
[PATCH] fix segfault during virsh save in pv guest

this patch fix the wrong sequence for fd and timeout register. the sequence
was right in dfa1e1dd for fd register, but it changed in e0622ca2.
in this patch, set priv, xl_priv in info and increase info->priv ref count
before virEventAddHandle. if do this after virEventAddHandle, the fd
callback or fd deregister maybe got the empty priv, xl_priv or wrong ref
count.

after apply this patch, test more than 100 around passed compare to fail
within 3round without this patch. each round includes define -> start ->
destroy -> create -> suspend -> resume -> reboot -> shutdown -> save ->
resotre -> dump -> destroy -> create -> setmem -> setvcpus -> destroy.

17:35 2013-04-25
GTD
0, 11:30-20:25

1, today
1), 18:08-19:16 write patch and send it to Jim. see"17:23 2013-04-25"
2), 10' send patch for libvirt compile error.
3), Summary: 今天上午还算有点效率, 下午又是四处乱看. 晚上还是要完成计划的.

19:28 2013-04-25
software skill, opensuse 12.3, multimedia
1, ref: http://opensuse-community.org/Restricted_formats/12.3
for KDE. for GNOME reference the original web
1), add repo 
sudo zypper addrepo  http://packman.inode.at/suse/12.3 packman_12_3
sudo zypper addrepo -r http://www.opensuse-guide.org/repo/12.3/libdvdcss.repo
2), install
zypper install libxine2-codecs k3b-codecs ffmpeg lame gstreamer-0_10-plugins-bad gstreamer-0_10-plugins-ugly gstreamer-0_10-plugins-ugly-orig-addon gstreamer-0_10-plugins-ffmpeg libdvdcss2

08:10 2013-04-26
company, virtualization, suse, xen, regular meeting: US / China Virtualization Sync, meeting, prepare notes
1, Bamvor
1), console, lock. block status.
2), libxl block add timeout.
Jim: remote blocktap module, got the same error.
try qemu upstream.
4.3 will use qemu upstream as default.
2, Chunyan
3, Jim:
think about the GSOC2013 libxl guys, what he need to do in Summer.
4, Lin Ma
testing qcow2.

12:52 2013-04-26
GTD
0, 11:20

1, today
1), sync
2), 12:50- personal stuff.
3), 30' send patch to libvir-list.
4), talk with Jim. see"13:16 2013-04-26"

13:16 2013-04-26
virtualization, libvirt, xen, libvirt, conversation with Jim
1, Previous Conversations Above
Jim Fehlig: Hi
Bamvor Jian Zhang: hi
Jim Fehlig: I sent a patch to xen-devel that add support for qdisk backend type
Jim Fehlig: I was testing with that patch (with driver name = 'qemu') and didn't hit the block script timeout we have been seeing
Bamvor Jian Zhang: ok. i will test it.
Jim Fehlig: I'm going to bed now, have a good day
Bamvor Jian Zhang: have a good sleep.
Jim Fehlig: btw, send the libxl bug fix patch upstream today
Jim Fehlig: I'll commit it tomorrow
Bamvor Jian Zhang: ok. i will. 
Bamvor Jian Zhang: ok, see your patch. in xen-devel.
Bamvor Jian Zhang: libvirt-libxl-qdisk.patch
Jim Fehlig: right
Jim Fehlig: bye
Jim Fehlig logged out at 1:12:21 PM.
2, (23:44 2013-04-25)
try to add qemu-system-i386 for hvm and pv, but fail on hvm. after discuss with Jim.
1), i shoud apply the patch add by David Scott. see"18:39 2013-4-25"3.
2), apply Jim patch. and configure example. see"18:39 2013-4-25"4.

18:39 2013-4-25
mailing list, virtualization, xen, [Xen-devel] libvirt, libxl and QDISKs
1, ian c
Perhaps having LIBXL_DISK_FORMAT as an enum was a mistake and really it should have been a string with a mapping to backends in a configuration file, so it could be extensible without needing to recompile the library. This could be something to consider for a future libxl.

2, Stefano Stabellini <Stefano.Stabellini@eu.citrix.com>
It looks like the defaults are the same of libxl.
However the mapping of RAW to TAP (libxl does the same) has always been a bit dubious to me: now that upstream QEMU is used with HVM guests too by libxl, there is no reason to use blktap over QEMU for raw files any more.

3, David Scott <dave.scott@eu.citrix.com>

This also works for me!

On a related note, what do you think about the attached patch? It allows the user to select a non-default qemu via the <emulator> element. My domain XML looked like this:

  <devices>
    <emulator>/usr/lib/xen/bin/qemu-system-i386</emulator>
    <disk device="disk" type="network">
      <driver name='qemu'/>
      <source protocol="rbd" name="rbd:rbd/ubuntu1204.img"/>
      <target dev="hda"/>
    </disk>
    <graphics type="vnc" port="-1" autoport="yes" listen="0.0.0.0"/>
  </devices>

Now that upstream qemu is the default in xen-4.3, it seems useful to be able to select the traditional qemu for older VMs.

Also I backported this to my xen-4.2 system and used this patch + your patch + the previous 'stat()' fix to successfully start a VM on ceph storage via libvirt + libxl (my quest is almost complete!)

Cheers,
Dave

patch: log/novell/hypervisor_and_tools/libvirt/xen4.2_support/20130427_block_add_timeout_test/libxl-make-emulator.patch

4, Jim Fehlig

    Something like the attached, which seems to work well for me when
    specifying driverName = qemu, e.g.
    
        <disk type='file' device='disk'>
          <driver name='qemu'/>
          <source file='/var/lib/xen/images/sles11sp2-pv/disk0.raw'/>
          <target dev='xvda' bus='xen'/>
        </disk>

patch: log/novell/hypervisor_and_tools/libvirt/xen4.2_support/20130427_block_add_timeout_test/libvirt-libxl-qdisk.patch

5, Jim Fehlig
> This also works for me!
Good to hear.  I'll send the patch to the libvirt list.
>
> On a related note, what do you think about the attached patch? It
> allows the user to select a non-default qemu via the <emulator>
> element. My domain XML looked like this:
>
>   <devices>
>     <emulator>/usr/lib/xen/bin/qemu-system-i386</emulator>
IMO, the possible emulators should be exposed in the capabilities.  E.g.
on a machine with both kvm and qemu, both emulators are shown as
possibilities for an hvm, x86_64 guest
# virsh capabilities
...
<guest>
  <os_type>hvm</os_type>
  <arch name='x86_64'>
  <wordsize>64</wordsize>
  <domain type='qemu'>
    <emulator>/usr/bin/qemu-system-x86_64</emulator>
    <machine>pc-1.1</machine>
    <machine canonical='pc-1.1'>pc</machine>
    <machine>pc-1.0</machine>
    <machine>pc-0.15</machine>
    <machine>pc-0.14</machine>
    <machine>pc-0.13</machine>
    <machine>pc-0.12</machine>
    <machine>pc-0.11</machine>
    <machine>pc-0.10</machine>
    <machine>isapc</machine>
  </domain>
  <domain type='kvm'>
    <emulator>/usr/bin/qemu-kvm</emulator>
    <machine>pc-1.1</machine>
    <machine canonical='pc-1.1'>pc</machine>
    <machine>pc-1.0</machine>
    <machine>pc-0.15</machine>
    <machine>pc-0.14</machine>
    <machine>pc-0.13</machine>
    <machine>pc-0.12</machine>
    <machine>pc-0.11</machine>
    <machine>pc-0.10</machine>
    <machine>isapc</machine>
  </domain>
   ....
</guest>
...
>     <disk device="disk" type="network">
>       <driver name='qemu'/>
>       <source protocol="rbd" name="rbd:rbd/ubuntu1204.img"/>
>       <target dev="hda"/>
>     </disk>
>     <graphics type="vnc" port="-1" autoport="yes" listen="0.0.0.0"/>
>   </devices>
>
> Now that upstream qemu is the default in xen-4.3, it seems useful to
> be able to select the traditional qemu for older VMs.
Agreed.  And reporting that both emulators exist via the capabilities
would be helpful for users.
>
> Also I backported this to my xen-4.2 system and used this patch + your
> patch + the previous 'stat()' fix to successfully start a VM on ceph
> storage via libvirt + libxl (my quest is almost complete!)
Nice!
> diff --git a/src/libxl/libxl_conf.c b/src/libxl/libxl_conf.c
> index f549a5d..abbd3c0 100644
> --- a/src/libxl/libxl_conf.c
> +++ b/src/libxl/libxl_conf.c
> @@ -811,6 +811,30 @@ libxlMakeCapabilities(libxl_ctx *ctx)
>  }
>
>  int
> +libxlMakeEmulator(virDomainDefPtr def, libxl_domain_config *d_config)
> +{
> +    /* No explicit override means use the default */
> +    if (!def->emulator) {
> +        return 0;
> +    }
> +    if (strstr(def->emulator, "/qemu-system-")) {
> +        d_config->b_info.device_model_version =
> +            LIBXL_DEVICE_MODEL_VERSION_QEMU_XEN;
> +        return 0;
> +    }
>
Here we could check the requested emulator against the capabilities, and
then do the proper mapping for device_model_version.
Do you have time for an upstream libvirt patch to expose the possible
emulators in the capabilities, along with this patch allowing the user
to specify one?

Regards,
Jim

14:47 2013-04-27
GTD
0, 14:00-15:51 16:31-20:30

1, today
1), 16:31-20:30 libvirt libxl driver: block add timeout. add David Scott patch and test. ref"14:52 2013-04-27". see"15:31 2013-04-27"
meal: 40'
2), Summary: 今天感觉比较累, 明天希望有个端倪: 是哪个patch引起的, 为什么destroy失败. 给Jim发个简单的邮件描述这个问题(因为我要放假三天).

15:20 2013-04-27
opensuse 12.3, vmware player
1, sudo zypper in kernel-devel
2, missing canberra-gtk-module
run the command is successful.
/usr/bin/kdesu '/usr/bin/vmware-modconfig' --icon='vmware-player' --appname='VMware'

15:31 2013-04-27
virtualization, libvirt, xen, libxl, block add timeout, test mailing list patch
1, error
libxl: debug: libxl_device.c:920:device_hotplug: calling hotplug script: /etc/xen/scripts/block add
libxl: debug: libxl_dm.c:1135:libxl__spawn_local_dm: Spawning device-model /usr/lib/xen/bin/qemu-system-i386 with arguments:
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   /usr/lib/xen/bin/qemu-system-i386
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -xen-domid
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   1
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -chardev
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   socket,id=libxl-cmd,path=/var/run/xen/qmp-libxl-1,server,nowait
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -mon
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   chardev=libxl-cmd,mode=control
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -name
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   bjz_04_sles11_sp2
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -vnc
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   127.0.0.1:0,to=99
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -vga
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   cirrus
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -boot
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   order=c
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -smp
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   4,maxcpus=1
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -net
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   none
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -M
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   xenfv
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -m
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   504
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   -drive
libxl: debug: libxl_dm.c:1137:libxl__spawn_local_dm:   file=/var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw,if=ide,index=0,media=disk,format=raw,cache=writeback
libxl: debug: libxl_event.c:559:libxl__ev_xswatch_register: watch w=0x7f491ad743c8 wpath=/local/domain/0/device-model/1/state token=3/1: register slotnum=3
libxl: debug: libxl_event.c:503:watchfd_callback: watch w=0x7f491ad743c8 wpath=/local/domain/0/device-model/1/state token=3/1: event epath=/local/domain/0/device-model/1/state
libxl: debug: libxl_event.c:596:libxl__ev_xswatch_deregister: watch w=0x7f491ad743c8 wpath=/local/domain/0/device-model/1/state token=3/1: deregister slotnum=3
libxl: error: libxl_dm.c:1204:device_model_spawn_outcome: domain 1 device model: spawn failed (rc=-3)
libxl: error: libxl_create.c:1042:domcreate_devmodel_started: device model did not start: -3
libxl: error: libxl_dm.c:1235:libxl__destroy_device_model: Device Model already exited
1), So, the command line for qemu: /usr/lib/xen/bin/qemu-system-i386 -xen-domid 1 -chardev socket,id=libxl-cmd,path=/var/run/xen/qmp-libxl-1,server,nowait -mon chardev=libxl-cmd,mode=control -name bjz_04_sles11_sp2 -vnc 127.0.0.1:0,to=99 -vga cirrus -boot order=c -smp 4,maxcpus=1 -net none -M xenfv -m 504 -drive file=/var/lib/xen/images_2/bjz_04_sles11_sp2/disk0.raw,if=ide,index=0,media=disk,format=raw,cache=writeback
2), the error message in /var/log/xen/qemu-dm-bjz_04_sles11_sp2.log 
maxcpus must be equal to or greater than smp
3), change maxcpus from 1 to 4, run qemu manually
qemu: hardware error: map shared IO page returned error 3 handle=0x7f8df8bac550
Aborted
2, check the code. libxl_dm.c:1137:libxl__spawn_local_dm
the args print in libxl__spawn_local_dm, is set by libxl__build_device_model_args_new, the i found that:
        if (b_info->max_vcpus > 1) {
            flexarray_append(dm_args, "-smp");
            if (b_info->avail_vcpus.size) {
                int nr_set_cpus = 0;
                nr_set_cpus = libxl_bitmap_count_set(&b_info->avail_vcpus);

                flexarray_append(dm_args, libxl__sprintf(gc, "%d,maxcpus=%d",
                                                         b_info->max_vcpus,
                                                         nr_set_cpus));
            } else
                flexarray_append(dm_args, libxl__sprintf(gc, "%d",
                                                         b_info->max_vcpus));
        }
\TODO: check nr_set_cpus.
1), only hvm hit this. in pv no this argument:
/usr/lib/xen/bin/qemu-system-i386 -xen-domid 6 -chardev socket,id=libxl-cmd,path=/var/run/xen/qmp-libxl-6,server,nowait -mon chardev=libxl-cmd,mode=control -xen-attach -name sles11_sp2_pv -vnc 127.0.0.1:5 -M xenpv -m 513 
2), if i changes the vcpu to 1, create successful, but destroy fails.
3), test pv guest first.
hang at create. define->start->destroy->create...
(1), (1), (1), (1), (1), (1), (1), (1), (1), it hang at ao_in_progress, does it broken after destroy?
Thread 9 (Thread 0x7fe91e181700 (LWP 4470)):
#0  0x00007fe92279f4f6 in *__GI___poll (fds=0x7fe928406d90, nfds=7, timeout=-1) at ../sysdeps/unix/sysv/linux/poll.c:87
#1  0x00007fe9270b6c77 in eventloop_iteration (egc=0x7fe91e1803e0, poller=0x7fe928406560) at libxl_event.c:1425
#2  0x00007fe9270b71ea in libxl__ao_inprogress (ao=0x7fe928402370, file=<optimized out>, line=<optimized out>, func=<optimized out>) at libxl_event.c:1685
#3  0x00007fe92709d307 in do_domain_create (ctx=<optimized out>, d_config=<optimized out>, domid=0x7fe91e1805ec, restore_fd=1, ao_how=<optimized out>, aop_console_how=0x0)
    at libxl_create.c:1211
(2), in "xl list" domain 1 is not full destoryed.
xl list
Name                                        ID   Mem VCPUs      State   Time(s)
Domain-0                                     0  3186     4     r-----      33.4
(null)                                       1     2     1     --p--d       0.3
sles11_sp2_pv                                2     0     0     --p---       0.0
(3), 排查是哪个修改导致了这个问题.
这次又和libxl__ao_inprogress有关系, 上次就没看明白...

11:20 2013-04-28
GTD
0, 10:40-19:23

1, today
1), 11:23- libvirt libxl driver: block add timeout. debug why fail. see"11:23 2013-04-28"
2), work on put opensuse 12.3 on mele M9. see"15:54 2013-04-28"

\TODO: install SLES11 SP3 RC1 and test this bug. the xen and libvirt package is not update. i need update libvirt at first.

2, next
1), console patch: do the make test and send it to Chunyan.

2, \TODO
1), subscribe LWN while my palpay account have enough money.
1), keep an eye on Xen Test Days. see"13:29 2013-02-22"1
2), do some work if jim gsoc is not selected by student and opensuse.org. see"18:08 2013-03-22"
3), is there any other changes in Jim libvirt libxl xen4.2 support patch. like console things?
在Jim xen4.2 patch里面有没有类似影响console的libxl功能的修改?

2, daily work
1), tracking xen-arm update.
2), read libvirt and xen-devel quickly, should less that 30minutes.
3), read linux news
http://www.linux.com/
http://www.phoronix.com/scan.php?page=home

3, week plan
1), send console patch to upstream.
2), finish libxl block status and relative functions.
3), libvirt libxl lock patch. see"14:24 2013-03-13"6.

4, next
1), read code about lastest kernel porting. see"11:49 2013-02-07".
1), coding excise for pthread_atfork.
2), rt-thread moto control driver in lua. first version do not use the PWM.

1), for libxl xen4.2 bug, figure out why virsh got event after libxl think its done. see"10:41 2013-01-24".
2), write code for libxl qmp. see"17:15 2013-01-23"
4), read jim patch on libvirt and xen.
3), debug libvirt libxl console. see"16:50 2013-01-04"
1), send xen libexec patch.
1), test Jim patch for libxl xen4.2 bug. see"11:00 2012-12-21"
3), re-read all the patch about libxl xen4.2.
1), got arm technical symposia pdf.
2), libvirt blkstats:
(1), add block stats in libxl_qmp.c, add cmd in xl.
(2), add patch in libvirt, send it to Jim. if the former patch only accept by xen-unstable not xen4.2-testing. i could not send patch to libvirt upstream.
3), try xen on kvm.
4), 对于vi不能方便查找keywords这个事情, 实在不能忍了, 如果这周能把managed save和bridge-utils bug fix, 就把这个做一个.

3, next week
1), work on lock patch.
2), try to build MK802 kernel on obs. speed up. i want it work on opensuse12.3
2), read kernel doc: "10:36 2012-11-23"
1), read code for patch. see"10:25 2012-11-23"2-2)-(2).
2), after "1)" finish. try xen on kvm.
3), read the mail on "Andrew Wafaa <awafaa@opensuse.org>"_email_"[opensuse-arm] Fwd: [fedora-arm] ARMv8 Bootstrap Project"_20121122
3), work on xen on ARM. ref"22:33 2012-11-19"
4), check the error from "10:18 2012-11-15"2
2012-11-15 04:02:45.318+0000: 4307: error : virNodeGetSecurityModel:9567 : this function is not supported by the connection driver: virNodeGetSecurityModel
5), ask jim to invite me to xen irc.

3, next next
1), gsoc: "22:23 2012-11-17"
1), notes about Huawei from eet-china.
2), read bug:https://bugzilla.novell.com/show_bug.cgi?id=781425

2, next
1), try to improve attach-disk, detach-disk in libxl driver, see"18:17 2012-11-07"4
2), test attach-disk command. see"10:41 2012-10-30"2
3), maybe libxl and qemu could communicate with qemu through xenstore?

libxl_dm.c:
        /* Find uuid and the write the vnc password to xenstore for qemu. */
        t = xs_transaction_start(ctx->xsh);
        vm_path = libxl__xs_read(&gc,t,libxl__sprintf(&gc, "%s/vm", p->dom_path));
        if (vm_path) {
            /* Now write the vncpassword into it. */
            pass_stuff = libxl__calloc(&gc, 3, sizeof(char *));
            pass_stuff[0] = "vncpasswd";
            pass_stuff[1] = info->vncpasswd;
            libxl__xs_writev(&gc,t,vm_path,pass_stuff);

3, for Jim
1), xenlight event lock in libvirt. see"16:52 2012-11-06"2-1).

4, next month
1), opensuse on MK802
(1), generate the 512MB version with opensuse12.2 RC2 which enable yast fist run.
(2), try opensuse based on ubuntu kernel in order to solve the error from miniand.
2), try qemu-dm instead of qemu xen
3), try xl create.

11:23 2013-04-28
virtualization, libvirt, xen, libxl, block add timeout, test mailing list patch, cont1
1, find out why qdisk test fail.
2, test whether xl works or not.
1), modify configuration:
 # diff sles11_sp2_pv sles11_sp2_pv_tap 
16,18c16
< disk=[ 'format=raw, vdev=xvda, access=rw, backendtype=qdisk, target=/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw', ]
< 
< 
---
> disk=[ 'file:/var/lib/xen/images_2/sles11_sp2_pv/disk0.raw,xvda,w', ]
2), fail
[    5.528146] XENBUS: Waiting for devices to initialise: 295s...290s...285s...280s...275s...270s...265s...260s...255s...250s...245s...240s...235s...230s...225s...220s...215s...210s...205s...200s...195s...190s...185s...180s...175s...170s...165s...160s...155s...150s...145s...140s...135s...130s...125s...120s...115s...110s...105s...100s...95s...90s...85s...80s...75s...70s...65s...60s...55s...50s...45s...40s...35s...30s...25s...20s...15s...10s...5s...0s...
[  300.528207] XENBUS: Device not ready: device/vbd/51712
[  300.544730] netfront: Initialising virtual ethernet driver.
3, 突然觉得会不会是我的qemu有问题, 不会用的是4.1的qemu吧.
自己make tools, make install-tools

15:54 2013-04-28
opensuse, arm, Allwinner A31, mele M9
1, M9 has the same uart pin map with mele A1000. that is 
Gnd, Rx, Tx, 3v3(pin 1)
2, u-boot has a 1 second timeout. So, i could simplly build the kernel and put kernel into SD card.
3, checkout the code
git clone http://git.hands.com/linux.git -b allwinner-sunxi-a31
git clone git://github.com/amery/linux-allwinner.git

3, \TODO
1), try burn image. if ok, put kernel into nanda.
1), post what i found to arm-netbook mailing list, xda-developers[1].
http://forum.xda-developers.com/showthread.php?t=2247104
http://forum.xda-developers.com/forumdisplay.php?f=1507

22:54 2013-04-28
software skill, sles11 sp2, compresser, 7z
http://download.opensuse.org/repositories/Archiving/SLE_11_SP2/

00:01 2013-04-30
hacking mele M9: the quad core allwinner SOC A31
hi, 

i have got the mele quad core STB. it is indeed has the same uart connector as mele A1000. and the MP tools is out, it could support make a bootable sd card. So, i am trying to put opensuse 12.3 on it.
the photos and bootlog, ref: http://xen_on_arm.farbox.com/post/mele_m9_quadcore

